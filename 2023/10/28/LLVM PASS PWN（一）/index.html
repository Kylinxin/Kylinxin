<!DOCTYPE html><html lang="zh-CN" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>LLVM PASS PWN（一） | Ky不是枕木</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: Bender;
 src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
 font-family: BenderLight;
 src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Ky不是枕木" type="application/atom+xml">
</head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>LLVM PASS PWN（一）</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-10-28T15:14:29.000Z" id="date"> 2023-10-28</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-10-28T14:56:33.522Z" id="updated"> 2023-10-28</time></div></span><br><span>Word Count: <div class="control">3.2k</div></span><br><span>Read Time: <div class="control">14 min</div></span></div></div><hr><div id="post-content"><h1>LLVM PASS PWN（一）</h1>
<h2 id="前置知识简述"><a href="#前置知识简述" class="headerlink" title="前置知识简述"></a>前置知识简述</h2>
<h3 id="为什么要编译程序"><a href="#为什么要编译程序" class="headerlink" title="为什么要编译程序"></a>为什么要编译程序</h3>
<p>机器语言是用1和0组成的代码，但机器是识别不了1和0的，更具体的是如何识别的呢？对机器电路进行设计之后，机器能识别高电平还是低电平，刚好与2进制很相似，想输入0就给机器输入低电平，想输入1，就给机器输入高电平，所以就看到了1和0的表示形式</p>
<p>机器语言它是计算机唯一能识别和执行的语言，但它的直观性差，可读性差，比如一串<code>11110000111100001111</code>机器可以快速识别是什么但是我们很难理解，再比如我们想要在屏幕上输出hello world那我们该如何用二进制来表示呢，所以汇编语言就诞生了</p>
<p>汇编语言用助记符来表示机器指令中的操作码和操作数的指令系统，如a = 1，我们不需要去用二进制来理解，我们完全可以利用mov a, 1进行理解，那有没有更简单的方法呢，比如现在要输出hello wrold，还是需要十几行的汇编代码的，所以高级语言就诞生了</p>
<p>高级语言是一种更接近人类的自然语言和数学语言的语言，比如想要a = 1，很直观就是a = 1，在很大程度上减少编程人员的编写量</p>
<p>但是问题来了，机器只懂0和1那怎么才能让高级语言被机器识别，所以就有了编译，将高级语言（源语言）翻译成汇编语言或机器语言（目标语言），编译的根本目的就是把源代码变成目标代码</p>
<h3 id="编译的过程是什么"><a href="#编译的过程是什么" class="headerlink" title="编译的过程是什么"></a>编译的过程是什么</h3>
<p>编译过程主要可以划分为前端与后端，笔者用一张图简述一下</p>
<p class='item-img' data-src='https://s2.loli.net/2023/10/28/UiPnzvrVDGfkLhm.png'><img src="https://s2.loli.net/2023/10/28/UiPnzvrVDGfkLhm.png" alt="image.png"></p>
<p>前端把源代码翻译成IR，后端把IR编译成目标平台的机器码，这里笔者在查阅资料的时候发现有些会将生成中间代码放入前端，而有些资料会将生成中间代码放入后端</p>
<p>在词法分析中编译器读入源代码，经过词法分析器识别出Token，比如词法分析器中识别出的Token可以是<code>int, return, {, }</code>等</p>
<p>在语法分析中会把上面的Token串给转换成一个抽象语法树AST，AST树反映了程序的语法结构</p>
<p>在语义分析中需要做的任务是理解语义，语句要做什么，如for是需要去实现循环，if是判断等</p>
<p>在前端完成之后，会生成中间代码，统一优化中间代码，再去将中间代码生成目标代码</p>
<p>前置知识这里笔者简述了一下，具体的可以移步编译原理</p>
<ul>
<li>
<h2 id="LLVM"><a href="#LLVM" class="headerlink" title="LLVM"></a>LLVM</h2>
<h3 id="LLVM-IR-LLVM-Pass"><a href="#LLVM-IR-LLVM-Pass" class="headerlink" title="LLVM-IR-LLVM-Pass"></a>LLVM IR &amp; LLVM Pass</h3>
<p><code>gcc</code>这个最经典的编译器提供的是一整套服务，前端和后端耦合在了一起，导致了如果一个新的编程语言出现可能需要设计一个新的IR以及实现这个IR的后端，如果出现了一个新的平台就要实现一个从自己的IR到新平台的后端，针对此类问题就出现了LLVM</p>
<p>不同的前后端使用统一的中间代码，这样一个新的编程语言出现只需要实现一个新的前端，如果出现了一个新的平台只需要实现一个新的后端</p>
<p>LLVM IR有三种表示形式</p>
<ul>
<li>可读IR，类似汇编代码，可以给人看的，后缀<code>.ll</code></li>
<li>不可读二进制IR，后缀<code>.bc</code></li>
<li>保存在内存中，内存格式</li>
</ul>
<p>LLVM Pass 是一个框架设计，是LLVM系统里重要的组成部分，因为LLVM Pass负责LLVM编译器绝大部分的工作，一系列的Pass组合，构建了编译器的转换和优化部分，抽象成结构化的编译器代码。</p>
<p>在实现上，LLVM的核心库中会给你一些 Pass类 去继承。你需要实现它的一些方法。 最后使用LLVM的编译器会把它翻译得到的IR传入Pass里，给你遍历和修改。</p>
<p>LLVM Pass的用处是插桩，机器无关的代码优化，静态分析，代码混淆等</p>
<h3 id="LLVM-工具"><a href="#LLVM-工具" class="headerlink" title="LLVM-工具"></a>LLVM 工具</h3>
<p>以下内容来自<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/122522485">LLVM Pass入门导引</a></p>
<ul>
<li><code>llvm-as</code>：把LLVM IR从人类能看懂的文本格式汇编成二进制格式。注意：此处得到的<strong>不是</strong>目标平台的机器码。</li>
<li><code>llvm-dis</code>：<code>llvm-as</code>的逆过程，即反汇编。 不过这里的反汇编的对象是LLVM IR的二进制格式，而不是机器码。</li>
<li><code>opt</code>：优化LLVM IR。输出新的LLVM IR。</li>
<li><code>llc</code>：把LLVM IR编译成汇编码。需要用<code>as</code>进一步得到机器码。</li>
<li><code>lli</code>：解释执行LLVM IR。</li>
</ul>
<h2 id="Clang"><a href="#Clang" class="headerlink" title="Clang"></a>Clang</h2>
<p>Clang 是 LLVM 的前端，可以用来编译 C，C++，ObjectiveC 等语言。Clang 的功能包括：词法分析、语法分析、语义分析、生成中间中间代码LLVM Intermediate Representation (LLVM IR)。</p>
<h2 id="LLVM-Clang环境安装-工具测试"><a href="#LLVM-Clang环境安装-工具测试" class="headerlink" title="LLVM-Clang环境安装-工具测试"></a>LLVM &amp; Clang环境安装 &amp; 工具测试</h2>
<p>ubuntu20.04下安装LLVM + Clang如下</p>
<blockquote>
<p>sudo apt install clang-12</p>
<p>sudo apt install clang-8</p>
<p>sudo apt install llvm-12</p>
<p>sudo apt install llvm-8</p>
</blockquote>
<p>llvm-12安装之后可以使用opt-12，今年的ciscn的LLVM PASS PWN就是opt-12，一般题目都会给出opt的版本。ubuntu20.04应该自带opt-10如果没有的话，<code>sudo apt install clang-10 &amp;&amp; sudo apt install llvm-10</code></p>
<p>上面的做题环境都安装完成之后，先写一个c文件，利用Clang将c文件编译成<code>.ll, .bc</code>等格式看一下是否是如上所说，c文件如下</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span>{<br>    <span class="hljs-type">char</span> name[<span class="hljs-number">0x20</span>];<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"hello world"</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"plz input your name"</span>);<br>    read(<span class="hljs-number">0</span>, name, <span class="hljs-number">0x1F</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"biubiubiu"</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>首先是<code>.c-&gt;.ll</code>，<code>clang-12 -emit-llvm -S test.c -o test.ll</code>，test.ll(生成的IR文本文件)如下</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs asm">; ModuleID = 'test.c'<br>source_filename = "test.c"<br>target datalayout = "e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128"<br>target triple = "x86_64-pc-linux-gnu"<br><br>@.str = private unnamed_addr constant [12 x i8] c"hello world\00", align 1<br>@.str.1 = private unnamed_addr constant [20 x i8] c"plz input your name\00", align 1<br>@.str.2 = private unnamed_addr constant [10 x i8] c"biubiubiu\00", align 1<br><br>; Function Attrs: noinline nounwind optnone uwtable<br>define dso_local i32 @main(i32 %0, i8** %1) #0 {<br>  %3 = alloca i32, align 4<br>  %4 = alloca i32, align 4<br>  %5 = alloca i8**, align 8<br>  %6 = alloca [32 x i8], align 16<br>  store i32 0, i32* %3, align 4<br>  store i32 %0, i32* %4, align 4<br>  store i8** %1, i8*** %5, align 8<br>  %7 = call i32 @puts(i8* getelementptr inbounds ([12 x i8], [12 x i8]* @.str, i64 0, i64 0))<br>  %8 = call i32 @puts(i8* getelementptr inbounds ([20 x i8], [20 x i8]* @.str.1, i64 0, i64 0))<br>  %9 = getelementptr inbounds [32 x i8], [32 x i8]* %6, i64 0, i64 0<br>  %10 = call i64 @read(i32 0, i8* %9, i64 31)<br>  %11 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([10 x i8], [10 x i8]* @.str.2, i64 0, i64 0))<br>  ret i32 0<br>}<br><br>declare dso_local i32 @puts(i8*) #1<br><br>declare dso_local i64 @read(i32, i8*, i64) #1<br><br>declare dso_local i32 @printf(i8*, ...) #1<br><br>attributes #0 = { noinline nounwind optnone uwtable "disable-tail-calls"="false" "frame-pointer"="all" "less-precise-fpmad"="false" "min-legal-vector-width"="0" "no-infs-fp-math"="false" "no-jump-tables"="false" "no-nans-fp-math"="false" "no-signed-zeros-fp-math"="false" "no-trapping-math"="true" "stack-protector-buffer-size"="8" "target-cpu"="x86-64" "target-features"="+cx8,+fxsr,+mmx,+sse,+sse2,+x87" "tune-cpu"="generic" "unsafe-fp-math"="false" "use-soft-float"="false" }<br>attributes #1 = { "disable-tail-calls"="false" "frame-pointer"="all" "less-precise-fpmad"="false" "no-infs-fp-math"="false" "no-nans-fp-math"="false" "no-signed-zeros-fp-math"="false" "no-trapping-math"="true" "stack-protector-buffer-size"="8" "target-cpu"="x86-64" "target-features"="+cx8,+fxsr,+mmx,+sse,+sse2,+x87" "tune-cpu"="generic" "unsafe-fp-math"="false" "use-soft-float"="false" }<br><br>!llvm.module.flags = !{!0}<br>!llvm.ident = !{!1}<br><br>!0 = !{i32 1, !"wchar_size", i32 4}<br>!1 = !{!"Ubuntu clang version 12.0.0-3ubuntu1~20.04.5"}<br></code></pre></td></tr></tbody></table></figure>
<p>上面的IR很直观，之前提到LLVM PASS的一个用处是优化IR代码，会将上面的可以优化的进行优化</p>
<p>其次是<code>.c-&gt;.bc</code>，<code>clang-12 -emit-llvm -c test.c -o test.bc</code>，bc是不可读二进制</p>
<p><a target="_blank" rel="noopener" href="https://xzfile.aliyuncs.com/media/upload/picture/20221014183446-d2d19954-4bab-1.png" class='item-img' data-src='https://xzfile.aliyuncs.com/media/upload/picture/20221014183446-d2d19954-4bab-1.png'><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221014183446-d2d19954-4bab-1.png" alt="img"></a></p>
<p>然后是<code>.ll -&gt; .bc</code>，<code>llvm-as test.ll -o test.bc</code>，结果和上面的一样</p>
<p>接着是<code>.bc - &gt; .ll</code>，<code>llvm-dis test.bc -o test.ll</code>，同上</p>
<p>最后还有一个<code>.bc -&gt; .s</code>， <code>llc test.bc -o test.s</code>，将字节码的二进制格式文件转换为本地的汇编文件</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs asm">.text<br>    .file   "test.c"<br>    .globl  main                    # -- Begin function main<br>    .p2align    4, 0x90<br>    .type   main,@function<br>main:                                   # @main<br>    .cfi_startproc<br># %bb.0:<br>    pushq   %rbp<br>    .cfi_def_cfa_offset 16<br>    .cfi_offset %rbp, -16<br>    movq    %rsp, %rbp<br>    .cfi_def_cfa_register %rbp<br>    subq    $48, %rsp<br>    movl    $0, -8(%rbp)<br>    movl    %edi, -4(%rbp)<br>    movq    %rsi, -16(%rbp)<br>    movabsq $.L.str, %rdi<br>    callq   puts<br>    movabsq $.L.str.1, %rdi<br>    callq   puts<br>    leaq    -48(%rbp), %rsi<br>    xorl    %edi, %edi<br>    movl    $31, %edx<br>    callq   read<br>    movabsq $.L.str.2, %rdi<br>    movb    $0, %al<br>    callq   printf<br>    xorl    %eax, %eax<br>    addq    $48, %rsp<br>    popq    %rbp<br>    .cfi_def_cfa %rsp, 8<br>    retq<br>.Lfunc_end0:<br>    .size   main, .Lfunc_end0-main<br>    .cfi_endproc<br>                                        # -- End function<br>    .type   .L.str,@object          # @.str<br>    .section    .rodata.str1.1,"aMS",@progbits,1<br>.L.str:<br>    .asciz  "hello world"<br>    .size   .L.str, 12<br><br>    .type   .L.str.1,@object        # @.str.1<br>.L.str.1:<br>    .asciz  "plz input your name"<br>    .size   .L.str.1, 20<br><br>    .type   .L.str.2,@object        # @.str.2<br>.L.str.2:<br>    .asciz  "biubiubiu"<br>    .size   .L.str.2, 10<br><br>    .ident  "Ubuntu clang version 12.0.0-3ubuntu1~20.04.5"<br>    .section    ".note.GNU-stack","",@progbits<br></code></pre></td></tr></tbody></table></figure>
<h2 id="编写第一个LLVM-Pass"><a href="#编写第一个LLVM-Pass" class="headerlink" title="编写第一个LLVM-Pass"></a>编写第一个LLVM Pass</h2>
<p>通过前面的知识之后，现在可以尝试编写“hello world”的pass，下面是<a target="_blank" rel="noopener" href="https://llvm.org/docs/WritingAnLLVMPass.html">官方</a>的示例</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"llvm/Pass.h"</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"llvm/IR/Function.h"</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"llvm/Support/raw_ostream.h"</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"llvm/IR/LegacyPassManager.h"</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"llvm/Transforms/IPO/PassManagerBuilder.h"</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> llvm;<br><br><span class="hljs-keyword">namespace</span> {<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Hello</span> : <span class="hljs-keyword">public</span> FunctionPass {<br>  <span class="hljs-type">static</span> <span class="hljs-type">char</span> ID;<br>  <span class="hljs-built_in">Hello</span>() : <span class="hljs-built_in">FunctionPass</span>(ID) {}<br><br>  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">runOnFunction</span><span class="hljs-params">(Function &amp;F)</span> <span class="hljs-keyword">override</span> </span>{<br>    <span class="hljs-built_in">errs</span>() &lt;&lt; <span class="hljs-string">"Hello: "</span>;<br>    <span class="hljs-built_in">errs</span>().<span class="hljs-built_in">write_escaped</span>(F.<span class="hljs-built_in">getName</span>()) &lt;&lt; <span class="hljs-string">'\n'</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  }<br>}; <span class="hljs-comment">// end of struct Hello</span><br>}  <span class="hljs-comment">// end of anonymous namespace</span><br><br><span class="hljs-type">char</span> Hello::ID = <span class="hljs-number">0</span>;<br><span class="hljs-function"><span class="hljs-type">static</span> RegisterPass&lt;Hello&gt; <span class="hljs-title">X</span><span class="hljs-params">(<span class="hljs-string">"hello"</span>, <span class="hljs-string">"Hello World Pass"</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                             <span class="hljs-literal">false</span> <span class="hljs-comment">/* Only looks at CFG */</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                             <span class="hljs-literal">false</span> <span class="hljs-comment">/* Analysis Pass */</span>)</span></span>;<br><br><span class="hljs-function"><span class="hljs-type">static</span> RegisterStandardPasses <span class="hljs-title">Y</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    PassManagerBuilder::EP_EarlyAsPossible,</span></span><br><span class="hljs-params"><span class="hljs-function">    [](<span class="hljs-type">const</span> PassManagerBuilder &amp;Builder,</span></span><br><span class="hljs-params"><span class="hljs-function">       legacy::PassManagerBase &amp;PM) { PM.add(<span class="hljs-keyword">new</span> Hello()); })</span></span>;<br></code></pre></td></tr></tbody></table></figure>
<p>先声明pass本身，然后声明了一个<code>Hello</code>类，它是FunctionPass的子类。稍后将详细描述不同的内置pass子类，但是现在知道FunctionPass一次对一个函数进行操作。</p>
<p>然后声明了LLVM用于标识pass的pass标识符。 这允许LLVM避免使用昂贵的C ++运行时信息，如下</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">static</span> <span class="hljs-type">char</span> ID;<br><span class="hljs-built_in">Hello</span>() : <span class="hljs-built_in">FunctionPass</span>(ID) {}<br></code></pre></td></tr></tbody></table></figure>
<p>然后声明了一个runOnFunction方法，它覆盖了从FunctionPass继承的抽象虚方法。 这是我们应该做的事情，所以我们只用每个函数的名称打印出我们的消息。代码如下</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">runOnFunction</span><span class="hljs-params">(Function &amp;F)</span> <span class="hljs-keyword">override</span> </span>{<br>    <span class="hljs-built_in">errs</span>() &lt;&lt; <span class="hljs-string">"Hello: "</span>;<br>    <span class="hljs-built_in">errs</span>().<span class="hljs-built_in">write_escaped</span>(F.<span class="hljs-built_in">getName</span>()) &lt;&lt; <span class="hljs-string">'\n'</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  }<br>}; <span class="hljs-comment">// end of struct Hello</span><br>}  <span class="hljs-comment">// end of anonymous namespace</span><br></code></pre></td></tr></tbody></table></figure>
<p>接着初始化passID。 LLVM使用ID的地址来标识pass，因此初始化值并不重要。代码如下</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">char</span> Hello::ID = <span class="hljs-number">0</span>;<br></code></pre></td></tr></tbody></table></figure>
<p>最后，我们注册我们的类Hello，给它一个命令行参数“hello”，并命名为“Hello World Pass”。 最后两个参数描述了它的行为：如果传递遍历CFG而不修改它，那么第三个参数设置为true; 如果pass是分析pass，例如支配树pass，则提供true作为第四个参数。代码如下</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> RegisterPass&lt;Hello&gt; <span class="hljs-title">X</span><span class="hljs-params">(<span class="hljs-string">"hello"</span>, <span class="hljs-string">"Hello World Pass"</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                             <span class="hljs-literal">false</span> <span class="hljs-comment">/* Only looks at CFG */</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                             <span class="hljs-literal">false</span> <span class="hljs-comment">/* Analysis Pass */</span>)</span></span>;<br></code></pre></td></tr></tbody></table></figure>
<p>如果我们想将通道注册为现有管道的一个步骤，则提供了一些扩展点，例如<code>PassManagerBuilder::EP_EarlyAsPossible</code>在任何优化之前应用我们的通道，或者<code>PassManagerBuilder::EP_FullLinkTimeOptimizationLast</code> 在链接时间优化之后应用它。代码如下</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> llvm::RegisterStandardPasses <span class="hljs-title">Y</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    llvm::PassManagerBuilder::EP_EarlyAsPossible,</span></span><br><span class="hljs-params"><span class="hljs-function">    [](<span class="hljs-type">const</span> llvm::PassManagerBuilder &amp;Builder,</span></span><br><span class="hljs-params"><span class="hljs-function">       llvm::legacy::PassManagerBase &amp;PM) { PM.add(<span class="hljs-keyword">new</span> Hello()); })</span></span>;<br></code></pre></td></tr></tbody></table></figure>
<p>现在需要将这个Pass编译成模块，使用如下命令即可</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++">clang<span class="hljs-number">-12</span> `llvm-config --cxxflags` -Wl,-znodelete -fno-rtti -fPIC -shared Hello.cpp -o LLVMHello.so `llvm-config --ldflags`<br></code></pre></td></tr></tbody></table></figure>
<p>现在应该会看到LLVMHello.so这个文件，通过官方文档可知需要使用以下命令</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++">opt -load LLVMHello.so -hello test.ll<br></code></pre></td></tr></tbody></table></figure>
<p>这里的 -hello由Hello.cpp中的<code>static RegisterPass&lt;Hello&gt; X</code>参数决定</p>
<p>但是笔者这里报了一个错<code>Error opening 'LLVMHello.so': LLVMHello.so: cannot open shared object file: No such file or directory</code>，<a target="_blank" rel="noopener" href="http://xn--linuxLLVMHello-zw7v050cxyshfbme6m579ritpyubl75fv72mz3wa3r6g.so">这是因为linux无法在默认地址找到LLVMHello.so</a>，解决很简单`sudo cp <a target="_blank" rel="noopener" href="http://LLVMHello.so">LLVMHello.so</a> /lib</p>
<p class='item-img' data-src='https://s2.loli.net/2023/10/28/XWF4LHKzkSwchIb.png'><img src="https://s2.loli.net/2023/10/28/XWF4LHKzkSwchIb.png" alt="image.png"></p>
<p>成功输出test.c所有函数名称</p>
<h2 id="对第一个LLVM-Pass逆向分析"><a href="#对第一个LLVM-Pass逆向分析" class="headerlink" title="对第一个LLVM-Pass逆向分析"></a>对第一个LLVM Pass逆向分析</h2>
<p>刚刚生成了LLVMHello.so这个pass文件，比赛题和上面也一样，会重写<code>FunctionPass</code>类中的<code>runOnFunction</code>函数，所以我们对上面的示例程序进行逆向分析，看一下虚表位置这样方便比赛的时候确定每个函数的位置</p>
<p class='item-img' data-src='https://s2.loli.net/2023/10/28/Yi63r1Ju9amMwxf.png'><img src="https://s2.loli.net/2023/10/28/Yi63r1Ju9amMwxf.png" alt="image.png"></p>
<p>跟进RegisterPass</p>
<p class='item-img' data-src='https://s2.loli.net/2023/10/28/75lPFTus26yqtnf.png'><img src="https://s2.loli.net/2023/10/28/75lPFTus26yqtnf.png" alt="image.png"></p>
<p>发现调用了callDefaultCtor进行对象创建，跟进它</p>
<p class='item-img' data-src='https://s2.loli.net/2023/10/28/LUV5XROSuFNvtMm.png'><img src="https://s2.loli.net/2023/10/28/LUV5XROSuFNvtMm.png" alt="image.png"></p>
<p>给Hello对象分配了0x20个空间，跟进Hello</p>
<p class='item-img' data-src='https://s2.loli.net/2023/10/28/EyKMYARvXJco7gu.png'><img src="https://s2.loli.net/2023/10/28/EyKMYARvXJco7gu.png" alt="image.png"></p>
<p>看到虚表了，直接跟进</p>
<p class='item-img' data-src='https://s2.loli.net/2023/10/28/uP6tBspbYAe4HwU.png'><img src="https://s2.loli.net/2023/10/28/uP6tBspbYAe4HwU.png" alt="image.png"></p>
<p><code>runOnFunction</code>函数位于虚表中的最后一个位置，因为runOnFunction函数被我们重写了，所以它指向的是我们自定义的那个函数，比赛题的漏洞基本就是这个，所以在做LLVM Pass pwn的时候定位函数的位置可以从虚表入手</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2>
<p>收获很大，从编译过程到LLVM，加固了计算机底层的一些知识，知道了LLVM PASS PWN该怎么入手，以前看到LLVM PASS PWN的时候都不知道怎么运行（XD），这里第一篇就结束了，后面会继续更新</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/130702001">https://zhuanlan.zhihu.com/p/130702001</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/122522485">https://zhuanlan.zhihu.com/p/122522485</a></p>
<p><a target="_blank" rel="noopener" href="https://www.homedt.net/196837.html">https://www.homedt.net/196837.html</a></p>
<p><a target="_blank" rel="noopener" href="https://llvm.org/docs/WritingAnLLVMPass.html">https://llvm.org/docs/WritingAnLLVMPass.html</a></p>
</li>
</ul>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2023/10/28/LLVM%20PASS%20PWN%20(%E4%BA%8C)/">← Next LLVM PASS PWN（二）</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/10/25/SROP/">SROP Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">Kylinxin</a></h1><div id="description"><p>当你觉得生活都不顺心如意的时候，来学习pwn吧！</p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">LLVM PASS PWN（一）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86%E7%AE%80%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text">前置知识简述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%BC%96%E8%AF%91%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.1.1.</span> <span class="toc-text">为什么要编译程序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E7%9A%84%E8%BF%87%E7%A8%8B%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.1.2.</span> <span class="toc-text">编译的过程是什么</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LLVM"><span class="toc-number">1.2.</span> <span class="toc-text">LLVM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#LLVM-IR-LLVM-Pass"><span class="toc-number">1.2.1.</span> <span class="toc-text">LLVM IR &amp; LLVM Pass</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LLVM-%E5%B7%A5%E5%85%B7"><span class="toc-number">1.2.2.</span> <span class="toc-text">LLVM 工具</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Clang"><span class="toc-number">1.3.</span> <span class="toc-text">Clang</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LLVM-Clang%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85-%E5%B7%A5%E5%85%B7%E6%B5%8B%E8%AF%95"><span class="toc-number">1.4.</span> <span class="toc-text">LLVM &amp; Clang环境安装 &amp; 工具测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99%E7%AC%AC%E4%B8%80%E4%B8%AALLVM-Pass"><span class="toc-number">1.5.</span> <span class="toc-text">编写第一个LLVM Pass</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%B9%E7%AC%AC%E4%B8%80%E4%B8%AALLVM-Pass%E9%80%86%E5%90%91%E5%88%86%E6%9E%90"><span class="toc-number">1.6.</span> <span class="toc-text">对第一个LLVM Pass逆向分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.7.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">1.8.</span> <span class="toc-text">Reference</span></a></li></ol></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>